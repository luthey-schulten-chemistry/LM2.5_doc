
<!DOCTYPE html>


<html lang="en" data-content_root="./" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>C++ Source Code &#8212; Lattice Microbes 2.5_dev documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  <!--
    this give us a css class that will be invisible only if js is disabled
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=fa44fd50" />
  
  <!-- So that users can add custom icons -->
  <script src="_static/scripts/fontawesome.js?digest=8878045cc6db502f8baf"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf" />

    <script src="_static/documentation_options.js?v=5d3ef798"></script>
    <script src="_static/doctools.js?v=9bcbadda"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'Cpp_source';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="2.5" />
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class=" navbar-header-items__start">
    
      <div class="navbar-item">

  
    
  

<a class="navbar-brand logo" href="index.html">
  
  
  
  
  
  
    <p class="title logo__title">Lattice Microbes</p>
  
</a></div>
    
  </div>
  
  <div class=" navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="Progress.html">
    Progress
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="Installation.html">
    Installation
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="jLM%20Examples.html">
    Examples
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="Visualization.html">
    Visualization
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="API.html">
    API Reference
  </a>
</li>

            <li class="nav-item dropdown">
                <button class="btn dropdown-toggle nav-item" type="button"
                data-bs-toggle="dropdown" aria-expanded="false"
                aria-controls="pst-nav-more-links">
                    More
                </button>
                <ul id="pst-nav-more-links" class="dropdown-menu">
                    
<li class=" ">
  <a class="nav-link dropdown-item nav-internal" href="Cpp_API.html">
    C++ API
  </a>
</li>


<li class=" ">
  <a class="nav-link dropdown-item nav-internal" href="Citations.html">
    Citations
  </a>
</li>

                </ul>
            </li>
            
  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
        </div>
      
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
    </div>
  

  
    <button class="pst-navbar-icon sidebar-toggle secondary-toggle" aria-label="On this page">
      <span class="fa-solid fa-outdent"></span>
    </button>
  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar hide-on-wide">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="Progress.html">
    Progress
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="Installation.html">
    Installation
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="jLM%20Examples.html">
    Examples
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="Visualization.html">
    Visualization
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="API.html">
    API Reference
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="Cpp_API.html">
    C++ API
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="Citations.html">
    Citations
  </a>
</li>

  </ul>
</nav></div>
          
        
      </div>
    
    
    
  </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
      <div class="sidebar-primary-item">
<div id="ethical-ad-placement"
      class="flat"
      data-ea-publisher="readthedocs"
      data-ea-type="readthedocs-sidebar"
      data-ea-manual="true">
</div></div>
  </div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">

<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    <li class="breadcrumb-item active" aria-current="page"><span class="ellipsis">C++ Source Code</span></li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="c-source-code">
<h1>C++ Source Code<a class="headerlink" href="#c-source-code" title="Link to this heading">#</a></h1>
<p>This section contains the actual C++ source code files.</p>
<section id="core-functions">
<h2>Core Functions<a class="headerlink" href="#core-functions" title="Link to this heading">#</a></h2>
<section id="runsimulation-h">
<h3>runSimulation.h<a class="headerlink" href="#runsimulation-h" title="Link to this heading">#</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cm">/*</span>
<span class="linenos"> 2</span><span class="cm"> * University of Illinois Open Source License</span>
<span class="linenos"> 3</span><span class="cm"> * Copyright 2014-2018 Luthey-Schulten Group,</span>
<span class="linenos"> 4</span><span class="cm"> * All rights reserved.</span>
<span class="linenos"> 5</span><span class="cm"> * </span>
<span class="linenos"> 6</span><span class="cm"> * Developed by: Luthey-Schulten Group</span>
<span class="linenos"> 7</span><span class="cm"> * 			     University of Illinois at Urbana-Champaign</span>
<span class="linenos"> 8</span><span class="cm"> * 			     http://www.scs.uiuc.edu/~schulten</span>
<span class="linenos"> 9</span><span class="cm"> * </span>
<span class="linenos">10</span><span class="cm"> * Permission is hereby granted, free of charge, to any person obtaining a copy of</span>
<span class="linenos">11</span><span class="cm"> * this software and associated documentation files (the Software), to deal with </span>
<span class="linenos">12</span><span class="cm"> * the Software without restriction, including without limitation the rights to </span>
<span class="linenos">13</span><span class="cm"> * use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies </span>
<span class="linenos">14</span><span class="cm"> * of the Software, and to permit persons to whom the Software is furnished to </span>
<span class="linenos">15</span><span class="cm"> * do so, subject to the following conditions:</span>
<span class="linenos">16</span><span class="cm"> * </span>
<span class="linenos">17</span><span class="cm"> * - Redistributions of source code must retain the above copyright notice, </span>
<span class="linenos">18</span><span class="cm"> * this list of conditions and the following disclaimers.</span>
<span class="linenos">19</span><span class="cm"> * </span>
<span class="linenos">20</span><span class="cm"> * - Redistributions in binary form must reproduce the above copyright notice, </span>
<span class="linenos">21</span><span class="cm"> * this list of conditions and the following disclaimers in the documentation </span>
<span class="linenos">22</span><span class="cm"> * and/or other materials provided with the distribution.</span>
<span class="linenos">23</span><span class="cm"> * </span>
<span class="linenos">24</span><span class="cm"> * - Neither the names of the Luthey-Schulten Group, University of Illinois at</span>
<span class="linenos">25</span><span class="cm"> * Urbana-Champaign, nor the names of its contributors may be used to endorse or</span>
<span class="linenos">26</span><span class="cm"> * promote products derived from this Software without specific prior written</span>
<span class="linenos">27</span><span class="cm"> * permission.</span>
<span class="linenos">28</span><span class="cm"> * </span>
<span class="linenos">29</span><span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR </span>
<span class="linenos">30</span><span class="cm"> * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, </span>
<span class="linenos">31</span><span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL </span>
<span class="linenos">32</span><span class="cm"> * THE CONTRIBUTORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR </span>
<span class="linenos">33</span><span class="cm"> * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, </span>
<span class="linenos">34</span><span class="cm"> * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR </span>
<span class="linenos">35</span><span class="cm"> * OTHER DEALINGS WITH THE SOFTWARE.</span>
<span class="linenos">36</span><span class="cm"> *</span>
<span class="linenos">37</span><span class="cm"> * Author(s): Mike Hallock</span>
<span class="linenos">38</span><span class="cm"> */</span>
<span class="linenos">39</span>
<span class="linenos">40</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;me/MESolver.h&quot;</span>
<span class="linenos">41</span>
<span class="linenos">42</span><span class="cp">#ifndef _MAIN_RUN_SIMULATION_H</span>
<span class="linenos">43</span><span class="cp">#define _MAIN_RUN_SIMULATION_H</span>
<span class="linenos">44</span>
<span class="linenos">45</span><span class="kt">void</span><span class="w"> </span><span class="nf">runSimulation</span><span class="p">(</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">simulationFilename</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">replicate</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">solverClass</span><span class="p">,</span>
<span class="linenos">46</span><span class="w">               </span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="w"> </span><span class="n">cudaDevices</span><span class="p">,</span><span class="w"> </span><span class="kt">time_t</span><span class="w"> </span><span class="n">checkpointInterval</span><span class="p">);</span>
<span class="linenos">47</span><span class="kt">void</span><span class="w"> </span><span class="nf">runSolver</span><span class="p">(</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">simulationFilename</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">replicate</span><span class="p">,</span><span class="w"> </span><span class="n">lm</span><span class="o">::</span><span class="n">me</span><span class="o">::</span><span class="n">MESolver</span><span class="w"> </span><span class="o">*</span><span class="n">solver</span><span class="p">,</span>
<span class="linenos">48</span><span class="w">               </span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="w"> </span><span class="n">cudaDevices</span><span class="p">,</span><span class="w"> </span><span class="kt">time_t</span><span class="w"> </span><span class="n">checkpointInterval</span><span class="p">);</span>
<span class="linenos">49</span>
<span class="linenos">50</span><span class="cp">#endif</span>
</pre></div>
</div>
</section>
<section id="runsimulation-cpp">
<h3>runSimulation.cpp<a class="headerlink" href="#runsimulation-cpp" title="Link to this heading">#</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="linenos">  1</span><span class="cm">/*</span>
<span class="linenos">  2</span><span class="cm"> * University of Illinois Open Source License Copyright 2008-2013</span>
<span class="linenos">  3</span><span class="cm"> * Luthey-Schulten Group, Copyright 2012 Roberts Group, All rights reserved.</span>
<span class="linenos">  4</span><span class="cm"> * </span>
<span class="linenos">  5</span><span class="cm"> * Developed by: Luthey-Schulten Group University of Illinois at</span>
<span class="linenos">  6</span><span class="cm"> * Urbana-Champaign http://www.scs.uiuc.edu/~schulten</span>
<span class="linenos">  7</span><span class="cm"> * </span>
<span class="linenos">  8</span><span class="cm"> * Permission is hereby granted, free of charge, to any person obtaining a copy</span>
<span class="linenos">  9</span><span class="cm"> * of this software and associated documentation files (the Software), to deal</span>
<span class="linenos"> 10</span><span class="cm"> * with the Software without restriction, including without limitation the</span>
<span class="linenos"> 11</span><span class="cm"> * rights to use, copy, modify, merge, publish, distribute, sublicense, and/or</span>
<span class="linenos"> 12</span><span class="cm"> * sell copies of the Software, and to permit persons to whom the Software is</span>
<span class="linenos"> 13</span><span class="cm"> * furnished to do so, subject to the following conditions:</span>
<span class="linenos"> 14</span><span class="cm"> * </span>
<span class="linenos"> 15</span><span class="cm"> * - Redistributions of source code must retain the above copyright notice,</span>
<span class="linenos"> 16</span><span class="cm"> * this list of conditions and the following disclaimers.</span>
<span class="linenos"> 17</span><span class="cm"> * </span>
<span class="linenos"> 18</span><span class="cm"> * - Redistributions in binary form must reproduce the above copyright notice,</span>
<span class="linenos"> 19</span><span class="cm"> * this list of conditions and the following disclaimers in the documentation</span>
<span class="linenos"> 20</span><span class="cm"> * and/or other materials provided with the distribution.</span>
<span class="linenos"> 21</span><span class="cm"> * </span>
<span class="linenos"> 22</span><span class="cm"> * - Neither the names of the Luthey-Schulten Group, University of Illinois at</span>
<span class="linenos"> 23</span><span class="cm"> * Urbana-Champaign, the Roberts Group, Johns Hopkins University, nor the names</span>
<span class="linenos"> 24</span><span class="cm"> * of its contributors may be used to endorse or promote products derived from</span>
<span class="linenos"> 25</span><span class="cm"> * this Software without specific prior written permission.</span>
<span class="linenos"> 26</span><span class="cm"> * </span>
<span class="linenos"> 27</span><span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR</span>
<span class="linenos"> 28</span><span class="cm"> * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,</span>
<span class="linenos"> 29</span><span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL THE</span>
<span class="linenos"> 30</span><span class="cm"> * CONTRIBUTORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER</span>
<span class="linenos"> 31</span><span class="cm"> * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING</span>
<span class="linenos"> 32</span><span class="cm"> * FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS</span>
<span class="linenos"> 33</span><span class="cm"> * WITH THE SOFTWARE.</span>
<span class="linenos"> 34</span><span class="cm"> *</span>
<span class="linenos"> 35</span><span class="cm"> * Author(s): Mike Hallock, Tyler Earnest</span>
<span class="linenos"> 36</span><span class="cm"> *</span>
<span class="linenos"> 37</span><span class="cm"> ***************************************************************************</span>
<span class="linenos"> 38</span><span class="cm"> *</span>
<span class="linenos"> 39</span><span class="cm"> * runSimulation and runSolver provide a stripped-down environment for</span>
<span class="linenos"> 40</span><span class="cm"> * executing a single replicate.  The motivation is to have a non entry point</span>
<span class="linenos"> 41</span><span class="cm"> * method to call for setting up a Solver and realizing the trajectory.</span>
<span class="linenos"> 42</span><span class="cm"> * Primarily, this is to provide the python interface an easy way to run a</span>
<span class="linenos"> 43</span><span class="cm"> * Solver without requiring setting up the output queue or dealing with</span>
<span class="linenos"> 44</span><span class="cm"> * resource allocation.  </span>
<span class="linenos"> 45</span><span class="cm"> */</span>
<span class="linenos"> 46</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;config.h&quot;</span>
<span class="linenos"> 47</span><span class="cp">#if defined(MACOSX)</span>
<span class="linenos"> 48</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;sys/sysctl.h&gt;</span>
<span class="linenos"> 49</span><span class="cp">#elif defined(LINUX)</span>
<span class="linenos"> 50</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;sys/sysinfo.h&gt;</span>
<span class="linenos"> 51</span><span class="cp">#endif</span>
<span class="linenos"> 52</span>
<span class="linenos"> 53</span>
<span class="linenos"> 54</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;string&gt;</span>
<span class="linenos"> 55</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;map&gt;</span>
<span class="linenos"> 56</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;cstdio&gt;</span>
<span class="linenos"> 57</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;cstring&gt;</span>
<span class="linenos"> 58</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;ctime&gt;</span>
<span class="linenos"> 59</span><span class="cp">#if defined(MACOSX)</span>
<span class="linenos"> 60</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;sys/time.h&gt;</span>
<span class="linenos"> 61</span><span class="cp">#endif</span>
<span class="linenos"> 62</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;csignal&gt;</span>
<span class="linenos"> 63</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;cerrno&gt;</span>
<span class="linenos"> 64</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;unistd.h&gt;</span>
<span class="linenos"> 65</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;sys/wait.h&gt;</span>
<span class="linenos"> 66</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;pthread.h&gt;</span>
<span class="linenos"> 67</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;google/protobuf/stubs/common.h&gt;</span>
<span class="linenos"> 68</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;core/Print.h&quot;</span>
<span class="linenos"> 69</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;core/Exceptions.h&quot;</span>
<span class="linenos"> 70</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;core/Types.h&quot;</span>
<span class="linenos"> 71</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;core/Math.h&quot;</span>
<span class="linenos"> 72</span><span class="cp">#ifdef OPT_CUDA</span>
<span class="linenos"> 73</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;cuda/lm_cuda.h&quot;</span>
<span class="linenos"> 74</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;rdme/MGPUMpdRdmeSolver.h&quot;</span>
<span class="linenos"> 75</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;rdme/MGPUIntMpdRdmeSolver.h&quot;</span>
<span class="linenos"> 76</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;cuda.h&gt;</span>
<span class="linenos"> 77</span><span class="cp">#endif</span>
<span class="linenos"> 78</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;io/lm_hdf5.h&quot;</span>
<span class="linenos"> 79</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;io/SimulationFile.h&quot;</span>
<span class="linenos"> 80</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;DiffusionModel.pb.h&quot;</span>
<span class="linenos"> 81</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;ReactionModel.pb.h&quot;</span>
<span class="linenos"> 82</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;io/SimulationParameters.h&quot;</span>
<span class="linenos"> 83</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;core/CheckpointSignaler.h&quot;</span>
<span class="linenos"> 84</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;core/DataOutputQueue.h&quot;</span>
<span class="linenos"> 85</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;core/LocalDataOutputWorker.h&quot;</span>
<span class="linenos"> 86</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;core/SignalHandler.h&quot;</span>
<span class="linenos"> 87</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;core/ReplicateRunner.h&quot;</span>
<span class="linenos"> 88</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;core/ResourceAllocator.h&quot;</span>
<span class="linenos"> 89</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;SimulationParameters.pb.h&quot;</span>
<span class="linenos"> 90</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;thread/Thread.h&quot;</span>
<span class="linenos"> 91</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;thread/WorkerManager.h&quot;</span>
<span class="linenos"> 92</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;lptf/Profile.h&quot;</span>
<span class="linenos"> 93</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;me/MESolverFactory.h&quot;</span>
<span class="linenos"> 94</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;me/MESolver.h&quot;</span>
<span class="linenos"> 95</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;cme/CMESolver.h&quot;</span>
<span class="linenos"> 96</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;rdme/RDMESolver.h&quot;</span>
<span class="linenos"> 97</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;core/runSimulation.h&quot;</span>
<span class="linenos"> 98</span>
<span class="linenos"> 99</span><span class="k">using</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="p">;</span>
<span class="linenos">100</span><span class="k">using</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">list</span><span class="p">;</span>
<span class="linenos">101</span><span class="k">using</span><span class="w"> </span><span class="n">lm</span><span class="o">::</span><span class="n">Print</span><span class="p">;</span>
<span class="linenos">102</span><span class="k">using</span><span class="w"> </span><span class="n">lm</span><span class="o">::</span><span class="n">Exception</span><span class="p">;</span>
<span class="linenos">103</span><span class="k">using</span><span class="w"> </span><span class="n">lm</span><span class="o">::</span><span class="n">main</span><span class="o">::</span><span class="n">ReplicateRunner</span><span class="p">;</span>
<span class="linenos">104</span><span class="k">using</span><span class="w"> </span><span class="n">lm</span><span class="o">::</span><span class="n">main</span><span class="o">::</span><span class="n">ResourceAllocator</span><span class="p">;</span>
<span class="linenos">105</span><span class="k">using</span><span class="w"> </span><span class="n">lm</span><span class="o">::</span><span class="n">me</span><span class="o">::</span><span class="n">MESolverFactory</span><span class="p">;</span>
<span class="linenos">106</span><span class="k">using</span><span class="w"> </span><span class="n">lm</span><span class="o">::</span><span class="kr">thread</span><span class="o">::</span><span class="n">PthreadException</span><span class="p">;</span>
<span class="linenos">107</span>
<span class="linenos">108</span><span class="k">extern</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">globalAbort</span><span class="p">;</span>
<span class="linenos">109</span>
<span class="linenos">110</span><span class="kt">void</span><span class="w"> </span><span class="nf">abortHandler</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">x</span><span class="p">)</span>
<span class="linenos">111</span><span class="p">{</span>
<span class="linenos">112</span><span class="w">	</span><span class="n">globalAbort</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
<span class="linenos">113</span><span class="p">}</span>
<span class="linenos">114</span>
<span class="linenos">115</span><span class="kt">void</span><span class="w"> </span><span class="nf">runSimulation</span><span class="p">(</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">simulationFilename</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">replicate</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">solverClass</span><span class="p">,</span>
<span class="linenos">116</span><span class="w">               </span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="w"> </span><span class="n">cudaDevices</span><span class="p">,</span><span class="w"> </span><span class="kt">time_t</span><span class="w"> </span><span class="n">checkpointInterval</span><span class="p">)</span>
<span class="linenos">117</span><span class="p">{</span>
<span class="linenos">118</span><span class="w">    </span><span class="n">lm</span><span class="o">::</span><span class="n">me</span><span class="o">::</span><span class="n">MESolverFactory</span><span class="w"> </span><span class="n">solverFactory</span><span class="p">;</span>
<span class="linenos">119</span><span class="w">    </span><span class="n">solverFactory</span><span class="p">.</span><span class="n">setSolver</span><span class="p">(</span><span class="n">solverClass</span><span class="p">);</span>
<span class="linenos">120</span><span class="w">    </span><span class="n">lm</span><span class="o">::</span><span class="n">me</span><span class="o">::</span><span class="n">MESolver</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">solver</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="linenos">121</span><span class="w">    </span><span class="n">solver</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">solverFactory</span><span class="p">.</span><span class="n">instantiate</span><span class="p">();</span>
<span class="linenos">122</span>
<span class="linenos">123</span><span class="w">    </span><span class="n">runSolver</span><span class="p">(</span><span class="n">simulationFilename</span><span class="p">,</span><span class="w"> </span><span class="n">replicate</span><span class="p">,</span><span class="w"> </span><span class="n">solver</span><span class="p">,</span><span class="w"> </span><span class="n">cudaDevices</span><span class="p">,</span><span class="n">checkpointInterval</span><span class="p">);</span>
<span class="linenos">124</span>
<span class="linenos">125</span><span class="w">    </span><span class="c1">// Free the solver we created</span>
<span class="linenos">126</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">solver</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="k">delete</span><span class="w"> </span><span class="n">solver</span><span class="p">;</span><span class="w"> </span><span class="n">solver</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;}</span>
<span class="linenos">127</span>
<span class="linenos">128</span><span class="p">}</span>
<span class="linenos">129</span>
<span class="linenos">130</span><span class="kt">void</span><span class="w"> </span><span class="nf">runSolver</span><span class="p">(</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">simulationFilename</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">replicate</span><span class="p">,</span><span class="w"> </span><span class="n">lm</span><span class="o">::</span><span class="n">me</span><span class="o">::</span><span class="n">MESolver</span><span class="w"> </span><span class="o">*</span><span class="n">solver</span><span class="p">,</span>
<span class="linenos">131</span><span class="w">               </span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="w"> </span><span class="n">cudaDevices</span><span class="p">,</span><span class="w"> </span><span class="kt">time_t</span><span class="w"> </span><span class="n">checkpointInterval</span><span class="p">)</span>
<span class="linenos">132</span><span class="p">{</span>
<span class="linenos">133</span><span class="w">    </span><span class="n">PROF_SET_THREAD</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="linenos">134</span><span class="w">    </span><span class="n">PROF_BEGIN</span><span class="p">(</span><span class="n">PROF_SIM_RUN</span><span class="p">);</span>
<span class="linenos">135</span><span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">cpuCoresPerReplicate</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span><span class="o">*</span><span class="n">cudaDevices</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
<span class="linenos">136</span><span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">cudaDevicesPerReplicate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span><span class="o">*</span><span class="n">cudaDevices</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
<span class="linenos">137</span><span class="w">    </span><span class="n">Print</span><span class="o">::</span><span class="n">printf</span><span class="p">(</span><span class="n">Print</span><span class="o">::</span><span class="n">DEBUG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;interactive process started.&quot;</span><span class="p">);</span>
<span class="linenos">138</span>
<span class="linenos">139</span><span class="cp">#ifdef OPT_CUDA</span>
<span class="linenos">140</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">dynamic_cast</span><span class="o">&lt;</span><span class="n">lm</span><span class="o">::</span><span class="n">rdme</span><span class="o">::</span><span class="n">MGPUMpdRdmeSolver</span><span class="o">*&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">solver</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="k">dynamic_cast</span><span class="o">&lt;</span><span class="n">lm</span><span class="o">::</span><span class="n">rdme</span><span class="o">::</span><span class="n">MGPUIntMpdRdmeSolver</span><span class="o">*&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">solver</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">cudaDevices</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">141</span><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="n">lm</span><span class="o">::</span><span class="n">Exception</span><span class="p">(</span><span class="s">&quot;Multiple CUDA devices specified for single GPU solver&quot;</span><span class="p">);</span>
<span class="linenos">142</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">143</span><span class="cp">#endif</span>
<span class="linenos">144</span>
<span class="linenos">145</span><span class="w">    </span><span class="n">signal</span><span class="p">(</span><span class="n">SIGINT</span><span class="p">,</span><span class="w"> </span><span class="n">abortHandler</span><span class="p">);</span>
<span class="linenos">146</span>
<span class="linenos">147</span><span class="w">    </span><span class="c1">// Get the number of processors. ( copied from Main.cpp )</span>
<span class="linenos">148</span><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">numberCpuCores</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">149</span><span class="cp">#if defined(MACOSX)</span>
<span class="linenos">150</span><span class="w">    </span><span class="n">uint</span><span class="w"> </span><span class="n">physicalCpuCores</span><span class="p">;</span>
<span class="linenos">151</span><span class="w">    </span><span class="kt">size_t</span><span class="w">  </span><span class="n">physicalCpuCoresSize</span><span class="o">=</span><span class="k">sizeof</span><span class="p">(</span><span class="n">physicalCpuCores</span><span class="p">);</span>
<span class="linenos">152</span><span class="w">    </span><span class="n">sysctlbyname</span><span class="p">(</span><span class="s">&quot;hw.activecpu&quot;</span><span class="p">,</span><span class="o">&amp;</span><span class="n">physicalCpuCores</span><span class="p">,</span><span class="o">&amp;</span><span class="n">physicalCpuCoresSize</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
<span class="linenos">153</span><span class="w">    </span><span class="n">numberCpuCores</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">physicalCpuCores</span><span class="p">;</span>
<span class="linenos">154</span><span class="cp">#elif defined(LINUX)</span>
<span class="linenos">155</span><span class="w">    </span><span class="cp">#ifdef ARM</span>
<span class="linenos">156</span><span class="w">        </span><span class="n">numberCpuCores</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_nprocs_conf</span><span class="p">();</span>
<span class="linenos">157</span><span class="w">    </span><span class="cp">#else</span>
<span class="linenos">158</span><span class="w">        </span><span class="n">numberCpuCores</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_nprocs</span><span class="p">();</span>
<span class="linenos">159</span><span class="w">    </span><span class="cp">#endif</span>
<span class="linenos">160</span><span class="cp">#else</span>
<span class="linenos">161</span><span class="w">    </span><span class="cp">#error &quot;Unsupported architecture.&quot;</span>
<span class="linenos">162</span><span class="cp">#endif</span>
<span class="linenos">163</span>
<span class="linenos">164</span><span class="w">    </span><span class="c1">// Create the resource allocator, subtract one core for the data output thread.</span>
<span class="linenos">165</span><span class="cp">#ifdef OPT_CUDA</span>
<span class="linenos">166</span><span class="w">    </span><span class="n">Print</span><span class="o">::</span><span class="n">printf</span><span class="p">(</span><span class="n">Print</span><span class="o">::</span><span class="n">INFO</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Using %d processor(s) and %zd CUDA device(s) per process.&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">numberCpuCores</span><span class="p">,</span><span class="w"> </span><span class="n">cudaDevices</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>
<span class="linenos">167</span><span class="w">    </span><span class="n">Print</span><span class="o">::</span><span class="n">printf</span><span class="p">(</span><span class="n">Print</span><span class="o">::</span><span class="n">INFO</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Assigning %0.2f processor(s) and %0.2f CUDA device(s) per replicate.&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">cpuCoresPerReplicate</span><span class="p">,</span><span class="w"> </span><span class="n">cudaDevicesPerReplicate</span><span class="p">);</span>
<span class="linenos">168</span><span class="w">    </span><span class="n">ResourceAllocator</span><span class="w"> </span><span class="n">resourceAllocator</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">numberCpuCores</span><span class="p">,</span><span class="w"> </span><span class="n">cpuCoresPerReplicate</span><span class="p">,</span><span class="w"> </span><span class="n">cudaDevices</span><span class="p">,</span><span class="w"> </span><span class="n">cudaDevicesPerReplicate</span><span class="p">);</span>
<span class="linenos">169</span><span class="cp">#else</span>
<span class="linenos">170</span><span class="w">    </span><span class="n">Print</span><span class="o">::</span><span class="n">printf</span><span class="p">(</span><span class="n">Print</span><span class="o">::</span><span class="n">INFO</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Using %d processor(s) per process.&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">numberCpuCores</span><span class="p">);</span>
<span class="linenos">171</span><span class="w">    </span><span class="n">Print</span><span class="o">::</span><span class="n">printf</span><span class="p">(</span><span class="n">Print</span><span class="o">::</span><span class="n">INFO</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Assigning %0.2f processor(s) per replicate.&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">cpuCoresPerReplicate</span><span class="p">);</span>
<span class="linenos">172</span><span class="w">    </span><span class="n">ResourceAllocator</span><span class="w"> </span><span class="n">resourceAllocator</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">numberCpuCores</span><span class="p">,</span><span class="w"> </span><span class="n">cpuCoresPerReplicate</span><span class="p">);</span>
<span class="linenos">173</span><span class="cp">#endif</span>
<span class="linenos">174</span>
<span class="linenos">175</span><span class="w">    </span><span class="n">ResourceAllocator</span><span class="o">::</span><span class="n">ComputeResources</span><span class="w"> </span><span class="n">resources</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">resourceAllocator</span><span class="p">.</span><span class="n">assignReplicate</span><span class="p">(</span><span class="n">replicate</span><span class="p">);</span>
<span class="linenos">176</span>
<span class="linenos">177</span><span class="w">    </span><span class="n">lm</span><span class="o">::</span><span class="n">main</span><span class="o">::</span><span class="n">CheckpointSignaler</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">checkpointSignaler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="linenos">178</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">checkpointInterval</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">179</span><span class="w">        </span><span class="n">checkpointSignaler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">lm</span><span class="o">::</span><span class="n">main</span><span class="o">::</span><span class="n">CheckpointSignaler</span><span class="p">();</span>
<span class="linenos">180</span><span class="w">        </span><span class="n">checkpointSignaler</span><span class="o">-&gt;</span><span class="n">setAffinity</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="linenos">181</span><span class="w">        </span><span class="n">checkpointSignaler</span><span class="o">-&gt;</span><span class="n">startCheckpointing</span><span class="p">(</span><span class="n">checkpointInterval</span><span class="p">);</span>
<span class="linenos">182</span><span class="w">        </span><span class="n">checkpointSignaler</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">();</span>
<span class="linenos">183</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">184</span>
<span class="linenos">185</span>
<span class="linenos">186</span><span class="w">    </span><span class="c1">// Open the file.</span>
<span class="linenos">187</span><span class="w">    </span><span class="n">lm</span><span class="o">::</span><span class="n">io</span><span class="o">::</span><span class="n">hdf5</span><span class="o">::</span><span class="n">SimulationFile</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">lm</span><span class="o">::</span><span class="n">io</span><span class="o">::</span><span class="n">hdf5</span><span class="o">::</span><span class="n">SimulationFile</span><span class="p">(</span><span class="n">simulationFilename</span><span class="p">);</span>
<span class="linenos">188</span>
<span class="linenos">189</span><span class="w">    </span><span class="c1">// Start the data output thread.</span>
<span class="linenos">190</span><span class="w">    </span><span class="n">lm</span><span class="o">::</span><span class="n">main</span><span class="o">::</span><span class="n">LocalDataOutputWorker</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">dataOutputWorker</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">lm</span><span class="o">::</span><span class="n">main</span><span class="o">::</span><span class="n">LocalDataOutputWorker</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
<span class="linenos">191</span><span class="w">    </span><span class="c1">//dataOutputWorker-&gt;setAffinity(reservedCpuCore);</span>
<span class="linenos">192</span><span class="w">    </span><span class="n">dataOutputWorker</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">();</span>
<span class="linenos">193</span>
<span class="linenos">194</span><span class="w">    </span><span class="c1">// Set the data output handler to be the worker.</span>
<span class="linenos">195</span><span class="w">    </span><span class="n">lm</span><span class="o">::</span><span class="n">main</span><span class="o">::</span><span class="n">DataOutputQueue</span><span class="o">::</span><span class="n">setInstance</span><span class="p">(</span><span class="n">dataOutputWorker</span><span class="p">);</span>
<span class="linenos">196</span>
<span class="linenos">197</span><span class="w">    </span><span class="c1">// Get the simulation parameters.</span>
<span class="linenos">198</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">,</span><span class="n">string</span><span class="o">&gt;</span><span class="w"> </span><span class="n">simulationParameters</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">file</span><span class="o">-&gt;</span><span class="n">getParameters</span><span class="p">();</span>
<span class="linenos">199</span>
<span class="linenos">200</span><span class="w">    </span><span class="c1">// Get the reaction model.</span>
<span class="linenos">201</span><span class="w">    </span><span class="n">lm</span><span class="o">::</span><span class="n">io</span><span class="o">::</span><span class="n">ReactionModel</span><span class="w"> </span><span class="n">reactionModel</span><span class="p">;</span>
<span class="linenos">202</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">solver</span><span class="o">-&gt;</span><span class="n">needsReactionModel</span><span class="p">())</span>
<span class="linenos">203</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">204</span><span class="w">        </span><span class="n">file</span><span class="o">-&gt;</span><span class="n">getReactionModel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reactionModel</span><span class="p">);</span>
<span class="linenos">205</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">206</span>
<span class="linenos">207</span><span class="w">    </span><span class="c1">// Get the diffusion model.</span>
<span class="linenos">208</span><span class="w">    </span><span class="n">lm</span><span class="o">::</span><span class="n">io</span><span class="o">::</span><span class="n">DiffusionModel</span><span class="w"> </span><span class="n">diffusionModel</span><span class="p">;</span>
<span class="linenos">209</span><span class="w">    </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">lattice</span><span class="o">=</span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">latticeSites</span><span class="o">=</span><span class="nb">NULL</span><span class="p">;</span>
<span class="linenos">210</span><span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">latticeSize</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">latticeSitesSize</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">211</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">solver</span><span class="o">-&gt;</span><span class="n">needsDiffusionModel</span><span class="p">())</span>
<span class="linenos">212</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">213</span><span class="w">        </span><span class="n">file</span><span class="o">-&gt;</span><span class="n">getDiffusionModel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">diffusionModel</span><span class="p">);</span>
<span class="linenos">214</span><span class="w">        </span><span class="n">latticeSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">diffusionModel</span><span class="p">.</span><span class="n">lattice_x_size</span><span class="p">()</span><span class="o">*</span><span class="n">diffusionModel</span><span class="p">.</span><span class="n">lattice_y_size</span><span class="p">()</span><span class="o">*</span><span class="n">diffusionModel</span><span class="p">.</span><span class="n">lattice_z_size</span><span class="p">()</span><span class="o">*</span><span class="n">diffusionModel</span><span class="p">.</span><span class="n">particles_per_site</span><span class="p">()</span><span class="o">*</span><span class="n">diffusionModel</span><span class="p">.</span><span class="n">bytes_per_particle</span><span class="p">();</span>
<span class="linenos">215</span><span class="w">        </span><span class="n">lattice</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">uint8_t</span><span class="p">[</span><span class="n">latticeSize</span><span class="p">];</span>
<span class="linenos">216</span><span class="w">        </span><span class="n">latticeSitesSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">diffusionModel</span><span class="p">.</span><span class="n">lattice_x_size</span><span class="p">()</span><span class="o">*</span><span class="n">diffusionModel</span><span class="p">.</span><span class="n">lattice_y_size</span><span class="p">()</span><span class="o">*</span><span class="n">diffusionModel</span><span class="p">.</span><span class="n">lattice_z_size</span><span class="p">();</span>
<span class="linenos">217</span><span class="w">        </span><span class="n">latticeSites</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">uint8_t</span><span class="p">[</span><span class="n">latticeSitesSize</span><span class="p">];</span>
<span class="linenos">218</span><span class="w">        </span><span class="n">file</span><span class="o">-&gt;</span><span class="n">getDiffusionModelLattice</span><span class="p">(</span><span class="o">&amp;</span><span class="n">diffusionModel</span><span class="p">,</span><span class="w"> </span><span class="n">lattice</span><span class="p">,</span><span class="w"> </span><span class="n">latticeSize</span><span class="p">,</span><span class="w"> </span><span class="n">latticeSites</span><span class="p">,</span><span class="w"> </span><span class="n">latticeSitesSize</span><span class="p">);</span>
<span class="linenos">219</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">220</span>
<span class="linenos">221</span><span class="w">    </span><span class="c1">// Start a new thread for the replicate.</span>
<span class="linenos">222</span><span class="w">    </span><span class="n">Print</span><span class="o">::</span><span class="n">printf</span><span class="p">(</span><span class="n">Print</span><span class="o">::</span><span class="n">DEBUG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Starting replicate %d (%s).&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">replicate</span><span class="p">,</span><span class="w"> </span><span class="n">resources</span><span class="p">.</span><span class="n">toString</span><span class="p">().</span><span class="n">c_str</span><span class="p">());</span>
<span class="linenos">223</span>
<span class="linenos">224</span><span class="w">    </span><span class="cp">#if defined(OPT_CUDA)</span>
<span class="linenos">225</span><span class="w">    </span><span class="c1">// Set the GPU affinity.</span>
<span class="linenos">226</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">resources</span><span class="p">.</span><span class="n">cudaDevices</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">227</span><span class="w">            </span><span class="n">lm</span><span class="o">::</span><span class="n">CUDA</span><span class="o">::</span><span class="n">setCurrentDevice</span><span class="p">(</span><span class="n">resources</span><span class="p">.</span><span class="n">cudaDevices</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="linenos">228</span><span class="w">    </span><span class="cp">#endif</span>
<span class="linenos">229</span>
<span class="linenos">230</span><span class="w">    </span><span class="k">try</span>
<span class="linenos">231</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">232</span><span class="w">        </span><span class="c1">// Run the simulation using the specified solver.</span>
<span class="linenos">233</span><span class="w">        </span><span class="n">solver</span><span class="o">-&gt;</span><span class="n">initialize</span><span class="p">(</span><span class="n">replicate</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">simulationParameters</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">resources</span><span class="p">);</span>
<span class="linenos">234</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">solver</span><span class="o">-&gt;</span><span class="n">needsReactionModel</span><span class="p">())</span>
<span class="linenos">235</span><span class="w">        </span><span class="p">{</span>
<span class="linenos">236</span><span class="w">            </span><span class="p">((</span><span class="n">lm</span><span class="o">::</span><span class="n">cme</span><span class="o">::</span><span class="n">CMESolver</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">solver</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">setReactionModel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reactionModel</span><span class="p">);</span>
<span class="linenos">237</span><span class="w">        </span><span class="p">}</span>
<span class="linenos">238</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">solver</span><span class="o">-&gt;</span><span class="n">needsDiffusionModel</span><span class="p">())</span>
<span class="linenos">239</span><span class="w">        </span><span class="p">{</span>
<span class="linenos">240</span><span class="w">            </span><span class="p">((</span><span class="n">lm</span><span class="o">::</span><span class="n">rdme</span><span class="o">::</span><span class="n">RDMESolver</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">solver</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">setDiffusionModel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">diffusionModel</span><span class="p">,</span><span class="w"> </span><span class="n">lattice</span><span class="p">,</span><span class="w"> </span><span class="n">latticeSize</span><span class="p">,</span><span class="w"> </span><span class="n">latticeSites</span><span class="p">,</span><span class="w"> </span><span class="n">latticeSitesSize</span><span class="p">);</span>
<span class="linenos">241</span><span class="w">        </span><span class="p">}</span>
<span class="linenos">242</span><span class="w">        </span><span class="n">solver</span><span class="o">-&gt;</span><span class="n">generateTrajectory</span><span class="p">();</span>
<span class="linenos">243</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">244</span><span class="w">    </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">lm</span><span class="o">::</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span>
<span class="linenos">245</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">246</span><span class="w">        </span><span class="n">Print</span><span class="o">::</span><span class="n">printf</span><span class="p">(</span><span class="n">Print</span><span class="o">::</span><span class="n">ERROR</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Exception during execution of replicate: %s.&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">what</span><span class="p">());</span>
<span class="linenos">247</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">248</span><span class="w">    </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">exception</span><span class="o">&amp;</span><span class="w"> </span><span class="n">e</span><span class="p">)</span>
<span class="linenos">249</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">250</span><span class="w">        </span><span class="n">Print</span><span class="o">::</span><span class="n">printf</span><span class="p">(</span><span class="n">Print</span><span class="o">::</span><span class="n">ERROR</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Std exception during execution of replicate: %s.&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">what</span><span class="p">());</span>
<span class="linenos">251</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">252</span><span class="w">    </span><span class="k">catch</span><span class="w"> </span><span class="p">(...)</span>
<span class="linenos">253</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">254</span><span class="w">        </span><span class="n">Print</span><span class="o">::</span><span class="n">printf</span><span class="p">(</span><span class="n">Print</span><span class="o">::</span><span class="n">ERROR</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Unknown exception during execution of replicate.&quot;</span><span class="p">);</span>
<span class="linenos">255</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">256</span>
<span class="linenos">257</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">checkpointInterval</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">258</span><span class="w">        </span><span class="n">checkpointSignaler</span><span class="o">-&gt;</span><span class="n">stopCheckpointing</span><span class="p">();</span>
<span class="linenos">259</span>
<span class="linenos">260</span>
<span class="linenos">261</span><span class="w">    </span><span class="n">Print</span><span class="o">::</span><span class="n">printf</span><span class="p">(</span><span class="n">Print</span><span class="o">::</span><span class="n">DEBUG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Stopping worker threads.&quot;</span><span class="p">);</span>
<span class="linenos">262</span><span class="w">    </span><span class="n">lm</span><span class="o">::</span><span class="kr">thread</span><span class="o">::</span><span class="n">WorkerManager</span><span class="o">::</span><span class="n">getInstance</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">stopWorkers</span><span class="p">();</span>
<span class="linenos">263</span>
<span class="linenos">264</span><span class="w">    </span><span class="c1">// Close the simulation file.</span>
<span class="linenos">265</span><span class="w">    </span><span class="k">delete</span><span class="w"> </span><span class="n">file</span><span class="p">;</span>
<span class="linenos">266</span><span class="w">    </span><span class="n">Print</span><span class="o">::</span><span class="n">printf</span><span class="p">(</span><span class="n">Print</span><span class="o">::</span><span class="n">INFO</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Simulation file closed.&quot;</span><span class="p">);</span>
<span class="linenos">267</span>
<span class="linenos">268</span>
<span class="linenos">269</span><span class="w">    </span><span class="c1">// Cleanup any resources.</span>
<span class="linenos">270</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">checkpointInterval</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">271</span><span class="w">        </span><span class="k">delete</span><span class="w"> </span><span class="n">checkpointSignaler</span><span class="p">;</span>
<span class="linenos">272</span><span class="w">    </span><span class="k">delete</span><span class="w"> </span><span class="n">dataOutputWorker</span><span class="p">;</span>
<span class="linenos">273</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">lattice</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="k">delete</span><span class="w"> </span><span class="p">[]</span><span class="w"> </span><span class="n">lattice</span><span class="p">;</span><span class="w"> </span><span class="n">lattice</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;}</span>
<span class="linenos">274</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">latticeSites</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="k">delete</span><span class="w"> </span><span class="p">[]</span><span class="w"> </span><span class="n">latticeSites</span><span class="p">;</span><span class="w"> </span><span class="n">latticeSites</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;}</span>
<span class="linenos">275</span>
<span class="linenos">276</span><span class="w">    </span><span class="n">Print</span><span class="o">::</span><span class="n">printf</span><span class="p">(</span><span class="n">Print</span><span class="o">::</span><span class="n">DEBUG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Master process finished.&quot;</span><span class="p">);</span>
<span class="linenos">277</span>
<span class="linenos">278</span>
<span class="linenos">279</span><span class="w">    </span><span class="n">PROF_END</span><span class="p">(</span><span class="n">PROF_SIM_RUN</span><span class="p">);</span>
<span class="linenos">280</span><span class="p">}</span>
</pre></div>
</div>
</section>
</section>
<section id="lattice-classes">
<h2>Lattice Classes<a class="headerlink" href="#lattice-classes" title="Link to this heading">#</a></h2>
<section id="lattice-h">
<h3>Lattice.h<a class="headerlink" href="#lattice-h" title="Link to this heading">#</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="linenos">  1</span><span class="cm">/*</span>
<span class="linenos">  2</span><span class="cm"> * University of Illinois Open Source License</span>
<span class="linenos">  3</span><span class="cm"> * Copyright 2008-2018 Luthey-Schulten Group,</span>
<span class="linenos">  4</span><span class="cm"> * Copyright 2012 Roberts Group,</span>
<span class="linenos">  5</span><span class="cm"> * All rights reserved.</span>
<span class="linenos">  6</span><span class="cm"> * </span>
<span class="linenos">  7</span><span class="cm"> * Developed by: Luthey-Schulten Group</span>
<span class="linenos">  8</span><span class="cm"> * 			     University of Illinois at Urbana-Champaign</span>
<span class="linenos">  9</span><span class="cm"> * 			     http://www.scs.uiuc.edu/~schulten</span>
<span class="linenos"> 10</span><span class="cm"> * </span>
<span class="linenos"> 11</span><span class="cm"> * Developed by: Roberts Group</span>
<span class="linenos"> 12</span><span class="cm"> * 			     Johns Hopkins University</span>
<span class="linenos"> 13</span><span class="cm"> * 			     http://biophysics.jhu.edu/roberts/</span>
<span class="linenos"> 14</span><span class="cm"> *</span>
<span class="linenos"> 15</span><span class="cm"> * Permission is hereby granted, free of charge, to any person obtaining a copy of</span>
<span class="linenos"> 16</span><span class="cm"> * this software and associated documentation files (the Software), to deal with </span>
<span class="linenos"> 17</span><span class="cm"> * the Software without restriction, including without limitation the rights to </span>
<span class="linenos"> 18</span><span class="cm"> * use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies </span>
<span class="linenos"> 19</span><span class="cm"> * of the Software, and to permit persons to whom the Software is furnished to </span>
<span class="linenos"> 20</span><span class="cm"> * do so, subject to the following conditions:</span>
<span class="linenos"> 21</span><span class="cm"> * </span>
<span class="linenos"> 22</span><span class="cm"> * - Redistributions of source code must retain the above copyright notice, </span>
<span class="linenos"> 23</span><span class="cm"> * this list of conditions and the following disclaimers.</span>
<span class="linenos"> 24</span><span class="cm"> * </span>
<span class="linenos"> 25</span><span class="cm"> * - Redistributions in binary form must reproduce the above copyright notice, </span>
<span class="linenos"> 26</span><span class="cm"> * this list of conditions and the following disclaimers in the documentation </span>
<span class="linenos"> 27</span><span class="cm"> * and/or other materials provided with the distribution.</span>
<span class="linenos"> 28</span><span class="cm"> * </span>
<span class="linenos"> 29</span><span class="cm"> * - Neither the names of the Luthey-Schulten Group, University of Illinois at</span>
<span class="linenos"> 30</span><span class="cm"> * Urbana-Champaign, the Roberts Group, Johns Hopkins University, nor the names</span>
<span class="linenos"> 31</span><span class="cm"> * of its contributors may be used to endorse or promote products derived from</span>
<span class="linenos"> 32</span><span class="cm"> * this Software without specific prior written permission.</span>
<span class="linenos"> 33</span><span class="cm"> * </span>
<span class="linenos"> 34</span><span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR </span>
<span class="linenos"> 35</span><span class="cm"> * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, </span>
<span class="linenos"> 36</span><span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL </span>
<span class="linenos"> 37</span><span class="cm"> * THE CONTRIBUTORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR </span>
<span class="linenos"> 38</span><span class="cm"> * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, </span>
<span class="linenos"> 39</span><span class="cm"> * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR </span>
<span class="linenos"> 40</span><span class="cm"> * OTHER DEALINGS WITH THE SOFTWARE.</span>
<span class="linenos"> 41</span><span class="cm"> *</span>
<span class="linenos"> 42</span><span class="cm"> * Author(s): Elijah Roberts</span>
<span class="linenos"> 43</span><span class="cm"> */</span>
<span class="linenos"> 44</span>
<span class="linenos"> 45</span><span class="cp">#ifndef LM_RDME_LATTICE_H_</span>
<span class="linenos"> 46</span><span class="cp">#define LM_RDME_LATTICE_H_</span>
<span class="linenos"> 47</span>
<span class="linenos"> 48</span><span class="c1">//using namespace std; //TODO: workaround for cuda compiler bug, remove this line when fixed.</span>
<span class="linenos"> 49</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;vector&gt;</span>
<span class="linenos"> 50</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;map&gt;</span>
<span class="linenos"> 51</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;core/Types.h&quot;</span>
<span class="linenos"> 52</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;core/Exceptions.h&quot;</span>
<span class="linenos"> 53</span>
<span class="linenos"> 54</span><span class="c1">// Type to store a lattice index.</span>
<span class="linenos"> 55</span><span class="k">typedef</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w">            </span><span class="n">lattice_size_t</span><span class="p">;</span>
<span class="linenos"> 56</span>
<span class="linenos"> 57</span><span class="c1">/// @struct lattice_coord_t</span>
<span class="linenos"> 58</span><span class="c1">/// @brief Type to store a lattice coordinate.</span>
<span class="linenos"> 59</span><span class="k">struct</span><span class="w"> </span><span class="nc">lattice_coord_t</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 60</span><span class="w">    </span><span class="c1">/// @brief Create a lattice coordinate</span>
<span class="linenos"> 61</span><span class="w">    </span><span class="c1">/// @param x Lattice x point</span>
<span class="linenos"> 62</span><span class="w">    </span><span class="c1">/// @param y Lattice y point</span>
<span class="linenos"> 63</span><span class="w">    </span><span class="c1">/// @param z Lattice z point</span>
<span class="linenos"> 64</span><span class="w">    </span><span class="n">lattice_coord_t</span><span class="p">(</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">z</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">:</span><span class="n">x</span><span class="p">(</span><span class="n">x</span><span class="p">),</span><span class="n">y</span><span class="p">(</span><span class="n">y</span><span class="p">),</span><span class="n">z</span><span class="p">(</span><span class="n">z</span><span class="p">){}</span>
<span class="linenos"> 65</span><span class="w">    </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">x</span><span class="p">;</span>
<span class="linenos"> 66</span><span class="w">    </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">y</span><span class="p">;</span>
<span class="linenos"> 67</span><span class="w">    </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">z</span><span class="p">;</span>
<span class="linenos"> 68</span><span class="p">};</span>
<span class="linenos"> 69</span>
<span class="linenos"> 70</span><span class="c1">// Type to store a particle index in a site.</span>
<span class="linenos"> 71</span><span class="k">typedef</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w">            </span><span class="n">site_size_t</span><span class="p">;</span>
<span class="linenos"> 72</span>
<span class="linenos"> 73</span><span class="c1">// Type to store a lattice site type.</span>
<span class="linenos"> 74</span><span class="k">typedef</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w">            </span><span class="n">site_t</span><span class="p">;</span>
<span class="linenos"> 75</span>
<span class="linenos"> 76</span><span class="c1">// Type to store a lattice particle type.</span>
<span class="linenos"> 77</span><span class="k">typedef</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w">            </span><span class="n">particle_t</span><span class="p">;</span>
<span class="linenos"> 78</span>
<span class="linenos"> 79</span><span class="c1">/// @struct particle_loc_t</span>
<span class="linenos"> 80</span><span class="c1">/// @brief Type to store a particle and position.</span>
<span class="linenos"> 81</span><span class="k">struct</span><span class="w"> </span><span class="nc">particle_loc_t</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 82</span><span class="w">    </span><span class="c1">/// @brief Create a particle location</span>
<span class="linenos"> 83</span><span class="w">    </span><span class="c1">/// @param p Particle type at the location</span>
<span class="linenos"> 84</span><span class="w">    </span><span class="c1">/// @param x Lattice x point</span>
<span class="linenos"> 85</span><span class="w">    </span><span class="c1">/// @param y Lattice y point</span>
<span class="linenos"> 86</span><span class="w">    </span><span class="c1">/// @param z Lattice z point</span>
<span class="linenos"> 87</span><span class="w">    </span><span class="c1">/// @param index Lattice index</span>
<span class="linenos"> 88</span><span class="w">    </span><span class="n">particle_loc_t</span><span class="p">(</span><span class="n">particle_t</span><span class="w"> </span><span class="n">p</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">z</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">site_size_t</span><span class="w"> </span><span class="n">index</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">:</span><span class="n">p</span><span class="p">(</span><span class="n">p</span><span class="p">),</span><span class="n">x</span><span class="p">(</span><span class="n">x</span><span class="p">),</span><span class="n">y</span><span class="p">(</span><span class="n">y</span><span class="p">),</span><span class="n">z</span><span class="p">(</span><span class="n">z</span><span class="p">),</span><span class="n">index</span><span class="p">(</span><span class="n">index</span><span class="p">){}</span>
<span class="linenos"> 89</span><span class="w">    </span><span class="n">particle_t</span><span class="w"> </span><span class="n">p</span><span class="p">;</span>
<span class="linenos"> 90</span><span class="w">    </span>
<span class="linenos"> 91</span><span class="w">    </span><span class="c1">// Location in the grid and index</span>
<span class="linenos"> 92</span><span class="w">    </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">x</span><span class="p">;</span>
<span class="linenos"> 93</span><span class="w">    </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">y</span><span class="p">;</span>
<span class="linenos"> 94</span><span class="w">    </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">z</span><span class="p">;</span>
<span class="linenos"> 95</span><span class="w">    </span><span class="n">site_size_t</span><span class="w"> </span><span class="n">index</span><span class="p">;</span>
<span class="linenos"> 96</span><span class="p">};</span>
<span class="linenos"> 97</span>
<span class="linenos"> 98</span><span class="k">namespace</span><span class="w"> </span><span class="nn">lm</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 99</span><span class="k">namespace</span><span class="w"> </span><span class="nn">rdme</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">100</span>
<span class="linenos">101</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">getCompiledLatticeMaxOccupancy</span><span class="p">();</span>
<span class="linenos">102</span>
<span class="linenos">103</span><span class="c1">/// @class InvalidSiteException</span>
<span class="linenos">104</span><span class="c1">/// @brief InvalidArgException for when an index into the lattice is out of bound or does not exist.</span>
<span class="linenos">105</span><span class="k">class</span><span class="w"> </span><span class="nc">InvalidSiteException</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">InvalidArgException</span>
<span class="linenos">106</span><span class="p">{</span>
<span class="linenos">107</span><span class="k">public</span><span class="o">:</span>
<span class="linenos">108</span><span class="w">    </span><span class="c1">/// @brief Create an exception based on the lattice location</span>
<span class="linenos">109</span><span class="w">    </span><span class="c1">/// @param x Lattice x point</span>
<span class="linenos">110</span><span class="w">    </span><span class="c1">/// @param y Lattice y point</span>
<span class="linenos">111</span><span class="w">    </span><span class="c1">/// @param z Lattice z Point</span>
<span class="linenos">112</span><span class="w">    </span><span class="n">InvalidSiteException</span><span class="p">(</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">InvalidArgException</span><span class="p">(</span><span class="s">&quot;lattice site index&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{}</span>
<span class="linenos">113</span><span class="w">    </span><span class="c1">/// @brief Create an exception based on the lattice index</span>
<span class="linenos">114</span><span class="w">    </span><span class="c1">/// @param index Lattice index</span>
<span class="linenos">115</span><span class="w">    </span><span class="n">InvalidSiteException</span><span class="p">(</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">index</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">InvalidArgException</span><span class="p">(</span><span class="s">&quot;lattice site index&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{}</span>
<span class="linenos">116</span><span class="p">};</span>
<span class="linenos">117</span>
<span class="linenos">118</span><span class="c1">/// @class InvalidParticleException</span>
<span class="linenos">119</span><span class="c1">/// @brief InvalidArgException for when a particle is </span>
<span class="linenos">120</span><span class="k">class</span><span class="w"> </span><span class="nc">InvalidParticleException</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">InvalidArgException</span>
<span class="linenos">121</span><span class="p">{</span>
<span class="linenos">122</span><span class="k">public</span><span class="o">:</span>
<span class="linenos">123</span><span class="w">    </span><span class="c1">/// @brief Create an eception based on the particle index</span>
<span class="linenos">124</span><span class="w">    </span><span class="c1">/// @param particleIndex Index of the particle</span>
<span class="linenos">125</span><span class="w">    </span><span class="n">InvalidParticleException</span><span class="p">(</span><span class="n">site_size_t</span><span class="w"> </span><span class="n">particleIndex</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">InvalidArgException</span><span class="p">(</span><span class="s">&quot;particleIndex&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Invalid particle index&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">particleIndex</span><span class="p">)</span><span class="w"> </span><span class="p">{}</span>
<span class="linenos">126</span><span class="p">};</span>
<span class="linenos">127</span>
<span class="linenos">128</span><span class="w">    </span>
<span class="linenos">129</span><span class="c1">/// @class Lattice</span>
<span class="linenos">130</span><span class="c1">/// @brief Base class for lattice type objects</span>
<span class="linenos">131</span><span class="k">class</span><span class="w"> </span><span class="nc">Lattice</span>
<span class="linenos">132</span><span class="p">{</span>
<span class="linenos">133</span><span class="k">public</span><span class="o">:</span>
<span class="linenos">134</span><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">rowMajorByteSerialize</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">destBuffer</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">lattice</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">bufferSize</span><span class="p">);</span>
<span class="linenos">135</span><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">rowMajorIntSerialize</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">destBuffer</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">lattice</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">bufferSize</span><span class="p">);</span>
<span class="linenos">136</span><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">rowMajorByteSerializeSites</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">destBuffer</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">lattice</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">bufferSize</span><span class="p">);</span>
<span class="linenos">137</span>
<span class="linenos">138</span><span class="k">public</span><span class="o">:</span>
<span class="linenos">139</span><span class="w">    </span><span class="c1">// Lattice limits.</span>
<span class="linenos">140</span><span class="w">    </span><span class="c1">/// @brief Get the maximum number of site types possible in the lattice</span>
<span class="linenos">141</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="n">site_t</span><span class="w"> </span><span class="n">getMaxSiteType</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">142</span><span class="w">    </span><span class="c1">/// @brief Get the maximum number of particle types possible in the lattice</span>
<span class="linenos">143</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="n">particle_t</span><span class="w"> </span><span class="nf">getMaxParticle</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">144</span><span class="w">    </span><span class="c1">/// @brief Get the maximum number of particles that can live in a site</span>
<span class="linenos">145</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="n">site_size_t</span><span class="w"> </span><span class="nf">getMaxOccupancy</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">146</span><span class="w">	</span>
<span class="linenos">147</span><span class="k">public</span><span class="o">:</span>
<span class="linenos">148</span><span class="w">    </span><span class="c1">/// @brief Create a Lattice object</span>
<span class="linenos">149</span><span class="w">    </span><span class="c1">/// @param size Size of the lattice as (x,y,z)</span>
<span class="linenos">150</span><span class="w">    </span><span class="c1">/// @param spacing Physical spacing between lattice sites</span>
<span class="linenos">151</span><span class="w">    </span><span class="n">Lattice</span><span class="p">(</span><span class="n">lattice_coord_t</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">si_dist_t</span><span class="w"> </span><span class="n">spacing</span><span class="p">);</span>
<span class="linenos">152</span><span class="w">    </span><span class="c1">/// @brief Create a Lattice object</span>
<span class="linenos">153</span><span class="w">    </span><span class="c1">/// @param xSize Number of sites in x</span>
<span class="linenos">154</span><span class="w">    </span><span class="c1">/// @param ySize Number of sites in y</span>
<span class="linenos">155</span><span class="w">    </span><span class="c1">/// @param zSize Number of sites in z</span>
<span class="linenos">156</span><span class="w">    </span><span class="c1">/// @param spacing Physical spacing between lattice sites</span>
<span class="linenos">157</span><span class="w">	</span><span class="n">Lattice</span><span class="p">(</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">xSize</span><span class="p">,</span><span class="w"> </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">ySize</span><span class="p">,</span><span class="w"> </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">zSize</span><span class="p">,</span><span class="w"> </span><span class="n">si_dist_t</span><span class="w"> </span><span class="n">spacing</span><span class="p">);</span>
<span class="linenos">158</span><span class="w">    </span><span class="c1">/// @brief Destroy the Lattice object</span>
<span class="linenos">159</span><span class="w">	</span><span class="k">virtual</span><span class="w"> </span><span class="o">~</span><span class="n">Lattice</span><span class="p">();</span>
<span class="linenos">160</span><span class="w">    </span>
<span class="linenos">161</span><span class="w">    </span><span class="c1">// Size related methods</span>
<span class="linenos">162</span><span class="w">    </span><span class="c1">/// @brief Get size of the Lattice</span>
<span class="linenos">163</span><span class="w">	</span><span class="k">virtual</span><span class="w"> </span><span class="n">lattice_coord_t</span><span class="w"> </span><span class="nf">getSize</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="p">;</span>
<span class="linenos">164</span><span class="w">    </span><span class="c1">/// @brief Get x dimension of the Lattice</span>
<span class="linenos">165</span><span class="w">	</span><span class="k">virtual</span><span class="w"> </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="nf">getXSize</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="p">;</span>
<span class="linenos">166</span><span class="w">    </span><span class="c1">/// @brief Get y dimension of the Lattice</span>
<span class="linenos">167</span><span class="w">	</span><span class="k">virtual</span><span class="w"> </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="nf">getYSize</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="p">;</span>
<span class="linenos">168</span><span class="w">    </span><span class="c1">/// @brief Get z dimension of the Lattice</span>
<span class="linenos">169</span><span class="w">	</span><span class="k">virtual</span><span class="w"> </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="nf">getZSize</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="p">;</span>
<span class="linenos">170</span><span class="w">    </span><span class="c1">/// @brief Get total number of sites in the Lattice</span>
<span class="linenos">171</span><span class="w">	</span><span class="k">virtual</span><span class="w"> </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="nf">getNumberSites</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="p">;</span>
<span class="linenos">172</span><span class="w">    </span><span class="c1">/// @brief Get spacing between lattice sites</span>
<span class="linenos">173</span><span class="w">	</span><span class="k">virtual</span><span class="w"> </span><span class="n">si_dist_t</span><span class="w"> </span><span class="nf">getSpacing</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="p">;</span>
<span class="linenos">174</span><span class="w">	</span>
<span class="linenos">175</span><span class="w">    </span>
<span class="linenos">176</span><span class="w">    </span><span class="c1">/// @brief Get the sites that are neighbor to the indicated site</span>
<span class="linenos">177</span><span class="w">    </span><span class="c1">/// @param index Index of the site for which to get neighbors</span>
<span class="linenos">178</span><span class="w">    </span><span class="c1">/// @param neighboringIndicies An array to hold the indicies of the neighbor sites</span>
<span class="linenos">179</span><span class="w">	</span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">getNeighboringSites</span><span class="p">(</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">index</span><span class="p">,</span><span class="w"> </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">neighboringIndices</span><span class="p">)</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">180</span>
<span class="linenos">181</span><span class="w">    </span>
<span class="linenos">182</span><span class="w">	</span><span class="c1">// Lattice site methods.</span>
<span class="linenos">183</span><span class="w">    </span><span class="c1">/// @brief Get the site type at the specified location</span>
<span class="linenos">184</span><span class="w">	</span><span class="k">virtual</span><span class="w"> </span><span class="n">site_t</span><span class="w"> </span><span class="nf">getSiteType</span><span class="p">(</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">185</span><span class="w">    </span><span class="c1">/// @brief Get the site type at the specified location</span>
<span class="linenos">186</span><span class="w">	</span><span class="k">virtual</span><span class="w"> </span><span class="n">site_t</span><span class="w"> </span><span class="nf">getSiteType</span><span class="p">(</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">index</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">187</span><span class="w">    </span><span class="c1">/// @brief Set the site type at the specified location</span>
<span class="linenos">188</span><span class="w">	</span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setSiteType</span><span class="p">(</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">z</span><span class="p">,</span><span class="w"> </span><span class="n">site_t</span><span class="w"> </span><span class="n">site</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">189</span><span class="w">    </span><span class="c1">/// @brief Set the site type at the specified location</span>
<span class="linenos">190</span><span class="w">	</span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setSiteType</span><span class="p">(</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">index</span><span class="p">,</span><span class="w"> </span><span class="n">site_t</span><span class="w"> </span><span class="n">site</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">191</span><span class="w">    </span><span class="c1">/// @brief Get a list of sites near the specified site within a certain distance</span>
<span class="linenos">192</span><span class="w">    </span><span class="c1">/// @param xc X location of the center site</span>
<span class="linenos">193</span><span class="w">    </span><span class="c1">/// @param yc Y location of the center site</span>
<span class="linenos">194</span><span class="w">    </span><span class="c1">/// @param zc Z location of the center site</span>
<span class="linenos">195</span><span class="w">    </span><span class="c1">/// @param minDistance Minimum distance for halo of sites</span>
<span class="linenos">196</span><span class="w">    </span><span class="c1">/// @param maxDistance Maximum distance for halo of sites</span>
<span class="linenos">197</span><span class="w">	</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">lattice_coord_t</span><span class="o">&gt;</span><span class="w"> </span><span class="n">getNearbySites</span><span class="p">(</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">xc</span><span class="p">,</span><span class="w"> </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">yc</span><span class="p">,</span><span class="w"> </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">zc</span><span class="p">,</span><span class="w"> </span><span class="n">uint</span><span class="w"> </span><span class="n">minDistance</span><span class="p">,</span><span class="w"> </span><span class="n">uint</span><span class="w"> </span><span class="n">maxDistance</span><span class="p">);</span>
<span class="linenos">198</span>
<span class="linenos">199</span><span class="c1">//	Need to remove this from the base class, can&#39;t assume a datatype for particlelattice</span>
<span class="linenos">200</span><span class="c1">//        virtual void getParticleLatticeView(uint8_t **particleLattice, int *Nw, int *Nz, int *Ny, int *Nx, int *Np) = 0;</span>
<span class="linenos">201</span><span class="c1">//        virtual void getSiteLatticeView(uint8_t **siteLattice, int *Nz, int *Ny, int *Nx) = 0;</span>
<span class="linenos">202</span>
<span class="linenos">203</span><span class="w">    </span>
<span class="linenos">204</span><span class="w">	</span><span class="c1">// Particle methods.</span>
<span class="linenos">205</span><span class="w">    </span><span class="c1">/// @brief Get the number of particles in the specified lattice site</span>
<span class="linenos">206</span><span class="w">	</span><span class="k">virtual</span><span class="w"> </span><span class="n">site_size_t</span><span class="w"> </span><span class="nf">getOccupancy</span><span class="p">(</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">207</span><span class="w">    </span><span class="c1">/// @brief Get the number of particles in the specified lattice site</span>
<span class="linenos">208</span><span class="w">	</span><span class="k">virtual</span><span class="w"> </span><span class="n">site_size_t</span><span class="w"> </span><span class="nf">getOccupancy</span><span class="p">(</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">index</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">209</span><span class="w">    </span>
<span class="linenos">210</span><span class="w">    </span><span class="c1">/// @brief Get the particle at the specified site with at the specified number in the particle list</span>
<span class="linenos">211</span><span class="w">	</span><span class="k">virtual</span><span class="w"> </span><span class="n">particle_t</span><span class="w"> </span><span class="nf">getParticle</span><span class="p">(</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">z</span><span class="p">,</span><span class="w"> </span><span class="n">site_size_t</span><span class="w"> </span><span class="n">particleIndex</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">212</span><span class="w">    </span><span class="c1">/// @brief Get the particle at the specified site with at the specified number in the particle list</span>
<span class="linenos">213</span><span class="w">	</span><span class="k">virtual</span><span class="w"> </span><span class="n">particle_t</span><span class="w"> </span><span class="nf">getParticle</span><span class="p">(</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">index</span><span class="p">,</span><span class="w"> </span><span class="n">site_size_t</span><span class="w"> </span><span class="n">particleIndex</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">214</span><span class="w">    </span>
<span class="linenos">215</span><span class="w">    </span><span class="c1">/// @brief Add a particle to the specified site</span>
<span class="linenos">216</span><span class="w">	</span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">addParticle</span><span class="p">(</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">z</span><span class="p">,</span><span class="w"> </span><span class="n">particle_t</span><span class="w"> </span><span class="n">particle</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">217</span><span class="w">    </span><span class="c1">/// @brief Add a particle to the specified site</span>
<span class="linenos">218</span><span class="w">	</span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">addParticle</span><span class="p">(</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">index</span><span class="p">,</span><span class="w"> </span><span class="n">particle_t</span><span class="w"> </span><span class="n">particle</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">219</span><span class="w">    </span><span class="c1">/// @brief Remove a particle to the specified site</span>
<span class="linenos">220</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">removeParticles</span><span class="p">(</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">221</span><span class="w">    </span><span class="c1">/// @brief Remove a particle to the specified site</span>
<span class="linenos">222</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">removeParticles</span><span class="p">(</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">index</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">223</span><span class="w">    </span><span class="c1">/// @brief Empty all particles from the specified site</span>
<span class="linenos">224</span><span class="w">	</span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">removeAllParticles</span><span class="p">();</span>
<span class="linenos">225</span><span class="w">	</span>
<span class="linenos">226</span><span class="w">	</span><span class="cm">/**</span>
<span class="linenos">227</span><span class="cm">	 * Particle searching methods.</span>
<span class="linenos">228</span><span class="cm">	 */</span>
<span class="linenos">229</span>
<span class="linenos">230</span><span class="w">	</span><span class="c1">// Search for a particle from the start of the lattice.</span>
<span class="linenos">231</span><span class="w">	</span><span class="cm">/*virtual particle_loc_t findParticle(particle_t particle)=0;</span>
<span class="linenos">232</span><span class="cm">	virtual particle_loc_t findNextParticle(particle_loc_t previousParticle)=0;</span>
<span class="linenos">233</span><span class="cm">	</span>
<span class="linenos">234</span><span class="cm">	// Search for a particle starting from a given location.</span>
<span class="linenos">235</span><span class="cm">	virtual particle_loc_t findNearbyParticle(particle_loc_t particle)=0;</span>
<span class="linenos">236</span><span class="cm">	*/</span>
<span class="linenos">237</span><span class="w">	</span>
<span class="linenos">238</span><span class="w">	</span><span class="c1">// Counts all of the particles on the lattice.</span>
<span class="linenos">239</span><span class="w">    </span><span class="c1">/// @brief Get the number of each particle type in the lattice</span>
<span class="linenos">240</span><span class="w">	</span><span class="k">virtual</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">particle_t</span><span class="p">,</span><span class="n">uint</span><span class="o">&gt;</span><span class="w"> </span><span class="n">getParticleCounts</span><span class="p">()</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">241</span><span class="w">	</span>
<span class="linenos">242</span><span class="w">	</span><span class="c1">//Finds all of the particle of a given range of types.</span>
<span class="linenos">243</span><span class="w">    </span><span class="c1">/// @brief Get the number of the specified particles types in the lattice</span>
<span class="linenos">244</span><span class="w">	</span><span class="k">virtual</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">particle_loc_t</span><span class="o">&gt;</span><span class="w"> </span><span class="n">findParticles</span><span class="p">(</span><span class="n">particle_t</span><span class="w"> </span><span class="n">minParticleType</span><span class="p">,</span><span class="w"> </span><span class="n">particle_t</span><span class="w"> </span><span class="n">maxParticleType</span><span class="p">)</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">245</span>
<span class="linenos">246</span><span class="w">    </span><span class="c1">/// @brief Print the lattice to the console</span>
<span class="linenos">247</span><span class="w">	</span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">print</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="p">;</span>
<span class="linenos">248</span>
<span class="linenos">249</span><span class="w">	</span><span class="c1">// Methods to set the data directly.</span>
<span class="linenos">250</span><span class="w">	</span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setFromRowMajorByteData</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">buffer</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">bufferSize</span><span class="p">)</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">251</span><span class="w">	</span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setSitesFromRowMajorByteData</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">buffer</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">bufferSize</span><span class="p">)</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">252</span>
<span class="linenos">253</span><span class="w">	</span><span class="k">virtual</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="nf">getLatticeMemorySize</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">254</span>
<span class="linenos">255</span><span class="k">protected</span><span class="o">:</span>
<span class="linenos">256</span><span class="w">	</span><span class="n">lattice_coord_t</span><span class="w"> </span><span class="n">size</span><span class="p">;</span><span class="w">           </span><span class="c1">// Dimension of lattice as (x, y, z) </span>
<span class="linenos">257</span><span class="w">	</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">numberSites</span><span class="p">;</span><span class="w">     </span><span class="c1">// Number of total sites (e.g. x*y*z)</span>
<span class="linenos">258</span><span class="w">    </span><span class="n">si_dist_t</span><span class="w"> </span><span class="n">spacing</span><span class="p">;</span><span class="w">              </span><span class="c1">// Physical spacing of the lattice (i.e. in units of nm, um, mm, etc.)</span>
<span class="linenos">259</span><span class="p">};</span>
<span class="linenos">260</span>
<span class="linenos">261</span>
<span class="linenos">262</span><span class="p">}</span>
<span class="linenos">263</span><span class="p">}</span>
<span class="linenos">264</span>
<span class="linenos">265</span><span class="cp">#endif</span>
</pre></div>
</div>
</section>
<section id="lattice-cpp">
<h3>Lattice.cpp<a class="headerlink" href="#lattice-cpp" title="Link to this heading">#</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="linenos">  1</span><span class="cm">/*</span>
<span class="linenos">  2</span><span class="cm"> * University of Illinois Open Source License</span>
<span class="linenos">  3</span><span class="cm"> * Copyright 2008-2018 Luthey-Schulten Group,</span>
<span class="linenos">  4</span><span class="cm"> * Copyright 2012 Roberts Group,</span>
<span class="linenos">  5</span><span class="cm"> * All rights reserved.</span>
<span class="linenos">  6</span><span class="cm"> * </span>
<span class="linenos">  7</span><span class="cm"> * Developed by: Luthey-Schulten Group</span>
<span class="linenos">  8</span><span class="cm"> * 			     University of Illinois at Urbana-Champaign</span>
<span class="linenos">  9</span><span class="cm"> * 			     http://www.scs.uiuc.edu/~schulten</span>
<span class="linenos"> 10</span><span class="cm"> * </span>
<span class="linenos"> 11</span><span class="cm"> * Developed by: Roberts Group</span>
<span class="linenos"> 12</span><span class="cm"> * 			     Johns Hopkins University</span>
<span class="linenos"> 13</span><span class="cm"> * 			     http://biophysics.jhu.edu/roberts/</span>
<span class="linenos"> 14</span><span class="cm"> *</span>
<span class="linenos"> 15</span><span class="cm"> * Permission is hereby granted, free of charge, to any person obtaining a copy of</span>
<span class="linenos"> 16</span><span class="cm"> * this software and associated documentation files (the Software), to deal with </span>
<span class="linenos"> 17</span><span class="cm"> * the Software without restriction, including without limitation the rights to </span>
<span class="linenos"> 18</span><span class="cm"> * use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies </span>
<span class="linenos"> 19</span><span class="cm"> * of the Software, and to permit persons to whom the Software is furnished to </span>
<span class="linenos"> 20</span><span class="cm"> * do so, subject to the following conditions:</span>
<span class="linenos"> 21</span><span class="cm"> * </span>
<span class="linenos"> 22</span><span class="cm"> * - Redistributions of source code must retain the above copyright notice, </span>
<span class="linenos"> 23</span><span class="cm"> * this list of conditions and the following disclaimers.</span>
<span class="linenos"> 24</span><span class="cm"> * </span>
<span class="linenos"> 25</span><span class="cm"> * - Redistributions in binary form must reproduce the above copyright notice, </span>
<span class="linenos"> 26</span><span class="cm"> * this list of conditions and the following disclaimers in the documentation </span>
<span class="linenos"> 27</span><span class="cm"> * and/or other materials provided with the distribution.</span>
<span class="linenos"> 28</span><span class="cm"> * </span>
<span class="linenos"> 29</span><span class="cm"> * - Neither the names of the Luthey-Schulten Group, University of Illinois at</span>
<span class="linenos"> 30</span><span class="cm"> * Urbana-Champaign, the Roberts Group, Johns Hopkins University, nor the names</span>
<span class="linenos"> 31</span><span class="cm"> * of its contributors may be used to endorse or promote products derived from</span>
<span class="linenos"> 32</span><span class="cm"> * this Software without specific prior written permission.</span>
<span class="linenos"> 33</span><span class="cm"> * </span>
<span class="linenos"> 34</span><span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR </span>
<span class="linenos"> 35</span><span class="cm"> * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, </span>
<span class="linenos"> 36</span><span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL </span>
<span class="linenos"> 37</span><span class="cm"> * THE CONTRIBUTORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR </span>
<span class="linenos"> 38</span><span class="cm"> * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, </span>
<span class="linenos"> 39</span><span class="cm"> * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR </span>
<span class="linenos"> 40</span><span class="cm"> * OTHER DEALINGS WITH THE SOFTWARE.</span>
<span class="linenos"> 41</span><span class="cm"> *</span>
<span class="linenos"> 42</span><span class="cm"> * Author(s): Elijah Roberts</span>
<span class="linenos"> 43</span><span class="cm"> */</span>
<span class="linenos"> 44</span>
<span class="linenos"> 45</span>
<span class="linenos"> 46</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;iomanip&gt;</span>
<span class="linenos"> 47</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;vector&gt;</span>
<span class="linenos"> 48</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;map&gt;</span>
<span class="linenos"> 49</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;cmath&gt;</span>
<span class="linenos"> 50</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;config.h&quot;</span>
<span class="linenos"> 51</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;core/Types.h&quot;</span>
<span class="linenos"> 52</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;core/Exceptions.h&quot;</span>
<span class="linenos"> 53</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;rdme/Lattice.h&quot;</span>
<span class="linenos"> 54</span>
<span class="linenos"> 55</span><span class="k">namespace</span><span class="w"> </span><span class="nn">lm</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 56</span><span class="k">namespace</span><span class="w"> </span><span class="nn">rdme</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 57</span>
<span class="linenos"> 58</span><span class="c1">// Function to return the compiled-in value for MPD_LATTICE_MAX_OCCUPANCY.  Used </span>
<span class="linenos"> 59</span><span class="c1">// by pyLM in order to request the appropriate density.</span>
<span class="linenos"> 60</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">getCompiledLatticeMaxOccupancy</span><span class="p">()</span>
<span class="linenos"> 61</span><span class="p">{</span>
<span class="linenos"> 62</span><span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="n">MPD_LATTICE_MAX_OCCUPANCY</span><span class="p">;</span>
<span class="linenos"> 63</span><span class="p">}</span>
<span class="linenos"> 64</span>
<span class="linenos"> 65</span><span class="n">Lattice</span><span class="o">::</span><span class="n">Lattice</span><span class="p">(</span><span class="n">lattice_coord_t</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">si_dist_t</span><span class="w"> </span><span class="n">spacing</span><span class="p">)</span>
<span class="linenos"> 66</span><span class="o">:</span><span class="n">size</span><span class="p">(</span><span class="n">size</span><span class="p">),</span><span class="n">numberSites</span><span class="p">(</span><span class="n">size</span><span class="p">.</span><span class="n">x</span><span class="o">*</span><span class="n">size</span><span class="p">.</span><span class="n">y</span><span class="o">*</span><span class="n">size</span><span class="p">.</span><span class="n">z</span><span class="p">),</span><span class="n">spacing</span><span class="p">(</span><span class="n">spacing</span><span class="p">)</span>
<span class="linenos"> 67</span><span class="p">{}</span>
<span class="linenos"> 68</span>
<span class="linenos"> 69</span><span class="n">Lattice</span><span class="o">::</span><span class="n">Lattice</span><span class="p">(</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">xSize</span><span class="p">,</span><span class="w"> </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">ySize</span><span class="p">,</span><span class="w"> </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">zSize</span><span class="p">,</span><span class="w"> </span><span class="n">si_dist_t</span><span class="w"> </span><span class="n">spacing</span><span class="p">)</span>
<span class="linenos"> 70</span><span class="o">:</span><span class="n">size</span><span class="p">(</span><span class="n">xSize</span><span class="p">,</span><span class="n">ySize</span><span class="p">,</span><span class="n">zSize</span><span class="p">),</span><span class="n">numberSites</span><span class="p">(</span><span class="n">size</span><span class="p">.</span><span class="n">x</span><span class="o">*</span><span class="n">size</span><span class="p">.</span><span class="n">y</span><span class="o">*</span><span class="n">size</span><span class="p">.</span><span class="n">z</span><span class="p">),</span><span class="n">spacing</span><span class="p">(</span><span class="n">spacing</span><span class="p">)</span>
<span class="linenos"> 71</span><span class="p">{</span>
<span class="linenos"> 72</span><span class="p">}</span>
<span class="linenos"> 73</span>
<span class="linenos"> 74</span><span class="n">Lattice</span><span class="o">::~</span><span class="n">Lattice</span><span class="p">()</span><span class="w"> </span><span class="p">{}</span>
<span class="linenos"> 75</span>
<span class="linenos"> 76</span><span class="n">lattice_coord_t</span><span class="w"> </span><span class="n">Lattice</span><span class="o">::</span><span class="n">getSize</span><span class="p">()</span><span class="w"> </span><span class="k">const</span>
<span class="linenos"> 77</span><span class="p">{</span>
<span class="linenos"> 78</span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">size</span><span class="p">;</span>
<span class="linenos"> 79</span><span class="p">}</span>
<span class="linenos"> 80</span>
<span class="linenos"> 81</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">Lattice</span><span class="o">::</span><span class="n">getXSize</span><span class="p">()</span><span class="w"> </span><span class="k">const</span>
<span class="linenos"> 82</span><span class="p">{</span>
<span class="linenos"> 83</span><span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="n">size</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
<span class="linenos"> 84</span><span class="p">}</span>
<span class="linenos"> 85</span>
<span class="linenos"> 86</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">Lattice</span><span class="o">::</span><span class="n">getYSize</span><span class="p">()</span><span class="w"> </span><span class="k">const</span>
<span class="linenos"> 87</span><span class="p">{</span>
<span class="linenos"> 88</span><span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="n">size</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
<span class="linenos"> 89</span><span class="p">}</span>
<span class="linenos"> 90</span>
<span class="linenos"> 91</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">Lattice</span><span class="o">::</span><span class="n">getZSize</span><span class="p">()</span><span class="w"> </span><span class="k">const</span>
<span class="linenos"> 92</span><span class="p">{</span>
<span class="linenos"> 93</span><span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="n">size</span><span class="p">.</span><span class="n">z</span><span class="p">;</span>
<span class="linenos"> 94</span><span class="p">}</span>
<span class="linenos"> 95</span>
<span class="linenos"> 96</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">Lattice</span><span class="o">::</span><span class="n">getNumberSites</span><span class="p">()</span><span class="w"> </span><span class="k">const</span>
<span class="linenos"> 97</span><span class="p">{</span>
<span class="linenos"> 98</span><span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="n">numberSites</span><span class="p">;</span>
<span class="linenos"> 99</span><span class="p">}</span>
<span class="linenos">100</span>
<span class="linenos">101</span><span class="n">si_dist_t</span><span class="w"> </span><span class="n">Lattice</span><span class="o">::</span><span class="n">getSpacing</span><span class="p">()</span><span class="w"> </span><span class="k">const</span>
<span class="linenos">102</span><span class="p">{</span>
<span class="linenos">103</span><span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="n">spacing</span><span class="p">;</span>
<span class="linenos">104</span><span class="p">}</span>
<span class="linenos">105</span>
<span class="linenos">106</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">lattice_coord_t</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Lattice</span><span class="o">::</span><span class="n">getNearbySites</span><span class="p">(</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">xc</span><span class="p">,</span><span class="w"> </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">yc</span><span class="p">,</span><span class="w"> </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">zc</span><span class="p">,</span><span class="w"> </span><span class="n">uint</span><span class="w"> </span><span class="n">minDistance</span><span class="p">,</span><span class="w"> </span><span class="n">uint</span><span class="w"> </span><span class="n">maxDistance</span><span class="p">)</span>
<span class="linenos">107</span><span class="p">{</span>
<span class="linenos">108</span><span class="w">	</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">lattice_coord_t</span><span class="o">&gt;</span><span class="w"> </span><span class="n">sites</span><span class="p">;</span>
<span class="linenos">109</span><span class="w">	</span><span class="kt">double</span><span class="w"> </span><span class="n">minDistanceSquared</span><span class="o">=</span><span class="p">(</span><span class="kt">double</span><span class="p">)(</span><span class="n">minDistance</span><span class="o">*</span><span class="n">minDistance</span><span class="p">);</span>
<span class="linenos">110</span><span class="w">	</span><span class="kt">double</span><span class="w"> </span><span class="n">maxDistanceSquared</span><span class="o">=</span><span class="p">(</span><span class="kt">double</span><span class="p">)(</span><span class="n">maxDistance</span><span class="o">*</span><span class="n">maxDistance</span><span class="p">);</span>
<span class="linenos">111</span><span class="w">	</span>
<span class="linenos">112</span><span class="w">	</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">xc</span><span class="o">&gt;=</span><span class="n">maxDistance</span><span class="p">)</span><span class="o">?</span><span class="p">(</span><span class="n">xc</span><span class="o">-</span><span class="n">maxDistance</span><span class="p">)</span><span class="o">:</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="p">((</span><span class="n">xc</span><span class="o">&lt;=</span><span class="n">size</span><span class="p">.</span><span class="n">x</span><span class="mi">-1</span><span class="o">-</span><span class="n">maxDistance</span><span class="p">)</span><span class="o">?</span><span class="p">(</span><span class="n">xc</span><span class="o">+</span><span class="n">maxDistance</span><span class="p">)</span><span class="o">:</span><span class="p">(</span><span class="n">size</span><span class="p">.</span><span class="n">x</span><span class="mi">-1</span><span class="p">));</span><span class="w"> </span><span class="n">x</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">113</span><span class="w">	</span><span class="p">{</span>
<span class="linenos">114</span><span class="w">		</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">yc</span><span class="o">&gt;=</span><span class="n">maxDistance</span><span class="p">)</span><span class="o">?</span><span class="p">(</span><span class="n">yc</span><span class="o">-</span><span class="n">maxDistance</span><span class="p">)</span><span class="o">:</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="p">((</span><span class="n">yc</span><span class="o">&lt;=</span><span class="n">size</span><span class="p">.</span><span class="n">y</span><span class="mi">-1</span><span class="o">-</span><span class="n">maxDistance</span><span class="p">)</span><span class="o">?</span><span class="p">(</span><span class="n">yc</span><span class="o">+</span><span class="n">maxDistance</span><span class="p">)</span><span class="o">:</span><span class="p">(</span><span class="n">size</span><span class="p">.</span><span class="n">y</span><span class="mi">-1</span><span class="p">));</span><span class="w"> </span><span class="n">y</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">115</span><span class="w">		</span><span class="p">{</span>
<span class="linenos">116</span><span class="w">			</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">zc</span><span class="o">&gt;=</span><span class="n">maxDistance</span><span class="p">)</span><span class="o">?</span><span class="p">(</span><span class="n">zc</span><span class="o">-</span><span class="n">maxDistance</span><span class="p">)</span><span class="o">:</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">z</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="p">((</span><span class="n">zc</span><span class="o">&lt;=</span><span class="n">size</span><span class="p">.</span><span class="n">z</span><span class="mi">-1</span><span class="o">-</span><span class="n">maxDistance</span><span class="p">)</span><span class="o">?</span><span class="p">(</span><span class="n">zc</span><span class="o">+</span><span class="n">maxDistance</span><span class="p">)</span><span class="o">:</span><span class="p">(</span><span class="n">size</span><span class="p">.</span><span class="n">z</span><span class="mi">-1</span><span class="p">));</span><span class="w"> </span><span class="n">z</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">117</span><span class="w">			</span><span class="p">{</span>
<span class="linenos">118</span><span class="w">				</span><span class="kt">double</span><span class="w"> </span><span class="n">rSquared</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pow</span><span class="p">((</span><span class="kt">double</span><span class="p">)</span><span class="n">x</span><span class="o">-</span><span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="n">xc</span><span class="p">,</span><span class="mf">2.0</span><span class="p">)</span><span class="o">+</span><span class="n">pow</span><span class="p">((</span><span class="kt">double</span><span class="p">)</span><span class="n">y</span><span class="o">-</span><span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="n">yc</span><span class="p">,</span><span class="mf">2.0</span><span class="p">)</span><span class="o">+</span><span class="n">pow</span><span class="p">((</span><span class="kt">double</span><span class="p">)</span><span class="n">z</span><span class="o">-</span><span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="n">zc</span><span class="p">,</span><span class="mf">2.0</span><span class="p">);</span>
<span class="linenos">119</span><span class="w">				</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rSquared</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="p">((</span><span class="kt">double</span><span class="p">)</span><span class="n">maxDistanceSquared</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">rSquared</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">minDistanceSquared</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">minDistance</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">maxDistance</span><span class="p">))</span>
<span class="linenos">120</span><span class="w">				</span><span class="p">{</span>
<span class="linenos">121</span><span class="w">					</span><span class="n">sites</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">lattice_coord_t</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">));</span>
<span class="linenos">122</span><span class="w">				</span><span class="p">}</span>
<span class="linenos">123</span><span class="w">			</span><span class="p">}</span>
<span class="linenos">124</span><span class="w">		</span><span class="p">}</span>
<span class="linenos">125</span><span class="w">	</span><span class="p">}</span>
<span class="linenos">126</span><span class="w">	</span>
<span class="linenos">127</span><span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="n">sites</span><span class="p">;</span>
<span class="linenos">128</span><span class="p">}</span>
<span class="linenos">129</span>
<span class="linenos">130</span><span class="kt">void</span><span class="w"> </span><span class="n">Lattice</span><span class="o">::</span><span class="n">removeAllParticles</span><span class="p">()</span>
<span class="linenos">131</span><span class="p">{</span>
<span class="linenos">132</span><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">z</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">z</span><span class="o">&lt;</span><span class="n">size</span><span class="p">.</span><span class="n">z</span><span class="p">;</span><span class="w"> </span><span class="n">z</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">133</span><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">y</span><span class="o">&lt;</span><span class="n">size</span><span class="p">.</span><span class="n">y</span><span class="p">;</span><span class="w"> </span><span class="n">y</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">134</span><span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">x</span><span class="o">&lt;</span><span class="n">size</span><span class="p">.</span><span class="n">x</span><span class="p">;</span><span class="w"> </span><span class="n">x</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">135</span><span class="w">                </span><span class="n">removeParticles</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">);</span>
<span class="linenos">136</span><span class="p">}</span>
<span class="linenos">137</span>
<span class="linenos">138</span><span class="kt">void</span><span class="w"> </span><span class="n">Lattice</span><span class="o">::</span><span class="n">rowMajorByteSerialize</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">bufferPtr</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">latticePtr</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">bufferSize</span><span class="p">)</span>
<span class="linenos">139</span><span class="p">{</span>
<span class="linenos">140</span><span class="w">    </span><span class="n">Lattice</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">lattice</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Lattice</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">latticePtr</span><span class="p">;</span>
<span class="linenos">141</span><span class="w">    </span><span class="n">byte</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">buffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">byte</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">bufferPtr</span><span class="p">;</span>
<span class="linenos">142</span><span class="w">    </span><span class="n">lattice_coord_t</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
<span class="linenos">143</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">bufferSize</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">size</span><span class="p">.</span><span class="n">x</span><span class="o">*</span><span class="n">size</span><span class="p">.</span><span class="n">y</span><span class="o">*</span><span class="n">size</span><span class="p">.</span><span class="n">z</span><span class="o">*</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getMaxOccupancy</span><span class="p">())</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="n">lm</span><span class="o">::</span><span class="n">InvalidArgException</span><span class="p">(</span><span class="n">__PRETTY_FUNCTION__</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;the buffer size was not equal to the lattice data size&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">bufferSize</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">.</span><span class="n">x</span><span class="o">*</span><span class="n">size</span><span class="p">.</span><span class="n">y</span><span class="o">*</span><span class="n">size</span><span class="p">.</span><span class="n">z</span><span class="o">*</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getMaxOccupancy</span><span class="p">());</span>
<span class="linenos">144</span><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">index</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">x</span><span class="o">&lt;</span><span class="n">size</span><span class="p">.</span><span class="n">x</span><span class="p">;</span><span class="w"> </span><span class="n">x</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">145</span><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">y</span><span class="o">&lt;</span><span class="n">size</span><span class="p">.</span><span class="n">y</span><span class="p">;</span><span class="w"> </span><span class="n">y</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">146</span><span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">z</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">z</span><span class="o">&lt;</span><span class="n">size</span><span class="p">.</span><span class="n">z</span><span class="p">;</span><span class="w"> </span><span class="n">z</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">147</span><span class="w">                </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">site_size_t</span><span class="w"> </span><span class="n">p</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">p</span><span class="o">&lt;</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getMaxOccupancy</span><span class="p">();</span><span class="w"> </span><span class="n">p</span><span class="o">++</span><span class="p">,</span><span class="w"> </span><span class="n">index</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">148</span><span class="w">                    </span><span class="n">buffer</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getParticle</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="n">p</span><span class="p">);</span>
<span class="linenos">149</span><span class="p">}</span>
<span class="linenos">150</span>
<span class="linenos">151</span><span class="kt">void</span><span class="w"> </span><span class="n">Lattice</span><span class="o">::</span><span class="n">rowMajorIntSerialize</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">bufferPtr</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">latticePtr</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">bufferSize</span><span class="p">)</span>
<span class="linenos">152</span><span class="p">{</span>
<span class="linenos">153</span><span class="w">    </span><span class="n">Lattice</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">lattice</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Lattice</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">latticePtr</span><span class="p">;</span>
<span class="linenos">154</span><span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">buffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uint32_t</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">bufferPtr</span><span class="p">;</span>
<span class="linenos">155</span><span class="w">    </span><span class="n">lattice_coord_t</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
<span class="linenos">156</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">bufferSize</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">size</span><span class="p">.</span><span class="n">x</span><span class="o">*</span><span class="n">size</span><span class="p">.</span><span class="n">y</span><span class="o">*</span><span class="n">size</span><span class="p">.</span><span class="n">z</span><span class="o">*</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getMaxOccupancy</span><span class="p">())</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="n">lm</span><span class="o">::</span><span class="n">InvalidArgException</span><span class="p">(</span><span class="n">__PRETTY_FUNCTION__</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;the buffer size was not equal to the lattice data size&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">bufferSize</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">.</span><span class="n">x</span><span class="o">*</span><span class="n">size</span><span class="p">.</span><span class="n">y</span><span class="o">*</span><span class="n">size</span><span class="p">.</span><span class="n">z</span><span class="o">*</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getMaxOccupancy</span><span class="p">());</span>
<span class="linenos">157</span><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">index</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">x</span><span class="o">&lt;</span><span class="n">size</span><span class="p">.</span><span class="n">x</span><span class="p">;</span><span class="w"> </span><span class="n">x</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">158</span><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">y</span><span class="o">&lt;</span><span class="n">size</span><span class="p">.</span><span class="n">y</span><span class="p">;</span><span class="w"> </span><span class="n">y</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">159</span><span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">z</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">z</span><span class="o">&lt;</span><span class="n">size</span><span class="p">.</span><span class="n">z</span><span class="p">;</span><span class="w"> </span><span class="n">z</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">160</span><span class="w">                </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">site_size_t</span><span class="w"> </span><span class="n">p</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">p</span><span class="o">&lt;</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getMaxOccupancy</span><span class="p">();</span><span class="w"> </span><span class="n">p</span><span class="o">++</span><span class="p">,</span><span class="w"> </span><span class="n">index</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">161</span><span class="w">                    </span><span class="n">buffer</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getParticle</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="n">p</span><span class="p">);</span>
<span class="linenos">162</span><span class="p">}</span>
<span class="linenos">163</span>
<span class="linenos">164</span><span class="kt">void</span><span class="w"> </span><span class="n">Lattice</span><span class="o">::</span><span class="n">rowMajorByteSerializeSites</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">bufferPtr</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">latticePtr</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">bufferSize</span><span class="p">)</span>
<span class="linenos">165</span><span class="p">{</span>
<span class="linenos">166</span><span class="w">    </span><span class="n">Lattice</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">lattice</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Lattice</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">latticePtr</span><span class="p">;</span>
<span class="linenos">167</span><span class="w">    </span><span class="n">byte</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">buffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">byte</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">bufferPtr</span><span class="p">;</span>
<span class="linenos">168</span><span class="w">    </span><span class="n">lattice_coord_t</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
<span class="linenos">169</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">bufferSize</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">size</span><span class="p">.</span><span class="n">x</span><span class="o">*</span><span class="n">size</span><span class="p">.</span><span class="n">y</span><span class="o">*</span><span class="n">size</span><span class="p">.</span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="n">lm</span><span class="o">::</span><span class="n">InvalidArgException</span><span class="p">(</span><span class="n">__PRETTY_FUNCTION__</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;the buffer size was not equal to the lattice site data size&quot;</span><span class="p">);</span>
<span class="linenos">170</span><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">index</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">x</span><span class="o">&lt;</span><span class="n">size</span><span class="p">.</span><span class="n">x</span><span class="p">;</span><span class="w"> </span><span class="n">x</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">171</span><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">y</span><span class="o">&lt;</span><span class="n">size</span><span class="p">.</span><span class="n">y</span><span class="p">;</span><span class="w"> </span><span class="n">y</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">172</span><span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">z</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">z</span><span class="o">&lt;</span><span class="n">size</span><span class="p">.</span><span class="n">z</span><span class="p">;</span><span class="w"> </span><span class="n">z</span><span class="o">++</span><span class="p">,</span><span class="w"> </span><span class="n">index</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">173</span><span class="w">				</span><span class="n">buffer</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">byte</span><span class="p">)</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getSiteType</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">);</span>
<span class="linenos">174</span><span class="p">}</span>
<span class="linenos">175</span>
<span class="linenos">176</span><span class="kt">void</span><span class="w"> </span><span class="n">Lattice</span><span class="o">::</span><span class="n">print</span><span class="p">()</span><span class="w"> </span><span class="k">const</span>
<span class="linenos">177</span><span class="p">{</span>
<span class="linenos">178</span><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">z</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">z</span><span class="o">&lt;</span><span class="n">size</span><span class="p">.</span><span class="n">z</span><span class="p">;</span><span class="w"> </span><span class="n">z</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">179</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">180</span><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">x</span><span class="o">&lt;</span><span class="n">size</span><span class="p">.</span><span class="n">x</span><span class="p">;</span><span class="w"> </span><span class="n">x</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">181</span><span class="w">        </span><span class="p">{</span>
<span class="linenos">182</span><span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">y</span><span class="o">&lt;</span><span class="n">size</span><span class="p">.</span><span class="n">y</span><span class="p">;</span><span class="w"> </span><span class="n">y</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">183</span><span class="w">            </span><span class="p">{</span>
<span class="linenos">184</span><span class="w">                </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;(%2d)&quot;</span><span class="p">,</span><span class="n">getSiteType</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">));</span>
<span class="linenos">185</span><span class="w">                </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">site_size_t</span><span class="w"> </span><span class="n">p</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">p</span><span class="o">&lt;</span><span class="n">getMaxOccupancy</span><span class="p">();</span><span class="w"> </span><span class="n">p</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">186</span><span class="w">                </span><span class="p">{</span>
<span class="linenos">187</span><span class="w">                    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;%2d%c&quot;</span><span class="p">,</span><span class="n">getParticle</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="n">p</span><span class="p">),</span><span class="n">p</span><span class="o">&lt;</span><span class="n">getMaxOccupancy</span><span class="p">()</span><span class="mi">-1</span><span class="o">?</span><span class="sc">&#39;,&#39;</span><span class="o">:</span><span class="sc">&#39; &#39;</span><span class="p">);</span>
<span class="linenos">188</span><span class="w">                </span><span class="p">}</span>
<span class="linenos">189</span><span class="w">            </span><span class="p">}</span>
<span class="linenos">190</span><span class="w">            </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="linenos">191</span><span class="w">        </span><span class="p">}</span>
<span class="linenos">192</span><span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;---------------</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="linenos">193</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">194</span><span class="p">}</span>
<span class="linenos">195</span>
<span class="linenos">196</span><span class="p">}</span>
<span class="linenos">197</span><span class="p">}</span>
</pre></div>
</div>
</section>
<section id="bytelattice-h">
<h3>ByteLattice.h<a class="headerlink" href="#bytelattice-h" title="Link to this heading">#</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="linenos">  1</span><span class="cm">/*</span>
<span class="linenos">  2</span><span class="cm"> * University of Illinois Open Source License</span>
<span class="linenos">  3</span><span class="cm"> * Copyright 2008-2018 Luthey-Schulten Group,</span>
<span class="linenos">  4</span><span class="cm"> * All rights reserved.</span>
<span class="linenos">  5</span><span class="cm"> * </span>
<span class="linenos">  6</span><span class="cm"> * Developed by: Luthey-Schulten Group</span>
<span class="linenos">  7</span><span class="cm"> * 			     University of Illinois at Urbana-Champaign</span>
<span class="linenos">  8</span><span class="cm"> * 			     http://www.scs.uiuc.edu/~schulten</span>
<span class="linenos">  9</span><span class="cm"> * </span>
<span class="linenos"> 10</span><span class="cm"> * Permission is hereby granted, free of charge, to any person obtaining a copy of</span>
<span class="linenos"> 11</span><span class="cm"> * this software and associated documentation files (the Software), to deal with </span>
<span class="linenos"> 12</span><span class="cm"> * the Software without restriction, including without limitation the rights to </span>
<span class="linenos"> 13</span><span class="cm"> * use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies </span>
<span class="linenos"> 14</span><span class="cm"> * of the Software, and to permit persons to whom the Software is furnished to </span>
<span class="linenos"> 15</span><span class="cm"> * do so, subject to the following conditions:</span>
<span class="linenos"> 16</span><span class="cm"> * </span>
<span class="linenos"> 17</span><span class="cm"> * - Redistributions of source code must retain the above copyright notice, </span>
<span class="linenos"> 18</span><span class="cm"> * this list of conditions and the following disclaimers.</span>
<span class="linenos"> 19</span><span class="cm"> * </span>
<span class="linenos"> 20</span><span class="cm"> * - Redistributions in binary form must reproduce the above copyright notice, </span>
<span class="linenos"> 21</span><span class="cm"> * this list of conditions and the following disclaimers in the documentation </span>
<span class="linenos"> 22</span><span class="cm"> * and/or other materials provided with the distribution.</span>
<span class="linenos"> 23</span><span class="cm"> * </span>
<span class="linenos"> 24</span><span class="cm"> * - Neither the names of the Luthey-Schulten Group, University of Illinois at</span>
<span class="linenos"> 25</span><span class="cm"> * Urbana-Champaign, nor the names of its contributors may be used to endorse or</span>
<span class="linenos"> 26</span><span class="cm"> * promote products derived from this Software without specific prior written</span>
<span class="linenos"> 27</span><span class="cm"> * permission.</span>
<span class="linenos"> 28</span><span class="cm"> * </span>
<span class="linenos"> 29</span><span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR </span>
<span class="linenos"> 30</span><span class="cm"> * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, </span>
<span class="linenos"> 31</span><span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL </span>
<span class="linenos"> 32</span><span class="cm"> * THE CONTRIBUTORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR </span>
<span class="linenos"> 33</span><span class="cm"> * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, </span>
<span class="linenos"> 34</span><span class="cm"> * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR </span>
<span class="linenos"> 35</span><span class="cm"> * OTHER DEALINGS WITH THE SOFTWARE.</span>
<span class="linenos"> 36</span><span class="cm"> *</span>
<span class="linenos"> 37</span><span class="cm"> * Author(s): Elijah Roberts</span>
<span class="linenos"> 38</span><span class="cm"> */</span>
<span class="linenos"> 39</span>
<span class="linenos"> 40</span><span class="cp">#ifndef LM_RDME_BYTELATTICE_H_</span>
<span class="linenos"> 41</span><span class="cp">#define LM_RDME_BYTELATTICE_H_</span>
<span class="linenos"> 42</span>
<span class="linenos"> 43</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;map&gt;</span>
<span class="linenos"> 44</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;core/Types.h&quot;</span>
<span class="linenos"> 45</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;rdme/Lattice.h&quot;</span>
<span class="linenos"> 46</span>
<span class="linenos"> 47</span><span class="k">namespace</span><span class="w"> </span><span class="nn">lm</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 48</span><span class="k">namespace</span><span class="w"> </span><span class="nn">rdme</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 49</span>
<span class="linenos"> 50</span><span class="c1">/// @class ByteLattice</span>
<span class="linenos"> 51</span><span class="c1">/// @brief A Lattice that is based on packed bytes of memory, i.e. one byte per lattice site to hold particles</span>
<span class="linenos"> 52</span><span class="k">class</span><span class="w"> </span><span class="nc">ByteLattice</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">Lattice</span>
<span class="linenos"> 53</span><span class="p">{</span>
<span class="linenos"> 54</span><span class="w">	</span><span class="c1">// TODO: total hack.  Needed to access the actual data structures</span>
<span class="linenos"> 55</span><span class="w">	</span><span class="c1">// Should modify CudaByteLattice to do what I need.</span>
<span class="linenos"> 56</span><span class="w">	</span><span class="k">friend</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">MGPUMpdRdmeSolver</span><span class="p">;</span>
<span class="linenos"> 57</span><span class="w">	</span><span class="k">friend</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">MPIMpdRdmeSolver</span><span class="p">;</span>
<span class="linenos"> 58</span><span class="w">	</span><span class="k">friend</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">MpdRdmeSolver</span><span class="p">;</span>
<span class="linenos"> 59</span>
<span class="linenos"> 60</span><span class="k">public</span><span class="o">:</span>
<span class="linenos"> 61</span><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">nativeSerialize</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">destBuffer</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">lattice</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">latticeSize</span><span class="p">);</span>
<span class="linenos"> 62</span><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">nativeSerializeSites</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">destBuffer</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">lattice</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">latticeSize</span><span class="p">);</span>
<span class="linenos"> 63</span><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">copyNativeToRowMajorByte</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">destBuffer</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">sourceBuffer</span><span class="p">,</span><span class="w"> </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">xSize</span><span class="p">,</span><span class="w"> </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">ySize</span><span class="p">,</span><span class="w"> </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">zSize</span><span class="p">,</span><span class="w"> </span><span class="n">uint</span><span class="w"> </span><span class="n">particlesPerSite</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">bufferSize</span><span class="p">);</span>
<span class="linenos"> 64</span><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">copyRowMajorByteToNative</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">destBuffer</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">sourceBuffer</span><span class="p">,</span><span class="w"> </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">xSize</span><span class="p">,</span><span class="w"> </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">ySize</span><span class="p">,</span><span class="w"> </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">zSize</span><span class="p">,</span><span class="w"> </span><span class="n">uint</span><span class="w"> </span><span class="n">particlesPerSite</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">bufferSize</span><span class="p">);</span>
<span class="linenos"> 65</span><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">copySitesRowMajorByteToNative</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">destBuffer</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">sourceBuffer</span><span class="p">,</span><span class="w"> </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">xSize</span><span class="p">,</span><span class="w"> </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">ySize</span><span class="p">,</span><span class="w"> </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">zSize</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">bufferSize</span><span class="p">);</span>
<span class="linenos"> 66</span><span class="w">	</span><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">copySitesNativeToRowMajorByte</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">destBuffer</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">sourceBuffer</span><span class="p">,</span><span class="w"> </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">xSize</span><span class="p">,</span><span class="w"> </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">ySize</span><span class="p">,</span><span class="w"> </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">zSize</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">bufferSize</span><span class="p">);</span>
<span class="linenos"> 67</span>
<span class="linenos"> 68</span><span class="k">public</span><span class="o">:</span>
<span class="linenos"> 69</span><span class="w">    </span><span class="c1">// Lattice limits.</span>
<span class="linenos"> 70</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="n">site_t</span><span class="w"> </span><span class="n">getMaxSiteType</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="p">;</span>
<span class="linenos"> 71</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="n">particle_t</span><span class="w"> </span><span class="nf">getMaxParticle</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="p">;</span>
<span class="linenos"> 72</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="n">site_size_t</span><span class="w"> </span><span class="nf">getMaxOccupancy</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="p">;</span>
<span class="linenos"> 73</span>
<span class="linenos"> 74</span><span class="k">public</span><span class="o">:</span>
<span class="linenos"> 75</span><span class="w">    </span><span class="n">ByteLattice</span><span class="p">(</span><span class="n">lattice_coord_t</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">si_dist_t</span><span class="w"> </span><span class="n">spacing</span><span class="p">,</span><span class="w"> </span><span class="n">uint</span><span class="w"> </span><span class="n">particlesPerSite</span><span class="p">);</span>
<span class="linenos"> 76</span><span class="w">    </span><span class="n">ByteLattice</span><span class="p">(</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">xSize</span><span class="p">,</span><span class="w"> </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">ySize</span><span class="p">,</span><span class="w"> </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">zSize</span><span class="p">,</span><span class="w"> </span><span class="n">si_dist_t</span><span class="w"> </span><span class="n">spacing</span><span class="p">,</span><span class="w"> </span><span class="n">uint</span><span class="w"> </span><span class="n">particlesPerSite</span><span class="p">);</span>
<span class="linenos"> 77</span><span class="w">	</span><span class="k">virtual</span><span class="w"> </span><span class="o">~</span><span class="n">ByteLattice</span><span class="p">();</span>
<span class="linenos"> 78</span><span class="w">	</span>
<span class="linenos"> 79</span><span class="w">	</span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">getNeighboringSites</span><span class="p">(</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">index</span><span class="p">,</span><span class="w"> </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">neighboringIndices</span><span class="p">);</span>
<span class="linenos"> 80</span>
<span class="linenos"> 81</span><span class="w">	</span><span class="c1">// Lattice site methods.</span>
<span class="linenos"> 82</span><span class="w">	</span><span class="k">virtual</span><span class="w"> </span><span class="n">site_t</span><span class="w"> </span><span class="nf">getSiteType</span><span class="p">(</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="p">;</span>
<span class="linenos"> 83</span><span class="w">	</span><span class="k">virtual</span><span class="w"> </span><span class="n">site_t</span><span class="w"> </span><span class="nf">getSiteType</span><span class="p">(</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">subvolume</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="p">;</span>
<span class="linenos"> 84</span><span class="w">	</span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setSiteType</span><span class="p">(</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">z</span><span class="p">,</span><span class="w"> </span><span class="n">site_t</span><span class="w"> </span><span class="n">siteType</span><span class="p">);</span>
<span class="linenos"> 85</span><span class="w">	</span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setSiteType</span><span class="p">(</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">subvolume</span><span class="p">,</span><span class="w"> </span><span class="n">site_t</span><span class="w"> </span><span class="n">site</span><span class="p">);</span>
<span class="linenos"> 86</span>
<span class="linenos"> 87</span><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">copySites</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">destBuffer</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">latticeSize</span><span class="p">);</span>
<span class="linenos"> 88</span><span class="w">	</span>
<span class="linenos"> 89</span><span class="w">	</span><span class="c1">// Particle methods.</span>
<span class="linenos"> 90</span><span class="w">	</span><span class="k">virtual</span><span class="w"> </span><span class="n">site_size_t</span><span class="w"> </span><span class="nf">getOccupancy</span><span class="p">(</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="p">;</span>
<span class="linenos"> 91</span><span class="w">	</span><span class="k">virtual</span><span class="w"> </span><span class="n">site_size_t</span><span class="w"> </span><span class="nf">getOccupancy</span><span class="p">(</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">subvolume</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="p">;</span>
<span class="linenos"> 92</span><span class="w">	</span><span class="k">virtual</span><span class="w"> </span><span class="n">particle_t</span><span class="w"> </span><span class="nf">getParticle</span><span class="p">(</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">z</span><span class="p">,</span><span class="w"> </span><span class="n">site_size_t</span><span class="w"> </span><span class="n">particleIndex</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="p">;</span>
<span class="linenos"> 93</span><span class="w">	</span><span class="k">virtual</span><span class="w"> </span><span class="n">particle_t</span><span class="w"> </span><span class="nf">getParticle</span><span class="p">(</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">subvolume</span><span class="p">,</span><span class="w"> </span><span class="n">site_size_t</span><span class="w"> </span><span class="n">particleIndex</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="p">;</span>
<span class="linenos"> 94</span><span class="w">	</span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">addParticle</span><span class="p">(</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">z</span><span class="p">,</span><span class="w"> </span><span class="n">particle_t</span><span class="w"> </span><span class="n">particle</span><span class="p">);</span>
<span class="linenos"> 95</span><span class="w">	</span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">addParticle</span><span class="p">(</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">subvolume</span><span class="p">,</span><span class="w"> </span><span class="n">particle_t</span><span class="w"> </span><span class="n">particle</span><span class="p">);</span>
<span class="linenos"> 96</span><span class="w">	</span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">removeParticles</span><span class="p">(</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">z</span><span class="p">);</span>
<span class="linenos"> 97</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">removeParticles</span><span class="p">(</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">subvolume</span><span class="p">);</span>
<span class="linenos"> 98</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">removeAllParticles</span><span class="p">();</span>
<span class="linenos"> 99</span><span class="w">	</span>
<span class="linenos">100</span><span class="w">	</span><span class="c1">// Particle searching.</span>
<span class="linenos">101</span><span class="w">    </span><span class="cm">/*virtual particle_loc_t findParticle(particle_t particle);</span>
<span class="linenos">102</span><span class="cm">    virtual particle_loc_t findNextParticle(particle_loc_t previousParticle);</span>
<span class="linenos">103</span><span class="cm">    virtual particle_loc_t findNearbyParticle(particle_loc_t particle)=0;</span>
<span class="linenos">104</span><span class="cm">	*/</span>
<span class="linenos">105</span>
<span class="linenos">106</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">particle_t</span><span class="p">,</span><span class="n">uint</span><span class="o">&gt;</span><span class="w"> </span><span class="n">getParticleCounts</span><span class="p">();</span>
<span class="linenos">107</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">particle_loc_t</span><span class="o">&gt;</span><span class="w"> </span><span class="n">findParticles</span><span class="p">(</span><span class="n">particle_t</span><span class="w"> </span><span class="n">minParticleType</span><span class="p">,</span><span class="w"> </span><span class="n">particle_t</span><span class="w"> </span><span class="n">maxParticleType</span><span class="p">);</span>
<span class="linenos">108</span><span class="w">	</span>
<span class="linenos">109</span><span class="w">    </span><span class="c1">// Methods to set the data directly.</span>
<span class="linenos">110</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setFromRowMajorByteData</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">buffer</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">bufferSize</span><span class="p">);</span>
<span class="linenos">111</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setSitesFromRowMajorByteData</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">buffer</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">bufferSize</span><span class="p">);</span>
<span class="linenos">112</span><span class="w">    </span>
<span class="linenos">113</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">getParticleLatticeView</span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">**</span><span class="n">particleLattice</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">Nw</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">Nz</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">Ny</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">Nx</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">Np</span><span class="p">);</span>
<span class="linenos">114</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">getSiteLatticeView</span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">**</span><span class="n">siteLattice</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">Nz</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">Ny</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">Nx</span><span class="p">);</span>
<span class="linenos">115</span>
<span class="linenos">116</span><span class="w">	</span><span class="k">virtual</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="nf">getLatticeMemorySize</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="p">;</span>
<span class="linenos">117</span>
<span class="linenos">118</span><span class="k">protected</span><span class="o">:</span>
<span class="linenos">119</span><span class="w">	</span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">allocateMemory</span><span class="p">();</span>
<span class="linenos">120</span><span class="w">	</span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">deallocateMemory</span><span class="p">();</span>
<span class="linenos">121</span><span class="w">	</span><span class="k">virtual</span><span class="w"> </span><span class="kt">uint32_t</span><span class="o">*</span><span class="w"> </span><span class="nf">getParticlesMemory</span><span class="p">();</span>
<span class="linenos">122</span><span class="w">	</span><span class="k">virtual</span><span class="w"> </span><span class="kt">uint8_t</span><span class="o">*</span><span class="w"> </span><span class="nf">getSitesMemory</span><span class="p">();</span>
<span class="linenos">123</span>
<span class="linenos">124</span><span class="k">protected</span><span class="o">:</span>
<span class="linenos">125</span><span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">wordsPerSite</span><span class="p">;</span><span class="w">      </span><span class="c1">// Number of bytes per site</span>
<span class="linenos">126</span><span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">particles</span><span class="p">;</span><span class="w">   </span><span class="c1">// Array of lists of particles at each site</span>
<span class="linenos">127</span><span class="w">    </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">siteTypes</span><span class="p">;</span><span class="w">    </span><span class="c1">// Array of site types representing the lattice</span>
<span class="linenos">128</span>
<span class="linenos">129</span><span class="k">private</span><span class="o">:</span>
<span class="linenos">130</span><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">uint</span><span class="w"> </span><span class="n">PARTICLES_PER_WORD</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span>
<span class="linenos">131</span><span class="p">};</span>
<span class="linenos">132</span>
<span class="linenos">133</span><span class="p">}</span>
<span class="linenos">134</span><span class="p">}</span>
<span class="linenos">135</span>
<span class="linenos">136</span><span class="cp">#endif</span>
</pre></div>
</div>
</section>
<section id="bytelattice-cpp">
<h3>ByteLattice.cpp<a class="headerlink" href="#bytelattice-cpp" title="Link to this heading">#</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="linenos">  1</span><span class="cm">/*</span>
<span class="linenos">  2</span><span class="cm"> * University of Illinois Open Source License</span>
<span class="linenos">  3</span><span class="cm"> * Copyright 2008-2018 Luthey-Schulten Group,</span>
<span class="linenos">  4</span><span class="cm"> * All rights reserved.</span>
<span class="linenos">  5</span><span class="cm"> * </span>
<span class="linenos">  6</span><span class="cm"> * Developed by: Luthey-Schulten Group</span>
<span class="linenos">  7</span><span class="cm"> * 			     University of Illinois at Urbana-Champaign</span>
<span class="linenos">  8</span><span class="cm"> * 			     http://www.scs.uiuc.edu/~schulten</span>
<span class="linenos">  9</span><span class="cm"> * </span>
<span class="linenos"> 10</span><span class="cm"> * Permission is hereby granted, free of charge, to any person obtaining a copy of</span>
<span class="linenos"> 11</span><span class="cm"> * this software and associated documentation files (the Software), to deal with </span>
<span class="linenos"> 12</span><span class="cm"> * the Software without restriction, including without limitation the rights to </span>
<span class="linenos"> 13</span><span class="cm"> * use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies </span>
<span class="linenos"> 14</span><span class="cm"> * of the Software, and to permit persons to whom the Software is furnished to </span>
<span class="linenos"> 15</span><span class="cm"> * do so, subject to the following conditions:</span>
<span class="linenos"> 16</span><span class="cm"> * </span>
<span class="linenos"> 17</span><span class="cm"> * - Redistributions of source code must retain the above copyright notice, </span>
<span class="linenos"> 18</span><span class="cm"> * this list of conditions and the following disclaimers.</span>
<span class="linenos"> 19</span><span class="cm"> * </span>
<span class="linenos"> 20</span><span class="cm"> * - Redistributions in binary form must reproduce the above copyright notice, </span>
<span class="linenos"> 21</span><span class="cm"> * this list of conditions and the following disclaimers in the documentation </span>
<span class="linenos"> 22</span><span class="cm"> * and/or other materials provided with the distribution.</span>
<span class="linenos"> 23</span><span class="cm"> * </span>
<span class="linenos"> 24</span><span class="cm"> * - Neither the names of the Luthey-Schulten Group, University of Illinois at</span>
<span class="linenos"> 25</span><span class="cm"> * Urbana-Champaign, nor the names of its contributors may be used to endorse or</span>
<span class="linenos"> 26</span><span class="cm"> * promote products derived from this Software without specific prior written</span>
<span class="linenos"> 27</span><span class="cm"> * permission.</span>
<span class="linenos"> 28</span><span class="cm"> * </span>
<span class="linenos"> 29</span><span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR </span>
<span class="linenos"> 30</span><span class="cm"> * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, </span>
<span class="linenos"> 31</span><span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL </span>
<span class="linenos"> 32</span><span class="cm"> * THE CONTRIBUTORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR </span>
<span class="linenos"> 33</span><span class="cm"> * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, </span>
<span class="linenos"> 34</span><span class="cm"> * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR </span>
<span class="linenos"> 35</span><span class="cm"> * OTHER DEALINGS WITH THE SOFTWARE.</span>
<span class="linenos"> 36</span><span class="cm"> *</span>
<span class="linenos"> 37</span><span class="cm"> * Author(s): Elijah Roberts</span>
<span class="linenos"> 38</span><span class="cm"> */</span>
<span class="linenos"> 39</span>
<span class="linenos"> 40</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;map&gt;</span>
<span class="linenos"> 41</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;vector&gt;</span>
<span class="linenos"> 42</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;climits&gt;</span>
<span class="linenos"> 43</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;cstring&gt;</span>
<span class="linenos"> 44</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;config.h&quot;</span>
<span class="linenos"> 45</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;core/Types.h&quot;</span>
<span class="linenos"> 46</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;core/Exceptions.h&quot;</span>
<span class="linenos"> 47</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;rdme/Lattice.h&quot;</span>
<span class="linenos"> 48</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;rdme/ByteLattice.h&quot;</span>
<span class="linenos"> 49</span>
<span class="linenos"> 50</span><span class="k">namespace</span><span class="w"> </span><span class="nn">lm</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 51</span><span class="k">namespace</span><span class="w"> </span><span class="nn">rdme</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 52</span>
<span class="linenos"> 53</span><span class="n">site_t</span><span class="w"> </span><span class="nf">ByteLattice::getMaxSiteType</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span><span class="k">return</span><span class="w"> </span><span class="mi">255</span><span class="p">;}</span>
<span class="linenos"> 54</span><span class="n">particle_t</span><span class="w"> </span><span class="nf">ByteLattice::getMaxParticle</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span><span class="k">return</span><span class="w"> </span><span class="mi">255</span><span class="p">;}</span>
<span class="linenos"> 55</span><span class="n">site_size_t</span><span class="w"> </span><span class="nf">ByteLattice::getMaxOccupancy</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span><span class="k">return</span><span class="w"> </span><span class="n">PARTICLES_PER_WORD</span><span class="o">*</span><span class="n">wordsPerSite</span><span class="p">;}</span>
<span class="linenos"> 56</span>
<span class="linenos"> 57</span><span class="n">ByteLattice</span><span class="o">::</span><span class="n">ByteLattice</span><span class="p">(</span><span class="n">lattice_coord_t</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">si_dist_t</span><span class="w"> </span><span class="n">spacing</span><span class="p">,</span><span class="w"> </span><span class="n">uint</span><span class="w"> </span><span class="n">particlesPerSite</span><span class="p">)</span>
<span class="linenos"> 58</span><span class="o">:</span><span class="n">Lattice</span><span class="p">(</span><span class="n">size</span><span class="p">,</span><span class="n">spacing</span><span class="p">),</span><span class="n">wordsPerSite</span><span class="p">(</span><span class="n">particlesPerSite</span><span class="o">/</span><span class="n">PARTICLES_PER_WORD</span><span class="p">),</span><span class="n">particles</span><span class="p">(</span><span class="nb">NULL</span><span class="p">),</span><span class="n">siteTypes</span><span class="p">(</span><span class="nb">NULL</span><span class="p">)</span>
<span class="linenos"> 59</span><span class="p">{</span>
<span class="linenos"> 60</span><span class="w">    </span><span class="c1">// Make sure that the memory layout is compatible with our CUDA assumptions.</span>
<span class="linenos"> 61</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span><span class="o">*</span><span class="n">CHAR_BIT</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="n">Exception</span><span class="p">(</span><span class="s">&quot;a byte lattice can only be created on architectures with an 8-bit char type.&quot;</span><span class="p">);</span>
<span class="linenos"> 62</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span><span class="o">*</span><span class="n">CHAR_BIT</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">32</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="n">Exception</span><span class="p">(</span><span class="s">&quot;a byte lattice can only be created on architectures with a 32-bit int type.&quot;</span><span class="p">);</span>
<span class="linenos"> 63</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">wordsPerSite</span><span class="o">*</span><span class="n">PARTICLES_PER_WORD</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">particlesPerSite</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="n">InvalidArgException</span><span class="p">(</span><span class="s">&quot;particlesPerSite&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;must be evenly divisible by the number of particles per word&quot;</span><span class="p">);</span>
<span class="linenos"> 64</span><span class="w">    </span><span class="n">allocateMemory</span><span class="p">();</span>
<span class="linenos"> 65</span><span class="p">}</span>
<span class="linenos"> 66</span>
<span class="linenos"> 67</span><span class="n">ByteLattice</span><span class="o">::</span><span class="n">ByteLattice</span><span class="p">(</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">xSize</span><span class="p">,</span><span class="w"> </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">ySize</span><span class="p">,</span><span class="w"> </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">zSize</span><span class="p">,</span><span class="w"> </span><span class="n">si_dist_t</span><span class="w"> </span><span class="n">spacing</span><span class="p">,</span><span class="w"> </span><span class="n">uint</span><span class="w"> </span><span class="n">particlesPerSite</span><span class="p">)</span>
<span class="linenos"> 68</span><span class="o">:</span><span class="n">Lattice</span><span class="p">(</span><span class="n">xSize</span><span class="p">,</span><span class="n">ySize</span><span class="p">,</span><span class="n">zSize</span><span class="p">,</span><span class="n">spacing</span><span class="p">),</span><span class="n">wordsPerSite</span><span class="p">(</span><span class="n">particlesPerSite</span><span class="o">/</span><span class="n">PARTICLES_PER_WORD</span><span class="p">),</span><span class="n">particles</span><span class="p">(</span><span class="nb">NULL</span><span class="p">),</span><span class="n">siteTypes</span><span class="p">(</span><span class="nb">NULL</span><span class="p">)</span>
<span class="linenos"> 69</span><span class="p">{</span>
<span class="linenos"> 70</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span><span class="o">*</span><span class="n">CHAR_BIT</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="n">Exception</span><span class="p">(</span><span class="s">&quot;a byte lattice can only be created on architectures with an 8-bit char type.&quot;</span><span class="p">);</span>
<span class="linenos"> 71</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span><span class="o">*</span><span class="n">CHAR_BIT</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">32</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="n">Exception</span><span class="p">(</span><span class="s">&quot;a byte lattice can only be created on architectures with a 32-bit int type.&quot;</span><span class="p">);</span>
<span class="linenos"> 72</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">wordsPerSite</span><span class="o">*</span><span class="n">PARTICLES_PER_WORD</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">particlesPerSite</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="n">InvalidArgException</span><span class="p">(</span><span class="s">&quot;particlesPerSite&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;must be evenly divisible by the number of particles per word&quot;</span><span class="p">);</span>
<span class="linenos"> 73</span><span class="w">    </span><span class="n">allocateMemory</span><span class="p">();</span>
<span class="linenos"> 74</span><span class="p">}</span>
<span class="linenos"> 75</span>
<span class="linenos"> 76</span><span class="n">ByteLattice</span><span class="o">::~</span><span class="n">ByteLattice</span><span class="p">()</span>
<span class="linenos"> 77</span><span class="p">{</span>
<span class="linenos"> 78</span><span class="w">    </span><span class="n">deallocateMemory</span><span class="p">();</span>
<span class="linenos"> 79</span><span class="p">}</span>
<span class="linenos"> 80</span>
<span class="linenos"> 81</span><span class="kt">void</span><span class="w"> </span><span class="n">ByteLattice</span><span class="o">::</span><span class="n">getNeighboringSites</span><span class="p">(</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">index</span><span class="p">,</span><span class="w"> </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">neighboringIndices</span><span class="p">)</span>
<span class="linenos"> 82</span><span class="p">{</span>
<span class="linenos"> 83</span><span class="w">    </span><span class="c1">//         y+1</span>
<span class="linenos"> 84</span><span class="w">    </span><span class="c1">//         |  z+1</span>
<span class="linenos"> 85</span><span class="w">    </span><span class="c1">//         | /</span>
<span class="linenos"> 86</span><span class="w">    </span><span class="c1">//   x-1---i---x+1 </span>
<span class="linenos"> 87</span><span class="w">    </span><span class="c1">//        /|</span>
<span class="linenos"> 88</span><span class="w">    </span><span class="c1">//     z-1 |</span>
<span class="linenos"> 89</span><span class="w">    </span><span class="c1">//         y-1</span>
<span class="linenos"> 90</span><span class="w">	</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">index</span><span class="o">/</span><span class="p">(</span><span class="n">size</span><span class="p">.</span><span class="n">x</span><span class="o">*</span><span class="n">size</span><span class="p">.</span><span class="n">y</span><span class="p">);</span>
<span class="linenos"> 91</span><span class="w">	</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">xy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">index</span><span class="o">-</span><span class="p">(</span><span class="n">z</span><span class="o">*</span><span class="n">size</span><span class="p">.</span><span class="n">x</span><span class="o">*</span><span class="n">size</span><span class="p">.</span><span class="n">y</span><span class="p">);</span>
<span class="linenos"> 92</span><span class="w">	</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">xy</span><span class="o">/</span><span class="n">size</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
<span class="linenos"> 93</span><span class="w">	</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">xy</span><span class="o">-</span><span class="p">(</span><span class="n">y</span><span class="o">*</span><span class="n">size</span><span class="p">.</span><span class="n">x</span><span class="p">);</span>
<span class="linenos"> 94</span>
<span class="linenos"> 95</span><span class="w">	</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">xySize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">size</span><span class="p">.</span><span class="n">x</span><span class="o">*</span><span class="n">size</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
<span class="linenos"> 96</span><span class="w">	</span><span class="n">neighboringIndices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span><span class="o">?</span><span class="p">(</span><span class="n">index</span><span class="mi">-1</span><span class="p">)</span><span class="o">:</span><span class="p">(</span><span class="n">index</span><span class="mi">-1</span><span class="o">+</span><span class="n">size</span><span class="p">.</span><span class="n">x</span><span class="p">);</span>
<span class="linenos"> 97</span><span class="w">	</span><span class="n">neighboringIndices</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="o">&lt;</span><span class="p">(</span><span class="n">size</span><span class="p">.</span><span class="n">x</span><span class="mi">-1</span><span class="p">))</span><span class="o">?</span><span class="p">(</span><span class="n">index</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">:</span><span class="p">(</span><span class="n">index</span><span class="o">+</span><span class="mi">1</span><span class="o">-</span><span class="n">size</span><span class="p">.</span><span class="n">x</span><span class="p">);</span>
<span class="linenos"> 98</span><span class="w">	</span><span class="n">neighboringIndices</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">y</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span><span class="o">?</span><span class="p">(</span><span class="n">index</span><span class="o">-</span><span class="n">size</span><span class="p">.</span><span class="n">x</span><span class="p">)</span><span class="o">:</span><span class="p">(</span><span class="n">index</span><span class="o">-</span><span class="n">size</span><span class="p">.</span><span class="n">x</span><span class="o">+</span><span class="n">xySize</span><span class="p">);</span>
<span class="linenos"> 99</span><span class="w">	</span><span class="n">neighboringIndices</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">y</span><span class="o">&lt;</span><span class="p">(</span><span class="n">size</span><span class="p">.</span><span class="n">y</span><span class="mi">-1</span><span class="p">))</span><span class="o">?</span><span class="p">(</span><span class="n">index</span><span class="o">+</span><span class="n">size</span><span class="p">.</span><span class="n">x</span><span class="p">)</span><span class="o">:</span><span class="p">(</span><span class="n">index</span><span class="o">+</span><span class="n">size</span><span class="p">.</span><span class="n">x</span><span class="o">-</span><span class="n">xySize</span><span class="p">);</span>
<span class="linenos">100</span><span class="w">	</span><span class="n">neighboringIndices</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">z</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span><span class="o">?</span><span class="p">(</span><span class="n">index</span><span class="o">-</span><span class="n">xySize</span><span class="p">)</span><span class="o">:</span><span class="p">(</span><span class="n">index</span><span class="o">-</span><span class="n">xySize</span><span class="o">+</span><span class="n">numberSites</span><span class="p">);</span>
<span class="linenos">101</span><span class="w">	</span><span class="n">neighboringIndices</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">z</span><span class="o">&lt;</span><span class="p">(</span><span class="n">size</span><span class="p">.</span><span class="n">z</span><span class="mi">-1</span><span class="p">))</span><span class="o">?</span><span class="p">(</span><span class="n">index</span><span class="o">+</span><span class="n">xySize</span><span class="p">)</span><span class="o">:</span><span class="p">(</span><span class="n">index</span><span class="o">+</span><span class="n">xySize</span><span class="o">-</span><span class="n">numberSites</span><span class="p">);</span>
<span class="linenos">102</span><span class="p">}</span>
<span class="linenos">103</span>
<span class="linenos">104</span><span class="kt">size_t</span><span class="w"> </span><span class="n">ByteLattice</span><span class="o">::</span><span class="n">getLatticeMemorySize</span><span class="p">()</span><span class="w"> </span><span class="k">const</span>
<span class="linenos">105</span><span class="p">{</span>
<span class="linenos">106</span><span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="p">(</span><span class="n">numberSites</span><span class="p">)</span><span class="o">*</span><span class="kt">size_t</span><span class="p">(</span><span class="n">wordsPerSite</span><span class="p">)</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">));</span>
<span class="linenos">107</span><span class="p">}</span>
<span class="linenos">108</span>
<span class="linenos">109</span><span class="kt">void</span><span class="w"> </span><span class="n">ByteLattice</span><span class="o">::</span><span class="n">allocateMemory</span><span class="p">()</span>
<span class="linenos">110</span><span class="p">{</span>
<span class="linenos">111</span><span class="w">    </span><span class="c1">// Allocate the data for the particles.</span>
<span class="linenos">112</span><span class="w">    </span><span class="n">particles</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">uint32_t</span><span class="p">[</span><span class="n">numberSites</span><span class="o">*</span><span class="n">wordsPerSite</span><span class="p">];</span>
<span class="linenos">113</span><span class="w">    </span><span class="n">memset</span><span class="p">(</span><span class="n">particles</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">getLatticeMemorySize</span><span class="p">());</span>
<span class="linenos">114</span>
<span class="linenos">115</span><span class="w">    </span><span class="c1">// Allocate the data for the site types.</span>
<span class="linenos">116</span><span class="w">    </span><span class="n">siteTypes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">uint8_t</span><span class="p">[</span><span class="n">numberSites</span><span class="p">];</span>
<span class="linenos">117</span><span class="w">    </span><span class="n">memset</span><span class="p">(</span><span class="n">siteTypes</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">numberSites</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">uint8_t</span><span class="p">));</span>
<span class="linenos">118</span><span class="p">}</span>
<span class="linenos">119</span>
<span class="linenos">120</span><span class="kt">void</span><span class="w"> </span><span class="n">ByteLattice</span><span class="o">::</span><span class="n">deallocateMemory</span><span class="p">()</span>
<span class="linenos">121</span><span class="p">{</span>
<span class="linenos">122</span><span class="w">    </span><span class="c1">// Free any allocated memory.</span>
<span class="linenos">123</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">particles</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span>
<span class="linenos">124</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">125</span><span class="w">        </span><span class="k">delete</span><span class="p">[]</span><span class="w"> </span><span class="n">particles</span><span class="p">;</span>
<span class="linenos">126</span><span class="w">        </span><span class="n">particles</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="linenos">127</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">128</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">siteTypes</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span>
<span class="linenos">129</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">130</span><span class="w">        </span><span class="k">delete</span><span class="p">[]</span><span class="w"> </span><span class="n">siteTypes</span><span class="p">;</span>
<span class="linenos">131</span><span class="w">        </span><span class="n">siteTypes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="linenos">132</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">133</span><span class="p">}</span>
<span class="linenos">134</span>
<span class="linenos">135</span><span class="kt">void</span><span class="w"> </span><span class="n">ByteLattice</span><span class="o">::</span><span class="n">getSiteLatticeView</span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">**</span><span class="n">siteLattice</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">Nz</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">Ny</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">Nx</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">136</span><span class="w">    </span><span class="o">*</span><span class="n">Nx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">size</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
<span class="linenos">137</span><span class="w">    </span><span class="o">*</span><span class="n">Ny</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">size</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
<span class="linenos">138</span><span class="w">    </span><span class="o">*</span><span class="n">Nz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">size</span><span class="p">.</span><span class="n">z</span><span class="p">;</span>
<span class="linenos">139</span><span class="w">    </span><span class="o">*</span><span class="n">siteLattice</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">siteTypes</span><span class="p">;</span>
<span class="linenos">140</span><span class="p">}</span>
<span class="linenos">141</span>
<span class="linenos">142</span><span class="kt">void</span><span class="w"> </span><span class="n">ByteLattice</span><span class="o">::</span><span class="n">getParticleLatticeView</span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">**</span><span class="n">particleLattice</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">Nw</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">Nz</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">Ny</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">Nx</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">Np</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">143</span><span class="w">    </span><span class="o">*</span><span class="n">Nx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">size</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
<span class="linenos">144</span><span class="w">    </span><span class="o">*</span><span class="n">Ny</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">size</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
<span class="linenos">145</span><span class="w">    </span><span class="o">*</span><span class="n">Nz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">size</span><span class="p">.</span><span class="n">z</span><span class="p">;</span>
<span class="linenos">146</span><span class="w">    </span><span class="o">*</span><span class="n">Np</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PARTICLES_PER_WORD</span><span class="p">;</span><span class="w"> </span>
<span class="linenos">147</span><span class="w">    </span><span class="o">*</span><span class="n">Nw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wordsPerSite</span><span class="p">;</span>
<span class="linenos">148</span><span class="w">    </span><span class="o">*</span><span class="n">particleLattice</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">particles</span><span class="p">;</span>
<span class="linenos">149</span><span class="p">}</span>
<span class="linenos">150</span>
<span class="linenos">151</span><span class="n">site_t</span><span class="w"> </span><span class="n">ByteLattice</span><span class="o">::</span><span class="n">getSiteType</span><span class="p">(</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="k">const</span>
<span class="linenos">152</span><span class="p">{</span>
<span class="linenos">153</span><span class="w">	</span><span class="c1">// Make sure the arguments are valid.</span>
<span class="linenos">154</span><span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">size</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">size</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">z</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">size</span><span class="p">.</span><span class="n">z</span><span class="p">)</span>
<span class="linenos">155</span><span class="w">		</span><span class="k">throw</span><span class="w"> </span><span class="n">InvalidSiteException</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">);</span>
<span class="linenos">156</span><span class="w">	</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">latticeIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="o">+</span><span class="p">(</span><span class="n">y</span><span class="o">*</span><span class="n">size</span><span class="p">.</span><span class="n">x</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="n">z</span><span class="o">*</span><span class="n">size</span><span class="p">.</span><span class="n">x</span><span class="o">*</span><span class="n">size</span><span class="p">.</span><span class="n">y</span><span class="p">);</span>
<span class="linenos">157</span><span class="w">	</span>
<span class="linenos">158</span><span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">site_t</span><span class="p">)</span><span class="n">siteTypes</span><span class="p">[</span><span class="n">latticeIndex</span><span class="p">];</span>
<span class="linenos">159</span><span class="p">}</span>
<span class="linenos">160</span>
<span class="linenos">161</span><span class="n">site_t</span><span class="w"> </span><span class="n">ByteLattice</span><span class="o">::</span><span class="n">getSiteType</span><span class="p">(</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">index</span><span class="p">)</span><span class="w"> </span><span class="k">const</span>
<span class="linenos">162</span><span class="p">{</span>
<span class="linenos">163</span><span class="w">	</span><span class="c1">// Make sure the arguments are valid.</span>
<span class="linenos">164</span><span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">index</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">numberSites</span><span class="p">)</span>
<span class="linenos">165</span><span class="w">		</span><span class="k">throw</span><span class="w"> </span><span class="n">InvalidSiteException</span><span class="p">(</span><span class="n">index</span><span class="p">);</span>
<span class="linenos">166</span><span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">site_t</span><span class="p">)</span><span class="n">siteTypes</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
<span class="linenos">167</span><span class="p">}</span>
<span class="linenos">168</span>
<span class="linenos">169</span><span class="kt">void</span><span class="w"> </span><span class="n">ByteLattice</span><span class="o">::</span><span class="n">setSiteType</span><span class="p">(</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">z</span><span class="p">,</span><span class="w"> </span><span class="n">site_t</span><span class="w"> </span><span class="n">siteType</span><span class="p">)</span>
<span class="linenos">170</span><span class="p">{</span>
<span class="linenos">171</span><span class="w">    </span><span class="c1">// Make sure the arguments are valid.</span>
<span class="linenos">172</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">size</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">size</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">z</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">size</span><span class="p">.</span><span class="n">z</span><span class="p">)</span>
<span class="linenos">173</span><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="n">InvalidSiteException</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">);</span>
<span class="linenos">174</span><span class="w">    </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">latticeIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="o">+</span><span class="p">(</span><span class="n">y</span><span class="o">*</span><span class="n">size</span><span class="p">.</span><span class="n">x</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="n">z</span><span class="o">*</span><span class="n">size</span><span class="p">.</span><span class="n">x</span><span class="o">*</span><span class="n">size</span><span class="p">.</span><span class="n">y</span><span class="p">);</span>
<span class="linenos">175</span>
<span class="linenos">176</span><span class="w">    </span><span class="n">siteTypes</span><span class="p">[</span><span class="n">latticeIndex</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span><span class="n">siteType</span><span class="p">;</span>
<span class="linenos">177</span><span class="p">}</span>
<span class="linenos">178</span>
<span class="linenos">179</span><span class="kt">void</span><span class="w"> </span><span class="n">ByteLattice</span><span class="o">::</span><span class="n">setSiteType</span><span class="p">(</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">index</span><span class="p">,</span><span class="w"> </span><span class="n">site_t</span><span class="w"> </span><span class="n">siteType</span><span class="p">)</span>
<span class="linenos">180</span><span class="p">{</span>
<span class="linenos">181</span><span class="w">    </span><span class="c1">// Make sure the arguments are valid.</span>
<span class="linenos">182</span><span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">index</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">numberSites</span><span class="p">)</span>
<span class="linenos">183</span><span class="w">		</span><span class="k">throw</span><span class="w"> </span><span class="n">InvalidSiteException</span><span class="p">(</span><span class="n">index</span><span class="p">);</span>
<span class="linenos">184</span><span class="w">    </span><span class="n">siteTypes</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span><span class="n">siteType</span><span class="p">;</span>
<span class="linenos">185</span><span class="p">}</span>
<span class="linenos">186</span>
<span class="linenos">187</span><span class="n">site_size_t</span><span class="w"> </span><span class="n">ByteLattice</span><span class="o">::</span><span class="n">getOccupancy</span><span class="p">(</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="k">const</span>
<span class="linenos">188</span><span class="p">{</span>
<span class="linenos">189</span><span class="w">    </span><span class="c1">// Make sure the arguments are valid.</span>
<span class="linenos">190</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">size</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">size</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">z</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">size</span><span class="p">.</span><span class="n">z</span><span class="p">)</span>
<span class="linenos">191</span><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="n">InvalidSiteException</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">);</span>
<span class="linenos">192</span><span class="w">    </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">latticeIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="o">+</span><span class="p">(</span><span class="n">y</span><span class="o">*</span><span class="n">size</span><span class="p">.</span><span class="n">x</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="n">z</span><span class="o">*</span><span class="n">size</span><span class="p">.</span><span class="n">x</span><span class="o">*</span><span class="n">size</span><span class="p">.</span><span class="n">y</span><span class="p">);</span>
<span class="linenos">193</span><span class="w">	</span>
<span class="linenos">194</span><span class="w">	</span><span class="c1">// Count the number of particles at the site.</span>
<span class="linenos">195</span><span class="w">    </span><span class="n">site_size_t</span><span class="w"> </span><span class="n">occupancy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">196</span><span class="w">	</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">wi</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">wi</span><span class="o">&lt;</span><span class="n">wordsPerSite</span><span class="p">;</span><span class="w"> </span><span class="n">wi</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">197</span><span class="w">	</span><span class="p">{</span>
<span class="linenos">198</span><span class="w">        </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">byteParticles</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">particles</span><span class="p">[</span><span class="n">latticeIndex</span><span class="p">]);</span>
<span class="linenos">199</span><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">pi</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">pi</span><span class="o">&lt;</span><span class="n">PARTICLES_PER_WORD</span><span class="p">;</span><span class="w"> </span><span class="n">pi</span><span class="o">++</span><span class="p">,</span><span class="w"> </span><span class="n">occupancy</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">200</span><span class="w">        </span><span class="p">{</span>
<span class="linenos">201</span><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">byteParticles</span><span class="p">[</span><span class="n">pi</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">occupancy</span><span class="p">;</span>
<span class="linenos">202</span><span class="w">        </span><span class="p">}</span>
<span class="linenos">203</span><span class="w">        </span><span class="n">latticeIndex</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">numberSites</span><span class="p">;</span>
<span class="linenos">204</span><span class="w">	</span><span class="p">}</span>
<span class="linenos">205</span><span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="n">occupancy</span><span class="p">;</span>
<span class="linenos">206</span><span class="p">}</span>
<span class="linenos">207</span>
<span class="linenos">208</span><span class="n">site_size_t</span><span class="w"> </span><span class="n">ByteLattice</span><span class="o">::</span><span class="n">getOccupancy</span><span class="p">(</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">index</span><span class="p">)</span><span class="w"> </span><span class="k">const</span>
<span class="linenos">209</span><span class="p">{</span>
<span class="linenos">210</span><span class="w">    </span><span class="c1">// Make sure the arguments are valid.</span>
<span class="linenos">211</span><span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">index</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">numberSites</span><span class="p">)</span>
<span class="linenos">212</span><span class="w">		</span><span class="k">throw</span><span class="w"> </span><span class="n">InvalidSiteException</span><span class="p">(</span><span class="n">index</span><span class="p">);</span>
<span class="linenos">213</span>
<span class="linenos">214</span><span class="w">	</span><span class="c1">// Count the number of particles at the site.</span>
<span class="linenos">215</span><span class="w">    </span><span class="n">site_size_t</span><span class="w"> </span><span class="n">occupancy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">216</span><span class="w">	</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">wi</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">wi</span><span class="o">&lt;</span><span class="n">wordsPerSite</span><span class="p">;</span><span class="w"> </span><span class="n">wi</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">217</span><span class="w">	</span><span class="p">{</span>
<span class="linenos">218</span><span class="w">        </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">byteParticles</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">particles</span><span class="p">[</span><span class="n">index</span><span class="p">]);</span>
<span class="linenos">219</span><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">pi</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">pi</span><span class="o">&lt;</span><span class="n">PARTICLES_PER_WORD</span><span class="p">;</span><span class="w"> </span><span class="n">pi</span><span class="o">++</span><span class="p">,</span><span class="w"> </span><span class="n">occupancy</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">220</span><span class="w">        </span><span class="p">{</span>
<span class="linenos">221</span><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">byteParticles</span><span class="p">[</span><span class="n">pi</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">occupancy</span><span class="p">;</span>
<span class="linenos">222</span><span class="w">        </span><span class="p">}</span>
<span class="linenos">223</span><span class="w">        </span><span class="n">index</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">numberSites</span><span class="p">;</span>
<span class="linenos">224</span><span class="w">	</span><span class="p">}</span>
<span class="linenos">225</span><span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="n">occupancy</span><span class="p">;</span>
<span class="linenos">226</span><span class="p">}</span>
<span class="linenos">227</span>
<span class="linenos">228</span><span class="n">particle_t</span><span class="w"> </span><span class="n">ByteLattice</span><span class="o">::</span><span class="n">getParticle</span><span class="p">(</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">z</span><span class="p">,</span><span class="w"> </span><span class="n">site_size_t</span><span class="w"> </span><span class="n">particleIndex</span><span class="p">)</span><span class="w"> </span><span class="k">const</span>
<span class="linenos">229</span><span class="p">{</span>
<span class="linenos">230</span><span class="w">	</span><span class="c1">// Make sure the arguments are valid.</span>
<span class="linenos">231</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">size</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">size</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">z</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">size</span><span class="p">.</span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">232</span><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="n">InvalidSiteException</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">);</span>
<span class="linenos">233</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">234</span><span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">particleIndex</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">getMaxOccupancy</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">235</span><span class="w">		</span><span class="k">throw</span><span class="w"> </span><span class="n">InvalidParticleException</span><span class="p">(</span><span class="n">particleIndex</span><span class="p">);</span>
<span class="linenos">236</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">237</span><span class="w">    </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">latticeIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="o">+</span><span class="p">(</span><span class="n">y</span><span class="o">*</span><span class="n">size</span><span class="p">.</span><span class="n">x</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="n">z</span><span class="o">*</span><span class="n">size</span><span class="p">.</span><span class="n">x</span><span class="o">*</span><span class="n">size</span><span class="p">.</span><span class="n">y</span><span class="p">);</span>
<span class="linenos">238</span><span class="w">	</span>
<span class="linenos">239</span><span class="w">    </span><span class="c1">// Figure out which word the particle is in.</span>
<span class="linenos">240</span><span class="w">    </span><span class="n">uint</span><span class="w"> </span><span class="n">word</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">particleIndex</span><span class="o">/</span><span class="n">PARTICLES_PER_WORD</span><span class="p">;</span>
<span class="linenos">241</span><span class="w">    </span><span class="n">latticeIndex</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">numberSites</span><span class="o">*</span><span class="n">word</span><span class="p">;</span>
<span class="linenos">242</span><span class="w">    </span><span class="n">uint</span><span class="w"> </span><span class="n">byteIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">particleIndex</span><span class="o">%</span><span class="n">PARTICLES_PER_WORD</span><span class="p">;</span>
<span class="linenos">243</span>
<span class="linenos">244</span><span class="w">	</span><span class="c1">// Get the value.</span>
<span class="linenos">245</span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">((</span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">particles</span><span class="p">[</span><span class="n">latticeIndex</span><span class="p">]))[</span><span class="n">byteIndex</span><span class="p">];</span>
<span class="linenos">246</span><span class="p">}</span>
<span class="linenos">247</span>
<span class="linenos">248</span><span class="n">particle_t</span><span class="w"> </span><span class="n">ByteLattice</span><span class="o">::</span><span class="n">getParticle</span><span class="p">(</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">index</span><span class="p">,</span><span class="w"> </span><span class="n">site_size_t</span><span class="w"> </span><span class="n">particleIndex</span><span class="p">)</span><span class="w"> </span><span class="k">const</span>
<span class="linenos">249</span><span class="p">{</span>
<span class="linenos">250</span><span class="w">	</span><span class="c1">// Make sure the arguments are valid.</span>
<span class="linenos">251</span><span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">index</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">numberSites</span><span class="p">)</span>
<span class="linenos">252</span><span class="w">		</span><span class="k">throw</span><span class="w"> </span><span class="n">InvalidSiteException</span><span class="p">(</span><span class="n">index</span><span class="p">);</span>
<span class="linenos">253</span><span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">particleIndex</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">getMaxOccupancy</span><span class="p">())</span>
<span class="linenos">254</span><span class="w">		</span><span class="k">throw</span><span class="w"> </span><span class="n">InvalidParticleException</span><span class="p">(</span><span class="n">particleIndex</span><span class="p">);</span>
<span class="linenos">255</span>
<span class="linenos">256</span><span class="w">    </span><span class="c1">// Figure out which word the particle is in.</span>
<span class="linenos">257</span><span class="w">    </span><span class="n">uint</span><span class="w"> </span><span class="n">word</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">particleIndex</span><span class="o">/</span><span class="n">PARTICLES_PER_WORD</span><span class="p">;</span>
<span class="linenos">258</span><span class="w">    </span><span class="n">index</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">numberSites</span><span class="o">*</span><span class="n">word</span><span class="p">;</span>
<span class="linenos">259</span><span class="w">    </span><span class="n">uint</span><span class="w"> </span><span class="n">byteIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">particleIndex</span><span class="o">%</span><span class="n">PARTICLES_PER_WORD</span><span class="p">;</span>
<span class="linenos">260</span>
<span class="linenos">261</span><span class="w">	</span><span class="c1">// Get the value.</span>
<span class="linenos">262</span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">((</span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">particles</span><span class="p">[</span><span class="n">index</span><span class="p">]))[</span><span class="n">byteIndex</span><span class="p">];</span>
<span class="linenos">263</span><span class="p">}</span>
<span class="linenos">264</span>
<span class="linenos">265</span><span class="kt">void</span><span class="w"> </span><span class="n">ByteLattice</span><span class="o">::</span><span class="n">addParticle</span><span class="p">(</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">z</span><span class="p">,</span><span class="w"> </span><span class="n">particle_t</span><span class="w"> </span><span class="n">particle</span><span class="p">)</span>
<span class="linenos">266</span><span class="p">{</span>
<span class="linenos">267</span><span class="w">	</span><span class="c1">// Make sure the arguments are valid.</span>
<span class="linenos">268</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">size</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">size</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">z</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">size</span><span class="p">.</span><span class="n">z</span><span class="p">)</span>
<span class="linenos">269</span><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="n">InvalidSiteException</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">);</span>
<span class="linenos">270</span><span class="w">    </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">latticeIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="o">+</span><span class="p">(</span><span class="n">y</span><span class="o">*</span><span class="n">size</span><span class="p">.</span><span class="n">x</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="n">z</span><span class="o">*</span><span class="n">size</span><span class="p">.</span><span class="n">x</span><span class="o">*</span><span class="n">size</span><span class="p">.</span><span class="n">y</span><span class="p">);</span>
<span class="linenos">271</span>
<span class="linenos">272</span><span class="w">    </span><span class="c1">// Go through the particles at the site.</span>
<span class="linenos">273</span><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">wi</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">wi</span><span class="o">&lt;</span><span class="n">wordsPerSite</span><span class="p">;</span><span class="w"> </span><span class="n">wi</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">274</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">275</span><span class="w">        </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">byteParticles</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">particles</span><span class="p">[</span><span class="n">latticeIndex</span><span class="p">]);</span>
<span class="linenos">276</span><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">pi</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">pi</span><span class="o">&lt;</span><span class="n">PARTICLES_PER_WORD</span><span class="p">;</span><span class="w"> </span><span class="n">pi</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">277</span><span class="w">        </span><span class="p">{</span>
<span class="linenos">278</span><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">byteParticles</span><span class="p">[</span><span class="n">pi</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">279</span><span class="w">            </span><span class="p">{</span>
<span class="linenos">280</span><span class="w">                </span><span class="n">byteParticles</span><span class="p">[</span><span class="n">pi</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span><span class="n">particle</span><span class="p">;</span>
<span class="linenos">281</span><span class="w">                </span><span class="k">return</span><span class="p">;</span>
<span class="linenos">282</span><span class="w">            </span><span class="p">}</span>
<span class="linenos">283</span><span class="w">        </span><span class="p">}</span>
<span class="linenos">284</span><span class="w">        </span><span class="n">latticeIndex</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">numberSites</span><span class="p">;</span>
<span class="linenos">285</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">286</span>
<span class="linenos">287</span><span class="w">    </span><span class="c1">// The site must have been full.</span>
<span class="linenos">288</span><span class="w">    </span><span class="k">throw</span><span class="w"> </span><span class="n">InvalidParticleException</span><span class="p">(</span><span class="n">getMaxOccupancy</span><span class="p">());</span>
<span class="linenos">289</span><span class="p">}</span>
<span class="linenos">290</span>
<span class="linenos">291</span><span class="kt">void</span><span class="w"> </span><span class="n">ByteLattice</span><span class="o">::</span><span class="n">addParticle</span><span class="p">(</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">index</span><span class="p">,</span><span class="w"> </span><span class="n">particle_t</span><span class="w"> </span><span class="n">particle</span><span class="p">)</span>
<span class="linenos">292</span><span class="p">{</span>
<span class="linenos">293</span><span class="w">	</span><span class="c1">// Make sure the arguments are valid.</span>
<span class="linenos">294</span><span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">index</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">numberSites</span><span class="p">)</span>
<span class="linenos">295</span><span class="w">		</span><span class="k">throw</span><span class="w"> </span><span class="n">InvalidSiteException</span><span class="p">(</span><span class="n">index</span><span class="p">);</span>
<span class="linenos">296</span>
<span class="linenos">297</span><span class="w">    </span><span class="c1">// Go through the particles at the site.</span>
<span class="linenos">298</span><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">wi</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">wi</span><span class="o">&lt;</span><span class="n">wordsPerSite</span><span class="p">;</span><span class="w"> </span><span class="n">wi</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">299</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">300</span><span class="w">        </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">byteParticles</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">particles</span><span class="p">[</span><span class="n">index</span><span class="p">]);</span>
<span class="linenos">301</span><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">pi</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">pi</span><span class="o">&lt;</span><span class="n">PARTICLES_PER_WORD</span><span class="p">;</span><span class="w"> </span><span class="n">pi</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">302</span><span class="w">        </span><span class="p">{</span>
<span class="linenos">303</span><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">byteParticles</span><span class="p">[</span><span class="n">pi</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">304</span><span class="w">            </span><span class="p">{</span>
<span class="linenos">305</span><span class="w">                </span><span class="n">byteParticles</span><span class="p">[</span><span class="n">pi</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span><span class="n">particle</span><span class="p">;</span>
<span class="linenos">306</span><span class="w">                </span><span class="k">return</span><span class="p">;</span>
<span class="linenos">307</span><span class="w">            </span><span class="p">}</span>
<span class="linenos">308</span><span class="w">        </span><span class="p">}</span>
<span class="linenos">309</span><span class="w">        </span><span class="n">index</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">numberSites</span><span class="p">;</span>
<span class="linenos">310</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">311</span>
<span class="linenos">312</span><span class="w">    </span><span class="c1">// The site must have been full.</span>
<span class="linenos">313</span><span class="w">    </span><span class="k">throw</span><span class="w"> </span><span class="n">InvalidParticleException</span><span class="p">(</span><span class="n">getMaxOccupancy</span><span class="p">());</span>
<span class="linenos">314</span><span class="p">}</span>
<span class="linenos">315</span>
<span class="linenos">316</span><span class="kt">void</span><span class="w"> </span><span class="n">ByteLattice</span><span class="o">::</span><span class="n">removeParticles</span><span class="p">(</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="linenos">317</span><span class="p">{</span>
<span class="linenos">318</span><span class="w">	</span><span class="c1">// Make sure the arguments are valid.</span>
<span class="linenos">319</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">size</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">size</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">z</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">size</span><span class="p">.</span><span class="n">z</span><span class="p">)</span>
<span class="linenos">320</span><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="n">InvalidSiteException</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">);</span>
<span class="linenos">321</span><span class="w">    </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">latticeIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="o">+</span><span class="p">(</span><span class="n">y</span><span class="o">*</span><span class="n">size</span><span class="p">.</span><span class="n">x</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="n">z</span><span class="o">*</span><span class="n">size</span><span class="p">.</span><span class="n">x</span><span class="o">*</span><span class="n">size</span><span class="p">.</span><span class="n">y</span><span class="p">);</span>
<span class="linenos">322</span><span class="w">	</span>
<span class="linenos">323</span><span class="w">    </span><span class="c1">// Reset all of the words for this site.</span>
<span class="linenos">324</span><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">wi</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">wi</span><span class="o">&lt;</span><span class="n">wordsPerSite</span><span class="p">;</span><span class="w"> </span><span class="n">wi</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">325</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">326</span><span class="w">        </span><span class="n">particles</span><span class="p">[</span><span class="n">latticeIndex</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">327</span><span class="w">        </span><span class="n">latticeIndex</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">numberSites</span><span class="p">;</span>
<span class="linenos">328</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">329</span><span class="p">}</span>
<span class="linenos">330</span>
<span class="linenos">331</span><span class="kt">void</span><span class="w"> </span><span class="n">ByteLattice</span><span class="o">::</span><span class="n">removeParticles</span><span class="p">(</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">index</span><span class="p">)</span>
<span class="linenos">332</span><span class="p">{</span>
<span class="linenos">333</span><span class="w">	</span><span class="c1">// Make sure the arguments are valid.</span>
<span class="linenos">334</span><span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">index</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">numberSites</span><span class="p">)</span>
<span class="linenos">335</span><span class="w">		</span><span class="k">throw</span><span class="w"> </span><span class="n">InvalidSiteException</span><span class="p">(</span><span class="n">index</span><span class="p">);</span>
<span class="linenos">336</span>
<span class="linenos">337</span><span class="w">    </span><span class="c1">// Reset all of the words for this site.</span>
<span class="linenos">338</span><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">wi</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">wi</span><span class="o">&lt;</span><span class="n">wordsPerSite</span><span class="p">;</span><span class="w"> </span><span class="n">wi</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">339</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">340</span><span class="w">        </span><span class="n">particles</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">341</span><span class="w">        </span><span class="n">index</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">numberSites</span><span class="p">;</span>
<span class="linenos">342</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">343</span><span class="p">}</span>
<span class="linenos">344</span>
<span class="linenos">345</span><span class="kt">void</span><span class="w"> </span><span class="n">ByteLattice</span><span class="o">::</span><span class="n">removeAllParticles</span><span class="p">()</span>
<span class="linenos">346</span><span class="p">{</span>
<span class="linenos">347</span><span class="w">    </span><span class="n">memset</span><span class="p">(</span><span class="n">particles</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">numberSites</span><span class="o">*</span><span class="n">wordsPerSite</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">));</span>
<span class="linenos">348</span><span class="p">}</span>
<span class="linenos">349</span>
<span class="linenos">350</span><span class="kt">void</span><span class="w"> </span><span class="n">ByteLattice</span><span class="o">::</span><span class="n">nativeSerialize</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">destBuffer</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">latticePtr</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">bufferSize</span><span class="p">)</span>
<span class="linenos">351</span><span class="p">{</span>
<span class="linenos">352</span><span class="w">    </span><span class="n">ByteLattice</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">lattice</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">ByteLattice</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">latticePtr</span><span class="p">;</span>
<span class="linenos">353</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">bufferSize</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getLatticeMemorySize</span><span class="p">())</span>
<span class="linenos">354</span><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="n">lm</span><span class="o">::</span><span class="n">InvalidArgException</span><span class="p">(</span><span class="s">&quot;bufferSize&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;the buffer size was not equal to the lattice data size&quot;</span><span class="p">);</span>
<span class="linenos">355</span><span class="w">    </span><span class="n">memcpy</span><span class="p">(</span><span class="n">destBuffer</span><span class="p">,</span><span class="w"> </span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">particles</span><span class="p">,</span><span class="w"> </span><span class="n">bufferSize</span><span class="p">);</span>
<span class="linenos">356</span><span class="p">}</span>
<span class="linenos">357</span>
<span class="linenos">358</span><span class="kt">void</span><span class="w"> </span><span class="n">ByteLattice</span><span class="o">::</span><span class="n">nativeSerializeSites</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">destBuffer</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">latticePtr</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">bufferSize</span><span class="p">)</span>
<span class="linenos">359</span><span class="p">{</span>
<span class="linenos">360</span><span class="w">    </span><span class="n">ByteLattice</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">lattice</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">ByteLattice</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">latticePtr</span><span class="p">;</span>
<span class="linenos">361</span><span class="w">	</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">copySites</span><span class="p">(</span><span class="n">destBuffer</span><span class="p">,</span><span class="w"> </span><span class="n">bufferSize</span><span class="p">);</span>
<span class="linenos">362</span><span class="p">}</span>
<span class="linenos">363</span>
<span class="linenos">364</span><span class="kt">void</span><span class="w"> </span><span class="n">ByteLattice</span><span class="o">::</span><span class="n">copySites</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">destBuffer</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">bufferSize</span><span class="p">)</span>
<span class="linenos">365</span><span class="p">{</span>
<span class="linenos">366</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">bufferSize</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">size</span><span class="p">.</span><span class="n">x</span><span class="o">*</span><span class="n">size</span><span class="p">.</span><span class="n">y</span><span class="o">*</span><span class="n">size</span><span class="p">.</span><span class="n">z</span><span class="p">)</span>
<span class="linenos">367</span><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="n">lm</span><span class="o">::</span><span class="n">InvalidArgException</span><span class="p">(</span><span class="s">&quot;bufferSize&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;the buffer size was not equal to the lattice site size&quot;</span><span class="p">);</span>
<span class="linenos">368</span><span class="w">    </span><span class="n">memcpy</span><span class="p">(</span><span class="n">destBuffer</span><span class="p">,</span><span class="w"> </span><span class="n">siteTypes</span><span class="p">,</span><span class="w"> </span><span class="n">bufferSize</span><span class="p">);</span>
<span class="linenos">369</span><span class="p">}</span>
<span class="linenos">370</span>
<span class="linenos">371</span><span class="kt">void</span><span class="w"> </span><span class="n">ByteLattice</span><span class="o">::</span><span class="n">copyNativeToRowMajorByte</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">destBuffer</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">sourceBuffer</span><span class="p">,</span><span class="w"> </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">xSize</span><span class="p">,</span><span class="w"> </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">ySize</span><span class="p">,</span><span class="w"> </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">zSize</span><span class="p">,</span><span class="w"> </span><span class="n">uint</span><span class="w"> </span><span class="n">particlesPerSite</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">bufferSize</span><span class="p">)</span>
<span class="linenos">372</span><span class="p">{</span>
<span class="linenos">373</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">bufferSize</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kt">size_t</span><span class="p">(</span><span class="n">xSize</span><span class="p">)</span><span class="o">*</span><span class="kt">size_t</span><span class="p">(</span><span class="n">ySize</span><span class="p">)</span><span class="o">*</span><span class="kt">size_t</span><span class="p">(</span><span class="n">zSize</span><span class="p">)</span><span class="o">*</span><span class="kt">size_t</span><span class="p">(</span><span class="n">particlesPerSite</span><span class="p">))</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="n">lm</span><span class="o">::</span><span class="n">InvalidArgException</span><span class="p">(</span><span class="s">&quot;bufferSize&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;the buffer size was not equal to the lattice data size&quot;</span><span class="p">);</span>
<span class="linenos">374</span><span class="w">    </span><span class="n">uint</span><span class="w"> </span><span class="n">wordsPerSite</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">particlesPerSite</span><span class="o">/</span><span class="n">PARTICLES_PER_WORD</span><span class="p">;</span>
<span class="linenos">375</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">wordsPerSite</span><span class="o">*</span><span class="n">PARTICLES_PER_WORD</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">particlesPerSite</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="n">InvalidArgException</span><span class="p">(</span><span class="s">&quot;particlesPerSite&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;must be evenly divisible by the number of particles per word&quot;</span><span class="p">);</span>
<span class="linenos">376</span>
<span class="linenos">377</span><span class="w">    </span><span class="c1">// Cast the buffers as appropriate.</span>
<span class="linenos">378</span><span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">sourceParticles</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uint32_t</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">sourceBuffer</span><span class="p">;</span>
<span class="linenos">379</span><span class="w">    </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">destParticles</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">destBuffer</span><span class="p">;</span>
<span class="linenos">380</span>
<span class="linenos">381</span>
<span class="linenos">382</span><span class="w">    </span><span class="c1">// Walk through the source buffer and copy the first word of particles.</span>
<span class="linenos">383</span><span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">latticeIndex</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">384</span><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">w</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">w</span><span class="o">&lt;</span><span class="n">wordsPerSite</span><span class="p">;</span><span class="w"> </span><span class="n">w</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">385</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">386</span><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">z</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">z</span><span class="o">&lt;</span><span class="n">zSize</span><span class="p">;</span><span class="w"> </span><span class="n">z</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">387</span><span class="w">        </span><span class="p">{</span>
<span class="linenos">388</span><span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">y</span><span class="o">&lt;</span><span class="n">ySize</span><span class="p">;</span><span class="w"> </span><span class="n">y</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">389</span><span class="w">            </span><span class="p">{</span>
<span class="linenos">390</span><span class="w">                </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">x</span><span class="o">&lt;</span><span class="n">xSize</span><span class="p">;</span><span class="w"> </span><span class="n">x</span><span class="o">++</span><span class="p">,</span><span class="w"> </span><span class="n">latticeIndex</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">391</span><span class="w">                </span><span class="p">{</span>
<span class="linenos">392</span><span class="w">                    </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">byteParticles</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">sourceParticles</span><span class="p">[</span><span class="n">latticeIndex</span><span class="p">]);</span>
<span class="linenos">393</span><span class="w">                    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">destIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="o">*</span><span class="kt">size_t</span><span class="p">(</span><span class="n">ySize</span><span class="p">)</span><span class="o">*</span><span class="kt">size_t</span><span class="p">(</span><span class="n">zSize</span><span class="p">)</span><span class="o">*</span><span class="kt">size_t</span><span class="p">(</span><span class="n">particlesPerSite</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">y</span><span class="o">*</span><span class="kt">size_t</span><span class="p">(</span><span class="n">zSize</span><span class="p">)</span><span class="o">*</span><span class="kt">size_t</span><span class="p">(</span><span class="n">particlesPerSite</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">z</span><span class="o">*</span><span class="kt">size_t</span><span class="p">(</span><span class="n">particlesPerSite</span><span class="p">);</span>
<span class="linenos">394</span><span class="w">                    </span><span class="n">destParticles</span><span class="p">[</span><span class="n">destIndex</span><span class="o">+</span><span class="n">w</span><span class="o">*</span><span class="n">PARTICLES_PER_WORD</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">byteParticles</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="linenos">395</span><span class="w">                    </span><span class="n">destParticles</span><span class="p">[</span><span class="n">destIndex</span><span class="o">+</span><span class="n">w</span><span class="o">*</span><span class="n">PARTICLES_PER_WORD</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">byteParticles</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<span class="linenos">396</span><span class="w">                    </span><span class="n">destParticles</span><span class="p">[</span><span class="n">destIndex</span><span class="o">+</span><span class="n">w</span><span class="o">*</span><span class="n">PARTICLES_PER_WORD</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">byteParticles</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<span class="linenos">397</span><span class="w">                    </span><span class="n">destParticles</span><span class="p">[</span><span class="n">destIndex</span><span class="o">+</span><span class="n">w</span><span class="o">*</span><span class="n">PARTICLES_PER_WORD</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">byteParticles</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
<span class="linenos">398</span><span class="w">                </span><span class="p">}</span>
<span class="linenos">399</span><span class="w">            </span><span class="p">}</span>
<span class="linenos">400</span><span class="w">        </span><span class="p">}</span>
<span class="linenos">401</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">402</span><span class="p">}</span>
<span class="linenos">403</span>
<span class="linenos">404</span><span class="kt">void</span><span class="w"> </span><span class="n">ByteLattice</span><span class="o">::</span><span class="n">copyRowMajorByteToNative</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">destBuffer</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">sourceBuffer</span><span class="p">,</span><span class="w"> </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">xSize</span><span class="p">,</span><span class="w"> </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">ySize</span><span class="p">,</span><span class="w"> </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">zSize</span><span class="p">,</span><span class="w"> </span><span class="n">uint</span><span class="w"> </span><span class="n">particlesPerSite</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">bufferSize</span><span class="p">)</span>
<span class="linenos">405</span><span class="p">{</span>
<span class="linenos">406</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">bufferSize</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kt">size_t</span><span class="p">(</span><span class="n">xSize</span><span class="p">)</span><span class="o">*</span><span class="kt">size_t</span><span class="p">(</span><span class="n">ySize</span><span class="p">)</span><span class="o">*</span><span class="kt">size_t</span><span class="p">(</span><span class="n">zSize</span><span class="p">)</span><span class="o">*</span><span class="kt">size_t</span><span class="p">(</span><span class="n">particlesPerSite</span><span class="p">))</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="n">lm</span><span class="o">::</span><span class="n">InvalidArgException</span><span class="p">(</span><span class="s">&quot;bufferSize&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;the buffer size was not equal to the lattice data size&quot;</span><span class="p">);</span>
<span class="linenos">407</span><span class="w">    </span><span class="n">uint</span><span class="w"> </span><span class="n">wordsPerSite</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">particlesPerSite</span><span class="o">/</span><span class="n">PARTICLES_PER_WORD</span><span class="p">;</span>
<span class="linenos">408</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">wordsPerSite</span><span class="o">*</span><span class="n">PARTICLES_PER_WORD</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">particlesPerSite</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="n">InvalidArgException</span><span class="p">(</span><span class="s">&quot;particlesPerSite&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;must be evenly divisible by the number of particles per word&quot;</span><span class="p">);</span>
<span class="linenos">409</span>
<span class="linenos">410</span><span class="w">    </span><span class="c1">// Cast the buffers as appropriate.</span>
<span class="linenos">411</span><span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">destParticles</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uint32_t</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">destBuffer</span><span class="p">;</span>
<span class="linenos">412</span><span class="w">    </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">sourceParticles</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">sourceBuffer</span><span class="p">;</span>
<span class="linenos">413</span><span class="w">  </span>
<span class="linenos">414</span>
<span class="linenos">415</span><span class="w">    </span><span class="c1">// Walk through the dest buffer and copy into it the particles one word at a time.</span>
<span class="linenos">416</span><span class="w">    </span><span class="n">uint</span><span class="w"> </span><span class="n">destIndex</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">417</span><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">w</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">w</span><span class="o">&lt;</span><span class="n">wordsPerSite</span><span class="p">;</span><span class="w"> </span><span class="n">w</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">418</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">419</span><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">z</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">z</span><span class="o">&lt;</span><span class="n">zSize</span><span class="p">;</span><span class="w"> </span><span class="n">z</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">420</span><span class="w">        </span><span class="p">{</span>
<span class="linenos">421</span><span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">y</span><span class="o">&lt;</span><span class="n">ySize</span><span class="p">;</span><span class="w"> </span><span class="n">y</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">422</span><span class="w">            </span><span class="p">{</span>
<span class="linenos">423</span><span class="w">                </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">x</span><span class="o">&lt;</span><span class="n">xSize</span><span class="p">;</span><span class="w"> </span><span class="n">x</span><span class="o">++</span><span class="p">,</span><span class="w"> </span><span class="n">destIndex</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">424</span><span class="w">                </span><span class="p">{</span>
<span class="linenos">425</span><span class="w">                    </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">destByteParticles</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">destParticles</span><span class="p">[</span><span class="n">destIndex</span><span class="p">]);</span>
<span class="linenos">426</span><span class="w">                    </span><span class="n">uint</span><span class="w"> </span><span class="n">sourceIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="o">*</span><span class="n">ySize</span><span class="o">*</span><span class="n">zSize</span><span class="o">*</span><span class="n">particlesPerSite</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">y</span><span class="o">*</span><span class="n">zSize</span><span class="o">*</span><span class="n">particlesPerSite</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">z</span><span class="o">*</span><span class="n">particlesPerSite</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">w</span><span class="o">*</span><span class="n">PARTICLES_PER_WORD</span><span class="p">;</span>
<span class="linenos">427</span><span class="w">                    </span><span class="n">destByteParticles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sourceParticles</span><span class="p">[</span><span class="n">sourceIndex</span><span class="p">];</span>
<span class="linenos">428</span><span class="w">                    </span><span class="n">destByteParticles</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sourceParticles</span><span class="p">[</span><span class="n">sourceIndex</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
<span class="linenos">429</span><span class="w">                    </span><span class="n">destByteParticles</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sourceParticles</span><span class="p">[</span><span class="n">sourceIndex</span><span class="o">+</span><span class="mi">2</span><span class="p">];</span>
<span class="linenos">430</span><span class="w">                    </span><span class="n">destByteParticles</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sourceParticles</span><span class="p">[</span><span class="n">sourceIndex</span><span class="o">+</span><span class="mi">3</span><span class="p">];</span>
<span class="linenos">431</span><span class="w">                </span><span class="p">}</span>
<span class="linenos">432</span><span class="w">            </span><span class="p">}</span>
<span class="linenos">433</span><span class="w">        </span><span class="p">}</span>
<span class="linenos">434</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">435</span><span class="p">}</span>
<span class="linenos">436</span>
<span class="linenos">437</span><span class="kt">void</span><span class="w"> </span><span class="n">ByteLattice</span><span class="o">::</span><span class="n">copySitesRowMajorByteToNative</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">destBuffer</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">sourceBuffer</span><span class="p">,</span><span class="w"> </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">xSize</span><span class="p">,</span><span class="w"> </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">ySize</span><span class="p">,</span><span class="w"> </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">zSize</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">bufferSize</span><span class="p">)</span>
<span class="linenos">438</span><span class="p">{</span>
<span class="linenos">439</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">bufferSize</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">xSize</span><span class="o">*</span><span class="n">ySize</span><span class="o">*</span><span class="n">zSize</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="n">lm</span><span class="o">::</span><span class="n">InvalidArgException</span><span class="p">(</span><span class="s">&quot;bufferSize&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;the buffer size was not equal to the lattice data size&quot;</span><span class="p">);</span>
<span class="linenos">440</span>
<span class="linenos">441</span><span class="w">    </span><span class="c1">// Cast the buffers as appropriate.</span>
<span class="linenos">442</span><span class="w">    </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">destSites</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">destBuffer</span><span class="p">;</span>
<span class="linenos">443</span><span class="w">    </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">sourceSites</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">sourceBuffer</span><span class="p">;</span>
<span class="linenos">444</span>
<span class="linenos">445</span>
<span class="linenos">446</span><span class="w">    </span><span class="c1">// Walk through the dest buffer and copy into it sites.</span>
<span class="linenos">447</span><span class="w">    </span><span class="n">uint</span><span class="w"> </span><span class="n">destIndex</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">448</span><span class="w">	</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">z</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">z</span><span class="o">&lt;</span><span class="n">zSize</span><span class="p">;</span><span class="w"> </span><span class="n">z</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">449</span><span class="w">	</span><span class="p">{</span>
<span class="linenos">450</span><span class="w">		</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">y</span><span class="o">&lt;</span><span class="n">ySize</span><span class="p">;</span><span class="w"> </span><span class="n">y</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">451</span><span class="w">		</span><span class="p">{</span>
<span class="linenos">452</span><span class="w">			</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">x</span><span class="o">&lt;</span><span class="n">xSize</span><span class="p">;</span><span class="w"> </span><span class="n">x</span><span class="o">++</span><span class="p">,</span><span class="w"> </span><span class="n">destIndex</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">453</span><span class="w">			</span><span class="p">{</span>
<span class="linenos">454</span><span class="w">				</span><span class="n">uint</span><span class="w"> </span><span class="n">sourceIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="o">*</span><span class="n">ySize</span><span class="o">*</span><span class="n">zSize</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">y</span><span class="o">*</span><span class="n">zSize</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">z</span><span class="p">;</span>
<span class="linenos">455</span><span class="w">				</span><span class="n">destSites</span><span class="p">[</span><span class="n">destIndex</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sourceSites</span><span class="p">[</span><span class="n">sourceIndex</span><span class="p">];</span>
<span class="linenos">456</span><span class="w">			</span><span class="p">}</span>
<span class="linenos">457</span><span class="w">		</span><span class="p">}</span>
<span class="linenos">458</span><span class="w">	</span><span class="p">}</span>
<span class="linenos">459</span><span class="p">}</span>
<span class="linenos">460</span>
<span class="linenos">461</span><span class="kt">void</span><span class="w"> </span><span class="n">ByteLattice</span><span class="o">::</span><span class="n">copySitesNativeToRowMajorByte</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">destBuffer</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">sourceBuffer</span><span class="p">,</span><span class="w"> </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">xSize</span><span class="p">,</span><span class="w"> </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">ySize</span><span class="p">,</span><span class="w"> </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">zSize</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">bufferSize</span><span class="p">)</span>
<span class="linenos">462</span><span class="p">{</span>
<span class="linenos">463</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">bufferSize</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">xSize</span><span class="o">*</span><span class="n">ySize</span><span class="o">*</span><span class="n">zSize</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="n">lm</span><span class="o">::</span><span class="n">InvalidArgException</span><span class="p">(</span><span class="s">&quot;bufferSize&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;the buffer size was not equal to the lattice data size&quot;</span><span class="p">);</span>
<span class="linenos">464</span>
<span class="linenos">465</span><span class="w">    </span><span class="c1">// Cast the buffers as appropriate.</span>
<span class="linenos">466</span><span class="w">    </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">destSites</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">destBuffer</span><span class="p">;</span>
<span class="linenos">467</span><span class="w">    </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">sourceSites</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">sourceBuffer</span><span class="p">;</span>
<span class="linenos">468</span>
<span class="linenos">469</span>
<span class="linenos">470</span><span class="w">    </span><span class="c1">// Walk through the dest buffer and copy into it sites.</span>
<span class="linenos">471</span><span class="w">    </span><span class="n">uint</span><span class="w"> </span><span class="n">sourceIndex</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">472</span><span class="w">	</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">z</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">z</span><span class="o">&lt;</span><span class="n">zSize</span><span class="p">;</span><span class="w"> </span><span class="n">z</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">473</span><span class="w">	</span><span class="p">{</span>
<span class="linenos">474</span><span class="w">		</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">y</span><span class="o">&lt;</span><span class="n">ySize</span><span class="p">;</span><span class="w"> </span><span class="n">y</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">475</span><span class="w">		</span><span class="p">{</span>
<span class="linenos">476</span><span class="w">			</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">x</span><span class="o">&lt;</span><span class="n">xSize</span><span class="p">;</span><span class="w"> </span><span class="n">x</span><span class="o">++</span><span class="p">,</span><span class="w"> </span><span class="n">sourceIndex</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">477</span><span class="w">			</span><span class="p">{</span>
<span class="linenos">478</span><span class="w">				</span><span class="n">uint</span><span class="w"> </span><span class="n">destIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="o">*</span><span class="n">ySize</span><span class="o">*</span><span class="n">zSize</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">y</span><span class="o">*</span><span class="n">zSize</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">z</span><span class="p">;</span>
<span class="linenos">479</span><span class="w">				</span><span class="n">destSites</span><span class="p">[</span><span class="n">destIndex</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sourceSites</span><span class="p">[</span><span class="n">sourceIndex</span><span class="p">];</span>
<span class="linenos">480</span><span class="w">			</span><span class="p">}</span>
<span class="linenos">481</span><span class="w">		</span><span class="p">}</span>
<span class="linenos">482</span><span class="w">	</span><span class="p">}</span>
<span class="linenos">483</span><span class="p">}</span>
<span class="linenos">484</span>
<span class="linenos">485</span><span class="kt">void</span><span class="w"> </span><span class="n">ByteLattice</span><span class="o">::</span><span class="n">setFromRowMajorByteData</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">buffer</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">bufferSize</span><span class="p">)</span>
<span class="linenos">486</span><span class="p">{</span>
<span class="linenos">487</span><span class="w">    </span><span class="n">copyRowMajorByteToNative</span><span class="p">(</span><span class="n">particles</span><span class="p">,</span><span class="w"> </span><span class="n">buffer</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">.</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">.</span><span class="n">z</span><span class="p">,</span><span class="w"> </span><span class="n">wordsPerSite</span><span class="o">*</span><span class="n">PARTICLES_PER_WORD</span><span class="p">,</span><span class="w"> </span><span class="n">bufferSize</span><span class="p">);</span>
<span class="linenos">488</span><span class="p">}</span>
<span class="linenos">489</span>
<span class="linenos">490</span><span class="kt">void</span><span class="w"> </span><span class="n">ByteLattice</span><span class="o">::</span><span class="n">setSitesFromRowMajorByteData</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">buffer</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">bufferSize</span><span class="p">)</span>
<span class="linenos">491</span><span class="p">{</span>
<span class="linenos">492</span><span class="w">    </span><span class="n">copySitesRowMajorByteToNative</span><span class="p">(</span><span class="n">siteTypes</span><span class="p">,</span><span class="w"> </span><span class="n">buffer</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">.</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">.</span><span class="n">z</span><span class="p">,</span><span class="w"> </span><span class="n">bufferSize</span><span class="p">);</span>
<span class="linenos">493</span><span class="p">}</span>
<span class="linenos">494</span>
<span class="linenos">495</span><span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">particle_t</span><span class="p">,</span><span class="n">uint</span><span class="o">&gt;</span><span class="w"> </span><span class="n">ByteLattice</span><span class="o">::</span><span class="n">getParticleCounts</span><span class="p">()</span>
<span class="linenos">496</span><span class="p">{</span>
<span class="linenos">497</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">particle_t</span><span class="p">,</span><span class="n">uint</span><span class="o">&gt;</span><span class="w"> </span><span class="n">particleCountMap</span><span class="p">;</span>
<span class="linenos">498</span><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">index</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">index</span><span class="o">&lt;</span><span class="n">numberSites</span><span class="o">*</span><span class="n">wordsPerSite</span><span class="p">;</span><span class="w"> </span><span class="n">index</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">499</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">500</span><span class="w">        </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">byteParticles</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">particles</span><span class="p">[</span><span class="n">index</span><span class="p">]);</span>
<span class="linenos">501</span><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">b</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">b</span><span class="o">&lt;</span><span class="n">PARTICLES_PER_WORD</span><span class="p">;</span><span class="w"> </span><span class="n">b</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">502</span><span class="w">        </span><span class="p">{</span>
<span class="linenos">503</span><span class="w">            </span><span class="c1">// Count the particle.</span>
<span class="linenos">504</span><span class="w">            </span><span class="n">particle_t</span><span class="w"> </span><span class="n">particle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">byteParticles</span><span class="p">[</span><span class="n">b</span><span class="p">];</span>
<span class="linenos">505</span><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">particle</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">506</span><span class="w">            </span><span class="p">{</span>
<span class="linenos">507</span><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">particleCountMap</span><span class="p">.</span><span class="n">count</span><span class="p">(</span><span class="n">particle</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">508</span><span class="w">                    </span><span class="n">particleCountMap</span><span class="p">[</span><span class="n">particle</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="linenos">509</span><span class="w">                </span><span class="k">else</span>
<span class="linenos">510</span><span class="w">                    </span><span class="n">particleCountMap</span><span class="p">[</span><span class="n">particle</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
<span class="linenos">511</span><span class="w">            </span><span class="p">}</span>
<span class="linenos">512</span><span class="w">            </span><span class="c1">// Otherwise, if the particle position is empty, move to the next site.</span>
<span class="linenos">513</span><span class="w">            </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">particle</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">514</span><span class="w">            </span><span class="p">{</span>
<span class="linenos">515</span><span class="w">                </span><span class="k">break</span><span class="p">;</span>
<span class="linenos">516</span><span class="w">            </span><span class="p">}</span>
<span class="linenos">517</span><span class="w">        </span><span class="p">}</span>
<span class="linenos">518</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">519</span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">particleCountMap</span><span class="p">;</span>
<span class="linenos">520</span><span class="p">}</span>
<span class="linenos">521</span>
<span class="linenos">522</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">particle_loc_t</span><span class="o">&gt;</span><span class="w"> </span><span class="n">ByteLattice</span><span class="o">::</span><span class="n">findParticles</span><span class="p">(</span><span class="n">particle_t</span><span class="w"> </span><span class="n">minParticleType</span><span class="p">,</span><span class="w"> </span><span class="n">particle_t</span><span class="w"> </span><span class="n">maxParticleType</span><span class="p">)</span>
<span class="linenos">523</span><span class="p">{</span>
<span class="linenos">524</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">particle_loc_t</span><span class="o">&gt;</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>
<span class="linenos">525</span>
<span class="linenos">526</span>
<span class="linenos">527</span><span class="w">    </span><span class="c1">// Walk through the lattice.</span>
<span class="linenos">528</span><span class="w">    </span><span class="n">uint</span><span class="w"> </span><span class="n">index</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">529</span><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">w</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">w</span><span class="o">&lt;</span><span class="n">wordsPerSite</span><span class="p">;</span><span class="w"> </span><span class="n">w</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">530</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">531</span><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">z</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">z</span><span class="o">&lt;</span><span class="n">size</span><span class="p">.</span><span class="n">z</span><span class="p">;</span><span class="w"> </span><span class="n">z</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">532</span><span class="w">        </span><span class="p">{</span>
<span class="linenos">533</span><span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">y</span><span class="o">&lt;</span><span class="n">size</span><span class="p">.</span><span class="n">y</span><span class="p">;</span><span class="w"> </span><span class="n">y</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">534</span><span class="w">            </span><span class="p">{</span>
<span class="linenos">535</span><span class="w">                </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">x</span><span class="o">&lt;</span><span class="n">size</span><span class="p">.</span><span class="n">x</span><span class="p">;</span><span class="w"> </span><span class="n">x</span><span class="o">++</span><span class="p">,</span><span class="w"> </span><span class="n">index</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">536</span><span class="w">                </span><span class="p">{</span>
<span class="linenos">537</span><span class="w">                    </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">byteParticles</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">particles</span><span class="p">[</span><span class="n">index</span><span class="p">]);</span>
<span class="linenos">538</span><span class="w">                    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">b</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">b</span><span class="o">&lt;</span><span class="n">PARTICLES_PER_WORD</span><span class="p">;</span><span class="w"> </span><span class="n">b</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">539</span><span class="w">                    </span><span class="p">{</span>
<span class="linenos">540</span><span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">byteParticles</span><span class="p">[</span><span class="n">b</span><span class="p">]</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">minParticleType</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">byteParticles</span><span class="p">[</span><span class="n">b</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">maxParticleType</span><span class="p">)</span>
<span class="linenos">541</span><span class="w">                            </span><span class="n">ret</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">particle_loc_t</span><span class="p">(</span><span class="n">byteParticles</span><span class="p">[</span><span class="n">b</span><span class="p">],</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">z</span><span class="p">,</span><span class="w"> </span><span class="n">w</span><span class="o">*</span><span class="n">PARTICLES_PER_WORD</span><span class="o">+</span><span class="n">b</span><span class="p">));</span>
<span class="linenos">542</span><span class="w">                    </span><span class="p">}</span>
<span class="linenos">543</span><span class="w">                </span><span class="p">}</span>
<span class="linenos">544</span><span class="w">            </span><span class="p">}</span>
<span class="linenos">545</span><span class="w">        </span><span class="p">}</span>
<span class="linenos">546</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">547</span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>
<span class="linenos">548</span><span class="p">}</span>
<span class="linenos">549</span>
<span class="linenos">550</span><span class="kt">uint32_t</span><span class="w"> </span><span class="o">*</span><span class="n">ByteLattice</span><span class="o">::</span><span class="n">getParticlesMemory</span><span class="p">()</span>
<span class="linenos">551</span><span class="p">{</span>
<span class="linenos">552</span><span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="n">particles</span><span class="p">;</span>
<span class="linenos">553</span><span class="p">}</span>
<span class="linenos">554</span>
<span class="linenos">555</span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="n">ByteLattice</span><span class="o">::</span><span class="n">getSitesMemory</span><span class="p">()</span>
<span class="linenos">556</span><span class="p">{</span>
<span class="linenos">557</span><span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="n">siteTypes</span><span class="p">;</span>
<span class="linenos">558</span><span class="p">}</span>
<span class="linenos">559</span>
<span class="linenos">560</span><span class="cm">/*</span>
<span class="linenos">561</span><span class="cm">bool ByteLattice::findParticle(lattice_particle_t particleToFind, lattice_size_t* x, lattice_size_t* y, lattice_size_t* z, uint* particleIndex)</span>
<span class="linenos">562</span><span class="cm">{</span>
<span class="linenos">563</span><span class="cm">	if (x == NULL || y == NULL || z == NULL || particleIndex == NULL)</span>
<span class="linenos">564</span><span class="cm">		throw InvalidArgException(&quot;location pointer was NULL&quot;);</span>
<span class="linenos">565</span>
<span class="linenos">566</span><span class="cm">	lattice_size_t xySize = xSize*ySize;</span>
<span class="linenos">567</span><span class="cm">	lattice_size_t numberSites = getNumberSites();</span>
<span class="linenos">568</span><span class="cm">	for (lattice_size_t latticeIndex = 0; latticeIndex&lt;numberSites; latticeIndex++)</span>
<span class="linenos">569</span><span class="cm">		for (uint i=0, shift=0; i&lt;maxParticlesPerSite; i++, shift+=bitsPerParticle)</span>
<span class="linenos">570</span><span class="cm">		{</span>
<span class="linenos">571</span><span class="cm">			// See if this is the particle we are looking for.</span>
<span class="linenos">572</span><span class="cm">			lattice_particle_t particle = (lattice[latticeIndex]&amp;(particleMask&lt;&lt;shift))&gt;&gt;shift;</span>
<span class="linenos">573</span><span class="cm">			if (particle == particleToFind)</span>
<span class="linenos">574</span><span class="cm">			{</span>
<span class="linenos">575</span><span class="cm">				*x = latticeIndex%xSize;</span>
<span class="linenos">576</span><span class="cm">				*y = (latticeIndex/xSize)%ySize;</span>
<span class="linenos">577</span><span class="cm">				*z = latticeIndex/xySize;</span>
<span class="linenos">578</span><span class="cm">				*particleIndex = i;</span>
<span class="linenos">579</span><span class="cm">				return true;</span>
<span class="linenos">580</span><span class="cm">			}</span>
<span class="linenos">581</span><span class="cm">			</span>
<span class="linenos">582</span><span class="cm">			// Otherwise, if the partiucle position is empty, move to the next site.</span>
<span class="linenos">583</span><span class="cm">			else if (particle == 0)</span>
<span class="linenos">584</span><span class="cm">			{</span>
<span class="linenos">585</span><span class="cm">				break;</span>
<span class="linenos">586</span><span class="cm">			}</span>
<span class="linenos">587</span><span class="cm">		}</span>
<span class="linenos">588</span><span class="cm">	return false;</span>
<span class="linenos">589</span><span class="cm">}</span>
<span class="linenos">590</span>
<span class="linenos">591</span>
<span class="linenos">592</span><span class="cm">bool ByteLattice::findNextParticle(lattice_particle_t particleToFind, lattice_size_t* x, lattice_size_t* y, lattice_size_t* z, uint* particleIndex)</span>
<span class="linenos">593</span><span class="cm">{</span>
<span class="linenos">594</span><span class="cm">	if (x == NULL || y == NULL || z == NULL || particleIndex == NULL)</span>
<span class="linenos">595</span><span class="cm">		throw InvalidArgException(&quot;location pointer was NULL&quot;);</span>
<span class="linenos">596</span>
<span class="linenos">597</span><span class="cm">	lattice_size_t xySize = xSize*ySize;</span>
<span class="linenos">598</span><span class="cm">	lattice_size_t numberSites = getNumberSites();</span>
<span class="linenos">599</span><span class="cm">	uint firstParticleToCheck = (*particleIndex)+1;</span>
<span class="linenos">600</span><span class="cm">	uint firstParticleToCheckShift = firstParticleToCheck*bitsPerParticle;</span>
<span class="linenos">601</span><span class="cm">	for (lattice_size_t latticeIndex=*x+(*y*xSize)+(*z*xSize*ySize); latticeIndex&lt;numberSites; latticeIndex++,firstParticleToCheck=0,firstParticleToCheckShift=0)</span>
<span class="linenos">602</span><span class="cm">		for (uint i=firstParticleToCheck, shift=firstParticleToCheckShift; i&lt;maxParticlesPerSite; i++, shift+=bitsPerParticle)</span>
<span class="linenos">603</span><span class="cm">		{</span>
<span class="linenos">604</span><span class="cm">			// See if this is the particle we are looking for.</span>
<span class="linenos">605</span><span class="cm">			lattice_particle_t particle = (lattice[latticeIndex]&amp;(particleMask&lt;&lt;shift))&gt;&gt;shift;</span>
<span class="linenos">606</span><span class="cm">			if (particle == particleToFind)</span>
<span class="linenos">607</span><span class="cm">			{</span>
<span class="linenos">608</span><span class="cm">				*x = latticeIndex%xSize;</span>
<span class="linenos">609</span><span class="cm">				*y = (latticeIndex/xSize)%ySize;</span>
<span class="linenos">610</span><span class="cm">				*z = latticeIndex/xySize;</span>
<span class="linenos">611</span><span class="cm">				*particleIndex = i;</span>
<span class="linenos">612</span><span class="cm">				return true;</span>
<span class="linenos">613</span><span class="cm">			}</span>
<span class="linenos">614</span><span class="cm">			</span>
<span class="linenos">615</span><span class="cm">			// Otherwise, if the particle position is empty, move to the next site.</span>
<span class="linenos">616</span><span class="cm">			else if (particle == 0)</span>
<span class="linenos">617</span><span class="cm">			{</span>
<span class="linenos">618</span><span class="cm">				break;</span>
<span class="linenos">619</span><span class="cm">			}</span>
<span class="linenos">620</span><span class="cm">		}</span>
<span class="linenos">621</span><span class="cm">	return false;</span>
<span class="linenos">622</span><span class="cm">}</span>
<span class="linenos">623</span>
<span class="linenos">624</span><span class="cm">bool ByteLattice::findNearbyParticle(lattice_particle_t particleToFind, lattice_size_t xi, lattice_size_t yi, lattice_size_t zi, lattice_size_t* xo, lattice_size_t* yo, lattice_size_t* zo, uint* particleIndex)</span>
<span class="linenos">625</span><span class="cm">{</span>
<span class="linenos">626</span><span class="cm">	// Make sure the arguments are valid.</span>
<span class="linenos">627</span><span class="cm">	if (xo == NULL || yo == NULL || zo == NULL || particleIndex == NULL)</span>
<span class="linenos">628</span><span class="cm">		throw InvalidArgException(&quot;Output location pointer was NULL.&quot;);</span>
<span class="linenos">629</span><span class="cm">	if (xi &gt;= xSize || yi &gt;= ySize || zi &gt;= zSize)</span>
<span class="linenos">630</span><span class="cm">		throw InvalidSiteException(xi,yi,zi);</span>
<span class="linenos">631</span><span class="cm">	</span>
<span class="linenos">632</span><span class="cm">	// Search for the particle in ever increasing concentric boxes around the initial site.</span>
<span class="linenos">633</span><span class="cm">	for (intv d=0; d&lt;=(intv)(xSize/2) || d&lt;=(intv)(ySize/2) || d&lt;=(intv)(zSize/2); d++)</span>
<span class="linenos">634</span><span class="cm">	{</span>
<span class="linenos">635</span><span class="cm">		//std::cout &lt;&lt; &quot;Depth: &quot; &lt;&lt; d &lt;&lt; &quot;\n&quot;;</span>
<span class="linenos">636</span><span class="cm">		</span>
<span class="linenos">637</span><span class="cm">		// Go through each z plane.</span>
<span class="linenos">638</span><span class="cm">		for (intv z=(intv)zi-d; z&lt;=(intv)zi+d; z++)</span>
<span class="linenos">639</span><span class="cm">		{</span>
<span class="linenos">640</span><span class="cm">			// Figure out the lattice z index.</span>
<span class="linenos">641</span><span class="cm">			lattice_size_t zl = (lattice_size_t)(z&lt;0)?(z+(intv)zSize):((z&gt;=(intv)zSize)?(z-(intv)zSize):z);</span>
<span class="linenos">642</span><span class="cm">			</span>
<span class="linenos">643</span><span class="cm">			//std::cout &lt;&lt; &quot;Z: &quot; &lt;&lt; z &lt;&lt; &quot;,&quot; &lt;&lt; zl &lt;&lt; &quot;\n&quot;;</span>
<span class="linenos">644</span><span class="cm">			</span>
<span class="linenos">645</span><span class="cm">			// Go through each y row.</span>
<span class="linenos">646</span><span class="cm">			for (intv y=(intv)yi-d; y&lt;=(intv)yi+d; y++)</span>
<span class="linenos">647</span><span class="cm">			{</span>
<span class="linenos">648</span><span class="cm">				// Figure out the lattice y index.</span>
<span class="linenos">649</span><span class="cm">				lattice_size_t yl = (lattice_size_t)(y&lt;0)?(y+(intv)ySize):((y&gt;=(intv)ySize)?(y-(intv)ySize):y);</span>
<span class="linenos">650</span><span class="cm">				lattice_size_t latticeIndex = (yl*zSize)+(zl*xSize*ySize);</span>
<span class="linenos">651</span><span class="cm">				</span>
<span class="linenos">652</span><span class="cm">				// Go through each x column.</span>
<span class="linenos">653</span><span class="cm">				int searchFullRow = (z==((intv)zi-d)||z==((intv)zi+d)||y==((intv)yi-d)||y==((intv)yi+d));</span>
<span class="linenos">654</span><span class="cm">				for (intv x=(intv)xi-d; x&lt;=(intv)xi+d; x+=(searchFullRow?(1):(2*d)))</span>
<span class="linenos">655</span><span class="cm">				{</span>
<span class="linenos">656</span><span class="cm">					// Figure out the lattice x index.</span>
<span class="linenos">657</span><span class="cm">					lattice_size_t xl = (lattice_size_t)(x&lt;0)?(x+(intv)xSize):((x&gt;=(intv)xSize)?(x-(intv)xSize):x);</span>
<span class="linenos">658</span><span class="cm">					</span>
<span class="linenos">659</span><span class="cm">					// Go through each particle at the site.</span>
<span class="linenos">660</span><span class="cm">					for (uint i=0, shift=0; i&lt;maxParticlesPerSite; i++, shift+=bitsPerParticle)</span>
<span class="linenos">661</span><span class="cm">					{</span>
<span class="linenos">662</span><span class="cm">						// See if this is the particle we are looking for.</span>
<span class="linenos">663</span><span class="cm">						lattice_particle_t particle = (lattice[latticeIndex+xl]&amp;(particleMask&lt;&lt;shift))&gt;&gt;shift;</span>
<span class="linenos">664</span><span class="cm">						if (particle == particleToFind)</span>
<span class="linenos">665</span><span class="cm">						{</span>
<span class="linenos">666</span><span class="cm">							*xo = xl;</span>
<span class="linenos">667</span><span class="cm">							*yo = yl;</span>
<span class="linenos">668</span><span class="cm">							*zo = zl;</span>
<span class="linenos">669</span><span class="cm">							*particleIndex = i;</span>
<span class="linenos">670</span><span class="cm">							return true;</span>
<span class="linenos">671</span><span class="cm">						}</span>
<span class="linenos">672</span><span class="cm">						</span>
<span class="linenos">673</span><span class="cm">						// Otherwise, if the particle position is empty, move to the next site.</span>
<span class="linenos">674</span><span class="cm">						else if (particle == 0)</span>
<span class="linenos">675</span><span class="cm">						{</span>
<span class="linenos">676</span><span class="cm">							break;</span>
<span class="linenos">677</span><span class="cm">						}</span>
<span class="linenos">678</span><span class="cm">					}</span>
<span class="linenos">679</span><span class="cm">				}</span>
<span class="linenos">680</span><span class="cm">			}</span>
<span class="linenos">681</span><span class="cm">		}</span>
<span class="linenos">682</span><span class="cm">	}</span>
<span class="linenos">683</span><span class="cm">	return false;</span>
<span class="linenos">684</span><span class="cm">}</span>
<span class="linenos">685</span>
<span class="linenos">686</span><span class="cm">*/</span>
<span class="linenos">687</span>
<span class="linenos">688</span><span class="p">}</span>
<span class="linenos">689</span><span class="p">}</span>
<span class="linenos">690</span>
<span class="linenos">691</span><span class="cm">/*</span>
<span class="linenos">692</span><span class="cm"> * 		// Go through each z plane.</span>
<span class="linenos">693</span><span class="cm">		for (uintv z=(d&lt;=zi)?(zi-d):0; z&lt;=((d&lt;zSize-zi)?(zi+d):(zSize-1)); z++)</span>
<span class="linenos">694</span><span class="cm">		{</span>
<span class="linenos">695</span><span class="cm">			// Go through each y row.</span>
<span class="linenos">696</span><span class="cm">			for (uintv y=(d&lt;=yi)?(yi-d):0; y&lt;=((d&lt;ySize-yi)?(yi+d):(ySize-1)); y++)</span>
<span class="linenos">697</span><span class="cm">			{</span>
<span class="linenos">698</span><span class="cm">				// Figure out the starting index of this row.</span>
<span class="linenos">699</span><span class="cm">				lattice_size_t latticeIndex = (y*zSize)+(z*xSize*ySize);</span>
<span class="linenos">700</span><span class="cm">				</span>
<span class="linenos">701</span><span class="cm">				// Go through each x column.</span>
<span class="linenos">702</span><span class="cm">				int searchFullRow = (z==(zi-d)||z==(zi+d)||y==(yi-d)||y==(yi+d));</span>
<span class="linenos">703</span><span class="cm">				for (uintv x=((d&lt;=xi)?(xi-d):(searchFullRow?(0):(xi+d))); x&lt;=((d&lt;xSize-xi)?(xi+d):(xSize-1)); x+=(searchFullRow?(1):(2*d)))</span>
<span class="linenos">704</span><span class="cm">				{</span>
<span class="linenos">705</span><span class="cm">					// Go through each particle at the site.</span>
<span class="linenos">706</span><span class="cm">					for (uint i=0, shift=0; i&lt;maxParticlesPerSite; i++, shift+=bitsPerParticle)</span>
<span class="linenos">707</span><span class="cm">					{</span>
<span class="linenos">708</span><span class="cm">						// See if this is the particle we are looking for.</span>
<span class="linenos">709</span><span class="cm">						lattice_particle_t particle = (lattice[latticeIndex+x]&amp;(particleMask&lt;&lt;shift))&gt;&gt;shift;</span>
<span class="linenos">710</span><span class="cm">						if (particle == particleToFind)</span>
<span class="linenos">711</span><span class="cm">						{</span>
<span class="linenos">712</span><span class="cm">							*xo = x;</span>
<span class="linenos">713</span><span class="cm">							*yo = y;</span>
<span class="linenos">714</span><span class="cm">							*zo = z;</span>
<span class="linenos">715</span><span class="cm">							*particleIndex = i;</span>
<span class="linenos">716</span><span class="cm">							return true;</span>
<span class="linenos">717</span><span class="cm">						}</span>
<span class="linenos">718</span><span class="cm">						</span>
<span class="linenos">719</span><span class="cm">						// Otherwise, if the particle position is empty, move to the next site.</span>
<span class="linenos">720</span><span class="cm">						else if (particle == 0)</span>
<span class="linenos">721</span><span class="cm">						{</span>
<span class="linenos">722</span><span class="cm">							break;</span>
<span class="linenos">723</span><span class="cm">						}</span>
<span class="linenos">724</span><span class="cm">					}</span>
<span class="linenos">725</span><span class="cm">				}</span>
<span class="linenos">726</span><span class="cm">			}</span>
<span class="linenos">727</span><span class="cm">		}</span>
<span class="linenos">728</span><span class="cm"> */</span>
</pre></div>
</div>
</section>
<section id="cudabytelattice-h">
<h3>CudaByteLattice.h<a class="headerlink" href="#cudabytelattice-h" title="Link to this heading">#</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cm">/*</span>
<span class="linenos"> 2</span><span class="cm"> * University of Illinois Open Source License</span>
<span class="linenos"> 3</span><span class="cm"> * Copyright 2008-2018 Luthey-Schulten Group,</span>
<span class="linenos"> 4</span><span class="cm"> * All rights reserved.</span>
<span class="linenos"> 5</span><span class="cm"> * </span>
<span class="linenos"> 6</span><span class="cm"> * Developed by: Luthey-Schulten Group</span>
<span class="linenos"> 7</span><span class="cm"> * 			     University of Illinois at Urbana-Champaign</span>
<span class="linenos"> 8</span><span class="cm"> * 			     http://www.scs.uiuc.edu/~schulten</span>
<span class="linenos"> 9</span><span class="cm"> * </span>
<span class="linenos">10</span><span class="cm"> * Permission is hereby granted, free of charge, to any person obtaining a copy of</span>
<span class="linenos">11</span><span class="cm"> * this software and associated documentation files (the Software), to deal with </span>
<span class="linenos">12</span><span class="cm"> * the Software without restriction, including without limitation the rights to </span>
<span class="linenos">13</span><span class="cm"> * use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies </span>
<span class="linenos">14</span><span class="cm"> * of the Software, and to permit persons to whom the Software is furnished to </span>
<span class="linenos">15</span><span class="cm"> * do so, subject to the following conditions:</span>
<span class="linenos">16</span><span class="cm"> * </span>
<span class="linenos">17</span><span class="cm"> * - Redistributions of source code must retain the above copyright notice, </span>
<span class="linenos">18</span><span class="cm"> * this list of conditions and the following disclaimers.</span>
<span class="linenos">19</span><span class="cm"> * </span>
<span class="linenos">20</span><span class="cm"> * - Redistributions in binary form must reproduce the above copyright notice, </span>
<span class="linenos">21</span><span class="cm"> * this list of conditions and the following disclaimers in the documentation </span>
<span class="linenos">22</span><span class="cm"> * and/or other materials provided with the distribution.</span>
<span class="linenos">23</span><span class="cm"> * </span>
<span class="linenos">24</span><span class="cm"> * - Neither the names of the Luthey-Schulten Group, University of Illinois at</span>
<span class="linenos">25</span><span class="cm"> * Urbana-Champaign, nor the names of its contributors may be used to endorse or</span>
<span class="linenos">26</span><span class="cm"> * promote products derived from this Software without specific prior written</span>
<span class="linenos">27</span><span class="cm"> * permission.</span>
<span class="linenos">28</span><span class="cm"> * </span>
<span class="linenos">29</span><span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR </span>
<span class="linenos">30</span><span class="cm"> * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, </span>
<span class="linenos">31</span><span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL </span>
<span class="linenos">32</span><span class="cm"> * THE CONTRIBUTORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR </span>
<span class="linenos">33</span><span class="cm"> * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, </span>
<span class="linenos">34</span><span class="cm"> * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR </span>
<span class="linenos">35</span><span class="cm"> * OTHER DEALINGS WITH THE SOFTWARE.</span>
<span class="linenos">36</span><span class="cm"> *</span>
<span class="linenos">37</span><span class="cm"> * Author(s): Elijah Roberts</span>
<span class="linenos">38</span><span class="cm"> */</span>
<span class="linenos">39</span>
<span class="linenos">40</span><span class="cp">#ifndef LM_RDME_CUDABYTELATTICE_H_</span>
<span class="linenos">41</span><span class="cp">#define LM_RDME_CUDABYTELATTICE_H_</span>
<span class="linenos">42</span>
<span class="linenos">43</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;vector&gt;</span>
<span class="linenos">44</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;map&gt;</span>
<span class="linenos">45</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;core/Exceptions.h&quot;</span>
<span class="linenos">46</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;cuda/lm_cuda.h&quot;</span>
<span class="linenos">47</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;rdme/ByteLattice.h&quot;</span>
<span class="linenos">48</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;rdme/Lattice.h&quot;</span>
<span class="linenos">49</span>
<span class="linenos">50</span><span class="k">namespace</span><span class="w"> </span><span class="nn">lm</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">51</span><span class="k">namespace</span><span class="w"> </span><span class="nn">rdme</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">52</span>
<span class="linenos">53</span><span class="k">class</span><span class="w"> </span><span class="nc">CudaByteLattice</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">ByteLattice</span>
<span class="linenos">54</span><span class="p">{</span>
<span class="linenos">55</span><span class="k">public</span><span class="o">:</span>
<span class="linenos">56</span><span class="w">    </span><span class="n">CudaByteLattice</span><span class="p">(</span><span class="n">lattice_coord_t</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">si_dist_t</span><span class="w"> </span><span class="n">spacing</span><span class="p">,</span><span class="w"> </span><span class="n">uint</span><span class="w"> </span><span class="n">particlesPerSite</span><span class="p">);</span>
<span class="linenos">57</span><span class="w">    </span><span class="n">CudaByteLattice</span><span class="p">(</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">xSize</span><span class="p">,</span><span class="w"> </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">ySize</span><span class="p">,</span><span class="w"> </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">zSize</span><span class="p">,</span><span class="w"> </span><span class="n">si_dist_t</span><span class="w"> </span><span class="n">spacing</span><span class="p">,</span><span class="w"> </span><span class="n">uint</span><span class="w"> </span><span class="n">particlesPerSite</span><span class="p">);</span>
<span class="linenos">58</span><span class="w">	</span><span class="k">virtual</span><span class="w"> </span><span class="o">~</span><span class="n">CudaByteLattice</span><span class="p">();</span>
<span class="linenos">59</span><span class="w">	</span>
<span class="linenos">60</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">copyToGPU</span><span class="p">();</span>
<span class="linenos">61</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">copyFromGPU</span><span class="p">();</span>
<span class="linenos">62</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">getGPUMemorySrc</span><span class="p">();</span>
<span class="linenos">63</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">getGPUMemoryDest</span><span class="p">();</span>
<span class="linenos">64</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">swapSrcDest</span><span class="p">();</span>
<span class="linenos">65</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">getGPUMemorySiteTypes</span><span class="p">();</span>
<span class="linenos">66</span><span class="w">	</span><span class="k">virtual</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="nf">getParticleMemorySize</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span><span class="k">return</span><span class="w"> </span><span class="n">cudaParticlesSize</span><span class="p">;}</span>
<span class="linenos">67</span>
<span class="linenos">68</span><span class="w">	</span><span class="c1">// Override methods that can cause the GPU memory to become stale.</span>
<span class="linenos">69</span><span class="w">	</span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setSiteType</span><span class="p">(</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">z</span><span class="p">,</span><span class="w"> </span><span class="n">site_t</span><span class="w"> </span><span class="n">site</span><span class="p">);</span>
<span class="linenos">70</span><span class="w">	</span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setSiteType</span><span class="p">(</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">index</span><span class="p">,</span><span class="w"> </span><span class="n">site_t</span><span class="w"> </span><span class="n">site</span><span class="p">);</span>
<span class="linenos">71</span><span class="w">	</span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">addParticle</span><span class="p">(</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">z</span><span class="p">,</span><span class="w"> </span><span class="n">particle_t</span><span class="w"> </span><span class="n">particle</span><span class="p">);</span>
<span class="linenos">72</span><span class="w">	</span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">addParticle</span><span class="p">(</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">index</span><span class="p">,</span><span class="w"> </span><span class="n">particle_t</span><span class="w"> </span><span class="n">particle</span><span class="p">);</span>
<span class="linenos">73</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">removeParticles</span><span class="p">(</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">z</span><span class="p">);</span>
<span class="linenos">74</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">removeParticles</span><span class="p">(</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">index</span><span class="p">);</span>
<span class="linenos">75</span><span class="w">	</span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">removeAllParticles</span><span class="p">();</span>
<span class="linenos">76</span>
<span class="linenos">77</span><span class="w">    </span><span class="c1">// Methods to set the data directly.</span>
<span class="linenos">78</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setFromRowMajorByteData</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">buffer</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">bufferSize</span><span class="p">);</span>
<span class="linenos">79</span>
<span class="linenos">80</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">getSiteLatticeView</span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">**</span><span class="n">siteLattice</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">Nz</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">Ny</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">Nx</span><span class="p">);</span>
<span class="linenos">81</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">getParticleLatticeView</span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">**</span><span class="n">particleLattice</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">Nw</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">Nz</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">Ny</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">Nx</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">Np</span><span class="p">);</span>
<span class="linenos">82</span><span class="w">	</span>
<span class="linenos">83</span><span class="k">protected</span><span class="o">:</span>
<span class="linenos">84</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">allocateCudaMemory</span><span class="p">();</span>
<span class="linenos">85</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">deallocateCudaMemory</span><span class="p">();</span>
<span class="linenos">86</span><span class="w">	</span>
<span class="linenos">87</span><span class="k">protected</span><span class="o">:</span>
<span class="linenos">88</span><span class="w">    </span><span class="n">uint</span><span class="w"> </span><span class="n">cudaParticlesCurrent</span><span class="p">;</span>
<span class="linenos">89</span><span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">cudaParticlesSize</span><span class="p">;</span>
<span class="linenos">90</span><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">cudaParticles</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<span class="linenos">91</span><span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">cudaSiteTypesSize</span><span class="p">;</span>
<span class="linenos">92</span><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">cudaSiteTypes</span><span class="p">;</span>
<span class="linenos">93</span><span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">isGPUMemorySynched</span><span class="p">;</span>
<span class="linenos">94</span><span class="p">};</span>
<span class="linenos">95</span>
<span class="linenos">96</span><span class="p">}</span>
<span class="linenos">97</span><span class="p">}</span>
<span class="linenos">98</span>
<span class="linenos">99</span><span class="cp">#endif</span>
</pre></div>
</div>
</section>
<section id="cudabytelattice-cu">
<h3>CudaByteLattice.cu<a class="headerlink" href="#cudabytelattice-cu" title="Link to this heading">#</a></h3>
<div class="highlight-cuda notranslate"><div class="highlight"><pre><span></span><span class="linenos">  1</span><span class="cm">/*</span>
<span class="linenos">  2</span><span class="cm"> * University of Illinois Open Source License</span>
<span class="linenos">  3</span><span class="cm"> * Copyright 2008-2018 Luthey-Schulten Group,</span>
<span class="linenos">  4</span><span class="cm"> * All rights reserved.</span>
<span class="linenos">  5</span><span class="cm"> * </span>
<span class="linenos">  6</span><span class="cm"> * Developed by: Luthey-Schulten Group</span>
<span class="linenos">  7</span><span class="cm"> * 			     University of Illinois at Urbana-Champaign</span>
<span class="linenos">  8</span><span class="cm"> * 			     http://www.scs.uiuc.edu/~schulten</span>
<span class="linenos">  9</span><span class="cm"> * </span>
<span class="linenos"> 10</span><span class="cm"> * Permission is hereby granted, free of charge, to any person obtaining a copy of</span>
<span class="linenos"> 11</span><span class="cm"> * this software and associated documentation files (the Software), to deal with </span>
<span class="linenos"> 12</span><span class="cm"> * the Software without restriction, including without limitation the rights to </span>
<span class="linenos"> 13</span><span class="cm"> * use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies </span>
<span class="linenos"> 14</span><span class="cm"> * of the Software, and to permit persons to whom the Software is furnished to </span>
<span class="linenos"> 15</span><span class="cm"> * do so, subject to the following conditions:</span>
<span class="linenos"> 16</span><span class="cm"> * </span>
<span class="linenos"> 17</span><span class="cm"> * - Redistributions of source code must retain the above copyright notice, </span>
<span class="linenos"> 18</span><span class="cm"> * this list of conditions and the following disclaimers.</span>
<span class="linenos"> 19</span><span class="cm"> * </span>
<span class="linenos"> 20</span><span class="cm"> * - Redistributions in binary form must reproduce the above copyright notice, </span>
<span class="linenos"> 21</span><span class="cm"> * this list of conditions and the following disclaimers in the documentation </span>
<span class="linenos"> 22</span><span class="cm"> * and/or other materials provided with the distribution.</span>
<span class="linenos"> 23</span><span class="cm"> * </span>
<span class="linenos"> 24</span><span class="cm"> * - Neither the names of the Luthey-Schulten Group, University of Illinois at</span>
<span class="linenos"> 25</span><span class="cm"> * Urbana-Champaign, nor the names of its contributors may be used to endorse or</span>
<span class="linenos"> 26</span><span class="cm"> * promote products derived from this Software without specific prior written</span>
<span class="linenos"> 27</span><span class="cm"> * permission.</span>
<span class="linenos"> 28</span><span class="cm"> * </span>
<span class="linenos"> 29</span><span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR </span>
<span class="linenos"> 30</span><span class="cm"> * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, </span>
<span class="linenos"> 31</span><span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL </span>
<span class="linenos"> 32</span><span class="cm"> * THE CONTRIBUTORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR </span>
<span class="linenos"> 33</span><span class="cm"> * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, </span>
<span class="linenos"> 34</span><span class="cm"> * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR </span>
<span class="linenos"> 35</span><span class="cm"> * OTHER DEALINGS WITH THE SOFTWARE.</span>
<span class="linenos"> 36</span><span class="cm"> *</span>
<span class="linenos"> 37</span><span class="cm"> * Author(s): Elijah Roberts</span>
<span class="linenos"> 38</span><span class="cm"> */</span>
<span class="linenos"> 39</span>
<span class="linenos"> 40</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;config.h&quot;</span>
<span class="linenos"> 41</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;core/Types.h&quot;</span>
<span class="linenos"> 42</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;core/Exceptions.h&quot;</span>
<span class="linenos"> 43</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;rdme/ByteLattice.h&quot;</span>
<span class="linenos"> 44</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;rdme/CudaByteLattice.h&quot;</span>
<span class="linenos"> 45</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;rdme/Lattice.h&quot;</span>
<span class="linenos"> 46</span>
<span class="linenos"> 47</span><span class="n">namespace</span><span class="w"> </span><span class="n">lm</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 48</span><span class="n">namespace</span><span class="w"> </span><span class="n">rdme</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 49</span>
<span class="linenos"> 50</span><span class="n">CudaByteLattice</span><span class="o">::</span><span class="n">CudaByteLattice</span><span class="p">(</span><span class="n">lattice_coord_t</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">si_dist_t</span><span class="w"> </span><span class="n">latticeSpacing</span><span class="p">,</span><span class="w"> </span><span class="n">uint</span><span class="w"> </span><span class="n">particlesPerSite</span><span class="p">)</span>
<span class="linenos"> 51</span><span class="o">:</span><span class="n">ByteLattice</span><span class="p">(</span><span class="n">size</span><span class="p">,</span><span class="n">latticeSpacing</span><span class="p">,</span><span class="n">particlesPerSite</span><span class="p">),</span><span class="n">cudaParticlesCurrent</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="n">cudaParticlesSize</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="n">cudaSiteTypesSize</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="n">cudaSiteTypes</span><span class="p">(</span><span class="nb">NULL</span><span class="p">),</span><span class="n">isGPUMemorySynched</span><span class="p">(</span><span class="nb">false</span><span class="p">)</span>
<span class="linenos"> 52</span><span class="p">{</span>
<span class="linenos"> 53</span><span class="w">    </span><span class="c1">// Initialize the pointers.</span>
<span class="linenos"> 54</span><span class="w">    </span><span class="n">cudaParticles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="linenos"> 55</span><span class="w">    </span><span class="n">cudaParticles</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="linenos"> 56</span>
<span class="linenos"> 57</span><span class="w">    </span><span class="n">allocateCudaMemory</span><span class="p">();</span>
<span class="linenos"> 58</span><span class="p">}</span>
<span class="linenos"> 59</span>
<span class="linenos"> 60</span><span class="n">CudaByteLattice</span><span class="o">::</span><span class="n">CudaByteLattice</span><span class="p">(</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">xSize</span><span class="p">,</span><span class="w"> </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">ySize</span><span class="p">,</span><span class="w"> </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">zSize</span><span class="p">,</span><span class="w"> </span><span class="n">si_dist_t</span><span class="w"> </span><span class="n">latticeSpacing</span><span class="p">,</span><span class="w"> </span><span class="n">uint</span><span class="w"> </span><span class="n">particlesPerSite</span><span class="p">)</span>
<span class="linenos"> 61</span><span class="o">:</span><span class="n">ByteLattice</span><span class="p">(</span><span class="n">xSize</span><span class="p">,</span><span class="n">ySize</span><span class="p">,</span><span class="n">zSize</span><span class="p">,</span><span class="n">latticeSpacing</span><span class="p">,</span><span class="n">particlesPerSite</span><span class="p">),</span><span class="n">cudaParticlesCurrent</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="n">cudaParticlesSize</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="n">cudaSiteTypesSize</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="n">cudaSiteTypes</span><span class="p">(</span><span class="nb">NULL</span><span class="p">),</span><span class="n">isGPUMemorySynched</span><span class="p">(</span><span class="nb">false</span><span class="p">)</span>
<span class="linenos"> 62</span><span class="p">{</span>
<span class="linenos"> 63</span><span class="w">    </span><span class="c1">// Initialize the pointers.</span>
<span class="linenos"> 64</span><span class="w">    </span><span class="n">cudaParticles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="linenos"> 65</span><span class="w">    </span><span class="n">cudaParticles</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="linenos"> 66</span>
<span class="linenos"> 67</span><span class="w">    </span><span class="n">allocateCudaMemory</span><span class="p">();</span>
<span class="linenos"> 68</span><span class="p">}</span>
<span class="linenos"> 69</span>
<span class="linenos"> 70</span><span class="n">CudaByteLattice</span><span class="o">::~</span><span class="n">CudaByteLattice</span><span class="p">()</span>
<span class="linenos"> 71</span><span class="p">{</span>
<span class="linenos"> 72</span><span class="w">    </span><span class="n">deallocateCudaMemory</span><span class="p">();</span>
<span class="linenos"> 73</span><span class="p">}</span>
<span class="linenos"> 74</span>
<span class="linenos"> 75</span><span class="kt">void</span><span class="w"> </span><span class="n">CudaByteLattice</span><span class="o">::</span><span class="n">allocateCudaMemory</span><span class="p">()</span>
<span class="linenos"> 76</span><span class="p">{</span>
<span class="linenos"> 77</span><span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">free</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">total</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<span class="linenos"> 78</span>
<span class="linenos"> 79</span><span class="w">    </span><span class="c1">// Allocate memory on the CUDA device.</span>
<span class="linenos"> 80</span><span class="w">    </span><span class="n">cudaParticlesSize</span><span class="o">=</span><span class="n">numberSites</span><span class="o">*</span><span class="n">wordsPerSite</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">);</span>
<span class="linenos"> 81</span><span class="w">	</span><span class="n">try</span>
<span class="linenos"> 82</span><span class="w">	</span><span class="p">{</span>
<span class="linenos"> 83</span><span class="w">		</span><span class="n">CUDA_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">cudaMalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cudaParticles</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">cudaParticlesSize</span><span class="p">));</span><span class="w"> </span><span class="c1">//TODO: track memory usage.</span>
<span class="linenos"> 84</span><span class="w">		</span><span class="n">CUDA_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">cudaMalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cudaParticles</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">cudaParticlesSize</span><span class="p">));</span><span class="w"> </span><span class="c1">//TODO: track memory usage.</span>
<span class="linenos"> 85</span><span class="w">	</span><span class="p">}</span>
<span class="linenos"> 86</span><span class="w">	</span><span class="n">catch</span><span class="p">(</span><span class="n">CUDAException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span>
<span class="linenos"> 87</span><span class="w">	</span><span class="p">{</span>
<span class="linenos"> 88</span><span class="w">		</span><span class="n">CUDA_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">cudaMemGetInfo</span><span class="p">(</span><span class="o">&amp;</span><span class="n">free</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">total</span><span class="p">));</span>
<span class="linenos"> 89</span><span class="w">		</span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Failed to allocate %zu bytes for particle lattice, %zu available out of %zu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">cudaParticlesSize</span><span class="o">*</span><span class="mi">2U</span><span class="p">,</span><span class="w"> </span><span class="n">free</span><span class="p">,</span><span class="w"> </span><span class="n">total</span><span class="p">);</span>
<span class="linenos"> 90</span><span class="w">		</span><span class="n">throw</span><span class="w"> </span><span class="n">e</span><span class="p">;</span>
<span class="linenos"> 91</span><span class="w">	</span><span class="p">}</span>
<span class="linenos"> 92</span><span class="w">    </span><span class="n">cudaSiteTypesSize</span><span class="o">=</span><span class="n">numberSites</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">uint8_t</span><span class="p">);</span>
<span class="linenos"> 93</span><span class="w">	</span><span class="n">try</span>
<span class="linenos"> 94</span><span class="w">	</span><span class="p">{</span>
<span class="linenos"> 95</span><span class="w">		</span><span class="n">CUDA_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">cudaMalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cudaSiteTypes</span><span class="p">,</span><span class="w"> </span><span class="n">cudaSiteTypesSize</span><span class="p">));</span><span class="w"> </span><span class="c1">//TODO: track memory usage.</span>
<span class="linenos"> 96</span><span class="w">	</span><span class="p">}</span>
<span class="linenos"> 97</span><span class="w">	</span><span class="n">catch</span><span class="p">(</span><span class="n">CUDAException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span>
<span class="linenos"> 98</span><span class="w">	</span><span class="p">{</span>
<span class="linenos"> 99</span><span class="w">		</span><span class="n">CUDA_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">cudaMemGetInfo</span><span class="p">(</span><span class="o">&amp;</span><span class="n">free</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">total</span><span class="p">));</span>
<span class="linenos">100</span><span class="w">		</span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Failed to allocate %zu bytes for site lattice, %zu available out of %zu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">cudaSiteTypesSize</span><span class="p">,</span><span class="w"> </span><span class="n">free</span><span class="p">,</span><span class="w"> </span><span class="n">total</span><span class="p">);</span>
<span class="linenos">101</span><span class="w">		</span><span class="n">throw</span><span class="w"> </span><span class="n">e</span><span class="p">;</span>
<span class="linenos">102</span><span class="w">	</span><span class="p">}</span>
<span class="linenos">103</span><span class="w">	</span>
<span class="linenos">104</span><span class="p">}</span>
<span class="linenos">105</span>
<span class="linenos">106</span><span class="kt">void</span><span class="w"> </span><span class="n">CudaByteLattice</span><span class="o">::</span><span class="n">deallocateCudaMemory</span><span class="p">()</span>
<span class="linenos">107</span><span class="p">{</span>
<span class="linenos">108</span><span class="w">    </span><span class="c1">// If we have any allocated device memory, free it.</span>
<span class="linenos">109</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cudaParticles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span>
<span class="linenos">110</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">111</span><span class="w">        </span><span class="n">CUDA_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">cudaFree</span><span class="p">(</span><span class="n">cudaParticles</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span><span class="w"> </span><span class="c1">//TODO: track memory usage.</span>
<span class="linenos">112</span><span class="w">        </span><span class="n">cudaParticles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="linenos">113</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">114</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cudaParticles</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span>
<span class="linenos">115</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">116</span><span class="w">        </span><span class="n">CUDA_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">cudaFree</span><span class="p">(</span><span class="n">cudaParticles</span><span class="p">[</span><span class="mi">1</span><span class="p">]));</span><span class="w"> </span><span class="c1">//TODO: track memory usage.</span>
<span class="linenos">117</span><span class="w">        </span><span class="n">cudaParticles</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="linenos">118</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">119</span><span class="w">    </span><span class="n">cudaParticlesSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">120</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cudaSiteTypes</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span>
<span class="linenos">121</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">122</span><span class="w">        </span><span class="n">CUDA_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">cudaFree</span><span class="p">(</span><span class="n">cudaSiteTypes</span><span class="p">));</span><span class="w"> </span><span class="c1">//TODO: track memory usage.</span>
<span class="linenos">123</span><span class="w">        </span><span class="n">cudaSiteTypes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="linenos">124</span><span class="w">        </span><span class="n">cudaSiteTypesSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">125</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">126</span><span class="p">}</span>
<span class="linenos">127</span>
<span class="linenos">128</span><span class="kt">void</span><span class="w"> </span><span class="n">CudaByteLattice</span><span class="o">::</span><span class="n">copyToGPU</span><span class="p">()</span>
<span class="linenos">129</span><span class="p">{</span>
<span class="linenos">130</span><span class="w">    </span><span class="n">CUDA_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">cudaMemcpy</span><span class="p">(</span><span class="n">cudaParticles</span><span class="p">[</span><span class="n">cudaParticlesCurrent</span><span class="p">],</span><span class="w"> </span><span class="n">particles</span><span class="p">,</span><span class="w"> </span><span class="n">cudaParticlesSize</span><span class="p">,</span><span class="w"> </span><span class="n">cudaMemcpyHostToDevice</span><span class="p">));</span>
<span class="linenos">131</span><span class="w">    </span><span class="n">CUDA_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">cudaMemcpy</span><span class="p">(</span><span class="n">cudaSiteTypes</span><span class="p">,</span><span class="w"> </span><span class="n">siteTypes</span><span class="p">,</span><span class="w"> </span><span class="n">cudaSiteTypesSize</span><span class="p">,</span><span class="w"> </span><span class="n">cudaMemcpyHostToDevice</span><span class="p">));</span>
<span class="linenos">132</span><span class="w">    </span><span class="n">isGPUMemorySynched</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="linenos">133</span><span class="p">}</span>
<span class="linenos">134</span>
<span class="linenos">135</span><span class="kt">void</span><span class="w"> </span><span class="n">CudaByteLattice</span><span class="o">::</span><span class="n">copyFromGPU</span><span class="p">()</span>
<span class="linenos">136</span><span class="p">{</span>
<span class="linenos">137</span><span class="w">	</span><span class="n">CUDA_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">cudaMemcpy</span><span class="p">(</span><span class="n">particles</span><span class="p">,</span><span class="w"> </span><span class="n">cudaParticles</span><span class="p">[</span><span class="n">cudaParticlesCurrent</span><span class="p">],</span><span class="w"> </span><span class="n">cudaParticlesSize</span><span class="p">,</span><span class="w"> </span><span class="n">cudaMemcpyDeviceToHost</span><span class="p">));</span>
<span class="linenos">138</span><span class="w">    </span><span class="n">CUDA_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">cudaMemcpy</span><span class="p">(</span><span class="n">siteTypes</span><span class="p">,</span><span class="w"> </span><span class="n">cudaSiteTypes</span><span class="p">,</span><span class="w"> </span><span class="n">cudaSiteTypesSize</span><span class="p">,</span><span class="w"> </span><span class="n">cudaMemcpyDeviceToHost</span><span class="p">));</span>
<span class="linenos">139</span><span class="w">	</span><span class="n">isGPUMemorySynched</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="linenos">140</span><span class="p">}</span>
<span class="linenos">141</span>
<span class="linenos">142</span>
<span class="linenos">143</span><span class="kt">void</span><span class="w"> </span><span class="n">CudaByteLattice</span><span class="o">::</span><span class="n">getSiteLatticeView</span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">**</span><span class="n">siteLattice</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">Nz</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">Ny</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">Nx</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">144</span><span class="w">    </span><span class="n">ByteLattice</span><span class="o">::</span><span class="n">getSiteLatticeView</span><span class="p">(</span><span class="n">siteLattice</span><span class="p">,</span><span class="w"> </span><span class="n">Nz</span><span class="p">,</span><span class="w"> </span><span class="n">Ny</span><span class="p">,</span><span class="w"> </span><span class="n">Nx</span><span class="p">);</span>
<span class="linenos">145</span><span class="w">    </span><span class="c1">// isGPUMemorySynched = false;</span>
<span class="linenos">146</span><span class="p">}</span>
<span class="linenos">147</span>
<span class="linenos">148</span><span class="kt">void</span><span class="w"> </span><span class="n">CudaByteLattice</span><span class="o">::</span><span class="n">getParticleLatticeView</span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">**</span><span class="n">particleLattice</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">Nw</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">Nz</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">Ny</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">Nx</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">Np</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">149</span><span class="w">    </span><span class="n">ByteLattice</span><span class="o">::</span><span class="n">getParticleLatticeView</span><span class="p">(</span><span class="n">particleLattice</span><span class="p">,</span><span class="w"> </span><span class="n">Nw</span><span class="p">,</span><span class="w">  </span><span class="n">Nz</span><span class="p">,</span><span class="w"> </span><span class="n">Ny</span><span class="p">,</span><span class="w"> </span><span class="n">Nx</span><span class="p">,</span><span class="w"> </span><span class="n">Np</span><span class="p">);</span>
<span class="linenos">150</span><span class="w">    </span><span class="c1">// isGPUMemorySynched = false;</span>
<span class="linenos">151</span><span class="p">}</span>
<span class="linenos">152</span>
<span class="linenos">153</span>
<span class="linenos">154</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">CudaByteLattice</span><span class="o">::</span><span class="n">getGPUMemorySrc</span><span class="p">()</span>
<span class="linenos">155</span><span class="p">{</span>
<span class="linenos">156</span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">cudaParticles</span><span class="p">[</span><span class="n">cudaParticlesCurrent</span><span class="p">];</span>
<span class="linenos">157</span><span class="p">}</span>
<span class="linenos">158</span>
<span class="linenos">159</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">CudaByteLattice</span><span class="o">::</span><span class="n">getGPUMemoryDest</span><span class="p">()</span>
<span class="linenos">160</span><span class="p">{</span>
<span class="linenos">161</span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">cudaParticles</span><span class="p">[</span><span class="n">cudaParticlesCurrent</span><span class="o">==</span><span class="mi">0</span><span class="o">?</span><span class="mi">1</span><span class="o">:</span><span class="mi">0</span><span class="p">];</span>
<span class="linenos">162</span><span class="p">}</span>
<span class="linenos">163</span>
<span class="linenos">164</span><span class="kt">void</span><span class="w"> </span><span class="n">CudaByteLattice</span><span class="o">::</span><span class="n">swapSrcDest</span><span class="p">()</span>
<span class="linenos">165</span><span class="p">{</span>
<span class="linenos">166</span><span class="w">    </span><span class="n">cudaParticlesCurrent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cudaParticlesCurrent</span><span class="o">==</span><span class="mi">0</span><span class="o">?</span><span class="mi">1</span><span class="o">:</span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">167</span><span class="p">}</span>
<span class="linenos">168</span>
<span class="linenos">169</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">CudaByteLattice</span><span class="o">::</span><span class="n">getGPUMemorySiteTypes</span><span class="p">()</span>
<span class="linenos">170</span><span class="p">{</span>
<span class="linenos">171</span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">cudaSiteTypes</span><span class="p">;</span>
<span class="linenos">172</span><span class="p">}</span>
<span class="linenos">173</span>
<span class="linenos">174</span><span class="kt">void</span><span class="w"> </span><span class="n">CudaByteLattice</span><span class="o">::</span><span class="n">setSiteType</span><span class="p">(</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">z</span><span class="p">,</span><span class="w"> </span><span class="n">site_t</span><span class="w"> </span><span class="n">site</span><span class="p">)</span>
<span class="linenos">175</span><span class="p">{</span>
<span class="linenos">176</span><span class="w">    </span><span class="n">ByteLattice</span><span class="o">::</span><span class="n">setSiteType</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="n">site</span><span class="p">);</span>
<span class="linenos">177</span><span class="w">    </span><span class="n">isGPUMemorySynched</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="linenos">178</span><span class="p">}</span>
<span class="linenos">179</span>
<span class="linenos">180</span><span class="kt">void</span><span class="w"> </span><span class="n">CudaByteLattice</span><span class="o">::</span><span class="n">addParticle</span><span class="p">(</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">z</span><span class="p">,</span><span class="w"> </span><span class="n">particle_t</span><span class="w"> </span><span class="n">particle</span><span class="p">)</span>
<span class="linenos">181</span><span class="p">{</span>
<span class="linenos">182</span><span class="w">    </span><span class="n">ByteLattice</span><span class="o">::</span><span class="n">addParticle</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="n">particle</span><span class="p">);</span>
<span class="linenos">183</span><span class="w">	</span><span class="n">isGPUMemorySynched</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="linenos">184</span><span class="p">}</span>
<span class="linenos">185</span>
<span class="linenos">186</span><span class="kt">void</span><span class="w"> </span><span class="n">CudaByteLattice</span><span class="o">::</span><span class="n">removeParticles</span><span class="p">(</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="linenos">187</span><span class="p">{</span>
<span class="linenos">188</span><span class="w">    </span><span class="n">ByteLattice</span><span class="o">::</span><span class="n">removeParticles</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">);</span>
<span class="linenos">189</span><span class="w">    </span><span class="n">isGPUMemorySynched</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="linenos">190</span><span class="p">}</span>
<span class="linenos">191</span>
<span class="linenos">192</span><span class="kt">void</span><span class="w"> </span><span class="n">CudaByteLattice</span><span class="o">::</span><span class="n">setSiteType</span><span class="p">(</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">index</span><span class="p">,</span><span class="w"> </span><span class="n">site_t</span><span class="w"> </span><span class="n">site</span><span class="p">)</span>
<span class="linenos">193</span><span class="p">{</span>
<span class="linenos">194</span><span class="w">    </span><span class="n">ByteLattice</span><span class="o">::</span><span class="n">setSiteType</span><span class="p">(</span><span class="n">index</span><span class="p">,</span><span class="n">site</span><span class="p">);</span>
<span class="linenos">195</span><span class="w">    </span><span class="n">isGPUMemorySynched</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="linenos">196</span><span class="p">}</span>
<span class="linenos">197</span>
<span class="linenos">198</span><span class="kt">void</span><span class="w"> </span><span class="n">CudaByteLattice</span><span class="o">::</span><span class="n">addParticle</span><span class="p">(</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">index</span><span class="p">,</span><span class="w"> </span><span class="n">particle_t</span><span class="w"> </span><span class="n">particle</span><span class="p">)</span>
<span class="linenos">199</span><span class="p">{</span>
<span class="linenos">200</span><span class="w">    </span><span class="n">ByteLattice</span><span class="o">::</span><span class="n">addParticle</span><span class="p">(</span><span class="n">index</span><span class="p">,</span><span class="n">particle</span><span class="p">);</span>
<span class="linenos">201</span><span class="w">	</span><span class="n">isGPUMemorySynched</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="linenos">202</span><span class="p">}</span>
<span class="linenos">203</span>
<span class="linenos">204</span><span class="kt">void</span><span class="w"> </span><span class="n">CudaByteLattice</span><span class="o">::</span><span class="n">removeParticles</span><span class="p">(</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">index</span><span class="p">)</span>
<span class="linenos">205</span><span class="p">{</span>
<span class="linenos">206</span><span class="w">    </span><span class="n">ByteLattice</span><span class="o">::</span><span class="n">removeParticles</span><span class="p">(</span><span class="n">index</span><span class="p">);</span>
<span class="linenos">207</span><span class="w">    </span><span class="n">isGPUMemorySynched</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="linenos">208</span><span class="p">}</span>
<span class="linenos">209</span>
<span class="linenos">210</span><span class="kt">void</span><span class="w"> </span><span class="n">CudaByteLattice</span><span class="o">::</span><span class="n">removeAllParticles</span><span class="p">()</span>
<span class="linenos">211</span><span class="p">{</span>
<span class="linenos">212</span><span class="w">    </span><span class="n">ByteLattice</span><span class="o">::</span><span class="n">removeAllParticles</span><span class="p">();</span>
<span class="linenos">213</span><span class="w">	</span><span class="n">isGPUMemorySynched</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="linenos">214</span><span class="p">}</span>
<span class="linenos">215</span>
<span class="linenos">216</span><span class="kt">void</span><span class="w"> </span><span class="n">CudaByteLattice</span><span class="o">::</span><span class="n">setFromRowMajorByteData</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">buffer</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">bufferSize</span><span class="p">)</span>
<span class="linenos">217</span><span class="p">{</span>
<span class="linenos">218</span><span class="w">    </span><span class="n">ByteLattice</span><span class="o">::</span><span class="n">setFromRowMajorByteData</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span><span class="w"> </span><span class="n">bufferSize</span><span class="p">);</span>
<span class="linenos">219</span><span class="w">    </span><span class="n">isGPUMemorySynched</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="linenos">220</span><span class="p">}</span>
<span class="linenos">221</span>
<span class="linenos">222</span><span class="p">}</span>
<span class="linenos">223</span><span class="p">}</span>
</pre></div>
</div>
</section>
<section id="cudaintlattice-h">
<h3>CudaIntLattice.h<a class="headerlink" href="#cudaintlattice-h" title="Link to this heading">#</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cm">/*</span>
<span class="linenos"> 2</span><span class="cm"> * University of Illinois Open Source License</span>
<span class="linenos"> 3</span><span class="cm"> * Copyright 2008-2018 Luthey-Schulten Group,</span>
<span class="linenos"> 4</span><span class="cm"> * All rights reserved.</span>
<span class="linenos"> 5</span><span class="cm"> * </span>
<span class="linenos"> 6</span><span class="cm"> * Developed by: Luthey-Schulten Group</span>
<span class="linenos"> 7</span><span class="cm"> * 			     University of Illinois at Urbana-Champaign</span>
<span class="linenos"> 8</span><span class="cm"> * 			     http://www.scs.uiuc.edu/~schulten</span>
<span class="linenos"> 9</span><span class="cm"> * </span>
<span class="linenos">10</span><span class="cm"> * Permission is hereby granted, free of charge, to any person obtaining a copy of</span>
<span class="linenos">11</span><span class="cm"> * this software and associated documentation files (the Software), to deal with </span>
<span class="linenos">12</span><span class="cm"> * the Software without restriction, including without limitation the rights to </span>
<span class="linenos">13</span><span class="cm"> * use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies </span>
<span class="linenos">14</span><span class="cm"> * of the Software, and to permit persons to whom the Software is furnished to </span>
<span class="linenos">15</span><span class="cm"> * do so, subject to the following conditions:</span>
<span class="linenos">16</span><span class="cm"> * </span>
<span class="linenos">17</span><span class="cm"> * - Redistributions of source code must retain the above copyright notice, </span>
<span class="linenos">18</span><span class="cm"> * this list of conditions and the following disclaimers.</span>
<span class="linenos">19</span><span class="cm"> * </span>
<span class="linenos">20</span><span class="cm"> * - Redistributions in binary form must reproduce the above copyright notice, </span>
<span class="linenos">21</span><span class="cm"> * this list of conditions and the following disclaimers in the documentation </span>
<span class="linenos">22</span><span class="cm"> * and/or other materials provided with the distribution.</span>
<span class="linenos">23</span><span class="cm"> * </span>
<span class="linenos">24</span><span class="cm"> * - Neither the names of the Luthey-Schulten Group, University of Illinois at</span>
<span class="linenos">25</span><span class="cm"> * Urbana-Champaign, nor the names of its contributors may be used to endorse or</span>
<span class="linenos">26</span><span class="cm"> * promote products derived from this Software without specific prior written</span>
<span class="linenos">27</span><span class="cm"> * permission.</span>
<span class="linenos">28</span><span class="cm"> * </span>
<span class="linenos">29</span><span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR </span>
<span class="linenos">30</span><span class="cm"> * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, </span>
<span class="linenos">31</span><span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL </span>
<span class="linenos">32</span><span class="cm"> * THE CONTRIBUTORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR </span>
<span class="linenos">33</span><span class="cm"> * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, </span>
<span class="linenos">34</span><span class="cm"> * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR </span>
<span class="linenos">35</span><span class="cm"> * OTHER DEALINGS WITH THE SOFTWARE.</span>
<span class="linenos">36</span><span class="cm"> *</span>
<span class="linenos">37</span><span class="cm"> * Author(s): Elijah Roberts</span>
<span class="linenos">38</span><span class="cm"> */</span>
<span class="linenos">39</span>
<span class="linenos">40</span><span class="cp">#ifndef LM_RDME_CUDAINTLATTICE_H_</span>
<span class="linenos">41</span><span class="cp">#define LM_RDME_CUDAINTLATTICE_H_</span>
<span class="linenos">42</span>
<span class="linenos">43</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;vector&gt;</span>
<span class="linenos">44</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;map&gt;</span>
<span class="linenos">45</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;core/Exceptions.h&quot;</span>
<span class="linenos">46</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;cuda/lm_cuda.h&quot;</span>
<span class="linenos">47</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;rdme/IntLattice.h&quot;</span>
<span class="linenos">48</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;rdme/Lattice.h&quot;</span>
<span class="linenos">49</span>
<span class="linenos">50</span><span class="k">namespace</span><span class="w"> </span><span class="nn">lm</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">51</span><span class="k">namespace</span><span class="w"> </span><span class="nn">rdme</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">52</span>
<span class="linenos">53</span><span class="k">class</span><span class="w"> </span><span class="nc">CudaIntLattice</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">IntLattice</span>
<span class="linenos">54</span><span class="p">{</span>
<span class="linenos">55</span><span class="k">public</span><span class="o">:</span>
<span class="linenos">56</span><span class="w">    </span><span class="n">CudaIntLattice</span><span class="p">(</span><span class="n">lattice_coord_t</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">si_dist_t</span><span class="w"> </span><span class="n">spacing</span><span class="p">,</span><span class="w"> </span><span class="n">uint</span><span class="w"> </span><span class="n">particlesPerSite</span><span class="p">);</span>
<span class="linenos">57</span><span class="w">    </span><span class="n">CudaIntLattice</span><span class="p">(</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">xSize</span><span class="p">,</span><span class="w"> </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">ySize</span><span class="p">,</span><span class="w"> </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">zSize</span><span class="p">,</span><span class="w"> </span><span class="n">si_dist_t</span><span class="w"> </span><span class="n">spacing</span><span class="p">,</span><span class="w"> </span><span class="n">uint</span><span class="w"> </span><span class="n">particlesPerSite</span><span class="p">);</span>
<span class="linenos">58</span><span class="w">	</span><span class="k">virtual</span><span class="w"> </span><span class="o">~</span><span class="n">CudaIntLattice</span><span class="p">();</span>
<span class="linenos">59</span><span class="w">	</span>
<span class="linenos">60</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">copyToGPU</span><span class="p">();</span>
<span class="linenos">61</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">copyFromGPU</span><span class="p">();</span>
<span class="linenos">62</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">getGPUMemorySrc</span><span class="p">();</span>
<span class="linenos">63</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">getGPUMemoryDest</span><span class="p">();</span>
<span class="linenos">64</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">swapSrcDest</span><span class="p">();</span>
<span class="linenos">65</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">getGPUMemorySiteTypes</span><span class="p">();</span>
<span class="linenos">66</span>
<span class="linenos">67</span><span class="w">	</span><span class="c1">// Override methods that can cause the GPU memory to become stale.</span>
<span class="linenos">68</span><span class="w">	</span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setSiteType</span><span class="p">(</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">z</span><span class="p">,</span><span class="w"> </span><span class="n">site_t</span><span class="w"> </span><span class="n">site</span><span class="p">);</span>
<span class="linenos">69</span><span class="w">	</span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setSiteType</span><span class="p">(</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">index</span><span class="p">,</span><span class="w"> </span><span class="n">site_t</span><span class="w"> </span><span class="n">site</span><span class="p">);</span>
<span class="linenos">70</span><span class="w">	</span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">addParticle</span><span class="p">(</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">z</span><span class="p">,</span><span class="w"> </span><span class="n">particle_t</span><span class="w"> </span><span class="n">particle</span><span class="p">);</span>
<span class="linenos">71</span><span class="w">	</span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">addParticle</span><span class="p">(</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">index</span><span class="p">,</span><span class="w"> </span><span class="n">particle_t</span><span class="w"> </span><span class="n">particle</span><span class="p">);</span>
<span class="linenos">72</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">removeParticles</span><span class="p">(</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">z</span><span class="p">);</span>
<span class="linenos">73</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">removeParticles</span><span class="p">(</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">index</span><span class="p">);</span>
<span class="linenos">74</span><span class="w">	</span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">removeAllParticles</span><span class="p">();</span>
<span class="linenos">75</span>
<span class="linenos">76</span><span class="w">    </span><span class="c1">// Methods to set the data directly.</span>
<span class="linenos">77</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setFromRowMajorByteData</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">buffer</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">bufferSize</span><span class="p">);</span>
<span class="linenos">78</span><span class="w">	</span>
<span class="linenos">79</span><span class="k">protected</span><span class="o">:</span>
<span class="linenos">80</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">allocateCudaMemory</span><span class="p">();</span>
<span class="linenos">81</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">deallocateCudaMemory</span><span class="p">();</span>
<span class="linenos">82</span><span class="w">	</span>
<span class="linenos">83</span><span class="k">protected</span><span class="o">:</span>
<span class="linenos">84</span><span class="w">    </span><span class="n">uint</span><span class="w"> </span><span class="n">cudaParticlesCurrent</span><span class="p">;</span>
<span class="linenos">85</span><span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">cudaParticlesSize</span><span class="p">;</span>
<span class="linenos">86</span><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">cudaParticles</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<span class="linenos">87</span><span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">cudaSiteTypesSize</span><span class="p">;</span>
<span class="linenos">88</span><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">cudaSiteTypes</span><span class="p">;</span>
<span class="linenos">89</span><span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">isGPUMemorySynched</span><span class="p">;</span>
<span class="linenos">90</span><span class="p">};</span>
<span class="linenos">91</span>
<span class="linenos">92</span><span class="p">}</span>
<span class="linenos">93</span><span class="p">}</span>
<span class="linenos">94</span>
<span class="linenos">95</span><span class="cp">#endif</span>
</pre></div>
</div>
</section>
<section id="cudaintlattice-cu">
<h3>CudaIntLattice.cu<a class="headerlink" href="#cudaintlattice-cu" title="Link to this heading">#</a></h3>
<div class="highlight-cuda notranslate"><div class="highlight"><pre><span></span><span class="linenos">  1</span><span class="cm">/*</span>
<span class="linenos">  2</span><span class="cm"> * University of Illinois Open Source License</span>
<span class="linenos">  3</span><span class="cm"> * Copyright 2008-2018 Luthey-Schulten Group,</span>
<span class="linenos">  4</span><span class="cm"> * All rights reserved.</span>
<span class="linenos">  5</span><span class="cm"> * </span>
<span class="linenos">  6</span><span class="cm"> * Developed by: Luthey-Schulten Group</span>
<span class="linenos">  7</span><span class="cm"> * 			     University of Illinois at Urbana-Champaign</span>
<span class="linenos">  8</span><span class="cm"> * 			     http://www.scs.uiuc.edu/~schulten</span>
<span class="linenos">  9</span><span class="cm"> * </span>
<span class="linenos"> 10</span><span class="cm"> * Permission is hereby granted, free of charge, to any person obtaining a copy of</span>
<span class="linenos"> 11</span><span class="cm"> * this software and associated documentation files (the Software), to deal with </span>
<span class="linenos"> 12</span><span class="cm"> * the Software without restriction, including without limitation the rights to </span>
<span class="linenos"> 13</span><span class="cm"> * use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies </span>
<span class="linenos"> 14</span><span class="cm"> * of the Software, and to permit persons to whom the Software is furnished to </span>
<span class="linenos"> 15</span><span class="cm"> * do so, subject to the following conditions:</span>
<span class="linenos"> 16</span><span class="cm"> * </span>
<span class="linenos"> 17</span><span class="cm"> * - Redistributions of source code must retain the above copyright notice, </span>
<span class="linenos"> 18</span><span class="cm"> * this list of conditions and the following disclaimers.</span>
<span class="linenos"> 19</span><span class="cm"> * </span>
<span class="linenos"> 20</span><span class="cm"> * - Redistributions in binary form must reproduce the above copyright notice, </span>
<span class="linenos"> 21</span><span class="cm"> * this list of conditions and the following disclaimers in the documentation </span>
<span class="linenos"> 22</span><span class="cm"> * and/or other materials provided with the distribution.</span>
<span class="linenos"> 23</span><span class="cm"> * </span>
<span class="linenos"> 24</span><span class="cm"> * - Neither the names of the Luthey-Schulten Group, University of Illinois at</span>
<span class="linenos"> 25</span><span class="cm"> * Urbana-Champaign, nor the names of its contributors may be used to endorse or</span>
<span class="linenos"> 26</span><span class="cm"> * promote products derived from this Software without specific prior written</span>
<span class="linenos"> 27</span><span class="cm"> * permission.</span>
<span class="linenos"> 28</span><span class="cm"> * </span>
<span class="linenos"> 29</span><span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR </span>
<span class="linenos"> 30</span><span class="cm"> * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, </span>
<span class="linenos"> 31</span><span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL </span>
<span class="linenos"> 32</span><span class="cm"> * THE CONTRIBUTORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR </span>
<span class="linenos"> 33</span><span class="cm"> * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, </span>
<span class="linenos"> 34</span><span class="cm"> * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR </span>
<span class="linenos"> 35</span><span class="cm"> * OTHER DEALINGS WITH THE SOFTWARE.</span>
<span class="linenos"> 36</span><span class="cm"> *</span>
<span class="linenos"> 37</span><span class="cm"> * Author(s): Elijah Roberts</span>
<span class="linenos"> 38</span><span class="cm"> */</span>
<span class="linenos"> 39</span>
<span class="linenos"> 40</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;config.h&quot;</span>
<span class="linenos"> 41</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;core/Types.h&quot;</span>
<span class="linenos"> 42</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;core/Exceptions.h&quot;</span>
<span class="linenos"> 43</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;rdme/CudaIntLattice.h&quot;</span>
<span class="linenos"> 44</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;rdme/Lattice.h&quot;</span>
<span class="linenos"> 45</span>
<span class="linenos"> 46</span><span class="n">namespace</span><span class="w"> </span><span class="n">lm</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 47</span><span class="n">namespace</span><span class="w"> </span><span class="n">rdme</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 48</span>
<span class="linenos"> 49</span><span class="n">CudaIntLattice</span><span class="o">::</span><span class="n">CudaIntLattice</span><span class="p">(</span><span class="n">lattice_coord_t</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">si_dist_t</span><span class="w"> </span><span class="n">latticeSpacing</span><span class="p">,</span><span class="w"> </span><span class="n">uint</span><span class="w"> </span><span class="n">particlesPerSite</span><span class="p">)</span>
<span class="linenos"> 50</span><span class="o">:</span><span class="n">IntLattice</span><span class="p">(</span><span class="n">size</span><span class="p">,</span><span class="n">latticeSpacing</span><span class="p">,</span><span class="n">particlesPerSite</span><span class="p">),</span><span class="n">cudaParticlesCurrent</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="n">cudaParticlesSize</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="n">cudaSiteTypesSize</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="n">cudaSiteTypes</span><span class="p">(</span><span class="nb">NULL</span><span class="p">),</span><span class="n">isGPUMemorySynched</span><span class="p">(</span><span class="nb">false</span><span class="p">)</span>
<span class="linenos"> 51</span><span class="p">{</span>
<span class="linenos"> 52</span><span class="w">    </span><span class="c1">// Initialize the pointers.</span>
<span class="linenos"> 53</span><span class="w">    </span><span class="n">cudaParticles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="linenos"> 54</span><span class="w">    </span><span class="n">cudaParticles</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="linenos"> 55</span>
<span class="linenos"> 56</span><span class="w">    </span><span class="c1">// Make sure the lattice dimensions are divisible by 32.</span>
<span class="linenos"> 57</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">size</span><span class="p">.</span><span class="n">x</span><span class="o">%</span><span class="mi">32</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">size</span><span class="p">.</span><span class="n">y</span><span class="o">%</span><span class="mi">32</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">size</span><span class="p">.</span><span class="n">z</span><span class="o">%</span><span class="mi">32</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="n">throw</span><span class="w"> </span><span class="n">InvalidArgException</span><span class="p">(</span><span class="s">&quot;size&quot;</span><span class="p">,</span><span class="s">&quot;each dimension of a CUDA lattice must be divisible by 32&quot;</span><span class="p">);</span>
<span class="linenos"> 58</span><span class="w">    </span><span class="n">allocateCudaMemory</span><span class="p">();</span>
<span class="linenos"> 59</span><span class="p">}</span>
<span class="linenos"> 60</span>
<span class="linenos"> 61</span><span class="n">CudaIntLattice</span><span class="o">::</span><span class="n">CudaIntLattice</span><span class="p">(</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">xSize</span><span class="p">,</span><span class="w"> </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">ySize</span><span class="p">,</span><span class="w"> </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">zSize</span><span class="p">,</span><span class="w"> </span><span class="n">si_dist_t</span><span class="w"> </span><span class="n">latticeSpacing</span><span class="p">,</span><span class="w"> </span><span class="n">uint</span><span class="w"> </span><span class="n">particlesPerSite</span><span class="p">)</span>
<span class="linenos"> 62</span><span class="o">:</span><span class="n">IntLattice</span><span class="p">(</span><span class="n">xSize</span><span class="p">,</span><span class="n">ySize</span><span class="p">,</span><span class="n">zSize</span><span class="p">,</span><span class="n">latticeSpacing</span><span class="p">,</span><span class="n">particlesPerSite</span><span class="p">),</span><span class="n">cudaParticlesCurrent</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="n">cudaParticlesSize</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="n">cudaSiteTypesSize</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="n">cudaSiteTypes</span><span class="p">(</span><span class="nb">NULL</span><span class="p">),</span><span class="n">isGPUMemorySynched</span><span class="p">(</span><span class="nb">false</span><span class="p">)</span>
<span class="linenos"> 63</span><span class="p">{</span>
<span class="linenos"> 64</span><span class="w">    </span><span class="c1">// Initialize the pointers.</span>
<span class="linenos"> 65</span><span class="w">    </span><span class="n">cudaParticles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="linenos"> 66</span><span class="w">    </span><span class="n">cudaParticles</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="linenos"> 67</span>
<span class="linenos"> 68</span><span class="w">    </span><span class="c1">// Make sure the lattice dimensions are divisible by 32.</span>
<span class="linenos"> 69</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">size</span><span class="p">.</span><span class="n">x</span><span class="o">%</span><span class="mi">32</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">size</span><span class="p">.</span><span class="n">y</span><span class="o">%</span><span class="mi">32</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">size</span><span class="p">.</span><span class="n">z</span><span class="o">%</span><span class="mi">32</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="n">throw</span><span class="w"> </span><span class="n">InvalidArgException</span><span class="p">(</span><span class="s">&quot;size&quot;</span><span class="p">,</span><span class="s">&quot;each dimension of a CUDA lattice must be divisible by 32&quot;</span><span class="p">);</span>
<span class="linenos"> 70</span><span class="w">    </span><span class="n">allocateCudaMemory</span><span class="p">();</span>
<span class="linenos"> 71</span><span class="p">}</span>
<span class="linenos"> 72</span>
<span class="linenos"> 73</span><span class="n">CudaIntLattice</span><span class="o">::~</span><span class="n">CudaIntLattice</span><span class="p">()</span>
<span class="linenos"> 74</span><span class="p">{</span>
<span class="linenos"> 75</span><span class="w">    </span><span class="n">deallocateCudaMemory</span><span class="p">();</span>
<span class="linenos"> 76</span><span class="p">}</span>
<span class="linenos"> 77</span>
<span class="linenos"> 78</span><span class="kt">void</span><span class="w"> </span><span class="n">CudaIntLattice</span><span class="o">::</span><span class="n">allocateCudaMemory</span><span class="p">()</span>
<span class="linenos"> 79</span><span class="p">{</span>
<span class="linenos"> 80</span><span class="w">    </span><span class="c1">// Allocate memory on the CUDA device.</span>
<span class="linenos"> 81</span><span class="w">    </span><span class="n">cudaParticlesSize</span><span class="o">=</span><span class="n">numberSites</span><span class="o">*</span><span class="n">wordsPerSite</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">);</span>
<span class="linenos"> 82</span><span class="w">    </span><span class="n">CUDA_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">cudaMalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cudaParticles</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">cudaParticlesSize</span><span class="p">));</span><span class="w"> </span><span class="c1">//TODO: track memory usage.</span>
<span class="linenos"> 83</span><span class="w">    </span><span class="n">CUDA_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">cudaMalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cudaParticles</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">cudaParticlesSize</span><span class="p">));</span><span class="w"> </span><span class="c1">//TODO: track memory usage.</span>
<span class="linenos"> 84</span><span class="w">    </span><span class="n">cudaSiteTypesSize</span><span class="o">=</span><span class="n">numberSites</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">uint8_t</span><span class="p">);</span>
<span class="linenos"> 85</span><span class="w">    </span><span class="n">CUDA_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">cudaMalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cudaSiteTypes</span><span class="p">,</span><span class="w"> </span><span class="n">cudaSiteTypesSize</span><span class="p">));</span><span class="w"> </span><span class="c1">//TODO: track memory usage.</span>
<span class="linenos"> 86</span><span class="p">}</span>
<span class="linenos"> 87</span>
<span class="linenos"> 88</span><span class="kt">void</span><span class="w"> </span><span class="n">CudaIntLattice</span><span class="o">::</span><span class="n">deallocateCudaMemory</span><span class="p">()</span>
<span class="linenos"> 89</span><span class="p">{</span>
<span class="linenos"> 90</span><span class="w">    </span><span class="c1">// If we have any allocated device memory, free it.</span>
<span class="linenos"> 91</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cudaParticles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span>
<span class="linenos"> 92</span><span class="w">    </span><span class="p">{</span>
<span class="linenos"> 93</span><span class="w">        </span><span class="n">CUDA_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">cudaFree</span><span class="p">(</span><span class="n">cudaParticles</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span><span class="w"> </span><span class="c1">//TODO: track memory usage.</span>
<span class="linenos"> 94</span><span class="w">        </span><span class="n">cudaParticles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="linenos"> 95</span><span class="w">    </span><span class="p">}</span>
<span class="linenos"> 96</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cudaParticles</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span>
<span class="linenos"> 97</span><span class="w">    </span><span class="p">{</span>
<span class="linenos"> 98</span><span class="w">        </span><span class="n">CUDA_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">cudaFree</span><span class="p">(</span><span class="n">cudaParticles</span><span class="p">[</span><span class="mi">1</span><span class="p">]));</span><span class="w"> </span><span class="c1">//TODO: track memory usage.</span>
<span class="linenos"> 99</span><span class="w">        </span><span class="n">cudaParticles</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="linenos">100</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">101</span><span class="w">    </span><span class="n">cudaParticlesSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">102</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cudaSiteTypes</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span>
<span class="linenos">103</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">104</span><span class="w">        </span><span class="n">CUDA_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">cudaFree</span><span class="p">(</span><span class="n">cudaSiteTypes</span><span class="p">));</span><span class="w"> </span><span class="c1">//TODO: track memory usage.</span>
<span class="linenos">105</span><span class="w">        </span><span class="n">cudaSiteTypes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="linenos">106</span><span class="w">        </span><span class="n">cudaSiteTypesSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">107</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">108</span><span class="p">}</span>
<span class="linenos">109</span>
<span class="linenos">110</span><span class="kt">void</span><span class="w"> </span><span class="n">CudaIntLattice</span><span class="o">::</span><span class="n">copyToGPU</span><span class="p">()</span>
<span class="linenos">111</span><span class="p">{</span>
<span class="linenos">112</span><span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">isGPUMemorySynched</span><span class="p">)</span>
<span class="linenos">113</span><span class="w">	</span><span class="p">{</span>
<span class="linenos">114</span><span class="w">		</span><span class="n">CUDA_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">cudaMemcpy</span><span class="p">(</span><span class="n">cudaParticles</span><span class="p">[</span><span class="n">cudaParticlesCurrent</span><span class="p">],</span><span class="w"> </span><span class="n">particles</span><span class="p">,</span><span class="w"> </span><span class="n">cudaParticlesSize</span><span class="p">,</span><span class="w"> </span><span class="n">cudaMemcpyHostToDevice</span><span class="p">));</span>
<span class="linenos">115</span><span class="w">        </span><span class="n">CUDA_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">cudaMemcpy</span><span class="p">(</span><span class="n">cudaSiteTypes</span><span class="p">,</span><span class="w"> </span><span class="n">siteTypes</span><span class="p">,</span><span class="w"> </span><span class="n">cudaSiteTypesSize</span><span class="p">,</span><span class="w"> </span><span class="n">cudaMemcpyHostToDevice</span><span class="p">));</span>
<span class="linenos">116</span><span class="w">		</span><span class="n">isGPUMemorySynched</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="linenos">117</span><span class="w">	</span><span class="p">}</span>
<span class="linenos">118</span><span class="p">}</span>
<span class="linenos">119</span>
<span class="linenos">120</span><span class="kt">void</span><span class="w"> </span><span class="n">CudaIntLattice</span><span class="o">::</span><span class="n">copyFromGPU</span><span class="p">()</span>
<span class="linenos">121</span><span class="p">{</span>
<span class="linenos">122</span><span class="w">	</span><span class="n">CUDA_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">cudaMemcpy</span><span class="p">(</span><span class="n">particles</span><span class="p">,</span><span class="w"> </span><span class="n">cudaParticles</span><span class="p">[</span><span class="n">cudaParticlesCurrent</span><span class="p">],</span><span class="w"> </span><span class="n">cudaParticlesSize</span><span class="p">,</span><span class="w"> </span><span class="n">cudaMemcpyDeviceToHost</span><span class="p">));</span>
<span class="linenos">123</span><span class="w">    </span><span class="n">CUDA_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">cudaMemcpy</span><span class="p">(</span><span class="n">siteTypes</span><span class="p">,</span><span class="w"> </span><span class="n">cudaSiteTypes</span><span class="p">,</span><span class="w"> </span><span class="n">cudaSiteTypesSize</span><span class="p">,</span><span class="w"> </span><span class="n">cudaMemcpyDeviceToHost</span><span class="p">));</span>
<span class="linenos">124</span><span class="w">	</span><span class="n">isGPUMemorySynched</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="linenos">125</span><span class="p">}</span>
<span class="linenos">126</span>
<span class="linenos">127</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">CudaIntLattice</span><span class="o">::</span><span class="n">getGPUMemorySrc</span><span class="p">()</span>
<span class="linenos">128</span><span class="p">{</span>
<span class="linenos">129</span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">cudaParticles</span><span class="p">[</span><span class="n">cudaParticlesCurrent</span><span class="p">];</span>
<span class="linenos">130</span><span class="p">}</span>
<span class="linenos">131</span>
<span class="linenos">132</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">CudaIntLattice</span><span class="o">::</span><span class="n">getGPUMemoryDest</span><span class="p">()</span>
<span class="linenos">133</span><span class="p">{</span>
<span class="linenos">134</span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">cudaParticles</span><span class="p">[</span><span class="n">cudaParticlesCurrent</span><span class="o">==</span><span class="mi">0</span><span class="o">?</span><span class="mi">1</span><span class="o">:</span><span class="mi">0</span><span class="p">];</span>
<span class="linenos">135</span><span class="p">}</span>
<span class="linenos">136</span>
<span class="linenos">137</span><span class="kt">void</span><span class="w"> </span><span class="n">CudaIntLattice</span><span class="o">::</span><span class="n">swapSrcDest</span><span class="p">()</span>
<span class="linenos">138</span><span class="p">{</span>
<span class="linenos">139</span><span class="w">    </span><span class="n">cudaParticlesCurrent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cudaParticlesCurrent</span><span class="o">==</span><span class="mi">0</span><span class="o">?</span><span class="mi">1</span><span class="o">:</span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">140</span><span class="p">}</span>
<span class="linenos">141</span>
<span class="linenos">142</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">CudaIntLattice</span><span class="o">::</span><span class="n">getGPUMemorySiteTypes</span><span class="p">()</span>
<span class="linenos">143</span><span class="p">{</span>
<span class="linenos">144</span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">cudaSiteTypes</span><span class="p">;</span>
<span class="linenos">145</span><span class="p">}</span>
<span class="linenos">146</span>
<span class="linenos">147</span><span class="kt">void</span><span class="w"> </span><span class="n">CudaIntLattice</span><span class="o">::</span><span class="n">setSiteType</span><span class="p">(</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">z</span><span class="p">,</span><span class="w"> </span><span class="n">site_t</span><span class="w"> </span><span class="n">site</span><span class="p">)</span><span class="w"> </span>
<span class="linenos">148</span><span class="p">{</span>
<span class="linenos">149</span><span class="w">    </span><span class="n">IntLattice</span><span class="o">::</span><span class="n">setSiteType</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="n">site</span><span class="p">);</span>
<span class="linenos">150</span><span class="w">    </span><span class="n">isGPUMemorySynched</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="linenos">151</span><span class="p">}</span>
<span class="linenos">152</span>
<span class="linenos">153</span><span class="kt">void</span><span class="w"> </span><span class="n">CudaIntLattice</span><span class="o">::</span><span class="n">addParticle</span><span class="p">(</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">z</span><span class="p">,</span><span class="w"> </span><span class="n">particle_t</span><span class="w"> </span><span class="n">particle</span><span class="p">)</span><span class="w"> </span>
<span class="linenos">154</span><span class="p">{</span>
<span class="linenos">155</span><span class="w">    </span><span class="n">IntLattice</span><span class="o">::</span><span class="n">addParticle</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="n">particle</span><span class="p">);</span>
<span class="linenos">156</span><span class="w">	</span><span class="n">isGPUMemorySynched</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="linenos">157</span><span class="p">}</span>
<span class="linenos">158</span>
<span class="linenos">159</span><span class="kt">void</span><span class="w"> </span><span class="n">CudaIntLattice</span><span class="o">::</span><span class="n">removeParticles</span><span class="p">(</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span>
<span class="linenos">160</span><span class="p">{</span>
<span class="linenos">161</span><span class="w">    </span><span class="n">IntLattice</span><span class="o">::</span><span class="n">removeParticles</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">);</span>
<span class="linenos">162</span><span class="w">    </span><span class="n">isGPUMemorySynched</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="linenos">163</span><span class="p">}</span>
<span class="linenos">164</span>
<span class="linenos">165</span><span class="kt">void</span><span class="w"> </span><span class="n">CudaIntLattice</span><span class="o">::</span><span class="n">setSiteType</span><span class="p">(</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">index</span><span class="p">,</span><span class="w"> </span><span class="n">site_t</span><span class="w"> </span><span class="n">site</span><span class="p">)</span><span class="w"> </span>
<span class="linenos">166</span><span class="p">{</span>
<span class="linenos">167</span><span class="w">    </span><span class="n">IntLattice</span><span class="o">::</span><span class="n">setSiteType</span><span class="p">(</span><span class="n">index</span><span class="p">,</span><span class="n">site</span><span class="p">);</span>
<span class="linenos">168</span><span class="w">    </span><span class="n">isGPUMemorySynched</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="linenos">169</span><span class="p">}</span>
<span class="linenos">170</span>
<span class="linenos">171</span><span class="kt">void</span><span class="w"> </span><span class="n">CudaIntLattice</span><span class="o">::</span><span class="n">addParticle</span><span class="p">(</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">index</span><span class="p">,</span><span class="w"> </span><span class="n">particle_t</span><span class="w"> </span><span class="n">particle</span><span class="p">)</span><span class="w"> </span>
<span class="linenos">172</span><span class="p">{</span>
<span class="linenos">173</span><span class="w">    </span><span class="n">IntLattice</span><span class="o">::</span><span class="n">addParticle</span><span class="p">(</span><span class="n">index</span><span class="p">,</span><span class="n">particle</span><span class="p">);</span>
<span class="linenos">174</span><span class="w">	</span><span class="n">isGPUMemorySynched</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="linenos">175</span><span class="p">}</span>
<span class="linenos">176</span>
<span class="linenos">177</span><span class="kt">void</span><span class="w"> </span><span class="n">CudaIntLattice</span><span class="o">::</span><span class="n">removeParticles</span><span class="p">(</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">index</span><span class="p">)</span><span class="w"> </span>
<span class="linenos">178</span><span class="p">{</span>
<span class="linenos">179</span><span class="w">    </span><span class="n">IntLattice</span><span class="o">::</span><span class="n">removeParticles</span><span class="p">(</span><span class="n">index</span><span class="p">);</span>
<span class="linenos">180</span><span class="w">    </span><span class="n">isGPUMemorySynched</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="linenos">181</span><span class="p">}</span>
<span class="linenos">182</span>
<span class="linenos">183</span><span class="kt">void</span><span class="w"> </span><span class="n">CudaIntLattice</span><span class="o">::</span><span class="n">removeAllParticles</span><span class="p">()</span>
<span class="linenos">184</span><span class="p">{</span>
<span class="linenos">185</span><span class="w">    </span><span class="n">IntLattice</span><span class="o">::</span><span class="n">removeAllParticles</span><span class="p">();</span>
<span class="linenos">186</span><span class="w">	</span><span class="n">isGPUMemorySynched</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="linenos">187</span><span class="p">}</span>
<span class="linenos">188</span>
<span class="linenos">189</span><span class="kt">void</span><span class="w"> </span><span class="n">CudaIntLattice</span><span class="o">::</span><span class="n">setFromRowMajorByteData</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">buffer</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">bufferSize</span><span class="p">)</span>
<span class="linenos">190</span><span class="p">{</span>
<span class="linenos">191</span><span class="w">    </span><span class="n">IntLattice</span><span class="o">::</span><span class="n">setFromRowMajorByteData</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span><span class="w"> </span><span class="n">bufferSize</span><span class="p">);</span>
<span class="linenos">192</span><span class="w">    </span><span class="n">isGPUMemorySynched</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="linenos">193</span><span class="p">}</span>
<span class="linenos">194</span>
<span class="linenos">195</span><span class="p">}</span>
<span class="linenos">196</span><span class="p">}</span>
</pre></div>
</div>
</section>
</section>
<section id="solver-classes">
<h2>Solver Classes<a class="headerlink" href="#solver-classes" title="Link to this heading">#</a></h2>
<section id="mesolver-h">
<h3>MESolver.h<a class="headerlink" href="#mesolver-h" title="Link to this heading">#</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cm">/*</span>
<span class="linenos"> 2</span><span class="cm"> * University of Illinois Open Source License</span>
<span class="linenos"> 3</span><span class="cm"> * Copyright 2011-2018 Luthey-Schulten Group,</span>
<span class="linenos"> 4</span><span class="cm"> * All rights reserved.</span>
<span class="linenos"> 5</span><span class="cm"> * </span>
<span class="linenos"> 6</span><span class="cm"> * Developed by: Luthey-Schulten Group</span>
<span class="linenos"> 7</span><span class="cm"> * 			     University of Illinois at Urbana-Champaign</span>
<span class="linenos"> 8</span><span class="cm"> * 			     http://www.scs.uiuc.edu/~schulten</span>
<span class="linenos"> 9</span><span class="cm"> * </span>
<span class="linenos">10</span><span class="cm"> * Permission is hereby granted, free of charge, to any person obtaining a copy of</span>
<span class="linenos">11</span><span class="cm"> * this software and associated documentation files (the Software), to deal with </span>
<span class="linenos">12</span><span class="cm"> * the Software without restriction, including without limitation the rights to </span>
<span class="linenos">13</span><span class="cm"> * use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies </span>
<span class="linenos">14</span><span class="cm"> * of the Software, and to permit persons to whom the Software is furnished to </span>
<span class="linenos">15</span><span class="cm"> * do so, subject to the following conditions:</span>
<span class="linenos">16</span><span class="cm"> * </span>
<span class="linenos">17</span><span class="cm"> * - Redistributions of source code must retain the above copyright notice, </span>
<span class="linenos">18</span><span class="cm"> * this list of conditions and the following disclaimers.</span>
<span class="linenos">19</span><span class="cm"> * </span>
<span class="linenos">20</span><span class="cm"> * - Redistributions in binary form must reproduce the above copyright notice, </span>
<span class="linenos">21</span><span class="cm"> * this list of conditions and the following disclaimers in the documentation </span>
<span class="linenos">22</span><span class="cm"> * and/or other materials provided with the distribution.</span>
<span class="linenos">23</span><span class="cm"> * </span>
<span class="linenos">24</span><span class="cm"> * - Neither the names of the Luthey-Schulten Group, University of Illinois at</span>
<span class="linenos">25</span><span class="cm"> * Urbana-Champaign, nor the names of its contributors may be used to endorse or</span>
<span class="linenos">26</span><span class="cm"> * promote products derived from this Software without specific prior written</span>
<span class="linenos">27</span><span class="cm"> * permission.</span>
<span class="linenos">28</span><span class="cm"> * </span>
<span class="linenos">29</span><span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR </span>
<span class="linenos">30</span><span class="cm"> * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, </span>
<span class="linenos">31</span><span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL </span>
<span class="linenos">32</span><span class="cm"> * THE CONTRIBUTORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR </span>
<span class="linenos">33</span><span class="cm"> * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, </span>
<span class="linenos">34</span><span class="cm"> * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR </span>
<span class="linenos">35</span><span class="cm"> * OTHER DEALINGS WITH THE SOFTWARE.</span>
<span class="linenos">36</span><span class="cm"> *</span>
<span class="linenos">37</span><span class="cm"> * Author(s): Elijah Roberts</span>
<span class="linenos">38</span><span class="cm"> */</span>
<span class="linenos">39</span>
<span class="linenos">40</span><span class="cp">#ifndef LM_ME_MESOLVER_H</span>
<span class="linenos">41</span><span class="cp">#define LM_ME_MESOLVER_H</span>
<span class="linenos">42</span>
<span class="linenos">43</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;map&gt;</span>
<span class="linenos">44</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;core/ResourceAllocator.h&quot;</span>
<span class="linenos">45</span>
<span class="linenos">46</span><span class="k">using</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="p">;</span>
<span class="linenos">47</span><span class="k">using</span><span class="w"> </span><span class="n">lm</span><span class="o">::</span><span class="n">main</span><span class="o">::</span><span class="n">ResourceAllocator</span><span class="p">;</span>
<span class="linenos">48</span>
<span class="linenos">49</span><span class="k">namespace</span><span class="w"> </span><span class="nn">lm</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">50</span>
<span class="linenos">51</span><span class="k">namespace</span><span class="w"> </span><span class="nn">io</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">52</span><span class="k">class</span><span class="w"> </span><span class="nc">ReactionModel</span><span class="p">;</span>
<span class="linenos">53</span><span class="p">}</span>
<span class="linenos">54</span><span class="k">namespace</span><span class="w"> </span><span class="nn">me</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">55</span>
<span class="linenos">56</span><span class="c1">/// @class MESolver</span>
<span class="linenos">57</span><span class="c1">/// @brief An abstract base class for all Master Equation solvers, this is essentially a representation of &quot;the simulation instance&quot;</span>
<span class="linenos">58</span><span class="k">class</span><span class="w"> </span><span class="nc">MESolver</span>
<span class="linenos">59</span><span class="p">{</span>
<span class="linenos">60</span>
<span class="linenos">61</span><span class="k">public</span><span class="o">:</span>
<span class="linenos">62</span><span class="w">    </span><span class="c1">/// @brief Create the MESolver</span>
<span class="linenos">63</span><span class="w">    </span><span class="n">MESolver</span><span class="p">();</span>
<span class="linenos">64</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="o">~</span><span class="n">MESolver</span><span class="p">();</span>
<span class="linenos">65</span><span class="w">    </span>
<span class="linenos">66</span><span class="w">    </span><span class="c1">/// @brief Initialize the simulation</span>
<span class="linenos">67</span><span class="w">    </span><span class="c1">/// @param replicate Replicate number out of total replicates</span>
<span class="linenos">68</span><span class="w">    </span><span class="c1">/// @param parameters A map of all the parameters for the simulation</span>
<span class="linenos">69</span><span class="w">    </span><span class="c1">/// @param A list of resources assigned to the simulation</span>
<span class="linenos">70</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">initialize</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">replicate</span><span class="p">,</span><span class="w"> </span><span class="n">map</span><span class="o">&lt;</span><span class="n">string</span><span class="p">,</span><span class="n">string</span><span class="o">&gt;</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">parameters</span><span class="p">,</span><span class="w"> </span><span class="n">ResourceAllocator</span><span class="o">::</span><span class="n">ComputeResources</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">resources</span><span class="p">)</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">71</span><span class="w">    </span>
<span class="linenos">72</span><span class="w">    </span><span class="c1">/// @brief Tells whether the solver needs a reaction model</span>
<span class="linenos">73</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="nf">needsReactionModel</span><span class="p">()</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">74</span><span class="w">    </span><span class="c1">/// @brief Tells whether the solver needs a reaction model</span>
<span class="linenos">75</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="nf">needsDiffusionModel</span><span class="p">()</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">76</span><span class="w">    </span><span class="c1">/// @brief Actually run the simulation</span>
<span class="linenos">77</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">generateTrajectory</span><span class="p">()</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">78</span><span class="p">};</span>
<span class="linenos">79</span>
<span class="linenos">80</span><span class="p">}</span>
<span class="linenos">81</span><span class="p">}</span>
<span class="linenos">82</span>
<span class="linenos">83</span><span class="cp">#endif</span>
</pre></div>
</div>
</section>
<section id="mesolver-cpp">
<h3>MESolver.cpp<a class="headerlink" href="#mesolver-cpp" title="Link to this heading">#</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cm">/*</span>
<span class="linenos"> 2</span><span class="cm"> * University of Illinois Open Source License</span>
<span class="linenos"> 3</span><span class="cm"> * Copyright 2011-2018 Luthey-Schulten Group,</span>
<span class="linenos"> 4</span><span class="cm"> * All rights reserved.</span>
<span class="linenos"> 5</span><span class="cm"> * </span>
<span class="linenos"> 6</span><span class="cm"> * Developed by: Luthey-Schulten Group</span>
<span class="linenos"> 7</span><span class="cm"> * 			     University of Illinois at Urbana-Champaign</span>
<span class="linenos"> 8</span><span class="cm"> * 			     http://www.scs.uiuc.edu/~schulten</span>
<span class="linenos"> 9</span><span class="cm"> * </span>
<span class="linenos">10</span><span class="cm"> * Permission is hereby granted, free of charge, to any person obtaining a copy of</span>
<span class="linenos">11</span><span class="cm"> * this software and associated documentation files (the Software), to deal with </span>
<span class="linenos">12</span><span class="cm"> * the Software without restriction, including without limitation the rights to </span>
<span class="linenos">13</span><span class="cm"> * use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies </span>
<span class="linenos">14</span><span class="cm"> * of the Software, and to permit persons to whom the Software is furnished to </span>
<span class="linenos">15</span><span class="cm"> * do so, subject to the following conditions:</span>
<span class="linenos">16</span><span class="cm"> * </span>
<span class="linenos">17</span><span class="cm"> * - Redistributions of source code must retain the above copyright notice, </span>
<span class="linenos">18</span><span class="cm"> * this list of conditions and the following disclaimers.</span>
<span class="linenos">19</span><span class="cm"> * </span>
<span class="linenos">20</span><span class="cm"> * - Redistributions in binary form must reproduce the above copyright notice, </span>
<span class="linenos">21</span><span class="cm"> * this list of conditions and the following disclaimers in the documentation </span>
<span class="linenos">22</span><span class="cm"> * and/or other materials provided with the distribution.</span>
<span class="linenos">23</span><span class="cm"> * </span>
<span class="linenos">24</span><span class="cm"> * - Neither the names of the Luthey-Schulten Group, University of Illinois at</span>
<span class="linenos">25</span><span class="cm"> * Urbana-Champaign, nor the names of its contributors may be used to endorse or</span>
<span class="linenos">26</span><span class="cm"> * promote products derived from this Software without specific prior written</span>
<span class="linenos">27</span><span class="cm"> * permission.</span>
<span class="linenos">28</span><span class="cm"> * </span>
<span class="linenos">29</span><span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR </span>
<span class="linenos">30</span><span class="cm"> * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, </span>
<span class="linenos">31</span><span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL </span>
<span class="linenos">32</span><span class="cm"> * THE CONTRIBUTORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR </span>
<span class="linenos">33</span><span class="cm"> * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, </span>
<span class="linenos">34</span><span class="cm"> * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR </span>
<span class="linenos">35</span><span class="cm"> * OTHER DEALINGS WITH THE SOFTWARE.</span>
<span class="linenos">36</span><span class="cm"> *</span>
<span class="linenos">37</span><span class="cm"> * Author(s): Elijah Roberts</span>
<span class="linenos">38</span><span class="cm"> */</span>
<span class="linenos">39</span>
<span class="linenos">40</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;config.h&quot;</span>
<span class="linenos">41</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;me/MESolver.h&quot;</span>
<span class="linenos">42</span>
<span class="linenos">43</span><span class="k">namespace</span><span class="w"> </span><span class="nn">lm</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">44</span><span class="k">namespace</span><span class="w"> </span><span class="nn">me</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">45</span>
<span class="linenos">46</span><span class="n">MESolver</span><span class="o">::</span><span class="n">MESolver</span><span class="p">()</span>
<span class="linenos">47</span><span class="p">{</span>
<span class="linenos">48</span><span class="p">}</span>
<span class="linenos">49</span>
<span class="linenos">50</span><span class="n">MESolver</span><span class="o">::~</span><span class="n">MESolver</span><span class="p">()</span>
<span class="linenos">51</span><span class="p">{</span>
<span class="linenos">52</span><span class="p">}</span>
<span class="linenos">53</span>
<span class="linenos">54</span><span class="p">}</span>
<span class="linenos">55</span><span class="p">}</span>
</pre></div>
</div>
</section>
<section id="cmesolver-h">
<h3>CMESolver.h<a class="headerlink" href="#cmesolver-h" title="Link to this heading">#</a></h3>
</section>
<section id="cmesolver-cpp">
<h3>CMESolver.cpp<a class="headerlink" href="#cmesolver-cpp" title="Link to this heading">#</a></h3>
</section>
</section>
<section id="rdme-solver-classes">
<h2>RDME Solver Classes<a class="headerlink" href="#rdme-solver-classes" title="Link to this heading">#</a></h2>
<section id="mpdrdmesolver-h">
<h3>MpdRdmeSolver.h<a class="headerlink" href="#mpdrdmesolver-h" title="Link to this heading">#</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="linenos">  1</span><span class="cm">/*</span>
<span class="linenos">  2</span><span class="cm"> * University of Illinois Open Source License</span>
<span class="linenos">  3</span><span class="cm"> * Copyright 2008-2018 Luthey-Schulten Group,</span>
<span class="linenos">  4</span><span class="cm"> * Copyright 2012 Roberts Group,</span>
<span class="linenos">  5</span><span class="cm"> * All rights reserved.</span>
<span class="linenos">  6</span><span class="cm"> * </span>
<span class="linenos">  7</span><span class="cm"> * Developed by: Luthey-Schulten Group</span>
<span class="linenos">  8</span><span class="cm"> * 			     University of Illinois at Urbana-Champaign</span>
<span class="linenos">  9</span><span class="cm"> * 			     http://www.scs.uiuc.edu/~schulten</span>
<span class="linenos"> 10</span><span class="cm"> * </span>
<span class="linenos"> 11</span><span class="cm"> * Developed by: Roberts Group</span>
<span class="linenos"> 12</span><span class="cm"> * 			     Johns Hopkins University</span>
<span class="linenos"> 13</span><span class="cm"> * 			     http://biophysics.jhu.edu/roberts/</span>
<span class="linenos"> 14</span><span class="cm"> *</span>
<span class="linenos"> 15</span><span class="cm"> * Permission is hereby granted, free of charge, to any person obtaining a copy of</span>
<span class="linenos"> 16</span><span class="cm"> * this software and associated documentation files (the Software), to deal with </span>
<span class="linenos"> 17</span><span class="cm"> * the Software without restriction, including without limitation the rights to </span>
<span class="linenos"> 18</span><span class="cm"> * use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies </span>
<span class="linenos"> 19</span><span class="cm"> * of the Software, and to permit persons to whom the Software is furnished to </span>
<span class="linenos"> 20</span><span class="cm"> * do so, subject to the following conditions:</span>
<span class="linenos"> 21</span><span class="cm"> * </span>
<span class="linenos"> 22</span><span class="cm"> * - Redistributions of source code must retain the above copyright notice, </span>
<span class="linenos"> 23</span><span class="cm"> * this list of conditions and the following disclaimers.</span>
<span class="linenos"> 24</span><span class="cm"> * </span>
<span class="linenos"> 25</span><span class="cm"> * - Redistributions in binary form must reproduce the above copyright notice, </span>
<span class="linenos"> 26</span><span class="cm"> * this list of conditions and the following disclaimers in the documentation </span>
<span class="linenos"> 27</span><span class="cm"> * and/or other materials provided with the distribution.</span>
<span class="linenos"> 28</span><span class="cm"> * </span>
<span class="linenos"> 29</span><span class="cm"> * - Neither the names of the Luthey-Schulten Group, University of Illinois at</span>
<span class="linenos"> 30</span><span class="cm"> * Urbana-Champaign, the Roberts Group, Johns Hopkins University, nor the names</span>
<span class="linenos"> 31</span><span class="cm"> * of its contributors may be used to endorse or promote products derived from</span>
<span class="linenos"> 32</span><span class="cm"> * this Software without specific prior written permission.</span>
<span class="linenos"> 33</span><span class="cm"> * </span>
<span class="linenos"> 34</span><span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR </span>
<span class="linenos"> 35</span><span class="cm"> * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, </span>
<span class="linenos"> 36</span><span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL </span>
<span class="linenos"> 37</span><span class="cm"> * THE CONTRIBUTORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR </span>
<span class="linenos"> 38</span><span class="cm"> * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, </span>
<span class="linenos"> 39</span><span class="cm"> * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR </span>
<span class="linenos"> 40</span><span class="cm"> * OTHER DEALINGS WITH THE SOFTWARE.</span>
<span class="linenos"> 41</span><span class="cm"> *</span>
<span class="linenos"> 42</span><span class="cm"> * Author(s): Elijah Roberts, Zane Thornburg</span>
<span class="linenos"> 43</span><span class="cm"> */</span>
<span class="linenos"> 44</span>
<span class="linenos"> 45</span><span class="cp">#ifndef LM_RDME_MPDRDMESOLVER_H_</span>
<span class="linenos"> 46</span><span class="cp">#define LM_RDME_MPDRDMESOLVER_H_</span>
<span class="linenos"> 47</span>
<span class="linenos"> 48</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;cuda/lm_cuda.h&quot;</span>
<span class="linenos"> 49</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;rdme/RDMESolver.h&quot;</span>
<span class="linenos"> 50</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;rdme/CudaByteLattice.h&quot;</span>
<span class="linenos"> 51</span>
<span class="linenos"> 52</span><span class="cp">#define OVERFLOW_MODE_CLASSIC 0</span>
<span class="linenos"> 53</span><span class="cp">#define OVERFLOW_MODE_RELAXED 1</span>
<span class="linenos"> 54</span>
<span class="linenos"> 55</span><span class="k">using</span><span class="w"> </span><span class="n">lm</span><span class="o">::</span><span class="n">rdme</span><span class="o">::</span><span class="n">RDMESolver</span><span class="p">;</span>
<span class="linenos"> 56</span><span class="k">using</span><span class="w"> </span><span class="n">lm</span><span class="o">::</span><span class="n">rdme</span><span class="o">::</span><span class="n">Lattice</span><span class="p">;</span>
<span class="linenos"> 57</span>
<span class="linenos"> 58</span><span class="k">namespace</span><span class="w"> </span><span class="nn">lm</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 59</span>
<span class="linenos"> 60</span><span class="k">namespace</span><span class="w"> </span><span class="nn">io</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 61</span><span class="w">    </span><span class="k">class</span><span class="w"> </span><span class="nc">Lattice</span><span class="p">;</span>
<span class="linenos"> 62</span><span class="w">    </span><span class="k">class</span><span class="w"> </span><span class="nc">SpeciesCounts</span><span class="p">;</span>
<span class="linenos"> 63</span><span class="p">}</span>
<span class="linenos"> 64</span>
<span class="linenos"> 65</span><span class="k">namespace</span><span class="w"> </span><span class="nn">rdme</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 66</span>
<span class="linenos"> 67</span><span class="k">class</span><span class="w"> </span><span class="nc">MpdRdmeSolver</span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">RDMESolver</span>
<span class="linenos"> 68</span><span class="p">{</span>
<span class="linenos"> 69</span><span class="w">    </span><span class="k">using</span><span class="w"> </span><span class="n">CMESolver</span><span class="o">::</span><span class="n">hookSimulation</span><span class="p">;</span>
<span class="linenos"> 70</span><span class="w">    </span><span class="k">using</span><span class="w"> </span><span class="n">CMESolver</span><span class="o">::</span><span class="n">onBeginTrajectory</span><span class="p">;</span>
<span class="linenos"> 71</span><span class="w">    </span><span class="k">using</span><span class="w"> </span><span class="n">CMESolver</span><span class="o">::</span><span class="n">onEndTrajectory</span><span class="p">;</span>
<span class="linenos"> 72</span><span class="w">    </span><span class="k">using</span><span class="w"> </span><span class="n">RDMESolver</span><span class="o">::</span><span class="n">buildDiffusionModel</span><span class="p">;</span>
<span class="linenos"> 73</span>
<span class="linenos"> 74</span><span class="k">public</span><span class="o">:</span>
<span class="linenos"> 75</span><span class="w">    </span><span class="n">MpdRdmeSolver</span><span class="p">();</span>
<span class="linenos"> 76</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="o">~</span><span class="n">MpdRdmeSolver</span><span class="p">();</span>
<span class="linenos"> 77</span>
<span class="linenos"> 78</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">initialize</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">replicate</span><span class="p">,</span>
<span class="linenos"> 79</span><span class="w">                            </span><span class="n">map</span><span class="o">&lt;</span><span class="n">string</span><span class="p">,</span><span class="w"> </span><span class="n">string</span><span class="o">&gt;*</span><span class="w"> </span><span class="n">parameters</span><span class="p">,</span>
<span class="linenos"> 80</span><span class="w">                            </span><span class="n">ResourceAllocator</span><span class="o">::</span><span class="n">ComputeResources</span><span class="o">*</span><span class="w"> </span><span class="n">resources</span><span class="p">);</span>
<span class="linenos"> 81</span>
<span class="linenos"> 82</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="nf">needsReactionModel</span><span class="p">()</span><span class="w">  </span><span class="p">{</span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;}</span>
<span class="linenos"> 83</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="nf">needsDiffusionModel</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;}</span>
<span class="linenos"> 84</span>
<span class="linenos"> 85</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">buildModel</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">uint</span><span class="w"> </span><span class="n">numberSpeciesA</span><span class="p">,</span>
<span class="linenos"> 86</span><span class="w">                            </span><span class="k">const</span><span class="w"> </span><span class="n">uint</span><span class="w"> </span><span class="n">numberReactionsA</span><span class="p">,</span>
<span class="linenos"> 87</span><span class="w">                            </span><span class="k">const</span><span class="w"> </span><span class="n">uint</span><span class="o">*</span><span class="w"> </span><span class="n">initialSpeciesCountsA</span><span class="p">,</span>
<span class="linenos"> 88</span><span class="w">                            </span><span class="k">const</span><span class="w"> </span><span class="n">uint</span><span class="o">*</span><span class="w"> </span><span class="n">reactionTypeA</span><span class="p">,</span>
<span class="linenos"> 89</span><span class="w">                            </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="o">*</span><span class="w"> </span><span class="n">kA</span><span class="p">,</span>
<span class="linenos"> 90</span><span class="w">                            </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">SA</span><span class="p">,</span>
<span class="linenos"> 91</span><span class="w">                            </span><span class="k">const</span><span class="w"> </span><span class="n">uint</span><span class="o">*</span><span class="w"> </span><span class="n">DA</span><span class="p">,</span>
<span class="linenos"> 92</span><span class="w">                            </span><span class="k">const</span><span class="w"> </span><span class="n">uint</span><span class="w"> </span><span class="n">kCols</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="linenos"> 93</span>
<span class="linenos"> 94</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">buildDiffusionModel</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">uint</span><span class="w"> </span><span class="n">numberSiteTypesA</span><span class="p">,</span>
<span class="linenos"> 95</span><span class="w">                                     </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="o">*</span><span class="w"> </span><span class="n">DFA</span><span class="p">,</span>
<span class="linenos"> 96</span><span class="w">                                     </span><span class="k">const</span><span class="w"> </span><span class="n">uint</span><span class="o">*</span><span class="w"> </span><span class="n">RLA</span><span class="p">,</span>
<span class="linenos"> 97</span><span class="w">                                     </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">latticeXSize</span><span class="p">,</span>
<span class="linenos"> 98</span><span class="w">                                     </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">latticeYSize</span><span class="p">,</span>
<span class="linenos"> 99</span><span class="w">                                     </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">latticeZSize</span><span class="p">,</span>
<span class="linenos">100</span><span class="w">                                     </span><span class="n">site_size_t</span><span class="w"> </span><span class="n">particlesPerSite</span><span class="p">,</span>
<span class="linenos">101</span><span class="w">                                     </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">bytes_per_particle</span><span class="p">,</span>
<span class="linenos">102</span><span class="w">                                     </span><span class="n">si_dist_t</span><span class="w"> </span><span class="n">latticeSpacing</span><span class="p">,</span>
<span class="linenos">103</span><span class="w">                                     </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="o">*</span><span class="w"> </span><span class="n">latticeData</span><span class="p">,</span>
<span class="linenos">104</span><span class="w">                                     </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="o">*</span><span class="w"> </span><span class="n">latticeSitesData</span><span class="p">,</span>
<span class="linenos">105</span><span class="w">                                     </span><span class="kt">bool</span><span class="w"> </span><span class="n">rowMajorData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span>
<span class="linenos">106</span>
<span class="linenos">107</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">generateTrajectory</span><span class="p">();</span>
<span class="linenos">108</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setReactionRate</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">rxid</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">rate</span><span class="p">);</span>
<span class="linenos">109</span>
<span class="linenos">110</span><span class="k">protected</span><span class="o">:</span>
<span class="linenos">111</span><span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">seed</span><span class="p">;</span>
<span class="linenos">112</span><span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">tau</span><span class="p">;</span>
<span class="linenos">113</span><span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">reactionModelModified</span><span class="p">;</span>
<span class="linenos">114</span>
<span class="linenos">115</span><span class="w">    </span><span class="kt">void</span><span class="o">*</span><span class="w">        </span><span class="n">cudaOverflowList</span><span class="p">;</span>
<span class="linenos">116</span><span class="w">    </span><span class="n">cudaStream_t</span><span class="w"> </span><span class="n">cudaStream</span><span class="p">;</span>
<span class="linenos">117</span>
<span class="linenos">118</span><span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">overflowTimesteps</span><span class="p">;</span>
<span class="linenos">119</span><span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">overflowListUses</span><span class="p">;</span>
<span class="linenos">120</span><span class="w">    </span><span class="kt">int</span><span class="w">      </span><span class="n">overflow_handling</span><span class="p">;</span>
<span class="linenos">121</span>
<span class="linenos">122</span><span class="w">    </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">model_reactionRates</span><span class="p">;</span>
<span class="linenos">123</span><span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">zeroOrderSize</span><span class="p">,</span><span class="w"> </span><span class="n">firstOrderSize</span><span class="p">,</span><span class="w"> </span><span class="n">secondOrderSize</span><span class="p">;</span>
<span class="linenos">124</span><span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="n">zeroOrder</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">firstOrder</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">secondOrder</span><span class="p">;</span>
<span class="linenos">125</span>
<span class="linenos">126</span><span class="cp">#ifdef MPD_GLOBAL_S_MATRIX</span>
<span class="linenos">127</span><span class="w">	</span><span class="kt">uint8_t</span><span class="o">*</span><span class="w"> </span><span class="n">RLG</span><span class="p">;</span><span class="w"> </span><span class="c1">// Device global memory pointer for RL matrix</span>
<span class="linenos">128</span><span class="w">	</span><span class="kt">int8_t</span><span class="o">*</span><span class="w"> </span><span class="n">SG</span><span class="p">;</span><span class="w">	  </span><span class="c1">// Device global memory pointer for S matrix</span>
<span class="linenos">129</span><span class="cp">#endif</span>
<span class="linenos">130</span>
<span class="linenos">131</span><span class="cp">#ifdef MPD_GLOBAL_T_MATRIX</span>
<span class="linenos">132</span><span class="w">	</span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">TG</span><span class="p">;</span>
<span class="linenos">133</span><span class="cp">#endif</span>
<span class="linenos">134</span>
<span class="linenos">135</span><span class="cp">#ifdef MPD_GLOBAL_R_MATRIX</span>
<span class="linenos">136</span><span class="w">    </span><span class="kt">float</span><span class="o">*</span><span class="w">        </span><span class="n">reactionRatesG</span><span class="p">;</span>
<span class="linenos">137</span><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">reactionOrdersG</span><span class="p">;</span>
<span class="linenos">138</span><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">reactionSitesG</span><span class="p">;</span>
<span class="linenos">139</span>
<span class="linenos">140</span><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">D1G</span><span class="p">;</span>
<span class="linenos">141</span><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">D2G</span><span class="p">;</span>
<span class="linenos">142</span><span class="cp">#endif</span>
<span class="linenos">143</span>
<span class="linenos">144</span><span class="w">    </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">propZeroOrder</span><span class="p">;</span>
<span class="linenos">145</span><span class="w">	</span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">propFirstOrder</span><span class="p">;</span>
<span class="linenos">146</span><span class="w">	</span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">propSecondOrder</span><span class="p">;</span>
<span class="linenos">147</span>
<span class="linenos">148</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">onBeginTrajectory</span><span class="p">(</span><span class="n">CudaByteLattice</span><span class="o">*</span><span class="w"> </span><span class="n">lattice</span><span class="p">);</span>
<span class="linenos">149</span><span class="w">	</span><span class="k">virtual</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">onEndTrajectory</span><span class="p">(</span><span class="n">CudaByteLattice</span><span class="o">*</span><span class="w"> </span><span class="n">lattice</span><span class="p">);</span>
<span class="linenos">150</span><span class="w">	</span><span class="k">virtual</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">onWriteLattice</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="n">CudaByteLattice</span><span class="o">*</span><span class="w"> </span><span class="n">lattice</span><span class="p">);</span>
<span class="linenos">151</span>
<span class="linenos">152</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">allocateLattice</span><span class="p">(</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">latticeXSize</span><span class="p">,</span>
<span class="linenos">153</span><span class="w">                                 </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">latticeYSize</span><span class="p">,</span>
<span class="linenos">154</span><span class="w">                                 </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">latticeZSize</span><span class="p">,</span>
<span class="linenos">155</span><span class="w">                                 </span><span class="n">site_size_t</span><span class="w"> </span><span class="n">particlesPerSite</span><span class="p">,</span>
<span class="linenos">156</span><span class="w">                                 </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">bytes_per_particle</span><span class="p">,</span>
<span class="linenos">157</span><span class="w">                                 </span><span class="n">si_dist_t</span><span class="w"> </span><span class="n">latticeSpacing</span><span class="p">);</span>
<span class="linenos">158</span>
<span class="linenos">159</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">writeLatticeData</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">time</span><span class="p">,</span>
<span class="linenos">160</span><span class="w">                                  </span><span class="n">CudaByteLattice</span><span class="o">*</span><span class="w"> </span><span class="n">lattice</span><span class="p">,</span>
<span class="linenos">161</span><span class="w">                                  </span><span class="n">lm</span><span class="o">::</span><span class="n">io</span><span class="o">::</span><span class="n">Lattice</span><span class="o">*</span><span class="w"> </span><span class="n">latticeDataSet</span><span class="p">);</span>
<span class="linenos">162</span><span class="w">	</span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">writeLatticeSites</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="n">CudaByteLattice</span><span class="o">*</span><span class="w"> </span><span class="n">lattice</span><span class="p">);</span>
<span class="linenos">163</span>
<span class="linenos">164</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">recordSpeciesCounts</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">time</span><span class="p">,</span>
<span class="linenos">165</span><span class="w">                                     </span><span class="n">CudaByteLattice</span><span class="o">*</span><span class="w"> </span><span class="n">lattice</span><span class="p">,</span>
<span class="linenos">166</span><span class="w">                                     </span><span class="n">lm</span><span class="o">::</span><span class="n">io</span><span class="o">::</span><span class="n">SpeciesCounts</span><span class="o">*</span><span class="w"> </span><span class="n">speciesCountsDataSet</span><span class="p">);</span>
<span class="linenos">167</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">writeSpeciesCounts</span><span class="p">(</span><span class="n">lm</span><span class="o">::</span><span class="n">io</span><span class="o">::</span><span class="n">SpeciesCounts</span><span class="o">*</span><span class="w"> </span><span class="n">speciesCountsDataSet</span><span class="p">);</span>
<span class="linenos">168</span>
<span class="linenos">169</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">hookSimulation</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="n">CudaByteLattice</span><span class="o">*</span><span class="w"> </span><span class="n">lattice</span><span class="p">);</span>
<span class="linenos">170</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">hookCheckSimulation</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="n">CudaByteLattice</span><span class="o">*</span><span class="w"> </span><span class="n">lattice</span><span class="p">);</span>
<span class="linenos">171</span>
<span class="linenos">172</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">runTimestep</span><span class="p">(</span><span class="n">CudaByteLattice</span><span class="o">*</span><span class="w"> </span><span class="n">lattice</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">timestep</span><span class="p">);</span>
<span class="linenos">173</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">uint64_t</span><span class="w"> </span><span class="nf">getTimestepSeed</span><span class="p">(</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">timestep</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">substep</span><span class="p">);</span>
<span class="linenos">174</span>
<span class="linenos">175</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">computePropensities</span><span class="p">();</span>
<span class="linenos">176</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">copyModelsToDevice</span><span class="p">();</span>
<span class="linenos">177</span>
<span class="linenos">178</span><span class="cp">#ifdef MPD_CUDA_3D_GRID_LAUNCH</span>
<span class="linenos">179</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">calculateXLaunchParameters</span><span class="p">(</span><span class="n">dim3</span><span class="o">*</span><span class="w"> </span><span class="n">gridSize</span><span class="p">,</span><span class="w"> </span><span class="n">dim3</span><span class="o">*</span><span class="w"> </span><span class="n">threadBlockSize</span><span class="p">,</span>
<span class="linenos">180</span><span class="w">                                            </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">maxXBlockSize</span><span class="p">,</span>
<span class="linenos">181</span><span class="w">                                            </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeXSize</span><span class="p">,</span>
<span class="linenos">182</span><span class="w">                                            </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeYSize</span><span class="p">,</span>
<span class="linenos">183</span><span class="w">                                            </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeZSize</span><span class="p">);</span>
<span class="linenos">184</span>
<span class="linenos">185</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">calculateYLaunchParameters</span><span class="p">(</span><span class="n">dim3</span><span class="o">*</span><span class="w"> </span><span class="n">gridSize</span><span class="p">,</span><span class="w"> </span><span class="n">dim3</span><span class="o">*</span><span class="w"> </span><span class="n">threadBlockSize</span><span class="p">,</span>
<span class="linenos">186</span><span class="w">                                            </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">blockXSize</span><span class="p">,</span>
<span class="linenos">187</span><span class="w">                                            </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">blockYSize</span><span class="p">,</span>
<span class="linenos">188</span><span class="w">                                            </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeXSize</span><span class="p">,</span>
<span class="linenos">189</span><span class="w">                                            </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeYSize</span><span class="p">,</span>
<span class="linenos">190</span><span class="w">                                            </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeZSize</span><span class="p">);</span>
<span class="linenos">191</span>
<span class="linenos">192</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">calculateZLaunchParameters</span><span class="p">(</span><span class="n">dim3</span><span class="o">*</span><span class="w"> </span><span class="n">gridSize</span><span class="p">,</span><span class="w"> </span><span class="n">dim3</span><span class="o">*</span><span class="w"> </span><span class="n">threadBlockSize</span><span class="p">,</span>
<span class="linenos">193</span><span class="w">                                            </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">blockXSize</span><span class="p">,</span>
<span class="linenos">194</span><span class="w">                                            </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">blockZSize</span><span class="p">,</span>
<span class="linenos">195</span><span class="w">                                            </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeXSize</span><span class="p">,</span>
<span class="linenos">196</span><span class="w">                                            </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeYSize</span><span class="p">,</span>
<span class="linenos">197</span><span class="w">                                            </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeZSize</span><span class="p">);</span>
<span class="linenos">198</span>
<span class="linenos">199</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">calculateReactionLaunchParameters</span><span class="p">(</span><span class="n">dim3</span><span class="o">*</span><span class="w"> </span><span class="n">gridSize</span><span class="p">,</span><span class="w"> </span><span class="n">dim3</span><span class="o">*</span><span class="w"> </span><span class="n">threadBlockSize</span><span class="p">,</span>
<span class="linenos">200</span><span class="w">                                                   </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">blockXSize</span><span class="p">,</span>
<span class="linenos">201</span><span class="w">                                                   </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">blockYSize</span><span class="p">,</span>
<span class="linenos">202</span><span class="w">                                                   </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeXSize</span><span class="p">,</span>
<span class="linenos">203</span><span class="w">                                                   </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeYSize</span><span class="p">,</span>
<span class="linenos">204</span><span class="w">                                                   </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeZSize</span><span class="p">);</span>
<span class="linenos">205</span><span class="cp">#else</span>
<span class="linenos">206</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">calculateXLaunchParameters</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">gridXSize</span><span class="p">,</span>
<span class="linenos">207</span><span class="w">                                            </span><span class="n">dim3</span><span class="o">*</span><span class="w"> </span><span class="n">gridSize</span><span class="p">,</span><span class="w"> </span><span class="n">dim3</span><span class="o">*</span><span class="w"> </span><span class="n">threadBlockSize</span><span class="p">,</span>
<span class="linenos">208</span><span class="w">                                            </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">maxXBlockSize</span><span class="p">,</span>
<span class="linenos">209</span><span class="w">                                            </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeXSize</span><span class="p">,</span>
<span class="linenos">210</span><span class="w">                                            </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeYSize</span><span class="p">,</span>
<span class="linenos">211</span><span class="w">                                            </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeZSize</span><span class="p">);</span>
<span class="linenos">212</span>
<span class="linenos">213</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">calculateYLaunchParameters</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">gridXSize</span><span class="p">,</span>
<span class="linenos">214</span><span class="w">                                            </span><span class="n">dim3</span><span class="o">*</span><span class="w"> </span><span class="n">gridSize</span><span class="p">,</span><span class="w"> </span><span class="n">dim3</span><span class="o">*</span><span class="w"> </span><span class="n">threadBlockSize</span><span class="p">,</span>
<span class="linenos">215</span><span class="w">                                            </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">blockXSize</span><span class="p">,</span>
<span class="linenos">216</span><span class="w">                                            </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">blockYSize</span><span class="p">,</span>
<span class="linenos">217</span><span class="w">                                            </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeXSize</span><span class="p">,</span>
<span class="linenos">218</span><span class="w">                                            </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeYSize</span><span class="p">,</span>
<span class="linenos">219</span><span class="w">                                            </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeZSize</span><span class="p">);</span>
<span class="linenos">220</span>
<span class="linenos">221</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">calculateZLaunchParameters</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">gridXSize</span><span class="p">,</span>
<span class="linenos">222</span><span class="w">                                            </span><span class="n">dim3</span><span class="o">*</span><span class="w"> </span><span class="n">gridSize</span><span class="p">,</span><span class="w"> </span><span class="n">dim3</span><span class="o">*</span><span class="w"> </span><span class="n">threadBlockSize</span><span class="p">,</span>
<span class="linenos">223</span><span class="w">                                            </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">blockXSize</span><span class="p">,</span>
<span class="linenos">224</span><span class="w">                                            </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">blockZSize</span><span class="p">,</span>
<span class="linenos">225</span><span class="w">                                            </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeXSize</span><span class="p">,</span>
<span class="linenos">226</span><span class="w">                                            </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeYSize</span><span class="p">,</span>
<span class="linenos">227</span><span class="w">                                            </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeZSize</span><span class="p">);</span>
<span class="linenos">228</span>
<span class="linenos">229</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">calculateReactionLaunchParameters</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">gridXSize</span><span class="p">,</span>
<span class="linenos">230</span><span class="w">                                                   </span><span class="n">dim3</span><span class="o">*</span><span class="w"> </span><span class="n">gridSize</span><span class="p">,</span><span class="w"> </span><span class="n">dim3</span><span class="o">*</span><span class="w"> </span><span class="n">threadBlockSize</span><span class="p">,</span>
<span class="linenos">231</span><span class="w">                                                   </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">blockXSize</span><span class="p">,</span>
<span class="linenos">232</span><span class="w">                                                   </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">blockYSize</span><span class="p">,</span>
<span class="linenos">233</span><span class="w">                                                   </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeXSize</span><span class="p">,</span>
<span class="linenos">234</span><span class="w">                                                   </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeYSize</span><span class="p">,</span>
<span class="linenos">235</span><span class="w">                                                   </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeZSize</span><span class="p">);</span>
<span class="linenos">236</span><span class="cp">#endif</span>
<span class="linenos">237</span>
<span class="linenos">238</span><span class="p">};</span>
<span class="linenos">239</span>
<span class="linenos">240</span>
<span class="linenos">241</span><span class="k">namespace</span><span class="w"> </span><span class="nn">mpdrdme_dev</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">242</span>
<span class="linenos">243</span><span class="cp">#ifdef MPD_FREAKYFAST</span>
<span class="linenos">244</span><span class="w">    </span><span class="cp">#ifdef MPD_GLOBAL_R_MATRIX</span>
<span class="linenos">245</span><span class="w">        </span><span class="n">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">precomp_reaction_kernel</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">inLattice</span><span class="p">,</span>
<span class="linenos">246</span><span class="w">                                                </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="o">*</span><span class="w"> </span><span class="n">inSites</span><span class="p">,</span>
<span class="linenos">247</span><span class="w">                                                </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">outLattice</span><span class="p">,</span>
<span class="linenos">248</span><span class="w">                                                </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">,</span>
<span class="linenos">249</span><span class="w">                                                </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">,</span>
<span class="linenos">250</span><span class="w">                                                </span><span class="k">const</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="kt">int8_t</span><span class="o">*</span><span class="w"> </span><span class="n">SG</span><span class="p">,</span>
<span class="linenos">251</span><span class="w">                                                </span><span class="k">const</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="kt">uint8_t</span><span class="o">*</span><span class="w"> </span><span class="n">RLG</span><span class="p">,</span>
<span class="linenos">252</span><span class="w">                                                </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="n">reactionOrdersG</span><span class="p">,</span>
<span class="linenos">253</span><span class="w">                                                </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="n">reactionSitesG</span><span class="p">,</span>
<span class="linenos">254</span><span class="w">                                                </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="n">D1G</span><span class="p">,</span>
<span class="linenos">255</span><span class="w">                                                </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="n">D2G</span><span class="p">,</span>
<span class="linenos">256</span><span class="w">                                                </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">reactionRatesG</span><span class="p">,</span>
<span class="linenos">257</span><span class="w">                                                </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="n">qp0</span><span class="p">,</span>
<span class="linenos">258</span><span class="w">                                                </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="n">qp1</span><span class="p">,</span>
<span class="linenos">259</span><span class="w">                                                </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="n">qp2</span><span class="p">);</span>
<span class="linenos">260</span><span class="w">    </span><span class="cp">#else</span>
<span class="linenos">261</span><span class="w">        </span><span class="n">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">precomp_reaction_kernel</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">inLattice</span><span class="p">,</span>
<span class="linenos">262</span><span class="w">                                                </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="o">*</span><span class="w"> </span><span class="n">inSites</span><span class="p">,</span>
<span class="linenos">263</span><span class="w">                                                </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">outLattice</span><span class="p">,</span>
<span class="linenos">264</span><span class="w">                                                </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">,</span>
<span class="linenos">265</span><span class="w">                                                </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">,</span>
<span class="linenos">266</span><span class="w">                                                </span><span class="k">const</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="kt">int8_t</span><span class="o">*</span><span class="w"> </span><span class="n">SG</span><span class="p">,</span>
<span class="linenos">267</span><span class="w">                                                </span><span class="k">const</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="kt">uint8_t</span><span class="o">*</span><span class="w"> </span><span class="n">RLG</span><span class="p">,</span>
<span class="linenos">268</span><span class="w">                                                </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="n">qp0</span><span class="p">,</span>
<span class="linenos">269</span><span class="w">                                                </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="n">qp1</span><span class="p">,</span>
<span class="linenos">270</span><span class="w">                                                </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="n">qp2</span><span class="p">);</span>
<span class="linenos">271</span><span class="w">    </span><span class="cp">#endif</span>
<span class="linenos">272</span><span class="cp">#endif</span>
<span class="linenos">273</span>
<span class="linenos">274</span><span class="cp">#ifdef MPD_CUDA_3D_GRID_LAUNCH</span>
<span class="linenos">275</span><span class="w">    </span><span class="n">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">mpd_x_kernel</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">inLattice</span><span class="p">,</span>
<span class="linenos">276</span><span class="w">                                 </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="o">*</span><span class="w"> </span><span class="n">inSites</span><span class="p">,</span>
<span class="linenos">277</span><span class="w">                                 </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">outLattice</span><span class="p">,</span>
<span class="linenos">278</span><span class="w">                                 </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">,</span>
<span class="linenos">279</span><span class="w">                                 </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">);</span>
<span class="linenos">280</span>
<span class="linenos">281</span><span class="w">    </span><span class="n">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">mpd_y_kernel</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">inLattice</span><span class="p">,</span>
<span class="linenos">282</span><span class="w">                                 </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="o">*</span><span class="w"> </span><span class="n">inSites</span><span class="p">,</span>
<span class="linenos">283</span><span class="w">                                 </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">outLattice</span><span class="p">,</span>
<span class="linenos">284</span><span class="w">                                 </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">,</span>
<span class="linenos">285</span><span class="w">                                 </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">);</span>
<span class="linenos">286</span>
<span class="linenos">287</span><span class="w">    </span><span class="n">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">mpd_z_kernel</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">inLattice</span><span class="p">,</span>
<span class="linenos">288</span><span class="w">                                 </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="o">*</span><span class="w"> </span><span class="n">inSites</span><span class="p">,</span>
<span class="linenos">289</span><span class="w">                                 </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">outLattice</span><span class="p">,</span>
<span class="linenos">290</span><span class="w">                                 </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">,</span>
<span class="linenos">291</span><span class="w">                                 </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">);</span>
<span class="linenos">292</span>
<span class="linenos">293</span><span class="w">    </span><span class="cp">#ifdef MPD_GLOBAL_S_MATRIX</span>
<span class="linenos">294</span><span class="w">        </span><span class="cp">#ifdef MPD_GLOBAL_R_MATRIX</span>
<span class="linenos">295</span><span class="w">            </span><span class="n">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">reaction_kernel</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">inLattice</span><span class="p">,</span>
<span class="linenos">296</span><span class="w">                                            </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="o">*</span><span class="w"> </span><span class="n">inSites</span><span class="p">,</span>
<span class="linenos">297</span><span class="w">                                            </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">outLattice</span><span class="p">,</span>
<span class="linenos">298</span><span class="w">                                            </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">,</span>
<span class="linenos">299</span><span class="w">                                            </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">,</span>
<span class="linenos">300</span><span class="w">                                            </span><span class="k">const</span><span class="w"> </span><span class="kt">int8_t</span><span class="o">*</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="n">SG</span><span class="p">,</span>
<span class="linenos">301</span><span class="w">                                            </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="o">*</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="n">RLG</span><span class="p">,</span>
<span class="linenos">302</span><span class="w">                                            </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="n">reactionOrdersG</span><span class="p">,</span>
<span class="linenos">303</span><span class="w">                                            </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="n">reactionSitesG</span><span class="p">,</span>
<span class="linenos">304</span><span class="w">                                            </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="n">D1G</span><span class="p">,</span>
<span class="linenos">305</span><span class="w">                                            </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="n">D2G</span><span class="p">,</span>
<span class="linenos">306</span><span class="w">                                            </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="n">reactionRatesG</span><span class="p">);</span>
<span class="linenos">307</span><span class="w">        </span><span class="cp">#else</span>
<span class="linenos">308</span><span class="w">            </span><span class="n">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">reaction_kernel</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">inLattice</span><span class="p">,</span>
<span class="linenos">309</span><span class="w">                                            </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="o">*</span><span class="w"> </span><span class="n">inSites</span><span class="p">,</span>
<span class="linenos">310</span><span class="w">                                            </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">outLattice</span><span class="p">,</span>
<span class="linenos">311</span><span class="w">                                            </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">,</span>
<span class="linenos">312</span><span class="w">                                            </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">,</span>
<span class="linenos">313</span><span class="w">                                            </span><span class="k">const</span><span class="w"> </span><span class="kt">int8_t</span><span class="o">*</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="n">SG</span><span class="p">,</span>
<span class="linenos">314</span><span class="w">                                            </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="o">*</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="n">RLG</span><span class="p">);</span>
<span class="linenos">315</span><span class="w">        </span><span class="cp">#endif</span>
<span class="linenos">316</span><span class="w">    </span><span class="cp">#else</span>
<span class="linenos">317</span><span class="w">        </span><span class="n">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">reaction_kernel</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">inLattice</span><span class="p">,</span>
<span class="linenos">318</span><span class="w">                                        </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="o">*</span><span class="w"> </span><span class="n">inSites</span><span class="p">,</span>
<span class="linenos">319</span><span class="w">                                        </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">outLattice</span><span class="p">,</span>
<span class="linenos">320</span><span class="w">                                        </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">,</span>
<span class="linenos">321</span><span class="w">                                        </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">);</span>
<span class="linenos">322</span><span class="w">    </span><span class="cp">#endif</span>
<span class="linenos">323</span><span class="cp">#else</span>
<span class="linenos">324</span><span class="w">    </span><span class="n">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">mpd_x_kernel</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">inLattice</span><span class="p">,</span>
<span class="linenos">325</span><span class="w">                                 </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="o">*</span><span class="w"> </span><span class="n">inSites</span><span class="p">,</span>
<span class="linenos">326</span><span class="w">                                 </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">outLattice</span><span class="p">,</span>
<span class="linenos">327</span><span class="w">                                 </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">gridXSize</span><span class="p">,</span>
<span class="linenos">328</span><span class="w">                                 </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">,</span>
<span class="linenos">329</span><span class="w">                                 </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">);</span>
<span class="linenos">330</span>
<span class="linenos">331</span><span class="w">    </span><span class="n">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">mpd_y_kernel</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">inLattice</span><span class="p">,</span>
<span class="linenos">332</span><span class="w">                                 </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="o">*</span><span class="w"> </span><span class="n">inSites</span><span class="p">,</span>
<span class="linenos">333</span><span class="w">                                 </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">outLattice</span><span class="p">,</span>
<span class="linenos">334</span><span class="w">                                 </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">gridXSize</span><span class="p">,</span>
<span class="linenos">335</span><span class="w">                                 </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">,</span>
<span class="linenos">336</span><span class="w">                                 </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">);</span>
<span class="linenos">337</span>
<span class="linenos">338</span><span class="w">    </span><span class="n">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">mpd_z_kernel</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">inLattice</span><span class="p">,</span>
<span class="linenos">339</span><span class="w">                                 </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="o">*</span><span class="w"> </span><span class="n">inSites</span><span class="p">,</span>
<span class="linenos">340</span><span class="w">                                 </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">outLattice</span><span class="p">,</span>
<span class="linenos">341</span><span class="w">                                 </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">gridXSize</span><span class="p">,</span>
<span class="linenos">342</span><span class="w">                                 </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">,</span>
<span class="linenos">343</span><span class="w">                                 </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">);</span>
<span class="linenos">344</span>
<span class="linenos">345</span><span class="w">    </span><span class="cp">#ifdef MPD_GLOBAL_S_MATRIX</span>
<span class="linenos">346</span><span class="w">        </span><span class="cp">#ifdef MPD_GLOBAL_R_MATRIX</span>
<span class="linenos">347</span><span class="w">            </span><span class="n">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">reaction_kernel</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">inLattice</span><span class="p">,</span>
<span class="linenos">348</span><span class="w">                                            </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="o">*</span><span class="w"> </span><span class="n">inSites</span><span class="p">,</span>
<span class="linenos">349</span><span class="w">                                            </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">outLattice</span><span class="p">,</span>
<span class="linenos">350</span><span class="w">                                            </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">gridXSize</span><span class="p">,</span>
<span class="linenos">351</span><span class="w">                                            </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">,</span>
<span class="linenos">352</span><span class="w">                                            </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">,</span>
<span class="linenos">353</span><span class="w">                                            </span><span class="k">const</span><span class="w"> </span><span class="kt">int8_t</span><span class="o">*</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="n">SG</span><span class="p">,</span>
<span class="linenos">354</span><span class="w">                                            </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="o">*</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="n">RLG</span><span class="p">,</span>
<span class="linenos">355</span><span class="w">                                            </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="n">reactionOrdersG</span><span class="p">,</span>
<span class="linenos">356</span><span class="w">                                            </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="n">reactionSitesG</span><span class="p">,</span>
<span class="linenos">357</span><span class="w">                                            </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="n">D1G</span><span class="p">,</span>
<span class="linenos">358</span><span class="w">                                            </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="n">D2G</span><span class="p">,</span>
<span class="linenos">359</span><span class="w">                                            </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="n">reactionRatesG</span><span class="p">);</span>
<span class="linenos">360</span><span class="w">        </span><span class="cp">#else</span>
<span class="linenos">361</span><span class="w">            </span><span class="n">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">reaction_kernel</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">inLattice</span><span class="p">,</span>
<span class="linenos">362</span><span class="w">                                            </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="o">*</span><span class="w"> </span><span class="n">inSites</span><span class="p">,</span>
<span class="linenos">363</span><span class="w">                                            </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">outLattice</span><span class="p">,</span>
<span class="linenos">364</span><span class="w">                                            </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">gridXSize</span><span class="p">,</span>
<span class="linenos">365</span><span class="w">                                            </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">,</span>
<span class="linenos">366</span><span class="w">                                            </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">,</span>
<span class="linenos">367</span><span class="w">                                            </span><span class="k">const</span><span class="w"> </span><span class="kt">int8_t</span><span class="o">*</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="n">SG</span><span class="p">,</span>
<span class="linenos">368</span><span class="w">                                            </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="o">*</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="n">RLG</span><span class="p">);</span>
<span class="linenos">369</span><span class="w">        </span><span class="cp">#endif</span>
<span class="linenos">370</span><span class="w">    </span><span class="cp">#else</span>
<span class="linenos">371</span><span class="w">        </span><span class="n">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">reaction_kernel</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">inLattice</span><span class="p">,</span>
<span class="linenos">372</span><span class="w">                                        </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="o">*</span><span class="w"> </span><span class="n">inSites</span><span class="p">,</span>
<span class="linenos">373</span><span class="w">                                        </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">outLattice</span><span class="p">,</span>
<span class="linenos">374</span><span class="w">                                        </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">gridXSize</span><span class="p">,</span>
<span class="linenos">375</span><span class="w">                                        </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">,</span>
<span class="linenos">376</span><span class="w">                                        </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">);</span>
<span class="linenos">377</span><span class="w">    </span><span class="cp">#endif</span>
<span class="linenos">378</span><span class="cp">#endif</span>
<span class="linenos">379</span>
<span class="linenos">380</span><span class="n">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">correct_overflows</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">inLattice</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">);</span>
<span class="linenos">381</span><span class="n">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">correct_overflowsEV</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">inLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">evData</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">);</span>
<span class="linenos">382</span><span class="n">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">sanity_check</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">L1</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">L2</span><span class="p">);</span>
<span class="linenos">383</span>
<span class="linenos">384</span><span class="p">}</span>
<span class="linenos">385</span><span class="p">}</span>
<span class="linenos">386</span><span class="p">}</span>
<span class="linenos">387</span>
<span class="linenos">388</span><span class="cp">#endif</span>
</pre></div>
</div>
</section>
<section id="mpdrdmesolver-cu">
<h3>MpdRdmeSolver.cu<a class="headerlink" href="#mpdrdmesolver-cu" title="Link to this heading">#</a></h3>
<div class="highlight-cuda notranslate"><div class="highlight"><pre><span></span><span class="linenos">   1</span><span class="cm">/*</span>
<span class="linenos">   2</span><span class="cm"> * University of Illinois Open Source License</span>
<span class="linenos">   3</span><span class="cm"> * Copyright 2008-2018 Luthey-Schulten Group,</span>
<span class="linenos">   4</span><span class="cm"> * Copyright 2012 Roberts Group,</span>
<span class="linenos">   5</span><span class="cm"> * All rights reserved.</span>
<span class="linenos">   6</span><span class="cm"> * </span>
<span class="linenos">   7</span><span class="cm"> * Developed by: Luthey-Schulten Group</span>
<span class="linenos">   8</span><span class="cm"> *               University of Illinois at Urbana-Champaign</span>
<span class="linenos">   9</span><span class="cm"> *               http://www.scs.uiuc.edu/~schulten</span>
<span class="linenos">  10</span><span class="cm"> * </span>
<span class="linenos">  11</span><span class="cm"> * Developed by: Roberts Group</span>
<span class="linenos">  12</span><span class="cm"> *               Johns Hopkins University</span>
<span class="linenos">  13</span><span class="cm"> *               http://biophysics.jhu.edu/roberts/</span>
<span class="linenos">  14</span><span class="cm"> *</span>
<span class="linenos">  15</span><span class="cm"> * Permission is hereby granted, free of charge, to any person obtaining a copy of</span>
<span class="linenos">  16</span><span class="cm"> * this software and associated documentation files (the Software), to deal with </span>
<span class="linenos">  17</span><span class="cm"> * the Software without restriction, including without limitation the rights to </span>
<span class="linenos">  18</span><span class="cm"> * use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies </span>
<span class="linenos">  19</span><span class="cm"> * of the Software, and to permit persons to whom the Software is furnished to </span>
<span class="linenos">  20</span><span class="cm"> * do so, subject to the following conditions:</span>
<span class="linenos">  21</span><span class="cm"> * </span>
<span class="linenos">  22</span><span class="cm"> * - Redistributions of source code must retain the above copyright notice, </span>
<span class="linenos">  23</span><span class="cm"> * this list of conditions and the following disclaimers.</span>
<span class="linenos">  24</span><span class="cm"> * </span>
<span class="linenos">  25</span><span class="cm"> * - Redistributions in binary form must reproduce the above copyright notice, </span>
<span class="linenos">  26</span><span class="cm"> * this list of conditions and the following disclaimers in the documentation </span>
<span class="linenos">  27</span><span class="cm"> * and/or other materials provided with the distribution.</span>
<span class="linenos">  28</span><span class="cm"> * </span>
<span class="linenos">  29</span><span class="cm"> * - Neither the names of the Luthey-Schulten Group, University of Illinois at</span>
<span class="linenos">  30</span><span class="cm"> * Urbana-Champaign, the Roberts Group, Johns Hopkins University, nor the names</span>
<span class="linenos">  31</span><span class="cm"> * of its contributors may be used to endorse or promote products derived from</span>
<span class="linenos">  32</span><span class="cm"> * this Software without specific prior written permission.</span>
<span class="linenos">  33</span><span class="cm"> * </span>
<span class="linenos">  34</span><span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR </span>
<span class="linenos">  35</span><span class="cm"> * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, </span>
<span class="linenos">  36</span><span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL </span>
<span class="linenos">  37</span><span class="cm"> * THE CONTRIBUTORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR </span>
<span class="linenos">  38</span><span class="cm"> * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, </span>
<span class="linenos">  39</span><span class="cm"> * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR </span>
<span class="linenos">  40</span><span class="cm"> * OTHER DEALINGS WITH THE SOFTWARE.</span>
<span class="linenos">  41</span><span class="cm"> *</span>
<span class="linenos">  42</span><span class="cm"> * Author(s): Elijah Roberts, Zane Thornburg</span>
<span class="linenos">  43</span><span class="cm"> */</span>
<span class="linenos">  44</span>
<span class="linenos">  45</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;map&gt;</span>
<span class="linenos">  46</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;string&gt;</span>
<span class="linenos">  47</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;cstdlib&gt;</span>
<span class="linenos">  48</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;config.h&quot;</span>
<span class="linenos">  49</span><span class="cp">#if defined(MACOSX)</span>
<span class="linenos">  50</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;mach/mach_time.h&gt;</span>
<span class="linenos">  51</span><span class="cp">#elif defined(LINUX)</span>
<span class="linenos">  52</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;time.h&gt;</span>
<span class="linenos">  53</span><span class="cp">#endif</span>
<span class="linenos">  54</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;cuda/lm_cuda.h&quot;</span>
<span class="linenos">  55</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;cuda/ldg.h&quot;</span>
<span class="linenos">  56</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;core/Math.h&quot;</span>
<span class="linenos">  57</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;core/Print.h&quot;</span>
<span class="linenos">  58</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;cme/CMESolver.h&quot;</span>
<span class="linenos">  59</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;DiffusionModel.pb.h&quot;</span>
<span class="linenos">  60</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;Lattice.pb.h&quot;</span>
<span class="linenos">  61</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;SpeciesCounts.pb.h&quot;</span>
<span class="linenos">  62</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;core/DataOutputQueue.h&quot;</span>
<span class="linenos">  63</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;core/ResourceAllocator.h&quot;</span>
<span class="linenos">  64</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;rdme/ByteLattice.h&quot;</span>
<span class="linenos">  65</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;rdme/CudaByteLattice.h&quot;</span>
<span class="linenos">  66</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;rdme/MpdRdmeSolver.h&quot;</span>
<span class="linenos">  67</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;rng/RandomGenerator.h&quot;</span>
<span class="linenos">  68</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;lptf/Profile.h&quot;</span>
<span class="linenos">  69</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;sstream&gt;</span>
<span class="linenos">  70</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;core/Timer.h&quot;</span>
<span class="linenos">  71</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;io/ArbitraryH5.h&quot;</span>
<span class="linenos">  72</span>
<span class="linenos">  73</span><span class="cp">#define MPD_WORDS_PER_SITE    (MPD_LATTICE_MAX_OCCUPANCY / 4) </span><span class="c1">// 4 </span>
<span class="linenos">  74</span><span class="cp">#define MPD_APRON_SIZE        1</span>
<span class="linenos">  75</span>
<span class="linenos">  76</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;cuda/constant.cuh&quot;</span>
<span class="linenos">  77</span>
<span class="linenos">  78</span><span class="n">namespace</span><span class="w"> </span><span class="n">lm</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">  79</span><span class="n">namespace</span><span class="w"> </span><span class="n">rdme</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">  80</span><span class="n">namespace</span><span class="w"> </span><span class="n">mpdrdme_dev</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">  81</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;rdme/dev/xor_random_dev.cu&quot;</span>
<span class="linenos">  82</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;rdme/dev/lattice_sim_1d_dev.cu&quot;</span>
<span class="linenos">  83</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;rdme/dev/byte_diffusion_1d_dev.cu&quot;</span>
<span class="linenos">  84</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;rdme/dev/byte_reaction_dev.cu&quot;</span>
<span class="linenos">  85</span><span class="p">}}}</span>
<span class="linenos">  86</span>
<span class="linenos">  87</span><span class="k">extern</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">globalAbort</span><span class="p">;</span>
<span class="linenos">  88</span>
<span class="linenos">  89</span><span class="n">using</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="p">;</span>
<span class="linenos">  90</span><span class="n">using</span><span class="w"> </span><span class="n">lm</span><span class="o">::</span><span class="n">io</span><span class="o">::</span><span class="n">DiffusionModel</span><span class="p">;</span>
<span class="linenos">  91</span><span class="n">using</span><span class="w"> </span><span class="n">lm</span><span class="o">::</span><span class="n">rdme</span><span class="o">::</span><span class="n">Lattice</span><span class="p">;</span>
<span class="linenos">  92</span><span class="n">using</span><span class="w"> </span><span class="n">lm</span><span class="o">::</span><span class="n">rng</span><span class="o">::</span><span class="n">RandomGenerator</span><span class="p">;</span>
<span class="linenos">  93</span>
<span class="linenos">  94</span><span class="n">namespace</span><span class="w"> </span><span class="n">lm</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">  95</span><span class="n">namespace</span><span class="w"> </span><span class="n">rdme</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">  96</span>
<span class="linenos">  97</span><span class="n">MpdRdmeSolver</span><span class="o">::</span><span class="n">MpdRdmeSolver</span><span class="p">()</span>
<span class="linenos">  98</span><span class="o">:</span><span class="n">RDMESolver</span><span class="p">(</span><span class="n">lm</span><span class="o">::</span><span class="n">rng</span><span class="o">::</span><span class="n">RandomGenerator</span><span class="o">::</span><span class="n">NONE</span><span class="p">),</span>
<span class="linenos">  99</span><span class="w"> </span><span class="n">seed</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="n">tau</span><span class="p">(</span><span class="mf">0.0</span><span class="p">),</span>
<span class="linenos"> 100</span><span class="w"> </span><span class="n">cudaOverflowList</span><span class="p">(</span><span class="nb">NULL</span><span class="p">),</span><span class="w"> </span><span class="n">cudaStream</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
<span class="linenos"> 101</span><span class="w"> </span><span class="n">overflowTimesteps</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="n">overflowListUses</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
<span class="linenos"> 102</span><span class="w"> </span><span class="n">model_reactionRates</span><span class="p">(</span><span class="nb">NULL</span><span class="p">),</span>
<span class="linenos"> 103</span><span class="w"> </span><span class="n">zeroOrder</span><span class="p">(</span><span class="nb">NULL</span><span class="p">),</span><span class="w"> </span><span class="n">firstOrder</span><span class="p">(</span><span class="nb">NULL</span><span class="p">),</span><span class="w"> </span><span class="n">secondOrder</span><span class="p">(</span><span class="nb">NULL</span><span class="p">)</span>
<span class="linenos"> 104</span><span class="p">{</span>
<span class="linenos"> 105</span><span class="p">}</span>
<span class="linenos"> 106</span>
<span class="linenos"> 107</span><span class="kt">void</span><span class="w"> </span><span class="n">MpdRdmeSolver</span><span class="o">::</span><span class="n">initialize</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">replicate</span><span class="p">,</span><span class="w"> </span><span class="n">map</span><span class="o">&lt;</span><span class="n">string</span><span class="p">,</span><span class="n">string</span><span class="o">&gt;</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">parameters</span><span class="p">,</span><span class="w"> </span><span class="n">ResourceAllocator</span><span class="o">::</span><span class="n">ComputeResources</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">resources</span><span class="p">)</span>
<span class="linenos"> 108</span><span class="p">{</span>
<span class="linenos"> 109</span><span class="w">	</span><span class="n">RDMESolver</span><span class="o">::</span><span class="n">initialize</span><span class="p">(</span><span class="n">replicate</span><span class="p">,</span><span class="w"> </span><span class="n">parameters</span><span class="p">,</span><span class="w"> </span><span class="n">resources</span><span class="p">);</span>
<span class="linenos"> 110</span>
<span class="linenos"> 111</span><span class="w">    </span><span class="c1">// Figure out the random seed.</span>
<span class="linenos"> 112</span><span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">seedTop</span><span class="o">=</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="p">)</span><span class="n">atoi</span><span class="p">((</span><span class="o">*</span><span class="n">parameters</span><span class="p">)[</span><span class="s">&quot;seed&quot;</span><span class="p">].</span><span class="n">c_str</span><span class="p">());</span>
<span class="linenos"> 113</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">seedTop</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="linenos"> 114</span><span class="w">    </span><span class="p">{</span>
<span class="linenos"> 115</span><span class="w">        </span><span class="cp">#if defined(MACOSX)</span>
<span class="linenos"> 116</span><span class="w">        </span><span class="n">seedTop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span><span class="n">mach_absolute_time</span><span class="p">();</span>
<span class="linenos"> 117</span><span class="w">        </span><span class="cp">#elif defined(LINUX)</span>
<span class="linenos"> 118</span><span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">timespec</span><span class="w"> </span><span class="n">seed_timespec</span><span class="p">;</span>
<span class="linenos"> 119</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">clock_gettime</span><span class="p">(</span><span class="n">CLOCK_REALTIME</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">seed_timespec</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="n">throw</span><span class="w"> </span><span class="n">lm</span><span class="o">::</span><span class="n">Exception</span><span class="p">(</span><span class="s">&quot;Error getting time to use for random seed.&quot;</span><span class="p">);</span>
<span class="linenos"> 120</span><span class="w">        </span><span class="n">seedTop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">seed_timespec</span><span class="p">.</span><span class="n">tv_nsec</span><span class="p">;</span>
<span class="linenos"> 121</span><span class="w">        </span><span class="cp">#endif</span>
<span class="linenos"> 122</span><span class="w">    </span><span class="p">}</span>
<span class="linenos"> 123</span><span class="w">    </span><span class="n">seed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">seedTop</span><span class="o">&lt;&lt;</span><span class="mi">16</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="n">replicate</span><span class="o">&amp;</span><span class="mh">0x0000FFFF</span><span class="p">);</span>
<span class="linenos"> 124</span><span class="w">    </span><span class="n">Print</span><span class="o">::</span><span class="n">printf</span><span class="p">(</span><span class="n">Print</span><span class="o">::</span><span class="n">INFO</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;MPDRDME: Rng seed: top word %u, bottom word %u&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">seed</span><span class="o">&gt;&gt;</span><span class="mi">16</span><span class="p">)</span><span class="o">*</span><span class="mh">0xffff</span><span class="p">,</span><span class="w"> </span><span class="n">seed</span><span class="o">&amp;</span><span class="mh">0xFFFF</span><span class="p">);</span>
<span class="linenos"> 125</span>
<span class="linenos"> 126</span><span class="w">	</span><span class="n">string</span><span class="w"> </span><span class="o">&amp;</span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">parameters</span><span class="p">)[</span><span class="s">&quot;rdme.mpd.overflowhandler&quot;</span><span class="p">];</span>
<span class="linenos"> 127</span><span class="w">	</span><span class="k">if</span><span class="p">(</span><span class="n">s</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;classic&quot;</span><span class="p">)</span>
<span class="linenos"> 128</span><span class="w">	</span><span class="p">{</span>
<span class="linenos"> 129</span><span class="w">		</span><span class="n">overflow_handling</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">OVERFLOW_MODE_CLASSIC</span><span class="p">;</span>
<span class="linenos"> 130</span><span class="w">		</span><span class="n">Print</span><span class="o">::</span><span class="n">printf</span><span class="p">(</span><span class="n">Print</span><span class="o">::</span><span class="n">DEBUG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Overflow handler set to classic&quot;</span><span class="p">);</span>
<span class="linenos"> 131</span><span class="w">	</span><span class="p">}</span>
<span class="linenos"> 132</span><span class="w">	</span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="p">(</span><span class="n">s</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;relaxed&quot;</span><span class="p">)</span>
<span class="linenos"> 133</span><span class="w">	</span><span class="p">{</span>
<span class="linenos"> 134</span><span class="w">		</span><span class="n">overflow_handling</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">OVERFLOW_MODE_RELAXED</span><span class="p">;</span>
<span class="linenos"> 135</span><span class="w">		</span><span class="n">Print</span><span class="o">::</span><span class="n">printf</span><span class="p">(</span><span class="n">Print</span><span class="o">::</span><span class="n">DEBUG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Overflow handler set to relaxed&quot;</span><span class="p">);</span>
<span class="linenos"> 136</span><span class="w">	</span><span class="p">}</span>
<span class="linenos"> 137</span><span class="w">	</span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="p">(</span><span class="n">s</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">)</span>
<span class="linenos"> 138</span><span class="w">	</span><span class="p">{</span>
<span class="linenos"> 139</span><span class="w">		</span><span class="n">overflow_handling</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">OVERFLOW_MODE_CLASSIC</span><span class="p">;</span>
<span class="linenos"> 140</span><span class="w">		</span><span class="n">Print</span><span class="o">::</span><span class="n">printf</span><span class="p">(</span><span class="n">Print</span><span class="o">::</span><span class="n">DEBUG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Overflow handler set to default (classic)&quot;</span><span class="p">);</span>
<span class="linenos"> 141</span><span class="w">	</span><span class="p">}</span>
<span class="linenos"> 142</span><span class="w">	</span><span class="k">else</span>
<span class="linenos"> 143</span><span class="w">	</span><span class="p">{</span>
<span class="linenos"> 144</span><span class="w">		</span><span class="n">overflow_handling</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">OVERFLOW_MODE_CLASSIC</span><span class="p">;</span>
<span class="linenos"> 145</span><span class="w">		</span><span class="n">Print</span><span class="o">::</span><span class="n">printf</span><span class="p">(</span><span class="n">Print</span><span class="o">::</span><span class="n">WARNING</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Unknown overflow handler requested: &#39;%s&#39;&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
<span class="linenos"> 146</span><span class="w">	</span><span class="p">}</span>
<span class="linenos"> 147</span>
<span class="linenos"> 148</span><span class="w">	</span>
<span class="linenos"> 149</span><span class="w">	</span><span class="cp">#ifdef MPD_MAPPED_OVERFLOWS</span>
<span class="linenos"> 150</span><span class="w">	</span><span class="n">CUDA_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">cudaHostAlloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cudaOverflowList</span><span class="p">,</span>
<span class="linenos"> 151</span><span class="w">		</span><span class="n">MPD_OVERFLOW_LIST_SIZE</span><span class="p">,</span>
<span class="linenos"> 152</span><span class="w">		</span><span class="n">cudaHostAllocPortable</span><span class="o">|</span><span class="n">cudaHostAllocMapped</span><span class="p">));</span>
<span class="linenos"> 153</span><span class="w">	</span><span class="n">memset</span><span class="p">(</span><span class="n">cudaOverflowList</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">MPD_OVERFLOW_LIST_SIZE</span><span class="p">);</span>
<span class="linenos"> 154</span><span class="w">	</span><span class="cp">#else</span>
<span class="linenos"> 155</span><span class="w">    </span><span class="c1">// Allocate memory on the device for the exception list.</span>
<span class="linenos"> 156</span><span class="w">    </span><span class="n">CUDA_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">cudaMalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cudaOverflowList</span><span class="p">,</span><span class="w"> </span><span class="n">MPD_OVERFLOW_LIST_SIZE</span><span class="p">));</span><span class="w"> </span><span class="c1">//TODO: track memory usage.</span>
<span class="linenos"> 157</span><span class="w">    </span><span class="n">CUDA_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">cudaMemset</span><span class="p">(</span><span class="n">cudaOverflowList</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">MPD_OVERFLOW_LIST_SIZE</span><span class="p">));</span>
<span class="linenos"> 158</span><span class="w">	</span><span class="cp">#endif</span>
<span class="linenos"> 159</span>
<span class="linenos"> 160</span><span class="w">    </span><span class="c1">// Create a stream for synchronizing the events.</span>
<span class="linenos"> 161</span><span class="w">    </span><span class="n">CUDA_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">cudaStreamCreate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cudaStream</span><span class="p">));</span>
<span class="linenos"> 162</span><span class="p">}</span>
<span class="linenos"> 163</span>
<span class="linenos"> 164</span><span class="n">MpdRdmeSolver</span><span class="o">::~</span><span class="n">MpdRdmeSolver</span><span class="p">()</span>
<span class="linenos"> 165</span><span class="p">{</span>
<span class="linenos"> 166</span><span class="w">    </span><span class="c1">// Free any device memory.</span>
<span class="linenos"> 167</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cudaOverflowList</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span>
<span class="linenos"> 168</span><span class="w">    </span><span class="p">{</span>
<span class="linenos"> 169</span><span class="w">	</span><span class="cp">#ifdef MPD_MAPPED_OVERFLOWS</span>
<span class="linenos"> 170</span><span class="w">        </span><span class="n">CUDA_EXCEPTION_CHECK_NOTHROW</span><span class="p">(</span><span class="n">cudaFreeHost</span><span class="p">(</span><span class="n">cudaOverflowList</span><span class="p">));</span><span class="w"> </span><span class="c1">//TODO: track memory usage.</span>
<span class="linenos"> 171</span><span class="w">	</span><span class="cp">#else</span>
<span class="linenos"> 172</span><span class="w">        </span><span class="n">CUDA_EXCEPTION_CHECK_NOTHROW</span><span class="p">(</span><span class="n">cudaFree</span><span class="p">(</span><span class="n">cudaOverflowList</span><span class="p">));</span><span class="w"> </span><span class="c1">//TODO: track memory usage.</span>
<span class="linenos"> 173</span><span class="w">	</span><span class="cp">#endif</span>
<span class="linenos"> 174</span><span class="w">        </span><span class="n">cudaOverflowList</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="linenos"> 175</span><span class="w">    </span><span class="p">}</span>
<span class="linenos"> 176</span>
<span class="linenos"> 177</span><span class="w">    </span><span class="c1">// If we have created a stream, destroy it.</span>
<span class="linenos"> 178</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cudaStream</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="linenos"> 179</span><span class="w">    </span><span class="p">{</span>
<span class="linenos"> 180</span><span class="w">        </span><span class="n">CUDA_EXCEPTION_CHECK_NOTHROW</span><span class="p">(</span><span class="n">cudaStreamDestroy</span><span class="p">(</span><span class="n">cudaStream</span><span class="p">));</span>
<span class="linenos"> 181</span><span class="w">        </span><span class="n">cudaStream</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="linenos"> 182</span><span class="w">    </span><span class="p">}</span>
<span class="linenos"> 183</span>
<span class="linenos"> 184</span><span class="w">    </span><span class="c1">// Free allocated memory in MpdRdmeSolver</span>
<span class="linenos"> 185</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">model_reactionRates</span><span class="p">)</span><span class="w">  </span><span class="p">{</span><span class="n">delete</span><span class="p">[]</span><span class="w"> </span><span class="n">model_reactionRates</span><span class="p">;}</span>
<span class="linenos"> 186</span>
<span class="linenos"> 187</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">zeroOrder</span><span class="p">)</span><span class="w">   </span><span class="p">{</span><span class="n">delete</span><span class="p">[]</span><span class="w"> </span><span class="n">zeroOrder</span><span class="p">;}</span>
<span class="linenos"> 188</span><span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">firstOrder</span><span class="p">)</span><span class="w">  </span><span class="p">{</span><span class="n">delete</span><span class="p">[]</span><span class="w"> </span><span class="n">firstOrder</span><span class="p">;}</span>
<span class="linenos"> 189</span><span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">secondOrder</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="n">delete</span><span class="p">[]</span><span class="w"> </span><span class="n">secondOrder</span><span class="p">;}</span>
<span class="linenos"> 190</span><span class="p">}</span>
<span class="linenos"> 191</span>
<span class="linenos"> 192</span><span class="kt">void</span><span class="w"> </span><span class="n">MpdRdmeSolver</span><span class="o">::</span><span class="n">allocateLattice</span><span class="p">(</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">latticeXSize</span><span class="p">,</span><span class="w"> </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">latticeYSize</span><span class="p">,</span><span class="w"> </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">latticeZSize</span><span class="p">,</span><span class="w"> </span><span class="n">site_size_t</span><span class="w"> </span><span class="n">particlesPerSite</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">bytes_per_particle</span><span class="p">,</span><span class="w"> </span><span class="n">si_dist_t</span><span class="w"> </span><span class="n">latticeSpacing</span><span class="p">)</span>
<span class="linenos"> 193</span><span class="p">{</span>
<span class="linenos"> 194</span><span class="w">	</span><span class="n">assert</span><span class="p">(</span><span class="n">bytes_per_particle</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="linenos"> 195</span><span class="w">	</span><span class="k">if</span><span class="p">(</span><span class="n">particlesPerSite</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">MPD_LATTICE_MAX_OCCUPANCY</span><span class="p">)</span>
<span class="linenos"> 196</span><span class="w">	</span><span class="p">{</span>
<span class="linenos"> 197</span><span class="w">		</span><span class="n">Print</span><span class="o">::</span><span class="n">printf</span><span class="p">(</span><span class="n">Print</span><span class="o">::</span><span class="n">ERROR</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;requested allocation for %d particles per site is not %d&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">particlesPerSite</span><span class="p">,</span><span class="w"> </span><span class="n">MPD_LATTICE_MAX_OCCUPANCY</span><span class="p">);</span>
<span class="linenos"> 198</span><span class="w">		</span><span class="n">throw</span><span class="w"> </span><span class="n">Exception</span><span class="p">(</span><span class="s">&quot;incorrect particle density&quot;</span><span class="p">);</span>
<span class="linenos"> 199</span><span class="w">	</span><span class="p">}</span>
<span class="linenos"> 200</span>
<span class="linenos"> 201</span><span class="w">	</span><span class="k">if</span><span class="p">(</span><span class="n">latticeXSize</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">32</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="linenos"> 202</span><span class="w">	</span><span class="p">{</span>
<span class="linenos"> 203</span><span class="w">		</span><span class="n">Print</span><span class="o">::</span><span class="n">printf</span><span class="p">(</span><span class="n">Print</span><span class="o">::</span><span class="n">ERROR</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;The X dimension (%d) is not divisible by %d&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">latticeXSize</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="p">);</span>
<span class="linenos"> 204</span><span class="w">		</span><span class="n">throw</span><span class="w"> </span><span class="n">Exception</span><span class="p">(</span><span class="s">&quot;incorrect lattice dimensions&quot;</span><span class="p">);</span>
<span class="linenos"> 205</span><span class="w">	</span><span class="p">}</span>
<span class="linenos"> 206</span>
<span class="linenos"> 207</span><span class="w">	</span><span class="k">if</span><span class="p">(</span><span class="n">latticeYSize</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">TUNE_MPD_Y_BLOCK_Y_SIZE</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="linenos"> 208</span><span class="w">	</span><span class="p">{</span>
<span class="linenos"> 209</span><span class="w">		</span><span class="n">Print</span><span class="o">::</span><span class="n">printf</span><span class="p">(</span><span class="n">Print</span><span class="o">::</span><span class="n">ERROR</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;The Y dimension (%d) is not divisible by %d&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">latticeYSize</span><span class="p">,</span><span class="w"> </span><span class="n">TUNE_MPD_Y_BLOCK_Y_SIZE</span><span class="p">);</span>
<span class="linenos"> 210</span><span class="w">		</span><span class="n">throw</span><span class="w"> </span><span class="n">Exception</span><span class="p">(</span><span class="s">&quot;incorrect lattice dimensions&quot;</span><span class="p">);</span>
<span class="linenos"> 211</span><span class="w">	</span><span class="p">}</span>
<span class="linenos"> 212</span>
<span class="linenos"> 213</span><span class="w">	</span><span class="k">if</span><span class="p">(</span><span class="n">latticeZSize</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">TUNE_MPD_Z_BLOCK_Z_SIZE</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="linenos"> 214</span><span class="w">	</span><span class="p">{</span>
<span class="linenos"> 215</span><span class="w">		</span><span class="n">Print</span><span class="o">::</span><span class="n">printf</span><span class="p">(</span><span class="n">Print</span><span class="o">::</span><span class="n">ERROR</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;The Z dimension (%d) is not divisible by %d&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">latticeZSize</span><span class="p">,</span><span class="w"> </span><span class="n">TUNE_MPD_Z_BLOCK_Z_SIZE</span><span class="p">);</span>
<span class="linenos"> 216</span><span class="w">		</span><span class="n">throw</span><span class="w"> </span><span class="n">Exception</span><span class="p">(</span><span class="s">&quot;incorrect lattice dimensions&quot;</span><span class="p">);</span>
<span class="linenos"> 217</span><span class="w">	</span><span class="p">}</span>
<span class="linenos"> 218</span>
<span class="linenos"> 219</span><span class="w">	</span><span class="n">try</span>
<span class="linenos"> 220</span><span class="w">	</span><span class="p">{</span>
<span class="linenos"> 221</span><span class="w">		</span><span class="n">CudaByteLattice</span><span class="w"> </span><span class="o">*</span><span class="n">cbl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">CudaByteLattice</span><span class="p">(</span><span class="n">latticeXSize</span><span class="p">,</span><span class="w"> </span><span class="n">latticeYSize</span><span class="p">,</span><span class="w"> </span><span class="n">latticeZSize</span><span class="p">,</span><span class="w"> </span><span class="n">latticeSpacing</span><span class="p">,</span><span class="w"> </span><span class="n">particlesPerSite</span><span class="p">);</span>
<span class="linenos"> 222</span><span class="w">		</span><span class="n">lattice</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Lattice</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">cbl</span><span class="p">;</span>
<span class="linenos"> 223</span><span class="w">	</span><span class="p">}</span>
<span class="linenos"> 224</span><span class="w">	</span><span class="n">catch</span><span class="w"> </span><span class="p">(</span><span class="n">CUDAException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span>
<span class="linenos"> 225</span><span class="w">	</span><span class="p">{</span>
<span class="linenos"> 226</span><span class="w">		</span><span class="n">Print</span><span class="o">::</span><span class="n">printf</span><span class="p">(</span><span class="n">Print</span><span class="o">::</span><span class="n">ERROR</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">what</span><span class="p">());</span>
<span class="linenos"> 227</span><span class="w">		</span><span class="n">throw</span><span class="w"> </span><span class="n">Exception</span><span class="p">(</span><span class="s">&quot;Failed to create cuda lattice&quot;</span><span class="p">);</span>
<span class="linenos"> 228</span><span class="w">	</span><span class="p">}</span>
<span class="linenos"> 229</span>
<span class="linenos"> 230</span><span class="p">}</span>
<span class="linenos"> 231</span>
<span class="linenos"> 232</span><span class="kt">void</span><span class="w"> </span><span class="n">MpdRdmeSolver</span><span class="o">::</span><span class="n">buildModel</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">uint</span><span class="w"> </span><span class="n">numberSpeciesA</span><span class="p">,</span>
<span class="linenos"> 233</span><span class="w">                               </span><span class="k">const</span><span class="w"> </span><span class="n">uint</span><span class="w"> </span><span class="n">numberReactionsA</span><span class="p">,</span>
<span class="linenos"> 234</span><span class="w">                               </span><span class="k">const</span><span class="w"> </span><span class="n">uint</span><span class="o">*</span><span class="w"> </span><span class="n">initialSpeciesCountsA</span><span class="p">,</span>
<span class="linenos"> 235</span><span class="w">                               </span><span class="k">const</span><span class="w"> </span><span class="n">uint</span><span class="o">*</span><span class="w"> </span><span class="n">reactionTypesA</span><span class="p">,</span>
<span class="linenos"> 236</span><span class="w">                               </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="o">*</span><span class="w"> </span><span class="n">KA</span><span class="p">,</span>
<span class="linenos"> 237</span><span class="w">                               </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">SA</span><span class="p">,</span>
<span class="linenos"> 238</span><span class="w">                               </span><span class="k">const</span><span class="w"> </span><span class="n">uint</span><span class="o">*</span><span class="w"> </span><span class="n">DA</span><span class="p">,</span>
<span class="linenos"> 239</span><span class="w">                               </span><span class="k">const</span><span class="w"> </span><span class="n">uint</span><span class="w"> </span><span class="n">kCols</span><span class="p">)</span>
<span class="linenos"> 240</span><span class="p">{</span>
<span class="linenos"> 241</span><span class="w">    </span><span class="n">CMESolver</span><span class="o">::</span><span class="n">buildModel</span><span class="p">(</span><span class="n">numberSpeciesA</span><span class="p">,</span>
<span class="linenos"> 242</span><span class="w">                          </span><span class="n">numberReactionsA</span><span class="p">,</span>
<span class="linenos"> 243</span><span class="w">                          </span><span class="n">initialSpeciesCountsA</span><span class="p">,</span>
<span class="linenos"> 244</span><span class="w">                          </span><span class="n">reactionTypesA</span><span class="p">,</span>
<span class="linenos"> 245</span><span class="w">                          </span><span class="n">KA</span><span class="p">,</span><span class="w"> </span><span class="n">SA</span><span class="p">,</span><span class="w"> </span><span class="n">DA</span><span class="p">,</span><span class="w"> </span><span class="n">kCols</span><span class="p">);</span>
<span class="linenos"> 246</span>
<span class="linenos"> 247</span><span class="w">    </span><span class="c1">// Get the time step.</span>
<span class="linenos"> 248</span><span class="w">    </span><span class="n">tau</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">atof</span><span class="p">((</span><span class="o">*</span><span class="n">parameters</span><span class="p">)[</span><span class="s">&quot;timestep&quot;</span><span class="p">].</span><span class="n">c_str</span><span class="p">());</span>
<span class="linenos"> 249</span>
<span class="linenos"> 250</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tau</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">)</span>
<span class="linenos"> 251</span><span class="w">    </span><span class="p">{</span>
<span class="linenos"> 252</span><span class="w">        </span><span class="n">throw</span><span class="w"> </span><span class="n">InvalidArgException</span><span class="p">(</span><span class="s">&quot;timestep&quot;</span><span class="p">,</span>
<span class="linenos"> 253</span><span class="w">                                  </span><span class="s">&quot;A positive timestep must be specified for the solver.&quot;</span><span class="p">);</span>
<span class="linenos"> 254</span><span class="w">    </span><span class="p">}</span>
<span class="linenos"> 255</span>
<span class="linenos"> 256</span><span class="w">    </span><span class="c1">// Make sure we can support the reaction model.</span>
<span class="linenos"> 257</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">numberReactions</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">MPD_MAX_REACTION_TABLE_ENTRIES</span><span class="p">)</span><span class="w"> </span>
<span class="linenos"> 258</span><span class="w">    </span><span class="p">{</span>
<span class="linenos"> 259</span><span class="w">        </span><span class="n">throw</span><span class="w"> </span><span class="n">Exception</span><span class="p">(</span><span class="s">&quot;The number of reaction table entries exceeds the maximum supported by the solver.&quot;</span><span class="p">);</span>
<span class="linenos"> 260</span><span class="w">    </span><span class="p">}</span>
<span class="linenos"> 261</span>
<span class="linenos"> 262</span><span class="cp">#ifndef MPD_GLOBAL_S_MATRIX</span>
<span class="linenos"> 263</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">numberSpecies</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">numberReactions</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">MPD_MAX_S_MATRIX_ENTRIES</span><span class="p">)</span><span class="w"> </span>
<span class="linenos"> 264</span><span class="w">    </span><span class="p">{</span>
<span class="linenos"> 265</span><span class="w">        </span><span class="n">throw</span><span class="w"> </span><span class="n">Exception</span><span class="p">(</span><span class="s">&quot;The number of S matrix entries exceeds the maximum supported by the solver.&quot;</span><span class="p">);</span>
<span class="linenos"> 266</span><span class="w">    </span><span class="p">}</span>
<span class="linenos"> 267</span><span class="cp">#endif</span>
<span class="linenos"> 268</span>
<span class="linenos"> 269</span><span class="w">    </span><span class="c1">// Setup the cuda reaction model.</span>
<span class="linenos"> 270</span><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">reactionOrders</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="p">[</span><span class="n">numberReactions</span><span class="p">];</span>
<span class="linenos"> 271</span><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">reactionSites</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="p">[</span><span class="n">numberReactions</span><span class="p">];</span>
<span class="linenos"> 272</span><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">D1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="p">[</span><span class="n">numberReactions</span><span class="p">];</span>
<span class="linenos"> 273</span><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">D2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="p">[</span><span class="n">numberReactions</span><span class="p">];</span>
<span class="linenos"> 274</span>
<span class="linenos"> 275</span><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">numberReactions</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="linenos"> 276</span><span class="w">    </span><span class="p">{</span>
<span class="linenos"> 277</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">reactionTypes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ZerothOrderPropensityArgs</span><span class="o">::</span><span class="n">REACTION_TYPE</span><span class="p">)</span>
<span class="linenos"> 278</span><span class="w">        </span><span class="p">{</span>
<span class="linenos"> 279</span><span class="w">            </span><span class="n">reactionOrders</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MPD_ZERO_ORDER_REACTION</span><span class="p">;</span>
<span class="linenos"> 280</span><span class="w">        	</span><span class="n">reactionSites</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos"> 281</span><span class="w">        	</span><span class="n">D1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span>
<span class="linenos"> 282</span><span class="w">        	</span><span class="n">D2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos"> 283</span><span class="w">        </span><span class="p">}</span>
<span class="linenos"> 284</span><span class="w">    	</span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">reactionTypes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">FirstOrderPropensityArgs</span><span class="o">::</span><span class="n">REACTION_TYPE</span><span class="p">)</span>
<span class="linenos"> 285</span><span class="w">    	</span><span class="p">{</span>
<span class="linenos"> 286</span><span class="w">    		</span><span class="n">reactionOrders</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MPD_FIRST_ORDER_REACTION</span><span class="p">;</span>
<span class="linenos"> 287</span><span class="w">    		</span><span class="n">reactionSites</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos"> 288</span><span class="w">    		</span><span class="n">D1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="n">FirstOrderPropensityArgs</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">propensityFunctionArgs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">-&gt;</span><span class="n">si</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="linenos"> 289</span><span class="w">    		</span><span class="n">D2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos"> 290</span><span class="w">    	</span><span class="p">}</span>
<span class="linenos"> 291</span><span class="w">    	</span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">reactionTypes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">SecondOrderPropensityArgs</span><span class="o">::</span><span class="n">REACTION_TYPE</span><span class="p">)</span>
<span class="linenos"> 292</span><span class="w">    	</span><span class="p">{</span>
<span class="linenos"> 293</span><span class="w">    		</span><span class="n">reactionOrders</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MPD_SECOND_ORDER_REACTION</span><span class="p">;</span>
<span class="linenos"> 294</span><span class="w">    		</span><span class="n">reactionSites</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos"> 295</span><span class="w">    		</span><span class="n">D1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="n">SecondOrderPropensityArgs</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">propensityFunctionArgs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">-&gt;</span><span class="n">s1i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="linenos"> 296</span><span class="w">    		</span><span class="n">D2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="n">SecondOrderPropensityArgs</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">propensityFunctionArgs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">-&gt;</span><span class="n">s2i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="linenos"> 297</span><span class="w">    	</span><span class="p">}</span>
<span class="linenos"> 298</span><span class="w">    	</span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">reactionTypes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">SecondOrderSelfPropensityArgs</span><span class="o">::</span><span class="n">REACTION_TYPE</span><span class="p">)</span>
<span class="linenos"> 299</span><span class="w">    	</span><span class="p">{</span>
<span class="linenos"> 300</span><span class="w">    		</span><span class="n">reactionOrders</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MPD_SECOND_ORDER_SELF_REACTION</span><span class="p">;</span>
<span class="linenos"> 301</span><span class="w">    		</span><span class="n">reactionSites</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos"> 302</span><span class="w">    		</span><span class="n">D1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="n">SecondOrderSelfPropensityArgs</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">propensityFunctionArgs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">-&gt;</span><span class="n">si</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="linenos"> 303</span><span class="w">    		</span><span class="n">D2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos"> 304</span><span class="w">    	</span><span class="p">}</span>
<span class="linenos"> 305</span><span class="w">    	</span><span class="k">else</span>
<span class="linenos"> 306</span><span class="w">    	</span><span class="p">{</span>
<span class="linenos"> 307</span><span class="w">    		</span><span class="n">throw</span><span class="w"> </span><span class="n">InvalidArgException</span><span class="p">(</span><span class="s">&quot;reactionTypeA&quot;</span><span class="p">,</span>
<span class="linenos"> 308</span><span class="w">                                      </span><span class="s">&quot;the reaction type was not supported by the solver&quot;</span><span class="p">,</span>
<span class="linenos"> 309</span><span class="w">                                      </span><span class="n">reactionTypes</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="linenos"> 310</span><span class="w">    	</span><span class="p">}</span>
<span class="linenos"> 311</span><span class="w">    </span><span class="p">}</span>
<span class="linenos"> 312</span>
<span class="linenos"> 313</span><span class="w">    </span><span class="c1">// Setup the cuda S matrix.</span>
<span class="linenos"> 314</span><span class="w">	</span><span class="c1">// Transpose S on the device because we will want to read along the numSpecies axis</span>
<span class="linenos"> 315</span><span class="w">	</span><span class="c1">// Before A1A2A3A4A5 B1B2B3B4B5 C1C2C3C4C5 ...</span>
<span class="linenos"> 316</span><span class="w">	</span><span class="c1">// After A1B1C1 A2B2C2 ...</span>
<span class="linenos"> 317</span><span class="w">    </span><span class="kt">int8_t</span><span class="o">*</span><span class="w"> </span><span class="n">tmpS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="kt">int8_t</span><span class="p">[</span><span class="n">numberSpecies</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">numberReactions</span><span class="p">];</span>
<span class="linenos"> 318</span>
<span class="linenos"> 319</span><span class="w">	</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">rx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">rx</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">numberReactions</span><span class="p">;</span><span class="w"> </span><span class="n">rx</span><span class="o">++</span><span class="p">)</span>
<span class="linenos"> 320</span><span class="w">	</span><span class="p">{</span>
<span class="linenos"> 321</span><span class="w">		</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">numberSpecies</span><span class="p">;</span><span class="w"> </span><span class="n">p</span><span class="o">++</span><span class="p">)</span>
<span class="linenos"> 322</span><span class="w">		</span><span class="p">{</span>
<span class="linenos"> 323</span><span class="w">		    </span><span class="n">tmpS</span><span class="p">[(</span><span class="n">rx</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">numberSpecies</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">p</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">S</span><span class="p">[(</span><span class="n">numberReactions</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">rx</span><span class="p">];</span>
<span class="linenos"> 324</span><span class="w">		</span><span class="p">}</span>
<span class="linenos"> 325</span><span class="w">	</span><span class="p">}</span>
<span class="linenos"> 326</span>
<span class="linenos"> 327</span><span class="w">    </span><span class="n">cudaMemcpyToSymbol</span><span class="p">(</span><span class="n">numberReactionsC</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">numberReactions</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="p">));</span>
<span class="linenos"> 328</span>
<span class="linenos"> 329</span><span class="cp">#ifdef MPD_GLOBAL_R_MATRIX</span>
<span class="linenos"> 330</span><span class="w">    </span><span class="n">cudaMalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reactionOrdersG</span><span class="p">,</span><span class="w"> </span><span class="n">numberReactions</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="p">));</span>
<span class="linenos"> 331</span><span class="w">    </span><span class="n">cudaMemcpy</span><span class="p">(</span><span class="n">reactionOrdersG</span><span class="p">,</span><span class="w"> </span><span class="n">reactionOrders</span><span class="p">,</span><span class="w"> </span><span class="n">numberReactions</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="p">),</span><span class="w"> </span><span class="n">cudaMemcpyHostToDevice</span><span class="p">);</span>
<span class="linenos"> 332</span><span class="w">    </span><span class="n">cudaMalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reactionSitesG</span><span class="p">,</span><span class="w"> </span><span class="n">numberReactions</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="p">));</span>
<span class="linenos"> 333</span><span class="w">    </span><span class="n">cudaMemcpy</span><span class="p">(</span><span class="n">reactionSitesG</span><span class="p">,</span><span class="w"> </span><span class="n">reactionSites</span><span class="p">,</span><span class="w"> </span><span class="n">numberReactions</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="p">),</span><span class="w"> </span><span class="n">cudaMemcpyHostToDevice</span><span class="p">);</span>
<span class="linenos"> 334</span><span class="w">    </span><span class="n">cudaMalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">D1G</span><span class="p">,</span><span class="w"> </span><span class="n">numberReactions</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="p">));</span>
<span class="linenos"> 335</span><span class="w">    </span><span class="n">cudaMemcpy</span><span class="p">(</span><span class="n">D1G</span><span class="p">,</span><span class="w"> </span><span class="n">D1</span><span class="p">,</span><span class="w"> </span><span class="n">numberReactions</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="p">),</span><span class="w"> </span><span class="n">cudaMemcpyHostToDevice</span><span class="p">);</span>
<span class="linenos"> 336</span><span class="w">    </span><span class="n">cudaMalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">D2G</span><span class="p">,</span><span class="w"> </span><span class="n">numberReactions</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="p">));</span>
<span class="linenos"> 337</span><span class="w">    </span><span class="n">cudaMemcpy</span><span class="p">(</span><span class="n">D2G</span><span class="p">,</span><span class="w"> </span><span class="n">D2</span><span class="p">,</span><span class="w"> </span><span class="n">numberReactions</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="p">),</span><span class="w"> </span><span class="n">cudaMemcpyHostToDevice</span><span class="p">);</span>
<span class="linenos"> 338</span><span class="cp">#else</span>
<span class="linenos"> 339</span><span class="w">    </span><span class="n">cudaMemcpyToSymbol</span><span class="p">(</span><span class="n">reactionOrdersC</span><span class="p">,</span><span class="w"> </span><span class="n">reactionOrders</span><span class="p">,</span><span class="w"> </span><span class="n">numberReactions</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="p">));</span>
<span class="linenos"> 340</span><span class="w">    </span><span class="n">cudaMemcpyToSymbol</span><span class="p">(</span><span class="n">reactionSitesC</span><span class="p">,</span><span class="w">  </span><span class="n">reactionSites</span><span class="p">,</span><span class="w">  </span><span class="n">numberReactions</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="p">));</span>
<span class="linenos"> 341</span><span class="w">    </span><span class="n">cudaMemcpyToSymbol</span><span class="p">(</span><span class="n">D1C</span><span class="p">,</span><span class="w"> </span><span class="n">D1</span><span class="p">,</span><span class="w"> </span><span class="n">numberReactions</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="p">));</span>
<span class="linenos"> 342</span><span class="w">    </span><span class="n">cudaMemcpyToSymbol</span><span class="p">(</span><span class="n">D2C</span><span class="p">,</span><span class="w"> </span><span class="n">D2</span><span class="p">,</span><span class="w"> </span><span class="n">numberReactions</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="p">));</span>
<span class="linenos"> 343</span><span class="cp">#endif</span>
<span class="linenos"> 344</span>
<span class="linenos"> 345</span><span class="cp">#ifdef MPD_GLOBAL_S_MATRIX</span>
<span class="linenos"> 346</span><span class="w">	</span><span class="n">cudaMalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">SG</span><span class="p">,</span><span class="w"> </span><span class="n">numberSpecies</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">numberReactions</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int8_t</span><span class="p">));</span>
<span class="linenos"> 347</span><span class="w">	</span><span class="n">cudaMemcpy</span><span class="p">(</span><span class="n">SG</span><span class="p">,</span><span class="w"> </span><span class="n">tmpS</span><span class="p">,</span><span class="w"> </span><span class="n">numberSpecies</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">numberReactions</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int8_t</span><span class="p">),</span><span class="w"> </span><span class="n">cudaMemcpyHostToDevice</span><span class="p">);</span>
<span class="linenos"> 348</span><span class="cp">#else</span>
<span class="linenos"> 349</span><span class="w">    </span><span class="n">cudaMemcpyToSymbol</span><span class="p">(</span><span class="n">SC</span><span class="p">,</span><span class="w"> </span><span class="n">tmpS</span><span class="p">,</span><span class="w"> </span><span class="n">numberSpecies</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">numberReactions</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int8_t</span><span class="p">));</span>
<span class="linenos"> 350</span><span class="cp">#endif</span>
<span class="linenos"> 351</span>
<span class="linenos"> 352</span><span class="w">    </span><span class="c1">// Free any temporary resources.</span>
<span class="linenos"> 353</span><span class="w">    </span><span class="n">delete</span><span class="p">[]</span><span class="w"> </span><span class="n">reactionOrders</span><span class="p">;</span>
<span class="linenos"> 354</span><span class="w">    </span><span class="n">delete</span><span class="p">[]</span><span class="w"> </span><span class="n">reactionSites</span><span class="p">;</span>
<span class="linenos"> 355</span><span class="w">    </span><span class="n">delete</span><span class="p">[]</span><span class="w"> </span><span class="n">D1</span><span class="p">;</span>
<span class="linenos"> 356</span><span class="w">    </span><span class="n">delete</span><span class="p">[]</span><span class="w"> </span><span class="n">D2</span><span class="p">;</span>
<span class="linenos"> 357</span><span class="w">    </span><span class="n">delete</span><span class="p">[]</span><span class="w"> </span><span class="n">tmpS</span><span class="p">;</span>
<span class="linenos"> 358</span><span class="p">}</span>
<span class="linenos"> 359</span>
<span class="linenos"> 360</span><span class="kt">void</span><span class="w"> </span><span class="n">MpdRdmeSolver</span><span class="o">::</span><span class="n">buildDiffusionModel</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">uint</span><span class="w"> </span><span class="n">numberSiteTypesA</span><span class="p">,</span>
<span class="linenos"> 361</span><span class="w">                                        </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="o">*</span><span class="w"> </span><span class="n">DFA</span><span class="p">,</span>
<span class="linenos"> 362</span><span class="w">                                        </span><span class="k">const</span><span class="w"> </span><span class="n">uint</span><span class="o">*</span><span class="w"> </span><span class="n">RLA</span><span class="p">,</span>
<span class="linenos"> 363</span><span class="w">                                        </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">latticeXSize</span><span class="p">,</span>
<span class="linenos"> 364</span><span class="w">                                        </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">latticeYSize</span><span class="p">,</span>
<span class="linenos"> 365</span><span class="w">                                        </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">latticeZSize</span><span class="p">,</span>
<span class="linenos"> 366</span><span class="w">                                        </span><span class="n">site_size_t</span><span class="w"> </span><span class="n">particlesPerSite</span><span class="p">,</span>
<span class="linenos"> 367</span><span class="w">                                        </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">bytes_per_particle</span><span class="p">,</span>
<span class="linenos"> 368</span><span class="w">                                        </span><span class="n">si_dist_t</span><span class="w"> </span><span class="n">latticeSpacing</span><span class="p">,</span>
<span class="linenos"> 369</span><span class="w">                                        </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="o">*</span><span class="w"> </span><span class="n">latticeData</span><span class="p">,</span>
<span class="linenos"> 370</span><span class="w">                                        </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="o">*</span><span class="w"> </span><span class="n">latticeSitesData</span><span class="p">,</span>
<span class="linenos"> 371</span><span class="w">                                        </span><span class="kt">bool</span><span class="w"> </span><span class="n">rowMajorData</span><span class="p">)</span>
<span class="linenos"> 372</span><span class="p">{</span>
<span class="linenos"> 373</span><span class="w">    </span><span class="n">RDMESolver</span><span class="o">::</span><span class="n">buildDiffusionModel</span><span class="p">(</span><span class="n">numberSiteTypesA</span><span class="p">,</span><span class="w"> </span><span class="n">DFA</span><span class="p">,</span><span class="w"> </span><span class="n">RLA</span><span class="p">,</span>
<span class="linenos"> 374</span><span class="w">                                    </span><span class="n">latticeXSize</span><span class="p">,</span><span class="w"> </span><span class="n">latticeYSize</span><span class="p">,</span><span class="w"> </span><span class="n">latticeZSize</span><span class="p">,</span>
<span class="linenos"> 375</span><span class="w">                                    </span><span class="n">particlesPerSite</span><span class="p">,</span><span class="w"> </span><span class="n">bytes_per_particle</span><span class="p">,</span>
<span class="linenos"> 376</span><span class="w">                                    </span><span class="n">latticeSpacing</span><span class="p">,</span><span class="w"> </span><span class="n">latticeData</span><span class="p">,</span><span class="w"> </span><span class="n">latticeSitesData</span><span class="p">,</span>
<span class="linenos"> 377</span><span class="w">                                    </span><span class="n">rowMajorData</span><span class="p">);</span>
<span class="linenos"> 378</span>
<span class="linenos"> 379</span><span class="w">    </span><span class="c1">// Get the time step.</span>
<span class="linenos"> 380</span><span class="w">    </span><span class="n">tau</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">atof</span><span class="p">((</span><span class="o">*</span><span class="n">parameters</span><span class="p">)[</span><span class="s">&quot;timestep&quot;</span><span class="p">].</span><span class="n">c_str</span><span class="p">());</span>
<span class="linenos"> 381</span>
<span class="linenos"> 382</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tau</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">)</span>
<span class="linenos"> 383</span><span class="w">    </span><span class="p">{</span>
<span class="linenos"> 384</span><span class="w">        </span><span class="n">throw</span><span class="w"> </span><span class="n">InvalidArgException</span><span class="p">(</span><span class="s">&quot;timestep&quot;</span><span class="p">,</span>
<span class="linenos"> 385</span><span class="w">                                  </span><span class="s">&quot;A positive timestep must be specified for the solver.&quot;</span><span class="p">);</span>
<span class="linenos"> 386</span><span class="w">    </span><span class="p">}</span>
<span class="linenos"> 387</span>
<span class="linenos"> 388</span><span class="w">    </span><span class="c1">// Setup the cuda transition matrix.</span>
<span class="linenos"> 389</span><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">DFmatrixSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">numberSpecies</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">numberSiteTypes</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">numberSiteTypes</span><span class="p">;</span>
<span class="linenos"> 390</span>
<span class="linenos"> 391</span><span class="cp">#ifndef MPD_GLOBAL_T_MATRIX</span>
<span class="linenos"> 392</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">DFmatrixSize</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">MPD_MAX_TRANSITION_TABLE_ENTRIES</span><span class="p">)</span>
<span class="linenos"> 393</span><span class="w">    </span><span class="p">{</span>
<span class="linenos"> 394</span><span class="w">        </span><span class="n">throw</span><span class="w"> </span><span class="n">Exception</span><span class="p">(</span><span class="s">&quot;The number of transition table entries exceeds the maximum supported by the solver.&quot;</span><span class="p">);</span>
<span class="linenos"> 395</span><span class="w">    </span><span class="p">}</span>
<span class="linenos"> 396</span><span class="cp">#endif</span>
<span class="linenos"> 397</span>
<span class="linenos"> 398</span><span class="cp">#ifndef MPD_GLOBAL_S_MATRIX</span>
<span class="linenos"> 399</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">numberReactions</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">numberSiteTypes</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">MPD_MAX_RL_MATRIX_ENTRIES</span><span class="p">)</span>
<span class="linenos"> 400</span><span class="w">    </span><span class="p">{</span>
<span class="linenos"> 401</span><span class="w">        </span><span class="n">throw</span><span class="w"> </span><span class="n">Exception</span><span class="p">(</span><span class="s">&quot;The number of RL matrix entries exceeds the maximum supported by the solver.&quot;</span><span class="p">);</span>
<span class="linenos"> 402</span><span class="w">    </span><span class="p">}</span>
<span class="linenos"> 403</span><span class="cp">#endif</span>
<span class="linenos"> 404</span>
<span class="linenos"> 405</span><span class="w">    </span><span class="c1">// Calculate the probability from the diffusion coefficient and the lattice properties.</span>
<span class="linenos"> 406</span><span class="w">    </span><span class="cm">/*</span>
<span class="linenos"> 407</span><span class="cm">     * p0 = probability of staying at the site, q = probability of moving in plus or minus direction</span>
<span class="linenos"> 408</span><span class="cm">     *</span>
<span class="linenos"> 409</span><span class="cm">     * D=(1-p0)*lambda^2/2*tau</span>
<span class="linenos"> 410</span><span class="cm">     * q=(1-p0)/2</span>
<span class="linenos"> 411</span><span class="cm">     * D=2q*lambda^2/2*tau</span>
<span class="linenos"> 412</span><span class="cm">     * q=D*tau/lambda^2</span>
<span class="linenos"> 413</span><span class="cm">     */</span>
<span class="linenos"> 414</span><span class="w">    </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="kt">float</span><span class="p">[</span><span class="n">DFmatrixSize</span><span class="p">];</span>
<span class="linenos"> 415</span>
<span class="linenos"> 416</span><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">DFmatrixSize</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="linenos"> 417</span><span class="w">    </span><span class="p">{</span>
<span class="linenos"> 418</span><span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">q</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">DF</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">tau</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">pow</span><span class="p">(</span><span class="n">latticeSpacing</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">));</span>
<span class="linenos"> 419</span>
<span class="linenos"> 420</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">q</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0.50f</span><span class="p">)</span>
<span class="linenos"> 421</span><span class="w">        </span><span class="p">{</span>
<span class="linenos"> 422</span><span class="w">            </span><span class="n">throw</span><span class="w"> </span><span class="n">InvalidArgException</span><span class="p">(</span><span class="s">&quot;D&quot;</span><span class="p">,</span>
<span class="linenos"> 423</span><span class="w">                                      </span><span class="s">&quot;The specified diffusion coefficient is too high for the diffusion model.&quot;</span><span class="p">);</span>
<span class="linenos"> 424</span><span class="w">        </span><span class="p">}</span>
<span class="linenos"> 425</span>
<span class="linenos"> 426</span><span class="w">        </span><span class="n">T</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">q</span><span class="p">;</span>
<span class="linenos"> 427</span><span class="w">    </span><span class="p">}</span>
<span class="linenos"> 428</span>
<span class="linenos"> 429</span><span class="w">    </span><span class="c1">// Setup the cuda reaction location matrix.</span>
<span class="linenos"> 430</span><span class="w">    </span><span class="kt">uint8_t</span><span class="o">*</span><span class="w"> </span><span class="n">tmpRL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="kt">uint8_t</span><span class="p">[</span><span class="n">numberReactions</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">numberSiteTypes</span><span class="p">];</span>
<span class="linenos"> 431</span>
<span class="linenos"> 432</span><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">numberReactions</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">numberSiteTypes</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="linenos"> 433</span><span class="w">    </span><span class="p">{</span>
<span class="linenos"> 434</span><span class="w">    	</span><span class="n">tmpRL</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">RL</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="linenos"> 435</span><span class="w">    </span><span class="p">}</span>
<span class="linenos"> 436</span>
<span class="linenos"> 437</span><span class="cp">#ifdef MPD_GLOBAL_T_MATRIX</span>
<span class="linenos"> 438</span><span class="w">	</span><span class="n">cudaMalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">TG</span><span class="p">,</span><span class="w"> </span><span class="n">DFmatrixSize</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">));</span>
<span class="linenos"> 439</span><span class="w">	</span><span class="n">cudaMemcpy</span><span class="p">(</span><span class="n">TG</span><span class="p">,</span><span class="w"> </span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">DFmatrixSize</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">),</span><span class="w"> </span><span class="n">cudaMemcpyHostToDevice</span><span class="p">);</span>
<span class="linenos"> 440</span><span class="w">	</span><span class="n">cudaMemcpyToSymbol</span><span class="p">(</span><span class="n">TC</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">TG</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="o">*</span><span class="p">));</span>
<span class="linenos"> 441</span><span class="cp">#else</span>
<span class="linenos"> 442</span><span class="w">	</span><span class="n">cudaMemcpyToSymbol</span><span class="p">(</span><span class="n">TC</span><span class="p">,</span><span class="w"> </span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">DFmatrixSize</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">));</span>
<span class="linenos"> 443</span><span class="cp">#endif</span>
<span class="linenos"> 444</span>
<span class="linenos"> 445</span><span class="w">    </span><span class="n">cudaMemcpyToSymbol</span><span class="p">(</span><span class="n">numberSpeciesC</span><span class="p">,</span><span class="w">   </span><span class="o">&amp;</span><span class="n">numberSpecies</span><span class="p">,</span><span class="w">   </span><span class="k">sizeof</span><span class="p">(</span><span class="n">numberSpeciesC</span><span class="p">));</span>
<span class="linenos"> 446</span><span class="w">    </span><span class="n">cudaMemcpyToSymbol</span><span class="p">(</span><span class="n">numberSiteTypesC</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">numberSiteTypes</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">numberSiteTypesC</span><span class="p">));</span>
<span class="linenos"> 447</span>
<span class="linenos"> 448</span><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeXYSize</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">latticeXSize</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">latticeYSize</span><span class="p">;</span>
<span class="linenos"> 449</span><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeXYZSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">latticeXSize</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">latticeYSize</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">latticeZSize</span><span class="p">;</span>
<span class="linenos"> 450</span>
<span class="linenos"> 451</span><span class="w">    </span><span class="n">cudaMemcpyToSymbol</span><span class="p">(</span><span class="n">latticeXSizeC</span><span class="p">,</span><span class="w">   </span><span class="o">&amp;</span><span class="n">latticeXSize</span><span class="p">,</span><span class="w">   </span><span class="k">sizeof</span><span class="p">(</span><span class="n">latticeXSizeC</span><span class="p">));</span>
<span class="linenos"> 452</span><span class="w">    </span><span class="n">cudaMemcpyToSymbol</span><span class="p">(</span><span class="n">latticeYSizeC</span><span class="p">,</span><span class="w">   </span><span class="o">&amp;</span><span class="n">latticeYSize</span><span class="p">,</span><span class="w">   </span><span class="k">sizeof</span><span class="p">(</span><span class="n">latticeYSizeC</span><span class="p">));</span>
<span class="linenos"> 453</span><span class="w">    </span><span class="n">cudaMemcpyToSymbol</span><span class="p">(</span><span class="n">latticeZSizeC</span><span class="p">,</span><span class="w">   </span><span class="o">&amp;</span><span class="n">latticeZSize</span><span class="p">,</span><span class="w">   </span><span class="k">sizeof</span><span class="p">(</span><span class="n">latticeZSizeC</span><span class="p">));</span>
<span class="linenos"> 454</span><span class="w">    </span><span class="n">cudaMemcpyToSymbol</span><span class="p">(</span><span class="n">latticeXYSizeC</span><span class="p">,</span><span class="w">  </span><span class="o">&amp;</span><span class="n">latticeXYSize</span><span class="p">,</span><span class="w">  </span><span class="k">sizeof</span><span class="p">(</span><span class="n">latticeXYSizeC</span><span class="p">));</span>
<span class="linenos"> 455</span><span class="w">    </span><span class="n">cudaMemcpyToSymbol</span><span class="p">(</span><span class="n">latticeXYZSizeC</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">latticeXYZSize</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">latticeXYZSizeC</span><span class="p">));</span>
<span class="linenos"> 456</span>
<span class="linenos"> 457</span><span class="w">    </span><span class="n">cudaMemcpyToSymbol</span><span class="p">(</span><span class="n">global_latticeZSizeC</span><span class="p">,</span><span class="w">   </span><span class="o">&amp;</span><span class="n">latticeZSize</span><span class="p">,</span><span class="w">   </span><span class="k">sizeof</span><span class="p">(</span><span class="n">global_latticeZSizeC</span><span class="p">));</span>
<span class="linenos"> 458</span><span class="w">    </span><span class="n">cudaMemcpyToSymbol</span><span class="p">(</span><span class="n">global_latticeXYZSizeC</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">latticeXYZSize</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">global_latticeXYZSizeC</span><span class="p">));</span>
<span class="linenos"> 459</span>
<span class="linenos"> 460</span><span class="cp">#ifdef MPD_GLOBAL_S_MATRIX</span>
<span class="linenos"> 461</span><span class="w">    </span><span class="c1">// RL in global memory</span>
<span class="linenos"> 462</span><span class="w">	</span><span class="n">cudaMalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">RLG</span><span class="p">,</span><span class="w"> </span><span class="n">numberReactions</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">numberSiteTypes</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">uint8_t</span><span class="p">));</span>
<span class="linenos"> 463</span><span class="w">	</span><span class="n">cudaMemcpy</span><span class="p">(</span><span class="n">RLG</span><span class="p">,</span><span class="w"> </span><span class="n">tmpRL</span><span class="p">,</span><span class="w"> </span><span class="n">numberReactions</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">numberSiteTypes</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">uint8_t</span><span class="p">),</span><span class="w"> </span><span class="n">cudaMemcpyHostToDevice</span><span class="p">);</span>
<span class="linenos"> 464</span><span class="cp">#else</span>
<span class="linenos"> 465</span><span class="w">	</span><span class="c1">// RL in constant memory</span>
<span class="linenos"> 466</span><span class="w">    </span><span class="n">cudaMemcpyToSymbol</span><span class="p">(</span><span class="n">RLC</span><span class="p">,</span><span class="w"> </span><span class="n">tmpRL</span><span class="p">,</span><span class="w"> </span><span class="n">numberReactions</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">numberSiteTypes</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">uint8_t</span><span class="p">));</span>
<span class="linenos"> 467</span><span class="cp">#endif</span>
<span class="linenos"> 468</span>
<span class="linenos"> 469</span><span class="w">    </span><span class="n">delete</span><span class="p">[]</span><span class="w"> </span><span class="n">tmpRL</span><span class="p">;</span>
<span class="linenos"> 470</span><span class="w">    </span><span class="n">delete</span><span class="p">[]</span><span class="w"> </span><span class="n">T</span><span class="p">;</span>
<span class="linenos"> 471</span>
<span class="linenos"> 472</span><span class="w">    </span><span class="c1">// Set the cuda reaction model rates now that we have the subvolume size.</span>
<span class="linenos"> 473</span><span class="w">    </span><span class="n">model_reactionRates</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="kt">float</span><span class="p">[</span><span class="n">numberReactions</span><span class="p">];</span>
<span class="linenos"> 474</span>
<span class="linenos"> 475</span><span class="w">    </span><span class="c1">// Set up pre-configured propensity matrices</span>
<span class="linenos"> 476</span><span class="w">	</span><span class="n">zeroOrderSize</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">numberSiteTypes</span><span class="p">;</span>
<span class="linenos"> 477</span><span class="w">	</span><span class="n">firstOrderSize</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">numberSiteTypes</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">numberSpecies</span><span class="p">;</span>
<span class="linenos"> 478</span><span class="w">	</span><span class="n">secondOrderSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">numberSiteTypes</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">numberSpecies</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">numberSpecies</span><span class="p">;</span>
<span class="linenos"> 479</span>
<span class="linenos"> 480</span><span class="w">	</span><span class="n">zeroOrder</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="kt">float</span><span class="p">[</span><span class="n">zeroOrderSize</span><span class="p">];</span>
<span class="linenos"> 481</span><span class="w">	</span><span class="n">firstOrder</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="kt">float</span><span class="p">[</span><span class="n">firstOrderSize</span><span class="p">];</span>
<span class="linenos"> 482</span><span class="w">	</span><span class="n">secondOrder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="kt">float</span><span class="p">[</span><span class="n">secondOrderSize</span><span class="p">];</span>
<span class="linenos"> 483</span>
<span class="linenos"> 484</span><span class="cp">#ifdef MPD_GLOBAL_R_MATRIX</span>
<span class="linenos"> 485</span><span class="w">    </span><span class="n">cudaMalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reactionRatesG</span><span class="p">,</span><span class="w"> </span><span class="n">numberReactions</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">));</span>
<span class="linenos"> 486</span><span class="cp">#endif</span>
<span class="linenos"> 487</span><span class="w">		</span>
<span class="linenos"> 488</span><span class="w">	</span><span class="n">cudaMalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">propZeroOrder</span><span class="p">,</span><span class="w">   </span><span class="n">zeroOrderSize</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">));</span>
<span class="linenos"> 489</span><span class="w">	</span><span class="n">cudaMalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">propFirstOrder</span><span class="p">,</span><span class="w">  </span><span class="n">firstOrderSize</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">));</span>
<span class="linenos"> 490</span><span class="w">	</span><span class="n">cudaMalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">propSecondOrder</span><span class="p">,</span><span class="w"> </span><span class="n">secondOrderSize</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">));</span>
<span class="linenos"> 491</span>
<span class="linenos"> 492</span><span class="w">    </span><span class="n">computePropensities</span><span class="p">();</span>
<span class="linenos"> 493</span><span class="w">    </span><span class="n">copyModelsToDevice</span><span class="p">();</span>
<span class="linenos"> 494</span><span class="w">	</span><span class="n">reactionModelModified</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="linenos"> 495</span><span class="p">}</span>
<span class="linenos"> 496</span>
<span class="linenos"> 497</span><span class="kt">void</span><span class="w"> </span><span class="n">MpdRdmeSolver</span><span class="o">::</span><span class="n">generateTrajectory</span><span class="p">()</span>
<span class="linenos"> 498</span><span class="p">{</span>
<span class="linenos"> 499</span><span class="w">    </span><span class="c1">// Shadow the lattice member as a cuda lattice.</span>
<span class="linenos"> 500</span><span class="w">    </span><span class="n">CudaByteLattice</span><span class="o">*</span><span class="w"> </span><span class="n">lattice</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="n">CudaByteLattice</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">this</span><span class="o">-&gt;</span><span class="n">lattice</span><span class="p">);</span>
<span class="linenos"> 501</span>
<span class="linenos"> 502</span><span class="w">   </span><span class="c1">// Get the interval for writing species counts and lattices.</span>
<span class="linenos"> 503</span><span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">speciesCountsWriteInterval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">atol</span><span class="p">((</span><span class="o">*</span><span class="n">parameters</span><span class="p">)[</span><span class="s">&quot;writeInterval&quot;</span><span class="p">].</span><span class="n">c_str</span><span class="p">());</span>
<span class="linenos"> 504</span><span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">nextSpeciesCountsWriteTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">speciesCountsWriteInterval</span><span class="p">;</span>
<span class="linenos"> 505</span>
<span class="linenos"> 506</span><span class="w">	</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">latticeWriteInterval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">atol</span><span class="p">((</span><span class="o">*</span><span class="n">parameters</span><span class="p">)[</span><span class="s">&quot;latticeWriteInterval&quot;</span><span class="p">].</span><span class="n">c_str</span><span class="p">());</span>
<span class="linenos"> 507</span><span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">nextLatticeWriteTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">latticeWriteInterval</span><span class="p">;</span>
<span class="linenos"> 508</span>
<span class="linenos"> 509</span><span class="w">	</span><span class="n">lm</span><span class="o">::</span><span class="n">io</span><span class="o">::</span><span class="n">Lattice</span><span class="w"> </span><span class="n">latticeDataSet</span><span class="p">;</span>
<span class="linenos"> 510</span><span class="w">    </span><span class="n">lm</span><span class="o">::</span><span class="n">io</span><span class="o">::</span><span class="n">SpeciesCounts</span><span class="w"> </span><span class="n">speciesCountsDataSet</span><span class="p">;</span>
<span class="linenos"> 511</span><span class="w">    </span><span class="n">speciesCountsDataSet</span><span class="p">.</span><span class="n">set_number_species</span><span class="p">(</span><span class="n">numberSpeciesToTrack</span><span class="p">);</span>
<span class="linenos"> 512</span><span class="w">    </span><span class="n">speciesCountsDataSet</span><span class="p">.</span><span class="n">set_number_entries</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="linenos"> 513</span>
<span class="linenos"> 514</span><span class="w">    </span><span class="c1">// Get the simulation time limit.</span>
<span class="linenos"> 515</span><span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">maxTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">atof</span><span class="p">((</span><span class="o">*</span><span class="n">parameters</span><span class="p">)[</span><span class="s">&quot;maxTime&quot;</span><span class="p">].</span><span class="n">c_str</span><span class="p">());</span>
<span class="linenos"> 516</span>
<span class="linenos"> 517</span><span class="w">    </span><span class="c1">// Set the initial time.</span>
<span class="linenos"> 518</span><span class="w">	</span><span class="kt">double</span><span class="w"> </span><span class="n">time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>
<span class="linenos"> 519</span><span class="w">	</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">current_timestep</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos"> 520</span>
<span class="linenos"> 521</span><span class="w">    </span><span class="kt">bool</span><span class="w">     </span><span class="n">hookEnabled</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="linenos"> 522</span><span class="w">	</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">hookInterval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos"> 523</span><span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">nextHookTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos"> 524</span>
<span class="linenos"> 525</span><span class="w">	</span><span class="c1">// Find out at what interval to hook simulations</span>
<span class="linenos"> 526</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="o">*</span><span class="n">parameters</span><span class="p">)[</span><span class="s">&quot;hookInterval&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">)</span>
<span class="linenos"> 527</span><span class="w">    </span><span class="p">{</span>
<span class="linenos"> 528</span><span class="w">		</span><span class="n">hookEnabled</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="linenos"> 529</span><span class="w">        </span><span class="n">hookInterval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">atol</span><span class="p">((</span><span class="o">*</span><span class="n">parameters</span><span class="p">)[</span><span class="s">&quot;hookInterval&quot;</span><span class="p">].</span><span class="n">c_str</span><span class="p">());</span>
<span class="linenos"> 530</span><span class="w">        </span><span class="n">nextHookTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hookInterval</span><span class="p">;</span>
<span class="linenos"> 531</span><span class="w">    </span><span class="p">}</span>
<span class="linenos"> 532</span>
<span class="linenos"> 533</span><span class="w">	</span><span class="c1">// Find out at what interval to write status messages</span>
<span class="linenos"> 534</span><span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">printPerfInterval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">60</span><span class="p">;</span>
<span class="linenos"> 535</span>
<span class="linenos"> 536</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="o">*</span><span class="n">parameters</span><span class="p">)[</span><span class="s">&quot;perfPrintInterval&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">)</span>
<span class="linenos"> 537</span><span class="w">    </span><span class="p">{</span>
<span class="linenos"> 538</span><span class="w">    	</span><span class="n">printPerfInterval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">atof</span><span class="p">((</span><span class="o">*</span><span class="n">parameters</span><span class="p">)[</span><span class="s">&quot;perfPrintInterval&quot;</span><span class="p">].</span><span class="n">c_str</span><span class="p">());</span>
<span class="linenos"> 539</span><span class="w">    </span><span class="p">}</span>
<span class="linenos"> 540</span>
<span class="linenos"> 541</span><span class="w">	</span><span class="c1">// Call beginning hook. Any modifications to the lattice will be</span>
<span class="linenos"> 542</span><span class="w">	</span><span class="c1">// accounted for because we have not yet copied to device memory;</span>
<span class="linenos"> 543</span><span class="w">	</span><span class="c1">// thus we do not need to check return value</span>
<span class="linenos"> 544</span><span class="w">	</span><span class="n">onBeginTrajectory</span><span class="p">(</span><span class="n">lattice</span><span class="p">);</span>
<span class="linenos"> 545</span>
<span class="linenos"> 546</span><span class="w">    </span><span class="c1">// Synchronize the cuda memory.</span>
<span class="linenos"> 547</span><span class="w">    </span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">copyToGPU</span><span class="p">();</span>
<span class="linenos"> 548</span>
<span class="linenos"> 549</span><span class="w">    </span><span class="c1">// Record the initial species counts.</span>
<span class="linenos"> 550</span><span class="w">    </span><span class="n">recordSpeciesCounts</span><span class="p">(</span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="n">lattice</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">speciesCountsDataSet</span><span class="p">);</span>
<span class="linenos"> 551</span>
<span class="linenos"> 552</span><span class="w">    </span><span class="c1">// Write the initial lattice.</span>
<span class="linenos"> 553</span><span class="w">    </span><span class="n">writeLatticeData</span><span class="p">(</span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="n">lattice</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">latticeDataSet</span><span class="p">);</span>
<span class="linenos"> 554</span>
<span class="linenos"> 555</span><span class="w">    </span><span class="n">Timer</span><span class="w"> </span><span class="n">timer</span><span class="p">;</span>
<span class="linenos"> 556</span><span class="w">    </span><span class="n">timer</span><span class="p">.</span><span class="n">tick</span><span class="p">();</span>
<span class="linenos"> 557</span>
<span class="linenos"> 558</span><span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">lastT</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos"> 559</span><span class="w">    </span><span class="kt">int</span><span class="w">    </span><span class="n">lastSteps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos"> 560</span>
<span class="linenos"> 561</span><span class="w">    </span><span class="c1">// Perform an initial hook check</span>
<span class="linenos"> 562</span><span class="w">    </span><span class="n">hookCheckSimulation</span><span class="p">(</span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="n">lattice</span><span class="p">);</span>
<span class="linenos"> 563</span>
<span class="linenos"> 564</span><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">time</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">maxTime</span><span class="p">)</span>
<span class="linenos"> 565</span><span class="w">    </span><span class="p">{</span>
<span class="linenos"> 566</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">globalAbort</span><span class="p">)</span>
<span class="linenos"> 567</span><span class="w">		</span><span class="p">{</span>
<span class="linenos"> 568</span><span class="w">			</span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Global abort: terminating solver</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="linenos"> 569</span><span class="w">			</span><span class="k">break</span><span class="p">;</span>
<span class="linenos"> 570</span><span class="w">		</span><span class="p">}</span>
<span class="linenos"> 571</span>
<span class="linenos"> 572</span><span class="w">        </span><span class="n">lastT</span><span class="w">     </span><span class="o">+=</span><span class="w"> </span><span class="n">timer</span><span class="p">.</span><span class="n">tock</span><span class="p">();</span>
<span class="linenos"> 573</span><span class="w">        </span><span class="n">lastSteps</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="linenos"> 574</span>
<span class="linenos"> 575</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">lastT</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">printPerfInterval</span><span class="p">)</span>
<span class="linenos"> 576</span><span class="w">        </span><span class="p">{</span>
<span class="linenos"> 577</span><span class="w">            </span><span class="kt">double</span><span class="w"> </span><span class="n">stepTime</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="n">lastT</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">lastSteps</span><span class="p">;</span>
<span class="linenos"> 578</span><span class="w">            </span><span class="kt">double</span><span class="w"> </span><span class="n">completionTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stepTime</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">maxTime</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">time</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">tau</span><span class="p">;</span>
<span class="linenos"> 579</span>
<span class="linenos"> 580</span><span class="w">            </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">units</span><span class="p">;</span>
<span class="linenos"> 581</span>
<span class="linenos"> 582</span><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">completionTime</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">60</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">60</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">24</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">365</span><span class="p">)</span>
<span class="linenos"> 583</span><span class="w">            </span><span class="p">{</span>
<span class="linenos"> 584</span><span class="w">                </span><span class="n">units</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;weeks&quot;</span><span class="p">;</span>
<span class="linenos"> 585</span><span class="w">                </span><span class="n">completionTime</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="mi">60</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">60</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">24</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">365</span><span class="p">;</span>
<span class="linenos"> 586</span><span class="w">            </span><span class="p">}</span>
<span class="linenos"> 587</span><span class="w">            </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">completionTime</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">60</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">60</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">24</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">30</span><span class="p">)</span>
<span class="linenos"> 588</span><span class="w">            </span><span class="p">{</span>
<span class="linenos"> 589</span><span class="w">                </span><span class="n">units</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;months&quot;</span><span class="p">;</span>
<span class="linenos"> 590</span><span class="w">                </span><span class="n">completionTime</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="mi">60</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">60</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">24</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">30</span><span class="p">;</span>
<span class="linenos"> 591</span><span class="w">            </span><span class="p">}</span>
<span class="linenos"> 592</span><span class="w">            </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">completionTime</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">60</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">60</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">24</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">7</span><span class="p">)</span>
<span class="linenos"> 593</span><span class="w">            </span><span class="p">{</span>
<span class="linenos"> 594</span><span class="w">                </span><span class="n">units</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;weeks&quot;</span><span class="p">;</span>
<span class="linenos"> 595</span><span class="w">                </span><span class="n">completionTime</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="mi">60</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">60</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">24</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">7</span><span class="p">;</span>
<span class="linenos"> 596</span><span class="w">            </span><span class="p">}</span>
<span class="linenos"> 597</span><span class="w">            </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">completionTime</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">60</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">60</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">24</span><span class="p">)</span>
<span class="linenos"> 598</span><span class="w">            </span><span class="p">{</span>
<span class="linenos"> 599</span><span class="w">                </span><span class="n">units</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;days&quot;</span><span class="p">;</span>
<span class="linenos"> 600</span><span class="w">                </span><span class="n">completionTime</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="mi">60</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">60</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">24</span><span class="p">;</span>
<span class="linenos"> 601</span><span class="w">            </span><span class="p">}</span>
<span class="linenos"> 602</span><span class="w">            </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">completionTime</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">60</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">60</span><span class="p">)</span>
<span class="linenos"> 603</span><span class="w">            </span><span class="p">{</span>
<span class="linenos"> 604</span><span class="w">                </span><span class="n">units</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;hours&quot;</span><span class="p">;</span>
<span class="linenos"> 605</span><span class="w">                </span><span class="n">completionTime</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="mi">60</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">60</span><span class="p">;</span>
<span class="linenos"> 606</span><span class="w">            </span><span class="p">}</span>
<span class="linenos"> 607</span><span class="w">            </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">completionTime</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">60</span><span class="p">)</span>
<span class="linenos"> 608</span><span class="w">            </span><span class="p">{</span>
<span class="linenos"> 609</span><span class="w">                </span><span class="n">units</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;minutes&quot;</span><span class="p">;</span>
<span class="linenos"> 610</span><span class="w">                </span><span class="n">completionTime</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="mi">60</span><span class="p">;</span>
<span class="linenos"> 611</span><span class="w">            </span><span class="p">}</span>
<span class="linenos"> 612</span><span class="w">            </span><span class="k">else</span>
<span class="linenos"> 613</span><span class="w">            </span><span class="p">{</span>
<span class="linenos"> 614</span><span class="w">                </span><span class="n">units</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;seconds&quot;</span><span class="p">;</span>
<span class="linenos"> 615</span><span class="w">            </span><span class="p">}</span>
<span class="linenos"> 616</span>
<span class="linenos"> 617</span><span class="w">            </span><span class="n">Print</span><span class="o">::</span><span class="n">printf</span><span class="p">(</span><span class="n">Print</span><span class="o">::</span><span class="n">INFO</span><span class="p">,</span>
<span class="linenos"> 618</span><span class="w">                          </span><span class="s">&quot;Average walltime per timestep: %.2f ms. &quot;</span>
<span class="linenos"> 619</span><span class="w">                          </span><span class="s">&quot;Progress: %.4fs/%.4fs (% .3g%% done / %.2g %s walltime remaining)&quot;</span><span class="p">,</span>
<span class="linenos"> 620</span><span class="w">                          </span><span class="mf">1000.0</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">stepTime</span><span class="p">,</span><span class="w"> </span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="n">maxTime</span><span class="p">,</span><span class="w"> </span><span class="mf">100.0</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">time</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">maxTime</span><span class="p">,</span>
<span class="linenos"> 621</span><span class="w">                          </span><span class="n">completionTime</span><span class="p">,</span><span class="w"> </span><span class="n">units</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
<span class="linenos"> 622</span>
<span class="linenos"> 623</span><span class="w">            </span><span class="n">lastT</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos"> 624</span><span class="w">            </span><span class="n">lastSteps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos"> 625</span><span class="w">        </span><span class="p">}</span>
<span class="linenos"> 626</span>
<span class="linenos"> 627</span><span class="w">        </span><span class="n">timer</span><span class="p">.</span><span class="n">tick</span><span class="p">();</span>
<span class="linenos"> 628</span>
<span class="linenos"> 629</span><span class="w">        </span><span class="c1">// Run the next timestep.</span>
<span class="linenos"> 630</span><span class="w">        </span><span class="n">runTimestep</span><span class="p">(</span><span class="n">lattice</span><span class="p">,</span><span class="w"> </span><span class="n">current_timestep</span><span class="o">++</span><span class="p">);</span>
<span class="linenos"> 631</span>
<span class="linenos"> 632</span><span class="w">        </span><span class="c1">// Update the time.</span>
<span class="linenos"> 633</span><span class="w">	    </span><span class="n">time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">current_timestep</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">tau</span><span class="p">;</span>
<span class="linenos"> 634</span>
<span class="linenos"> 635</span><span class="w">	    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">current_timestep</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">nextLatticeWriteTime</span><span class="w"> </span><span class="o">||</span>
<span class="linenos"> 636</span><span class="w">            </span><span class="n">current_timestep</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">nextSpeciesCountsWriteTime</span><span class="w"> </span><span class="o">||</span>
<span class="linenos"> 637</span><span class="w">            </span><span class="p">(</span><span class="n">hookEnabled</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">current_timestep</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">nextHookTime</span><span class="p">))</span>
<span class="linenos"> 638</span><span class="w">        </span><span class="p">{</span>
<span class="linenos"> 639</span><span class="w">            </span><span class="n">reactionModelModified</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="linenos"> 640</span>
<span class="linenos"> 641</span><span class="w">            </span><span class="c1">// Synchronize the lattice.</span>
<span class="linenos"> 642</span><span class="w">            </span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">copyFromGPU</span><span class="p">();</span>
<span class="linenos"> 643</span>
<span class="linenos"> 644</span><span class="w">            </span><span class="c1">// Check if we need to execute the hook</span>
<span class="linenos"> 645</span><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">hookEnabled</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">current_timestep</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">nextHookTime</span><span class="p">)</span>
<span class="linenos"> 646</span><span class="w">            </span><span class="p">{</span>
<span class="linenos"> 647</span><span class="w">                </span><span class="n">hookCheckSimulation</span><span class="p">(</span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="n">lattice</span><span class="p">);</span>
<span class="linenos"> 648</span><span class="w">                </span><span class="n">nextHookTime</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">hookInterval</span><span class="p">;</span>
<span class="linenos"> 649</span><span class="w">            </span><span class="p">}</span>
<span class="linenos"> 650</span>
<span class="linenos"> 651</span><span class="w">	        </span><span class="c1">// See if we need to write the lattice.</span>
<span class="linenos"> 652</span><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">current_timestep</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">nextLatticeWriteTime</span><span class="p">)</span>
<span class="linenos"> 653</span><span class="w">            </span><span class="p">{</span>
<span class="linenos"> 654</span><span class="w">                </span><span class="n">writeLatticeData</span><span class="p">(</span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="n">lattice</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">latticeDataSet</span><span class="p">);</span>
<span class="linenos"> 655</span><span class="w">                </span><span class="n">nextLatticeWriteTime</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">latticeWriteInterval</span><span class="p">;</span>
<span class="linenos"> 656</span><span class="w">            </span><span class="p">}</span>
<span class="linenos"> 657</span>
<span class="linenos"> 658</span><span class="w">            </span><span class="c1">// See if we need to write the species counts.</span>
<span class="linenos"> 659</span><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">current_timestep</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">nextSpeciesCountsWriteTime</span><span class="p">)</span>
<span class="linenos"> 660</span><span class="w">            </span><span class="p">{</span>
<span class="linenos"> 661</span><span class="w">                </span><span class="n">recordSpeciesCounts</span><span class="p">(</span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="n">lattice</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">speciesCountsDataSet</span><span class="p">);</span>
<span class="linenos"> 662</span><span class="w">                </span><span class="n">nextSpeciesCountsWriteTime</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">speciesCountsWriteInterval</span><span class="p">;</span>
<span class="linenos"> 663</span>
<span class="linenos"> 664</span><span class="w">                </span><span class="c1">// See if we have accumulated enough species counts to send.</span>
<span class="linenos"> 665</span><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">speciesCountsDataSet</span><span class="p">.</span><span class="n">number_entries</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">TUNE_SPECIES_COUNTS_BUFFER_SIZE</span><span class="p">)</span>
<span class="linenos"> 666</span><span class="w">                </span><span class="p">{</span>
<span class="linenos"> 667</span><span class="w">                    </span><span class="n">writeSpeciesCounts</span><span class="p">(</span><span class="o">&amp;</span><span class="n">speciesCountsDataSet</span><span class="p">);</span>
<span class="linenos"> 668</span><span class="w">                </span><span class="p">}</span>
<span class="linenos"> 669</span><span class="w">            </span><span class="p">}</span>
<span class="linenos"> 670</span><span class="w">	    </span><span class="p">}</span>
<span class="linenos"> 671</span><span class="w">    </span><span class="p">}</span>
<span class="linenos"> 672</span>
<span class="linenos"> 673</span><span class="w">	</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">copyFromGPU</span><span class="p">();</span>
<span class="linenos"> 674</span><span class="w">	</span><span class="n">onEndTrajectory</span><span class="p">(</span><span class="n">lattice</span><span class="p">);</span>
<span class="linenos"> 675</span>
<span class="linenos"> 676</span><span class="w">    </span><span class="c1">// Write any remaining species counts.</span>
<span class="linenos"> 677</span><span class="w">    </span><span class="n">writeSpeciesCounts</span><span class="p">(</span><span class="o">&amp;</span><span class="n">speciesCountsDataSet</span><span class="p">);</span>
<span class="linenos"> 678</span><span class="p">}</span>
<span class="linenos"> 679</span>
<span class="linenos"> 680</span><span class="kt">void</span><span class="w"> </span><span class="n">MpdRdmeSolver</span><span class="o">::</span><span class="n">setReactionRate</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">rxid</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">rate</span><span class="p">)</span>
<span class="linenos"> 681</span><span class="p">{</span>
<span class="linenos"> 682</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">reactionTypes</span><span class="p">[</span><span class="n">rxid</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w">  </span><span class="n">ZerothOrderPropensityArgs</span><span class="o">::</span><span class="n">REACTION_TYPE</span><span class="p">)</span>
<span class="linenos"> 683</span><span class="w">	</span><span class="p">{</span>
<span class="linenos"> 684</span><span class="w">		</span><span class="p">((</span><span class="n">ZerothOrderPropensityArgs</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">propensityFunctionArgs</span><span class="p">[</span><span class="n">rxid</span><span class="p">])</span><span class="o">-&gt;</span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rate</span><span class="p">;</span>
<span class="linenos"> 685</span><span class="w">	</span><span class="p">}</span>
<span class="linenos"> 686</span><span class="w">	</span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">reactionTypes</span><span class="p">[</span><span class="n">rxid</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">FirstOrderPropensityArgs</span><span class="o">::</span><span class="n">REACTION_TYPE</span><span class="p">)</span>
<span class="linenos"> 687</span><span class="w">	</span><span class="p">{</span>
<span class="linenos"> 688</span><span class="w">		</span><span class="p">((</span><span class="n">FirstOrderPropensityArgs</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">propensityFunctionArgs</span><span class="p">[</span><span class="n">rxid</span><span class="p">])</span><span class="o">-&gt;</span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rate</span><span class="p">;</span>
<span class="linenos"> 689</span><span class="w">	</span><span class="p">}</span>
<span class="linenos"> 690</span><span class="w">	</span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">reactionTypes</span><span class="p">[</span><span class="n">rxid</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">SecondOrderPropensityArgs</span><span class="o">::</span><span class="n">REACTION_TYPE</span><span class="p">)</span>
<span class="linenos"> 691</span><span class="w">	</span><span class="p">{</span>
<span class="linenos"> 692</span><span class="w">		</span><span class="p">((</span><span class="n">SecondOrderPropensityArgs</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">propensityFunctionArgs</span><span class="p">[</span><span class="n">rxid</span><span class="p">])</span><span class="o">-&gt;</span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rate</span><span class="p">;</span>
<span class="linenos"> 693</span><span class="w">	</span><span class="p">}</span>
<span class="linenos"> 694</span><span class="w">	</span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">reactionTypes</span><span class="p">[</span><span class="n">rxid</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">SecondOrderSelfPropensityArgs</span><span class="o">::</span><span class="n">REACTION_TYPE</span><span class="p">)</span>
<span class="linenos"> 695</span><span class="w">	</span><span class="p">{</span>
<span class="linenos"> 696</span><span class="w">		</span><span class="p">((</span><span class="n">SecondOrderSelfPropensityArgs</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">propensityFunctionArgs</span><span class="p">[</span><span class="n">rxid</span><span class="p">])</span><span class="o">-&gt;</span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rate</span><span class="p">;</span>
<span class="linenos"> 697</span><span class="w">	</span><span class="p">}</span>
<span class="linenos"> 698</span><span class="w">    </span><span class="k">else</span>
<span class="linenos"> 699</span><span class="w">    </span><span class="p">{</span>
<span class="linenos"> 700</span><span class="w">    	</span><span class="n">throw</span><span class="w"> </span><span class="n">InvalidArgException</span><span class="p">(</span><span class="s">&quot;reactionTypeA&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;the reaction type was not supported by the solver&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">reactionTypes</span><span class="p">[</span><span class="n">rxid</span><span class="p">]);</span>
<span class="linenos"> 701</span><span class="w">    </span><span class="p">}</span>
<span class="linenos"> 702</span>
<span class="linenos"> 703</span><span class="w">	</span><span class="c1">// Flag to trigger re-computation of rdme propensities</span>
<span class="linenos"> 704</span><span class="w">	</span><span class="n">reactionModelModified</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="linenos"> 705</span><span class="p">}</span>
<span class="linenos"> 706</span>
<span class="linenos"> 707</span><span class="kt">void</span><span class="w"> </span><span class="n">MpdRdmeSolver</span><span class="o">::</span><span class="n">computePropensities</span><span class="p">()</span>
<span class="linenos"> 708</span><span class="p">{</span>
<span class="linenos"> 709</span><span class="w">	</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeXSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getXSize</span><span class="p">();</span>
<span class="linenos"> 710</span><span class="w">	</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeYSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getYSize</span><span class="p">();</span>
<span class="linenos"> 711</span><span class="w">	</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeZSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getZSize</span><span class="p">();</span>
<span class="linenos"> 712</span>
<span class="linenos"> 713</span><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">numberReactions</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="linenos"> 714</span><span class="w">    </span><span class="p">{</span>
<span class="linenos"> 715</span><span class="w">    	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">reactionTypes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ZerothOrderPropensityArgs</span><span class="o">::</span><span class="n">REACTION_TYPE</span><span class="p">)</span>
<span class="linenos"> 716</span><span class="w">    	</span><span class="p">{</span>
<span class="linenos"> 717</span><span class="w">    	    </span><span class="n">model_reactionRates</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="n">ZerothOrderPropensityArgs</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">propensityFunctionArgs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">-&gt;</span><span class="n">k</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">tau</span><span class="w"> </span><span class="o">/</span>
<span class="linenos"> 718</span><span class="w">                                     </span><span class="p">(</span><span class="n">latticeXSize</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">latticeYSize</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">latticeZSize</span><span class="p">);</span>
<span class="linenos"> 719</span><span class="w">    	</span><span class="p">}</span>
<span class="linenos"> 720</span><span class="w">    	</span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">reactionTypes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">FirstOrderPropensityArgs</span><span class="o">::</span><span class="n">REACTION_TYPE</span><span class="p">)</span>
<span class="linenos"> 721</span><span class="w">    	</span><span class="p">{</span>
<span class="linenos"> 722</span><span class="w">    		</span><span class="n">model_reactionRates</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="n">FirstOrderPropensityArgs</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">propensityFunctionArgs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">-&gt;</span><span class="n">k</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">tau</span><span class="p">;</span>
<span class="linenos"> 723</span><span class="w">    	</span><span class="p">}</span>
<span class="linenos"> 724</span><span class="w">    	</span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">reactionTypes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">SecondOrderPropensityArgs</span><span class="o">::</span><span class="n">REACTION_TYPE</span><span class="p">)</span>
<span class="linenos"> 725</span><span class="w">    	</span><span class="p">{</span>
<span class="linenos"> 726</span><span class="w">    		</span><span class="n">model_reactionRates</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="n">SecondOrderPropensityArgs</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">propensityFunctionArgs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">-&gt;</span><span class="n">k</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">tau</span><span class="w"> </span><span class="o">*</span>
<span class="linenos"> 727</span><span class="w">                                     </span><span class="n">latticeXSize</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">latticeYSize</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">latticeZSize</span><span class="p">;</span>
<span class="linenos"> 728</span><span class="w">    	</span><span class="p">}</span>
<span class="linenos"> 729</span><span class="w">    	</span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">reactionTypes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">SecondOrderSelfPropensityArgs</span><span class="o">::</span><span class="n">REACTION_TYPE</span><span class="p">)</span>
<span class="linenos"> 730</span><span class="w">    	</span><span class="p">{</span>
<span class="linenos"> 731</span><span class="w">    		</span><span class="n">model_reactionRates</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="n">SecondOrderSelfPropensityArgs</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">propensityFunctionArgs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">-&gt;</span><span class="n">k</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">tau</span><span class="w"> </span><span class="o">*</span>
<span class="linenos"> 732</span><span class="w">                                     </span><span class="n">latticeXSize</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">latticeYSize</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">latticeZSize</span><span class="p">;</span>
<span class="linenos"> 733</span><span class="w">    	</span><span class="p">}</span>
<span class="linenos"> 734</span><span class="w">    	</span><span class="k">else</span>
<span class="linenos"> 735</span><span class="w">    	</span><span class="p">{</span>
<span class="linenos"> 736</span><span class="w">    		</span><span class="n">throw</span><span class="w"> </span><span class="n">InvalidArgException</span><span class="p">(</span><span class="s">&quot;reactionTypeA&quot;</span><span class="p">,</span>
<span class="linenos"> 737</span><span class="w">                                      </span><span class="s">&quot;the reaction type was not supported by the solver&quot;</span><span class="p">,</span>
<span class="linenos"> 738</span><span class="w">                                      </span><span class="n">reactionTypes</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="linenos"> 739</span><span class="w">    	</span><span class="p">}</span>
<span class="linenos"> 740</span><span class="w">    </span><span class="p">}</span>
<span class="linenos"> 741</span>
<span class="linenos"> 742</span><span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">scale</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">latticeXSize</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">latticeYSize</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">latticeZSize</span><span class="p">;</span>
<span class="linenos"> 743</span>
<span class="linenos"> 744</span><span class="w">	</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">site</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">site</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">numberSiteTypes</span><span class="p">;</span><span class="w"> </span><span class="n">site</span><span class="o">++</span><span class="p">)</span>
<span class="linenos"> 745</span><span class="w">	</span><span class="p">{</span>
<span class="linenos"> 746</span><span class="w">		</span><span class="n">uint</span><span class="w"> </span><span class="n">o1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">site</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">numberSpecies</span><span class="p">;</span>
<span class="linenos"> 747</span><span class="w">		</span><span class="n">uint</span><span class="w"> </span><span class="n">o2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">site</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">numberSpecies</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">numberSpecies</span><span class="p">;</span>
<span class="linenos"> 748</span>
<span class="linenos"> 749</span><span class="w">		</span><span class="n">zeroOrder</span><span class="p">[</span><span class="n">site</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">;</span>
<span class="linenos"> 750</span>
<span class="linenos"> 751</span><span class="w">		</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">numberSpecies</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="linenos"> 752</span><span class="w">		</span><span class="p">{</span>
<span class="linenos"> 753</span><span class="w">			</span><span class="n">firstOrder</span><span class="p">[</span><span class="n">o1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">;</span>
<span class="linenos"> 754</span>
<span class="linenos"> 755</span><span class="w">			</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">numberSpecies</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">++</span><span class="p">)</span>
<span class="linenos"> 756</span><span class="w">				</span><span class="n">secondOrder</span><span class="p">[</span><span class="n">o2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">numberSpecies</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">;</span><span class="w">	</span>
<span class="linenos"> 757</span><span class="w">		</span><span class="p">}</span>
<span class="linenos"> 758</span>
<span class="linenos"> 759</span><span class="w">		</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">numberReactions</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="linenos"> 760</span><span class="w">		</span><span class="p">{</span>
<span class="linenos"> 761</span><span class="w">			</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">RL</span><span class="p">[(</span><span class="n">i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">numberSiteTypes</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">site</span><span class="p">])</span><span class="w"> </span><span class="p">{</span><span class="k">continue</span><span class="p">;}</span>
<span class="linenos"> 762</span>
<span class="linenos"> 763</span><span class="w">			</span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">reactionTypes</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
<span class="linenos"> 764</span><span class="w">			</span><span class="p">{</span>
<span class="linenos"> 765</span><span class="w">				</span><span class="k">case</span><span class="w"> </span><span class="no">ZerothOrderPropensityArgs</span><span class="o">::</span><span class="no">REACTION_TYPE</span><span class="p">:</span>
<span class="linenos"> 766</span><span class="w">                </span><span class="p">{</span>
<span class="linenos"> 767</span><span class="w">				    </span><span class="n">ZerothOrderPropensityArgs</span><span class="o">*</span><span class="w"> </span><span class="n">rx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">ZerothOrderPropensityArgs</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">propensityFunctionArgs</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="linenos"> 768</span><span class="w">				    </span><span class="n">zeroOrder</span><span class="p">[</span><span class="n">site</span><span class="p">]</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">k</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">tau</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">scale</span><span class="p">;</span>
<span class="linenos"> 769</span><span class="w">                    </span><span class="k">break</span><span class="p">;</span>
<span class="linenos"> 770</span><span class="w">                </span><span class="p">}</span>
<span class="linenos"> 771</span><span class="w">				</span><span class="k">case</span><span class="w"> </span><span class="no">FirstOrderPropensityArgs</span><span class="o">::</span><span class="no">REACTION_TYPE</span><span class="p">:</span>
<span class="linenos"> 772</span><span class="w">                </span><span class="p">{</span>
<span class="linenos"> 773</span><span class="w">				    </span><span class="n">FirstOrderPropensityArgs</span><span class="o">*</span><span class="w"> </span><span class="n">rx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">FirstOrderPropensityArgs</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">propensityFunctionArgs</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="linenos"> 774</span><span class="w">				    </span><span class="n">firstOrder</span><span class="p">[</span><span class="n">o1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">si</span><span class="p">]</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">k</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">tau</span><span class="p">;</span>
<span class="linenos"> 775</span><span class="w">                    </span><span class="k">break</span><span class="p">;</span>
<span class="linenos"> 776</span><span class="w">                </span><span class="p">}</span>
<span class="linenos"> 777</span><span class="w">				</span><span class="k">case</span><span class="w"> </span><span class="no">SecondOrderPropensityArgs</span><span class="o">::</span><span class="no">REACTION_TYPE</span><span class="p">:</span>
<span class="linenos"> 778</span><span class="w">                </span><span class="p">{</span>
<span class="linenos"> 779</span><span class="w">				    </span><span class="n">SecondOrderPropensityArgs</span><span class="o">*</span><span class="w"> </span><span class="n">rx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">SecondOrderPropensityArgs</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">propensityFunctionArgs</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="linenos"> 780</span><span class="w">				    </span><span class="n">secondOrder</span><span class="p">[</span><span class="n">o2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">s1i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">numberSpecies</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">s2i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">k</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">tau</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">scale</span><span class="p">;</span>
<span class="linenos"> 781</span><span class="w">				    </span><span class="n">secondOrder</span><span class="p">[</span><span class="n">o2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">s2i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">numberSpecies</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">s1i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">k</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">tau</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">scale</span><span class="p">;</span>
<span class="linenos"> 782</span><span class="w">                    </span><span class="k">break</span><span class="p">;</span>
<span class="linenos"> 783</span><span class="w">                </span><span class="p">}</span>
<span class="linenos"> 784</span><span class="w">				</span><span class="k">case</span><span class="w"> </span><span class="no">SecondOrderSelfPropensityArgs</span><span class="o">::</span><span class="no">REACTION_TYPE</span><span class="p">:</span>
<span class="linenos"> 785</span><span class="w">                </span><span class="p">{</span>
<span class="linenos"> 786</span><span class="w">				    </span><span class="n">SecondOrderSelfPropensityArgs</span><span class="o">*</span><span class="w"> </span><span class="n">rx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">SecondOrderSelfPropensityArgs</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">propensityFunctionArgs</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="linenos"> 787</span><span class="w">				    </span><span class="n">secondOrder</span><span class="p">[</span><span class="n">o2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">si</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">numberSpecies</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">si</span><span class="p">]</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">k</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">tau</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">scale</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<span class="linenos"> 788</span><span class="w">                </span><span class="p">}</span>
<span class="linenos"> 789</span><span class="w">			</span><span class="p">}</span>
<span class="linenos"> 790</span><span class="w">		</span><span class="p">}</span>
<span class="linenos"> 791</span><span class="w">	</span><span class="p">}</span>
<span class="linenos"> 792</span><span class="p">}</span>
<span class="linenos"> 793</span>
<span class="linenos"> 794</span><span class="kt">void</span><span class="w"> </span><span class="n">MpdRdmeSolver</span><span class="o">::</span><span class="n">copyModelsToDevice</span><span class="p">()</span>
<span class="linenos"> 795</span><span class="p">{</span>
<span class="linenos"> 796</span><span class="cp">#ifdef MPD_GLOBAL_R_MATRIX</span>
<span class="linenos"> 797</span><span class="w">    </span><span class="n">cudaMemcpy</span><span class="p">(</span><span class="n">reactionRatesG</span><span class="p">,</span><span class="w"> </span><span class="n">model_reactionRates</span><span class="p">,</span><span class="w"> </span><span class="n">numberReactions</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">),</span><span class="w"> </span><span class="n">cudaMemcpyHostToDevice</span><span class="p">);</span>
<span class="linenos"> 798</span><span class="cp">#else</span>
<span class="linenos"> 799</span><span class="w">    </span><span class="n">cudaMemcpyToSymbol</span><span class="p">(</span><span class="n">reactionRatesC</span><span class="p">,</span><span class="w"> </span><span class="n">model_reactionRates</span><span class="p">,</span><span class="w"> </span><span class="n">numberReactions</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">));</span>
<span class="linenos"> 800</span><span class="cp">#endif</span>
<span class="linenos"> 801</span>
<span class="linenos"> 802</span><span class="w">	</span><span class="n">cudaMemcpy</span><span class="p">(</span><span class="n">propZeroOrder</span><span class="p">,</span><span class="w">   </span><span class="n">zeroOrder</span><span class="p">,</span><span class="w">   </span><span class="n">zeroOrderSize</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">),</span><span class="w">   </span><span class="n">cudaMemcpyHostToDevice</span><span class="p">);</span>
<span class="linenos"> 803</span><span class="w">	</span><span class="n">cudaMemcpy</span><span class="p">(</span><span class="n">propFirstOrder</span><span class="p">,</span><span class="w">  </span><span class="n">firstOrder</span><span class="p">,</span><span class="w">  </span><span class="n">firstOrderSize</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">),</span><span class="w">  </span><span class="n">cudaMemcpyHostToDevice</span><span class="p">);</span>
<span class="linenos"> 804</span><span class="w">	</span><span class="n">cudaMemcpy</span><span class="p">(</span><span class="n">propSecondOrder</span><span class="p">,</span><span class="w"> </span><span class="n">secondOrder</span><span class="p">,</span><span class="w"> </span><span class="n">secondOrderSize</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">),</span><span class="w"> </span><span class="n">cudaMemcpyHostToDevice</span><span class="p">);</span>
<span class="linenos"> 805</span><span class="p">}</span>
<span class="linenos"> 806</span>
<span class="linenos"> 807</span><span class="kt">int</span><span class="w"> </span><span class="n">MpdRdmeSolver</span><span class="o">::</span><span class="n">hookSimulation</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="n">CudaByteLattice</span><span class="w"> </span><span class="o">*</span><span class="n">lattice</span><span class="p">)</span>
<span class="linenos"> 808</span><span class="p">{</span>
<span class="linenos"> 809</span><span class="w">	</span><span class="c1">// Overload this function in derivative classes</span>
<span class="linenos"> 810</span><span class="w">	</span><span class="c1">// Return 0 if the lattice state is unchanged</span>
<span class="linenos"> 811</span><span class="w">	</span><span class="c1">// Return 1 if the lattice state has been modified, </span>
<span class="linenos"> 812</span><span class="w">    </span><span class="c1">//          and it needs to be copied back to the GPU</span>
<span class="linenos"> 813</span><span class="w">	</span><span class="c1">// Return 2 if lattice sites have changed, and should</span>
<span class="linenos"> 814</span><span class="w">	</span><span class="c1">//			be copied back to the GPU *and* be recorded</span>
<span class="linenos"> 815</span><span class="w">	</span><span class="c1">//			in the output file</span>
<span class="linenos"> 816</span><span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos"> 817</span><span class="p">}</span>
<span class="linenos"> 818</span>
<span class="linenos"> 819</span><span class="kt">int</span><span class="w"> </span><span class="n">MpdRdmeSolver</span><span class="o">::</span><span class="n">onWriteLattice</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="n">CudaByteLattice</span><span class="w"> </span><span class="o">*</span><span class="n">lattice</span><span class="p">)</span>
<span class="linenos"> 820</span><span class="p">{</span>
<span class="linenos"> 821</span><span class="w">	</span><span class="c1">// Overload this function in derivative classes</span>
<span class="linenos"> 822</span><span class="w">	</span><span class="c1">// Return 0 if the lattice state is unchanged</span>
<span class="linenos"> 823</span><span class="w">	</span><span class="c1">// Return 1 if the lattice state has been modified, </span>
<span class="linenos"> 824</span><span class="w">    </span><span class="c1">//          and it needs to be copied back to the GPU.</span>
<span class="linenos"> 825</span><span class="w">	</span><span class="c1">// Return 2 if lattice sites have changed, and should</span>
<span class="linenos"> 826</span><span class="w">	</span><span class="c1">//			be copied back to the GPU *and* be recorded</span>
<span class="linenos"> 827</span><span class="w">	</span><span class="c1">//			in the output file</span>
<span class="linenos"> 828</span><span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos"> 829</span><span class="p">}</span>
<span class="linenos"> 830</span>
<span class="linenos"> 831</span><span class="kt">int</span><span class="w"> </span><span class="n">MpdRdmeSolver</span><span class="o">::</span><span class="n">onBeginTrajectory</span><span class="p">(</span><span class="n">CudaByteLattice</span><span class="w"> </span><span class="o">*</span><span class="n">lattice</span><span class="p">)</span>
<span class="linenos"> 832</span><span class="p">{</span>
<span class="linenos"> 833</span><span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos"> 834</span><span class="p">}</span>
<span class="linenos"> 835</span>
<span class="linenos"> 836</span><span class="kt">int</span><span class="w"> </span><span class="n">MpdRdmeSolver</span><span class="o">::</span><span class="n">onEndTrajectory</span><span class="p">(</span><span class="n">CudaByteLattice</span><span class="w"> </span><span class="o">*</span><span class="n">lattice</span><span class="p">)</span>
<span class="linenos"> 837</span><span class="p">{</span>
<span class="linenos"> 838</span><span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos"> 839</span><span class="p">}</span>
<span class="linenos"> 840</span>
<span class="linenos"> 841</span><span class="kt">void</span><span class="w"> </span><span class="n">MpdRdmeSolver</span><span class="o">::</span><span class="n">writeLatticeData</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">time</span><span class="p">,</span>
<span class="linenos"> 842</span><span class="w">                                     </span><span class="n">CudaByteLattice</span><span class="o">*</span><span class="w"> </span><span class="n">lattice</span><span class="p">,</span>
<span class="linenos"> 843</span><span class="w">                                     </span><span class="n">lm</span><span class="o">::</span><span class="n">io</span><span class="o">::</span><span class="n">Lattice</span><span class="o">*</span><span class="w"> </span><span class="n">latticeDataSet</span><span class="p">)</span>
<span class="linenos"> 844</span><span class="p">{</span>
<span class="linenos"> 845</span><span class="w">    </span><span class="c1">// Record the lattice data.</span>
<span class="linenos"> 846</span><span class="w">    </span><span class="n">latticeDataSet</span><span class="o">-&gt;</span><span class="n">Clear</span><span class="p">();</span>
<span class="linenos"> 847</span><span class="w">    </span><span class="n">latticeDataSet</span><span class="o">-&gt;</span><span class="n">set_lattice_x_size</span><span class="p">(</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getSize</span><span class="p">().</span><span class="n">x</span><span class="p">);</span>
<span class="linenos"> 848</span><span class="w">    </span><span class="n">latticeDataSet</span><span class="o">-&gt;</span><span class="n">set_lattice_y_size</span><span class="p">(</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getSize</span><span class="p">().</span><span class="n">y</span><span class="p">);</span>
<span class="linenos"> 849</span><span class="w">    </span><span class="n">latticeDataSet</span><span class="o">-&gt;</span><span class="n">set_lattice_z_size</span><span class="p">(</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getSize</span><span class="p">().</span><span class="n">z</span><span class="p">);</span>
<span class="linenos"> 850</span><span class="w">    </span><span class="n">latticeDataSet</span><span class="o">-&gt;</span><span class="n">set_particles_per_site</span><span class="p">(</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getMaxOccupancy</span><span class="p">());</span>
<span class="linenos"> 851</span><span class="w">    </span><span class="n">latticeDataSet</span><span class="o">-&gt;</span><span class="n">set_time</span><span class="p">(</span><span class="n">time</span><span class="p">);</span>
<span class="linenos"> 852</span>
<span class="linenos"> 853</span><span class="w">    </span><span class="c1">// Push it to the output queue.</span>
<span class="linenos"> 854</span><span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">payloadSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">size_t</span><span class="p">(</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getSize</span><span class="p">().</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">*</span>
<span class="linenos"> 855</span><span class="w">                         </span><span class="kt">size_t</span><span class="p">(</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getSize</span><span class="p">().</span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="o">*</span>
<span class="linenos"> 856</span><span class="w">                         </span><span class="kt">size_t</span><span class="p">(</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getSize</span><span class="p">().</span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="o">*</span>
<span class="linenos"> 857</span><span class="w">                         </span><span class="kt">size_t</span><span class="p">(</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getMaxOccupancy</span><span class="p">())</span><span class="w"> </span><span class="o">*</span>
<span class="linenos"> 858</span><span class="w">                         </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">uint8_t</span><span class="p">);</span>
<span class="linenos"> 859</span>
<span class="linenos"> 860</span><span class="w">    </span><span class="n">lm</span><span class="o">::</span><span class="n">main</span><span class="o">::</span><span class="n">DataOutputQueue</span><span class="o">::</span><span class="n">getInstance</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">pushDataSet</span><span class="p">(</span><span class="n">lm</span><span class="o">::</span><span class="n">main</span><span class="o">::</span><span class="n">DataOutputQueue</span><span class="o">::</span><span class="n">BYTE_LATTICE</span><span class="p">,</span>
<span class="linenos"> 861</span><span class="w">                                                          </span><span class="n">replicate</span><span class="p">,</span>
<span class="linenos"> 862</span><span class="w">                                                          </span><span class="n">latticeDataSet</span><span class="p">,</span>
<span class="linenos"> 863</span><span class="w">                                                          </span><span class="n">lattice</span><span class="p">,</span>
<span class="linenos"> 864</span><span class="w">                                                          </span><span class="n">payloadSize</span><span class="p">,</span>
<span class="linenos"> 865</span><span class="w">                                                          </span><span class="o">&amp;</span><span class="n">lm</span><span class="o">::</span><span class="n">rdme</span><span class="o">::</span><span class="n">ByteLattice</span><span class="o">::</span><span class="n">nativeSerialize</span><span class="p">);</span>
<span class="linenos"> 866</span><span class="p">}</span>
<span class="linenos"> 867</span>
<span class="linenos"> 868</span><span class="kt">void</span><span class="w"> </span><span class="n">MpdRdmeSolver</span><span class="o">::</span><span class="n">writeLatticeSites</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="n">CudaByteLattice</span><span class="o">*</span><span class="w"> </span><span class="n">lattice</span><span class="p">)</span>
<span class="linenos"> 869</span><span class="p">{</span>
<span class="linenos"> 870</span><span class="w">	</span><span class="n">lm</span><span class="o">::</span><span class="n">io</span><span class="o">::</span><span class="n">Lattice</span><span class="w"> </span><span class="n">latticeDataSet</span><span class="p">;</span>
<span class="linenos"> 871</span>
<span class="linenos"> 872</span><span class="w">    </span><span class="c1">// Record the lattice data.</span>
<span class="linenos"> 873</span><span class="w">    </span><span class="n">latticeDataSet</span><span class="p">.</span><span class="n">Clear</span><span class="p">();</span>
<span class="linenos"> 874</span><span class="w">    </span><span class="n">latticeDataSet</span><span class="p">.</span><span class="n">set_lattice_x_size</span><span class="p">(</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getSize</span><span class="p">().</span><span class="n">x</span><span class="p">);</span>
<span class="linenos"> 875</span><span class="w">    </span><span class="n">latticeDataSet</span><span class="p">.</span><span class="n">set_lattice_y_size</span><span class="p">(</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getSize</span><span class="p">().</span><span class="n">y</span><span class="p">);</span>
<span class="linenos"> 876</span><span class="w">    </span><span class="n">latticeDataSet</span><span class="p">.</span><span class="n">set_lattice_z_size</span><span class="p">(</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getSize</span><span class="p">().</span><span class="n">z</span><span class="p">);</span>
<span class="linenos"> 877</span><span class="w">    </span><span class="n">latticeDataSet</span><span class="p">.</span><span class="n">set_particles_per_site</span><span class="p">(</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getMaxOccupancy</span><span class="p">());</span>
<span class="linenos"> 878</span><span class="w">    </span><span class="n">latticeDataSet</span><span class="p">.</span><span class="n">set_time</span><span class="p">(</span><span class="n">time</span><span class="p">);</span>
<span class="linenos"> 879</span>
<span class="linenos"> 880</span><span class="w">    </span><span class="c1">// Push it to the output queue.</span>
<span class="linenos"> 881</span><span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">payloadSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getSize</span><span class="p">().</span><span class="n">x</span><span class="w"> </span><span class="o">*</span>
<span class="linenos"> 882</span><span class="w">                         </span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getSize</span><span class="p">().</span><span class="n">y</span><span class="w"> </span><span class="o">*</span>
<span class="linenos"> 883</span><span class="w">                         </span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getSize</span><span class="p">().</span><span class="n">z</span><span class="w"> </span><span class="o">*</span>
<span class="linenos"> 884</span><span class="w">                         </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">uint8_t</span><span class="p">);</span>
<span class="linenos"> 885</span>
<span class="linenos"> 886</span><span class="w">    </span><span class="n">lm</span><span class="o">::</span><span class="n">main</span><span class="o">::</span><span class="n">DataOutputQueue</span><span class="o">::</span><span class="n">getInstance</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">pushDataSet</span><span class="p">(</span><span class="n">lm</span><span class="o">::</span><span class="n">main</span><span class="o">::</span><span class="n">DataOutputQueue</span><span class="o">::</span><span class="n">SITE_LATTICE</span><span class="p">,</span>
<span class="linenos"> 887</span><span class="w">                                                          </span><span class="n">replicate</span><span class="p">,</span>
<span class="linenos"> 888</span><span class="w">                                                          </span><span class="o">&amp;</span><span class="n">latticeDataSet</span><span class="p">,</span>
<span class="linenos"> 889</span><span class="w">                                                          </span><span class="n">lattice</span><span class="p">,</span>
<span class="linenos"> 890</span><span class="w">                                                          </span><span class="n">payloadSize</span><span class="p">,</span>
<span class="linenos"> 891</span><span class="w">                                                          </span><span class="o">&amp;</span><span class="n">lm</span><span class="o">::</span><span class="n">rdme</span><span class="o">::</span><span class="n">ByteLattice</span><span class="o">::</span><span class="n">nativeSerializeSites</span><span class="p">);</span>
<span class="linenos"> 892</span><span class="p">}</span>
<span class="linenos"> 893</span>
<span class="linenos"> 894</span><span class="kt">void</span><span class="w"> </span><span class="n">MpdRdmeSolver</span><span class="o">::</span><span class="n">recordSpeciesCounts</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="n">CudaByteLattice</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">lattice</span><span class="p">,</span><span class="w"> </span><span class="n">lm</span><span class="o">::</span><span class="n">io</span><span class="o">::</span><span class="n">SpeciesCounts</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">speciesCountsDataSet</span><span class="p">)</span>
<span class="linenos"> 895</span><span class="p">{</span>
<span class="linenos"> 896</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">particle_t</span><span class="p">,</span><span class="n">uint</span><span class="o">&gt;</span><span class="w"> </span><span class="n">particleCounts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getParticleCounts</span><span class="p">();</span>
<span class="linenos"> 897</span><span class="w">    </span><span class="n">speciesCountsDataSet</span><span class="o">-&gt;</span><span class="n">set_number_entries</span><span class="p">(</span><span class="n">speciesCountsDataSet</span><span class="o">-&gt;</span><span class="n">number_entries</span><span class="p">()</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
<span class="linenos"> 898</span><span class="w">    </span><span class="n">speciesCountsDataSet</span><span class="o">-&gt;</span><span class="n">add_time</span><span class="p">(</span><span class="n">time</span><span class="p">);</span>
<span class="linenos"> 899</span><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">particle_t</span><span class="w"> </span><span class="n">p</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">p</span><span class="o">&lt;</span><span class="n">numberSpeciesToTrack</span><span class="p">;</span><span class="w"> </span><span class="n">p</span><span class="o">++</span><span class="p">)</span>
<span class="linenos"> 900</span><span class="w">    </span><span class="p">{</span>
<span class="linenos"> 901</span><span class="w">        </span><span class="n">speciesCountsDataSet</span><span class="o">-&gt;</span><span class="n">add_species_count</span><span class="p">((</span><span class="n">particleCounts</span><span class="p">.</span><span class="n">count</span><span class="p">(</span><span class="n">p</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span><span class="o">?</span><span class="n">particleCounts</span><span class="p">[</span><span class="n">p</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">:</span><span class="mi">0</span><span class="p">);</span>
<span class="linenos"> 902</span><span class="w">    </span><span class="p">}</span>
<span class="linenos"> 903</span><span class="p">}</span>
<span class="linenos"> 904</span>
<span class="linenos"> 905</span><span class="kt">void</span><span class="w"> </span><span class="n">MpdRdmeSolver</span><span class="o">::</span><span class="n">writeSpeciesCounts</span><span class="p">(</span><span class="n">lm</span><span class="o">::</span><span class="n">io</span><span class="o">::</span><span class="n">SpeciesCounts</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">speciesCountsDataSet</span><span class="p">)</span>
<span class="linenos"> 906</span><span class="p">{</span>
<span class="linenos"> 907</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">speciesCountsDataSet</span><span class="o">-&gt;</span><span class="n">number_entries</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="linenos"> 908</span><span class="w">    </span><span class="p">{</span>
<span class="linenos"> 909</span><span class="w">        </span><span class="c1">// Push it to the output queue.</span>
<span class="linenos"> 910</span><span class="w">        </span><span class="n">lm</span><span class="o">::</span><span class="n">main</span><span class="o">::</span><span class="n">DataOutputQueue</span><span class="o">::</span><span class="n">getInstance</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">pushDataSet</span><span class="p">(</span><span class="n">lm</span><span class="o">::</span><span class="n">main</span><span class="o">::</span><span class="n">DataOutputQueue</span><span class="o">::</span><span class="n">SPECIES_COUNTS</span><span class="p">,</span><span class="w"> </span><span class="n">replicate</span><span class="p">,</span><span class="w"> </span><span class="n">speciesCountsDataSet</span><span class="p">);</span>
<span class="linenos"> 911</span>
<span class="linenos"> 912</span><span class="w">        </span><span class="c1">// Reset the data set.</span>
<span class="linenos"> 913</span><span class="w">        </span><span class="n">speciesCountsDataSet</span><span class="o">-&gt;</span><span class="n">Clear</span><span class="p">();</span>
<span class="linenos"> 914</span><span class="w">        </span><span class="n">speciesCountsDataSet</span><span class="o">-&gt;</span><span class="n">set_number_species</span><span class="p">(</span><span class="n">numberSpeciesToTrack</span><span class="p">);</span>
<span class="linenos"> 915</span><span class="w">        </span><span class="n">speciesCountsDataSet</span><span class="o">-&gt;</span><span class="n">set_number_entries</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="linenos"> 916</span><span class="w">    </span><span class="p">}</span>
<span class="linenos"> 917</span><span class="p">}</span>
<span class="linenos"> 918</span>
<span class="linenos"> 919</span><span class="kt">void</span><span class="w"> </span><span class="n">MpdRdmeSolver</span><span class="o">::</span><span class="n">hookCheckSimulation</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="n">CudaByteLattice</span><span class="o">*</span><span class="w"> </span><span class="n">lattice</span><span class="p">)</span>
<span class="linenos"> 920</span><span class="p">{</span>
<span class="linenos"> 921</span><span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">hookSimulation</span><span class="p">(</span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="n">lattice</span><span class="p">))</span>
<span class="linenos"> 922</span><span class="w">    </span><span class="p">{</span>
<span class="linenos"> 923</span><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="mi">0</span><span class="p">:</span>
<span class="linenos"> 924</span><span class="w">        </span><span class="p">{</span>
<span class="linenos"> 925</span><span class="w">            </span><span class="k">break</span><span class="p">;</span>
<span class="linenos"> 926</span><span class="w">        </span><span class="p">}</span>
<span class="linenos"> 927</span><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span>
<span class="linenos"> 928</span><span class="w">        </span><span class="p">{</span>
<span class="linenos"> 929</span><span class="w">            </span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">copyToGPU</span><span class="p">();</span>
<span class="linenos"> 930</span><span class="w">            </span><span class="k">break</span><span class="p">;</span>
<span class="linenos"> 931</span><span class="w">        </span><span class="p">}</span>
<span class="linenos"> 932</span><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="mi">2</span><span class="p">:</span>
<span class="linenos"> 933</span><span class="w">        </span><span class="p">{</span>
<span class="linenos"> 934</span><span class="w">            </span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">copyToGPU</span><span class="p">();</span>
<span class="linenos"> 935</span><span class="w">            </span><span class="n">writeLatticeSites</span><span class="p">(</span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="n">lattice</span><span class="p">);</span>
<span class="linenos"> 936</span><span class="w">            </span><span class="k">break</span><span class="p">;</span>
<span class="linenos"> 937</span><span class="w">        </span><span class="p">}</span>
<span class="linenos"> 938</span><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="mi">3</span><span class="p">:</span>
<span class="linenos"> 939</span><span class="w">        </span><span class="p">{</span>
<span class="linenos"> 940</span><span class="w">            </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;hook return value is 3, force to stop.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="linenos"> 941</span><span class="w">            </span><span class="n">writeLatticeSites</span><span class="p">(</span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="n">lattice</span><span class="p">);</span>
<span class="linenos"> 942</span><span class="w">            </span><span class="k">return</span><span class="p">;</span>
<span class="linenos"> 943</span><span class="w">        </span><span class="p">}</span>
<span class="linenos"> 944</span><span class="w">        </span><span class="k">default</span><span class="o">:</span>
<span class="linenos"> 945</span><span class="w">        </span><span class="p">{</span>
<span class="linenos"> 946</span><span class="w">            </span><span class="n">throw</span><span class="p">(</span><span class="s">&quot;Unknown hook return value&quot;</span><span class="p">);</span>
<span class="linenos"> 947</span><span class="w">        </span><span class="p">}</span>
<span class="linenos"> 948</span><span class="w">    </span><span class="p">}</span>
<span class="linenos"> 949</span>
<span class="linenos"> 950</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">reactionModelModified</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="n">computePropensities</span><span class="p">();}</span>
<span class="linenos"> 951</span><span class="p">}</span>
<span class="linenos"> 952</span>
<span class="linenos"> 953</span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">MpdRdmeSolver</span><span class="o">::</span><span class="n">getTimestepSeed</span><span class="p">(</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">timestep</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">substep</span><span class="p">)</span>
<span class="linenos"> 954</span><span class="p">{</span>
<span class="linenos"> 955</span><span class="w">    </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">timestepHash</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(((((</span><span class="kt">uint64_t</span><span class="p">)</span><span class="n">seed</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="mi">30</span><span class="p">)</span><span class="o">+</span><span class="n">timestep</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="n">substep</span><span class="p">;</span>
<span class="linenos"> 956</span><span class="w">    </span><span class="n">timestepHash</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">timestepHash</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">3202034522624059733ULL</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">4354685564936845319ULL</span><span class="p">;</span>
<span class="linenos"> 957</span><span class="w">    </span><span class="n">timestepHash</span><span class="w"> </span><span class="o">^=</span><span class="w"> </span><span class="n">timestepHash</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">20</span><span class="p">;</span><span class="w"> </span><span class="n">timestepHash</span><span class="w"> </span><span class="o">^=</span><span class="w"> </span><span class="n">timestepHash</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">41</span><span class="p">;</span><span class="w"> </span><span class="n">timestepHash</span><span class="w"> </span><span class="o">^=</span><span class="w"> </span><span class="n">timestepHash</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span>
<span class="linenos"> 958</span><span class="w">    </span><span class="n">timestepHash</span><span class="w"> </span><span class="o">*=</span><span class="w"> </span><span class="mi">7664345821815920749ULL</span><span class="p">;</span>
<span class="linenos"> 959</span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">;</span>
<span class="linenos"> 960</span><span class="p">}</span>
<span class="linenos"> 961</span>
<span class="linenos"> 962</span><span class="kt">void</span><span class="w"> </span><span class="n">MpdRdmeSolver</span><span class="o">::</span><span class="n">runTimestep</span><span class="p">(</span><span class="n">CudaByteLattice</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">lattice</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">timestep</span><span class="p">)</span>
<span class="linenos"> 963</span><span class="p">{</span>
<span class="linenos"> 964</span><span class="w">    </span><span class="n">PROF_BEGIN</span><span class="p">(</span><span class="n">PROF_MPD_TIMESTEP</span><span class="p">);</span>
<span class="linenos"> 965</span>
<span class="linenos"> 966</span><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">reactionModelModified</span><span class="p">)</span>
<span class="linenos"> 967</span><span class="w">        </span><span class="n">copyModelsToDevice</span><span class="p">();</span>
<span class="linenos"> 968</span>
<span class="linenos"> 969</span><span class="w">    </span><span class="c1">// Calculate some properties of the lattice.</span>
<span class="linenos"> 970</span><span class="w">    </span><span class="n">lattice_coord_t</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getSize</span><span class="p">();</span>
<span class="linenos"> 971</span><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeXSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">size</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
<span class="linenos"> 972</span><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeYSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">size</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
<span class="linenos"> 973</span><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeZSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">size</span><span class="p">.</span><span class="n">z</span><span class="p">;</span>
<span class="linenos"> 974</span>
<span class="linenos"> 975</span><span class="w">    </span><span class="kt">dim3</span><span class="w"> </span><span class="n">gridSize</span><span class="p">,</span><span class="w"> </span><span class="n">threadBlockSize</span><span class="p">;</span>
<span class="linenos"> 976</span>
<span class="linenos"> 977</span><span class="w">    </span><span class="c1">// Execute the kernel for the x direction.</span>
<span class="linenos"> 978</span><span class="w">    </span><span class="n">PROF_CUDA_START</span><span class="p">(</span><span class="n">cudaStream</span><span class="p">);</span>
<span class="linenos"> 979</span>
<span class="linenos"> 980</span><span class="w">    </span><span class="n">PROF_CUDA_BEGIN</span><span class="p">(</span><span class="n">PROF_MPD_X_DIFFUSION</span><span class="p">,</span><span class="n">cudaStream</span><span class="p">);</span>
<span class="linenos"> 981</span><span class="w">    </span><span class="cp">#ifdef MPD_CUDA_3D_GRID_LAUNCH</span>
<span class="linenos"> 982</span><span class="w">    </span><span class="n">calculateXLaunchParameters</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gridSize</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">threadBlockSize</span><span class="p">,</span><span class="w"> </span><span class="n">TUNE_MPD_X_BLOCK_MAX_X_SIZE</span><span class="p">,</span><span class="w"> </span><span class="n">latticeXSize</span><span class="p">,</span><span class="w"> </span><span class="n">latticeYSize</span><span class="p">,</span><span class="w"> </span><span class="n">latticeZSize</span><span class="p">);</span>
<span class="linenos"> 983</span><span class="w">    </span><span class="n">CUDA_EXCEPTION_EXECUTE</span><span class="p">((</span><span class="n">mpdrdme_dev</span><span class="o">::</span><span class="n">mpd_x_kernel</span><span class="o">&lt;&lt;&lt;</span><span class="n">gridSize</span><span class="p">,</span><span class="n">threadBlockSize</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">cudaStream</span><span class="o">&gt;&gt;&gt;</span><span class="p">((</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getGPUMemorySrc</span><span class="p">(),</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getGPUMemorySiteTypes</span><span class="p">(),</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getGPUMemoryDest</span><span class="p">(),</span><span class="w"> </span><span class="n">getTimestepSeed</span><span class="p">(</span><span class="n">timestep</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="p">)</span><span class="n">cudaOverflowList</span><span class="p">)));</span>
<span class="linenos"> 984</span><span class="w">    </span><span class="cp">#else</span>
<span class="linenos"> 985</span><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">gridXSize</span><span class="p">;</span>
<span class="linenos"> 986</span><span class="w">    </span><span class="n">calculateXLaunchParameters</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gridXSize</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">gridSize</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">threadBlockSize</span><span class="p">,</span><span class="w"> </span><span class="n">TUNE_MPD_X_BLOCK_MAX_X_SIZE</span><span class="p">,</span><span class="w"> </span><span class="n">latticeXSize</span><span class="p">,</span><span class="w"> </span><span class="n">latticeYSize</span><span class="p">,</span><span class="w"> </span><span class="n">latticeZSize</span><span class="p">);</span>
<span class="linenos"> 987</span><span class="w">    </span><span class="n">CUDA_EXCEPTION_EXECUTE</span><span class="p">((</span><span class="n">mpdrdme_dev</span><span class="o">::</span><span class="n">mpd_x_kernel</span><span class="o">&lt;&lt;&lt;</span><span class="n">gridSize</span><span class="p">,</span><span class="n">threadBlockSize</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">cudaStream</span><span class="o">&gt;&gt;&gt;</span><span class="p">((</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getGPUMemorySrc</span><span class="p">(),</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getGPUMemorySiteTypes</span><span class="p">(),</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getGPUMemoryDest</span><span class="p">(),</span><span class="w"> </span><span class="n">gridXSize</span><span class="p">,</span><span class="w"> </span><span class="n">getTimestepSeed</span><span class="p">(</span><span class="n">timestep</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="p">)</span><span class="n">cudaOverflowList</span><span class="p">)));</span>
<span class="linenos"> 988</span><span class="w">    </span><span class="cp">#endif</span>
<span class="linenos"> 989</span><span class="w">    </span><span class="n">PROF_CUDA_END</span><span class="p">(</span><span class="n">PROF_MPD_X_DIFFUSION</span><span class="p">,</span><span class="n">cudaStream</span><span class="p">);</span>
<span class="linenos"> 990</span><span class="w">    </span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">swapSrcDest</span><span class="p">();</span>
<span class="linenos"> 991</span>
<span class="linenos"> 992</span><span class="w">    </span><span class="c1">// Execute the kernel for the y direction.</span>
<span class="linenos"> 993</span><span class="w">    </span><span class="n">PROF_CUDA_BEGIN</span><span class="p">(</span><span class="n">PROF_MPD_Y_DIFFUSION</span><span class="p">,</span><span class="n">cudaStream</span><span class="p">);</span>
<span class="linenos"> 994</span><span class="w">    </span><span class="cp">#ifdef MPD_CUDA_3D_GRID_LAUNCH</span>
<span class="linenos"> 995</span><span class="w">    </span><span class="n">calculateYLaunchParameters</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gridSize</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">threadBlockSize</span><span class="p">,</span><span class="w"> </span><span class="n">TUNE_MPD_Y_BLOCK_X_SIZE</span><span class="p">,</span><span class="w"> </span><span class="n">TUNE_MPD_Y_BLOCK_Y_SIZE</span><span class="p">,</span><span class="w"> </span><span class="n">latticeXSize</span><span class="p">,</span><span class="w"> </span><span class="n">latticeYSize</span><span class="p">,</span><span class="w"> </span><span class="n">latticeZSize</span><span class="p">);</span>
<span class="linenos"> 996</span><span class="w">    </span><span class="n">CUDA_EXCEPTION_EXECUTE</span><span class="p">((</span><span class="n">mpdrdme_dev</span><span class="o">::</span><span class="n">mpd_y_kernel</span><span class="o">&lt;&lt;&lt;</span><span class="n">gridSize</span><span class="p">,</span><span class="n">threadBlockSize</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">cudaStream</span><span class="o">&gt;&gt;&gt;</span><span class="p">((</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getGPUMemorySrc</span><span class="p">(),</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getGPUMemorySiteTypes</span><span class="p">(),</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getGPUMemoryDest</span><span class="p">(),</span><span class="w"> </span><span class="n">getTimestepSeed</span><span class="p">(</span><span class="n">timestep</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="p">)</span><span class="n">cudaOverflowList</span><span class="p">)));</span>
<span class="linenos"> 997</span><span class="w">    </span><span class="cp">#else</span>
<span class="linenos"> 998</span><span class="w">    </span><span class="n">calculateYLaunchParameters</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gridXSize</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">gridSize</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">threadBlockSize</span><span class="p">,</span><span class="w"> </span><span class="n">TUNE_MPD_Y_BLOCK_X_SIZE</span><span class="p">,</span><span class="w"> </span><span class="n">TUNE_MPD_Y_BLOCK_Y_SIZE</span><span class="p">,</span><span class="w"> </span><span class="n">latticeXSize</span><span class="p">,</span><span class="w"> </span><span class="n">latticeYSize</span><span class="p">,</span><span class="w"> </span><span class="n">latticeZSize</span><span class="p">);</span>
<span class="linenos"> 999</span><span class="w">    </span><span class="n">CUDA_EXCEPTION_EXECUTE</span><span class="p">((</span><span class="n">mpdrdme_dev</span><span class="o">::</span><span class="n">mpd_y_kernel</span><span class="o">&lt;&lt;&lt;</span><span class="n">gridSize</span><span class="p">,</span><span class="n">threadBlockSize</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">cudaStream</span><span class="o">&gt;&gt;&gt;</span><span class="p">((</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getGPUMemorySrc</span><span class="p">(),</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getGPUMemorySiteTypes</span><span class="p">(),</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getGPUMemoryDest</span><span class="p">(),</span><span class="w"> </span><span class="n">gridXSize</span><span class="p">,</span><span class="w"> </span><span class="n">getTimestepSeed</span><span class="p">(</span><span class="n">timestep</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="p">)</span><span class="n">cudaOverflowList</span><span class="p">)));</span>
<span class="linenos">1000</span><span class="w">    </span><span class="cp">#endif</span>
<span class="linenos">1001</span><span class="w">    </span><span class="n">PROF_CUDA_END</span><span class="p">(</span><span class="n">PROF_MPD_Y_DIFFUSION</span><span class="p">,</span><span class="n">cudaStream</span><span class="p">);</span>
<span class="linenos">1002</span><span class="w">    </span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">swapSrcDest</span><span class="p">();</span>
<span class="linenos">1003</span>
<span class="linenos">1004</span><span class="w">    </span><span class="c1">// Execute the kernel for the z direction.</span>
<span class="linenos">1005</span><span class="w">    </span><span class="n">PROF_CUDA_BEGIN</span><span class="p">(</span><span class="n">PROF_MPD_Z_DIFFUSION</span><span class="p">,</span><span class="n">cudaStream</span><span class="p">);</span>
<span class="linenos">1006</span><span class="w">    </span><span class="cp">#ifdef MPD_CUDA_3D_GRID_LAUNCH</span>
<span class="linenos">1007</span><span class="w">    </span><span class="n">calculateZLaunchParameters</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gridSize</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">threadBlockSize</span><span class="p">,</span><span class="w"> </span><span class="n">TUNE_MPD_Z_BLOCK_X_SIZE</span><span class="p">,</span><span class="w"> </span><span class="n">TUNE_MPD_Z_BLOCK_Z_SIZE</span><span class="p">,</span><span class="w"> </span><span class="n">latticeXSize</span><span class="p">,</span><span class="w"> </span><span class="n">latticeYSize</span><span class="p">,</span><span class="w"> </span><span class="n">latticeZSize</span><span class="p">);</span>
<span class="linenos">1008</span><span class="w">    </span><span class="n">CUDA_EXCEPTION_EXECUTE</span><span class="p">((</span><span class="n">mpdrdme_dev</span><span class="o">::</span><span class="n">mpd_z_kernel</span><span class="o">&lt;&lt;&lt;</span><span class="n">gridSize</span><span class="p">,</span><span class="n">threadBlockSize</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">cudaStream</span><span class="o">&gt;&gt;&gt;</span><span class="p">((</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getGPUMemorySrc</span><span class="p">(),</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getGPUMemorySiteTypes</span><span class="p">(),</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getGPUMemoryDest</span><span class="p">(),</span><span class="w"> </span><span class="n">getTimestepSeed</span><span class="p">(</span><span class="n">timestep</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="p">)</span><span class="n">cudaOverflowList</span><span class="p">)));</span>
<span class="linenos">1009</span><span class="w">    </span><span class="cp">#else</span>
<span class="linenos">1010</span><span class="w">    </span><span class="n">calculateZLaunchParameters</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gridXSize</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">gridSize</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">threadBlockSize</span><span class="p">,</span><span class="w"> </span><span class="n">TUNE_MPD_Z_BLOCK_X_SIZE</span><span class="p">,</span><span class="w"> </span><span class="n">TUNE_MPD_Z_BLOCK_Z_SIZE</span><span class="p">,</span><span class="w"> </span><span class="n">latticeXSize</span><span class="p">,</span><span class="w"> </span><span class="n">latticeYSize</span><span class="p">,</span><span class="w"> </span><span class="n">latticeZSize</span><span class="p">);</span>
<span class="linenos">1011</span><span class="w">    </span><span class="n">CUDA_EXCEPTION_EXECUTE</span><span class="p">((</span><span class="n">mpdrdme_dev</span><span class="o">::</span><span class="n">mpd_z_kernel</span><span class="o">&lt;&lt;&lt;</span><span class="n">gridSize</span><span class="p">,</span><span class="n">threadBlockSize</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">cudaStream</span><span class="o">&gt;&gt;&gt;</span><span class="p">((</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getGPUMemorySrc</span><span class="p">(),</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getGPUMemorySiteTypes</span><span class="p">(),</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getGPUMemoryDest</span><span class="p">(),</span><span class="w"> </span><span class="n">gridXSize</span><span class="p">,</span><span class="w"> </span><span class="n">getTimestepSeed</span><span class="p">(</span><span class="n">timestep</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="p">)</span><span class="n">cudaOverflowList</span><span class="p">)));</span>
<span class="linenos">1012</span><span class="w">    </span><span class="cp">#endif</span>
<span class="linenos">1013</span><span class="w">    </span><span class="n">PROF_CUDA_END</span><span class="p">(</span><span class="n">PROF_MPD_Z_DIFFUSION</span><span class="p">,</span><span class="n">cudaStream</span><span class="p">);</span>
<span class="linenos">1014</span><span class="w">    </span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">swapSrcDest</span><span class="p">();</span>
<span class="linenos">1015</span>
<span class="linenos">1016</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">numberReactions</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">1017</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">1018</span><span class="w">        </span><span class="c1">// Execute the kernel for the reaction, this kernel updates the lattice in-place, so only the src pointer is passed.</span>
<span class="linenos">1019</span><span class="w">        </span><span class="n">PROF_CUDA_BEGIN</span><span class="p">(</span><span class="n">PROF_MPD_REACTION</span><span class="p">,</span><span class="n">cudaStream</span><span class="p">);</span>
<span class="linenos">1020</span><span class="w">        </span><span class="cp">#ifdef MPD_CUDA_3D_GRID_LAUNCH</span>
<span class="linenos">1021</span><span class="w">        </span><span class="n">calculateReactionLaunchParameters</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gridSize</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">threadBlockSize</span><span class="p">,</span><span class="w"> </span><span class="n">TUNE_MPD_REACTION_BLOCK_X_SIZE</span><span class="p">,</span><span class="w"> </span><span class="n">TUNE_MPD_REACTION_BLOCK_Y_SIZE</span><span class="p">,</span><span class="w"> </span><span class="n">latticeXSize</span><span class="p">,</span><span class="w"> </span><span class="n">latticeYSize</span><span class="p">,</span><span class="w"> </span><span class="n">latticeZSize</span><span class="p">);</span>
<span class="linenos">1022</span><span class="cp">#ifdef MPD_GLOBAL_S_MATRIX</span>
<span class="linenos">1023</span>
<span class="linenos">1024</span><span class="cp">#ifdef MPD_GLOBAL_R_MATRIX</span>
<span class="linenos">1025</span><span class="w">        </span><span class="cp">#ifdef MPD_FREAKYFAST</span>
<span class="linenos">1026</span><span class="w">                </span><span class="n">CUDA_EXCEPTION_EXECUTE</span><span class="p">((</span><span class="n">mpdrdme_dev</span><span class="o">::</span><span class="n">precomp_reaction_kernel</span><span class="o">&lt;&lt;&lt;</span><span class="n">gridSize</span><span class="p">,</span><span class="n">threadBlockSize</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">cudaStream</span><span class="o">&gt;&gt;&gt;</span><span class="p">((</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getGPUMemorySrc</span><span class="p">(),</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getGPUMemorySiteTypes</span><span class="p">(),</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getGPUMemorySrc</span><span class="p">(),</span><span class="w"> </span><span class="n">getTimestepSeed</span><span class="p">(</span><span class="n">timestep</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="p">)</span><span class="n">cudaOverflowList</span><span class="p">,</span><span class="w"> </span><span class="n">SG</span><span class="p">,</span><span class="w"> </span><span class="n">RLG</span><span class="p">,</span><span class="w"> </span><span class="n">reactionOrdersG</span><span class="p">,</span><span class="w"> </span><span class="n">reactionSitesG</span><span class="p">,</span><span class="w"> </span><span class="n">D1G</span><span class="p">,</span><span class="w"> </span><span class="n">D2G</span><span class="p">,</span><span class="w"> </span><span class="n">reactionRatesG</span><span class="p">,</span><span class="w"> </span><span class="n">propZeroOrder</span><span class="p">,</span><span class="w"> </span><span class="n">propFirstOrder</span><span class="p">,</span><span class="w"> </span><span class="n">propSecondOrder</span><span class="p">)));</span>
<span class="linenos">1027</span><span class="w">        </span><span class="cp">#else</span>
<span class="linenos">1028</span><span class="w">                </span><span class="n">CUDA_EXCEPTION_EXECUTE</span><span class="p">((</span><span class="n">mpdrdme_dev</span><span class="o">::</span><span class="n">reaction_kernel</span><span class="o">&lt;&lt;&lt;</span><span class="n">gridSize</span><span class="p">,</span><span class="n">threadBlockSize</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">cudaStream</span><span class="o">&gt;&gt;&gt;</span><span class="p">((</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getGPUMemorySrc</span><span class="p">(),</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getGPUMemorySiteTypes</span><span class="p">(),</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getGPUMemorySrc</span><span class="p">(),</span><span class="w"> </span><span class="n">getTimestepSeed</span><span class="p">(</span><span class="n">timestep</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="p">)</span><span class="n">cudaOverflowList</span><span class="p">,</span><span class="w"> </span><span class="n">SG</span><span class="p">,</span><span class="w"> </span><span class="n">RLG</span><span class="p">,</span><span class="w"> </span><span class="n">reactionOrdersG</span><span class="p">,</span><span class="w"> </span><span class="n">reactionSitesG</span><span class="p">,</span><span class="w"> </span><span class="n">D1G</span><span class="p">,</span><span class="w"> </span><span class="n">D2G</span><span class="p">,</span><span class="w"> </span><span class="n">reactionRatesG</span><span class="p">)));</span>
<span class="linenos">1029</span><span class="w">        </span><span class="cp">#endif</span>
<span class="linenos">1030</span><span class="cp">#else</span>
<span class="linenos">1031</span><span class="w">	</span><span class="cp">#ifdef MPD_FREAKYFAST</span>
<span class="linenos">1032</span><span class="w">		</span><span class="n">CUDA_EXCEPTION_EXECUTE</span><span class="p">((</span><span class="n">mpdrdme_dev</span><span class="o">::</span><span class="n">precomp_reaction_kernel</span><span class="o">&lt;&lt;&lt;</span><span class="n">gridSize</span><span class="p">,</span><span class="n">threadBlockSize</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">cudaStream</span><span class="o">&gt;&gt;&gt;</span><span class="p">((</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getGPUMemorySrc</span><span class="p">(),</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getGPUMemorySiteTypes</span><span class="p">(),</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getGPUMemorySrc</span><span class="p">(),</span><span class="w"> </span><span class="n">getTimestepSeed</span><span class="p">(</span><span class="n">timestep</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="p">)</span><span class="n">cudaOverflowList</span><span class="p">,</span><span class="w"> </span><span class="n">SG</span><span class="p">,</span><span class="w"> </span><span class="n">RLG</span><span class="p">,</span><span class="w"> </span><span class="n">propZeroOrder</span><span class="p">,</span><span class="w"> </span><span class="n">propFirstOrder</span><span class="p">,</span><span class="w"> </span><span class="n">propSecondOrder</span><span class="p">)));</span>
<span class="linenos">1033</span><span class="w">	</span><span class="cp">#else</span>
<span class="linenos">1034</span><span class="w">		</span><span class="n">CUDA_EXCEPTION_EXECUTE</span><span class="p">((</span><span class="n">mpdrdme_dev</span><span class="o">::</span><span class="n">reaction_kernel</span><span class="o">&lt;&lt;&lt;</span><span class="n">gridSize</span><span class="p">,</span><span class="n">threadBlockSize</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">cudaStream</span><span class="o">&gt;&gt;&gt;</span><span class="p">((</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getGPUMemorySrc</span><span class="p">(),</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getGPUMemorySiteTypes</span><span class="p">(),</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getGPUMemorySrc</span><span class="p">(),</span><span class="w"> </span><span class="n">getTimestepSeed</span><span class="p">(</span><span class="n">timestep</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="p">)</span><span class="n">cudaOverflowList</span><span class="p">,</span><span class="w"> </span><span class="n">SG</span><span class="p">,</span><span class="w"> </span><span class="n">RLG</span><span class="p">)));</span>
<span class="linenos">1035</span><span class="w">	</span><span class="cp">#endif</span>
<span class="linenos">1036</span><span class="cp">#endif</span>
<span class="linenos">1037</span>
<span class="linenos">1038</span><span class="cp">#else</span>
<span class="linenos">1039</span><span class="w">        </span><span class="n">CUDA_EXCEPTION_EXECUTE</span><span class="p">((</span><span class="n">mpdrdme_dev</span><span class="o">::</span><span class="n">reaction_kernel</span><span class="o">&lt;&lt;&lt;</span><span class="n">gridSize</span><span class="p">,</span><span class="n">threadBlockSize</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">cudaStream</span><span class="o">&gt;&gt;&gt;</span><span class="p">((</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getGPUMemorySrc</span><span class="p">(),</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getGPUMemorySiteTypes</span><span class="p">(),</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getGPUMemorySrc</span><span class="p">(),</span><span class="w"> </span><span class="n">getTimestepSeed</span><span class="p">(</span><span class="n">timestep</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="p">)</span><span class="n">cudaOverflowList</span><span class="p">)));</span>
<span class="linenos">1040</span><span class="cp">#endif</span>
<span class="linenos">1041</span><span class="w">        </span><span class="cp">#else</span>
<span class="linenos">1042</span><span class="w">        </span><span class="n">calculateReactionLaunchParameters</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gridXSize</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">gridSize</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">threadBlockSize</span><span class="p">,</span><span class="w"> </span><span class="n">TUNE_MPD_REACTION_BLOCK_X_SIZE</span><span class="p">,</span><span class="w"> </span><span class="n">TUNE_MPD_REACTION_BLOCK_Y_SIZE</span><span class="p">,</span><span class="w"> </span><span class="n">latticeXSize</span><span class="p">,</span><span class="w"> </span><span class="n">latticeYSize</span><span class="p">,</span><span class="w"> </span><span class="n">latticeZSize</span><span class="p">);</span>
<span class="linenos">1043</span><span class="cp">#ifdef MPD_GLOBAL_S_MATRIX</span>
<span class="linenos">1044</span><span class="w">        </span><span class="n">CUDA_EXCEPTION_EXECUTE</span><span class="p">((</span><span class="n">mpdrdme_dev</span><span class="o">::</span><span class="n">reaction_kernel</span><span class="o">&lt;&lt;&lt;</span><span class="n">gridSize</span><span class="p">,</span><span class="n">threadBlockSize</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">cudaStream</span><span class="o">&gt;&gt;&gt;</span><span class="p">((</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getGPUMemorySrc</span><span class="p">(),</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getGPUMemorySiteTypes</span><span class="p">(),</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getGPUMemorySrc</span><span class="p">(),</span><span class="w"> </span><span class="n">gridXSize</span><span class="p">,</span><span class="w"> </span><span class="n">getTimestepSeed</span><span class="p">(</span><span class="n">timestep</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="p">)</span><span class="n">cudaOverflowList</span><span class="p">,</span><span class="w"> </span><span class="n">SG</span><span class="p">,</span><span class="w"> </span><span class="n">RLG</span><span class="p">)));</span>
<span class="linenos">1045</span><span class="cp">#else</span>
<span class="linenos">1046</span><span class="w">        </span><span class="n">CUDA_EXCEPTION_EXECUTE</span><span class="p">((</span><span class="n">mpdrdme_dev</span><span class="o">::</span><span class="n">reaction_kernel</span><span class="o">&lt;&lt;&lt;</span><span class="n">gridSize</span><span class="p">,</span><span class="n">threadBlockSize</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">cudaStream</span><span class="o">&gt;&gt;&gt;</span><span class="p">((</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getGPUMemorySrc</span><span class="p">(),</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getGPUMemorySiteTypes</span><span class="p">(),</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getGPUMemorySrc</span><span class="p">(),</span><span class="w"> </span><span class="n">gridXSize</span><span class="p">,</span><span class="w"> </span><span class="n">getTimestepSeed</span><span class="p">(</span><span class="n">timestep</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="p">)</span><span class="n">cudaOverflowList</span><span class="p">)));</span>
<span class="linenos">1047</span><span class="cp">#endif</span>
<span class="linenos">1048</span><span class="w">        </span><span class="cp">#endif</span>
<span class="linenos">1049</span><span class="w">        </span><span class="n">PROF_CUDA_END</span><span class="p">(</span><span class="n">PROF_MPD_REACTION</span><span class="p">,</span><span class="n">cudaStream</span><span class="p">);</span>
<span class="linenos">1050</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">1051</span>
<span class="linenos">1052</span><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">overflow_handling</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">OVERFLOW_MODE_RELAXED</span><span class="p">)</span>
<span class="linenos">1053</span><span class="w">	</span><span class="n">mpdrdme_dev</span><span class="o">::</span><span class="n">correct_overflows</span><span class="o">&lt;&lt;&lt;</span><span class="kt">dim3</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="kt">dim3</span><span class="p">(</span><span class="n">TUNE_MPD_MAX_PARTICLE_OVERFLOWS</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="mi">0</span><span class="p">,</span><span class="n">cudaStream</span><span class="o">&gt;&gt;&gt;</span><span class="p">((</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="p">)</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getGPUMemorySrc</span><span class="p">(),</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="p">)</span><span class="n">cudaOverflowList</span><span class="p">);</span>
<span class="linenos">1054</span>
<span class="linenos">1055</span><span class="w">    </span><span class="c1">// Wait for the kernels to complete.</span>
<span class="linenos">1056</span><span class="w">    </span><span class="n">PROF_BEGIN</span><span class="p">(</span><span class="n">PROF_MPD_SYNCHRONIZE</span><span class="p">);</span>
<span class="linenos">1057</span><span class="w">    </span><span class="n">CUDA_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">cudaStreamSynchronize</span><span class="p">(</span><span class="n">cudaStream</span><span class="p">));</span>
<span class="linenos">1058</span><span class="w">    </span><span class="n">PROF_END</span><span class="p">(</span><span class="n">PROF_MPD_SYNCHRONIZE</span><span class="p">);</span>
<span class="linenos">1059</span>
<span class="linenos">1060</span><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">overflow_handling</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">OVERFLOW_MODE_RELAXED</span><span class="p">)</span>
<span class="linenos">1061</span><span class="w">	</span><span class="p">{</span>
<span class="linenos">1062</span><span class="w">		</span><span class="n">uint</span><span class="w"> </span><span class="n">unresolved</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="p">)</span><span class="n">cudaOverflowList</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
<span class="linenos">1063</span><span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">unresolved</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">1064</span><span class="w">		</span><span class="p">{</span>
<span class="linenos">1065</span><span class="w">            </span><span class="n">Print</span><span class="o">::</span><span class="n">printf</span><span class="p">(</span><span class="n">Print</span><span class="o">::</span><span class="n">WARNING</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;%d unresolved overflows&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">unresolved</span><span class="p">);</span>
<span class="linenos">1066</span><span class="w">		</span><span class="p">}</span>
<span class="linenos">1067</span><span class="w">	</span><span class="p">}</span>
<span class="linenos">1068</span>
<span class="linenos">1069</span><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">overflow_handling</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">OVERFLOW_MODE_CLASSIC</span><span class="p">)</span>
<span class="linenos">1070</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">1071</span>
<span class="linenos">1072</span><span class="w">    </span><span class="c1">// Handle any particle overflows.</span>
<span class="linenos">1073</span><span class="w">    </span><span class="n">PROF_BEGIN</span><span class="p">(</span><span class="n">PROF_MPD_OVERFLOW</span><span class="p">);</span>
<span class="linenos">1074</span><span class="w">    </span>
<span class="linenos">1075</span><span class="w">    </span><span class="n">overflowTimesteps</span><span class="o">++</span><span class="p">;</span>
<span class="linenos">1076</span><span class="cp">#ifndef MPD_MAPPED_OVERFLOWS</span>
<span class="linenos">1077</span><span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">overflowList</span><span class="p">[</span><span class="mi">1</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">TUNE_MPD_MAX_PARTICLE_OVERFLOWS</span><span class="p">];</span>
<span class="linenos">1078</span><span class="w">    </span><span class="n">CUDA_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">cudaMemcpy</span><span class="p">(</span><span class="n">overflowList</span><span class="p">,</span><span class="w"> </span><span class="n">cudaOverflowList</span><span class="p">,</span><span class="w"> </span><span class="n">MPD_OVERFLOW_LIST_SIZE</span><span class="p">,</span><span class="w"> </span><span class="n">cudaMemcpyDeviceToHost</span><span class="p">));</span>
<span class="linenos">1079</span><span class="cp">#else</span>
<span class="linenos">1080</span><span class="w">	</span><span class="kt">uint32_t</span><span class="w"> </span><span class="o">*</span><span class="n">overflowList</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uint32_t</span><span class="o">*</span><span class="p">)</span><span class="n">cudaOverflowList</span><span class="p">;</span>
<span class="linenos">1081</span><span class="cp">#endif</span>
<span class="linenos">1082</span>
<span class="linenos">1083</span><span class="w">    </span><span class="n">uint</span><span class="w"> </span><span class="n">numberExceptions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">overflowList</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="linenos">1084</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">numberExceptions</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">1085</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">1086</span><span class="w">        </span><span class="n">Print</span><span class="o">::</span><span class="n">printf</span><span class="p">(</span><span class="n">Print</span><span class="o">::</span><span class="n">DEBUG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;%d overflows&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">numberExceptions</span><span class="p">);</span>
<span class="linenos">1087</span>
<span class="linenos">1088</span><span class="w">        </span><span class="c1">// Make sure we did not exceed the overflow buffer.</span>
<span class="linenos">1089</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">numberExceptions</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">TUNE_MPD_MAX_PARTICLE_OVERFLOWS</span><span class="p">)</span>
<span class="linenos">1090</span><span class="w">            </span><span class="n">throw</span><span class="w"> </span><span class="n">Exception</span><span class="p">(</span><span class="s">&quot;Too many particle overflows for the available buffer&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">numberExceptions</span><span class="p">);</span>
<span class="linenos">1091</span>
<span class="linenos">1092</span><span class="w">        </span><span class="c1">// Synchronize the lattice.</span>
<span class="linenos">1093</span><span class="w">        </span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">copyFromGPU</span><span class="p">();</span>
<span class="linenos">1094</span><span class="w">        </span>
<span class="linenos">1095</span><span class="w">        </span><span class="c1">// Go through each exception.</span>
<span class="linenos">1096</span><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">numberExceptions</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">1097</span><span class="w">        </span><span class="p">{</span>
<span class="linenos">1098</span><span class="w">            </span><span class="c1">// Extract the index and particle type.</span>
<span class="linenos">1099</span><span class="w">            </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">latticeIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">overflowList</span><span class="p">[(</span><span class="n">i</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
<span class="linenos">1100</span><span class="w">            </span><span class="n">particle_t</span><span class="w"> </span><span class="n">particle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">overflowList</span><span class="p">[(</span><span class="n">i</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="mi">2</span><span class="p">];</span>
<span class="linenos">1101</span><span class="w">            </span>
<span class="linenos">1102</span><span class="w">            </span><span class="c1">// Get the x, y, and z coordiantes.</span>
<span class="linenos">1103</span><span class="w">            </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">latticeIndex</span><span class="o">%</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getXSize</span><span class="p">();</span>
<span class="linenos">1104</span><span class="w">            </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">latticeIndex</span><span class="o">/</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getXSize</span><span class="p">())</span><span class="o">%</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getYSize</span><span class="p">();</span>
<span class="linenos">1105</span><span class="w">            </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">latticeIndex</span><span class="o">/</span><span class="p">(</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getXSize</span><span class="p">()</span><span class="o">*</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getYSize</span><span class="p">());</span>
<span class="linenos">1106</span><span class="w">            </span>
<span class="linenos">1107</span><span class="w">            </span><span class="c1">// Put the particles back into a nearby lattice site.</span>
<span class="linenos">1108</span><span class="w">            </span><span class="kt">bool</span><span class="w"> </span><span class="n">replacedParticle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="linenos">1109</span><span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">searchRadius</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="o">!</span><span class="n">replacedParticle</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">searchRadius</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">TUNE_MPD_MAX_OVERFLOW_REPLACEMENT_DIST</span><span class="p">;</span><span class="w"> </span><span class="n">searchRadius</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">1110</span><span class="w">            </span><span class="p">{</span>
<span class="linenos">1111</span><span class="w">                </span><span class="c1">// Get the nearby sites.</span>
<span class="linenos">1112</span><span class="w">                </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">lattice_coord_t</span><span class="o">&gt;</span><span class="w"> </span><span class="n">sites</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getNearbySites</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">,(</span><span class="n">searchRadius</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span><span class="o">?</span><span class="n">searchRadius</span><span class="mi">-1</span><span class="o">:</span><span class="mi">0</span><span class="p">,</span><span class="n">searchRadius</span><span class="p">);</span>
<span class="linenos">1113</span><span class="w">                </span>
<span class="linenos">1114</span><span class="w">                </span><span class="c1">// TODO: Shuffle the sites.</span>
<span class="linenos">1115</span><span class="w">                </span>
<span class="linenos">1116</span><span class="w">                </span><span class="c1">// Try to find one that in not fully occupied and of the same type.</span>
<span class="linenos">1117</span><span class="w">                </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">lattice_coord_t</span><span class="o">&gt;::</span><span class="n">iterator</span><span class="w"> </span><span class="n">it</span><span class="o">=</span><span class="n">sites</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span><span class="w"> </span><span class="n">it</span><span class="o">&lt;</span><span class="n">sites</span><span class="p">.</span><span class="n">end</span><span class="p">();</span><span class="w"> </span><span class="n">it</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">1118</span><span class="w">                </span><span class="p">{</span>
<span class="linenos">1119</span><span class="w">                    </span><span class="n">lattice_coord_t</span><span class="w"> </span><span class="n">site</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">it</span><span class="p">;</span>
<span class="linenos">1120</span><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getOccupancy</span><span class="p">(</span><span class="n">site</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="n">site</span><span class="p">.</span><span class="n">y</span><span class="p">,</span><span class="n">site</span><span class="p">.</span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getMaxOccupancy</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getSiteType</span><span class="p">(</span><span class="n">site</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="n">site</span><span class="p">.</span><span class="n">y</span><span class="p">,</span><span class="n">site</span><span class="p">.</span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getSiteType</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">))</span>
<span class="linenos">1121</span><span class="w">                    </span><span class="p">{</span>
<span class="linenos">1122</span><span class="w">                        </span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">addParticle</span><span class="p">(</span><span class="n">site</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">site</span><span class="p">.</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">site</span><span class="p">.</span><span class="n">z</span><span class="p">,</span><span class="w"> </span><span class="n">particle</span><span class="p">);</span>
<span class="linenos">1123</span><span class="w">                        </span><span class="n">replacedParticle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="linenos">1124</span><span class="w">                        </span><span class="n">Print</span><span class="o">::</span><span class="n">printf</span><span class="p">(</span><span class="n">Print</span><span class="o">::</span><span class="n">VERBOSE_DEBUG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Handled overflow of particle %d at site %d,%d,%d type=%d occ=%d by placing at site %d,%d,%d type=%d newocc=%d dist=%0.2f&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">particle</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">z</span><span class="p">,</span><span class="w"> </span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getSiteType</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">),</span><span class="w"> </span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getOccupancy</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">),</span><span class="w"> </span><span class="n">site</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">site</span><span class="p">.</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">site</span><span class="p">.</span><span class="n">z</span><span class="p">,</span><span class="w"> </span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getSiteType</span><span class="p">(</span><span class="n">site</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="n">site</span><span class="p">.</span><span class="n">y</span><span class="p">,</span><span class="n">site</span><span class="p">.</span><span class="n">z</span><span class="p">),</span><span class="w"> </span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getOccupancy</span><span class="p">(</span><span class="n">site</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="n">site</span><span class="p">.</span><span class="n">y</span><span class="p">,</span><span class="n">site</span><span class="p">.</span><span class="n">z</span><span class="p">),</span><span class="w"> </span><span class="n">sqrt</span><span class="p">(</span><span class="n">pow</span><span class="p">((</span><span class="kt">double</span><span class="p">)</span><span class="n">x</span><span class="o">-</span><span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="n">site</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="mf">2.0</span><span class="p">)</span><span class="o">+</span><span class="n">pow</span><span class="p">((</span><span class="kt">double</span><span class="p">)</span><span class="n">y</span><span class="o">-</span><span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="n">site</span><span class="p">.</span><span class="n">y</span><span class="p">,</span><span class="mf">2.0</span><span class="p">)</span><span class="o">+</span><span class="n">pow</span><span class="p">((</span><span class="kt">double</span><span class="p">)</span><span class="n">z</span><span class="o">-</span><span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="n">site</span><span class="p">.</span><span class="n">z</span><span class="p">,</span><span class="mf">2.0</span><span class="p">)));</span>
<span class="linenos">1125</span><span class="w">                        </span><span class="k">break</span><span class="p">;</span>
<span class="linenos">1126</span><span class="w">                    </span><span class="p">}</span>
<span class="linenos">1127</span><span class="w">                </span><span class="p">}</span>
<span class="linenos">1128</span><span class="w">            </span><span class="p">}</span>
<span class="linenos">1129</span><span class="w">            </span>
<span class="linenos">1130</span><span class="w">            </span><span class="c1">// If we were not able to fix the exception, throw an error.</span>
<span class="linenos">1131</span><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">replacedParticle</span><span class="p">)</span>
<span class="linenos">1132</span><span class="w">                </span><span class="n">throw</span><span class="w"> </span><span class="n">Exception</span><span class="p">(</span><span class="s">&quot;Unable to find an available site to handle a particle overflow.&quot;</span><span class="p">);</span>
<span class="linenos">1133</span><span class="w">        </span><span class="p">}</span>
<span class="linenos">1134</span><span class="w">        </span>
<span class="linenos">1135</span><span class="w">            </span>
<span class="linenos">1136</span><span class="w">        </span><span class="c1">// Copy the changes back to the GPU.</span>
<span class="linenos">1137</span><span class="w">        </span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">copyToGPU</span><span class="p">();</span>
<span class="linenos">1138</span><span class="w">            </span>
<span class="linenos">1139</span><span class="w">        </span><span class="c1">// Reset the overflow list.</span>
<span class="linenos">1140</span><span class="w">        </span><span class="n">CUDA_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">cudaMemset</span><span class="p">(</span><span class="n">cudaOverflowList</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">MPD_OVERFLOW_LIST_SIZE</span><span class="p">));</span>
<span class="linenos">1141</span>
<span class="linenos">1142</span><span class="w">        </span><span class="c1">// Track that we used the overflow list.</span>
<span class="linenos">1143</span><span class="w">        </span><span class="n">overflowListUses</span><span class="o">++</span><span class="p">;</span>
<span class="linenos">1144</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">1145</span><span class="w">    </span>
<span class="linenos">1146</span><span class="w">    </span><span class="c1">// If the overflow lsit is being used too often, print a warning.</span>
<span class="linenos">1147</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">overflowTimesteps</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">1000</span><span class="p">)</span>
<span class="linenos">1148</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">1149</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">overflowListUses</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">10</span><span class="p">)</span>
<span class="linenos">1150</span><span class="w">            </span><span class="n">Print</span><span class="o">::</span><span class="n">printf</span><span class="p">(</span><span class="n">Print</span><span class="o">::</span><span class="n">WARNING</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;%d uses of the particle overflow list in the last 1000 timesteps, performance may be degraded.&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">overflowListUses</span><span class="p">);</span>
<span class="linenos">1151</span><span class="w">        </span><span class="n">overflowTimesteps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">1152</span><span class="w">        </span><span class="n">overflowListUses</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">1153</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">1154</span><span class="w">    </span><span class="n">PROF_END</span><span class="p">(</span><span class="n">PROF_MPD_OVERFLOW</span><span class="p">);</span>
<span class="linenos">1155</span><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="c1">// End classic overflow</span>
<span class="linenos">1156</span>
<span class="linenos">1157</span><span class="w">    </span><span class="n">PROF_CUDA_FINISH</span><span class="p">(</span><span class="n">cudaStream</span><span class="p">);</span>
<span class="linenos">1158</span><span class="w">    </span><span class="n">PROF_END</span><span class="p">(</span><span class="n">PROF_MPD_TIMESTEP</span><span class="p">);</span>
<span class="linenos">1159</span><span class="p">}</span>
<span class="linenos">1160</span>
<span class="linenos">1161</span><span class="cp">#ifdef MPD_CUDA_3D_GRID_LAUNCH</span>
<span class="linenos">1162</span><span class="cm">/**</span>
<span class="linenos">1163</span><span class="cm"> * Gets the launch parameters for launching an x diffusion kernel.</span>
<span class="linenos">1164</span><span class="cm"> */</span>
<span class="linenos">1165</span><span class="kt">void</span><span class="w"> </span><span class="n">MpdRdmeSolver</span><span class="o">::</span><span class="n">calculateXLaunchParameters</span><span class="p">(</span><span class="kt">dim3</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">gridSize</span><span class="p">,</span><span class="w"> </span><span class="kt">dim3</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">threadBlockSize</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">maxXBlockSize</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeXSize</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeYSize</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeZSize</span><span class="p">)</span>
<span class="linenos">1166</span><span class="p">{</span>
<span class="linenos">1167</span><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">xBlockXSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">min</span><span class="p">(</span><span class="n">maxXBlockSize</span><span class="p">,</span><span class="n">latticeXSize</span><span class="p">);</span>
<span class="linenos">1168</span><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">gridXSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">latticeXSize</span><span class="o">/</span><span class="n">xBlockXSize</span><span class="p">;</span>
<span class="linenos">1169</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">gridXSize</span><span class="o">*</span><span class="n">xBlockXSize</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">latticeXSize</span><span class="p">)</span>
<span class="linenos">1170</span><span class="w">	</span><span class="p">{</span>
<span class="linenos">1171</span><span class="w">		</span><span class="c1">// Find the largest number of warps that is divisible</span>
<span class="linenos">1172</span><span class="w">		</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">tryx</span><span class="o">=</span><span class="mi">32</span><span class="p">;</span>
<span class="linenos">1173</span><span class="w">		</span><span class="k">while</span><span class="p">(</span><span class="n">tryx</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">maxXBlockSize</span><span class="p">)</span>
<span class="linenos">1174</span><span class="w">		</span><span class="p">{</span>
<span class="linenos">1175</span><span class="w">			</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">latticeXSize</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">tryx</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">1176</span><span class="w">				</span><span class="n">xBlockXSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tryx</span><span class="p">;</span>
<span class="linenos">1177</span><span class="w">			</span><span class="n">tryx</span><span class="w"> </span><span class="o">+=</span><span class="mi">32</span><span class="p">;</span>
<span class="linenos">1178</span><span class="w">		</span><span class="p">}</span>
<span class="linenos">1179</span><span class="w">		</span><span class="n">gridXSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">latticeXSize</span><span class="o">/</span><span class="n">xBlockXSize</span><span class="p">;</span>
<span class="linenos">1180</span><span class="w">	</span><span class="p">}</span>
<span class="linenos">1181</span><span class="w">			</span>
<span class="linenos">1182</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">gridSize</span><span class="p">).</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gridXSize</span><span class="p">;</span>
<span class="linenos">1183</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">gridSize</span><span class="p">).</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">latticeYSize</span><span class="p">;</span>
<span class="linenos">1184</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">gridSize</span><span class="p">).</span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">latticeZSize</span><span class="p">;</span>
<span class="linenos">1185</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">threadBlockSize</span><span class="p">).</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">xBlockXSize</span><span class="p">;</span>
<span class="linenos">1186</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">threadBlockSize</span><span class="p">).</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="linenos">1187</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">threadBlockSize</span><span class="p">).</span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="linenos">1188</span><span class="p">}</span>
<span class="linenos">1189</span>
<span class="linenos">1190</span><span class="cm">/**</span>
<span class="linenos">1191</span><span class="cm"> * Gets the launch parameters for launching a y diffusion kernel.</span>
<span class="linenos">1192</span><span class="cm"> */</span>
<span class="linenos">1193</span><span class="kt">void</span><span class="w"> </span><span class="n">MpdRdmeSolver</span><span class="o">::</span><span class="n">calculateYLaunchParameters</span><span class="p">(</span><span class="kt">dim3</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">gridSize</span><span class="p">,</span><span class="w"> </span><span class="kt">dim3</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">threadBlockSize</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">blockXSize</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">blockYSize</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeXSize</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeYSize</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeZSize</span><span class="p">)</span>
<span class="linenos">1194</span><span class="p">{</span>
<span class="linenos">1195</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">gridSize</span><span class="p">).</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">latticeXSize</span><span class="o">/</span><span class="n">blockXSize</span><span class="p">;</span>
<span class="linenos">1196</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">gridSize</span><span class="p">).</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">latticeYSize</span><span class="o">/</span><span class="n">blockYSize</span><span class="p">;</span>
<span class="linenos">1197</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">gridSize</span><span class="p">).</span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">latticeZSize</span><span class="p">;</span>
<span class="linenos">1198</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">threadBlockSize</span><span class="p">).</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blockXSize</span><span class="p">;</span>
<span class="linenos">1199</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">threadBlockSize</span><span class="p">).</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blockYSize</span><span class="p">;</span>
<span class="linenos">1200</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">threadBlockSize</span><span class="p">).</span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="linenos">1201</span><span class="p">}</span>
<span class="linenos">1202</span>
<span class="linenos">1203</span><span class="cm">/**</span>
<span class="linenos">1204</span><span class="cm"> * Gets the launch parameters for launching a z diffusion kernel.</span>
<span class="linenos">1205</span><span class="cm"> */</span>
<span class="linenos">1206</span><span class="kt">void</span><span class="w"> </span><span class="n">MpdRdmeSolver</span><span class="o">::</span><span class="n">calculateZLaunchParameters</span><span class="p">(</span><span class="kt">dim3</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">gridSize</span><span class="p">,</span><span class="w"> </span><span class="kt">dim3</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">threadBlockSize</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">blockXSize</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">blockZSize</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeXSize</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeYSize</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeZSize</span><span class="p">)</span>
<span class="linenos">1207</span><span class="p">{</span>
<span class="linenos">1208</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">gridSize</span><span class="p">).</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">latticeXSize</span><span class="o">/</span><span class="n">blockXSize</span><span class="p">;</span>
<span class="linenos">1209</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">gridSize</span><span class="p">).</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">latticeYSize</span><span class="p">;</span>
<span class="linenos">1210</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">gridSize</span><span class="p">).</span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">latticeZSize</span><span class="o">/</span><span class="n">blockZSize</span><span class="p">;</span>
<span class="linenos">1211</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">threadBlockSize</span><span class="p">).</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blockXSize</span><span class="p">;</span>
<span class="linenos">1212</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">threadBlockSize</span><span class="p">).</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="linenos">1213</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">threadBlockSize</span><span class="p">).</span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blockZSize</span><span class="p">;</span>
<span class="linenos">1214</span><span class="p">}</span>
<span class="linenos">1215</span>
<span class="linenos">1216</span><span class="cm">/**</span>
<span class="linenos">1217</span><span class="cm"> * Gets the launch parameters for launching a y diffusion kernel.</span>
<span class="linenos">1218</span><span class="cm"> */</span>
<span class="linenos">1219</span><span class="kt">void</span><span class="w"> </span><span class="n">MpdRdmeSolver</span><span class="o">::</span><span class="n">calculateReactionLaunchParameters</span><span class="p">(</span><span class="kt">dim3</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">gridSize</span><span class="p">,</span><span class="w"> </span><span class="kt">dim3</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">threadBlockSize</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">blockXSize</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">blockYSize</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeXSize</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeYSize</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeZSize</span><span class="p">)</span>
<span class="linenos">1220</span><span class="p">{</span>
<span class="linenos">1221</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">gridSize</span><span class="p">).</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">latticeXSize</span><span class="o">/</span><span class="n">blockXSize</span><span class="p">;</span>
<span class="linenos">1222</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">gridSize</span><span class="p">).</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">latticeYSize</span><span class="o">/</span><span class="n">blockYSize</span><span class="p">;</span>
<span class="linenos">1223</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">gridSize</span><span class="p">).</span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">latticeZSize</span><span class="p">;</span>
<span class="linenos">1224</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">threadBlockSize</span><span class="p">).</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blockXSize</span><span class="p">;</span>
<span class="linenos">1225</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">threadBlockSize</span><span class="p">).</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blockYSize</span><span class="p">;</span>
<span class="linenos">1226</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">threadBlockSize</span><span class="p">).</span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="linenos">1227</span><span class="p">}</span>
<span class="linenos">1228</span>
<span class="linenos">1229</span><span class="cp">#else</span>
<span class="linenos">1230</span><span class="cm">/**</span>
<span class="linenos">1231</span><span class="cm"> * Gets the launch parameters for launching an x diffusion kernel.</span>
<span class="linenos">1232</span><span class="cm"> */</span>
<span class="linenos">1233</span><span class="kt">void</span><span class="w"> </span><span class="n">MpdRdmeSolver</span><span class="o">::</span><span class="n">calculateXLaunchParameters</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">gridXSize</span><span class="p">,</span><span class="w"> </span><span class="kt">dim3</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">gridSize</span><span class="p">,</span><span class="w"> </span><span class="kt">dim3</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">threadBlockSize</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">maxXBlockSize</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeXSize</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeYSize</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeZSize</span><span class="p">)</span>
<span class="linenos">1234</span><span class="p">{</span>
<span class="linenos">1235</span><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">xBlockXSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">min</span><span class="p">(</span><span class="n">maxXBlockSize</span><span class="p">,</span><span class="n">latticeXSize</span><span class="p">);</span>
<span class="linenos">1236</span><span class="w">    </span><span class="o">*</span><span class="n">gridXSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">latticeXSize</span><span class="o">/</span><span class="n">xBlockXSize</span><span class="p">;</span>
<span class="linenos">1237</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">gridXSize</span><span class="o">*</span><span class="n">xBlockXSize</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">latticeXSize</span><span class="p">)</span>
<span class="linenos">1238</span><span class="w">	</span><span class="p">{</span>
<span class="linenos">1239</span><span class="w">		</span><span class="c1">// Find the largest number of warps that is divisible</span>
<span class="linenos">1240</span><span class="w">		</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">tryx</span><span class="o">=</span><span class="mi">32</span><span class="p">;</span>
<span class="linenos">1241</span><span class="w">		</span><span class="k">while</span><span class="p">(</span><span class="n">tryx</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">maxXBlockSize</span><span class="p">)</span>
<span class="linenos">1242</span><span class="w">		</span><span class="p">{</span>
<span class="linenos">1243</span><span class="w">			</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">latticeXSize</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">tryx</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">1244</span><span class="w">				</span><span class="n">xBlockXSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tryx</span><span class="p">;</span>
<span class="linenos">1245</span><span class="w">			</span><span class="n">tryx</span><span class="w"> </span><span class="o">+=</span><span class="mi">32</span><span class="p">;</span>
<span class="linenos">1246</span><span class="w">		</span><span class="p">}</span>
<span class="linenos">1247</span><span class="w">		</span><span class="n">gridXSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">latticeXSize</span><span class="o">/</span><span class="n">xBlockXSize</span><span class="p">;</span>
<span class="linenos">1248</span><span class="w">	</span><span class="p">}</span>
<span class="linenos">1249</span>
<span class="linenos">1250</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">gridSize</span><span class="p">).</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">gridXSize</span><span class="p">)</span><span class="o">*</span><span class="n">latticeYSize</span><span class="p">;</span>
<span class="linenos">1251</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">gridSize</span><span class="p">).</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">latticeZSize</span><span class="p">;</span>
<span class="linenos">1252</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">gridSize</span><span class="p">).</span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="linenos">1253</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">threadBlockSize</span><span class="p">).</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">xBlockXSize</span><span class="p">;</span>
<span class="linenos">1254</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">threadBlockSize</span><span class="p">).</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="linenos">1255</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">threadBlockSize</span><span class="p">).</span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="linenos">1256</span><span class="p">}</span>
<span class="linenos">1257</span>
<span class="linenos">1258</span><span class="cm">/**</span>
<span class="linenos">1259</span><span class="cm"> * Gets the launch parameters for launching a y diffusion kernel.</span>
<span class="linenos">1260</span><span class="cm"> */</span>
<span class="linenos">1261</span><span class="kt">void</span><span class="w"> </span><span class="n">MpdRdmeSolver</span><span class="o">::</span><span class="n">calculateYLaunchParameters</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">gridXSize</span><span class="p">,</span><span class="w"> </span><span class="kt">dim3</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">gridSize</span><span class="p">,</span><span class="w"> </span><span class="kt">dim3</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">threadBlockSize</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">blockXSize</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">blockYSize</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeXSize</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeYSize</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeZSize</span><span class="p">)</span>
<span class="linenos">1262</span><span class="p">{</span>
<span class="linenos">1263</span><span class="w">    </span><span class="o">*</span><span class="n">gridXSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">latticeXSize</span><span class="o">/</span><span class="n">blockXSize</span><span class="p">;</span>
<span class="linenos">1264</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">gridSize</span><span class="p">).</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">gridXSize</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">latticeYSize</span><span class="o">/</span><span class="n">blockYSize</span><span class="p">);</span>
<span class="linenos">1265</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">gridSize</span><span class="p">).</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">latticeZSize</span><span class="p">;</span>
<span class="linenos">1266</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">gridSize</span><span class="p">).</span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="linenos">1267</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">threadBlockSize</span><span class="p">).</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blockXSize</span><span class="p">;</span>
<span class="linenos">1268</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">threadBlockSize</span><span class="p">).</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blockYSize</span><span class="p">;</span>
<span class="linenos">1269</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">threadBlockSize</span><span class="p">).</span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="linenos">1270</span><span class="p">}</span>
<span class="linenos">1271</span>
<span class="linenos">1272</span><span class="cm">/**</span>
<span class="linenos">1273</span><span class="cm"> * Gets the launch parameters for launching a z diffusion kernel.</span>
<span class="linenos">1274</span><span class="cm"> */</span>
<span class="linenos">1275</span><span class="kt">void</span><span class="w"> </span><span class="n">MpdRdmeSolver</span><span class="o">::</span><span class="n">calculateZLaunchParameters</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">gridXSize</span><span class="p">,</span><span class="w"> </span><span class="kt">dim3</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">gridSize</span><span class="p">,</span><span class="w"> </span><span class="kt">dim3</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">threadBlockSize</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">blockXSize</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">blockZSize</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeXSize</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeYSize</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeZSize</span><span class="p">)</span>
<span class="linenos">1276</span><span class="p">{</span>
<span class="linenos">1277</span><span class="w">    </span><span class="o">*</span><span class="n">gridXSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">latticeXSize</span><span class="o">/</span><span class="n">blockXSize</span><span class="p">;</span>
<span class="linenos">1278</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">gridSize</span><span class="p">).</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">gridXSize</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">latticeYSize</span><span class="p">);</span>
<span class="linenos">1279</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">gridSize</span><span class="p">).</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">latticeZSize</span><span class="o">/</span><span class="n">blockZSize</span><span class="p">;</span>
<span class="linenos">1280</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">gridSize</span><span class="p">).</span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="linenos">1281</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">threadBlockSize</span><span class="p">).</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blockXSize</span><span class="p">;</span>
<span class="linenos">1282</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">threadBlockSize</span><span class="p">).</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="linenos">1283</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">threadBlockSize</span><span class="p">).</span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blockZSize</span><span class="p">;</span>
<span class="linenos">1284</span><span class="p">}</span>
<span class="linenos">1285</span>
<span class="linenos">1286</span><span class="cm">/**</span>
<span class="linenos">1287</span><span class="cm"> * Gets the launch parameters for launching a reaction diffusion kernel.</span>
<span class="linenos">1288</span><span class="cm"> */</span>
<span class="linenos">1289</span><span class="kt">void</span><span class="w"> </span><span class="n">MpdRdmeSolver</span><span class="o">::</span><span class="n">calculateReactionLaunchParameters</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">gridXSize</span><span class="p">,</span><span class="w"> </span><span class="kt">dim3</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">gridSize</span><span class="p">,</span><span class="w"> </span><span class="kt">dim3</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">threadBlockSize</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">blockXSize</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">blockYSize</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeXSize</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeYSize</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeZSize</span><span class="p">)</span>
<span class="linenos">1290</span><span class="p">{</span>
<span class="linenos">1291</span><span class="w">    </span><span class="o">*</span><span class="n">gridXSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">latticeXSize</span><span class="o">/</span><span class="n">blockXSize</span><span class="p">;</span>
<span class="linenos">1292</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">gridSize</span><span class="p">).</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">gridXSize</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">latticeYSize</span><span class="o">/</span><span class="n">blockYSize</span><span class="p">);</span>
<span class="linenos">1293</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">gridSize</span><span class="p">).</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">latticeZSize</span><span class="p">;</span>
<span class="linenos">1294</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">gridSize</span><span class="p">).</span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="linenos">1295</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">threadBlockSize</span><span class="p">).</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blockXSize</span><span class="p">;</span>
<span class="linenos">1296</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">threadBlockSize</span><span class="p">).</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blockYSize</span><span class="p">;</span>
<span class="linenos">1297</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">threadBlockSize</span><span class="p">).</span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="linenos">1298</span><span class="p">}</span>
<span class="linenos">1299</span><span class="cp">#endif</span>
<span class="linenos">1300</span>
<span class="linenos">1301</span>
<span class="linenos">1302</span><span class="n">namespace</span><span class="w"> </span><span class="n">mpdrdme_dev</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">1303</span><span class="cm">/**</span>
<span class="linenos">1304</span><span class="cm"> * Multiparticle diffusion performed by copying the lattice section to shared memory, making a choice for each lattice</span>
<span class="linenos">1305</span><span class="cm"> * site, storing the new lattice into shared memory, and then updating the global lattice.</span>
<span class="linenos">1306</span><span class="cm"> */</span>
<span class="linenos">1307</span><span class="cp">#ifdef MPD_CUDA_3D_GRID_LAUNCH</span>
<span class="linenos">1308</span><span class="kr">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">__launch_bounds__</span><span class="p">(</span><span class="n">TUNE_MPD_X_BLOCK_MAX_X_SIZE</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="n">mpd_x_kernel</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">inLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">inSites</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">outLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">)</span>
<span class="linenos">1309</span><span class="p">{</span>
<span class="linenos">1310</span><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">bx</span><span class="o">=</span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">by</span><span class="o">=</span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">bz</span><span class="o">=</span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">z</span><span class="p">;</span>
<span class="linenos">1311</span><span class="cp">#else</span>
<span class="linenos">1312</span><span class="kr">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">__launch_bounds__</span><span class="p">(</span><span class="n">TUNE_MPD_X_BLOCK_MAX_X_SIZE</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="n">mpd_x_kernel</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">inLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">inSites</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">outLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">gridXSize</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">)</span>
<span class="linenos">1313</span><span class="p">{</span>
<span class="linenos">1314</span><span class="w">    </span><span class="kt">__shared__</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">bx</span><span class="p">,</span><span class="w"> </span><span class="n">by</span><span class="p">,</span><span class="w"> </span><span class="n">bz</span><span class="p">;</span>
<span class="linenos">1315</span><span class="w">    </span><span class="n">calculateBlockPosition</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bx</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">by</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">bz</span><span class="p">,</span><span class="w"> </span><span class="n">gridXSize</span><span class="p">);</span>
<span class="linenos">1316</span><span class="cp">#endif</span>
<span class="linenos">1317</span>
<span class="linenos">1318</span><span class="w">    </span><span class="c1">// Figure out the offset of this thread in the lattice and the lattice segment.</span>
<span class="linenos">1319</span><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeXIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">bx</span><span class="o">*</span><span class="nb">blockDim</span><span class="p">.</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
<span class="linenos">1320</span><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">bz</span><span class="o">*</span><span class="n">latticeXYSizeC</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">by</span><span class="o">*</span><span class="n">latticeXSizeC</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">latticeXIndex</span><span class="p">;</span>
<span class="linenos">1321</span><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">windowIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="o">+</span><span class="n">MPD_APRON_SIZE</span><span class="p">;</span>
<span class="linenos">1322</span>
<span class="linenos">1323</span><span class="w">    </span><span class="c1">///////////////////////////////////////////</span>
<span class="linenos">1324</span><span class="w">    </span><span class="c1">// Load the lattice into shared memory. //</span>
<span class="linenos">1325</span><span class="w">    </span><span class="c1">///////////////////////////////////////////</span>
<span class="linenos">1326</span>
<span class="linenos">1327</span><span class="w">    </span><span class="c1">// Shared memory to store the lattice segment.</span>
<span class="linenos">1328</span><span class="w">    </span><span class="kt">__shared__</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">window</span><span class="p">[</span><span class="n">MPD_X_WINDOW_SIZE</span><span class="o">*</span><span class="n">MPD_WORDS_PER_SITE</span><span class="p">];</span>
<span class="linenos">1329</span><span class="w">    </span><span class="kt">__shared__</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">sitesWindow</span><span class="p">[</span><span class="n">MPD_X_WINDOW_SIZE</span><span class="p">];</span>
<span class="linenos">1330</span>
<span class="linenos">1331</span><span class="w">    </span><span class="c1">// Copy the x window from device memory into shared memory.</span>
<span class="linenos">1332</span><span class="w">    </span><span class="n">copyXWindowFromLattice</span><span class="p">(</span><span class="n">bx</span><span class="p">,</span><span class="w"> </span><span class="n">inLattice</span><span class="p">,</span><span class="w"> </span><span class="n">window</span><span class="p">,</span><span class="w"> </span><span class="n">latticeIndex</span><span class="p">,</span><span class="w"> </span><span class="n">latticeXIndex</span><span class="p">,</span><span class="w"> </span><span class="n">windowIndex</span><span class="p">);</span>
<span class="linenos">1333</span><span class="w">    </span><span class="n">copyXWindowFromSites</span><span class="p">(</span><span class="n">bx</span><span class="p">,</span><span class="w"> </span><span class="n">inSites</span><span class="p">,</span><span class="w"> </span><span class="n">sitesWindow</span><span class="p">,</span><span class="w"> </span><span class="n">latticeIndex</span><span class="p">,</span><span class="w"> </span><span class="n">latticeXIndex</span><span class="p">,</span><span class="w"> </span><span class="n">windowIndex</span><span class="p">);</span>
<span class="linenos">1334</span><span class="w">    </span><span class="nf">__syncthreads</span><span class="p">();</span>
<span class="linenos">1335</span>
<span class="linenos">1336</span><span class="w">    </span><span class="c1">////////////////////////////////////////</span>
<span class="linenos">1337</span><span class="w">    </span><span class="c1">// Make the choice for each particle. //</span>
<span class="linenos">1338</span><span class="w">    </span><span class="c1">////////////////////////////////////////</span>
<span class="linenos">1339</span>
<span class="linenos">1340</span><span class="w">    </span><span class="kt">__shared__</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">choices</span><span class="p">[</span><span class="n">MPD_X_WINDOW_SIZE</span><span class="o">*</span><span class="n">MPD_WORDS_PER_SITE</span><span class="p">];</span>
<span class="linenos">1341</span>
<span class="linenos">1342</span><span class="w">    </span><span class="c1">// Make the choices.</span>
<span class="linenos">1343</span><span class="w">    </span><span class="n">makeXDiffusionChoices</span><span class="p">(</span><span class="n">window</span><span class="p">,</span><span class="w"> </span><span class="n">sitesWindow</span><span class="p">,</span><span class="w"> </span><span class="n">choices</span><span class="p">,</span><span class="w"> </span><span class="n">latticeIndex</span><span class="p">,</span><span class="w"> </span><span class="n">latticeXIndex</span><span class="p">,</span><span class="w"> </span><span class="n">windowIndex</span><span class="p">,</span><span class="w"> </span><span class="nb">blockDim</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">);</span>
<span class="linenos">1344</span><span class="w">    </span><span class="nf">__syncthreads</span><span class="p">();</span>
<span class="linenos">1345</span>
<span class="linenos">1346</span><span class="w">    </span><span class="c1">//////////////////////////////////////////////////////////</span>
<span class="linenos">1347</span><span class="w">    </span><span class="c1">// Create version of the lattice at the next time step. //</span>
<span class="linenos">1348</span><span class="w">    </span><span class="c1">//////////////////////////////////////////////////////////</span>
<span class="linenos">1349</span>
<span class="linenos">1350</span><span class="w">    </span><span class="c1">// Propagate the choices to the new lattice segment.</span>
<span class="linenos">1351</span><span class="w">    </span><span class="n">performPropagation</span><span class="p">(</span><span class="n">outLattice</span><span class="p">,</span><span class="w"> </span><span class="n">window</span><span class="p">,</span><span class="w"> </span><span class="n">choices</span><span class="p">,</span><span class="w"> </span><span class="n">latticeIndex</span><span class="p">,</span><span class="w"> </span><span class="n">windowIndex</span><span class="mi">-1</span><span class="p">,</span><span class="w"> </span><span class="n">windowIndex</span><span class="p">,</span><span class="w"> </span><span class="n">windowIndex</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">MPD_X_WINDOW_SIZE</span><span class="p">,</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">);</span>
<span class="linenos">1352</span><span class="p">}</span>
<span class="linenos">1353</span>
<span class="linenos">1354</span><span class="cm">/**</span>
<span class="linenos">1355</span><span class="cm"> * Multiparticle diffusion performed by copying the lattice section to shared memory, making a choice for each lattice</span>
<span class="linenos">1356</span><span class="cm"> * site, storing the new lattice into shared memory, and then updating the global lattice.</span>
<span class="linenos">1357</span><span class="cm"> */</span>
<span class="linenos">1358</span><span class="cp">#ifdef MPD_CUDA_3D_GRID_LAUNCH</span>
<span class="linenos">1359</span><span class="kr">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">__launch_bounds__</span><span class="p">(</span><span class="n">TUNE_MPD_Y_BLOCK_X_SIZE</span><span class="o">*</span><span class="n">TUNE_MPD_Y_BLOCK_Y_SIZE</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="n">mpd_y_kernel</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">inLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">inSites</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">outLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">)</span>
<span class="linenos">1360</span><span class="p">{</span>
<span class="linenos">1361</span><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">bx</span><span class="o">=</span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">by</span><span class="o">=</span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">bz</span><span class="o">=</span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">z</span><span class="p">;</span>
<span class="linenos">1362</span><span class="cp">#else</span>
<span class="linenos">1363</span><span class="kr">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">__launch_bounds__</span><span class="p">(</span><span class="n">TUNE_MPD_Y_BLOCK_X_SIZE</span><span class="o">*</span><span class="n">TUNE_MPD_Y_BLOCK_Y_SIZE</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="n">mpd_y_kernel</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">inLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">inSites</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">outLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">gridXSize</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">)</span>
<span class="linenos">1364</span><span class="p">{</span>
<span class="linenos">1365</span><span class="w">    </span><span class="kt">__shared__</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">bx</span><span class="p">,</span><span class="w"> </span><span class="n">by</span><span class="p">,</span><span class="w"> </span><span class="n">bz</span><span class="p">;</span>
<span class="linenos">1366</span><span class="w">    </span><span class="n">calculateBlockPosition</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bx</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">by</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">bz</span><span class="p">,</span><span class="w"> </span><span class="n">gridXSize</span><span class="p">);</span>
<span class="linenos">1367</span><span class="cp">#endif</span>
<span class="linenos">1368</span>
<span class="linenos">1369</span><span class="w">    </span><span class="c1">// Figure out the offset of this thread in the lattice and the lattice segment.</span>
<span class="linenos">1370</span><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeYIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">by</span><span class="o">*</span><span class="nb">blockDim</span><span class="p">.</span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
<span class="linenos">1371</span><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">bz</span><span class="o">*</span><span class="n">latticeXYSizeC</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">latticeYIndex</span><span class="o">*</span><span class="n">latticeXSizeC</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">bx</span><span class="o">*</span><span class="nb">blockDim</span><span class="p">.</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
<span class="linenos">1372</span><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">windowYIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">y</span><span class="o">+</span><span class="n">MPD_APRON_SIZE</span><span class="p">;</span>
<span class="linenos">1373</span><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">windowIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">windowYIndex</span><span class="o">*</span><span class="nb">blockDim</span><span class="p">.</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
<span class="linenos">1374</span>
<span class="linenos">1375</span><span class="w">    </span><span class="c1">///////////////////////////////////////////</span>
<span class="linenos">1376</span><span class="w">    </span><span class="c1">// Load the lattice into shared memory. //</span>
<span class="linenos">1377</span><span class="w">    </span><span class="c1">///////////////////////////////////////////</span>
<span class="linenos">1378</span>
<span class="linenos">1379</span><span class="w">    </span><span class="c1">// Shared memory to store the lattice segment. Each lattice site has four particles, eight bits for each particle.</span>
<span class="linenos">1380</span><span class="w">    </span><span class="kt">__shared__</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">window</span><span class="p">[</span><span class="n">MPD_Y_WINDOW_SIZE</span><span class="o">*</span><span class="n">MPD_WORDS_PER_SITE</span><span class="p">];</span>
<span class="linenos">1381</span><span class="w">    </span><span class="kt">__shared__</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">sitesWindow</span><span class="p">[</span><span class="n">MPD_Y_WINDOW_SIZE</span><span class="p">];</span>
<span class="linenos">1382</span>
<span class="linenos">1383</span><span class="w">    </span><span class="c1">// Copy the x window from device memory into shared memory.</span>
<span class="linenos">1384</span><span class="w">    </span><span class="n">copyYWindowFromLattice</span><span class="p">(</span><span class="n">inLattice</span><span class="p">,</span><span class="w"> </span><span class="n">window</span><span class="p">,</span><span class="w"> </span><span class="n">latticeIndex</span><span class="p">,</span><span class="w"> </span><span class="n">latticeYIndex</span><span class="p">,</span><span class="w"> </span><span class="n">windowIndex</span><span class="p">,</span><span class="w"> </span><span class="n">windowYIndex</span><span class="p">);</span>
<span class="linenos">1385</span><span class="w">    </span><span class="n">copyYWindowFromSites</span><span class="p">(</span><span class="n">inSites</span><span class="p">,</span><span class="w"> </span><span class="n">sitesWindow</span><span class="p">,</span><span class="w"> </span><span class="n">latticeIndex</span><span class="p">,</span><span class="w"> </span><span class="n">latticeYIndex</span><span class="p">,</span><span class="w"> </span><span class="n">windowIndex</span><span class="p">,</span><span class="w"> </span><span class="n">windowYIndex</span><span class="p">);</span>
<span class="linenos">1386</span><span class="w">    </span><span class="nf">__syncthreads</span><span class="p">();</span>
<span class="linenos">1387</span>
<span class="linenos">1388</span><span class="w">    </span><span class="c1">////////////////////////////////////////</span>
<span class="linenos">1389</span><span class="w">    </span><span class="c1">// Make the choice for each particle. //</span>
<span class="linenos">1390</span><span class="w">    </span><span class="c1">////////////////////////////////////////</span>
<span class="linenos">1391</span>
<span class="linenos">1392</span><span class="w">    </span><span class="kt">__shared__</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">choices</span><span class="p">[</span><span class="n">MPD_Y_WINDOW_SIZE</span><span class="o">*</span><span class="n">MPD_WORDS_PER_SITE</span><span class="p">];</span>
<span class="linenos">1393</span>
<span class="linenos">1394</span><span class="w">    </span><span class="c1">// Make the choices.</span>
<span class="linenos">1395</span><span class="w">    </span><span class="n">makeYDiffusionChoices</span><span class="p">(</span><span class="n">window</span><span class="p">,</span><span class="w"> </span><span class="n">sitesWindow</span><span class="p">,</span><span class="w"> </span><span class="n">choices</span><span class="p">,</span><span class="w"> </span><span class="n">latticeIndex</span><span class="p">,</span><span class="w"> </span><span class="n">latticeYIndex</span><span class="p">,</span><span class="w"> </span><span class="n">windowIndex</span><span class="p">,</span><span class="w"> </span><span class="n">windowYIndex</span><span class="p">,</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">);</span>
<span class="linenos">1396</span><span class="w">    </span><span class="nf">__syncthreads</span><span class="p">();</span>
<span class="linenos">1397</span>
<span class="linenos">1398</span><span class="w">    </span><span class="c1">//////////////////////////////////////////////////////////</span>
<span class="linenos">1399</span><span class="w">    </span><span class="c1">// Create version of the lattice at the next time step. //</span>
<span class="linenos">1400</span><span class="w">    </span><span class="c1">//////////////////////////////////////////////////////////</span>
<span class="linenos">1401</span>
<span class="linenos">1402</span><span class="w">    </span><span class="c1">// Progate the choices to the new lattice segment.</span>
<span class="linenos">1403</span><span class="w">    </span><span class="n">performPropagation</span><span class="p">(</span><span class="n">outLattice</span><span class="p">,</span><span class="w"> </span><span class="n">window</span><span class="p">,</span><span class="w"> </span><span class="n">choices</span><span class="p">,</span><span class="w"> </span><span class="n">latticeIndex</span><span class="p">,</span><span class="w"> </span><span class="n">windowIndex</span><span class="o">-</span><span class="n">TUNE_MPD_Y_BLOCK_X_SIZE</span><span class="p">,</span><span class="w"> </span><span class="n">windowIndex</span><span class="p">,</span><span class="w"> </span><span class="n">windowIndex</span><span class="o">+</span><span class="n">TUNE_MPD_Y_BLOCK_X_SIZE</span><span class="p">,</span><span class="w"> </span><span class="n">MPD_Y_WINDOW_SIZE</span><span class="p">,</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">);</span>
<span class="linenos">1404</span><span class="p">}</span>
<span class="linenos">1405</span>
<span class="linenos">1406</span><span class="cm">/**</span>
<span class="linenos">1407</span><span class="cm"> * Multiparticle diffusion performed by copying the lattice section to shared memory, making a choice for each lattice</span>
<span class="linenos">1408</span><span class="cm"> * site, storing the new lattice into shared memory, and then updating the global lattice.</span>
<span class="linenos">1409</span><span class="cm"> */</span>
<span class="linenos">1410</span><span class="cp">#ifdef MPD_CUDA_3D_GRID_LAUNCH</span>
<span class="linenos">1411</span><span class="kr">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">__launch_bounds__</span><span class="p">(</span><span class="n">TUNE_MPD_Z_BLOCK_X_SIZE</span><span class="o">*</span><span class="n">TUNE_MPD_Z_BLOCK_Z_SIZE</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="n">mpd_z_kernel</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">inLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">inSites</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">outLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">)</span>
<span class="linenos">1412</span><span class="p">{</span>
<span class="linenos">1413</span><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">bx</span><span class="o">=</span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">by</span><span class="o">=</span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">bz</span><span class="o">=</span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">z</span><span class="p">;</span>
<span class="linenos">1414</span><span class="cp">#else</span>
<span class="linenos">1415</span><span class="kr">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">__launch_bounds__</span><span class="p">(</span><span class="n">TUNE_MPD_Z_BLOCK_X_SIZE</span><span class="o">*</span><span class="n">TUNE_MPD_Z_BLOCK_Z_SIZE</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="n">mpd_z_kernel</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">inLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">inSites</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">outLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">gridXSize</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">)</span>
<span class="linenos">1416</span><span class="p">{</span>
<span class="linenos">1417</span><span class="w">    </span><span class="kt">__shared__</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">bx</span><span class="p">,</span><span class="w"> </span><span class="n">by</span><span class="p">,</span><span class="w"> </span><span class="n">bz</span><span class="p">;</span>
<span class="linenos">1418</span><span class="w">    </span><span class="n">calculateBlockPosition</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bx</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">by</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">bz</span><span class="p">,</span><span class="w"> </span><span class="n">gridXSize</span><span class="p">);</span>
<span class="linenos">1419</span><span class="cp">#endif</span>
<span class="linenos">1420</span>
<span class="linenos">1421</span><span class="w">    </span><span class="c1">// Figure out the offset of this thread in the lattice and the lattice segment.</span>
<span class="linenos">1422</span><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeZIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">bz</span><span class="o">*</span><span class="nb">blockDim</span><span class="p">.</span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">z</span><span class="p">;</span>
<span class="linenos">1423</span><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">latticeZIndex</span><span class="o">*</span><span class="n">latticeXYSizeC</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">by</span><span class="o">*</span><span class="n">latticeXSizeC</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">bx</span><span class="o">*</span><span class="nb">blockDim</span><span class="p">.</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
<span class="linenos">1424</span><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">windowZIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">z</span><span class="o">+</span><span class="n">MPD_APRON_SIZE</span><span class="p">;</span>
<span class="linenos">1425</span><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">windowIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">windowZIndex</span><span class="o">*</span><span class="nb">blockDim</span><span class="p">.</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
<span class="linenos">1426</span>
<span class="linenos">1427</span><span class="w">    </span><span class="c1">///////////////////////////////////////////</span>
<span class="linenos">1428</span><span class="w">    </span><span class="c1">// Load the lattice into shared memory. //</span>
<span class="linenos">1429</span><span class="w">    </span><span class="c1">///////////////////////////////////////////</span>
<span class="linenos">1430</span>
<span class="linenos">1431</span><span class="w">    </span><span class="c1">// Shared memory to store the lattice segment. Each lattice site has four particles, eight bits for each particle.</span>
<span class="linenos">1432</span><span class="w">    </span><span class="kt">__shared__</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">window</span><span class="p">[</span><span class="n">MPD_Z_WINDOW_SIZE</span><span class="o">*</span><span class="n">MPD_WORDS_PER_SITE</span><span class="p">];</span>
<span class="linenos">1433</span><span class="w">    </span><span class="kt">__shared__</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">sitesWindow</span><span class="p">[</span><span class="n">MPD_Z_WINDOW_SIZE</span><span class="p">];</span>
<span class="linenos">1434</span>
<span class="linenos">1435</span><span class="w">    </span><span class="c1">// Copy the x window from device memory into shared memory.</span>
<span class="linenos">1436</span><span class="w">    </span><span class="n">copyZWindowFromLattice</span><span class="p">(</span><span class="n">inLattice</span><span class="p">,</span><span class="w"> </span><span class="n">window</span><span class="p">,</span><span class="w"> </span><span class="n">latticeIndex</span><span class="p">,</span><span class="w"> </span><span class="n">latticeZIndex</span><span class="p">,</span><span class="w"> </span><span class="n">windowIndex</span><span class="p">,</span><span class="w"> </span><span class="n">windowZIndex</span><span class="p">);</span>
<span class="linenos">1437</span><span class="w">    </span><span class="n">copyZWindowFromSites</span><span class="p">(</span><span class="n">inSites</span><span class="p">,</span><span class="w"> </span><span class="n">sitesWindow</span><span class="p">,</span><span class="w"> </span><span class="n">latticeIndex</span><span class="p">,</span><span class="w"> </span><span class="n">latticeZIndex</span><span class="p">,</span><span class="w"> </span><span class="n">windowIndex</span><span class="p">,</span><span class="w"> </span><span class="n">windowZIndex</span><span class="p">);</span>
<span class="linenos">1438</span><span class="w">    </span><span class="nf">__syncthreads</span><span class="p">();</span>
<span class="linenos">1439</span>
<span class="linenos">1440</span><span class="w">    </span><span class="c1">////////////////////////////////////////</span>
<span class="linenos">1441</span><span class="w">    </span><span class="c1">// Make the choice for each particle. //</span>
<span class="linenos">1442</span><span class="w">    </span><span class="c1">////////////////////////////////////////</span>
<span class="linenos">1443</span>
<span class="linenos">1444</span><span class="w">    </span><span class="kt">__shared__</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">choices</span><span class="p">[</span><span class="n">MPD_Z_WINDOW_SIZE</span><span class="o">*</span><span class="n">MPD_WORDS_PER_SITE</span><span class="p">];</span>
<span class="linenos">1445</span>
<span class="linenos">1446</span><span class="w">    </span><span class="c1">// Make the choices.</span>
<span class="linenos">1447</span><span class="w">    </span><span class="n">makeZDiffusionChoices</span><span class="p">(</span><span class="n">window</span><span class="p">,</span><span class="w"> </span><span class="n">sitesWindow</span><span class="p">,</span><span class="w"> </span><span class="n">choices</span><span class="p">,</span><span class="w"> </span><span class="n">latticeIndex</span><span class="p">,</span><span class="w"> </span><span class="n">latticeZIndex</span><span class="p">,</span><span class="w"> </span><span class="n">windowIndex</span><span class="p">,</span><span class="w"> </span><span class="n">windowZIndex</span><span class="p">,</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">);</span>
<span class="linenos">1448</span><span class="w">    </span><span class="nf">__syncthreads</span><span class="p">();</span>
<span class="linenos">1449</span>
<span class="linenos">1450</span><span class="w">    </span><span class="c1">//////////////////////////////////////////////////////////</span>
<span class="linenos">1451</span><span class="w">    </span><span class="c1">// Create version of the lattice at the next time step. //</span>
<span class="linenos">1452</span><span class="w">    </span><span class="c1">//////////////////////////////////////////////////////////</span>
<span class="linenos">1453</span>
<span class="linenos">1454</span><span class="w">    </span><span class="c1">// Progate the choices to the new lattice segment.</span>
<span class="linenos">1455</span><span class="w">    </span><span class="n">performPropagation</span><span class="p">(</span><span class="n">outLattice</span><span class="p">,</span><span class="w"> </span><span class="n">window</span><span class="p">,</span><span class="w"> </span><span class="n">choices</span><span class="p">,</span><span class="w"> </span><span class="n">latticeIndex</span><span class="p">,</span><span class="w"> </span><span class="n">windowIndex</span><span class="o">-</span><span class="n">TUNE_MPD_Z_BLOCK_X_SIZE</span><span class="p">,</span><span class="w"> </span><span class="n">windowIndex</span><span class="p">,</span><span class="w"> </span><span class="n">windowIndex</span><span class="o">+</span><span class="n">TUNE_MPD_Z_BLOCK_X_SIZE</span><span class="p">,</span><span class="w"> </span><span class="n">MPD_Z_WINDOW_SIZE</span><span class="p">,</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">);</span>
<span class="linenos">1456</span><span class="p">}</span>
<span class="linenos">1457</span>
<span class="linenos">1458</span><span class="cm">/**</span>
<span class="linenos">1459</span><span class="cm"> * Multiparticle diffusion performed by copying the lattice section to shared memory, making a choice for each lattice</span>
<span class="linenos">1460</span><span class="cm"> * site, storing the new lattice into shared memory, and then updating the global lattice.</span>
<span class="linenos">1461</span><span class="cm"> */</span>
<span class="linenos">1462</span><span class="cp">#ifdef MPD_CUDA_3D_GRID_LAUNCH</span>
<span class="linenos">1463</span><span class="cp">#ifdef MPD_GLOBAL_S_MATRIX</span>
<span class="linenos">1464</span><span class="cp">#ifdef MPD_GLOBAL_R_MATRIX</span>
<span class="linenos">1465</span><span class="kr">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">__launch_bounds__</span><span class="p">(</span><span class="n">TUNE_MPD_REACTION_BLOCK_X_SIZE</span><span class="o">*</span><span class="n">TUNE_MPD_REACTION_BLOCK_Y_SIZE</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="n">reaction_kernel</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">inLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">inSites</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">outLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="kt">int8_t</span><span class="w"> </span><span class="o">*</span><span class="n">SG</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="n">RLG</span><span class="p">,</span><span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="n">reactionOrdersG</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="n">reactionSitesG</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="n">D1G</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="n">D2G</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="n">reactionRatesG</span><span class="p">)</span>
<span class="linenos">1466</span><span class="cp">#else</span>
<span class="linenos">1467</span><span class="kr">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">__launch_bounds__</span><span class="p">(</span><span class="n">TUNE_MPD_REACTION_BLOCK_X_SIZE</span><span class="o">*</span><span class="n">TUNE_MPD_REACTION_BLOCK_Y_SIZE</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="n">reaction_kernel</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">inLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">inSites</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">outLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="kt">int8_t</span><span class="w"> </span><span class="o">*</span><span class="n">SG</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="n">RLG</span><span class="p">)</span>
<span class="linenos">1468</span><span class="cp">#endif</span>
<span class="linenos">1469</span><span class="cp">#else</span>
<span class="linenos">1470</span><span class="kr">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">__launch_bounds__</span><span class="p">(</span><span class="n">TUNE_MPD_REACTION_BLOCK_X_SIZE</span><span class="o">*</span><span class="n">TUNE_MPD_REACTION_BLOCK_Y_SIZE</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="n">reaction_kernel</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">inLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">inSites</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">outLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">)</span>
<span class="linenos">1471</span><span class="cp">#endif</span>
<span class="linenos">1472</span><span class="p">{</span>
<span class="linenos">1473</span><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">bx</span><span class="o">=</span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">by</span><span class="o">=</span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">bz</span><span class="o">=</span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">z</span><span class="p">;</span>
<span class="linenos">1474</span><span class="cp">#else</span>
<span class="linenos">1475</span><span class="cp">#ifdef MPD_GLOBAL_S_MATRIX</span>
<span class="linenos">1476</span><span class="cp">#ifdef MPD_GLOBAL_R_MATRIX</span>
<span class="linenos">1477</span><span class="kr">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">__launch_bounds__</span><span class="p">(</span><span class="n">TUNE_MPD_REACTION_BLOCK_X_SIZE</span><span class="o">*</span><span class="n">TUNE_MPD_REACTION_BLOCK_Y_SIZE</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="n">reaction_kernel</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">inLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">inSites</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">outLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">gridXSize</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="kt">int8_t</span><span class="w"> </span><span class="o">*</span><span class="n">SG</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="n">RLG</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="n">reactionOrdersG</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="n">reactionSitesG</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="n">D1G</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="n">D2G</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="n">reactionRatesG</span><span class="p">)</span>
<span class="linenos">1478</span><span class="cp">#else</span>
<span class="linenos">1479</span><span class="kr">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">__launch_bounds__</span><span class="p">(</span><span class="n">TUNE_MPD_REACTION_BLOCK_X_SIZE</span><span class="o">*</span><span class="n">TUNE_MPD_REACTION_BLOCK_Y_SIZE</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="n">reaction_kernel</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">inLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">inSites</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">outLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">gridXSize</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="kt">int8_t</span><span class="w"> </span><span class="o">*</span><span class="n">SG</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="n">RLG</span><span class="p">)</span>
<span class="linenos">1480</span><span class="cp">#endif</span>
<span class="linenos">1481</span><span class="cp">#else</span>
<span class="linenos">1482</span><span class="kr">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">__launch_bounds__</span><span class="p">(</span><span class="n">TUNE_MPD_REACTION_BLOCK_X_SIZE</span><span class="o">*</span><span class="n">TUNE_MPD_REACTION_BLOCK_Y_SIZE</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="n">reaction_kernel</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">inLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">inSites</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">outLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">gridXSize</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">)</span>
<span class="linenos">1483</span><span class="cp">#endif</span>
<span class="linenos">1484</span><span class="p">{</span>
<span class="linenos">1485</span><span class="w">    </span><span class="kt">__shared__</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">bx</span><span class="p">,</span><span class="w"> </span><span class="n">by</span><span class="p">,</span><span class="w"> </span><span class="n">bz</span><span class="p">;</span>
<span class="linenos">1486</span><span class="w">    </span><span class="n">calculateBlockPosition</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bx</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">by</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">bz</span><span class="p">,</span><span class="w"> </span><span class="n">gridXSize</span><span class="p">);</span>
<span class="linenos">1487</span><span class="cp">#endif</span>
<span class="linenos">1488</span>
<span class="linenos">1489</span><span class="w">    </span><span class="c1">// Figure out the offset of this thread in the lattice and the lattice segment.</span>
<span class="linenos">1490</span><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeYIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">by</span><span class="o">*</span><span class="nb">blockDim</span><span class="p">.</span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
<span class="linenos">1491</span><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">bz</span><span class="o">*</span><span class="n">latticeXYSizeC</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">latticeYIndex</span><span class="o">*</span><span class="n">latticeXSizeC</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">bx</span><span class="o">*</span><span class="nb">blockDim</span><span class="p">.</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
<span class="linenos">1492</span>
<span class="linenos">1493</span><span class="w">    </span><span class="c1">///////////////////////////////////////////</span>
<span class="linenos">1494</span><span class="w">    </span><span class="c1">// Load the particles and site.          //</span>
<span class="linenos">1495</span><span class="w">    </span><span class="c1">///////////////////////////////////////////</span>
<span class="linenos">1496</span>
<span class="linenos">1497</span><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">particles</span><span class="p">[</span><span class="n">MPD_WORDS_PER_SITE</span><span class="p">];</span>
<span class="linenos">1498</span><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">w</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">latticeOffset</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">w</span><span class="o">&lt;</span><span class="n">MPD_WORDS_PER_SITE</span><span class="p">;</span><span class="w"> </span><span class="n">w</span><span class="o">++</span><span class="p">,</span><span class="w"> </span><span class="n">latticeOffset</span><span class="o">+=</span><span class="n">latticeXYZSizeC</span><span class="p">)</span>
<span class="linenos">1499</span><span class="w">        </span><span class="n">particles</span><span class="p">[</span><span class="n">w</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inLattice</span><span class="p">[</span><span class="n">latticeIndex</span><span class="o">+</span><span class="n">latticeOffset</span><span class="p">];</span>
<span class="linenos">1500</span><span class="w">    </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">siteType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inSites</span><span class="p">[</span><span class="n">latticeIndex</span><span class="p">];</span>
<span class="linenos">1501</span>
<span class="linenos">1502</span><span class="w">    </span><span class="c1">////////////////////////////////////////</span>
<span class="linenos">1503</span><span class="w">    </span><span class="c1">// Perform the reactions.             //</span>
<span class="linenos">1504</span><span class="w">    </span><span class="c1">////////////////////////////////////////</span>
<span class="linenos">1505</span>
<span class="linenos">1506</span><span class="w">    </span><span class="c1">// Calculate the kinetic rate for each reaction at this site.</span>
<span class="linenos">1507</span><span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">totalReactionPropensity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">;</span>
<span class="linenos">1508</span><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">numberReactionsC</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">1509</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">1510</span><span class="cp">#ifdef MPD_GLOBAL_S_MATRIX</span>
<span class="linenos">1511</span><span class="cp">#ifdef MPD_GLOBAL_R_MATRIX</span>
<span class="linenos">1512</span><span class="w">        </span><span class="n">totalReactionPropensity</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">calculateReactionPropensity</span><span class="p">(</span><span class="n">siteType</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="o">*</span><span class="p">)</span><span class="n">particles</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">RLG</span><span class="p">,</span><span class="w"> </span><span class="n">reactionOrdersG</span><span class="p">,</span><span class="w"> </span><span class="n">reactionSitesG</span><span class="p">,</span><span class="w"> </span><span class="n">D1G</span><span class="p">,</span><span class="w"> </span><span class="n">D2G</span><span class="p">,</span><span class="w"> </span><span class="n">reactionRatesG</span><span class="p">);</span>
<span class="linenos">1513</span><span class="cp">#else</span>
<span class="linenos">1514</span><span class="w">        </span><span class="n">totalReactionPropensity</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">calculateReactionPropensity</span><span class="p">(</span><span class="n">siteType</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="o">*</span><span class="p">)</span><span class="n">particles</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">RLG</span><span class="p">);</span>
<span class="linenos">1515</span><span class="cp">#endif</span>
<span class="linenos">1516</span><span class="cp">#else</span>
<span class="linenos">1517</span><span class="w">        </span><span class="n">totalReactionPropensity</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">calculateReactionPropensity</span><span class="p">(</span><span class="n">siteType</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="o">*</span><span class="p">)</span><span class="n">particles</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">);</span>
<span class="linenos">1518</span><span class="cp">#endif</span>
<span class="linenos">1519</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">1520</span>
<span class="linenos">1521</span><span class="w">	</span><span class="c1">// If propensity is zero, no reaction can occur.</span>
<span class="linenos">1522</span><span class="w">	</span><span class="k">if</span><span class="p">(</span><span class="n">totalReactionPropensity</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">)</span>
<span class="linenos">1523</span><span class="w">		</span><span class="k">return</span><span class="p">;</span>
<span class="linenos">1524</span>
<span class="linenos">1525</span><span class="w">    </span><span class="c1">// See if a reaction occurred at the site.</span>
<span class="linenos">1526</span><span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">reactionProbability</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">calculateReactionProbability</span><span class="p">(</span><span class="n">totalReactionPropensity</span><span class="p">);</span>
<span class="linenos">1527</span><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">reactionOccurred</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">checkForReaction</span><span class="p">(</span><span class="n">latticeIndex</span><span class="p">,</span><span class="w"> </span><span class="n">reactionProbability</span><span class="p">,</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">);</span>
<span class="linenos">1528</span>
<span class="linenos">1529</span><span class="w">    </span><span class="c1">// If there was a reaction, process it.</span>
<span class="linenos">1530</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">reactionOccurred</span><span class="p">)</span>
<span class="linenos">1531</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">1532</span><span class="w">        </span><span class="c1">// Figure out which reaction occurred.</span>
<span class="linenos">1533</span><span class="cp">#ifdef MPD_GLOBAL_S_MATRIX</span>
<span class="linenos">1534</span><span class="cp">#ifdef MPD_GLOBAL_R_MATRIX</span>
<span class="linenos">1535</span><span class="w">        </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">reactionIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">determineReactionIndex</span><span class="p">(</span><span class="n">siteType</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="o">*</span><span class="p">)</span><span class="n">particles</span><span class="p">,</span><span class="w"> </span><span class="n">latticeIndex</span><span class="p">,</span><span class="w"> </span><span class="n">totalReactionPropensity</span><span class="p">,</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">,</span><span class="w"> </span><span class="n">RLG</span><span class="p">,</span><span class="w"> </span><span class="n">reactionOrdersG</span><span class="p">,</span><span class="w"> </span><span class="n">reactionSitesG</span><span class="p">,</span><span class="w"> </span><span class="n">D1G</span><span class="p">,</span><span class="w"> </span><span class="n">D2G</span><span class="p">,</span><span class="w"> </span><span class="n">reactionRatesG</span><span class="p">);</span>
<span class="linenos">1536</span><span class="cp">#else</span>
<span class="linenos">1537</span><span class="w">        </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">reactionIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">determineReactionIndex</span><span class="p">(</span><span class="n">siteType</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="o">*</span><span class="p">)</span><span class="n">particles</span><span class="p">,</span><span class="w"> </span><span class="n">latticeIndex</span><span class="p">,</span><span class="w"> </span><span class="n">totalReactionPropensity</span><span class="p">,</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">,</span><span class="w"> </span><span class="n">RLG</span><span class="p">);</span>
<span class="linenos">1538</span><span class="cp">#endif</span>
<span class="linenos">1539</span><span class="cp">#else</span>
<span class="linenos">1540</span><span class="w">        </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">reactionIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">determineReactionIndex</span><span class="p">(</span><span class="n">siteType</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="o">*</span><span class="p">)</span><span class="n">particles</span><span class="p">,</span><span class="w"> </span><span class="n">latticeIndex</span><span class="p">,</span><span class="w"> </span><span class="n">totalReactionPropensity</span><span class="p">,</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">);</span>
<span class="linenos">1541</span><span class="cp">#endif</span>
<span class="linenos">1542</span>
<span class="linenos">1543</span><span class="w">        </span><span class="c1">// Construct the new site.</span>
<span class="linenos">1544</span><span class="cp">#ifdef MPD_GLOBAL_S_MATRIX</span>
<span class="linenos">1545</span><span class="w">        </span><span class="n">evaluateReaction</span><span class="p">(</span><span class="n">latticeIndex</span><span class="p">,</span><span class="w"> </span><span class="n">siteType</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="o">*</span><span class="p">)</span><span class="n">particles</span><span class="p">,</span><span class="w"> </span><span class="n">reactionIndex</span><span class="p">,</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">,</span><span class="w"> </span><span class="n">SG</span><span class="p">);</span>
<span class="linenos">1546</span><span class="cp">#else</span>
<span class="linenos">1547</span><span class="w">        </span><span class="n">evaluateReaction</span><span class="p">(</span><span class="n">latticeIndex</span><span class="p">,</span><span class="w"> </span><span class="n">siteType</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="o">*</span><span class="p">)</span><span class="n">particles</span><span class="p">,</span><span class="w"> </span><span class="n">reactionIndex</span><span class="p">,</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">);</span>
<span class="linenos">1548</span><span class="cp">#endif</span>
<span class="linenos">1549</span>
<span class="linenos">1550</span><span class="w">        </span><span class="c1">// Copy the new particles back into the lattice.</span>
<span class="linenos">1551</span><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">w</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">latticeOffset</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">w</span><span class="o">&lt;</span><span class="n">MPD_WORDS_PER_SITE</span><span class="p">;</span><span class="w"> </span><span class="n">w</span><span class="o">++</span><span class="p">,</span><span class="w"> </span><span class="n">latticeOffset</span><span class="o">+=</span><span class="n">latticeXYZSizeC</span><span class="p">)</span>
<span class="linenos">1552</span><span class="w">             </span><span class="n">outLattice</span><span class="p">[</span><span class="n">latticeIndex</span><span class="o">+</span><span class="n">latticeOffset</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">particles</span><span class="p">[</span><span class="n">w</span><span class="p">];</span>
<span class="linenos">1553</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">1554</span><span class="p">}</span>
<span class="linenos">1555</span>
<span class="linenos">1556</span><span class="cp">#ifdef MPD_GLOBAL_S_MATRIX</span>
<span class="linenos">1557</span><span class="cp">#ifdef MPD_GLOBAL_R_MATRIX</span>
<span class="linenos">1558</span><span class="kr">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">__launch_bounds__</span><span class="p">(</span><span class="n">TUNE_MPD_REACTION_BLOCK_X_SIZE</span><span class="o">*</span><span class="n">TUNE_MPD_REACTION_BLOCK_Y_SIZE</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="n">precomp_reaction_kernel</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">inLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">inSites</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">outLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="kt">int8_t</span><span class="w"> </span><span class="o">*</span><span class="n">SG</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="n">RLG</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="n">reactionOrdersG</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="n">reactionSitesG</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="n">D1G</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="n">D2G</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="n">reactionRatesG</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="n">qp0</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="n">qp1</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="n">qp2</span><span class="p">)</span>
<span class="linenos">1559</span><span class="cp">#else</span>
<span class="linenos">1560</span><span class="kr">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">__launch_bounds__</span><span class="p">(</span><span class="n">TUNE_MPD_REACTION_BLOCK_X_SIZE</span><span class="o">*</span><span class="n">TUNE_MPD_REACTION_BLOCK_Y_SIZE</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="n">precomp_reaction_kernel</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">inLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">inSites</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">outLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="kt">int8_t</span><span class="w"> </span><span class="o">*</span><span class="n">SG</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="n">RLG</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="n">qp0</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="n">qp1</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="n">qp2</span><span class="p">)</span>
<span class="linenos">1561</span><span class="cp">#endif</span>
<span class="linenos">1562</span><span class="cp">#else</span>
<span class="linenos">1563</span><span class="kr">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">__launch_bounds__</span><span class="p">(</span><span class="n">TUNE_MPD_REACTION_BLOCK_X_SIZE</span><span class="o">*</span><span class="n">TUNE_MPD_REACTION_BLOCK_Y_SIZE</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="n">precomp_reaction_kernel</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">inLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">inSites</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">outLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="n">qp0</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="n">qp1</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="n">qp2</span><span class="p">)</span>
<span class="linenos">1564</span><span class="cp">#endif</span>
<span class="linenos">1565</span><span class="p">{</span>
<span class="linenos">1566</span><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">bx</span><span class="o">=</span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">by</span><span class="o">=</span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">bz</span><span class="o">=</span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">z</span><span class="p">;</span>
<span class="linenos">1567</span>
<span class="linenos">1568</span><span class="w">    </span><span class="c1">// Figure out the offset of this thread in the lattice and the lattice segment.</span>
<span class="linenos">1569</span><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeYIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">by</span><span class="o">*</span><span class="nb">blockDim</span><span class="p">.</span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
<span class="linenos">1570</span><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">bz</span><span class="o">*</span><span class="n">latticeXYSizeC</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">latticeYIndex</span><span class="o">*</span><span class="n">latticeXSizeC</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">bx</span><span class="o">*</span><span class="nb">blockDim</span><span class="p">.</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
<span class="linenos">1571</span>
<span class="linenos">1572</span><span class="w">    </span><span class="c1">///////////////////////////////////////////</span>
<span class="linenos">1573</span><span class="w">    </span><span class="c1">// Load the particles and site.          //</span>
<span class="linenos">1574</span><span class="w">    </span><span class="c1">///////////////////////////////////////////</span>
<span class="linenos">1575</span>
<span class="linenos">1576</span><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">particles</span><span class="p">[</span><span class="n">MPD_WORDS_PER_SITE</span><span class="p">];</span>
<span class="linenos">1577</span><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">w</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">latticeOffset</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">w</span><span class="o">&lt;</span><span class="n">MPD_WORDS_PER_SITE</span><span class="p">;</span><span class="w"> </span><span class="n">w</span><span class="o">++</span><span class="p">,</span><span class="w"> </span><span class="n">latticeOffset</span><span class="o">+=</span><span class="n">latticeXYZSizeC</span><span class="p">)</span>
<span class="linenos">1578</span><span class="w">        </span><span class="n">particles</span><span class="p">[</span><span class="n">w</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inLattice</span><span class="p">[</span><span class="n">latticeIndex</span><span class="o">+</span><span class="n">latticeOffset</span><span class="p">];</span>
<span class="linenos">1579</span><span class="w">    </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">siteType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inSites</span><span class="p">[</span><span class="n">latticeIndex</span><span class="p">];</span>
<span class="linenos">1580</span>
<span class="linenos">1581</span><span class="w">    </span><span class="c1">////////////////////////////////////////</span>
<span class="linenos">1582</span><span class="w">    </span><span class="c1">// Perform the reactions.             //</span>
<span class="linenos">1583</span><span class="w">    </span><span class="c1">////////////////////////////////////////</span>
<span class="linenos">1584</span>
<span class="linenos">1585</span><span class="w">    </span><span class="c1">// Calculate the kinetic rate for each reaction at this site.</span>
<span class="linenos">1586</span><span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">totalReactionPropensity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_element</span><span class="p">(</span><span class="n">qp0</span><span class="p">,</span><span class="n">siteType</span><span class="p">);</span>
<span class="linenos">1587</span><span class="w">    </span><span class="c1">//float totalReactionPropensity = qp0[siteType];</span>
<span class="linenos">1588</span><span class="w">	</span><span class="k">for</span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">MPD_PARTICLES_PER_SITE</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">1589</span><span class="w">	</span><span class="p">{</span>
<span class="linenos">1590</span><span class="w">		</span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">p1</span><span class="o">=</span><span class="p">((</span><span class="kt">uint8_t</span><span class="o">*</span><span class="p">)</span><span class="n">particles</span><span class="p">)[</span><span class="n">i</span><span class="p">];</span>
<span class="linenos">1591</span><span class="w">		</span><span class="k">if</span><span class="p">(</span><span class="n">p1</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">1592</span><span class="w">		</span><span class="p">{</span>
<span class="linenos">1593</span><span class="w">			</span><span class="n">totalReactionPropensity</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">read_element</span><span class="p">(</span><span class="n">qp1</span><span class="p">,(</span><span class="n">siteType</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">numberSpeciesC</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">p1</span><span class="mi">-1</span><span class="p">)));</span>
<span class="linenos">1594</span><span class="w">			</span><span class="c1">//totalReactionPropensity += qp1[(siteType * numberSpeciesC + (p1-1))];</span>
<span class="linenos">1595</span><span class="w">			</span><span class="k">for</span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">j</span><span class="o">=</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">&lt;</span><span class="n">MPD_PARTICLES_PER_SITE</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">1596</span><span class="w">			</span><span class="p">{</span>
<span class="linenos">1597</span><span class="w">				</span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">p2</span><span class="o">=</span><span class="p">((</span><span class="kt">uint8_t</span><span class="o">*</span><span class="p">)</span><span class="n">particles</span><span class="p">)[</span><span class="n">j</span><span class="p">];</span>
<span class="linenos">1598</span><span class="w">				</span><span class="k">if</span><span class="p">(</span><span class="n">p2</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">1599</span><span class="w">				</span><span class="p">{</span>
<span class="linenos">1600</span><span class="w">					</span><span class="n">totalReactionPropensity</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">read_element</span><span class="p">(</span><span class="n">qp2</span><span class="p">,</span><span class="n">siteType</span><span class="o">*</span><span class="n">numberSpeciesC</span><span class="o">*</span><span class="n">numberSpeciesC</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">p1</span><span class="mi">-1</span><span class="p">)</span><span class="o">*</span><span class="n">numberSpeciesC</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">p2</span><span class="mi">-1</span><span class="p">));</span>
<span class="linenos">1601</span><span class="w">					</span><span class="c1">//totalReactionPropensity += qp2[siteType*numberSpeciesC*numberSpeciesC + (p1-1)*numberSpeciesC + (p2-1)];</span>
<span class="linenos">1602</span><span class="w">				</span><span class="p">}</span>
<span class="linenos">1603</span><span class="w">			</span><span class="p">}</span>
<span class="linenos">1604</span><span class="w">		</span><span class="p">}</span>
<span class="linenos">1605</span><span class="w">	</span><span class="p">}</span>
<span class="linenos">1606</span>
<span class="linenos">1607</span>
<span class="linenos">1608</span><span class="w">	</span><span class="c1">// If propensity is zero, no reaction can occur.</span>
<span class="linenos">1609</span><span class="w">	</span><span class="k">if</span><span class="p">(</span><span class="n">totalReactionPropensity</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">)</span>
<span class="linenos">1610</span><span class="w">		</span><span class="k">return</span><span class="p">;</span>
<span class="linenos">1611</span>
<span class="linenos">1612</span><span class="w">    </span><span class="c1">// See if a reaction occurred at the site.</span>
<span class="linenos">1613</span><span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">reactionProbability</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">calculateReactionProbability</span><span class="p">(</span><span class="n">totalReactionPropensity</span><span class="p">);</span>
<span class="linenos">1614</span><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">reactionOccurred</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">checkForReaction</span><span class="p">(</span><span class="n">latticeIndex</span><span class="p">,</span><span class="w"> </span><span class="n">reactionProbability</span><span class="p">,</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">);</span>
<span class="linenos">1615</span>
<span class="linenos">1616</span><span class="w">    </span><span class="c1">// If there was a reaction, process it.</span>
<span class="linenos">1617</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">reactionOccurred</span><span class="p">)</span>
<span class="linenos">1618</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">1619</span><span class="w">        </span><span class="c1">// Figure out which reaction occurred.</span>
<span class="linenos">1620</span><span class="cp">#ifdef MPD_GLOBAL_S_MATRIX</span>
<span class="linenos">1621</span><span class="cp">#ifdef MPD_GLOBAL_R_MATRIX</span>
<span class="linenos">1622</span><span class="w">        </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">reactionIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">determineReactionIndex</span><span class="p">(</span><span class="n">siteType</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="o">*</span><span class="p">)</span><span class="n">particles</span><span class="p">,</span><span class="w"> </span><span class="n">latticeIndex</span><span class="p">,</span><span class="w"> </span><span class="n">totalReactionPropensity</span><span class="p">,</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">,</span><span class="w"> </span><span class="n">RLG</span><span class="p">,</span><span class="w"> </span><span class="n">reactionOrdersG</span><span class="p">,</span><span class="w"> </span><span class="n">reactionSitesG</span><span class="p">,</span><span class="w"> </span><span class="n">D1G</span><span class="p">,</span><span class="w"> </span><span class="n">D2G</span><span class="p">,</span><span class="w"> </span><span class="n">reactionRatesG</span><span class="p">);</span>
<span class="linenos">1623</span><span class="cp">#else</span>
<span class="linenos">1624</span><span class="w">        </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">reactionIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">determineReactionIndex</span><span class="p">(</span><span class="n">siteType</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="o">*</span><span class="p">)</span><span class="n">particles</span><span class="p">,</span><span class="w"> </span><span class="n">latticeIndex</span><span class="p">,</span><span class="w"> </span><span class="n">totalReactionPropensity</span><span class="p">,</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">,</span><span class="w"> </span><span class="n">RLG</span><span class="p">);</span>
<span class="linenos">1625</span><span class="cp">#endif</span>
<span class="linenos">1626</span><span class="cp">#else</span>
<span class="linenos">1627</span><span class="w">        </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">reactionIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">determineReactionIndex</span><span class="p">(</span><span class="n">siteType</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="o">*</span><span class="p">)</span><span class="n">particles</span><span class="p">,</span><span class="w"> </span><span class="n">latticeIndex</span><span class="p">,</span><span class="w"> </span><span class="n">totalReactionPropensity</span><span class="p">,</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">);</span>
<span class="linenos">1628</span><span class="cp">#endif</span>
<span class="linenos">1629</span>
<span class="linenos">1630</span><span class="w">        </span><span class="c1">// Construct the new site.</span>
<span class="linenos">1631</span><span class="cp">#ifdef MPD_GLOBAL_S_MATRIX</span>
<span class="linenos">1632</span><span class="w">        </span><span class="n">evaluateReaction</span><span class="p">(</span><span class="n">latticeIndex</span><span class="p">,</span><span class="w"> </span><span class="n">siteType</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="o">*</span><span class="p">)</span><span class="n">particles</span><span class="p">,</span><span class="w"> </span><span class="n">reactionIndex</span><span class="p">,</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">,</span><span class="w"> </span><span class="n">SG</span><span class="p">);</span>
<span class="linenos">1633</span><span class="cp">#else</span>
<span class="linenos">1634</span><span class="w">        </span><span class="n">evaluateReaction</span><span class="p">(</span><span class="n">latticeIndex</span><span class="p">,</span><span class="w"> </span><span class="n">siteType</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="o">*</span><span class="p">)</span><span class="n">particles</span><span class="p">,</span><span class="w"> </span><span class="n">reactionIndex</span><span class="p">,</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">);</span>
<span class="linenos">1635</span><span class="cp">#endif</span>
<span class="linenos">1636</span>
<span class="linenos">1637</span><span class="w">        </span><span class="c1">// Copy the new particles back into the lattice.</span>
<span class="linenos">1638</span><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">w</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">latticeOffset</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">w</span><span class="o">&lt;</span><span class="n">MPD_WORDS_PER_SITE</span><span class="p">;</span><span class="w"> </span><span class="n">w</span><span class="o">++</span><span class="p">,</span><span class="w"> </span><span class="n">latticeOffset</span><span class="o">+=</span><span class="n">latticeXYZSizeC</span><span class="p">)</span>
<span class="linenos">1639</span><span class="w">             </span><span class="n">outLattice</span><span class="p">[</span><span class="n">latticeIndex</span><span class="o">+</span><span class="n">latticeOffset</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">particles</span><span class="p">[</span><span class="n">w</span><span class="p">];</span>
<span class="linenos">1640</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">1641</span><span class="p">}</span>
<span class="linenos">1642</span>
<span class="linenos">1643</span><span class="kr">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">correct_overflows</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">lattice</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">)</span>
<span class="linenos">1644</span><span class="p">{</span>
<span class="linenos">1645</span><span class="w">	</span><span class="c1">// Remember: #define MPD_OVERFLOW_LIST_SIZE       1+2*TUNE_MPD_MAX_PARTICLE_OVERFLOWS*sizeof(uint32_t)</span>
<span class="linenos">1646</span><span class="w">	</span><span class="c1">// Requirement: one block with TUNE_MPD_MAX_PARTICLE_OVERFLOWS threads</span>
<span class="linenos">1647</span><span class="w">	</span>
<span class="linenos">1648</span><span class="w">	</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
<span class="linenos">1649</span><span class="w">	</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">total</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="linenos">1650</span>
<span class="linenos">1651</span><span class="w">	</span><span class="kt">__shared__</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">indexes</span><span class="p">[</span><span class="n">TUNE_MPD_MAX_PARTICLE_OVERFLOWS</span><span class="p">];</span>
<span class="linenos">1652</span><span class="w">	</span><span class="kt">__shared__</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">maxround</span><span class="p">;</span>
<span class="linenos">1653</span>
<span class="linenos">1654</span><span class="w">	</span><span class="c1">// Do I have an overflow to look at?</span>
<span class="linenos">1655</span><span class="w">	</span><span class="k">if</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">total</span><span class="p">)</span>
<span class="linenos">1656</span><span class="w">		</span><span class="k">return</span><span class="p">;</span>
<span class="linenos">1657</span>
<span class="linenos">1658</span><span class="w">	</span><span class="c1">// Abort if overflows have overflown</span>
<span class="linenos">1659</span><span class="w">	</span><span class="k">if</span><span class="p">(</span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="n">assert</span><span class="p">(</span><span class="n">total</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">TUNE_MPD_MAX_PARTICLE_OVERFLOWS</span><span class="p">);</span>
<span class="linenos">1660</span>
<span class="linenos">1661</span><span class="w">	</span><span class="c1">// load our index</span>
<span class="linenos">1662</span><span class="w">	</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">latticeIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">[(</span><span class="n">i</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
<span class="linenos">1663</span><span class="w">	</span><span class="n">particle_t</span><span class="w"> </span><span class="n">particle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">[(</span><span class="n">i</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="mi">2</span><span class="p">];</span>
<span class="linenos">1664</span>
<span class="linenos">1665</span><span class="w">	</span><span class="n">indexes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">latticeIndex</span><span class="p">;</span>
<span class="linenos">1666</span>
<span class="linenos">1667</span><span class="w">	</span><span class="c1">// zero out list</span>
<span class="linenos">1668</span><span class="w">	</span><span class="n">maxround</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">1669</span><span class="w">	</span><span class="nf">__syncthreads</span><span class="p">();</span>
<span class="linenos">1670</span><span class="w">	</span><span class="n">siteOverflowList</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">1671</span>
<span class="linenos">1672</span><span class="w">	</span><span class="c1">// Discover which round I should go in.  To prevent situations where two threads</span>
<span class="linenos">1673</span><span class="w">	</span><span class="c1">// will try and add a particle to the same site at the same time, and thus</span>
<span class="linenos">1674</span><span class="w">	</span><span class="c1">// negating the others, each thread determines what round it is allowed to make</span>
<span class="linenos">1675</span><span class="w">	</span><span class="c1">// edits in, by determining how many previous overflows are occuring at the </span>
<span class="linenos">1676</span><span class="w">	</span><span class="c1">// same index.</span>
<span class="linenos">1677</span><span class="w">	</span><span class="kt">int</span><span class="w"> </span><span class="n">round</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">1678</span><span class="w">	</span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">i</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">1679</span><span class="w">	</span><span class="p">{</span>
<span class="linenos">1680</span><span class="w">		</span><span class="k">if</span><span class="p">(</span><span class="n">indexes</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">latticeIndex</span><span class="p">)</span>
<span class="linenos">1681</span><span class="w">			</span><span class="n">round</span><span class="o">++</span><span class="p">;</span>
<span class="linenos">1682</span><span class="w">	</span><span class="p">}</span>
<span class="linenos">1683</span><span class="w">	</span><span class="n">atomicMax</span><span class="p">(</span><span class="o">&amp;</span><span class="n">maxround</span><span class="p">,</span><span class="w"> </span><span class="n">round</span><span class="p">);</span>
<span class="linenos">1684</span><span class="w">	</span><span class="nf">__syncthreads</span><span class="p">();</span>
<span class="linenos">1685</span>
<span class="linenos">1686</span><span class="w">	</span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">r</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">maxround</span><span class="p">;</span><span class="w"> </span><span class="n">r</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">1687</span><span class="w">	</span><span class="p">{</span>
<span class="linenos">1688</span><span class="w">		</span><span class="k">if</span><span class="p">(</span><span class="n">round</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">r</span><span class="p">)</span>
<span class="linenos">1689</span><span class="w">		</span><span class="p">{</span>
<span class="linenos">1690</span><span class="w">			</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">particles</span><span class="p">[</span><span class="n">MPD_WORDS_PER_SITE</span><span class="p">];</span>
<span class="linenos">1691</span><span class="w">			</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">w</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">latticeOffset</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">w</span><span class="o">&lt;</span><span class="n">MPD_WORDS_PER_SITE</span><span class="p">;</span><span class="w"> </span><span class="n">w</span><span class="o">++</span><span class="p">,</span><span class="w"> </span><span class="n">latticeOffset</span><span class="o">+=</span><span class="n">latticeXYZSizeC</span><span class="p">)</span>
<span class="linenos">1692</span><span class="w">				</span><span class="n">particles</span><span class="p">[</span><span class="n">w</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lattice</span><span class="p">[</span><span class="n">latticeIndex</span><span class="o">+</span><span class="n">latticeOffset</span><span class="p">];</span>
<span class="linenos">1693</span><span class="w">			</span>
<span class="linenos">1694</span><span class="w">			</span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="o">=</span><span class="p">(</span><span class="kt">uint8_t</span><span class="o">*</span><span class="p">)</span><span class="n">particles</span><span class="p">;</span>
<span class="linenos">1695</span><span class="w">			</span><span class="kt">int</span><span class="w"> </span><span class="n">ok</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">1696</span><span class="w">			</span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">pi</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">pi</span><span class="o">&lt;</span><span class="n">MPD_PARTICLES_PER_SITE</span><span class="p">;</span><span class="w"> </span><span class="n">pi</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">1697</span><span class="w">			</span><span class="p">{</span>
<span class="linenos">1698</span><span class="w">				</span><span class="k">if</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">pi</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">1699</span><span class="w">				</span><span class="p">{</span>
<span class="linenos">1700</span><span class="w">					</span><span class="n">p</span><span class="p">[</span><span class="n">pi</span><span class="p">]</span><span class="o">=</span><span class="n">particle</span><span class="p">;</span>
<span class="linenos">1701</span><span class="w">					</span><span class="n">ok</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
<span class="linenos">1702</span><span class="w">					</span><span class="c1">//printf(&quot;(round %d) Corrected overflow of particle %d at index %d\n&quot;, r, particle, latticeIndex);</span>
<span class="linenos">1703</span><span class="w">					</span><span class="k">break</span><span class="p">;</span>
<span class="linenos">1704</span><span class="w">				</span><span class="p">}</span>
<span class="linenos">1705</span><span class="w">			</span><span class="p">}</span>
<span class="linenos">1706</span>
<span class="linenos">1707</span><span class="w">			</span><span class="k">if</span><span class="p">(</span><span class="n">ok</span><span class="p">)</span>
<span class="linenos">1708</span><span class="w">			</span><span class="p">{</span>
<span class="linenos">1709</span><span class="w">				</span><span class="c1">// Copy the new particles back into the lattice.</span>
<span class="linenos">1710</span><span class="w">				</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">w</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">latticeOffset</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">w</span><span class="o">&lt;</span><span class="n">MPD_WORDS_PER_SITE</span><span class="p">;</span><span class="w"> </span><span class="n">w</span><span class="o">++</span><span class="p">,</span><span class="w"> </span><span class="n">latticeOffset</span><span class="o">+=</span><span class="n">latticeXYZSizeC</span><span class="p">)</span>
<span class="linenos">1711</span><span class="w">				     </span><span class="n">lattice</span><span class="p">[</span><span class="n">latticeIndex</span><span class="o">+</span><span class="n">latticeOffset</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">particles</span><span class="p">[</span><span class="n">w</span><span class="p">];</span>
<span class="linenos">1712</span><span class="w">			</span><span class="p">}</span>
<span class="linenos">1713</span><span class="w">			</span><span class="k">else</span>
<span class="linenos">1714</span><span class="w">			</span><span class="p">{</span>
<span class="linenos">1715</span><span class="w">				</span><span class="kt">int</span><span class="w"> </span><span class="n">exceptionIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">atomicAdd</span><span class="p">(</span><span class="n">siteOverflowList</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="linenos">1716</span><span class="w">				</span><span class="n">siteOverflowList</span><span class="p">[(</span><span class="n">exceptionIndex</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">latticeIndex</span><span class="p">;</span>
<span class="linenos">1717</span><span class="w">				</span><span class="n">siteOverflowList</span><span class="p">[(</span><span class="n">exceptionIndex</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">particle</span><span class="p">;</span>
<span class="linenos">1718</span><span class="w">				</span><span class="c1">//printf(&quot;(round %d) Failed to correct overflow of particle %d at index %d\n&quot;, r, particle, latticeIndex);</span>
<span class="linenos">1719</span><span class="w">			</span><span class="p">}</span>
<span class="linenos">1720</span><span class="w">		</span><span class="p">}</span>
<span class="linenos">1721</span><span class="w">		</span><span class="nf">__syncthreads</span><span class="p">();</span>
<span class="linenos">1722</span><span class="w">	</span><span class="p">}</span>
<span class="linenos">1723</span>
<span class="linenos">1724</span><span class="w">	</span><span class="c1">//if(i  == 0)</span>
<span class="linenos">1725</span><span class="w">		</span><span class="c1">//printf(&quot;in: %d overflows, out: %d\n&quot;, total, siteOverflowList[0]);</span>
<span class="linenos">1726</span>
<span class="linenos">1727</span><span class="p">}</span>
<span class="linenos">1728</span>
<span class="linenos">1729</span>
<span class="linenos">1730</span><span class="w">	</span><span class="c1">// Sanity test kernel to compare kernel outputs</span>
<span class="linenos">1731</span><span class="w">	</span><span class="kr">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">__launch_bounds__</span><span class="p">(</span><span class="n">TUNE_MPD_REACTION_BLOCK_X_SIZE</span><span class="o">*</span><span class="n">TUNE_MPD_REACTION_BLOCK_Y_SIZE</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="n">sanity_check</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">L1</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">L2</span><span class="p">)</span>
<span class="linenos">1732</span><span class="w">	</span><span class="p">{</span>
<span class="linenos">1733</span><span class="w">		</span><span class="c1">// Figure out the offset of this thread in the lattice and the lattice segment.</span>
<span class="linenos">1734</span><span class="w">		</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">bx</span><span class="o">=</span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">by</span><span class="o">=</span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">bz</span><span class="o">=</span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">z</span><span class="p">;</span>
<span class="linenos">1735</span><span class="w">		</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeYIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">by</span><span class="o">*</span><span class="nb">blockDim</span><span class="p">.</span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
<span class="linenos">1736</span><span class="w">		</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">bz</span><span class="o">*</span><span class="n">latticeXYSizeC</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">latticeYIndex</span><span class="o">*</span><span class="n">latticeXSizeC</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">bx</span><span class="o">*</span><span class="nb">blockDim</span><span class="p">.</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
<span class="linenos">1737</span>
<span class="linenos">1738</span><span class="w">		</span><span class="c1">///////////////////////////////////////////</span>
<span class="linenos">1739</span><span class="w">		</span><span class="c1">// Load the particles and site.          //</span>
<span class="linenos">1740</span><span class="w">		</span><span class="c1">///////////////////////////////////////////</span>
<span class="linenos">1741</span>
<span class="linenos">1742</span><span class="w">		</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">particles1</span><span class="p">;</span>
<span class="linenos">1743</span><span class="w">		</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">particles2</span><span class="p">;</span>
<span class="linenos">1744</span><span class="w">		</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">w</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">latticeOffset</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">w</span><span class="o">&lt;</span><span class="n">MPD_WORDS_PER_SITE</span><span class="p">;</span><span class="w"> </span><span class="n">w</span><span class="o">++</span><span class="p">,</span><span class="w"> </span><span class="n">latticeOffset</span><span class="o">+=</span><span class="n">latticeXYZSizeC</span><span class="p">)</span>
<span class="linenos">1745</span><span class="w">		</span><span class="p">{</span>
<span class="linenos">1746</span><span class="w">			</span><span class="n">particles1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">L1</span><span class="p">[</span><span class="n">latticeIndex</span><span class="o">+</span><span class="n">latticeOffset</span><span class="p">];</span>
<span class="linenos">1747</span><span class="w">			</span><span class="n">particles2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">L2</span><span class="p">[</span><span class="n">latticeIndex</span><span class="o">+</span><span class="n">latticeOffset</span><span class="p">];</span>
<span class="linenos">1748</span>
<span class="linenos">1749</span><span class="w">			</span><span class="k">if</span><span class="p">(</span><span class="n">particles1</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">particles2</span><span class="p">)</span>
<span class="linenos">1750</span><span class="w">			</span><span class="p">{</span>
<span class="linenos">1751</span><span class="w">				</span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;**</span><span class="se">\n</span><span class="s"> ********* Sanity failure block(%d,%d,%d) thread(%d,%d,%d) w=%d L1=%8X L2=%8X</span><span class="se">\n</span><span class="s">**</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
<span class="linenos">1752</span><span class="w">					</span><span class="n">bx</span><span class="p">,</span><span class="n">by</span><span class="p">,</span><span class="n">bz</span><span class="p">,</span>
<span class="linenos">1753</span><span class="w">					</span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">z</span><span class="p">,</span>
<span class="linenos">1754</span><span class="w">					</span><span class="n">w</span><span class="p">,</span><span class="w"> </span><span class="n">particles1</span><span class="p">,</span><span class="w"> </span><span class="n">particles2</span><span class="p">);</span>
<span class="linenos">1755</span><span class="w">			</span><span class="p">}</span>
<span class="linenos">1756</span><span class="w">		</span><span class="p">}</span>
<span class="linenos">1757</span><span class="w">	</span><span class="p">}</span>
<span class="linenos">1758</span>
<span class="linenos">1759</span><span class="p">}</span>
<span class="linenos">1760</span>
<span class="linenos">1761</span><span class="p">}</span>
<span class="linenos">1762</span><span class="p">}</span>
</pre></div>
</div>
</section>
<section id="intmpdrdmesolver-h">
<h3>IntMpdRdmeSolver.h<a class="headerlink" href="#intmpdrdmesolver-h" title="Link to this heading">#</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="linenos">  1</span><span class="cm">/*</span>
<span class="linenos">  2</span><span class="cm"> * University of Illinois Open Source License</span>
<span class="linenos">  3</span><span class="cm"> * Copyright 2008-2018 Luthey-Schulten Group,</span>
<span class="linenos">  4</span><span class="cm"> * Copyright 2012 Roberts Group,</span>
<span class="linenos">  5</span><span class="cm"> * All rights reserved.</span>
<span class="linenos">  6</span><span class="cm"> * </span>
<span class="linenos">  7</span><span class="cm"> * Developed by: Luthey-Schulten Group</span>
<span class="linenos">  8</span><span class="cm"> * 			     University of Illinois at Urbana-Champaign</span>
<span class="linenos">  9</span><span class="cm"> * 			     http://www.scs.uiuc.edu/~schulten</span>
<span class="linenos"> 10</span><span class="cm"> * </span>
<span class="linenos"> 11</span><span class="cm"> * Developed by: Roberts Group</span>
<span class="linenos"> 12</span><span class="cm"> * 			     Johns Hopkins University</span>
<span class="linenos"> 13</span><span class="cm"> * 			     http://biophysics.jhu.edu/roberts/</span>
<span class="linenos"> 14</span><span class="cm"> *</span>
<span class="linenos"> 15</span><span class="cm"> * Permission is hereby granted, free of charge, to any person obtaining a copy of</span>
<span class="linenos"> 16</span><span class="cm"> * this software and associated documentation files (the Software), to deal with </span>
<span class="linenos"> 17</span><span class="cm"> * the Software without restriction, including without limitation the rights to </span>
<span class="linenos"> 18</span><span class="cm"> * use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies </span>
<span class="linenos"> 19</span><span class="cm"> * of the Software, and to permit persons to whom the Software is furnished to </span>
<span class="linenos"> 20</span><span class="cm"> * do so, subject to the following conditions:</span>
<span class="linenos"> 21</span><span class="cm"> * </span>
<span class="linenos"> 22</span><span class="cm"> * - Redistributions of source code must retain the above copyright notice, </span>
<span class="linenos"> 23</span><span class="cm"> * this list of conditions and the following disclaimers.</span>
<span class="linenos"> 24</span><span class="cm"> * </span>
<span class="linenos"> 25</span><span class="cm"> * - Redistributions in binary form must reproduce the above copyright notice, </span>
<span class="linenos"> 26</span><span class="cm"> * this list of conditions and the following disclaimers in the documentation </span>
<span class="linenos"> 27</span><span class="cm"> * and/or other materials provided with the distribution.</span>
<span class="linenos"> 28</span><span class="cm"> * </span>
<span class="linenos"> 29</span><span class="cm"> * - Neither the names of the Luthey-Schulten Group, University of Illinois at</span>
<span class="linenos"> 30</span><span class="cm"> * Urbana-Champaign, the Roberts Group, Johns Hopkins University, nor the names</span>
<span class="linenos"> 31</span><span class="cm"> * of its contributors may be used to endorse or promote products derived from</span>
<span class="linenos"> 32</span><span class="cm"> * this Software without specific prior written permission.</span>
<span class="linenos"> 33</span><span class="cm"> * </span>
<span class="linenos"> 34</span><span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR </span>
<span class="linenos"> 35</span><span class="cm"> * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, </span>
<span class="linenos"> 36</span><span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL </span>
<span class="linenos"> 37</span><span class="cm"> * THE CONTRIBUTORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR </span>
<span class="linenos"> 38</span><span class="cm"> * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, </span>
<span class="linenos"> 39</span><span class="cm"> * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR </span>
<span class="linenos"> 40</span><span class="cm"> * OTHER DEALINGS WITH THE SOFTWARE.</span>
<span class="linenos"> 41</span><span class="cm"> *</span>
<span class="linenos"> 42</span><span class="cm"> * Author(s): Elijah Roberts, Zane Thornburg</span>
<span class="linenos"> 43</span><span class="cm"> */</span>
<span class="linenos"> 44</span>
<span class="linenos"> 45</span><span class="cp">#ifndef LM_RDME_INTMPDRDMESOLVER_H_</span>
<span class="linenos"> 46</span><span class="cp">#define LM_RDME_INTMPDRDMESOLVER_H_</span>
<span class="linenos"> 47</span>
<span class="linenos"> 48</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;cuda/lm_cuda.h&quot;</span>
<span class="linenos"> 49</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;rdme/RDMESolver.h&quot;</span>
<span class="linenos"> 50</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;rdme/CudaIntLattice.h&quot;</span>
<span class="linenos"> 51</span>
<span class="linenos"> 52</span><span class="k">using</span><span class="w"> </span><span class="n">lm</span><span class="o">::</span><span class="n">rdme</span><span class="o">::</span><span class="n">RDMESolver</span><span class="p">;</span>
<span class="linenos"> 53</span><span class="k">using</span><span class="w"> </span><span class="n">lm</span><span class="o">::</span><span class="n">rdme</span><span class="o">::</span><span class="n">Lattice</span><span class="p">;</span>
<span class="linenos"> 54</span>
<span class="linenos"> 55</span><span class="k">namespace</span><span class="w"> </span><span class="nn">lm</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 56</span>
<span class="linenos"> 57</span><span class="k">namespace</span><span class="w"> </span><span class="nn">io</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 58</span><span class="w">    </span><span class="k">class</span><span class="w"> </span><span class="nc">Lattice</span><span class="p">;</span>
<span class="linenos"> 59</span><span class="w">    </span><span class="k">class</span><span class="w"> </span><span class="nc">SpeciesCounts</span><span class="p">;</span>
<span class="linenos"> 60</span><span class="p">}</span>
<span class="linenos"> 61</span>
<span class="linenos"> 62</span><span class="k">namespace</span><span class="w"> </span><span class="nn">rdme</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 63</span>
<span class="linenos"> 64</span><span class="k">class</span><span class="w"> </span><span class="nc">IntMpdRdmeSolver</span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">RDMESolver</span>
<span class="linenos"> 65</span><span class="p">{</span>
<span class="linenos"> 66</span><span class="w">    </span><span class="k">using</span><span class="w"> </span><span class="n">CMESolver</span><span class="o">::</span><span class="n">hookSimulation</span><span class="p">;</span>
<span class="linenos"> 67</span><span class="w">    </span><span class="k">using</span><span class="w"> </span><span class="n">RDMESolver</span><span class="o">::</span><span class="n">buildDiffusionModel</span><span class="p">;</span>
<span class="linenos"> 68</span>
<span class="linenos"> 69</span><span class="k">public</span><span class="o">:</span>
<span class="linenos"> 70</span><span class="w">    </span><span class="n">IntMpdRdmeSolver</span><span class="p">();</span>
<span class="linenos"> 71</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="o">~</span><span class="n">IntMpdRdmeSolver</span><span class="p">();</span>
<span class="linenos"> 72</span>
<span class="linenos"> 73</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">initialize</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">replicate</span><span class="p">,</span>
<span class="linenos"> 74</span><span class="w">                            </span><span class="n">map</span><span class="o">&lt;</span><span class="n">string</span><span class="p">,</span><span class="w"> </span><span class="n">string</span><span class="o">&gt;*</span><span class="w"> </span><span class="n">parameters</span><span class="p">,</span>
<span class="linenos"> 75</span><span class="w">                            </span><span class="n">ResourceAllocator</span><span class="o">::</span><span class="n">ComputeResources</span><span class="o">*</span><span class="w"> </span><span class="n">resources</span><span class="p">);</span>
<span class="linenos"> 76</span>
<span class="linenos"> 77</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="nf">needsReactionModel</span><span class="p">()</span><span class="w">  </span><span class="p">{</span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;}</span>
<span class="linenos"> 78</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="nf">needsDiffusionModel</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;}</span>
<span class="linenos"> 79</span>
<span class="linenos"> 80</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">buildModel</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">uint</span><span class="w"> </span><span class="n">numberSpeciesA</span><span class="p">,</span>
<span class="linenos"> 81</span><span class="w">                            </span><span class="k">const</span><span class="w"> </span><span class="n">uint</span><span class="w"> </span><span class="n">numberReactionsA</span><span class="p">,</span>
<span class="linenos"> 82</span><span class="w">                            </span><span class="k">const</span><span class="w"> </span><span class="n">uint</span><span class="o">*</span><span class="w"> </span><span class="n">initialSpeciesCountsA</span><span class="p">,</span>
<span class="linenos"> 83</span><span class="w">                            </span><span class="k">const</span><span class="w"> </span><span class="n">uint</span><span class="o">*</span><span class="w"> </span><span class="n">reactionTypeA</span><span class="p">,</span>
<span class="linenos"> 84</span><span class="w">                            </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="o">*</span><span class="w"> </span><span class="n">kA</span><span class="p">,</span>
<span class="linenos"> 85</span><span class="w">                            </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">SA</span><span class="p">,</span>
<span class="linenos"> 86</span><span class="w">                            </span><span class="k">const</span><span class="w"> </span><span class="n">uint</span><span class="o">*</span><span class="w"> </span><span class="n">DA</span><span class="p">,</span>
<span class="linenos"> 87</span><span class="w">                            </span><span class="k">const</span><span class="w"> </span><span class="n">uint</span><span class="w"> </span><span class="n">kCols</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="linenos"> 88</span>
<span class="linenos"> 89</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">buildDiffusionModel</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">uint</span><span class="w"> </span><span class="n">numberSiteTypesA</span><span class="p">,</span>
<span class="linenos"> 90</span><span class="w">                                     </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="o">*</span><span class="w"> </span><span class="n">DFA</span><span class="p">,</span>
<span class="linenos"> 91</span><span class="w">                                     </span><span class="k">const</span><span class="w"> </span><span class="n">uint</span><span class="o">*</span><span class="w"> </span><span class="n">RLA</span><span class="p">,</span>
<span class="linenos"> 92</span><span class="w">                                     </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">latticeXSize</span><span class="p">,</span>
<span class="linenos"> 93</span><span class="w">                                     </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">latticeYSize</span><span class="p">,</span>
<span class="linenos"> 94</span><span class="w">                                     </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">latticeZSize</span><span class="p">,</span>
<span class="linenos"> 95</span><span class="w">                                     </span><span class="n">site_size_t</span><span class="w"> </span><span class="n">particlesPerSite</span><span class="p">,</span>
<span class="linenos"> 96</span><span class="w">                                     </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">bytes_per_particle</span><span class="p">,</span>
<span class="linenos"> 97</span><span class="w">                                     </span><span class="n">si_dist_t</span><span class="w"> </span><span class="n">latticeSpacing</span><span class="p">,</span>
<span class="linenos"> 98</span><span class="w">                                     </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="o">*</span><span class="w"> </span><span class="n">latticeData</span><span class="p">,</span>
<span class="linenos"> 99</span><span class="w">                                     </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="o">*</span><span class="w"> </span><span class="n">latticeSitesData</span><span class="p">,</span>
<span class="linenos">100</span><span class="w">                                     </span><span class="kt">bool</span><span class="w"> </span><span class="n">rowMajorData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span>
<span class="linenos">101</span>
<span class="linenos">102</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">generateTrajectory</span><span class="p">();</span>
<span class="linenos">103</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setReactionRate</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">rxid</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">rate</span><span class="p">);</span>
<span class="linenos">104</span>
<span class="linenos">105</span><span class="k">protected</span><span class="o">:</span>
<span class="linenos">106</span><span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">seed</span><span class="p">;</span>
<span class="linenos">107</span><span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">tau</span><span class="p">;</span>
<span class="linenos">108</span><span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">reactionModelModified</span><span class="p">;</span>
<span class="linenos">109</span>
<span class="linenos">110</span><span class="w">    </span><span class="kt">void</span><span class="o">*</span><span class="w">        </span><span class="n">cudaOverflowList</span><span class="p">;</span>
<span class="linenos">111</span><span class="w">    </span><span class="n">cudaStream_t</span><span class="w"> </span><span class="n">cudaStream</span><span class="p">;</span>
<span class="linenos">112</span>
<span class="linenos">113</span><span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">overflowTimesteps</span><span class="p">;</span>
<span class="linenos">114</span><span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">overflowListUses</span><span class="p">;</span>
<span class="linenos">115</span>
<span class="linenos">116</span><span class="w">    </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">model_reactionRates</span><span class="p">;</span>
<span class="linenos">117</span><span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">zeroOrderSize</span><span class="p">,</span><span class="w"> </span><span class="n">firstOrderSize</span><span class="p">,</span><span class="w"> </span><span class="n">secondOrderSize</span><span class="p">;</span>
<span class="linenos">118</span><span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="n">zeroOrder</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">firstOrder</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">secondOrder</span><span class="p">;</span>
<span class="linenos">119</span>
<span class="linenos">120</span><span class="cp">#ifdef MPD_GLOBAL_S_MATRIX</span>
<span class="linenos">121</span><span class="w">    </span><span class="kt">uint8_t</span><span class="o">*</span><span class="w"> </span><span class="n">RLG</span><span class="p">;</span><span class="w"> </span><span class="c1">// Device global memory pointer for RL matrix</span>
<span class="linenos">122</span><span class="w">	</span><span class="kt">int8_t</span><span class="o">*</span><span class="w"> </span><span class="n">SG</span><span class="p">;</span><span class="w">   </span><span class="c1">// Device global memory pointer for S matrix</span>
<span class="linenos">123</span><span class="cp">#endif</span>
<span class="linenos">124</span>
<span class="linenos">125</span><span class="cp">#ifdef MPD_GLOBAL_T_MATRIX</span>
<span class="linenos">126</span><span class="w">	</span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">TG</span><span class="p">;</span>
<span class="linenos">127</span><span class="cp">#endif</span>
<span class="linenos">128</span>
<span class="linenos">129</span><span class="cp">#ifdef MPD_GLOBAL_R_MATRIX</span>
<span class="linenos">130</span><span class="w">    </span><span class="kt">float</span><span class="o">*</span><span class="w">        </span><span class="n">reactionRatesG</span><span class="p">;</span>
<span class="linenos">131</span><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">reactionOrdersG</span><span class="p">;</span>
<span class="linenos">132</span><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">reactionSitesG</span><span class="p">;</span>
<span class="linenos">133</span>
<span class="linenos">134</span><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">D1G</span><span class="p">;</span>
<span class="linenos">135</span><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">D2G</span><span class="p">;</span>
<span class="linenos">136</span><span class="cp">#endif</span>
<span class="linenos">137</span>
<span class="linenos">138</span><span class="w">	</span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">propZeroOrder</span><span class="p">;</span>
<span class="linenos">139</span><span class="w">	</span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">propFirstOrder</span><span class="p">;</span>
<span class="linenos">140</span><span class="w">	</span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">propSecondOrder</span><span class="p">;</span>
<span class="linenos">141</span>
<span class="linenos">142</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">allocateLattice</span><span class="p">(</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">latticeXSize</span><span class="p">,</span>
<span class="linenos">143</span><span class="w">                                 </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">latticeYSize</span><span class="p">,</span>
<span class="linenos">144</span><span class="w">                                 </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">latticeZSize</span><span class="p">,</span>
<span class="linenos">145</span><span class="w">                                 </span><span class="n">site_size_t</span><span class="w"> </span><span class="n">particlesPerSite</span><span class="p">,</span>
<span class="linenos">146</span><span class="w">                                 </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">bytes_per_particle</span><span class="p">,</span>
<span class="linenos">147</span><span class="w">                                 </span><span class="n">si_dist_t</span><span class="w"> </span><span class="n">latticeSpacing</span><span class="p">);</span>
<span class="linenos">148</span>
<span class="linenos">149</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">writeLatticeData</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">time</span><span class="p">,</span>
<span class="linenos">150</span><span class="w">                                  </span><span class="n">CudaIntLattice</span><span class="o">*</span><span class="w"> </span><span class="n">lattice</span><span class="p">,</span>
<span class="linenos">151</span><span class="w">                                  </span><span class="n">lm</span><span class="o">::</span><span class="n">io</span><span class="o">::</span><span class="n">Lattice</span><span class="o">*</span><span class="w"> </span><span class="n">latticeDataSet</span><span class="p">);</span>
<span class="linenos">152</span><span class="w">	</span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">writeLatticeSites</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="n">CudaIntLattice</span><span class="o">*</span><span class="w"> </span><span class="n">lattice</span><span class="p">);</span>
<span class="linenos">153</span>
<span class="linenos">154</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">recordSpeciesCounts</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">time</span><span class="p">,</span>
<span class="linenos">155</span><span class="w">                                     </span><span class="n">CudaIntLattice</span><span class="o">*</span><span class="w"> </span><span class="n">lattice</span><span class="p">,</span>
<span class="linenos">156</span><span class="w">                                     </span><span class="n">lm</span><span class="o">::</span><span class="n">io</span><span class="o">::</span><span class="n">SpeciesCounts</span><span class="o">*</span><span class="w"> </span><span class="n">speciesCountsDataSet</span><span class="p">);</span>
<span class="linenos">157</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">writeSpeciesCounts</span><span class="p">(</span><span class="n">lm</span><span class="o">::</span><span class="n">io</span><span class="o">::</span><span class="n">SpeciesCounts</span><span class="o">*</span><span class="w"> </span><span class="n">speciesCountsDataSet</span><span class="p">);</span>
<span class="linenos">158</span>
<span class="linenos">159</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">hookSimulation</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="n">CudaIntLattice</span><span class="o">*</span><span class="w"> </span><span class="n">lattice</span><span class="p">);</span>
<span class="linenos">160</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">hookCheckSimulation</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="n">CudaIntLattice</span><span class="o">*</span><span class="w"> </span><span class="n">lattice</span><span class="p">);</span>
<span class="linenos">161</span>
<span class="linenos">162</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">runTimestep</span><span class="p">(</span><span class="n">CudaIntLattice</span><span class="o">*</span><span class="w"> </span><span class="n">lattice</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">timestep</span><span class="p">);</span>
<span class="linenos">163</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">uint64_t</span><span class="w"> </span><span class="nf">getTimestepSeed</span><span class="p">(</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">timestep</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">substep</span><span class="p">);</span>
<span class="linenos">164</span>
<span class="linenos">165</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setLatticeData</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="o">*</span><span class="w"> </span><span class="n">latticeData</span><span class="p">);</span>
<span class="linenos">166</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">computePropensities</span><span class="p">();</span>
<span class="linenos">167</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">copyModelsToDevice</span><span class="p">();</span>
<span class="linenos">168</span>
<span class="linenos">169</span><span class="cp">#ifdef MPD_CUDA_3D_GRID_LAUNCH</span>
<span class="linenos">170</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">calculateXLaunchParameters</span><span class="p">(</span><span class="n">dim3</span><span class="o">*</span><span class="w"> </span><span class="n">gridSize</span><span class="p">,</span><span class="w"> </span><span class="n">dim3</span><span class="o">*</span><span class="w"> </span><span class="n">threadBlockSize</span><span class="p">,</span>
<span class="linenos">171</span><span class="w">                                            </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">maxXBlockSize</span><span class="p">,</span>
<span class="linenos">172</span><span class="w">                                            </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeXSize</span><span class="p">,</span>
<span class="linenos">173</span><span class="w">                                            </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeYSize</span><span class="p">,</span>
<span class="linenos">174</span><span class="w">                                            </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeZSize</span><span class="p">);</span>
<span class="linenos">175</span>
<span class="linenos">176</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">calculateYLaunchParameters</span><span class="p">(</span><span class="n">dim3</span><span class="o">*</span><span class="w"> </span><span class="n">gridSize</span><span class="p">,</span><span class="w"> </span><span class="n">dim3</span><span class="o">*</span><span class="w"> </span><span class="n">threadBlockSize</span><span class="p">,</span>
<span class="linenos">177</span><span class="w">                                            </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">blockXSize</span><span class="p">,</span>
<span class="linenos">178</span><span class="w">                                            </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">blockYSize</span><span class="p">,</span>
<span class="linenos">179</span><span class="w">                                            </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeXSize</span><span class="p">,</span>
<span class="linenos">180</span><span class="w">                                            </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeYSize</span><span class="p">,</span>
<span class="linenos">181</span><span class="w">                                            </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeZSize</span><span class="p">);</span>
<span class="linenos">182</span>
<span class="linenos">183</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">calculateZLaunchParameters</span><span class="p">(</span><span class="n">dim3</span><span class="o">*</span><span class="w"> </span><span class="n">gridSize</span><span class="p">,</span><span class="w"> </span><span class="n">dim3</span><span class="o">*</span><span class="w"> </span><span class="n">threadBlockSize</span><span class="p">,</span>
<span class="linenos">184</span><span class="w">                                            </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">blockXSize</span><span class="p">,</span>
<span class="linenos">185</span><span class="w">                                            </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">blockZSize</span><span class="p">,</span>
<span class="linenos">186</span><span class="w">                                            </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeXSize</span><span class="p">,</span>
<span class="linenos">187</span><span class="w">                                            </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeYSize</span><span class="p">,</span>
<span class="linenos">188</span><span class="w">                                            </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeZSize</span><span class="p">);</span>
<span class="linenos">189</span>
<span class="linenos">190</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">calculateReactionLaunchParameters</span><span class="p">(</span><span class="n">dim3</span><span class="o">*</span><span class="w"> </span><span class="n">gridSize</span><span class="p">,</span><span class="w"> </span><span class="n">dim3</span><span class="o">*</span><span class="w"> </span><span class="n">threadBlockSize</span><span class="p">,</span>
<span class="linenos">191</span><span class="w">                                                   </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">blockXSize</span><span class="p">,</span>
<span class="linenos">192</span><span class="w">                                                   </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">blockYSize</span><span class="p">,</span>
<span class="linenos">193</span><span class="w">                                                   </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeXSize</span><span class="p">,</span>
<span class="linenos">194</span><span class="w">                                                   </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeYSize</span><span class="p">,</span>
<span class="linenos">195</span><span class="w">                                                   </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeZSize</span><span class="p">);</span>
<span class="linenos">196</span><span class="cp">#else</span>
<span class="linenos">197</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">calculateXLaunchParameters</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">gridXSize</span><span class="p">,</span>
<span class="linenos">198</span><span class="w">                                            </span><span class="n">dim3</span><span class="o">*</span><span class="w"> </span><span class="n">gridSize</span><span class="p">,</span><span class="w"> </span><span class="n">dim3</span><span class="o">*</span><span class="w"> </span><span class="n">threadBlockSize</span><span class="p">,</span>
<span class="linenos">199</span><span class="w">                                            </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">maxXBlockSize</span><span class="p">,</span>
<span class="linenos">200</span><span class="w">                                            </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeXSize</span><span class="p">,</span>
<span class="linenos">201</span><span class="w">                                            </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeYSize</span><span class="p">,</span>
<span class="linenos">202</span><span class="w">                                            </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeZSize</span><span class="p">);</span>
<span class="linenos">203</span>
<span class="linenos">204</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">calculateYLaunchParameters</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">gridXSize</span><span class="p">,</span>
<span class="linenos">205</span><span class="w">                                            </span><span class="n">dim3</span><span class="o">*</span><span class="w"> </span><span class="n">gridSize</span><span class="p">,</span><span class="w"> </span><span class="n">dim3</span><span class="o">*</span><span class="w"> </span><span class="n">threadBlockSize</span><span class="p">,</span>
<span class="linenos">206</span><span class="w">                                            </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">blockXSize</span><span class="p">,</span>
<span class="linenos">207</span><span class="w">                                            </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">blockYSize</span><span class="p">,</span>
<span class="linenos">208</span><span class="w">                                            </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeXSize</span><span class="p">,</span>
<span class="linenos">209</span><span class="w">                                            </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeYSize</span><span class="p">,</span>
<span class="linenos">210</span><span class="w">                                            </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeZSize</span><span class="p">);</span>
<span class="linenos">211</span>
<span class="linenos">212</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">calculateZLaunchParameters</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">gridXSize</span><span class="p">,</span>
<span class="linenos">213</span><span class="w">                                            </span><span class="n">dim3</span><span class="o">*</span><span class="w"> </span><span class="n">gridSize</span><span class="p">,</span><span class="w"> </span><span class="n">dim3</span><span class="o">*</span><span class="w"> </span><span class="n">threadBlockSize</span><span class="p">,</span>
<span class="linenos">214</span><span class="w">                                            </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">blockXSize</span><span class="p">,</span>
<span class="linenos">215</span><span class="w">                                            </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">blockZSize</span><span class="p">,</span>
<span class="linenos">216</span><span class="w">                                            </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeXSize</span><span class="p">,</span>
<span class="linenos">217</span><span class="w">                                            </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeYSize</span><span class="p">,</span>
<span class="linenos">218</span><span class="w">                                            </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeZSize</span><span class="p">);</span>
<span class="linenos">219</span>
<span class="linenos">220</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">calculateReactionLaunchParameters</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">gridXSize</span><span class="p">,</span>
<span class="linenos">221</span><span class="w">                                                   </span><span class="n">dim3</span><span class="o">*</span><span class="w"> </span><span class="n">gridSize</span><span class="p">,</span><span class="w"> </span><span class="n">dim3</span><span class="o">*</span><span class="w"> </span><span class="n">threadBlockSize</span><span class="p">,</span>
<span class="linenos">222</span><span class="w">                                                   </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">blockXSize</span><span class="p">,</span>
<span class="linenos">223</span><span class="w">                                                   </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">blockYSize</span><span class="p">,</span>
<span class="linenos">224</span><span class="w">                                                   </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeXSize</span><span class="p">,</span>
<span class="linenos">225</span><span class="w">                                                   </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeYSize</span><span class="p">,</span>
<span class="linenos">226</span><span class="w">                                                   </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeZSize</span><span class="p">);</span>
<span class="linenos">227</span><span class="cp">#endif</span>
<span class="linenos">228</span><span class="p">};</span>
<span class="linenos">229</span>
<span class="linenos">230</span>
<span class="linenos">231</span><span class="k">namespace</span><span class="w"> </span><span class="nn">intmpdrdme_dev</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">232</span>
<span class="linenos">233</span><span class="cp">#ifdef MPD_FREAKYFAST</span>
<span class="linenos">234</span><span class="w">    </span><span class="cp">#ifdef MPD_GLOBAL_R_MATRIX</span>
<span class="linenos">235</span><span class="w">        </span><span class="n">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">precomp_reaction_kernel</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">inLattice</span><span class="p">,</span>
<span class="linenos">236</span><span class="w">                                                </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="o">*</span><span class="w"> </span><span class="n">inSites</span><span class="p">,</span>
<span class="linenos">237</span><span class="w">                                                </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">outLattice</span><span class="p">,</span>
<span class="linenos">238</span><span class="w">                                                </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">,</span>
<span class="linenos">239</span><span class="w">                                                </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">,</span>
<span class="linenos">240</span><span class="w">                                                </span><span class="k">const</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="kt">int8_t</span><span class="o">*</span><span class="w"> </span><span class="n">SG</span><span class="p">,</span>
<span class="linenos">241</span><span class="w">                                                </span><span class="k">const</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="kt">uint8_t</span><span class="o">*</span><span class="w"> </span><span class="n">RLG</span><span class="p">,</span>
<span class="linenos">242</span><span class="w">                                                </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="n">reactionOrdersG</span><span class="p">,</span>
<span class="linenos">243</span><span class="w">                                                </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="n">reactionSitesG</span><span class="p">,</span>
<span class="linenos">244</span><span class="w">                                                </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="n">D1G</span><span class="p">,</span>
<span class="linenos">245</span><span class="w">                                                </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="n">D2G</span><span class="p">,</span>
<span class="linenos">246</span><span class="w">                                                </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">reactionRatesG</span><span class="p">,</span>
<span class="linenos">247</span><span class="w">                                                </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="n">qp0</span><span class="p">,</span>
<span class="linenos">248</span><span class="w">                                                </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="n">qp1</span><span class="p">,</span>
<span class="linenos">249</span><span class="w">                                                </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="n">qp2</span><span class="p">);</span>
<span class="linenos">250</span><span class="w">    </span><span class="cp">#else</span>
<span class="linenos">251</span><span class="w">        </span><span class="n">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">precomp_reaction_kernel</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">inLattice</span><span class="p">,</span>
<span class="linenos">252</span><span class="w">                                                </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="o">*</span><span class="w"> </span><span class="n">inSites</span><span class="p">,</span>
<span class="linenos">253</span><span class="w">                                                </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">outLattice</span><span class="p">,</span>
<span class="linenos">254</span><span class="w">                                                </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">,</span>
<span class="linenos">255</span><span class="w">                                                </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">,</span>
<span class="linenos">256</span><span class="w">                                                </span><span class="k">const</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="kt">int8_t</span><span class="o">*</span><span class="w"> </span><span class="n">SG</span><span class="p">,</span>
<span class="linenos">257</span><span class="w">                                                </span><span class="k">const</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="kt">uint8_t</span><span class="o">*</span><span class="w"> </span><span class="n">RLG</span><span class="p">,</span>
<span class="linenos">258</span><span class="w">                                                </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="n">qp0</span><span class="p">,</span>
<span class="linenos">259</span><span class="w">                                                </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="n">qp1</span><span class="p">,</span>
<span class="linenos">260</span><span class="w">                                                </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="n">qp2</span><span class="p">);</span>
<span class="linenos">261</span><span class="w">    </span><span class="cp">#endif</span>
<span class="linenos">262</span><span class="cp">#endif</span>
<span class="linenos">263</span>
<span class="linenos">264</span><span class="cp">#ifdef MPD_CUDA_3D_GRID_LAUNCH</span>
<span class="linenos">265</span><span class="w">    </span><span class="n">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">mpd_x_kernel</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">inLattice</span><span class="p">,</span>
<span class="linenos">266</span><span class="w">                                 </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="o">*</span><span class="w"> </span><span class="n">inSites</span><span class="p">,</span>
<span class="linenos">267</span><span class="w">                                 </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">outLattice</span><span class="p">,</span>
<span class="linenos">268</span><span class="w">                                 </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">,</span>
<span class="linenos">269</span><span class="w">                                 </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">);</span>
<span class="linenos">270</span>
<span class="linenos">271</span><span class="w">    </span><span class="n">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">mpd_y_kernel</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">inLattice</span><span class="p">,</span>
<span class="linenos">272</span><span class="w">                                 </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="o">*</span><span class="w"> </span><span class="n">inSites</span><span class="p">,</span>
<span class="linenos">273</span><span class="w">                                 </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">outLattice</span><span class="p">,</span>
<span class="linenos">274</span><span class="w">                                 </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">,</span>
<span class="linenos">275</span><span class="w">                                 </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">);</span>
<span class="linenos">276</span>
<span class="linenos">277</span><span class="w">    </span><span class="n">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">mpd_z_kernel</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">inLattice</span><span class="p">,</span>
<span class="linenos">278</span><span class="w">                                 </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="o">*</span><span class="w"> </span><span class="n">inSites</span><span class="p">,</span>
<span class="linenos">279</span><span class="w">                                 </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">outLattice</span><span class="p">,</span>
<span class="linenos">280</span><span class="w">                                 </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">,</span>
<span class="linenos">281</span><span class="w">                                 </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">);</span>
<span class="linenos">282</span>
<span class="linenos">283</span><span class="w">    </span><span class="cp">#ifdef MPD_GLOBAL_S_MATRIX</span>
<span class="linenos">284</span><span class="w">        </span><span class="cp">#ifdef MPD_GLOBAL_R_MATRIX</span>
<span class="linenos">285</span><span class="w">            </span><span class="n">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">reaction_kernel</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">inLattice</span><span class="p">,</span>
<span class="linenos">286</span><span class="w">                                            </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="o">*</span><span class="w"> </span><span class="n">inSites</span><span class="p">,</span>
<span class="linenos">287</span><span class="w">                                            </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">outLattice</span><span class="p">,</span>
<span class="linenos">288</span><span class="w">                                            </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">,</span>
<span class="linenos">289</span><span class="w">                                            </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">,</span>
<span class="linenos">290</span><span class="w">                                            </span><span class="k">const</span><span class="w"> </span><span class="kt">int8_t</span><span class="o">*</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="n">SG</span><span class="p">,</span>
<span class="linenos">291</span><span class="w">                                            </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="o">*</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="n">RLG</span><span class="p">,</span>
<span class="linenos">292</span><span class="w">                                            </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="n">reactionOrdersG</span><span class="p">,</span>
<span class="linenos">293</span><span class="w">                                            </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="n">reactionSitesG</span><span class="p">,</span>
<span class="linenos">294</span><span class="w">                                            </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="n">D1G</span><span class="p">,</span>
<span class="linenos">295</span><span class="w">                                            </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="n">D2G</span><span class="p">,</span>
<span class="linenos">296</span><span class="w">                                            </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="n">reactionRatesG</span><span class="p">);</span>
<span class="linenos">297</span><span class="w">        </span><span class="cp">#else</span>
<span class="linenos">298</span><span class="w">            </span><span class="n">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">reaction_kernel</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">inLattice</span><span class="p">,</span>
<span class="linenos">299</span><span class="w">                                            </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="o">*</span><span class="w"> </span><span class="n">inSites</span><span class="p">,</span>
<span class="linenos">300</span><span class="w">                                            </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">outLattice</span><span class="p">,</span>
<span class="linenos">301</span><span class="w">                                            </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">,</span>
<span class="linenos">302</span><span class="w">                                            </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">,</span>
<span class="linenos">303</span><span class="w">                                            </span><span class="k">const</span><span class="w"> </span><span class="kt">int8_t</span><span class="o">*</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="n">SG</span><span class="p">,</span>
<span class="linenos">304</span><span class="w">                                            </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="o">*</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="n">RLG</span><span class="p">);</span>
<span class="linenos">305</span><span class="w">        </span><span class="cp">#endif</span>
<span class="linenos">306</span><span class="w">    </span><span class="cp">#else</span>
<span class="linenos">307</span><span class="w">        </span><span class="n">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">reaction_kernel</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">inLattice</span><span class="p">,</span>
<span class="linenos">308</span><span class="w">                                        </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="o">*</span><span class="w"> </span><span class="n">inSites</span><span class="p">,</span>
<span class="linenos">309</span><span class="w">                                        </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">outLattice</span><span class="p">,</span>
<span class="linenos">310</span><span class="w">                                        </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">,</span>
<span class="linenos">311</span><span class="w">                                        </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">);</span>
<span class="linenos">312</span><span class="w">    </span><span class="cp">#endif</span>
<span class="linenos">313</span><span class="cp">#else</span>
<span class="linenos">314</span><span class="w">    </span><span class="n">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">mpd_x_kernel</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">inLattice</span><span class="p">,</span>
<span class="linenos">315</span><span class="w">                                 </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="o">*</span><span class="w"> </span><span class="n">inSites</span><span class="p">,</span>
<span class="linenos">316</span><span class="w">                                 </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">outLattice</span><span class="p">,</span>
<span class="linenos">317</span><span class="w">                                 </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">gridXSize</span><span class="p">,</span>
<span class="linenos">318</span><span class="w">                                 </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">,</span>
<span class="linenos">319</span><span class="w">                                 </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">);</span>
<span class="linenos">320</span>
<span class="linenos">321</span><span class="w">    </span><span class="n">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">mpd_y_kernel</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">inLattice</span><span class="p">,</span>
<span class="linenos">322</span><span class="w">                                 </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="o">*</span><span class="w"> </span><span class="n">inSites</span><span class="p">,</span>
<span class="linenos">323</span><span class="w">                                 </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">outLattice</span><span class="p">,</span>
<span class="linenos">324</span><span class="w">                                 </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">gridXSize</span><span class="p">,</span>
<span class="linenos">325</span><span class="w">                                 </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">,</span>
<span class="linenos">326</span><span class="w">                                 </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">);</span>
<span class="linenos">327</span>
<span class="linenos">328</span><span class="w">    </span><span class="n">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">mpd_z_kernel</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">inLattice</span><span class="p">,</span>
<span class="linenos">329</span><span class="w">                                 </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="o">*</span><span class="w"> </span><span class="n">inSites</span><span class="p">,</span>
<span class="linenos">330</span><span class="w">                                 </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">outLattice</span><span class="p">,</span>
<span class="linenos">331</span><span class="w">                                 </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">gridXSize</span><span class="p">,</span>
<span class="linenos">332</span><span class="w">                                 </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">,</span>
<span class="linenos">333</span><span class="w">                                 </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">);</span>
<span class="linenos">334</span>
<span class="linenos">335</span><span class="w">    </span><span class="cp">#ifdef MPD_GLOBAL_S_MATRIX</span>
<span class="linenos">336</span><span class="w">        </span><span class="cp">#ifdef MPD_GLOBAL_R_MATRIX</span>
<span class="linenos">337</span><span class="w">            </span><span class="n">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">reaction_kernel</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">inLattice</span><span class="p">,</span>
<span class="linenos">338</span><span class="w">                                            </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="o">*</span><span class="w"> </span><span class="n">inSites</span><span class="p">,</span>
<span class="linenos">339</span><span class="w">                                            </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">outLattice</span><span class="p">,</span>
<span class="linenos">340</span><span class="w">                                            </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">gridXSize</span><span class="p">,</span>
<span class="linenos">341</span><span class="w">                                            </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">,</span>
<span class="linenos">342</span><span class="w">                                            </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">,</span>
<span class="linenos">343</span><span class="w">                                            </span><span class="k">const</span><span class="w"> </span><span class="kt">int8_t</span><span class="o">*</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="n">SG</span><span class="p">,</span>
<span class="linenos">344</span><span class="w">                                            </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="o">*</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="n">RLG</span><span class="p">,</span>
<span class="linenos">345</span><span class="w">                                            </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="n">reactionOrdersG</span><span class="p">,</span>
<span class="linenos">346</span><span class="w">                                            </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="n">reactionSitesG</span><span class="p">,</span>
<span class="linenos">347</span><span class="w">                                            </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="n">D1G</span><span class="p">,</span>
<span class="linenos">348</span><span class="w">                                            </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="n">D2G</span><span class="p">,</span>
<span class="linenos">349</span><span class="w">                                            </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="n">reactionRatesG</span><span class="p">);</span>
<span class="linenos">350</span><span class="w">        </span><span class="cp">#else</span>
<span class="linenos">351</span><span class="w">            </span><span class="n">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">reaction_kernel</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">inLattice</span><span class="p">,</span>
<span class="linenos">352</span><span class="w">                                            </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="o">*</span><span class="w"> </span><span class="n">inSites</span><span class="p">,</span>
<span class="linenos">353</span><span class="w">                                            </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">outLattice</span><span class="p">,</span>
<span class="linenos">354</span><span class="w">                                            </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">gridXSize</span><span class="p">,</span>
<span class="linenos">355</span><span class="w">                                            </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">,</span>
<span class="linenos">356</span><span class="w">                                            </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">,</span>
<span class="linenos">357</span><span class="w">                                            </span><span class="k">const</span><span class="w"> </span><span class="kt">int8_t</span><span class="o">*</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="n">SG</span><span class="p">,</span>
<span class="linenos">358</span><span class="w">                                            </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="o">*</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="n">RLG</span><span class="p">);</span>
<span class="linenos">359</span><span class="w">        </span><span class="cp">#endif</span>
<span class="linenos">360</span><span class="w">    </span><span class="cp">#else</span>
<span class="linenos">361</span><span class="w">        </span><span class="n">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">reaction_kernel</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">inLattice</span><span class="p">,</span>
<span class="linenos">362</span><span class="w">                                        </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="o">*</span><span class="w"> </span><span class="n">inSites</span><span class="p">,</span>
<span class="linenos">363</span><span class="w">                                        </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">outLattice</span><span class="p">,</span>
<span class="linenos">364</span><span class="w">                                        </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">gridXSize</span><span class="p">,</span>
<span class="linenos">365</span><span class="w">                                        </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">,</span>
<span class="linenos">366</span><span class="w">                                        </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">);</span>
<span class="linenos">367</span><span class="w">    </span><span class="cp">#endif</span>
<span class="linenos">368</span><span class="cp">#endif</span>
<span class="linenos">369</span>
<span class="linenos">370</span><span class="p">}</span>
<span class="linenos">371</span><span class="p">}</span>
<span class="linenos">372</span><span class="p">}</span>
<span class="linenos">373</span>
<span class="linenos">374</span><span class="cp">#endif</span>
</pre></div>
</div>
</section>
<section id="intmpdrdmesolver-cu">
<h3>IntMpdRdmeSolver.cu<a class="headerlink" href="#intmpdrdmesolver-cu" title="Link to this heading">#</a></h3>
<div class="highlight-cuda notranslate"><div class="highlight"><pre><span></span><span class="linenos">   1</span><span class="cm">/*</span>
<span class="linenos">   2</span><span class="cm"> * University of Illinois Open Source License</span>
<span class="linenos">   3</span><span class="cm"> * Copyright 2008-2018 Luthey-Schulten Group,</span>
<span class="linenos">   4</span><span class="cm"> * Copyright 2012 Roberts Group,</span>
<span class="linenos">   5</span><span class="cm"> * All rights reserved.</span>
<span class="linenos">   6</span><span class="cm"> * </span>
<span class="linenos">   7</span><span class="cm"> * Developed by: Luthey-Schulten Group</span>
<span class="linenos">   8</span><span class="cm"> *               University of Illinois at Urbana-Champaign</span>
<span class="linenos">   9</span><span class="cm"> *               http://www.scs.uiuc.edu/~schulten</span>
<span class="linenos">  10</span><span class="cm"> * </span>
<span class="linenos">  11</span><span class="cm"> * Developed by: Roberts Group</span>
<span class="linenos">  12</span><span class="cm"> *               Johns Hopkins University</span>
<span class="linenos">  13</span><span class="cm"> *               http://biophysics.jhu.edu/roberts/</span>
<span class="linenos">  14</span><span class="cm"> *</span>
<span class="linenos">  15</span><span class="cm"> * Permission is hereby granted, free of charge, to any person obtaining a copy of</span>
<span class="linenos">  16</span><span class="cm"> * this software and associated documentation files (the Software), to deal with </span>
<span class="linenos">  17</span><span class="cm"> * the Software without restriction, including without limitation the rights to </span>
<span class="linenos">  18</span><span class="cm"> * use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies </span>
<span class="linenos">  19</span><span class="cm"> * of the Software, and to permit persons to whom the Software is furnished to </span>
<span class="linenos">  20</span><span class="cm"> * do so, subject to the following conditions:</span>
<span class="linenos">  21</span><span class="cm"> * </span>
<span class="linenos">  22</span><span class="cm"> * - Redistributions of source code must retain the above copyright notice, </span>
<span class="linenos">  23</span><span class="cm"> * this list of conditions and the following disclaimers.</span>
<span class="linenos">  24</span><span class="cm"> * </span>
<span class="linenos">  25</span><span class="cm"> * - Redistributions in binary form must reproduce the above copyright notice, </span>
<span class="linenos">  26</span><span class="cm"> * this list of conditions and the following disclaimers in the documentation </span>
<span class="linenos">  27</span><span class="cm"> * and/or other materials provided with the distribution.</span>
<span class="linenos">  28</span><span class="cm"> * </span>
<span class="linenos">  29</span><span class="cm"> * - Neither the names of the Luthey-Schulten Group, University of Illinois at</span>
<span class="linenos">  30</span><span class="cm"> * Urbana-Champaign, the Roberts Group, Johns Hopkins University, nor the names</span>
<span class="linenos">  31</span><span class="cm"> * of its contributors may be used to endorse or promote products derived from</span>
<span class="linenos">  32</span><span class="cm"> * this Software without specific prior written permission.</span>
<span class="linenos">  33</span><span class="cm"> * </span>
<span class="linenos">  34</span><span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR </span>
<span class="linenos">  35</span><span class="cm"> * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, </span>
<span class="linenos">  36</span><span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL </span>
<span class="linenos">  37</span><span class="cm"> * THE CONTRIBUTORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR </span>
<span class="linenos">  38</span><span class="cm"> * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, </span>
<span class="linenos">  39</span><span class="cm"> * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR </span>
<span class="linenos">  40</span><span class="cm"> * OTHER DEALINGS WITH THE SOFTWARE.</span>
<span class="linenos">  41</span><span class="cm"> *</span>
<span class="linenos">  42</span><span class="cm"> * Author(s): Elijah Roberts, Zane Thornburg</span>
<span class="linenos">  43</span><span class="cm"> */</span>
<span class="linenos">  44</span>
<span class="linenos">  45</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;map&gt;</span>
<span class="linenos">  46</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;string&gt;</span>
<span class="linenos">  47</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;cstdlib&gt;</span>
<span class="linenos">  48</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;config.h&quot;</span>
<span class="linenos">  49</span><span class="cp">#if defined(MACOSX)</span>
<span class="linenos">  50</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;mach/mach_time.h&gt;</span>
<span class="linenos">  51</span><span class="cp">#elif defined(LINUX)</span>
<span class="linenos">  52</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;time.h&gt;</span>
<span class="linenos">  53</span><span class="cp">#endif</span>
<span class="linenos">  54</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;cuda/lm_cuda.h&quot;</span>
<span class="linenos">  55</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;core/Math.h&quot;</span>
<span class="linenos">  56</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;core/Print.h&quot;</span>
<span class="linenos">  57</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;cme/CMESolver.h&quot;</span>
<span class="linenos">  58</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;DiffusionModel.pb.h&quot;</span>
<span class="linenos">  59</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;Lattice.pb.h&quot;</span>
<span class="linenos">  60</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;SpeciesCounts.pb.h&quot;</span>
<span class="linenos">  61</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;core/DataOutputQueue.h&quot;</span>
<span class="linenos">  62</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;core/ResourceAllocator.h&quot;</span>
<span class="linenos">  63</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;rdme/ByteLattice.h&quot;</span>
<span class="linenos">  64</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;rdme/IntLattice.h&quot;</span>
<span class="linenos">  65</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;rdme/CudaIntLattice.h&quot;</span>
<span class="linenos">  66</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;rdme/IntMpdRdmeSolver.h&quot;</span>
<span class="linenos">  67</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;rng/RandomGenerator.h&quot;</span>
<span class="linenos">  68</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;lptf/Profile.h&quot;</span>
<span class="linenos">  69</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;core/Timer.h&quot;</span>
<span class="linenos">  70</span>
<span class="linenos">  71</span><span class="cp">#define MPD_WORDS_PER_SITE    MPD_LATTICE_MAX_OCCUPANCY </span><span class="c1">// 16 </span>
<span class="linenos">  72</span><span class="cp">#define MPD_APRON_SIZE        1</span>
<span class="linenos">  73</span>
<span class="linenos">  74</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;cuda/constant.cuh&quot;</span>
<span class="linenos">  75</span>
<span class="linenos">  76</span><span class="n">namespace</span><span class="w"> </span><span class="n">lm</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">  77</span><span class="n">namespace</span><span class="w"> </span><span class="n">rdme</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">  78</span><span class="n">namespace</span><span class="w"> </span><span class="n">intmpdrdme_dev</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">  79</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;rdme/dev/xor_random_dev.cu&quot;</span>
<span class="linenos">  80</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;rdme/dev/lattice_sim_1d_dev.cu&quot;</span>
<span class="linenos">  81</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;rdme/dev/word_diffusion_1d_dev.cu&quot;</span>
<span class="linenos">  82</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;rdme/dev/word_reaction_dev.cu&quot;</span>
<span class="linenos">  83</span><span class="p">}}}</span>
<span class="linenos">  84</span>
<span class="linenos">  85</span><span class="k">extern</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">globalAbort</span><span class="p">;</span>
<span class="linenos">  86</span>
<span class="linenos">  87</span><span class="n">using</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="p">;</span>
<span class="linenos">  88</span><span class="n">using</span><span class="w"> </span><span class="n">lm</span><span class="o">::</span><span class="n">io</span><span class="o">::</span><span class="n">DiffusionModel</span><span class="p">;</span>
<span class="linenos">  89</span><span class="n">using</span><span class="w"> </span><span class="n">lm</span><span class="o">::</span><span class="n">rdme</span><span class="o">::</span><span class="n">Lattice</span><span class="p">;</span>
<span class="linenos">  90</span><span class="n">using</span><span class="w"> </span><span class="n">lm</span><span class="o">::</span><span class="n">rng</span><span class="o">::</span><span class="n">RandomGenerator</span><span class="p">;</span>
<span class="linenos">  91</span>
<span class="linenos">  92</span><span class="n">namespace</span><span class="w"> </span><span class="n">lm</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">  93</span><span class="n">namespace</span><span class="w"> </span><span class="n">rdme</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">  94</span>
<span class="linenos">  95</span><span class="n">IntMpdRdmeSolver</span><span class="o">::</span><span class="n">IntMpdRdmeSolver</span><span class="p">()</span>
<span class="linenos">  96</span><span class="o">:</span><span class="n">RDMESolver</span><span class="p">(</span><span class="n">lm</span><span class="o">::</span><span class="n">rng</span><span class="o">::</span><span class="n">RandomGenerator</span><span class="o">::</span><span class="n">NONE</span><span class="p">),</span>
<span class="linenos">  97</span><span class="w"> </span><span class="n">seed</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="n">tau</span><span class="p">(</span><span class="mf">0.0</span><span class="p">),</span>
<span class="linenos">  98</span><span class="w"> </span><span class="n">cudaOverflowList</span><span class="p">(</span><span class="nb">NULL</span><span class="p">),</span><span class="w"> </span><span class="n">cudaStream</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
<span class="linenos">  99</span><span class="w"> </span><span class="n">overflowTimesteps</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="n">overflowListUses</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
<span class="linenos"> 100</span><span class="w"> </span><span class="n">model_reactionRates</span><span class="p">(</span><span class="nb">NULL</span><span class="p">),</span>
<span class="linenos"> 101</span><span class="w"> </span><span class="n">zeroOrder</span><span class="p">(</span><span class="nb">NULL</span><span class="p">),</span><span class="w"> </span><span class="n">firstOrder</span><span class="p">(</span><span class="nb">NULL</span><span class="p">),</span><span class="w"> </span><span class="n">secondOrder</span><span class="p">(</span><span class="nb">NULL</span><span class="p">)</span>
<span class="linenos"> 102</span><span class="p">{</span>
<span class="linenos"> 103</span><span class="p">}</span>
<span class="linenos"> 104</span>
<span class="linenos"> 105</span><span class="kt">void</span><span class="w"> </span><span class="n">IntMpdRdmeSolver</span><span class="o">::</span><span class="n">initialize</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">replicate</span><span class="p">,</span><span class="w"> </span><span class="n">map</span><span class="o">&lt;</span><span class="n">string</span><span class="p">,</span><span class="n">string</span><span class="o">&gt;</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">parameters</span><span class="p">,</span><span class="w"> </span><span class="n">ResourceAllocator</span><span class="o">::</span><span class="n">ComputeResources</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">resources</span><span class="p">)</span>
<span class="linenos"> 106</span><span class="p">{</span>
<span class="linenos"> 107</span><span class="w">	</span><span class="n">RDMESolver</span><span class="o">::</span><span class="n">initialize</span><span class="p">(</span><span class="n">replicate</span><span class="p">,</span><span class="w"> </span><span class="n">parameters</span><span class="p">,</span><span class="w"> </span><span class="n">resources</span><span class="p">);</span>
<span class="linenos"> 108</span>
<span class="linenos"> 109</span><span class="w">    </span><span class="c1">// Figure out the random seed.</span>
<span class="linenos"> 110</span><span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">seedTop</span><span class="o">=</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="p">)</span><span class="n">atoi</span><span class="p">((</span><span class="o">*</span><span class="n">parameters</span><span class="p">)[</span><span class="s">&quot;seed&quot;</span><span class="p">].</span><span class="n">c_str</span><span class="p">());</span>
<span class="linenos"> 111</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">seedTop</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="linenos"> 112</span><span class="w">    </span><span class="p">{</span>
<span class="linenos"> 113</span><span class="w">        </span><span class="cp">#if defined(MACOSX)</span>
<span class="linenos"> 114</span><span class="w">        </span><span class="n">seedTop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span><span class="n">mach_absolute_time</span><span class="p">();</span>
<span class="linenos"> 115</span><span class="w">        </span><span class="cp">#elif defined(LINUX)</span>
<span class="linenos"> 116</span><span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">timespec</span><span class="w"> </span><span class="n">seed_timespec</span><span class="p">;</span>
<span class="linenos"> 117</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">clock_gettime</span><span class="p">(</span><span class="n">CLOCK_REALTIME</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">seed_timespec</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="n">throw</span><span class="w"> </span><span class="n">lm</span><span class="o">::</span><span class="n">Exception</span><span class="p">(</span><span class="s">&quot;Error getting time to use for random seed.&quot;</span><span class="p">);</span>
<span class="linenos"> 118</span><span class="w">        </span><span class="n">seedTop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">seed_timespec</span><span class="p">.</span><span class="n">tv_nsec</span><span class="p">;</span>
<span class="linenos"> 119</span><span class="w">        </span><span class="cp">#endif</span>
<span class="linenos"> 120</span><span class="w">    </span><span class="p">}</span>
<span class="linenos"> 121</span><span class="w">    </span><span class="n">seed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">seedTop</span><span class="o">&lt;&lt;</span><span class="mi">16</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="n">replicate</span><span class="o">&amp;</span><span class="mh">0x0000FFFF</span><span class="p">);</span>
<span class="linenos"> 122</span>
<span class="linenos"> 123</span><span class="w">    </span><span class="c1">// Allocate memory on the device for the exception list.</span>
<span class="linenos"> 124</span><span class="w">    </span><span class="n">CUDA_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">cudaMalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cudaOverflowList</span><span class="p">,</span><span class="w"> </span><span class="n">MPD_OVERFLOW_LIST_SIZE</span><span class="p">));</span><span class="w"> </span><span class="c1">//TODO: track memory usage.</span>
<span class="linenos"> 125</span><span class="w">    </span><span class="n">CUDA_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">cudaMemset</span><span class="p">(</span><span class="n">cudaOverflowList</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">MPD_OVERFLOW_LIST_SIZE</span><span class="p">));</span>
<span class="linenos"> 126</span>
<span class="linenos"> 127</span><span class="w">    </span><span class="c1">// Create a stream for synchronizing the events.</span>
<span class="linenos"> 128</span><span class="w">    </span><span class="n">CUDA_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">cudaStreamCreate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cudaStream</span><span class="p">));</span>
<span class="linenos"> 129</span><span class="p">}</span>
<span class="linenos"> 130</span>
<span class="linenos"> 131</span><span class="n">IntMpdRdmeSolver</span><span class="o">::~</span><span class="n">IntMpdRdmeSolver</span><span class="p">()</span>
<span class="linenos"> 132</span><span class="p">{</span>
<span class="linenos"> 133</span><span class="w">    </span><span class="c1">// Free any device memory.</span>
<span class="linenos"> 134</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cudaOverflowList</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span>
<span class="linenos"> 135</span><span class="w">    </span><span class="p">{</span>
<span class="linenos"> 136</span><span class="w">        </span><span class="n">CUDA_EXCEPTION_CHECK_NOTHROW</span><span class="p">(</span><span class="n">cudaFree</span><span class="p">(</span><span class="n">cudaOverflowList</span><span class="p">));</span><span class="w"> </span><span class="c1">//TODO: track memory usage.</span>
<span class="linenos"> 137</span><span class="w">        </span><span class="n">cudaOverflowList</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="linenos"> 138</span><span class="w">    </span><span class="p">}</span>
<span class="linenos"> 139</span>
<span class="linenos"> 140</span><span class="w">    </span><span class="c1">// If we have created a stream, destroy it.</span>
<span class="linenos"> 141</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cudaStream</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="linenos"> 142</span><span class="w">    </span><span class="p">{</span>
<span class="linenos"> 143</span><span class="w">        </span><span class="n">CUDA_EXCEPTION_CHECK_NOTHROW</span><span class="p">(</span><span class="n">cudaStreamDestroy</span><span class="p">(</span><span class="n">cudaStream</span><span class="p">));</span>
<span class="linenos"> 144</span><span class="w">        </span><span class="n">cudaStream</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="linenos"> 145</span><span class="w">    </span><span class="p">}</span>
<span class="linenos"> 146</span>
<span class="linenos"> 147</span><span class="w">    </span><span class="c1">// Free allocated memory in IntMpdRdmeSolver</span>
<span class="linenos"> 148</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">model_reactionRates</span><span class="p">)</span><span class="w">  </span><span class="p">{</span><span class="n">delete</span><span class="w"> </span><span class="p">[]</span><span class="w"> </span><span class="n">model_reactionRates</span><span class="p">;}</span>
<span class="linenos"> 149</span>
<span class="linenos"> 150</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">zeroOrder</span><span class="p">)</span><span class="w">   </span><span class="p">{</span><span class="n">delete</span><span class="w"> </span><span class="p">[]</span><span class="w"> </span><span class="n">zeroOrder</span><span class="p">;}</span>
<span class="linenos"> 151</span><span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">firstOrder</span><span class="p">)</span><span class="w">  </span><span class="p">{</span><span class="n">delete</span><span class="w"> </span><span class="p">[]</span><span class="w"> </span><span class="n">firstOrder</span><span class="p">;}</span>
<span class="linenos"> 152</span><span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">secondOrder</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="n">delete</span><span class="w"> </span><span class="p">[]</span><span class="w"> </span><span class="n">secondOrder</span><span class="p">;}</span>
<span class="linenos"> 153</span><span class="p">}</span>
<span class="linenos"> 154</span>
<span class="linenos"> 155</span><span class="kt">void</span><span class="w"> </span><span class="n">IntMpdRdmeSolver</span><span class="o">::</span><span class="n">allocateLattice</span><span class="p">(</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">latticeXSize</span><span class="p">,</span><span class="w"> </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">latticeYSize</span><span class="p">,</span><span class="w"> </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">latticeZSize</span><span class="p">,</span><span class="w"> </span><span class="n">site_size_t</span><span class="w"> </span><span class="n">particlesPerSite</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">bytes_per_particle</span><span class="p">,</span><span class="w"> </span><span class="n">si_dist_t</span><span class="w"> </span><span class="n">latticeSpacing</span><span class="p">)</span>
<span class="linenos"> 156</span><span class="p">{</span>
<span class="linenos"> 157</span><span class="w">	</span><span class="k">if</span><span class="p">(</span><span class="n">bytes_per_particle</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span>
<span class="linenos"> 158</span><span class="w">	</span><span class="p">{</span>
<span class="linenos"> 159</span><span class="w">		</span><span class="n">Print</span><span class="o">::</span><span class="n">printf</span><span class="p">(</span><span class="n">Print</span><span class="o">::</span><span class="n">ERROR</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;IntMpdRdmeSolver works only with lattices of 4 bytes per particle, not %d&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">bytes_per_particle</span><span class="p">);</span>
<span class="linenos"> 160</span><span class="w">		</span><span class="n">throw</span><span class="w"> </span><span class="n">Exception</span><span class="p">(</span><span class="s">&quot;incorrect lattice data type&quot;</span><span class="p">);</span>
<span class="linenos"> 161</span><span class="w">	</span><span class="p">}</span>
<span class="linenos"> 162</span>
<span class="linenos"> 163</span><span class="w">	</span><span class="k">if</span><span class="p">(</span><span class="n">particlesPerSite</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">MPD_LATTICE_MAX_OCCUPANCY</span><span class="p">)</span>
<span class="linenos"> 164</span><span class="w">	</span><span class="p">{</span>
<span class="linenos"> 165</span><span class="w">		</span><span class="n">Print</span><span class="o">::</span><span class="n">printf</span><span class="p">(</span><span class="n">Print</span><span class="o">::</span><span class="n">ERROR</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;requested allocation for %d particles per site is not %d&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">particlesPerSite</span><span class="p">,</span><span class="w"> </span><span class="n">MPD_LATTICE_MAX_OCCUPANCY</span><span class="p">);</span>
<span class="linenos"> 166</span><span class="w">		</span><span class="n">throw</span><span class="w"> </span><span class="n">Exception</span><span class="p">(</span><span class="s">&quot;incorrect particle density&quot;</span><span class="p">);</span>
<span class="linenos"> 167</span><span class="w">	</span><span class="p">}</span>
<span class="linenos"> 168</span>
<span class="linenos"> 169</span><span class="w">    </span><span class="n">lattice</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Lattice</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">new</span><span class="w"> </span><span class="n">CudaIntLattice</span><span class="p">(</span><span class="n">latticeXSize</span><span class="p">,</span><span class="w"> </span><span class="n">latticeYSize</span><span class="p">,</span><span class="w"> </span><span class="n">latticeZSize</span><span class="p">,</span><span class="w"> </span><span class="n">latticeSpacing</span><span class="p">,</span><span class="w"> </span><span class="n">particlesPerSite</span><span class="p">);</span>
<span class="linenos"> 170</span><span class="p">}</span>
<span class="linenos"> 171</span>
<span class="linenos"> 172</span><span class="kt">void</span><span class="w"> </span><span class="n">IntMpdRdmeSolver</span><span class="o">::</span><span class="n">buildModel</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">uint</span><span class="w"> </span><span class="n">numberSpeciesA</span><span class="p">,</span>
<span class="linenos"> 173</span><span class="w">                                  </span><span class="k">const</span><span class="w"> </span><span class="n">uint</span><span class="w"> </span><span class="n">numberReactionsA</span><span class="p">,</span>
<span class="linenos"> 174</span><span class="w">                                  </span><span class="k">const</span><span class="w"> </span><span class="n">uint</span><span class="o">*</span><span class="w"> </span><span class="n">initialSpeciesCountsA</span><span class="p">,</span>
<span class="linenos"> 175</span><span class="w">                                  </span><span class="k">const</span><span class="w"> </span><span class="n">uint</span><span class="o">*</span><span class="w"> </span><span class="n">reactionTypesA</span><span class="p">,</span>
<span class="linenos"> 176</span><span class="w">                                  </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="o">*</span><span class="w"> </span><span class="n">KA</span><span class="p">,</span>
<span class="linenos"> 177</span><span class="w">                                  </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">SA</span><span class="p">,</span>
<span class="linenos"> 178</span><span class="w">                                  </span><span class="k">const</span><span class="w"> </span><span class="n">uint</span><span class="o">*</span><span class="w"> </span><span class="n">DA</span><span class="p">,</span>
<span class="linenos"> 179</span><span class="w">                                  </span><span class="k">const</span><span class="w"> </span><span class="n">uint</span><span class="w"> </span><span class="n">kCols</span><span class="p">)</span>
<span class="linenos"> 180</span><span class="p">{</span>
<span class="linenos"> 181</span><span class="w">    </span><span class="n">CMESolver</span><span class="o">::</span><span class="n">buildModel</span><span class="p">(</span><span class="n">numberSpeciesA</span><span class="p">,</span>
<span class="linenos"> 182</span><span class="w">                          </span><span class="n">numberReactionsA</span><span class="p">,</span>
<span class="linenos"> 183</span><span class="w">                          </span><span class="n">initialSpeciesCountsA</span><span class="p">,</span>
<span class="linenos"> 184</span><span class="w">                          </span><span class="n">reactionTypesA</span><span class="p">,</span>
<span class="linenos"> 185</span><span class="w">                          </span><span class="n">KA</span><span class="p">,</span><span class="w"> </span><span class="n">SA</span><span class="p">,</span><span class="w"> </span><span class="n">DA</span><span class="p">,</span><span class="w"> </span><span class="n">kCols</span><span class="p">);</span>
<span class="linenos"> 186</span>
<span class="linenos"> 187</span><span class="w">    </span><span class="c1">// Get the time step.</span>
<span class="linenos"> 188</span><span class="w">    </span><span class="n">tau</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">atof</span><span class="p">((</span><span class="o">*</span><span class="n">parameters</span><span class="p">)[</span><span class="s">&quot;timestep&quot;</span><span class="p">].</span><span class="n">c_str</span><span class="p">());</span>
<span class="linenos"> 189</span>
<span class="linenos"> 190</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tau</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">)</span>
<span class="linenos"> 191</span><span class="w">    </span><span class="p">{</span>
<span class="linenos"> 192</span><span class="w">        </span><span class="n">throw</span><span class="w"> </span><span class="n">InvalidArgException</span><span class="p">(</span><span class="s">&quot;timestep&quot;</span><span class="p">,</span>
<span class="linenos"> 193</span><span class="w">                                  </span><span class="s">&quot;A positive timestep must be specified for the solver.&quot;</span><span class="p">);</span>
<span class="linenos"> 194</span><span class="w">    </span><span class="p">}</span>
<span class="linenos"> 195</span>
<span class="linenos"> 196</span><span class="w">    </span><span class="c1">// Make sure we can support the reaction model.</span>
<span class="linenos"> 197</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">numberReactions</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">MPD_MAX_REACTION_TABLE_ENTRIES</span><span class="p">)</span>
<span class="linenos"> 198</span><span class="w">    </span><span class="p">{</span>
<span class="linenos"> 199</span><span class="w">        </span><span class="n">throw</span><span class="w"> </span><span class="n">Exception</span><span class="p">(</span><span class="s">&quot;The number of reaction table entries exceeds the maximum supported by the solver.&quot;</span><span class="p">);</span>
<span class="linenos"> 200</span><span class="w">    </span><span class="p">}</span>
<span class="linenos"> 201</span>
<span class="linenos"> 202</span><span class="cp">#ifndef MPD_GLOBAL_S_MATRIX</span>
<span class="linenos"> 203</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">numberSpecies</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">numberReactions</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">MPD_MAX_S_MATRIX_ENTRIES</span><span class="p">)</span>
<span class="linenos"> 204</span><span class="w">    </span><span class="p">{</span>
<span class="linenos"> 205</span><span class="w">        </span><span class="n">throw</span><span class="w"> </span><span class="n">Exception</span><span class="p">(</span><span class="s">&quot;The number of S matrix entries exceeds the maximum supported by the solver.&quot;</span><span class="p">);</span>
<span class="linenos"> 206</span><span class="w">    </span><span class="p">}</span>
<span class="linenos"> 207</span><span class="cp">#endif</span>
<span class="linenos"> 208</span>
<span class="linenos"> 209</span><span class="w">    </span><span class="c1">// Setup the cuda reaction model.</span>
<span class="linenos"> 210</span><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">reactionOrders</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="p">[</span><span class="n">numberReactions</span><span class="p">];</span>
<span class="linenos"> 211</span><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">reactionSites</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="p">[</span><span class="n">numberReactions</span><span class="p">];</span>
<span class="linenos"> 212</span><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">D1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="p">[</span><span class="n">numberReactions</span><span class="p">];</span>
<span class="linenos"> 213</span><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">D2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="p">[</span><span class="n">numberReactions</span><span class="p">];</span>
<span class="linenos"> 214</span>
<span class="linenos"> 215</span><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">numberReactions</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="linenos"> 216</span><span class="w">    </span><span class="p">{</span>
<span class="linenos"> 217</span><span class="w">	    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">reactionTypes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ZerothOrderPropensityArgs</span><span class="o">::</span><span class="n">REACTION_TYPE</span><span class="p">)</span>
<span class="linenos"> 218</span><span class="w">        </span><span class="p">{</span>
<span class="linenos"> 219</span><span class="w">    	    </span><span class="n">reactionOrders</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MPD_ZERO_ORDER_REACTION</span><span class="p">;</span>
<span class="linenos"> 220</span><span class="w">    		</span><span class="n">reactionSites</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos"> 221</span><span class="w">    		</span><span class="n">D1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span>
<span class="linenos"> 222</span><span class="w">    		</span><span class="n">D2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos"> 223</span><span class="w">	    </span><span class="p">}</span>
<span class="linenos"> 224</span><span class="w">    	</span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">reactionTypes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">FirstOrderPropensityArgs</span><span class="o">::</span><span class="n">REACTION_TYPE</span><span class="p">)</span>
<span class="linenos"> 225</span><span class="w">    	</span><span class="p">{</span>
<span class="linenos"> 226</span><span class="w">    		</span><span class="n">reactionOrders</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MPD_FIRST_ORDER_REACTION</span><span class="p">;</span>
<span class="linenos"> 227</span><span class="w">    		</span><span class="n">reactionSites</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos"> 228</span><span class="w">    		</span><span class="n">D1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="n">FirstOrderPropensityArgs</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">propensityFunctionArgs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">-&gt;</span><span class="n">si</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="linenos"> 229</span><span class="w">    		</span><span class="n">D2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos"> 230</span><span class="w">    	</span><span class="p">}</span>
<span class="linenos"> 231</span><span class="w">    	</span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">reactionTypes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">SecondOrderPropensityArgs</span><span class="o">::</span><span class="n">REACTION_TYPE</span><span class="p">)</span>
<span class="linenos"> 232</span><span class="w">    	</span><span class="p">{</span>
<span class="linenos"> 233</span><span class="w">    		</span><span class="n">reactionOrders</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MPD_SECOND_ORDER_REACTION</span><span class="p">;</span>
<span class="linenos"> 234</span><span class="w">    		</span><span class="n">reactionSites</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos"> 235</span><span class="w">    		</span><span class="n">D1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="n">SecondOrderPropensityArgs</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">propensityFunctionArgs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">-&gt;</span><span class="n">s1i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="linenos"> 236</span><span class="w">    		</span><span class="n">D2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="n">SecondOrderPropensityArgs</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">propensityFunctionArgs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">-&gt;</span><span class="n">s2i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="linenos"> 237</span><span class="w">    	</span><span class="p">}</span>
<span class="linenos"> 238</span><span class="w">    	</span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">reactionTypes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">SecondOrderSelfPropensityArgs</span><span class="o">::</span><span class="n">REACTION_TYPE</span><span class="p">)</span>
<span class="linenos"> 239</span><span class="w">    	</span><span class="p">{</span>
<span class="linenos"> 240</span><span class="w">    		</span><span class="n">reactionOrders</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MPD_SECOND_ORDER_SELF_REACTION</span><span class="p">;</span>
<span class="linenos"> 241</span><span class="w">    		</span><span class="n">reactionSites</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos"> 242</span><span class="w">    		</span><span class="n">D1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="n">SecondOrderSelfPropensityArgs</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">propensityFunctionArgs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">-&gt;</span><span class="n">si</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="linenos"> 243</span><span class="w">    		</span><span class="n">D2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos"> 244</span><span class="w">    	</span><span class="p">}</span>
<span class="linenos"> 245</span><span class="w">    	</span><span class="k">else</span>
<span class="linenos"> 246</span><span class="w">    	</span><span class="p">{</span>
<span class="linenos"> 247</span><span class="w">    		</span><span class="n">throw</span><span class="w"> </span><span class="n">InvalidArgException</span><span class="p">(</span><span class="s">&quot;reactionTypeA&quot;</span><span class="p">,</span>
<span class="linenos"> 248</span><span class="w">                                      </span><span class="s">&quot;the reaction type was not supported by the solver&quot;</span><span class="p">,</span>
<span class="linenos"> 249</span><span class="w">                                      </span><span class="n">reactionTypes</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="linenos"> 250</span><span class="w">    	</span><span class="p">}</span>
<span class="linenos"> 251</span><span class="w">    </span><span class="p">}</span>
<span class="linenos"> 252</span>
<span class="linenos"> 253</span><span class="w">    </span><span class="c1">// Setup the cuda S matrix.</span>
<span class="linenos"> 254</span><span class="w">	</span><span class="c1">// Transpose S on the device because we will want to read along the numSpecies axis</span>
<span class="linenos"> 255</span><span class="w">	</span><span class="c1">// Before A1A2A3A4A5 B1B2B3B4B5 C1C2C3C4C5 ...</span>
<span class="linenos"> 256</span><span class="w">	</span><span class="c1">// After A1B1C1 A2B2C2 ...</span>
<span class="linenos"> 257</span><span class="w">    </span><span class="kt">int8_t</span><span class="o">*</span><span class="w"> </span><span class="n">tmpS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="kt">int8_t</span><span class="p">[</span><span class="n">numberSpecies</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">numberReactions</span><span class="p">];</span>
<span class="linenos"> 258</span>
<span class="linenos"> 259</span><span class="w">	</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">rx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">rx</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">numberReactions</span><span class="p">;</span><span class="w"> </span><span class="n">rx</span><span class="o">++</span><span class="p">)</span>
<span class="linenos"> 260</span><span class="w">	</span><span class="p">{</span>
<span class="linenos"> 261</span><span class="w">		</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">numberSpecies</span><span class="p">;</span><span class="w"> </span><span class="n">p</span><span class="o">++</span><span class="p">)</span>
<span class="linenos"> 262</span><span class="w">		</span><span class="p">{</span>
<span class="linenos"> 263</span><span class="w">		    </span><span class="n">tmpS</span><span class="p">[(</span><span class="n">rx</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">numberSpecies</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">p</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">S</span><span class="p">[(</span><span class="n">numberReactions</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">rx</span><span class="p">];</span>
<span class="linenos"> 264</span><span class="w">		</span><span class="p">}</span>
<span class="linenos"> 265</span><span class="w">	</span><span class="p">}</span>
<span class="linenos"> 266</span>
<span class="linenos"> 267</span><span class="w">    </span><span class="n">cudaMemcpyToSymbol</span><span class="p">(</span><span class="n">numberReactionsC</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">numberReactions</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="p">));</span>
<span class="linenos"> 268</span>
<span class="linenos"> 269</span><span class="cp">#ifdef MPD_GLOBAL_R_MATRIX</span>
<span class="linenos"> 270</span><span class="w">    </span><span class="n">cudaMalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reactionOrdersG</span><span class="p">,</span><span class="w"> </span><span class="n">numberReactions</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="p">));</span>
<span class="linenos"> 271</span><span class="w">    </span><span class="n">cudaMemcpy</span><span class="p">(</span><span class="n">reactionOrdersG</span><span class="p">,</span><span class="w"> </span><span class="n">reactionOrders</span><span class="p">,</span><span class="w"> </span><span class="n">numberReactions</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="p">),</span><span class="w"> </span><span class="n">cudaMemcpyHostToDevice</span><span class="p">);</span>
<span class="linenos"> 272</span><span class="w">    </span><span class="n">cudaMalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reactionSitesG</span><span class="p">,</span><span class="w"> </span><span class="n">numberReactions</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="p">));</span>
<span class="linenos"> 273</span><span class="w">    </span><span class="n">cudaMemcpy</span><span class="p">(</span><span class="n">reactionSitesG</span><span class="p">,</span><span class="w"> </span><span class="n">reactionSites</span><span class="p">,</span><span class="w"> </span><span class="n">numberReactions</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="p">),</span><span class="w"> </span><span class="n">cudaMemcpyHostToDevice</span><span class="p">);</span>
<span class="linenos"> 274</span><span class="w">    </span><span class="n">cudaMalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">D1G</span><span class="p">,</span><span class="w"> </span><span class="n">numberReactions</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="p">));</span>
<span class="linenos"> 275</span><span class="w">    </span><span class="n">cudaMemcpy</span><span class="p">(</span><span class="n">D1G</span><span class="p">,</span><span class="w"> </span><span class="n">D1</span><span class="p">,</span><span class="w"> </span><span class="n">numberReactions</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="p">),</span><span class="w"> </span><span class="n">cudaMemcpyHostToDevice</span><span class="p">);</span>
<span class="linenos"> 276</span><span class="w">    </span><span class="n">cudaMalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">D2G</span><span class="p">,</span><span class="w"> </span><span class="n">numberReactions</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="p">));</span>
<span class="linenos"> 277</span><span class="w">    </span><span class="n">cudaMemcpy</span><span class="p">(</span><span class="n">D2G</span><span class="p">,</span><span class="w"> </span><span class="n">D2</span><span class="p">,</span><span class="w"> </span><span class="n">numberReactions</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="p">),</span><span class="w"> </span><span class="n">cudaMemcpyHostToDevice</span><span class="p">);</span>
<span class="linenos"> 278</span><span class="cp">#else</span>
<span class="linenos"> 279</span><span class="w">    </span><span class="n">cudaMemcpyToSymbol</span><span class="p">(</span><span class="n">reactionOrdersC</span><span class="p">,</span><span class="w"> </span><span class="n">reactionOrders</span><span class="p">,</span><span class="w"> </span><span class="n">numberReactions</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="p">));</span>
<span class="linenos"> 280</span><span class="w">    </span><span class="n">cudaMemcpyToSymbol</span><span class="p">(</span><span class="n">reactionSitesC</span><span class="p">,</span><span class="w">  </span><span class="n">reactionSites</span><span class="p">,</span><span class="w">  </span><span class="n">numberReactions</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="p">));</span>
<span class="linenos"> 281</span><span class="w">    </span><span class="n">cudaMemcpyToSymbol</span><span class="p">(</span><span class="n">D1C</span><span class="p">,</span><span class="w"> </span><span class="n">D1</span><span class="p">,</span><span class="w"> </span><span class="n">numberReactions</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="p">));</span>
<span class="linenos"> 282</span><span class="w">    </span><span class="n">cudaMemcpyToSymbol</span><span class="p">(</span><span class="n">D2C</span><span class="p">,</span><span class="w"> </span><span class="n">D2</span><span class="p">,</span><span class="w"> </span><span class="n">numberReactions</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="p">));</span>
<span class="linenos"> 283</span><span class="cp">#endif</span>
<span class="linenos"> 284</span>
<span class="linenos"> 285</span><span class="cp">#ifdef MPD_GLOBAL_S_MATRIX</span>
<span class="linenos"> 286</span><span class="w">    </span><span class="n">cudaMalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">SG</span><span class="p">,</span><span class="w"> </span><span class="n">numberSpecies</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">numberReactions</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int8_t</span><span class="p">));</span>
<span class="linenos"> 287</span><span class="w">	</span><span class="n">cudaMemcpy</span><span class="p">(</span><span class="n">SG</span><span class="p">,</span><span class="w"> </span><span class="n">tmpS</span><span class="p">,</span><span class="w"> </span><span class="n">numberSpecies</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">numberReactions</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int8_t</span><span class="p">),</span><span class="w"> </span><span class="n">cudaMemcpyHostToDevice</span><span class="p">);</span>
<span class="linenos"> 288</span><span class="cp">#else</span>
<span class="linenos"> 289</span><span class="w">    </span><span class="n">cudaMemcpyToSymbol</span><span class="p">(</span><span class="n">SC</span><span class="p">,</span><span class="w"> </span><span class="n">tmpS</span><span class="p">,</span><span class="w"> </span><span class="n">numberSpecies</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">numberReactions</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int8_t</span><span class="p">));</span>
<span class="linenos"> 290</span><span class="cp">#endif</span>
<span class="linenos"> 291</span>
<span class="linenos"> 292</span><span class="w">    </span><span class="c1">// Free any temporary resources.</span>
<span class="linenos"> 293</span><span class="w">    </span><span class="n">delete</span><span class="p">[]</span><span class="w"> </span><span class="n">reactionOrders</span><span class="p">;</span>
<span class="linenos"> 294</span><span class="w">    </span><span class="n">delete</span><span class="p">[]</span><span class="w"> </span><span class="n">reactionSites</span><span class="p">;</span>
<span class="linenos"> 295</span><span class="w">    </span><span class="n">delete</span><span class="p">[]</span><span class="w"> </span><span class="n">D1</span><span class="p">;</span>
<span class="linenos"> 296</span><span class="w">    </span><span class="n">delete</span><span class="p">[]</span><span class="w"> </span><span class="n">D2</span><span class="p">;</span>
<span class="linenos"> 297</span><span class="w">    </span><span class="n">delete</span><span class="p">[]</span><span class="w"> </span><span class="n">tmpS</span><span class="p">;</span>
<span class="linenos"> 298</span><span class="p">}</span>
<span class="linenos"> 299</span>
<span class="linenos"> 300</span><span class="kt">void</span><span class="w"> </span><span class="n">IntMpdRdmeSolver</span><span class="o">::</span><span class="n">buildDiffusionModel</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">uint</span><span class="w"> </span><span class="n">numberSiteTypesA</span><span class="p">,</span>
<span class="linenos"> 301</span><span class="w">                                           </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="o">*</span><span class="w"> </span><span class="n">DFA</span><span class="p">,</span>
<span class="linenos"> 302</span><span class="w">                                           </span><span class="k">const</span><span class="w"> </span><span class="n">uint</span><span class="o">*</span><span class="w"> </span><span class="n">RLA</span><span class="p">,</span>
<span class="linenos"> 303</span><span class="w">                                           </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">latticeXSize</span><span class="p">,</span>
<span class="linenos"> 304</span><span class="w">                                           </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">latticeYSize</span><span class="p">,</span>
<span class="linenos"> 305</span><span class="w">                                           </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">latticeZSize</span><span class="p">,</span>
<span class="linenos"> 306</span><span class="w">                                           </span><span class="n">site_size_t</span><span class="w"> </span><span class="n">particlesPerSite</span><span class="p">,</span>
<span class="linenos"> 307</span><span class="w">                                           </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">bytes_per_particle</span><span class="p">,</span>
<span class="linenos"> 308</span><span class="w">                                           </span><span class="n">si_dist_t</span><span class="w"> </span><span class="n">latticeSpacing</span><span class="p">,</span>
<span class="linenos"> 309</span><span class="w">                                           </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="o">*</span><span class="w"> </span><span class="n">latticeData</span><span class="p">,</span>
<span class="linenos"> 310</span><span class="w">                                           </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="o">*</span><span class="w"> </span><span class="n">latticeSitesData</span><span class="p">,</span>
<span class="linenos"> 311</span><span class="w">                                           </span><span class="kt">bool</span><span class="w"> </span><span class="n">rowMajorData</span><span class="p">)</span>
<span class="linenos"> 312</span><span class="p">{</span>
<span class="linenos"> 313</span><span class="w">    </span><span class="n">RDMESolver</span><span class="o">::</span><span class="n">buildDiffusionModel</span><span class="p">(</span><span class="n">numberSiteTypesA</span><span class="p">,</span><span class="w"> </span><span class="n">DFA</span><span class="p">,</span><span class="w"> </span><span class="n">RLA</span><span class="p">,</span>
<span class="linenos"> 314</span><span class="w">                                    </span><span class="n">latticeXSize</span><span class="p">,</span><span class="w"> </span><span class="n">latticeYSize</span><span class="p">,</span><span class="w"> </span><span class="n">latticeZSize</span><span class="p">,</span>
<span class="linenos"> 315</span><span class="w">                                    </span><span class="n">particlesPerSite</span><span class="p">,</span><span class="w"> </span><span class="n">bytes_per_particle</span><span class="p">,</span>
<span class="linenos"> 316</span><span class="w">                                    </span><span class="n">latticeSpacing</span><span class="p">,</span><span class="w"> </span><span class="n">latticeData</span><span class="p">,</span><span class="w"> </span><span class="n">latticeSitesData</span><span class="p">,</span>
<span class="linenos"> 317</span><span class="w">                                    </span><span class="n">rowMajorData</span><span class="p">);</span>
<span class="linenos"> 318</span>
<span class="linenos"> 319</span><span class="w">    </span><span class="c1">// Get the time step.</span>
<span class="linenos"> 320</span><span class="w">    </span><span class="n">tau</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">atof</span><span class="p">((</span><span class="o">*</span><span class="n">parameters</span><span class="p">)[</span><span class="s">&quot;timestep&quot;</span><span class="p">].</span><span class="n">c_str</span><span class="p">());</span>
<span class="linenos"> 321</span>
<span class="linenos"> 322</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tau</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">)</span>
<span class="linenos"> 323</span><span class="w">    </span><span class="p">{</span>
<span class="linenos"> 324</span><span class="w">        </span><span class="n">throw</span><span class="w"> </span><span class="n">InvalidArgException</span><span class="p">(</span><span class="s">&quot;timestep&quot;</span><span class="p">,</span>
<span class="linenos"> 325</span><span class="w">                                  </span><span class="s">&quot;A positive timestep must be specified for the solver.&quot;</span><span class="p">);</span>
<span class="linenos"> 326</span><span class="w">    </span><span class="p">}</span>
<span class="linenos"> 327</span>
<span class="linenos"> 328</span><span class="w">    </span><span class="c1">// Setup the cuda transition matrix.</span>
<span class="linenos"> 329</span><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">DFmatrixSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">numberSpecies</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">numberSiteTypes</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">numberSiteTypes</span><span class="p">;</span>
<span class="linenos"> 330</span>
<span class="linenos"> 331</span><span class="cp">#ifndef MPD_GLOBAL_T_MATRIX</span>
<span class="linenos"> 332</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">DFmatrixSize</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">MPD_MAX_TRANSITION_TABLE_ENTRIES</span><span class="p">)</span>
<span class="linenos"> 333</span><span class="w">    </span><span class="p">{</span>
<span class="linenos"> 334</span><span class="w">        </span><span class="n">throw</span><span class="w"> </span><span class="n">Exception</span><span class="p">(</span><span class="s">&quot;The number of transition table entries exceeds the maximum supported by the solver.&quot;</span><span class="p">);</span>
<span class="linenos"> 335</span><span class="w">    </span><span class="p">}</span>
<span class="linenos"> 336</span><span class="cp">#endif</span>
<span class="linenos"> 337</span>
<span class="linenos"> 338</span><span class="cp">#ifndef MPD_GLOBAL_S_MATRIX</span>
<span class="linenos"> 339</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">numberReactions</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">numberSiteTypes</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">MPD_MAX_RL_MATRIX_ENTRIES</span><span class="p">)</span>
<span class="linenos"> 340</span><span class="w">    </span><span class="p">{</span>
<span class="linenos"> 341</span><span class="w">        </span><span class="n">throw</span><span class="w"> </span><span class="n">Exception</span><span class="p">(</span><span class="s">&quot;The number of RL matrix entries exceeds the maximum supported by the solver.&quot;</span><span class="p">);</span>
<span class="linenos"> 342</span><span class="w">    </span><span class="p">}</span>
<span class="linenos"> 343</span><span class="cp">#endif</span>
<span class="linenos"> 344</span>
<span class="linenos"> 345</span><span class="w">    </span><span class="c1">// Calculate the probability from the diffusion coefficient and the lattice properties.</span>
<span class="linenos"> 346</span><span class="w">    </span><span class="cm">/*</span>
<span class="linenos"> 347</span><span class="cm">     * p0 = probability of staying at the site, q = probability of moving in plus or minus direction</span>
<span class="linenos"> 348</span><span class="cm">     *</span>
<span class="linenos"> 349</span><span class="cm">     * D=(1-p0)*lambda^2/2*tau</span>
<span class="linenos"> 350</span><span class="cm">     * q=(1-p0)/2</span>
<span class="linenos"> 351</span><span class="cm">     * D=2q*lambda^2/2*tau</span>
<span class="linenos"> 352</span><span class="cm">     * q=D*tau/lambda^2</span>
<span class="linenos"> 353</span><span class="cm">     */</span>
<span class="linenos"> 354</span><span class="w">    </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="kt">float</span><span class="p">[</span><span class="n">DFmatrixSize</span><span class="p">];</span>
<span class="linenos"> 355</span>
<span class="linenos"> 356</span><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">DFmatrixSize</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="linenos"> 357</span><span class="w">    </span><span class="p">{</span>
<span class="linenos"> 358</span><span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">q</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">DF</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">tau</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">pow</span><span class="p">(</span><span class="n">latticeSpacing</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">));</span>
<span class="linenos"> 359</span>
<span class="linenos"> 360</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">q</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0.50f</span><span class="p">)</span>
<span class="linenos"> 361</span><span class="w">        </span><span class="p">{</span>
<span class="linenos"> 362</span><span class="w">            </span><span class="n">throw</span><span class="w"> </span><span class="n">InvalidArgException</span><span class="p">(</span><span class="s">&quot;D&quot;</span><span class="p">,</span>
<span class="linenos"> 363</span><span class="w">                                      </span><span class="s">&quot;The specified diffusion coefficient is too high for the diffusion model.&quot;</span><span class="p">);</span>
<span class="linenos"> 364</span><span class="w">        </span><span class="p">}</span>
<span class="linenos"> 365</span>
<span class="linenos"> 366</span><span class="w">        </span><span class="n">T</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">q</span><span class="p">;</span>
<span class="linenos"> 367</span><span class="w">    </span><span class="p">}</span>
<span class="linenos"> 368</span>
<span class="linenos"> 369</span><span class="w">    </span><span class="c1">// Setup the cuda reaction location matrix.</span>
<span class="linenos"> 370</span><span class="w">    </span><span class="kt">uint8_t</span><span class="o">*</span><span class="w"> </span><span class="n">tmpRL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="kt">uint8_t</span><span class="p">[</span><span class="n">numberReactions</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">numberSiteTypes</span><span class="p">];</span>
<span class="linenos"> 371</span>
<span class="linenos"> 372</span><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">numberReactions</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">numberSiteTypes</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="linenos"> 373</span><span class="w">    </span><span class="p">{</span>
<span class="linenos"> 374</span><span class="w">    	</span><span class="n">tmpRL</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">RL</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="linenos"> 375</span><span class="w">    </span><span class="p">}</span>
<span class="linenos"> 376</span>
<span class="linenos"> 377</span><span class="cp">#ifdef MPD_GLOBAL_T_MATRIX</span>
<span class="linenos"> 378</span><span class="w">	</span><span class="n">cudaMalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">TG</span><span class="p">,</span><span class="w"> </span><span class="n">DFmatrixSize</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">));</span>
<span class="linenos"> 379</span><span class="w">	</span><span class="n">cudaMemcpy</span><span class="p">(</span><span class="n">TG</span><span class="p">,</span><span class="w"> </span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">DFmatrixSize</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">),</span><span class="w"> </span><span class="n">cudaMemcpyHostToDevice</span><span class="p">);</span>
<span class="linenos"> 380</span><span class="w">    </span><span class="n">cudaMemcpyToSymbol</span><span class="p">(</span><span class="n">TC</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">TG</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="o">*</span><span class="p">));</span>
<span class="linenos"> 381</span><span class="cp">#else</span>
<span class="linenos"> 382</span><span class="w">    </span><span class="n">cudaMemcpyToSymbol</span><span class="p">(</span><span class="n">TC</span><span class="p">,</span><span class="w"> </span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">DFmatrixSize</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">));</span>
<span class="linenos"> 383</span><span class="cp">#endif</span>
<span class="linenos"> 384</span>
<span class="linenos"> 385</span><span class="w">    </span><span class="n">cudaMemcpyToSymbol</span><span class="p">(</span><span class="n">numberSpeciesC</span><span class="p">,</span><span class="w">   </span><span class="o">&amp;</span><span class="n">numberSpecies</span><span class="p">,</span><span class="w">   </span><span class="k">sizeof</span><span class="p">(</span><span class="n">numberSpeciesC</span><span class="p">));</span>
<span class="linenos"> 386</span><span class="w">    </span><span class="n">cudaMemcpyToSymbol</span><span class="p">(</span><span class="n">numberSiteTypesC</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">numberSiteTypes</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">numberSiteTypesC</span><span class="p">));</span>
<span class="linenos"> 387</span>
<span class="linenos"> 388</span><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeXYSize</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">latticeXSize</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">latticeYSize</span><span class="p">;</span>
<span class="linenos"> 389</span><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeXYZSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">latticeXSize</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">latticeYSize</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">latticeZSize</span><span class="p">;</span>
<span class="linenos"> 390</span>
<span class="linenos"> 391</span><span class="w">    </span><span class="n">cudaMemcpyToSymbol</span><span class="p">(</span><span class="n">latticeXSizeC</span><span class="p">,</span><span class="w">   </span><span class="o">&amp;</span><span class="n">latticeXSize</span><span class="p">,</span><span class="w">   </span><span class="k">sizeof</span><span class="p">(</span><span class="n">latticeXSizeC</span><span class="p">));</span>
<span class="linenos"> 392</span><span class="w">    </span><span class="n">cudaMemcpyToSymbol</span><span class="p">(</span><span class="n">latticeYSizeC</span><span class="p">,</span><span class="w">   </span><span class="o">&amp;</span><span class="n">latticeYSize</span><span class="p">,</span><span class="w">   </span><span class="k">sizeof</span><span class="p">(</span><span class="n">latticeYSizeC</span><span class="p">));</span>
<span class="linenos"> 393</span><span class="w">    </span><span class="n">cudaMemcpyToSymbol</span><span class="p">(</span><span class="n">latticeZSizeC</span><span class="p">,</span><span class="w">   </span><span class="o">&amp;</span><span class="n">latticeZSize</span><span class="p">,</span><span class="w">   </span><span class="k">sizeof</span><span class="p">(</span><span class="n">latticeZSizeC</span><span class="p">));</span>
<span class="linenos"> 394</span><span class="w">    </span><span class="n">cudaMemcpyToSymbol</span><span class="p">(</span><span class="n">latticeXYSizeC</span><span class="p">,</span><span class="w">  </span><span class="o">&amp;</span><span class="n">latticeXYSize</span><span class="p">,</span><span class="w">  </span><span class="k">sizeof</span><span class="p">(</span><span class="n">latticeXYSizeC</span><span class="p">));</span>
<span class="linenos"> 395</span><span class="w">    </span><span class="n">cudaMemcpyToSymbol</span><span class="p">(</span><span class="n">latticeXYZSizeC</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">latticeXYZSize</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">latticeXYZSizeC</span><span class="p">));</span>
<span class="linenos"> 396</span>
<span class="linenos"> 397</span><span class="w">    </span><span class="n">cudaMemcpyToSymbol</span><span class="p">(</span><span class="n">global_latticeZSizeC</span><span class="p">,</span><span class="w">   </span><span class="o">&amp;</span><span class="n">latticeZSize</span><span class="p">,</span><span class="w">   </span><span class="k">sizeof</span><span class="p">(</span><span class="n">global_latticeZSizeC</span><span class="p">));</span>
<span class="linenos"> 398</span><span class="w">    </span><span class="n">cudaMemcpyToSymbol</span><span class="p">(</span><span class="n">global_latticeXYZSizeC</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">latticeXYZSize</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">global_latticeXYZSizeC</span><span class="p">));</span>
<span class="linenos"> 399</span>
<span class="linenos"> 400</span><span class="cp">#ifdef MPD_GLOBAL_S_MATRIX</span>
<span class="linenos"> 401</span><span class="w">	</span><span class="c1">// RL in global memory</span>
<span class="linenos"> 402</span><span class="w">	</span><span class="n">cudaMalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">RLG</span><span class="p">,</span><span class="w"> </span><span class="n">numberReactions</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">numberSiteTypes</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">uint8_t</span><span class="p">));</span>
<span class="linenos"> 403</span><span class="w">	</span><span class="n">cudaMemcpy</span><span class="p">(</span><span class="n">RLG</span><span class="p">,</span><span class="w"> </span><span class="n">tmpRL</span><span class="p">,</span><span class="w"> </span><span class="n">numberReactions</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">numberSiteTypes</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">uint8_t</span><span class="p">),</span><span class="w"> </span><span class="n">cudaMemcpyHostToDevice</span><span class="p">);</span>
<span class="linenos"> 404</span><span class="cp">#else</span>
<span class="linenos"> 405</span><span class="w">	</span><span class="c1">// RL in constant memory</span>
<span class="linenos"> 406</span><span class="w">    </span><span class="n">cudaMemcpyToSymbol</span><span class="p">(</span><span class="n">RLC</span><span class="p">,</span><span class="w"> </span><span class="n">tmpRL</span><span class="p">,</span><span class="w"> </span><span class="n">numberReactions</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">numberSiteTypes</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">uint8_t</span><span class="p">));</span>
<span class="linenos"> 407</span><span class="cp">#endif</span>
<span class="linenos"> 408</span>
<span class="linenos"> 409</span><span class="w">    </span><span class="n">delete</span><span class="p">[]</span><span class="w"> </span><span class="n">tmpRL</span><span class="p">;</span>
<span class="linenos"> 410</span><span class="w">    </span><span class="n">delete</span><span class="p">[]</span><span class="w"> </span><span class="n">T</span><span class="p">;</span>
<span class="linenos"> 411</span>
<span class="linenos"> 412</span><span class="w">    </span><span class="c1">// Set the cuda reaction model rates now that we have the subvolume size.</span>
<span class="linenos"> 413</span><span class="w">    </span><span class="n">model_reactionRates</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="kt">float</span><span class="p">[</span><span class="n">numberReactions</span><span class="p">];</span>
<span class="linenos"> 414</span>
<span class="linenos"> 415</span><span class="w">    </span><span class="c1">// Set up pre-configured propensity matrices</span>
<span class="linenos"> 416</span><span class="w">	</span><span class="n">zeroOrderSize</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">numberSiteTypes</span><span class="p">;</span>
<span class="linenos"> 417</span><span class="w">	</span><span class="n">firstOrderSize</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">numberSiteTypes</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">numberSpecies</span><span class="p">;</span>
<span class="linenos"> 418</span><span class="w">	</span><span class="n">secondOrderSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">numberSiteTypes</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">numberSpecies</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">numberSpecies</span><span class="p">;</span>
<span class="linenos"> 419</span>
<span class="linenos"> 420</span><span class="w">	</span><span class="n">zeroOrder</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="kt">float</span><span class="p">[</span><span class="n">zeroOrderSize</span><span class="p">];</span>
<span class="linenos"> 421</span><span class="w">	</span><span class="n">firstOrder</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="kt">float</span><span class="p">[</span><span class="n">firstOrderSize</span><span class="p">];</span>
<span class="linenos"> 422</span><span class="w">	</span><span class="n">secondOrder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="kt">float</span><span class="p">[</span><span class="n">secondOrderSize</span><span class="p">];</span>
<span class="linenos"> 423</span>
<span class="linenos"> 424</span><span class="cp">#ifdef MPD_GLOBAL_R_MATRIX</span>
<span class="linenos"> 425</span><span class="w">    </span><span class="n">cudaMalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reactionRatesG</span><span class="p">,</span><span class="w"> </span><span class="n">numberReactions</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">));</span>
<span class="linenos"> 426</span><span class="cp">#endif</span>
<span class="linenos"> 427</span><span class="w">		</span>
<span class="linenos"> 428</span><span class="w">	</span><span class="n">cudaMalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">propZeroOrder</span><span class="p">,</span><span class="w">   </span><span class="n">zeroOrderSize</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">));</span>
<span class="linenos"> 429</span><span class="w">	</span><span class="n">cudaMalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">propFirstOrder</span><span class="p">,</span><span class="w">  </span><span class="n">firstOrderSize</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">));</span>
<span class="linenos"> 430</span><span class="w">	</span><span class="n">cudaMalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">propSecondOrder</span><span class="p">,</span><span class="w"> </span><span class="n">secondOrderSize</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">));</span>
<span class="linenos"> 431</span>
<span class="linenos"> 432</span><span class="w">    </span><span class="n">computePropensities</span><span class="p">();</span>
<span class="linenos"> 433</span><span class="w">    </span><span class="n">copyModelsToDevice</span><span class="p">();</span>
<span class="linenos"> 434</span><span class="w">	</span><span class="n">reactionModelModified</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="linenos"> 435</span><span class="p">}</span>
<span class="linenos"> 436</span>
<span class="linenos"> 437</span><span class="kt">void</span><span class="w"> </span><span class="n">IntMpdRdmeSolver</span><span class="o">::</span><span class="n">setLatticeData</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="o">*</span><span class="w"> </span><span class="n">latticeData</span><span class="p">)</span>
<span class="linenos"> 438</span><span class="p">{</span>
<span class="linenos"> 439</span><span class="w">	</span><span class="n">lattice_coord_t</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getSize</span><span class="p">();</span>
<span class="linenos"> 440</span><span class="w">	</span><span class="n">site_size_t</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getMaxOccupancy</span><span class="p">();</span>
<span class="linenos"> 441</span>
<span class="linenos"> 442</span><span class="w">	</span><span class="c1">// reinterpret the input as a 32-bit array</span>
<span class="linenos"> 443</span><span class="w">	</span><span class="kt">uint32_t</span><span class="w"> </span><span class="o">*</span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uint32_t</span><span class="o">*</span><span class="p">)</span><span class="n">latticeData</span><span class="p">;</span>
<span class="linenos"> 444</span>
<span class="linenos"> 445</span><span class="w">	</span><span class="c1">// Set the lattice data.</span>
<span class="linenos"> 446</span><span class="w">	</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">index</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">s</span><span class="p">.</span><span class="n">x</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="linenos"> 447</span><span class="w">	</span><span class="p">{</span>
<span class="linenos"> 448</span><span class="w">		</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">&lt;</span><span class="n">s</span><span class="p">.</span><span class="n">y</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">++</span><span class="p">)</span>
<span class="linenos"> 449</span><span class="w">		</span><span class="p">{</span>
<span class="linenos"> 450</span><span class="w">			</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">k</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">k</span><span class="o">&lt;</span><span class="n">s</span><span class="p">.</span><span class="n">z</span><span class="p">;</span><span class="w"> </span><span class="n">k</span><span class="o">++</span><span class="p">)</span>
<span class="linenos"> 451</span><span class="w">			</span><span class="p">{</span>
<span class="linenos"> 452</span><span class="w">				</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">l</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">l</span><span class="o">&lt;</span><span class="n">p</span><span class="p">;</span><span class="w"> </span><span class="n">l</span><span class="o">++</span><span class="p">,</span><span class="w"> </span><span class="n">index</span><span class="o">++</span><span class="p">)</span>
<span class="linenos"> 453</span><span class="w">				</span><span class="p">{</span>
<span class="linenos"> 454</span><span class="w">					</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="linenos"> 455</span><span class="w">					</span><span class="p">{</span>
<span class="linenos"> 456</span><span class="w">						</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">numberSpecies</span><span class="p">)</span><span class="w"> </span><span class="n">throw</span><span class="w"> </span><span class="n">InvalidArgException</span><span class="p">(</span><span class="s">&quot;latticeData&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;an invalid species was found&quot;</span><span class="p">,</span><span class="n">data</span><span class="p">[</span><span class="n">index</span><span class="p">]);</span>
<span class="linenos"> 457</span><span class="w">						</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">addParticle</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">data</span><span class="p">[</span><span class="n">index</span><span class="p">]);</span>
<span class="linenos"> 458</span><span class="w">					</span><span class="p">}</span>
<span class="linenos"> 459</span><span class="w">				</span><span class="p">}</span>
<span class="linenos"> 460</span><span class="w">			</span><span class="p">}</span>
<span class="linenos"> 461</span><span class="w">		</span><span class="p">}</span>
<span class="linenos"> 462</span><span class="w">	</span><span class="p">}</span>
<span class="linenos"> 463</span><span class="p">}</span>
<span class="linenos"> 464</span>
<span class="linenos"> 465</span><span class="kt">void</span><span class="w"> </span><span class="n">IntMpdRdmeSolver</span><span class="o">::</span><span class="n">setReactionRate</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">rxid</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">rate</span><span class="p">)</span>
<span class="linenos"> 466</span><span class="p">{</span>
<span class="linenos"> 467</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">reactionTypes</span><span class="p">[</span><span class="n">rxid</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w">  </span><span class="n">ZerothOrderPropensityArgs</span><span class="o">::</span><span class="n">REACTION_TYPE</span><span class="p">)</span>
<span class="linenos"> 468</span><span class="w">	</span><span class="p">{</span>
<span class="linenos"> 469</span><span class="w">		</span><span class="p">((</span><span class="n">ZerothOrderPropensityArgs</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">propensityFunctionArgs</span><span class="p">[</span><span class="n">rxid</span><span class="p">])</span><span class="o">-&gt;</span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rate</span><span class="p">;</span>
<span class="linenos"> 470</span><span class="w">	</span><span class="p">}</span>
<span class="linenos"> 471</span><span class="w">	</span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">reactionTypes</span><span class="p">[</span><span class="n">rxid</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">FirstOrderPropensityArgs</span><span class="o">::</span><span class="n">REACTION_TYPE</span><span class="p">)</span>
<span class="linenos"> 472</span><span class="w">	</span><span class="p">{</span>
<span class="linenos"> 473</span><span class="w">		</span><span class="p">((</span><span class="n">FirstOrderPropensityArgs</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">propensityFunctionArgs</span><span class="p">[</span><span class="n">rxid</span><span class="p">])</span><span class="o">-&gt;</span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rate</span><span class="p">;</span>
<span class="linenos"> 474</span><span class="w">	</span><span class="p">}</span>
<span class="linenos"> 475</span><span class="w">	</span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">reactionTypes</span><span class="p">[</span><span class="n">rxid</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">SecondOrderPropensityArgs</span><span class="o">::</span><span class="n">REACTION_TYPE</span><span class="p">)</span>
<span class="linenos"> 476</span><span class="w">	</span><span class="p">{</span>
<span class="linenos"> 477</span><span class="w">		</span><span class="p">((</span><span class="n">SecondOrderPropensityArgs</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">propensityFunctionArgs</span><span class="p">[</span><span class="n">rxid</span><span class="p">])</span><span class="o">-&gt;</span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rate</span><span class="p">;</span>
<span class="linenos"> 478</span><span class="w">	</span><span class="p">}</span>
<span class="linenos"> 479</span><span class="w">	</span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">reactionTypes</span><span class="p">[</span><span class="n">rxid</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">SecondOrderSelfPropensityArgs</span><span class="o">::</span><span class="n">REACTION_TYPE</span><span class="p">)</span>
<span class="linenos"> 480</span><span class="w">	</span><span class="p">{</span>
<span class="linenos"> 481</span><span class="w">		</span><span class="p">((</span><span class="n">SecondOrderSelfPropensityArgs</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">propensityFunctionArgs</span><span class="p">[</span><span class="n">rxid</span><span class="p">])</span><span class="o">-&gt;</span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rate</span><span class="p">;</span>
<span class="linenos"> 482</span><span class="w">	</span><span class="p">}</span>
<span class="linenos"> 483</span><span class="w">    </span><span class="k">else</span>
<span class="linenos"> 484</span><span class="w">    </span><span class="p">{</span>
<span class="linenos"> 485</span><span class="w">    	</span><span class="n">throw</span><span class="w"> </span><span class="n">InvalidArgException</span><span class="p">(</span><span class="s">&quot;reactionTypeA&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;the reaction type was not supported by the solver&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">reactionTypes</span><span class="p">[</span><span class="n">rxid</span><span class="p">]);</span>
<span class="linenos"> 486</span><span class="w">    </span><span class="p">}</span>
<span class="linenos"> 487</span>
<span class="linenos"> 488</span><span class="w">	</span><span class="c1">// Flag to trigger re-computation of rdme propensities</span>
<span class="linenos"> 489</span><span class="w">	</span><span class="n">reactionModelModified</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="linenos"> 490</span><span class="p">}</span>
<span class="linenos"> 491</span>
<span class="linenos"> 492</span><span class="kt">void</span><span class="w"> </span><span class="n">IntMpdRdmeSolver</span><span class="o">::</span><span class="n">computePropensities</span><span class="p">()</span>
<span class="linenos"> 493</span><span class="p">{</span>
<span class="linenos"> 494</span><span class="w">	</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeXSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getXSize</span><span class="p">();</span>
<span class="linenos"> 495</span><span class="w">	</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeYSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getYSize</span><span class="p">();</span>
<span class="linenos"> 496</span><span class="w">	</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeZSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getZSize</span><span class="p">();</span>
<span class="linenos"> 497</span><span class="w">    </span>
<span class="linenos"> 498</span><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">numberReactions</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="linenos"> 499</span><span class="w">    </span><span class="p">{</span>
<span class="linenos"> 500</span><span class="w">    	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">reactionTypes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ZerothOrderPropensityArgs</span><span class="o">::</span><span class="n">REACTION_TYPE</span><span class="p">)</span>
<span class="linenos"> 501</span><span class="w">    	</span><span class="p">{</span>
<span class="linenos"> 502</span><span class="w">    	    </span><span class="n">model_reactionRates</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="n">ZerothOrderPropensityArgs</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">propensityFunctionArgs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">-&gt;</span><span class="n">k</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">tau</span><span class="w"> </span><span class="o">/</span>
<span class="linenos"> 503</span><span class="w">                                     </span><span class="p">(</span><span class="n">latticeXSize</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">latticeYSize</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">latticeZSize</span><span class="p">);</span>
<span class="linenos"> 504</span><span class="w">    	</span><span class="p">}</span>
<span class="linenos"> 505</span><span class="w">    	</span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">reactionTypes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">FirstOrderPropensityArgs</span><span class="o">::</span><span class="n">REACTION_TYPE</span><span class="p">)</span>
<span class="linenos"> 506</span><span class="w">    	</span><span class="p">{</span>
<span class="linenos"> 507</span><span class="w">    		</span><span class="n">model_reactionRates</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="n">FirstOrderPropensityArgs</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">propensityFunctionArgs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">-&gt;</span><span class="n">k</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">tau</span><span class="p">;</span>
<span class="linenos"> 508</span><span class="w">    	</span><span class="p">}</span>
<span class="linenos"> 509</span><span class="w">    	</span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">reactionTypes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">SecondOrderPropensityArgs</span><span class="o">::</span><span class="n">REACTION_TYPE</span><span class="p">)</span>
<span class="linenos"> 510</span><span class="w">    	</span><span class="p">{</span>
<span class="linenos"> 511</span><span class="w">    		</span><span class="n">model_reactionRates</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="n">SecondOrderPropensityArgs</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">propensityFunctionArgs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">-&gt;</span><span class="n">k</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">tau</span><span class="w"> </span><span class="o">*</span>
<span class="linenos"> 512</span><span class="w">                                     </span><span class="n">latticeXSize</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">latticeYSize</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">latticeZSize</span><span class="p">;</span>
<span class="linenos"> 513</span><span class="w">    	</span><span class="p">}</span>
<span class="linenos"> 514</span><span class="w">    	</span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">reactionTypes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">SecondOrderSelfPropensityArgs</span><span class="o">::</span><span class="n">REACTION_TYPE</span><span class="p">)</span>
<span class="linenos"> 515</span><span class="w">    	</span><span class="p">{</span>
<span class="linenos"> 516</span><span class="w">    		</span><span class="n">model_reactionRates</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="n">SecondOrderSelfPropensityArgs</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">propensityFunctionArgs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">-&gt;</span><span class="n">k</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">tau</span><span class="w"> </span><span class="o">*</span>
<span class="linenos"> 517</span><span class="w">                                     </span><span class="n">latticeXSize</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">latticeYSize</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">latticeZSize</span><span class="p">;</span>
<span class="linenos"> 518</span><span class="w">    	</span><span class="p">}</span>
<span class="linenos"> 519</span><span class="w">    	</span><span class="k">else</span>
<span class="linenos"> 520</span><span class="w">    	</span><span class="p">{</span>
<span class="linenos"> 521</span><span class="w">    		</span><span class="n">throw</span><span class="w"> </span><span class="n">InvalidArgException</span><span class="p">(</span><span class="s">&quot;reactionTypeA&quot;</span><span class="p">,</span>
<span class="linenos"> 522</span><span class="w">                                      </span><span class="s">&quot;the reaction type was not supported by the solver&quot;</span><span class="p">,</span>
<span class="linenos"> 523</span><span class="w">                                      </span><span class="n">reactionTypes</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="linenos"> 524</span><span class="w">    	</span><span class="p">}</span>
<span class="linenos"> 525</span><span class="w">    </span><span class="p">}</span>
<span class="linenos"> 526</span>
<span class="linenos"> 527</span><span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">scale</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">latticeXSize</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">latticeYSize</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">latticeZSize</span><span class="p">;</span>
<span class="linenos"> 528</span>
<span class="linenos"> 529</span><span class="w">	</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">site</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">site</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">numberSiteTypes</span><span class="p">;</span><span class="w"> </span><span class="n">site</span><span class="o">++</span><span class="p">)</span>
<span class="linenos"> 530</span><span class="w">	</span><span class="p">{</span>
<span class="linenos"> 531</span><span class="w">		</span><span class="n">uint</span><span class="w"> </span><span class="n">o1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">site</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">numberSpecies</span><span class="p">;</span>
<span class="linenos"> 532</span><span class="w">		</span><span class="n">uint</span><span class="w"> </span><span class="n">o2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">site</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">numberSpecies</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">numberSpecies</span><span class="p">;</span>
<span class="linenos"> 533</span>
<span class="linenos"> 534</span><span class="w">		</span><span class="n">zeroOrder</span><span class="p">[</span><span class="n">site</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">;</span>
<span class="linenos"> 535</span>
<span class="linenos"> 536</span><span class="w">		</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">numberSpecies</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="linenos"> 537</span><span class="w">		</span><span class="p">{</span>
<span class="linenos"> 538</span><span class="w">			</span><span class="n">firstOrder</span><span class="p">[</span><span class="n">o1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">;</span>
<span class="linenos"> 539</span>
<span class="linenos"> 540</span><span class="w">			</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">numberSpecies</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">++</span><span class="p">)</span>
<span class="linenos"> 541</span><span class="w">				</span><span class="n">secondOrder</span><span class="p">[</span><span class="n">o2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">numberSpecies</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">;</span><span class="w">	</span>
<span class="linenos"> 542</span><span class="w">		</span><span class="p">}</span>
<span class="linenos"> 543</span>
<span class="linenos"> 544</span><span class="w">		</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">numberReactions</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="linenos"> 545</span><span class="w">		</span><span class="p">{</span>
<span class="linenos"> 546</span><span class="w">			</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">RL</span><span class="p">[(</span><span class="n">i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">numberSiteTypes</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">site</span><span class="p">])</span><span class="w"> </span><span class="p">{</span><span class="k">continue</span><span class="p">;}</span>
<span class="linenos"> 547</span>
<span class="linenos"> 548</span><span class="w">			</span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">reactionTypes</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
<span class="linenos"> 549</span><span class="w">			</span><span class="p">{</span>
<span class="linenos"> 550</span><span class="w">				</span><span class="k">case</span><span class="w"> </span><span class="no">ZerothOrderPropensityArgs</span><span class="o">::</span><span class="no">REACTION_TYPE</span><span class="p">:</span>
<span class="linenos"> 551</span><span class="w">                </span><span class="p">{</span>
<span class="linenos"> 552</span><span class="w">				    </span><span class="n">ZerothOrderPropensityArgs</span><span class="o">*</span><span class="w"> </span><span class="n">rx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">ZerothOrderPropensityArgs</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">propensityFunctionArgs</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="linenos"> 553</span><span class="w">				    </span><span class="n">zeroOrder</span><span class="p">[</span><span class="n">site</span><span class="p">]</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">k</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">tau</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">scale</span><span class="p">;</span>
<span class="linenos"> 554</span><span class="w">                    </span><span class="k">break</span><span class="p">;</span>
<span class="linenos"> 555</span><span class="w">                </span><span class="p">}</span>
<span class="linenos"> 556</span><span class="w">				</span><span class="k">case</span><span class="w"> </span><span class="no">FirstOrderPropensityArgs</span><span class="o">::</span><span class="no">REACTION_TYPE</span><span class="p">:</span>
<span class="linenos"> 557</span><span class="w">                </span><span class="p">{</span>
<span class="linenos"> 558</span><span class="w">				    </span><span class="n">FirstOrderPropensityArgs</span><span class="o">*</span><span class="w"> </span><span class="n">rx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">FirstOrderPropensityArgs</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">propensityFunctionArgs</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="linenos"> 559</span><span class="w">				    </span><span class="n">firstOrder</span><span class="p">[</span><span class="n">o1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">si</span><span class="p">]</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">k</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">tau</span><span class="p">;</span>
<span class="linenos"> 560</span><span class="w">                    </span><span class="k">break</span><span class="p">;</span>
<span class="linenos"> 561</span><span class="w">                </span><span class="p">}</span>
<span class="linenos"> 562</span><span class="w">				</span><span class="k">case</span><span class="w"> </span><span class="no">SecondOrderPropensityArgs</span><span class="o">::</span><span class="no">REACTION_TYPE</span><span class="p">:</span>
<span class="linenos"> 563</span><span class="w">                </span><span class="p">{</span>
<span class="linenos"> 564</span><span class="w">				    </span><span class="n">SecondOrderPropensityArgs</span><span class="o">*</span><span class="w"> </span><span class="n">rx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">SecondOrderPropensityArgs</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">propensityFunctionArgs</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="linenos"> 565</span><span class="w">				    </span><span class="n">secondOrder</span><span class="p">[</span><span class="n">o2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">s1i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">numberSpecies</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">s2i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">k</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">tau</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">scale</span><span class="p">;</span>
<span class="linenos"> 566</span><span class="w">				    </span><span class="n">secondOrder</span><span class="p">[</span><span class="n">o2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">s2i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">numberSpecies</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">s1i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">k</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">tau</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">scale</span><span class="p">;</span>
<span class="linenos"> 567</span><span class="w">                    </span><span class="k">break</span><span class="p">;</span>
<span class="linenos"> 568</span><span class="w">                </span><span class="p">}</span>
<span class="linenos"> 569</span><span class="w">				</span><span class="k">case</span><span class="w"> </span><span class="no">SecondOrderSelfPropensityArgs</span><span class="o">::</span><span class="no">REACTION_TYPE</span><span class="p">:</span>
<span class="linenos"> 570</span><span class="w">                </span><span class="p">{</span>
<span class="linenos"> 571</span><span class="w">				    </span><span class="n">SecondOrderSelfPropensityArgs</span><span class="o">*</span><span class="w"> </span><span class="n">rx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">SecondOrderSelfPropensityArgs</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">propensityFunctionArgs</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="linenos"> 572</span><span class="w">				    </span><span class="n">secondOrder</span><span class="p">[</span><span class="n">o2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">si</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">numberSpecies</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">si</span><span class="p">]</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">k</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">tau</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">scale</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<span class="linenos"> 573</span><span class="w">                </span><span class="p">}</span>
<span class="linenos"> 574</span><span class="w">			</span><span class="p">}</span>
<span class="linenos"> 575</span><span class="w">		</span><span class="p">}</span>
<span class="linenos"> 576</span><span class="w">	</span><span class="p">}</span>
<span class="linenos"> 577</span><span class="p">}</span>
<span class="linenos"> 578</span>
<span class="linenos"> 579</span><span class="kt">void</span><span class="w"> </span><span class="n">IntMpdRdmeSolver</span><span class="o">::</span><span class="n">copyModelsToDevice</span><span class="p">()</span>
<span class="linenos"> 580</span><span class="p">{</span>
<span class="linenos"> 581</span><span class="cp">#ifdef MPD_GLOBAL_R_MATRIX</span>
<span class="linenos"> 582</span><span class="w">    </span><span class="n">cudaMemcpy</span><span class="p">(</span><span class="n">reactionRatesG</span><span class="p">,</span><span class="w"> </span><span class="n">model_reactionRates</span><span class="p">,</span><span class="w"> </span><span class="n">numberReactions</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">),</span><span class="w"> </span><span class="n">cudaMemcpyHostToDevice</span><span class="p">);</span>
<span class="linenos"> 583</span><span class="cp">#else</span>
<span class="linenos"> 584</span><span class="w">    </span><span class="n">cudaMemcpyToSymbol</span><span class="p">(</span><span class="n">reactionRatesC</span><span class="p">,</span><span class="w"> </span><span class="n">model_reactionRates</span><span class="p">,</span><span class="w"> </span><span class="n">numberReactions</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">));</span>
<span class="linenos"> 585</span><span class="cp">#endif</span>
<span class="linenos"> 586</span>
<span class="linenos"> 587</span><span class="w">	</span><span class="n">cudaMemcpy</span><span class="p">(</span><span class="n">propZeroOrder</span><span class="p">,</span><span class="w">   </span><span class="n">zeroOrder</span><span class="p">,</span><span class="w">   </span><span class="n">zeroOrderSize</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">),</span><span class="w">   </span><span class="n">cudaMemcpyHostToDevice</span><span class="p">);</span>
<span class="linenos"> 588</span><span class="w">	</span><span class="n">cudaMemcpy</span><span class="p">(</span><span class="n">propFirstOrder</span><span class="p">,</span><span class="w">  </span><span class="n">firstOrder</span><span class="p">,</span><span class="w">  </span><span class="n">firstOrderSize</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">),</span><span class="w">  </span><span class="n">cudaMemcpyHostToDevice</span><span class="p">);</span>
<span class="linenos"> 589</span><span class="w">	</span><span class="n">cudaMemcpy</span><span class="p">(</span><span class="n">propSecondOrder</span><span class="p">,</span><span class="w"> </span><span class="n">secondOrder</span><span class="p">,</span><span class="w"> </span><span class="n">secondOrderSize</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">),</span><span class="w"> </span><span class="n">cudaMemcpyHostToDevice</span><span class="p">);</span>
<span class="linenos"> 590</span><span class="p">}</span>
<span class="linenos"> 591</span>
<span class="linenos"> 592</span><span class="kt">void</span><span class="w"> </span><span class="n">IntMpdRdmeSolver</span><span class="o">::</span><span class="n">generateTrajectory</span><span class="p">()</span>
<span class="linenos"> 593</span><span class="p">{</span>
<span class="linenos"> 594</span><span class="w">    </span><span class="c1">// Shadow the lattice member as a cuda lattice.</span>
<span class="linenos"> 595</span><span class="w">    </span><span class="n">CudaIntLattice</span><span class="o">*</span><span class="w"> </span><span class="n">lattice</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="n">CudaIntLattice</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">this</span><span class="o">-&gt;</span><span class="n">lattice</span><span class="p">);</span>
<span class="linenos"> 596</span>
<span class="linenos"> 597</span><span class="w">    </span><span class="c1">// Get the interval for writing species counts and lattices.</span>
<span class="linenos"> 598</span><span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">speciesCountsWriteInterval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">atol</span><span class="p">((</span><span class="o">*</span><span class="n">parameters</span><span class="p">)[</span><span class="s">&quot;writeInterval&quot;</span><span class="p">].</span><span class="n">c_str</span><span class="p">());</span>
<span class="linenos"> 599</span><span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">nextSpeciesCountsWriteTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">speciesCountsWriteInterval</span><span class="p">;</span>
<span class="linenos"> 600</span>
<span class="linenos"> 601</span><span class="w">	</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">latticeWriteInterval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">atol</span><span class="p">((</span><span class="o">*</span><span class="n">parameters</span><span class="p">)[</span><span class="s">&quot;latticeWriteInterval&quot;</span><span class="p">].</span><span class="n">c_str</span><span class="p">());</span>
<span class="linenos"> 602</span><span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">nextLatticeWriteTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">latticeWriteInterval</span><span class="p">;</span>
<span class="linenos"> 603</span>
<span class="linenos"> 604</span><span class="w">	</span><span class="n">lm</span><span class="o">::</span><span class="n">io</span><span class="o">::</span><span class="n">Lattice</span><span class="w"> </span><span class="n">latticeDataSet</span><span class="p">;</span>
<span class="linenos"> 605</span><span class="w">    </span><span class="n">lm</span><span class="o">::</span><span class="n">io</span><span class="o">::</span><span class="n">SpeciesCounts</span><span class="w"> </span><span class="n">speciesCountsDataSet</span><span class="p">;</span>
<span class="linenos"> 606</span><span class="w">    </span><span class="n">speciesCountsDataSet</span><span class="p">.</span><span class="n">set_number_species</span><span class="p">(</span><span class="n">numberSpeciesToTrack</span><span class="p">);</span>
<span class="linenos"> 607</span><span class="w">    </span><span class="n">speciesCountsDataSet</span><span class="p">.</span><span class="n">set_number_entries</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="linenos"> 608</span>
<span class="linenos"> 609</span><span class="w">    </span><span class="c1">// Get the simulation time limit.</span>
<span class="linenos"> 610</span><span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">maxTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">atof</span><span class="p">((</span><span class="o">*</span><span class="n">parameters</span><span class="p">)[</span><span class="s">&quot;maxTime&quot;</span><span class="p">].</span><span class="n">c_str</span><span class="p">());</span>
<span class="linenos"> 611</span>
<span class="linenos"> 612</span><span class="w">    </span><span class="c1">// Set the initial time.</span>
<span class="linenos"> 613</span><span class="w">	</span><span class="kt">double</span><span class="w"> </span><span class="n">time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>
<span class="linenos"> 614</span><span class="w">	</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">current_timestep</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos"> 615</span>
<span class="linenos"> 616</span><span class="w">    </span><span class="kt">bool</span><span class="w">     </span><span class="n">hookEnabled</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="linenos"> 617</span><span class="w">	</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">hookInterval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos"> 618</span><span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">nextHookTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos"> 619</span>
<span class="linenos"> 620</span><span class="w">    </span><span class="c1">// Find out at what interval to hook simulations</span>
<span class="linenos"> 621</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="o">*</span><span class="n">parameters</span><span class="p">)[</span><span class="s">&quot;hookInterval&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">)</span>
<span class="linenos"> 622</span><span class="w">    </span><span class="p">{</span>
<span class="linenos"> 623</span><span class="w">		</span><span class="n">hookEnabled</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="linenos"> 624</span><span class="w">        </span><span class="n">hookInterval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">atol</span><span class="p">((</span><span class="o">*</span><span class="n">parameters</span><span class="p">)[</span><span class="s">&quot;hookInterval&quot;</span><span class="p">].</span><span class="n">c_str</span><span class="p">());</span>
<span class="linenos"> 625</span><span class="w">        </span><span class="n">nextHookTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hookInterval</span><span class="p">;</span>
<span class="linenos"> 626</span><span class="w">    </span><span class="p">}</span>
<span class="linenos"> 627</span>
<span class="linenos"> 628</span><span class="w">    </span><span class="c1">// Find out at what interval to write status messages</span>
<span class="linenos"> 629</span><span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">printPerfInterval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">60</span><span class="p">;</span>
<span class="linenos"> 630</span>
<span class="linenos"> 631</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="o">*</span><span class="n">parameters</span><span class="p">)[</span><span class="s">&quot;perfPrintInterval&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">)</span>
<span class="linenos"> 632</span><span class="w">    </span><span class="p">{</span>
<span class="linenos"> 633</span><span class="w">    	</span><span class="n">printPerfInterval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">atof</span><span class="p">((</span><span class="o">*</span><span class="n">parameters</span><span class="p">)[</span><span class="s">&quot;perfPrintInterval&quot;</span><span class="p">].</span><span class="n">c_str</span><span class="p">());</span>
<span class="linenos"> 634</span><span class="w">    </span><span class="p">}</span>
<span class="linenos"> 635</span>
<span class="linenos"> 636</span><span class="w">    </span><span class="c1">// Synchronize the cuda memory.</span>
<span class="linenos"> 637</span><span class="w">    </span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">copyToGPU</span><span class="p">();</span>
<span class="linenos"> 638</span>
<span class="linenos"> 639</span><span class="w">    </span><span class="c1">// Record the initial species counts.</span>
<span class="linenos"> 640</span><span class="w">    </span><span class="n">recordSpeciesCounts</span><span class="p">(</span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="n">lattice</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">speciesCountsDataSet</span><span class="p">);</span>
<span class="linenos"> 641</span>
<span class="linenos"> 642</span><span class="w">    </span><span class="c1">// Write the initial lattice.</span>
<span class="linenos"> 643</span><span class="w">    </span><span class="n">writeLatticeData</span><span class="p">(</span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="n">lattice</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">latticeDataSet</span><span class="p">);</span>
<span class="linenos"> 644</span>
<span class="linenos"> 645</span><span class="w">    </span><span class="n">Timer</span><span class="w"> </span><span class="n">timer</span><span class="p">;</span>
<span class="linenos"> 646</span><span class="w">    </span><span class="n">timer</span><span class="p">.</span><span class="n">tick</span><span class="p">();</span>
<span class="linenos"> 647</span>
<span class="linenos"> 648</span><span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">lastT</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos"> 649</span><span class="w">    </span><span class="kt">int</span><span class="w">    </span><span class="n">lastSteps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos"> 650</span>
<span class="linenos"> 651</span><span class="w">    </span><span class="c1">// Perform an initial hook check</span>
<span class="linenos"> 652</span><span class="w">    </span><span class="n">hookCheckSimulation</span><span class="p">(</span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="n">lattice</span><span class="p">);</span>
<span class="linenos"> 653</span>
<span class="linenos"> 654</span><span class="w">    </span><span class="c1">// Loop until we have finished the simulation</span>
<span class="linenos"> 655</span><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">time</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">maxTime</span><span class="p">)</span>
<span class="linenos"> 656</span><span class="w">    </span><span class="p">{</span>
<span class="linenos"> 657</span><span class="w">	    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">globalAbort</span><span class="p">)</span>
<span class="linenos"> 658</span><span class="w">		</span><span class="p">{</span>
<span class="linenos"> 659</span><span class="w">			</span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Global abort: terminating solver</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="linenos"> 660</span><span class="w">			</span><span class="k">break</span><span class="p">;</span>
<span class="linenos"> 661</span><span class="w">		</span><span class="p">}</span>
<span class="linenos"> 662</span>
<span class="linenos"> 663</span><span class="w">        </span><span class="n">lastT</span><span class="w">     </span><span class="o">+=</span><span class="w"> </span><span class="n">timer</span><span class="p">.</span><span class="n">tock</span><span class="p">();</span>
<span class="linenos"> 664</span><span class="w">        </span><span class="n">lastSteps</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="linenos"> 665</span>
<span class="linenos"> 666</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">lastT</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">printPerfInterval</span><span class="p">)</span>
<span class="linenos"> 667</span><span class="w">        </span><span class="p">{</span>
<span class="linenos"> 668</span><span class="w">            </span><span class="kt">double</span><span class="w"> </span><span class="n">stepTime</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="n">lastT</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">lastSteps</span><span class="p">;</span>
<span class="linenos"> 669</span><span class="w">            </span><span class="kt">double</span><span class="w"> </span><span class="n">completionTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stepTime</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">maxTime</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">time</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">tau</span><span class="p">;</span>
<span class="linenos"> 670</span>
<span class="linenos"> 671</span><span class="w">            </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">units</span><span class="p">;</span>
<span class="linenos"> 672</span>
<span class="linenos"> 673</span><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">completionTime</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">60</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">60</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">24</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">365</span><span class="p">)</span>
<span class="linenos"> 674</span><span class="w">            </span><span class="p">{</span>
<span class="linenos"> 675</span><span class="w">                </span><span class="n">units</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;weeks&quot;</span><span class="p">;</span>
<span class="linenos"> 676</span><span class="w">                </span><span class="n">completionTime</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="mi">60</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">60</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">24</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">365</span><span class="p">;</span>
<span class="linenos"> 677</span><span class="w">            </span><span class="p">}</span>
<span class="linenos"> 678</span><span class="w">            </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">completionTime</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">60</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">60</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">24</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">30</span><span class="p">)</span>
<span class="linenos"> 679</span><span class="w">            </span><span class="p">{</span>
<span class="linenos"> 680</span><span class="w">                </span><span class="n">units</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;months&quot;</span><span class="p">;</span>
<span class="linenos"> 681</span><span class="w">                </span><span class="n">completionTime</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="mi">60</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">60</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">24</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">30</span><span class="p">;</span>
<span class="linenos"> 682</span><span class="w">            </span><span class="p">}</span>
<span class="linenos"> 683</span><span class="w">            </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">completionTime</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">60</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">60</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">24</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">7</span><span class="p">)</span>
<span class="linenos"> 684</span><span class="w">            </span><span class="p">{</span>
<span class="linenos"> 685</span><span class="w">                </span><span class="n">units</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;weeks&quot;</span><span class="p">;</span>
<span class="linenos"> 686</span><span class="w">                </span><span class="n">completionTime</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="mi">60</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">60</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">24</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">7</span><span class="p">;</span>
<span class="linenos"> 687</span><span class="w">            </span><span class="p">}</span>
<span class="linenos"> 688</span><span class="w">            </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">completionTime</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">60</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">60</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">24</span><span class="p">)</span>
<span class="linenos"> 689</span><span class="w">            </span><span class="p">{</span>
<span class="linenos"> 690</span><span class="w">                </span><span class="n">units</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;days&quot;</span><span class="p">;</span>
<span class="linenos"> 691</span><span class="w">                </span><span class="n">completionTime</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="mi">60</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">60</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">24</span><span class="p">;</span>
<span class="linenos"> 692</span><span class="w">            </span><span class="p">}</span>
<span class="linenos"> 693</span><span class="w">            </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">completionTime</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">60</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">60</span><span class="p">)</span>
<span class="linenos"> 694</span><span class="w">            </span><span class="p">{</span>
<span class="linenos"> 695</span><span class="w">                </span><span class="n">units</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;hours&quot;</span><span class="p">;</span>
<span class="linenos"> 696</span><span class="w">                </span><span class="n">completionTime</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="mi">60</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">60</span><span class="p">;</span>
<span class="linenos"> 697</span><span class="w">            </span><span class="p">}</span>
<span class="linenos"> 698</span><span class="w">            </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">completionTime</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">60</span><span class="p">)</span>
<span class="linenos"> 699</span><span class="w">            </span><span class="p">{</span>
<span class="linenos"> 700</span><span class="w">                </span><span class="n">units</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;minutes&quot;</span><span class="p">;</span>
<span class="linenos"> 701</span><span class="w">                </span><span class="n">completionTime</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="mi">60</span><span class="p">;</span>
<span class="linenos"> 702</span><span class="w">            </span><span class="p">}</span>
<span class="linenos"> 703</span><span class="w">            </span><span class="k">else</span>
<span class="linenos"> 704</span><span class="w">            </span><span class="p">{</span>
<span class="linenos"> 705</span><span class="w">                </span><span class="n">units</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;seconds&quot;</span><span class="p">;</span>
<span class="linenos"> 706</span><span class="w">            </span><span class="p">}</span>
<span class="linenos"> 707</span>
<span class="linenos"> 708</span><span class="w">            </span><span class="n">Print</span><span class="o">::</span><span class="n">printf</span><span class="p">(</span><span class="n">Print</span><span class="o">::</span><span class="n">INFO</span><span class="p">,</span>
<span class="linenos"> 709</span><span class="w">                          </span><span class="s">&quot;Average walltime per timestep: %.2f ms. &quot;</span>
<span class="linenos"> 710</span><span class="w">                          </span><span class="s">&quot;Progress: %.4fs/%.4fs (% .3g%% done / %.2g %s walltime remaining)&quot;</span><span class="p">,</span>
<span class="linenos"> 711</span><span class="w">                          </span><span class="mf">1000.0</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">stepTime</span><span class="p">,</span><span class="w"> </span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="n">maxTime</span><span class="p">,</span><span class="w"> </span><span class="mf">100.0</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">time</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">maxTime</span><span class="p">,</span>
<span class="linenos"> 712</span><span class="w">                          </span><span class="n">completionTime</span><span class="p">,</span><span class="w"> </span><span class="n">units</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
<span class="linenos"> 713</span>
<span class="linenos"> 714</span><span class="w">            </span><span class="n">lastT</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos"> 715</span><span class="w">            </span><span class="n">lastSteps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos"> 716</span><span class="w">        </span><span class="p">}</span>
<span class="linenos"> 717</span>
<span class="linenos"> 718</span><span class="w">        </span><span class="n">timer</span><span class="p">.</span><span class="n">tick</span><span class="p">();</span>
<span class="linenos"> 719</span>
<span class="linenos"> 720</span><span class="w">        </span><span class="c1">// Run the next timestep.</span>
<span class="linenos"> 721</span><span class="w">        </span><span class="n">runTimestep</span><span class="p">(</span><span class="n">lattice</span><span class="p">,</span><span class="w"> </span><span class="n">current_timestep</span><span class="o">++</span><span class="p">);</span>
<span class="linenos"> 722</span>
<span class="linenos"> 723</span><span class="w">        </span><span class="c1">// Update the time.</span>
<span class="linenos"> 724</span><span class="w">	    </span><span class="n">time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">current_timestep</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">tau</span><span class="p">;</span>
<span class="linenos"> 725</span>
<span class="linenos"> 726</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">current_timestep</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">nextLatticeWriteTime</span><span class="w"> </span><span class="o">||</span>
<span class="linenos"> 727</span><span class="w">            </span><span class="n">current_timestep</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">nextSpeciesCountsWriteTime</span><span class="w"> </span><span class="o">||</span>
<span class="linenos"> 728</span><span class="w">            </span><span class="p">(</span><span class="n">hookEnabled</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">current_timestep</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">nextHookTime</span><span class="p">))</span>
<span class="linenos"> 729</span><span class="w">        </span><span class="p">{</span>
<span class="linenos"> 730</span><span class="w">            </span><span class="n">reactionModelModified</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="linenos"> 731</span>
<span class="linenos"> 732</span><span class="w">            </span><span class="c1">// Synchronize the lattice.</span>
<span class="linenos"> 733</span><span class="w">            </span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">copyFromGPU</span><span class="p">();</span>
<span class="linenos"> 734</span>
<span class="linenos"> 735</span><span class="w">	        </span><span class="c1">// Check if we need to execute the hook</span>
<span class="linenos"> 736</span><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">hookEnabled</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">current_timestep</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">nextHookTime</span><span class="p">)</span>
<span class="linenos"> 737</span><span class="w">            </span><span class="p">{</span>
<span class="linenos"> 738</span><span class="w">   	            </span><span class="n">hookCheckSimulation</span><span class="p">(</span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="n">lattice</span><span class="p">);</span>
<span class="linenos"> 739</span><span class="w">                </span><span class="n">nextHookTime</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">hookInterval</span><span class="p">;</span>
<span class="linenos"> 740</span><span class="w">            </span><span class="p">}</span>
<span class="linenos"> 741</span>
<span class="linenos"> 742</span><span class="w">            </span><span class="c1">// See if we need to write the lattice.</span>
<span class="linenos"> 743</span><span class="w">	        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">current_timestep</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">nextLatticeWriteTime</span><span class="p">)</span>
<span class="linenos"> 744</span><span class="w">            </span><span class="p">{</span>
<span class="linenos"> 745</span><span class="w">                </span><span class="n">writeLatticeData</span><span class="p">(</span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="n">lattice</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">latticeDataSet</span><span class="p">);</span>
<span class="linenos"> 746</span><span class="w">                </span><span class="n">nextLatticeWriteTime</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">latticeWriteInterval</span><span class="p">;</span>
<span class="linenos"> 747</span><span class="w">            </span><span class="p">}</span>
<span class="linenos"> 748</span>
<span class="linenos"> 749</span><span class="w">            </span><span class="c1">// See if we need to write the species counts.</span>
<span class="linenos"> 750</span><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">current_timestep</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">nextSpeciesCountsWriteTime</span><span class="p">)</span>
<span class="linenos"> 751</span><span class="w">            </span><span class="p">{</span>
<span class="linenos"> 752</span><span class="w">                </span><span class="n">recordSpeciesCounts</span><span class="p">(</span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="n">lattice</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">speciesCountsDataSet</span><span class="p">);</span>
<span class="linenos"> 753</span><span class="w">                </span><span class="n">nextSpeciesCountsWriteTime</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">speciesCountsWriteInterval</span><span class="p">;</span>
<span class="linenos"> 754</span>
<span class="linenos"> 755</span><span class="w">                </span><span class="c1">// See if we have accumulated enough species counts to send.</span>
<span class="linenos"> 756</span><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">speciesCountsDataSet</span><span class="p">.</span><span class="n">number_entries</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">TUNE_SPECIES_COUNTS_BUFFER_SIZE</span><span class="p">)</span>
<span class="linenos"> 757</span><span class="w">                </span><span class="p">{</span>
<span class="linenos"> 758</span><span class="w">                    </span><span class="n">writeSpeciesCounts</span><span class="p">(</span><span class="o">&amp;</span><span class="n">speciesCountsDataSet</span><span class="p">);</span>
<span class="linenos"> 759</span><span class="w">                </span><span class="p">}</span>
<span class="linenos"> 760</span><span class="w">            </span><span class="p">}</span>
<span class="linenos"> 761</span><span class="w">        </span><span class="p">}</span>
<span class="linenos"> 762</span><span class="w">    </span><span class="p">}</span>
<span class="linenos"> 763</span>
<span class="linenos"> 764</span><span class="w">    </span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">copyFromGPU</span><span class="p">();</span>
<span class="linenos"> 765</span>
<span class="linenos"> 766</span><span class="w">    </span><span class="c1">// Write any remaining species counts.</span>
<span class="linenos"> 767</span><span class="w">    </span><span class="n">writeSpeciesCounts</span><span class="p">(</span><span class="o">&amp;</span><span class="n">speciesCountsDataSet</span><span class="p">);</span>
<span class="linenos"> 768</span><span class="p">}</span>
<span class="linenos"> 769</span>
<span class="linenos"> 770</span><span class="kt">int</span><span class="w"> </span><span class="n">IntMpdRdmeSolver</span><span class="o">::</span><span class="n">hookSimulation</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="n">CudaIntLattice</span><span class="w"> </span><span class="o">*</span><span class="n">lattice</span><span class="p">)</span>
<span class="linenos"> 771</span><span class="p">{</span><span class="w">                                                       </span>
<span class="linenos"> 772</span><span class="w">    </span><span class="c1">// Overload this function in derivative classes</span>
<span class="linenos"> 773</span><span class="w">	</span><span class="c1">// Return 0 if the lattice state is unchanged</span>
<span class="linenos"> 774</span><span class="w">	</span><span class="c1">// Return 1 if the lattice state has been modified, </span>
<span class="linenos"> 775</span><span class="w">    </span><span class="c1">//          and it needs to be copied back to the GPU</span>
<span class="linenos"> 776</span><span class="w">	</span><span class="c1">// Return 2 if lattice sites have changed, and should</span>
<span class="linenos"> 777</span><span class="w">	</span><span class="c1">//			be copied back to the GPU *and* be recorded</span>
<span class="linenos"> 778</span><span class="w">	</span><span class="c1">//			in the output file           </span>
<span class="linenos"> 779</span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">                                             </span>
<span class="linenos"> 780</span><span class="p">}</span>
<span class="linenos"> 781</span>
<span class="linenos"> 782</span><span class="kt">void</span><span class="w"> </span><span class="n">IntMpdRdmeSolver</span><span class="o">::</span><span class="n">writeLatticeData</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">time</span><span class="p">,</span>
<span class="linenos"> 783</span><span class="w">                                        </span><span class="n">CudaIntLattice</span><span class="o">*</span><span class="w"> </span><span class="n">lattice</span><span class="p">,</span>
<span class="linenos"> 784</span><span class="w">                                        </span><span class="n">lm</span><span class="o">::</span><span class="n">io</span><span class="o">::</span><span class="n">Lattice</span><span class="o">*</span><span class="w"> </span><span class="n">latticeDataSet</span><span class="p">)</span>
<span class="linenos"> 785</span><span class="p">{</span>
<span class="linenos"> 786</span><span class="w">    </span><span class="c1">// Record the lattice data.</span>
<span class="linenos"> 787</span><span class="w">    </span><span class="n">latticeDataSet</span><span class="o">-&gt;</span><span class="n">Clear</span><span class="p">();</span>
<span class="linenos"> 788</span><span class="w">    </span><span class="n">latticeDataSet</span><span class="o">-&gt;</span><span class="n">set_lattice_x_size</span><span class="p">(</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getSize</span><span class="p">().</span><span class="n">x</span><span class="p">);</span>
<span class="linenos"> 789</span><span class="w">    </span><span class="n">latticeDataSet</span><span class="o">-&gt;</span><span class="n">set_lattice_y_size</span><span class="p">(</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getSize</span><span class="p">().</span><span class="n">y</span><span class="p">);</span>
<span class="linenos"> 790</span><span class="w">    </span><span class="n">latticeDataSet</span><span class="o">-&gt;</span><span class="n">set_lattice_z_size</span><span class="p">(</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getSize</span><span class="p">().</span><span class="n">z</span><span class="p">);</span>
<span class="linenos"> 791</span><span class="w">    </span><span class="n">latticeDataSet</span><span class="o">-&gt;</span><span class="n">set_particles_per_site</span><span class="p">(</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getMaxOccupancy</span><span class="p">());</span>
<span class="linenos"> 792</span><span class="w">    </span><span class="n">latticeDataSet</span><span class="o">-&gt;</span><span class="n">set_time</span><span class="p">(</span><span class="n">time</span><span class="p">);</span>
<span class="linenos"> 793</span>
<span class="linenos"> 794</span><span class="w">    </span><span class="c1">// Push it to the output queue.</span>
<span class="linenos"> 795</span><span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">payloadSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getSize</span><span class="p">().</span><span class="n">x</span><span class="w"> </span><span class="o">*</span>
<span class="linenos"> 796</span><span class="w">                         </span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getSize</span><span class="p">().</span><span class="n">y</span><span class="w"> </span><span class="o">*</span>
<span class="linenos"> 797</span><span class="w">                         </span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getSize</span><span class="p">().</span><span class="n">z</span><span class="w"> </span><span class="o">*</span>
<span class="linenos"> 798</span><span class="w">                         </span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getMaxOccupancy</span><span class="p">()</span><span class="w"> </span><span class="o">*</span>
<span class="linenos"> 799</span><span class="w">                         </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">);</span>
<span class="linenos"> 800</span>
<span class="linenos"> 801</span><span class="w">    </span><span class="n">lm</span><span class="o">::</span><span class="n">main</span><span class="o">::</span><span class="n">DataOutputQueue</span><span class="o">::</span><span class="n">getInstance</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">pushDataSet</span><span class="p">(</span><span class="n">lm</span><span class="o">::</span><span class="n">main</span><span class="o">::</span><span class="n">DataOutputQueue</span><span class="o">::</span><span class="n">INT_LATTICE</span><span class="p">,</span>
<span class="linenos"> 802</span><span class="w">                                                          </span><span class="n">replicate</span><span class="p">,</span>
<span class="linenos"> 803</span><span class="w">                                                          </span><span class="n">latticeDataSet</span><span class="p">,</span>
<span class="linenos"> 804</span><span class="w">                                                          </span><span class="n">lattice</span><span class="p">,</span>
<span class="linenos"> 805</span><span class="w">                                                          </span><span class="n">payloadSize</span><span class="p">,</span>
<span class="linenos"> 806</span><span class="w">                                                          </span><span class="o">&amp;</span><span class="n">lm</span><span class="o">::</span><span class="n">rdme</span><span class="o">::</span><span class="n">IntLattice</span><span class="o">::</span><span class="n">nativeSerialize</span><span class="p">);</span>
<span class="linenos"> 807</span><span class="p">}</span>
<span class="linenos"> 808</span>
<span class="linenos"> 809</span><span class="kt">void</span><span class="w"> </span><span class="n">IntMpdRdmeSolver</span><span class="o">::</span><span class="n">writeLatticeSites</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="n">CudaIntLattice</span><span class="o">*</span><span class="w"> </span><span class="n">lattice</span><span class="p">)</span>
<span class="linenos"> 810</span><span class="p">{</span>
<span class="linenos"> 811</span><span class="w">    </span><span class="n">lm</span><span class="o">::</span><span class="n">io</span><span class="o">::</span><span class="n">Lattice</span><span class="w"> </span><span class="n">latticeDataSet</span><span class="p">;</span>
<span class="linenos"> 812</span>
<span class="linenos"> 813</span><span class="w">    </span><span class="c1">// Record the lattice data.</span>
<span class="linenos"> 814</span><span class="w">    </span><span class="n">latticeDataSet</span><span class="p">.</span><span class="n">Clear</span><span class="p">();</span>
<span class="linenos"> 815</span><span class="w">    </span><span class="n">latticeDataSet</span><span class="p">.</span><span class="n">set_lattice_x_size</span><span class="p">(</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getSize</span><span class="p">().</span><span class="n">x</span><span class="p">);</span>
<span class="linenos"> 816</span><span class="w">    </span><span class="n">latticeDataSet</span><span class="p">.</span><span class="n">set_lattice_y_size</span><span class="p">(</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getSize</span><span class="p">().</span><span class="n">y</span><span class="p">);</span>
<span class="linenos"> 817</span><span class="w">    </span><span class="n">latticeDataSet</span><span class="p">.</span><span class="n">set_lattice_z_size</span><span class="p">(</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getSize</span><span class="p">().</span><span class="n">z</span><span class="p">);</span>
<span class="linenos"> 818</span><span class="w">    </span><span class="n">latticeDataSet</span><span class="p">.</span><span class="n">set_particles_per_site</span><span class="p">(</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getMaxOccupancy</span><span class="p">());</span>
<span class="linenos"> 819</span><span class="w">    </span><span class="n">latticeDataSet</span><span class="p">.</span><span class="n">set_time</span><span class="p">(</span><span class="n">time</span><span class="p">);</span>
<span class="linenos"> 820</span>
<span class="linenos"> 821</span><span class="w">    </span><span class="c1">// Push it to the output queue.</span>
<span class="linenos"> 822</span><span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">payloadSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getSize</span><span class="p">().</span><span class="n">x</span><span class="w"> </span><span class="o">*</span>
<span class="linenos"> 823</span><span class="w">                         </span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getSize</span><span class="p">().</span><span class="n">y</span><span class="w"> </span><span class="o">*</span>
<span class="linenos"> 824</span><span class="w">                         </span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getSize</span><span class="p">().</span><span class="n">z</span><span class="w"> </span><span class="o">*</span>
<span class="linenos"> 825</span><span class="w">                         </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">uint8_t</span><span class="p">);</span>
<span class="linenos"> 826</span>
<span class="linenos"> 827</span><span class="w">    </span><span class="n">lm</span><span class="o">::</span><span class="n">main</span><span class="o">::</span><span class="n">DataOutputQueue</span><span class="o">::</span><span class="n">getInstance</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">pushDataSet</span><span class="p">(</span><span class="n">lm</span><span class="o">::</span><span class="n">main</span><span class="o">::</span><span class="n">DataOutputQueue</span><span class="o">::</span><span class="n">SITE_LATTICE</span><span class="p">,</span>
<span class="linenos"> 828</span><span class="w">                                                          </span><span class="n">replicate</span><span class="p">,</span>
<span class="linenos"> 829</span><span class="w">                                                          </span><span class="o">&amp;</span><span class="n">latticeDataSet</span><span class="p">,</span>
<span class="linenos"> 830</span><span class="w">                                                          </span><span class="n">lattice</span><span class="p">,</span>
<span class="linenos"> 831</span><span class="w">                                                          </span><span class="n">payloadSize</span><span class="p">,</span>
<span class="linenos"> 832</span><span class="w">                                                          </span><span class="o">&amp;</span><span class="n">lm</span><span class="o">::</span><span class="n">rdme</span><span class="o">::</span><span class="n">ByteLattice</span><span class="o">::</span><span class="n">nativeSerializeSites</span><span class="p">);</span>
<span class="linenos"> 833</span><span class="p">}</span>
<span class="linenos"> 834</span>
<span class="linenos"> 835</span><span class="kt">void</span><span class="w"> </span><span class="n">IntMpdRdmeSolver</span><span class="o">::</span><span class="n">recordSpeciesCounts</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="n">CudaIntLattice</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">lattice</span><span class="p">,</span><span class="w"> </span><span class="n">lm</span><span class="o">::</span><span class="n">io</span><span class="o">::</span><span class="n">SpeciesCounts</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">speciesCountsDataSet</span><span class="p">)</span>
<span class="linenos"> 836</span><span class="p">{</span>
<span class="linenos"> 837</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">particle_t</span><span class="p">,</span><span class="n">uint</span><span class="o">&gt;</span><span class="w"> </span><span class="n">particleCounts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getParticleCounts</span><span class="p">();</span>
<span class="linenos"> 838</span><span class="w">    </span><span class="n">speciesCountsDataSet</span><span class="o">-&gt;</span><span class="n">set_number_entries</span><span class="p">(</span><span class="n">speciesCountsDataSet</span><span class="o">-&gt;</span><span class="n">number_entries</span><span class="p">()</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
<span class="linenos"> 839</span><span class="w">    </span><span class="n">speciesCountsDataSet</span><span class="o">-&gt;</span><span class="n">add_time</span><span class="p">(</span><span class="n">time</span><span class="p">);</span>
<span class="linenos"> 840</span><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">particle_t</span><span class="w"> </span><span class="n">p</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">p</span><span class="o">&lt;</span><span class="n">numberSpeciesToTrack</span><span class="p">;</span><span class="w"> </span><span class="n">p</span><span class="o">++</span><span class="p">)</span>
<span class="linenos"> 841</span><span class="w">    </span><span class="p">{</span>
<span class="linenos"> 842</span><span class="w">        </span><span class="n">speciesCountsDataSet</span><span class="o">-&gt;</span><span class="n">add_species_count</span><span class="p">((</span><span class="n">particleCounts</span><span class="p">.</span><span class="n">count</span><span class="p">(</span><span class="n">p</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span><span class="o">?</span><span class="n">particleCounts</span><span class="p">[</span><span class="n">p</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">:</span><span class="mi">0</span><span class="p">);</span>
<span class="linenos"> 843</span><span class="w">    </span><span class="p">}</span>
<span class="linenos"> 844</span><span class="p">}</span>
<span class="linenos"> 845</span>
<span class="linenos"> 846</span><span class="kt">void</span><span class="w"> </span><span class="n">IntMpdRdmeSolver</span><span class="o">::</span><span class="n">writeSpeciesCounts</span><span class="p">(</span><span class="n">lm</span><span class="o">::</span><span class="n">io</span><span class="o">::</span><span class="n">SpeciesCounts</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">speciesCountsDataSet</span><span class="p">)</span>
<span class="linenos"> 847</span><span class="p">{</span>
<span class="linenos"> 848</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">speciesCountsDataSet</span><span class="o">-&gt;</span><span class="n">number_entries</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="linenos"> 849</span><span class="w">    </span><span class="p">{</span>
<span class="linenos"> 850</span><span class="w">        </span><span class="c1">// Push it to the output queue.</span>
<span class="linenos"> 851</span><span class="w">        </span><span class="n">lm</span><span class="o">::</span><span class="n">main</span><span class="o">::</span><span class="n">DataOutputQueue</span><span class="o">::</span><span class="n">getInstance</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">pushDataSet</span><span class="p">(</span><span class="n">lm</span><span class="o">::</span><span class="n">main</span><span class="o">::</span><span class="n">DataOutputQueue</span><span class="o">::</span><span class="n">SPECIES_COUNTS</span><span class="p">,</span><span class="w"> </span><span class="n">replicate</span><span class="p">,</span><span class="w"> </span><span class="n">speciesCountsDataSet</span><span class="p">);</span>
<span class="linenos"> 852</span>
<span class="linenos"> 853</span><span class="w">        </span><span class="c1">// Reset the data set.</span>
<span class="linenos"> 854</span><span class="w">        </span><span class="n">speciesCountsDataSet</span><span class="o">-&gt;</span><span class="n">Clear</span><span class="p">();</span>
<span class="linenos"> 855</span><span class="w">        </span><span class="n">speciesCountsDataSet</span><span class="o">-&gt;</span><span class="n">set_number_species</span><span class="p">(</span><span class="n">numberSpeciesToTrack</span><span class="p">);</span>
<span class="linenos"> 856</span><span class="w">        </span><span class="n">speciesCountsDataSet</span><span class="o">-&gt;</span><span class="n">set_number_entries</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="linenos"> 857</span><span class="w">    </span><span class="p">}</span>
<span class="linenos"> 858</span><span class="p">}</span>
<span class="linenos"> 859</span>
<span class="linenos"> 860</span><span class="kt">void</span><span class="w"> </span><span class="n">IntMpdRdmeSolver</span><span class="o">::</span><span class="n">hookCheckSimulation</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="n">CudaIntLattice</span><span class="o">*</span><span class="w"> </span><span class="n">lattice</span><span class="p">)</span>
<span class="linenos"> 861</span><span class="p">{</span>
<span class="linenos"> 862</span><span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">hookSimulation</span><span class="p">(</span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="n">lattice</span><span class="p">))</span>
<span class="linenos"> 863</span><span class="w">    </span><span class="p">{</span>
<span class="linenos"> 864</span><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="mi">0</span><span class="p">:</span>
<span class="linenos"> 865</span><span class="w">        </span><span class="p">{</span>
<span class="linenos"> 866</span><span class="w">            </span><span class="k">break</span><span class="p">;</span>
<span class="linenos"> 867</span><span class="w">        </span><span class="p">}</span>
<span class="linenos"> 868</span><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span>
<span class="linenos"> 869</span><span class="w">        </span><span class="p">{</span>
<span class="linenos"> 870</span><span class="w">            </span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">copyToGPU</span><span class="p">();</span>
<span class="linenos"> 871</span><span class="w">            </span><span class="k">break</span><span class="p">;</span>
<span class="linenos"> 872</span><span class="w">        </span><span class="p">}</span>
<span class="linenos"> 873</span><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="mi">2</span><span class="p">:</span>
<span class="linenos"> 874</span><span class="w">        </span><span class="p">{</span>
<span class="linenos"> 875</span><span class="w">            </span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">copyToGPU</span><span class="p">();</span>
<span class="linenos"> 876</span><span class="w">            </span><span class="n">writeLatticeSites</span><span class="p">(</span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="n">lattice</span><span class="p">);</span>
<span class="linenos"> 877</span><span class="w">            </span><span class="k">break</span><span class="p">;</span>
<span class="linenos"> 878</span><span class="w">        </span><span class="p">}</span>
<span class="linenos"> 879</span><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="mi">3</span><span class="p">:</span>
<span class="linenos"> 880</span><span class="w">        </span><span class="p">{</span>
<span class="linenos"> 881</span><span class="w">            </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;hook return value is 3, force to stop.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="linenos"> 882</span><span class="w">            </span><span class="n">writeLatticeSites</span><span class="p">(</span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="n">lattice</span><span class="p">);</span>
<span class="linenos"> 883</span><span class="w">            </span><span class="k">return</span><span class="p">;</span>
<span class="linenos"> 884</span><span class="w">        </span><span class="p">}</span>
<span class="linenos"> 885</span><span class="w">        </span><span class="k">default</span><span class="o">:</span>
<span class="linenos"> 886</span><span class="w">        </span><span class="p">{</span>
<span class="linenos"> 887</span><span class="w">            </span><span class="n">throw</span><span class="p">(</span><span class="s">&quot;Unknown hook return value&quot;</span><span class="p">);</span>
<span class="linenos"> 888</span><span class="w">        </span><span class="p">}</span>
<span class="linenos"> 889</span><span class="w">    </span><span class="p">}</span>
<span class="linenos"> 890</span>
<span class="linenos"> 891</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">reactionModelModified</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="n">computePropensities</span><span class="p">();}</span>
<span class="linenos"> 892</span><span class="p">}</span>
<span class="linenos"> 893</span>
<span class="linenos"> 894</span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">IntMpdRdmeSolver</span><span class="o">::</span><span class="n">getTimestepSeed</span><span class="p">(</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">timestep</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">substep</span><span class="p">)</span>
<span class="linenos"> 895</span><span class="p">{</span>
<span class="linenos"> 896</span><span class="w">    </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">timestepHash</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(((((</span><span class="kt">uint64_t</span><span class="p">)</span><span class="n">seed</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="mi">30</span><span class="p">)</span><span class="o">+</span><span class="n">timestep</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="n">substep</span><span class="p">;</span>
<span class="linenos"> 897</span><span class="w">    </span><span class="n">timestepHash</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">timestepHash</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">3202034522624059733ULL</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">4354685564936845319ULL</span><span class="p">;</span>
<span class="linenos"> 898</span><span class="w">    </span><span class="n">timestepHash</span><span class="w"> </span><span class="o">^=</span><span class="w"> </span><span class="n">timestepHash</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">20</span><span class="p">;</span><span class="w"> </span><span class="n">timestepHash</span><span class="w"> </span><span class="o">^=</span><span class="w"> </span><span class="n">timestepHash</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">41</span><span class="p">;</span><span class="w"> </span><span class="n">timestepHash</span><span class="w"> </span><span class="o">^=</span><span class="w"> </span><span class="n">timestepHash</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span>
<span class="linenos"> 899</span><span class="w">    </span><span class="n">timestepHash</span><span class="w"> </span><span class="o">*=</span><span class="w"> </span><span class="mi">7664345821815920749ULL</span><span class="p">;</span>
<span class="linenos"> 900</span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">;</span>
<span class="linenos"> 901</span><span class="p">}</span>
<span class="linenos"> 902</span>
<span class="linenos"> 903</span><span class="kt">void</span><span class="w"> </span><span class="n">IntMpdRdmeSolver</span><span class="o">::</span><span class="n">runTimestep</span><span class="p">(</span><span class="n">CudaIntLattice</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">lattice</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">timestep</span><span class="p">)</span>
<span class="linenos"> 904</span><span class="p">{</span>
<span class="linenos"> 905</span><span class="w">    </span><span class="n">PROF_BEGIN</span><span class="p">(</span><span class="n">PROF_MPD_TIMESTEP</span><span class="p">);</span>
<span class="linenos"> 906</span>
<span class="linenos"> 907</span><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">reactionModelModified</span><span class="p">)</span>
<span class="linenos"> 908</span><span class="w">        </span><span class="n">copyModelsToDevice</span><span class="p">();</span>
<span class="linenos"> 909</span>
<span class="linenos"> 910</span><span class="w">    </span><span class="c1">// Calculate some properties of the lattice.</span>
<span class="linenos"> 911</span><span class="w">    </span><span class="n">lattice_coord_t</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getSize</span><span class="p">();</span>
<span class="linenos"> 912</span><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeXSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">size</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
<span class="linenos"> 913</span><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeYSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">size</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
<span class="linenos"> 914</span><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeZSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">size</span><span class="p">.</span><span class="n">z</span><span class="p">;</span>
<span class="linenos"> 915</span>
<span class="linenos"> 916</span><span class="w">    </span><span class="kt">dim3</span><span class="w"> </span><span class="n">gridSize</span><span class="p">,</span><span class="w"> </span><span class="n">threadBlockSize</span><span class="p">;</span>
<span class="linenos"> 917</span>
<span class="linenos"> 918</span><span class="w">    </span><span class="c1">// Execute the kernel for the x direction.</span>
<span class="linenos"> 919</span><span class="w">    </span><span class="n">PROF_CUDA_START</span><span class="p">(</span><span class="n">cudaStream</span><span class="p">);</span>
<span class="linenos"> 920</span>
<span class="linenos"> 921</span><span class="w">    </span><span class="n">PROF_CUDA_BEGIN</span><span class="p">(</span><span class="n">PROF_MPD_X_DIFFUSION</span><span class="p">,</span><span class="n">cudaStream</span><span class="p">);</span>
<span class="linenos"> 922</span><span class="w">    </span><span class="cp">#ifdef MPD_CUDA_3D_GRID_LAUNCH</span>
<span class="linenos"> 923</span><span class="w">    </span><span class="n">calculateXLaunchParameters</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gridSize</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">threadBlockSize</span><span class="p">,</span><span class="w"> </span><span class="n">TUNE_MPD_X_BLOCK_MAX_X_SIZE</span><span class="p">,</span><span class="w"> </span><span class="n">latticeXSize</span><span class="p">,</span><span class="w"> </span><span class="n">latticeYSize</span><span class="p">,</span><span class="w"> </span><span class="n">latticeZSize</span><span class="p">);</span>
<span class="linenos"> 924</span><span class="w">    </span><span class="n">CUDA_EXCEPTION_EXECUTE</span><span class="p">((</span><span class="n">intmpdrdme_dev</span><span class="o">::</span><span class="n">mpd_x_kernel</span><span class="o">&lt;&lt;&lt;</span><span class="n">gridSize</span><span class="p">,</span><span class="n">threadBlockSize</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">cudaStream</span><span class="o">&gt;&gt;&gt;</span><span class="p">((</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getGPUMemorySrc</span><span class="p">(),</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getGPUMemorySiteTypes</span><span class="p">(),</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getGPUMemoryDest</span><span class="p">(),</span><span class="w"> </span><span class="n">getTimestepSeed</span><span class="p">(</span><span class="n">timestep</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="p">)</span><span class="n">cudaOverflowList</span><span class="p">)));</span>
<span class="linenos"> 925</span><span class="w">    </span><span class="cp">#else</span>
<span class="linenos"> 926</span><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">gridXSize</span><span class="p">;</span>
<span class="linenos"> 927</span><span class="w">    </span><span class="n">calculateXLaunchParameters</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gridXSize</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">gridSize</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">threadBlockSize</span><span class="p">,</span><span class="w"> </span><span class="n">TUNE_MPD_X_BLOCK_MAX_X_SIZE</span><span class="p">,</span><span class="w"> </span><span class="n">latticeXSize</span><span class="p">,</span><span class="w"> </span><span class="n">latticeYSize</span><span class="p">,</span><span class="w"> </span><span class="n">latticeZSize</span><span class="p">);</span>
<span class="linenos"> 928</span><span class="w">    </span><span class="n">CUDA_EXCEPTION_EXECUTE</span><span class="p">((</span><span class="n">intmpdrdme_dev</span><span class="o">::</span><span class="n">mpd_x_kernel</span><span class="o">&lt;&lt;&lt;</span><span class="n">gridSize</span><span class="p">,</span><span class="n">threadBlockSize</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">cudaStream</span><span class="o">&gt;&gt;&gt;</span><span class="p">((</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getGPUMemorySrc</span><span class="p">(),</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getGPUMemorySiteTypes</span><span class="p">(),</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getGPUMemoryDest</span><span class="p">(),</span><span class="w"> </span><span class="n">gridXSize</span><span class="p">,</span><span class="w"> </span><span class="n">getTimestepSeed</span><span class="p">(</span><span class="n">timestep</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="p">)</span><span class="n">cudaOverflowList</span><span class="p">)));</span>
<span class="linenos"> 929</span><span class="w">    </span><span class="cp">#endif</span>
<span class="linenos"> 930</span><span class="w">    </span><span class="n">PROF_CUDA_END</span><span class="p">(</span><span class="n">PROF_MPD_X_DIFFUSION</span><span class="p">,</span><span class="n">cudaStream</span><span class="p">);</span>
<span class="linenos"> 931</span><span class="w">    </span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">swapSrcDest</span><span class="p">();</span>
<span class="linenos"> 932</span>
<span class="linenos"> 933</span><span class="w">    </span><span class="c1">// Execute the kernel for the y direction.</span>
<span class="linenos"> 934</span><span class="w">    </span><span class="n">PROF_CUDA_BEGIN</span><span class="p">(</span><span class="n">PROF_MPD_Y_DIFFUSION</span><span class="p">,</span><span class="n">cudaStream</span><span class="p">);</span>
<span class="linenos"> 935</span><span class="w">    </span><span class="cp">#ifdef MPD_CUDA_3D_GRID_LAUNCH</span>
<span class="linenos"> 936</span><span class="w">    </span><span class="n">calculateYLaunchParameters</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gridSize</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">threadBlockSize</span><span class="p">,</span><span class="w"> </span><span class="n">TUNE_MPD_Y_BLOCK_X_SIZE</span><span class="p">,</span><span class="w"> </span><span class="n">TUNE_MPD_Y_BLOCK_Y_SIZE</span><span class="p">,</span><span class="w"> </span><span class="n">latticeXSize</span><span class="p">,</span><span class="w"> </span><span class="n">latticeYSize</span><span class="p">,</span><span class="w"> </span><span class="n">latticeZSize</span><span class="p">);</span>
<span class="linenos"> 937</span><span class="w">    </span><span class="n">CUDA_EXCEPTION_EXECUTE</span><span class="p">((</span><span class="n">intmpdrdme_dev</span><span class="o">::</span><span class="n">mpd_y_kernel</span><span class="o">&lt;&lt;&lt;</span><span class="n">gridSize</span><span class="p">,</span><span class="n">threadBlockSize</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">cudaStream</span><span class="o">&gt;&gt;&gt;</span><span class="p">((</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getGPUMemorySrc</span><span class="p">(),</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getGPUMemorySiteTypes</span><span class="p">(),</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getGPUMemoryDest</span><span class="p">(),</span><span class="w"> </span><span class="n">getTimestepSeed</span><span class="p">(</span><span class="n">timestep</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="p">)</span><span class="n">cudaOverflowList</span><span class="p">)));</span>
<span class="linenos"> 938</span><span class="w">    </span><span class="cp">#else</span>
<span class="linenos"> 939</span><span class="w">    </span><span class="n">calculateYLaunchParameters</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gridXSize</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">gridSize</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">threadBlockSize</span><span class="p">,</span><span class="w"> </span><span class="n">TUNE_MPD_Y_BLOCK_X_SIZE</span><span class="p">,</span><span class="w"> </span><span class="n">TUNE_MPD_Y_BLOCK_Y_SIZE</span><span class="p">,</span><span class="w"> </span><span class="n">latticeXSize</span><span class="p">,</span><span class="w"> </span><span class="n">latticeYSize</span><span class="p">,</span><span class="w"> </span><span class="n">latticeZSize</span><span class="p">);</span>
<span class="linenos"> 940</span><span class="w">    </span><span class="n">CUDA_EXCEPTION_EXECUTE</span><span class="p">((</span><span class="n">intmpdrdme_dev</span><span class="o">::</span><span class="n">mpd_y_kernel</span><span class="o">&lt;&lt;&lt;</span><span class="n">gridSize</span><span class="p">,</span><span class="n">threadBlockSize</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">cudaStream</span><span class="o">&gt;&gt;&gt;</span><span class="p">((</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getGPUMemorySrc</span><span class="p">(),</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getGPUMemorySiteTypes</span><span class="p">(),</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getGPUMemoryDest</span><span class="p">(),</span><span class="w"> </span><span class="n">gridXSize</span><span class="p">,</span><span class="w"> </span><span class="n">getTimestepSeed</span><span class="p">(</span><span class="n">timestep</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="p">)</span><span class="n">cudaOverflowList</span><span class="p">)));</span>
<span class="linenos"> 941</span><span class="w">    </span><span class="cp">#endif</span>
<span class="linenos"> 942</span><span class="w">    </span><span class="n">PROF_CUDA_END</span><span class="p">(</span><span class="n">PROF_MPD_Y_DIFFUSION</span><span class="p">,</span><span class="n">cudaStream</span><span class="p">);</span>
<span class="linenos"> 943</span><span class="w">    </span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">swapSrcDest</span><span class="p">();</span>
<span class="linenos"> 944</span>
<span class="linenos"> 945</span><span class="w">    </span><span class="c1">// Execute the kernel for the z direction.</span>
<span class="linenos"> 946</span><span class="w">    </span><span class="n">PROF_CUDA_BEGIN</span><span class="p">(</span><span class="n">PROF_MPD_Z_DIFFUSION</span><span class="p">,</span><span class="n">cudaStream</span><span class="p">);</span>
<span class="linenos"> 947</span><span class="w">    </span><span class="cp">#ifdef MPD_CUDA_3D_GRID_LAUNCH</span>
<span class="linenos"> 948</span><span class="w">    </span><span class="n">calculateZLaunchParameters</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gridSize</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">threadBlockSize</span><span class="p">,</span><span class="w"> </span><span class="n">TUNE_MPD_Z_BLOCK_X_SIZE</span><span class="p">,</span><span class="w"> </span><span class="n">TUNE_MPD_Z_BLOCK_Z_SIZE</span><span class="p">,</span><span class="w"> </span><span class="n">latticeXSize</span><span class="p">,</span><span class="w"> </span><span class="n">latticeYSize</span><span class="p">,</span><span class="w"> </span><span class="n">latticeZSize</span><span class="p">);</span>
<span class="linenos"> 949</span><span class="w">    </span><span class="n">CUDA_EXCEPTION_EXECUTE</span><span class="p">((</span><span class="n">intmpdrdme_dev</span><span class="o">::</span><span class="n">mpd_z_kernel</span><span class="o">&lt;&lt;&lt;</span><span class="n">gridSize</span><span class="p">,</span><span class="n">threadBlockSize</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">cudaStream</span><span class="o">&gt;&gt;&gt;</span><span class="p">((</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getGPUMemorySrc</span><span class="p">(),</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getGPUMemorySiteTypes</span><span class="p">(),</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getGPUMemoryDest</span><span class="p">(),</span><span class="w"> </span><span class="n">getTimestepSeed</span><span class="p">(</span><span class="n">timestep</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="p">)</span><span class="n">cudaOverflowList</span><span class="p">)));</span>
<span class="linenos"> 950</span><span class="w">    </span><span class="cp">#else</span>
<span class="linenos"> 951</span><span class="w">    </span><span class="n">calculateZLaunchParameters</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gridXSize</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">gridSize</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">threadBlockSize</span><span class="p">,</span><span class="w"> </span><span class="n">TUNE_MPD_Z_BLOCK_X_SIZE</span><span class="p">,</span><span class="w"> </span><span class="n">TUNE_MPD_Z_BLOCK_Z_SIZE</span><span class="p">,</span><span class="w"> </span><span class="n">latticeXSize</span><span class="p">,</span><span class="w"> </span><span class="n">latticeYSize</span><span class="p">,</span><span class="w"> </span><span class="n">latticeZSize</span><span class="p">);</span>
<span class="linenos"> 952</span><span class="w">    </span><span class="n">CUDA_EXCEPTION_EXECUTE</span><span class="p">((</span><span class="n">intmpdrdme_dev</span><span class="o">::</span><span class="n">mpd_z_kernel</span><span class="o">&lt;&lt;&lt;</span><span class="n">gridSize</span><span class="p">,</span><span class="n">threadBlockSize</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">cudaStream</span><span class="o">&gt;&gt;&gt;</span><span class="p">((</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getGPUMemorySrc</span><span class="p">(),</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getGPUMemorySiteTypes</span><span class="p">(),</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getGPUMemoryDest</span><span class="p">(),</span><span class="w"> </span><span class="n">gridXSize</span><span class="p">,</span><span class="w"> </span><span class="n">getTimestepSeed</span><span class="p">(</span><span class="n">timestep</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="p">)</span><span class="n">cudaOverflowList</span><span class="p">)));</span>
<span class="linenos"> 953</span><span class="w">    </span><span class="cp">#endif</span>
<span class="linenos"> 954</span><span class="w">    </span><span class="n">PROF_CUDA_END</span><span class="p">(</span><span class="n">PROF_MPD_Z_DIFFUSION</span><span class="p">,</span><span class="n">cudaStream</span><span class="p">);</span>
<span class="linenos"> 955</span><span class="w">    </span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">swapSrcDest</span><span class="p">();</span>
<span class="linenos"> 956</span>
<span class="linenos"> 957</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">numberReactions</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="linenos"> 958</span><span class="w">    </span><span class="p">{</span>
<span class="linenos"> 959</span><span class="w">        </span><span class="c1">// Execute the kernel for the reaction, this kernel updates the lattice in-place, so only the src pointer is passed.</span>
<span class="linenos"> 960</span><span class="w">        </span><span class="n">PROF_CUDA_BEGIN</span><span class="p">(</span><span class="n">PROF_MPD_REACTION</span><span class="p">,</span><span class="n">cudaStream</span><span class="p">);</span>
<span class="linenos"> 961</span><span class="w">        </span><span class="cp">#ifdef MPD_CUDA_3D_GRID_LAUNCH</span>
<span class="linenos"> 962</span><span class="w">        </span><span class="n">calculateReactionLaunchParameters</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gridSize</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">threadBlockSize</span><span class="p">,</span><span class="w"> </span><span class="n">TUNE_MPD_REACTION_BLOCK_X_SIZE</span><span class="p">,</span><span class="w"> </span><span class="n">TUNE_MPD_REACTION_BLOCK_Y_SIZE</span><span class="p">,</span><span class="w"> </span><span class="n">latticeXSize</span><span class="p">,</span><span class="w"> </span><span class="n">latticeYSize</span><span class="p">,</span><span class="w"> </span><span class="n">latticeZSize</span><span class="p">);</span>
<span class="linenos"> 963</span><span class="w">            </span><span class="cp">#ifdef MPD_GLOBAL_S_MATRIX</span>
<span class="linenos"> 964</span><span class="w">            </span><span class="cp">#ifdef MPD_GLOBAL_R_MATRIX</span>
<span class="linenos"> 965</span><span class="w">                    </span><span class="cp">#ifdef MPD_FREAKYFAST</span>
<span class="linenos"> 966</span><span class="w">                    </span><span class="n">CUDA_EXCEPTION_EXECUTE</span><span class="p">((</span><span class="n">intmpdrdme_dev</span><span class="o">::</span><span class="n">precomp_reaction_kernel</span><span class="o">&lt;&lt;&lt;</span><span class="n">gridSize</span><span class="p">,</span><span class="n">threadBlockSize</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">cudaStream</span><span class="o">&gt;&gt;&gt;</span><span class="p">((</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getGPUMemorySrc</span><span class="p">(),</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getGPUMemorySiteTypes</span><span class="p">(),</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getGPUMemorySrc</span><span class="p">(),</span><span class="w"> </span><span class="n">getTimestepSeed</span><span class="p">(</span><span class="n">timestep</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="p">)</span><span class="n">cudaOverflowList</span><span class="p">,</span><span class="w"> </span><span class="n">SG</span><span class="p">,</span><span class="w"> </span><span class="n">RLG</span><span class="p">,</span><span class="w"> </span><span class="n">reactionOrdersG</span><span class="p">,</span><span class="w"> </span><span class="n">reactionSitesG</span><span class="p">,</span><span class="w"> </span><span class="n">D1G</span><span class="p">,</span><span class="w"> </span><span class="n">D2G</span><span class="p">,</span><span class="w"> </span><span class="n">reactionRatesG</span><span class="p">,</span><span class="w"> </span><span class="n">propZeroOrder</span><span class="p">,</span><span class="w"> </span><span class="n">propFirstOrder</span><span class="p">,</span><span class="w"> </span><span class="n">propSecondOrder</span><span class="p">)));</span>
<span class="linenos"> 967</span><span class="w">                    </span><span class="cp">#else</span>
<span class="linenos"> 968</span><span class="w">                    </span><span class="n">CUDA_EXCEPTION_EXECUTE</span><span class="p">((</span><span class="n">intmpdrdme_dev</span><span class="o">::</span><span class="n">reaction_kernel</span><span class="o">&lt;&lt;&lt;</span><span class="n">gridSize</span><span class="p">,</span><span class="n">threadBlockSize</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">cudaStream</span><span class="o">&gt;&gt;&gt;</span><span class="p">((</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getGPUMemorySrc</span><span class="p">(),</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getGPUMemorySiteTypes</span><span class="p">(),</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getGPUMemorySrc</span><span class="p">(),</span><span class="w"> </span><span class="n">getTimestepSeed</span><span class="p">(</span><span class="n">timestep</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="p">)</span><span class="n">cudaOverflowList</span><span class="p">,</span><span class="w"> </span><span class="n">SG</span><span class="p">,</span><span class="w"> </span><span class="n">RLG</span><span class="p">,</span><span class="w"> </span><span class="n">reactionOrdersG</span><span class="p">,</span><span class="w"> </span><span class="n">reactionSitesG</span><span class="p">,</span><span class="w"> </span><span class="n">D1G</span><span class="p">,</span><span class="w"> </span><span class="n">D2G</span><span class="p">,</span><span class="w"> </span><span class="n">reactionRatesG</span><span class="p">)));</span>
<span class="linenos"> 969</span><span class="w">                    </span><span class="cp">#endif</span>
<span class="linenos"> 970</span><span class="w">            </span><span class="cp">#else</span>
<span class="linenos"> 971</span><span class="w">                </span><span class="cp">#ifdef MPD_FREAKYFAST</span>
<span class="linenos"> 972</span><span class="w">                </span><span class="n">CUDA_EXCEPTION_EXECUTE</span><span class="p">((</span><span class="n">intmpdrdme_dev</span><span class="o">::</span><span class="n">precomp_reaction_kernel</span><span class="o">&lt;&lt;&lt;</span><span class="n">gridSize</span><span class="p">,</span><span class="n">threadBlockSize</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">cudaStream</span><span class="o">&gt;&gt;&gt;</span><span class="p">((</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getGPUMemorySrc</span><span class="p">(),</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getGPUMemorySiteTypes</span><span class="p">(),</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getGPUMemorySrc</span><span class="p">(),</span><span class="w"> </span><span class="n">getTimestepSeed</span><span class="p">(</span><span class="n">timestep</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="p">)</span><span class="n">cudaOverflowList</span><span class="p">,</span><span class="w"> </span><span class="n">SG</span><span class="p">,</span><span class="w"> </span><span class="n">RLG</span><span class="p">,</span><span class="w"> </span><span class="n">propZeroOrder</span><span class="p">,</span><span class="w"> </span><span class="n">propFirstOrder</span><span class="p">,</span><span class="w"> </span><span class="n">propSecondOrder</span><span class="p">)));</span>
<span class="linenos"> 973</span><span class="w">                </span><span class="cp">#else</span>
<span class="linenos"> 974</span><span class="w">                    </span><span class="n">CUDA_EXCEPTION_EXECUTE</span><span class="p">((</span><span class="n">intmpdrdme_dev</span><span class="o">::</span><span class="n">reaction_kernel</span><span class="o">&lt;&lt;&lt;</span><span class="n">gridSize</span><span class="p">,</span><span class="n">threadBlockSize</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">cudaStream</span><span class="o">&gt;&gt;&gt;</span><span class="p">((</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getGPUMemorySrc</span><span class="p">(),</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getGPUMemorySiteTypes</span><span class="p">(),</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getGPUMemorySrc</span><span class="p">(),</span><span class="w"> </span><span class="n">getTimestepSeed</span><span class="p">(</span><span class="n">timestep</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="p">)</span><span class="n">cudaOverflowList</span><span class="p">,</span><span class="w"> </span><span class="n">SG</span><span class="p">,</span><span class="w"> </span><span class="n">RLG</span><span class="p">)));</span>
<span class="linenos"> 975</span><span class="w">                </span><span class="cp">#endif</span>
<span class="linenos"> 976</span><span class="w">            </span><span class="cp">#endif</span>
<span class="linenos"> 977</span><span class="w">            </span><span class="cp">#else</span>
<span class="linenos"> 978</span><span class="w">                    </span><span class="n">CUDA_EXCEPTION_EXECUTE</span><span class="p">((</span><span class="n">intmpdrdme_dev</span><span class="o">::</span><span class="n">reaction_kernel</span><span class="o">&lt;&lt;&lt;</span><span class="n">gridSize</span><span class="p">,</span><span class="n">threadBlockSize</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">cudaStream</span><span class="o">&gt;&gt;&gt;</span><span class="p">((</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getGPUMemorySrc</span><span class="p">(),</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getGPUMemorySiteTypes</span><span class="p">(),</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getGPUMemorySrc</span><span class="p">(),</span><span class="w"> </span><span class="n">getTimestepSeed</span><span class="p">(</span><span class="n">timestep</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="p">)</span><span class="n">cudaOverflowList</span><span class="p">)));</span>
<span class="linenos"> 979</span><span class="w">            </span><span class="cp">#endif</span>
<span class="linenos"> 980</span><span class="w">                    </span><span class="cp">#else</span>
<span class="linenos"> 981</span><span class="w">                    </span><span class="n">calculateReactionLaunchParameters</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gridXSize</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">gridSize</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">threadBlockSize</span><span class="p">,</span><span class="w"> </span><span class="n">TUNE_MPD_REACTION_BLOCK_X_SIZE</span><span class="p">,</span><span class="w"> </span><span class="n">TUNE_MPD_REACTION_BLOCK_Y_SIZE</span><span class="p">,</span><span class="w"> </span><span class="n">latticeXSize</span><span class="p">,</span><span class="w"> </span><span class="n">latticeYSize</span><span class="p">,</span><span class="w"> </span><span class="n">latticeZSize</span><span class="p">);</span>
<span class="linenos"> 982</span><span class="w">        </span><span class="cp">#ifdef MPD_GLOBAL_S_MATRIX</span>
<span class="linenos"> 983</span><span class="w">                </span><span class="n">CUDA_EXCEPTION_EXECUTE</span><span class="p">((</span><span class="n">intmpdrdme_dev</span><span class="o">::</span><span class="n">reaction_kernel</span><span class="o">&lt;&lt;&lt;</span><span class="n">gridSize</span><span class="p">,</span><span class="n">threadBlockSize</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">cudaStream</span><span class="o">&gt;&gt;&gt;</span><span class="p">((</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getGPUMemorySrc</span><span class="p">(),</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getGPUMemorySiteTypes</span><span class="p">(),</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getGPUMemorySrc</span><span class="p">(),</span><span class="w"> </span><span class="n">gridXSize</span><span class="p">,</span><span class="w"> </span><span class="n">getTimestepSeed</span><span class="p">(</span><span class="n">timestep</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="p">)</span><span class="n">cudaOverflowList</span><span class="p">,</span><span class="w"> </span><span class="n">SG</span><span class="p">,</span><span class="w"> </span><span class="n">RLG</span><span class="p">)));</span>
<span class="linenos"> 984</span><span class="w">        </span><span class="cp">#else</span>
<span class="linenos"> 985</span><span class="w">                </span><span class="n">CUDA_EXCEPTION_EXECUTE</span><span class="p">((</span><span class="n">intmpdrdme_dev</span><span class="o">::</span><span class="n">reaction_kernel</span><span class="o">&lt;&lt;&lt;</span><span class="n">gridSize</span><span class="p">,</span><span class="n">threadBlockSize</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">cudaStream</span><span class="o">&gt;&gt;&gt;</span><span class="p">((</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getGPUMemorySrc</span><span class="p">(),</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getGPUMemorySiteTypes</span><span class="p">(),</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getGPUMemorySrc</span><span class="p">(),</span><span class="w"> </span><span class="n">gridXSize</span><span class="p">,</span><span class="w"> </span><span class="n">getTimestepSeed</span><span class="p">(</span><span class="n">timestep</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="p">)</span><span class="n">cudaOverflowList</span><span class="p">)));</span>
<span class="linenos"> 986</span><span class="w">        </span><span class="cp">#endif</span>
<span class="linenos"> 987</span><span class="w">        </span><span class="cp">#endif</span>
<span class="linenos"> 988</span><span class="w">        </span><span class="n">PROF_CUDA_END</span><span class="p">(</span><span class="n">PROF_MPD_REACTION</span><span class="p">,</span><span class="n">cudaStream</span><span class="p">);</span>
<span class="linenos"> 989</span><span class="w">    </span><span class="p">}</span>
<span class="linenos"> 990</span>
<span class="linenos"> 991</span><span class="w">    </span><span class="c1">// Wait for the kernels to complete.</span>
<span class="linenos"> 992</span><span class="w">    </span><span class="n">PROF_BEGIN</span><span class="p">(</span><span class="n">PROF_MPD_SYNCHRONIZE</span><span class="p">);</span>
<span class="linenos"> 993</span><span class="w">    </span><span class="n">CUDA_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">cudaStreamSynchronize</span><span class="p">(</span><span class="n">cudaStream</span><span class="p">));</span>
<span class="linenos"> 994</span><span class="w">    </span><span class="n">PROF_END</span><span class="p">(</span><span class="n">PROF_MPD_SYNCHRONIZE</span><span class="p">);</span>
<span class="linenos"> 995</span>
<span class="linenos"> 996</span><span class="w">    </span><span class="c1">// Handle any particle overflows.</span>
<span class="linenos"> 997</span><span class="w">    </span><span class="n">PROF_BEGIN</span><span class="p">(</span><span class="n">PROF_MPD_OVERFLOW</span><span class="p">);</span>
<span class="linenos"> 998</span><span class="w">    </span>
<span class="linenos"> 999</span><span class="w">    </span><span class="n">overflowTimesteps</span><span class="o">++</span><span class="p">;</span>
<span class="linenos">1000</span><span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">overflowList</span><span class="p">[</span><span class="mi">1</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">TUNE_MPD_MAX_PARTICLE_OVERFLOWS</span><span class="p">];</span>
<span class="linenos">1001</span><span class="w">    </span><span class="n">CUDA_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">cudaMemcpy</span><span class="p">(</span><span class="n">overflowList</span><span class="p">,</span><span class="w"> </span><span class="n">cudaOverflowList</span><span class="p">,</span><span class="w"> </span><span class="n">MPD_OVERFLOW_LIST_SIZE</span><span class="p">,</span><span class="w"> </span><span class="n">cudaMemcpyDeviceToHost</span><span class="p">));</span>
<span class="linenos">1002</span><span class="w">    </span><span class="n">uint</span><span class="w"> </span><span class="n">numberExceptions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">overflowList</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="linenos">1003</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">numberExceptions</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">1004</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">1005</span><span class="w">        </span><span class="n">Print</span><span class="o">::</span><span class="n">printf</span><span class="p">(</span><span class="n">Print</span><span class="o">::</span><span class="n">DEBUG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;%d overflows&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">numberExceptions</span><span class="p">);</span>
<span class="linenos">1006</span><span class="w">        </span>
<span class="linenos">1007</span><span class="w">        </span><span class="c1">// Make sure we did not exceed the overflow buffer.</span>
<span class="linenos">1008</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">numberExceptions</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">TUNE_MPD_MAX_PARTICLE_OVERFLOWS</span><span class="p">)</span>
<span class="linenos">1009</span><span class="w">            </span><span class="n">throw</span><span class="w"> </span><span class="n">Exception</span><span class="p">(</span><span class="s">&quot;Too many particle overflows for the available buffer&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">numberExceptions</span><span class="p">);</span>
<span class="linenos">1010</span><span class="w">            </span>
<span class="linenos">1011</span><span class="w">        </span><span class="c1">// Synchronize the lattice.</span>
<span class="linenos">1012</span><span class="w">        </span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">copyFromGPU</span><span class="p">();</span>
<span class="linenos">1013</span><span class="w">        </span>
<span class="linenos">1014</span><span class="w">        </span><span class="c1">// Go through each exception.</span>
<span class="linenos">1015</span><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">numberExceptions</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">1016</span><span class="w">        </span><span class="p">{</span>
<span class="linenos">1017</span><span class="w">            </span><span class="c1">// Extract the index and particle type.</span>
<span class="linenos">1018</span><span class="w">            </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">latticeIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">overflowList</span><span class="p">[(</span><span class="n">i</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
<span class="linenos">1019</span><span class="w">            </span><span class="n">particle_t</span><span class="w"> </span><span class="n">particle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">overflowList</span><span class="p">[(</span><span class="n">i</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="mi">2</span><span class="p">];</span>
<span class="linenos">1020</span><span class="w">            </span>
<span class="linenos">1021</span><span class="w">            </span><span class="c1">// Get the x, y, and z coordiantes.</span>
<span class="linenos">1022</span><span class="w">            </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">latticeIndex</span><span class="o">%</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getXSize</span><span class="p">();</span>
<span class="linenos">1023</span><span class="w">            </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">latticeIndex</span><span class="o">/</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getXSize</span><span class="p">())</span><span class="o">%</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getYSize</span><span class="p">();</span>
<span class="linenos">1024</span><span class="w">            </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">latticeIndex</span><span class="o">/</span><span class="p">(</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getXSize</span><span class="p">()</span><span class="o">*</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getYSize</span><span class="p">());</span>
<span class="linenos">1025</span><span class="w">            </span>
<span class="linenos">1026</span><span class="w">            </span><span class="c1">// Put the particles back into a nearby lattice site.</span>
<span class="linenos">1027</span><span class="w">            </span><span class="kt">bool</span><span class="w"> </span><span class="n">replacedParticle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="linenos">1028</span><span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">searchRadius</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="o">!</span><span class="n">replacedParticle</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">searchRadius</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">TUNE_MPD_MAX_OVERFLOW_REPLACEMENT_DIST</span><span class="p">;</span><span class="w"> </span><span class="n">searchRadius</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">1029</span><span class="w">            </span><span class="p">{</span>
<span class="linenos">1030</span><span class="w">                </span><span class="c1">// Get the nearby sites.</span>
<span class="linenos">1031</span><span class="w">                </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">lattice_coord_t</span><span class="o">&gt;</span><span class="w"> </span><span class="n">sites</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getNearbySites</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">,(</span><span class="n">searchRadius</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span><span class="o">?</span><span class="n">searchRadius</span><span class="mi">-1</span><span class="o">:</span><span class="mi">0</span><span class="p">,</span><span class="n">searchRadius</span><span class="p">);</span>
<span class="linenos">1032</span><span class="w">                </span>
<span class="linenos">1033</span><span class="w">                </span><span class="c1">// TODO: Shuffle the sites.</span>
<span class="linenos">1034</span><span class="w">                </span>
<span class="linenos">1035</span><span class="w">                </span><span class="c1">// Try to find one that in not fully occupied and of the same type.</span>
<span class="linenos">1036</span><span class="w">                </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">lattice_coord_t</span><span class="o">&gt;::</span><span class="n">iterator</span><span class="w"> </span><span class="n">it</span><span class="o">=</span><span class="n">sites</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span><span class="w"> </span><span class="n">it</span><span class="o">&lt;</span><span class="n">sites</span><span class="p">.</span><span class="n">end</span><span class="p">();</span><span class="w"> </span><span class="n">it</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">1037</span><span class="w">                </span><span class="p">{</span>
<span class="linenos">1038</span><span class="w">                    </span><span class="n">lattice_coord_t</span><span class="w"> </span><span class="n">site</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">it</span><span class="p">;</span>
<span class="linenos">1039</span><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getOccupancy</span><span class="p">(</span><span class="n">site</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="n">site</span><span class="p">.</span><span class="n">y</span><span class="p">,</span><span class="n">site</span><span class="p">.</span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getMaxOccupancy</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getSiteType</span><span class="p">(</span><span class="n">site</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="n">site</span><span class="p">.</span><span class="n">y</span><span class="p">,</span><span class="n">site</span><span class="p">.</span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getSiteType</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">))</span>
<span class="linenos">1040</span><span class="w">                    </span><span class="p">{</span>
<span class="linenos">1041</span><span class="w">                        </span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">addParticle</span><span class="p">(</span><span class="n">site</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">site</span><span class="p">.</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">site</span><span class="p">.</span><span class="n">z</span><span class="p">,</span><span class="w"> </span><span class="n">particle</span><span class="p">);</span>
<span class="linenos">1042</span><span class="w">                        </span><span class="n">replacedParticle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="linenos">1043</span><span class="w">                        </span><span class="n">Print</span><span class="o">::</span><span class="n">printf</span><span class="p">(</span><span class="n">Print</span><span class="o">::</span><span class="n">VERBOSE_DEBUG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Handled overflow of particle %d at site %d,%d,%d type=%d occ=%d by placing at site %d,%d,%d type=%d newocc=%d dist=%0.2f&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">particle</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">z</span><span class="p">,</span><span class="w"> </span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getSiteType</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">),</span><span class="w"> </span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getOccupancy</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">),</span><span class="w"> </span><span class="n">site</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">site</span><span class="p">.</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">site</span><span class="p">.</span><span class="n">z</span><span class="p">,</span><span class="w"> </span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getSiteType</span><span class="p">(</span><span class="n">site</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="n">site</span><span class="p">.</span><span class="n">y</span><span class="p">,</span><span class="n">site</span><span class="p">.</span><span class="n">z</span><span class="p">),</span><span class="w"> </span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getOccupancy</span><span class="p">(</span><span class="n">site</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="n">site</span><span class="p">.</span><span class="n">y</span><span class="p">,</span><span class="n">site</span><span class="p">.</span><span class="n">z</span><span class="p">),</span><span class="w"> </span><span class="n">sqrt</span><span class="p">(</span><span class="n">pow</span><span class="p">((</span><span class="kt">double</span><span class="p">)</span><span class="n">x</span><span class="o">-</span><span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="n">site</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="mf">2.0</span><span class="p">)</span><span class="o">+</span><span class="n">pow</span><span class="p">((</span><span class="kt">double</span><span class="p">)</span><span class="n">y</span><span class="o">-</span><span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="n">site</span><span class="p">.</span><span class="n">y</span><span class="p">,</span><span class="mf">2.0</span><span class="p">)</span><span class="o">+</span><span class="n">pow</span><span class="p">((</span><span class="kt">double</span><span class="p">)</span><span class="n">z</span><span class="o">-</span><span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="n">site</span><span class="p">.</span><span class="n">z</span><span class="p">,</span><span class="mf">2.0</span><span class="p">)));</span>
<span class="linenos">1044</span><span class="w">                        </span><span class="k">break</span><span class="p">;</span>
<span class="linenos">1045</span><span class="w">                    </span><span class="p">}</span>
<span class="linenos">1046</span><span class="w">                </span><span class="p">}</span>
<span class="linenos">1047</span><span class="w">            </span><span class="p">}</span>
<span class="linenos">1048</span><span class="w">            </span>
<span class="linenos">1049</span><span class="w">            </span><span class="c1">// If we were not able to fix the exception, throw an error.</span>
<span class="linenos">1050</span><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">replacedParticle</span><span class="p">)</span>
<span class="linenos">1051</span><span class="w">                </span><span class="n">throw</span><span class="w"> </span><span class="n">Exception</span><span class="p">(</span><span class="s">&quot;Unable to find an available site to handle a particle overflow.&quot;</span><span class="p">);</span>
<span class="linenos">1052</span><span class="w">        </span><span class="p">}</span>
<span class="linenos">1053</span><span class="w">        </span>
<span class="linenos">1054</span><span class="w">            </span>
<span class="linenos">1055</span><span class="w">        </span><span class="c1">// Copy the changes back to the GPU.</span>
<span class="linenos">1056</span><span class="w">        </span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">copyToGPU</span><span class="p">();</span>
<span class="linenos">1057</span><span class="w">            </span>
<span class="linenos">1058</span><span class="w">        </span><span class="c1">// Reset the overflow list.</span>
<span class="linenos">1059</span><span class="w">        </span><span class="n">CUDA_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">cudaMemset</span><span class="p">(</span><span class="n">cudaOverflowList</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">MPD_OVERFLOW_LIST_SIZE</span><span class="p">));</span>
<span class="linenos">1060</span><span class="w">        </span>
<span class="linenos">1061</span><span class="w">        </span><span class="c1">// Track that we used the overflow list.</span>
<span class="linenos">1062</span><span class="w">        </span><span class="n">overflowListUses</span><span class="o">++</span><span class="p">;</span>
<span class="linenos">1063</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">1064</span><span class="w">    </span>
<span class="linenos">1065</span><span class="w">    </span><span class="c1">// If the overflow lsit is being used too often, print a warning.</span>
<span class="linenos">1066</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">overflowTimesteps</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">1000</span><span class="p">)</span>
<span class="linenos">1067</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">1068</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">overflowListUses</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">10</span><span class="p">)</span>
<span class="linenos">1069</span><span class="w">            </span><span class="n">Print</span><span class="o">::</span><span class="n">printf</span><span class="p">(</span><span class="n">Print</span><span class="o">::</span><span class="n">WARNING</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;%d uses of the particle overflow list in the last 1000 timesteps, performance may be degraded.&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">overflowListUses</span><span class="p">);</span>
<span class="linenos">1070</span><span class="w">        </span><span class="n">overflowTimesteps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">1071</span><span class="w">        </span><span class="n">overflowListUses</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">1072</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">1073</span><span class="w">    </span><span class="n">PROF_END</span><span class="p">(</span><span class="n">PROF_MPD_OVERFLOW</span><span class="p">);</span>
<span class="linenos">1074</span>
<span class="linenos">1075</span><span class="w">    </span><span class="n">PROF_CUDA_FINISH</span><span class="p">(</span><span class="n">cudaStream</span><span class="p">);</span>
<span class="linenos">1076</span><span class="w">    </span><span class="n">PROF_END</span><span class="p">(</span><span class="n">PROF_MPD_TIMESTEP</span><span class="p">);</span>
<span class="linenos">1077</span><span class="p">}</span>
<span class="linenos">1078</span>
<span class="linenos">1079</span><span class="cp">#ifdef MPD_CUDA_3D_GRID_LAUNCH</span>
<span class="linenos">1080</span><span class="cm">/**</span>
<span class="linenos">1081</span><span class="cm"> * Gets the launch parameters for launching an x diffusion kernel.</span>
<span class="linenos">1082</span><span class="cm"> */</span>
<span class="linenos">1083</span><span class="kt">void</span><span class="w"> </span><span class="n">IntMpdRdmeSolver</span><span class="o">::</span><span class="n">calculateXLaunchParameters</span><span class="p">(</span><span class="kt">dim3</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">gridSize</span><span class="p">,</span><span class="w"> </span><span class="kt">dim3</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">threadBlockSize</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">maxXBlockSize</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeXSize</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeYSize</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeZSize</span><span class="p">)</span>
<span class="linenos">1084</span><span class="p">{</span>
<span class="linenos">1085</span><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">xBlockXSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">min</span><span class="p">(</span><span class="n">maxXBlockSize</span><span class="p">,</span><span class="n">latticeXSize</span><span class="p">);</span>
<span class="linenos">1086</span><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">gridXSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">latticeXSize</span><span class="o">/</span><span class="n">xBlockXSize</span><span class="p">;</span>
<span class="linenos">1087</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">gridXSize</span><span class="o">*</span><span class="n">xBlockXSize</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">latticeXSize</span><span class="p">)</span>
<span class="linenos">1088</span><span class="w">	</span><span class="p">{</span>
<span class="linenos">1089</span><span class="w">		</span><span class="c1">// Find the largest number of warps that is divisible</span>
<span class="linenos">1090</span><span class="w">		</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">tryx</span><span class="o">=</span><span class="mi">32</span><span class="p">;</span>
<span class="linenos">1091</span><span class="w">		</span><span class="k">while</span><span class="p">(</span><span class="n">tryx</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">maxXBlockSize</span><span class="p">)</span>
<span class="linenos">1092</span><span class="w">		</span><span class="p">{</span>
<span class="linenos">1093</span><span class="w">			</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">latticeXSize</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">tryx</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">1094</span><span class="w">				</span><span class="n">xBlockXSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tryx</span><span class="p">;</span>
<span class="linenos">1095</span><span class="w">			</span><span class="n">tryx</span><span class="w"> </span><span class="o">+=</span><span class="mi">32</span><span class="p">;</span>
<span class="linenos">1096</span><span class="w">		</span><span class="p">}</span>
<span class="linenos">1097</span><span class="w">		</span><span class="n">gridXSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">latticeXSize</span><span class="o">/</span><span class="n">xBlockXSize</span><span class="p">;</span>
<span class="linenos">1098</span><span class="w">	</span><span class="p">}</span>
<span class="linenos">1099</span><span class="w">			</span>
<span class="linenos">1100</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">gridSize</span><span class="p">).</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gridXSize</span><span class="p">;</span>
<span class="linenos">1101</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">gridSize</span><span class="p">).</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">latticeYSize</span><span class="p">;</span>
<span class="linenos">1102</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">gridSize</span><span class="p">).</span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">latticeZSize</span><span class="p">;</span>
<span class="linenos">1103</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">threadBlockSize</span><span class="p">).</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">xBlockXSize</span><span class="p">;</span>
<span class="linenos">1104</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">threadBlockSize</span><span class="p">).</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="linenos">1105</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">threadBlockSize</span><span class="p">).</span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="linenos">1106</span><span class="p">}</span>
<span class="linenos">1107</span>
<span class="linenos">1108</span><span class="cm">/**</span>
<span class="linenos">1109</span><span class="cm"> * Gets the launch parameters for launching a y diffusion kernel.</span>
<span class="linenos">1110</span><span class="cm"> */</span>
<span class="linenos">1111</span><span class="kt">void</span><span class="w"> </span><span class="n">IntMpdRdmeSolver</span><span class="o">::</span><span class="n">calculateYLaunchParameters</span><span class="p">(</span><span class="kt">dim3</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">gridSize</span><span class="p">,</span><span class="w"> </span><span class="kt">dim3</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">threadBlockSize</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">blockXSize</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">blockYSize</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeXSize</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeYSize</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeZSize</span><span class="p">)</span>
<span class="linenos">1112</span><span class="p">{</span>
<span class="linenos">1113</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">gridSize</span><span class="p">).</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">latticeXSize</span><span class="o">/</span><span class="n">blockXSize</span><span class="p">;</span>
<span class="linenos">1114</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">gridSize</span><span class="p">).</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">latticeYSize</span><span class="o">/</span><span class="n">blockYSize</span><span class="p">;</span>
<span class="linenos">1115</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">gridSize</span><span class="p">).</span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">latticeZSize</span><span class="p">;</span>
<span class="linenos">1116</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">threadBlockSize</span><span class="p">).</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blockXSize</span><span class="p">;</span>
<span class="linenos">1117</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">threadBlockSize</span><span class="p">).</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blockYSize</span><span class="p">;</span>
<span class="linenos">1118</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">threadBlockSize</span><span class="p">).</span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="linenos">1119</span><span class="p">}</span>
<span class="linenos">1120</span>
<span class="linenos">1121</span><span class="cm">/**</span>
<span class="linenos">1122</span><span class="cm"> * Gets the launch parameters for launching a z diffusion kernel.</span>
<span class="linenos">1123</span><span class="cm"> */</span>
<span class="linenos">1124</span><span class="kt">void</span><span class="w"> </span><span class="n">IntMpdRdmeSolver</span><span class="o">::</span><span class="n">calculateZLaunchParameters</span><span class="p">(</span><span class="kt">dim3</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">gridSize</span><span class="p">,</span><span class="w"> </span><span class="kt">dim3</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">threadBlockSize</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">blockXSize</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">blockZSize</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeXSize</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeYSize</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeZSize</span><span class="p">)</span>
<span class="linenos">1125</span><span class="p">{</span>
<span class="linenos">1126</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">gridSize</span><span class="p">).</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">latticeXSize</span><span class="o">/</span><span class="n">blockXSize</span><span class="p">;</span>
<span class="linenos">1127</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">gridSize</span><span class="p">).</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">latticeYSize</span><span class="p">;</span>
<span class="linenos">1128</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">gridSize</span><span class="p">).</span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">latticeZSize</span><span class="o">/</span><span class="n">blockZSize</span><span class="p">;</span>
<span class="linenos">1129</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">threadBlockSize</span><span class="p">).</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blockXSize</span><span class="p">;</span>
<span class="linenos">1130</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">threadBlockSize</span><span class="p">).</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="linenos">1131</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">threadBlockSize</span><span class="p">).</span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blockZSize</span><span class="p">;</span>
<span class="linenos">1132</span><span class="p">}</span>
<span class="linenos">1133</span>
<span class="linenos">1134</span><span class="cm">/**</span>
<span class="linenos">1135</span><span class="cm"> * Gets the launch parameters for launching a y diffusion kernel.</span>
<span class="linenos">1136</span><span class="cm"> */</span>
<span class="linenos">1137</span><span class="kt">void</span><span class="w"> </span><span class="n">IntMpdRdmeSolver</span><span class="o">::</span><span class="n">calculateReactionLaunchParameters</span><span class="p">(</span><span class="kt">dim3</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">gridSize</span><span class="p">,</span><span class="w"> </span><span class="kt">dim3</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">threadBlockSize</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">blockXSize</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">blockYSize</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeXSize</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeYSize</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeZSize</span><span class="p">)</span>
<span class="linenos">1138</span><span class="p">{</span>
<span class="linenos">1139</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">gridSize</span><span class="p">).</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">latticeXSize</span><span class="o">/</span><span class="n">blockXSize</span><span class="p">;</span>
<span class="linenos">1140</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">gridSize</span><span class="p">).</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">latticeYSize</span><span class="o">/</span><span class="n">blockYSize</span><span class="p">;</span>
<span class="linenos">1141</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">gridSize</span><span class="p">).</span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">latticeZSize</span><span class="p">;</span>
<span class="linenos">1142</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">threadBlockSize</span><span class="p">).</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blockXSize</span><span class="p">;</span>
<span class="linenos">1143</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">threadBlockSize</span><span class="p">).</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blockYSize</span><span class="p">;</span>
<span class="linenos">1144</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">threadBlockSize</span><span class="p">).</span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="linenos">1145</span><span class="p">}</span>
<span class="linenos">1146</span>
<span class="linenos">1147</span><span class="cp">#else</span>
<span class="linenos">1148</span><span class="cm">/**</span>
<span class="linenos">1149</span><span class="cm"> * Gets the launch parameters for launching an x diffusion kernel.</span>
<span class="linenos">1150</span><span class="cm"> */</span>
<span class="linenos">1151</span><span class="kt">void</span><span class="w"> </span><span class="n">IntMpdRdmeSolver</span><span class="o">::</span><span class="n">calculateXLaunchParameters</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">gridXSize</span><span class="p">,</span><span class="w"> </span><span class="kt">dim3</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">gridSize</span><span class="p">,</span><span class="w"> </span><span class="kt">dim3</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">threadBlockSize</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">maxXBlockSize</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeXSize</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeYSize</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeZSize</span><span class="p">)</span>
<span class="linenos">1152</span><span class="p">{</span>
<span class="linenos">1153</span><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">xBlockXSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">min</span><span class="p">(</span><span class="n">maxXBlockSize</span><span class="p">,</span><span class="n">latticeXSize</span><span class="p">);</span>
<span class="linenos">1154</span><span class="w">    </span><span class="o">*</span><span class="n">gridXSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">latticeXSize</span><span class="o">/</span><span class="n">xBlockXSize</span><span class="p">;</span>
<span class="linenos">1155</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">gridXSize</span><span class="o">*</span><span class="n">xBlockXSize</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">latticeXSize</span><span class="p">)</span>
<span class="linenos">1156</span><span class="w">	</span><span class="p">{</span>
<span class="linenos">1157</span><span class="w">		</span><span class="c1">// Find the largest number of warps that is divisible</span>
<span class="linenos">1158</span><span class="w">		</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">tryx</span><span class="o">=</span><span class="mi">32</span><span class="p">;</span>
<span class="linenos">1159</span><span class="w">		</span><span class="k">while</span><span class="p">(</span><span class="n">tryx</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">maxXBlockSize</span><span class="p">)</span>
<span class="linenos">1160</span><span class="w">		</span><span class="p">{</span>
<span class="linenos">1161</span><span class="w">			</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">latticeXSize</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">tryx</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">1162</span><span class="w">				</span><span class="n">xBlockXSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tryx</span><span class="p">;</span>
<span class="linenos">1163</span><span class="w">			</span><span class="n">tryx</span><span class="w"> </span><span class="o">+=</span><span class="mi">32</span><span class="p">;</span>
<span class="linenos">1164</span><span class="w">		</span><span class="p">}</span>
<span class="linenos">1165</span><span class="w">		</span><span class="n">gridXSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">latticeXSize</span><span class="o">/</span><span class="n">xBlockXSize</span><span class="p">;</span>
<span class="linenos">1166</span><span class="w">	</span><span class="p">}</span>
<span class="linenos">1167</span>
<span class="linenos">1168</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">gridSize</span><span class="p">).</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">gridXSize</span><span class="p">)</span><span class="o">*</span><span class="n">latticeYSize</span><span class="p">;</span>
<span class="linenos">1169</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">gridSize</span><span class="p">).</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">latticeZSize</span><span class="p">;</span>
<span class="linenos">1170</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">gridSize</span><span class="p">).</span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="linenos">1171</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">threadBlockSize</span><span class="p">).</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">xBlockXSize</span><span class="p">;</span>
<span class="linenos">1172</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">threadBlockSize</span><span class="p">).</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="linenos">1173</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">threadBlockSize</span><span class="p">).</span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="linenos">1174</span><span class="p">}</span>
<span class="linenos">1175</span>
<span class="linenos">1176</span><span class="cm">/**</span>
<span class="linenos">1177</span><span class="cm"> * Gets the launch parameters for launching a y diffusion kernel.</span>
<span class="linenos">1178</span><span class="cm"> */</span>
<span class="linenos">1179</span><span class="kt">void</span><span class="w"> </span><span class="n">IntMpdRdmeSolver</span><span class="o">::</span><span class="n">calculateYLaunchParameters</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">gridXSize</span><span class="p">,</span><span class="w"> </span><span class="kt">dim3</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">gridSize</span><span class="p">,</span><span class="w"> </span><span class="kt">dim3</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">threadBlockSize</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">blockXSize</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">blockYSize</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeXSize</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeYSize</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeZSize</span><span class="p">)</span>
<span class="linenos">1180</span><span class="p">{</span>
<span class="linenos">1181</span><span class="w">    </span><span class="o">*</span><span class="n">gridXSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">latticeXSize</span><span class="o">/</span><span class="n">blockXSize</span><span class="p">;</span>
<span class="linenos">1182</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">gridSize</span><span class="p">).</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">gridXSize</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">latticeYSize</span><span class="o">/</span><span class="n">blockYSize</span><span class="p">);</span>
<span class="linenos">1183</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">gridSize</span><span class="p">).</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">latticeZSize</span><span class="p">;</span>
<span class="linenos">1184</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">gridSize</span><span class="p">).</span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="linenos">1185</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">threadBlockSize</span><span class="p">).</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blockXSize</span><span class="p">;</span>
<span class="linenos">1186</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">threadBlockSize</span><span class="p">).</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blockYSize</span><span class="p">;</span>
<span class="linenos">1187</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">threadBlockSize</span><span class="p">).</span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="linenos">1188</span><span class="p">}</span>
<span class="linenos">1189</span>
<span class="linenos">1190</span><span class="cm">/**</span>
<span class="linenos">1191</span><span class="cm"> * Gets the launch parameters for launching a z diffusion kernel.</span>
<span class="linenos">1192</span><span class="cm"> */</span>
<span class="linenos">1193</span><span class="kt">void</span><span class="w"> </span><span class="n">IntMpdRdmeSolver</span><span class="o">::</span><span class="n">calculateZLaunchParameters</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">gridXSize</span><span class="p">,</span><span class="w"> </span><span class="kt">dim3</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">gridSize</span><span class="p">,</span><span class="w"> </span><span class="kt">dim3</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">threadBlockSize</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">blockXSize</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">blockZSize</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeXSize</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeYSize</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeZSize</span><span class="p">)</span>
<span class="linenos">1194</span><span class="p">{</span>
<span class="linenos">1195</span><span class="w">    </span><span class="o">*</span><span class="n">gridXSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">latticeXSize</span><span class="o">/</span><span class="n">blockXSize</span><span class="p">;</span>
<span class="linenos">1196</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">gridSize</span><span class="p">).</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">gridXSize</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">latticeYSize</span><span class="p">);</span>
<span class="linenos">1197</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">gridSize</span><span class="p">).</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">latticeZSize</span><span class="o">/</span><span class="n">blockZSize</span><span class="p">;</span>
<span class="linenos">1198</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">gridSize</span><span class="p">).</span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="linenos">1199</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">threadBlockSize</span><span class="p">).</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blockXSize</span><span class="p">;</span>
<span class="linenos">1200</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">threadBlockSize</span><span class="p">).</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="linenos">1201</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">threadBlockSize</span><span class="p">).</span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blockZSize</span><span class="p">;</span>
<span class="linenos">1202</span><span class="p">}</span>
<span class="linenos">1203</span>
<span class="linenos">1204</span><span class="cm">/**</span>
<span class="linenos">1205</span><span class="cm"> * Gets the launch parameters for launching a reaction diffusion kernel.</span>
<span class="linenos">1206</span><span class="cm"> */</span>
<span class="linenos">1207</span><span class="kt">void</span><span class="w"> </span><span class="n">IntMpdRdmeSolver</span><span class="o">::</span><span class="n">calculateReactionLaunchParameters</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">gridXSize</span><span class="p">,</span><span class="w"> </span><span class="kt">dim3</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">gridSize</span><span class="p">,</span><span class="w"> </span><span class="kt">dim3</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">threadBlockSize</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">blockXSize</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">blockYSize</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeXSize</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeYSize</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeZSize</span><span class="p">)</span>
<span class="linenos">1208</span><span class="p">{</span>
<span class="linenos">1209</span><span class="w">    </span><span class="o">*</span><span class="n">gridXSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">latticeXSize</span><span class="o">/</span><span class="n">blockXSize</span><span class="p">;</span>
<span class="linenos">1210</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">gridSize</span><span class="p">).</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">gridXSize</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">latticeYSize</span><span class="o">/</span><span class="n">blockYSize</span><span class="p">);</span>
<span class="linenos">1211</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">gridSize</span><span class="p">).</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">latticeZSize</span><span class="p">;</span>
<span class="linenos">1212</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">gridSize</span><span class="p">).</span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="linenos">1213</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">threadBlockSize</span><span class="p">).</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blockXSize</span><span class="p">;</span>
<span class="linenos">1214</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">threadBlockSize</span><span class="p">).</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blockYSize</span><span class="p">;</span>
<span class="linenos">1215</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">threadBlockSize</span><span class="p">).</span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="linenos">1216</span><span class="p">}</span>
<span class="linenos">1217</span><span class="cp">#endif</span>
<span class="linenos">1218</span>
<span class="linenos">1219</span>
<span class="linenos">1220</span><span class="n">namespace</span><span class="w"> </span><span class="n">intmpdrdme_dev</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">1221</span><span class="cm">/**</span>
<span class="linenos">1222</span><span class="cm"> * Multiparticle diffusion performed by copying the lattice section to shared memory, making a choice for each lattice</span>
<span class="linenos">1223</span><span class="cm"> * site, storing the new lattice into shared memory, and then updating the global lattice.</span>
<span class="linenos">1224</span><span class="cm"> */</span>
<span class="linenos">1225</span><span class="cp">#ifdef MPD_CUDA_3D_GRID_LAUNCH</span>
<span class="linenos">1226</span><span class="kr">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">__launch_bounds__</span><span class="p">(</span><span class="n">TUNE_MPD_X_BLOCK_MAX_X_SIZE</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="n">mpd_x_kernel</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">inLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">inSites</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">outLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">)</span>
<span class="linenos">1227</span><span class="p">{</span>
<span class="linenos">1228</span><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">bx</span><span class="o">=</span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">by</span><span class="o">=</span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">bz</span><span class="o">=</span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">z</span><span class="p">;</span>
<span class="linenos">1229</span><span class="cp">#else</span>
<span class="linenos">1230</span><span class="kr">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">__launch_bounds__</span><span class="p">(</span><span class="n">TUNE_MPD_X_BLOCK_MAX_X_SIZE</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="n">mpd_x_kernel</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">inLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">inSites</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">outLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">gridXSize</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">)</span>
<span class="linenos">1231</span><span class="p">{</span>
<span class="linenos">1232</span><span class="w">    </span><span class="kt">__shared__</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">bx</span><span class="p">,</span><span class="w"> </span><span class="n">by</span><span class="p">,</span><span class="w"> </span><span class="n">bz</span><span class="p">;</span>
<span class="linenos">1233</span><span class="w">    </span><span class="n">calculateBlockPosition</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bx</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">by</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">bz</span><span class="p">,</span><span class="w"> </span><span class="n">gridXSize</span><span class="p">);</span>
<span class="linenos">1234</span><span class="cp">#endif</span>
<span class="linenos">1235</span>
<span class="linenos">1236</span><span class="w">    </span><span class="c1">// Figure out the offset of this thread in the lattice and the lattice segment.</span>
<span class="linenos">1237</span><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeXIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">bx</span><span class="o">*</span><span class="nb">blockDim</span><span class="p">.</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
<span class="linenos">1238</span><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">bz</span><span class="o">*</span><span class="n">latticeXYSizeC</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">by</span><span class="o">*</span><span class="n">latticeXSizeC</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">latticeXIndex</span><span class="p">;</span>
<span class="linenos">1239</span><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">windowIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="o">+</span><span class="n">MPD_APRON_SIZE</span><span class="p">;</span>
<span class="linenos">1240</span>
<span class="linenos">1241</span><span class="w">    </span><span class="c1">///////////////////////////////////////////</span>
<span class="linenos">1242</span><span class="w">    </span><span class="c1">// Load the lattice into shared memory. //</span>
<span class="linenos">1243</span><span class="w">    </span><span class="c1">///////////////////////////////////////////</span>
<span class="linenos">1244</span>
<span class="linenos">1245</span><span class="w">    </span><span class="c1">// Shared memory to store the lattice segment.</span>
<span class="linenos">1246</span><span class="w">    </span><span class="kt">__shared__</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">window</span><span class="p">[</span><span class="n">MPD_X_WINDOW_SIZE</span><span class="o">*</span><span class="n">MPD_WORDS_PER_SITE</span><span class="p">];</span>
<span class="linenos">1247</span><span class="w">    </span><span class="kt">__shared__</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">sitesWindow</span><span class="p">[</span><span class="n">MPD_X_WINDOW_SIZE</span><span class="p">];</span>
<span class="linenos">1248</span>
<span class="linenos">1249</span><span class="w">    </span><span class="c1">// Copy the x window from device memory into shared memory.</span>
<span class="linenos">1250</span><span class="w">    </span><span class="n">copyXWindowFromLattice</span><span class="p">(</span><span class="n">bx</span><span class="p">,</span><span class="w"> </span><span class="n">inLattice</span><span class="p">,</span><span class="w"> </span><span class="n">window</span><span class="p">,</span><span class="w"> </span><span class="n">latticeIndex</span><span class="p">,</span><span class="w"> </span><span class="n">latticeXIndex</span><span class="p">,</span><span class="w"> </span><span class="n">windowIndex</span><span class="p">);</span>
<span class="linenos">1251</span><span class="w">    </span><span class="n">copyXWindowFromSites</span><span class="p">(</span><span class="n">bx</span><span class="p">,</span><span class="w"> </span><span class="n">inSites</span><span class="p">,</span><span class="w"> </span><span class="n">sitesWindow</span><span class="p">,</span><span class="w"> </span><span class="n">latticeIndex</span><span class="p">,</span><span class="w"> </span><span class="n">latticeXIndex</span><span class="p">,</span><span class="w"> </span><span class="n">windowIndex</span><span class="p">);</span>
<span class="linenos">1252</span><span class="w">    </span><span class="nf">__syncthreads</span><span class="p">();</span>
<span class="linenos">1253</span>
<span class="linenos">1254</span><span class="w">    </span><span class="c1">////////////////////////////////////////</span>
<span class="linenos">1255</span><span class="w">    </span><span class="c1">// Make the choice for each particle. //</span>
<span class="linenos">1256</span><span class="w">    </span><span class="c1">////////////////////////////////////////</span>
<span class="linenos">1257</span>
<span class="linenos">1258</span><span class="w">    </span><span class="kt">__shared__</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">choices</span><span class="p">[</span><span class="n">MPD_X_WINDOW_SIZE</span><span class="o">*</span><span class="n">MPD_WORDS_PER_SITE</span><span class="p">];</span>
<span class="linenos">1259</span>
<span class="linenos">1260</span><span class="w">    </span><span class="c1">// Make the choices.</span>
<span class="linenos">1261</span><span class="w">    </span><span class="n">makeXDiffusionChoices</span><span class="p">(</span><span class="n">window</span><span class="p">,</span><span class="w"> </span><span class="n">sitesWindow</span><span class="p">,</span><span class="w"> </span><span class="n">choices</span><span class="p">,</span><span class="w"> </span><span class="n">latticeIndex</span><span class="p">,</span><span class="w"> </span><span class="n">latticeXIndex</span><span class="p">,</span><span class="w"> </span><span class="n">windowIndex</span><span class="p">,</span><span class="w"> </span><span class="nb">blockDim</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">);</span>
<span class="linenos">1262</span><span class="w">    </span><span class="nf">__syncthreads</span><span class="p">();</span>
<span class="linenos">1263</span>
<span class="linenos">1264</span><span class="w">    </span><span class="c1">//////////////////////////////////////////////////////////</span>
<span class="linenos">1265</span><span class="w">    </span><span class="c1">// Create version of the lattice at the next time step. //</span>
<span class="linenos">1266</span><span class="w">    </span><span class="c1">//////////////////////////////////////////////////////////</span>
<span class="linenos">1267</span>
<span class="linenos">1268</span><span class="w">    </span><span class="c1">// Propagate the choices to the new lattice segment.</span>
<span class="linenos">1269</span><span class="w">    </span><span class="n">performPropagation</span><span class="p">(</span><span class="n">outLattice</span><span class="p">,</span><span class="w"> </span><span class="n">window</span><span class="p">,</span><span class="w"> </span><span class="n">choices</span><span class="p">,</span><span class="w"> </span><span class="n">latticeIndex</span><span class="p">,</span><span class="w"> </span><span class="n">windowIndex</span><span class="mi">-1</span><span class="p">,</span><span class="w"> </span><span class="n">windowIndex</span><span class="p">,</span><span class="w"> </span><span class="n">windowIndex</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">MPD_X_WINDOW_SIZE</span><span class="p">,</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">);</span>
<span class="linenos">1270</span><span class="p">}</span>
<span class="linenos">1271</span>
<span class="linenos">1272</span><span class="cm">/**</span>
<span class="linenos">1273</span><span class="cm"> * Multiparticle diffusion performed by copying the lattice section to shared memory, making a choice for each lattice</span>
<span class="linenos">1274</span><span class="cm"> * site, storing the new lattice into shared memory, and then updating the global lattice.</span>
<span class="linenos">1275</span><span class="cm"> */</span>
<span class="linenos">1276</span><span class="cp">#ifdef MPD_CUDA_3D_GRID_LAUNCH</span>
<span class="linenos">1277</span><span class="kr">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">__launch_bounds__</span><span class="p">(</span><span class="n">TUNE_MPD_Y_BLOCK_X_SIZE</span><span class="o">*</span><span class="n">TUNE_MPD_Y_BLOCK_Y_SIZE</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="n">mpd_y_kernel</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">inLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">inSites</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">outLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">)</span>
<span class="linenos">1278</span><span class="p">{</span>
<span class="linenos">1279</span><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">bx</span><span class="o">=</span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">by</span><span class="o">=</span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">bz</span><span class="o">=</span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">z</span><span class="p">;</span>
<span class="linenos">1280</span><span class="cp">#else</span>
<span class="linenos">1281</span><span class="kr">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">__launch_bounds__</span><span class="p">(</span><span class="n">TUNE_MPD_Y_BLOCK_X_SIZE</span><span class="o">*</span><span class="n">TUNE_MPD_Y_BLOCK_Y_SIZE</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="n">mpd_y_kernel</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">inLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">inSites</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">outLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">gridXSize</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">)</span>
<span class="linenos">1282</span><span class="p">{</span>
<span class="linenos">1283</span><span class="w">    </span><span class="kt">__shared__</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">bx</span><span class="p">,</span><span class="w"> </span><span class="n">by</span><span class="p">,</span><span class="w"> </span><span class="n">bz</span><span class="p">;</span>
<span class="linenos">1284</span><span class="w">    </span><span class="n">calculateBlockPosition</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bx</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">by</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">bz</span><span class="p">,</span><span class="w"> </span><span class="n">gridXSize</span><span class="p">);</span>
<span class="linenos">1285</span><span class="cp">#endif</span>
<span class="linenos">1286</span>
<span class="linenos">1287</span><span class="w">    </span><span class="c1">// Figure out the offset of this thread in the lattice and the lattice segment.</span>
<span class="linenos">1288</span><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeYIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">by</span><span class="o">*</span><span class="nb">blockDim</span><span class="p">.</span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
<span class="linenos">1289</span><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">bz</span><span class="o">*</span><span class="n">latticeXYSizeC</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">latticeYIndex</span><span class="o">*</span><span class="n">latticeXSizeC</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">bx</span><span class="o">*</span><span class="nb">blockDim</span><span class="p">.</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
<span class="linenos">1290</span><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">windowYIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">y</span><span class="o">+</span><span class="n">MPD_APRON_SIZE</span><span class="p">;</span>
<span class="linenos">1291</span><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">windowIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">windowYIndex</span><span class="o">*</span><span class="nb">blockDim</span><span class="p">.</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
<span class="linenos">1292</span>
<span class="linenos">1293</span><span class="w">    </span><span class="c1">///////////////////////////////////////////</span>
<span class="linenos">1294</span><span class="w">    </span><span class="c1">// Load the lattice into shared memory. //</span>
<span class="linenos">1295</span><span class="w">    </span><span class="c1">///////////////////////////////////////////</span>
<span class="linenos">1296</span>
<span class="linenos">1297</span><span class="w">    </span><span class="c1">// Shared memory to store the lattice segment. Each lattice site has four particles, eight bits for each particle.</span>
<span class="linenos">1298</span><span class="w">    </span><span class="kt">__shared__</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">window</span><span class="p">[</span><span class="n">MPD_Y_WINDOW_SIZE</span><span class="o">*</span><span class="n">MPD_WORDS_PER_SITE</span><span class="p">];</span>
<span class="linenos">1299</span><span class="w">    </span><span class="kt">__shared__</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">sitesWindow</span><span class="p">[</span><span class="n">MPD_Y_WINDOW_SIZE</span><span class="p">];</span>
<span class="linenos">1300</span>
<span class="linenos">1301</span><span class="w">    </span><span class="c1">// Copy the x window from device memory into shared memory.</span>
<span class="linenos">1302</span><span class="w">    </span><span class="n">copyYWindowFromLattice</span><span class="p">(</span><span class="n">inLattice</span><span class="p">,</span><span class="w"> </span><span class="n">window</span><span class="p">,</span><span class="w"> </span><span class="n">latticeIndex</span><span class="p">,</span><span class="w"> </span><span class="n">latticeYIndex</span><span class="p">,</span><span class="w"> </span><span class="n">windowIndex</span><span class="p">,</span><span class="w"> </span><span class="n">windowYIndex</span><span class="p">);</span>
<span class="linenos">1303</span><span class="w">    </span><span class="n">copyYWindowFromSites</span><span class="p">(</span><span class="n">inSites</span><span class="p">,</span><span class="w"> </span><span class="n">sitesWindow</span><span class="p">,</span><span class="w"> </span><span class="n">latticeIndex</span><span class="p">,</span><span class="w"> </span><span class="n">latticeYIndex</span><span class="p">,</span><span class="w"> </span><span class="n">windowIndex</span><span class="p">,</span><span class="w"> </span><span class="n">windowYIndex</span><span class="p">);</span>
<span class="linenos">1304</span><span class="w">    </span><span class="nf">__syncthreads</span><span class="p">();</span>
<span class="linenos">1305</span>
<span class="linenos">1306</span><span class="w">    </span><span class="c1">////////////////////////////////////////</span>
<span class="linenos">1307</span><span class="w">    </span><span class="c1">// Make the choice for each particle. //</span>
<span class="linenos">1308</span><span class="w">    </span><span class="c1">////////////////////////////////////////</span>
<span class="linenos">1309</span>
<span class="linenos">1310</span><span class="w">    </span><span class="kt">__shared__</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">choices</span><span class="p">[</span><span class="n">MPD_Y_WINDOW_SIZE</span><span class="o">*</span><span class="n">MPD_WORDS_PER_SITE</span><span class="p">];</span>
<span class="linenos">1311</span>
<span class="linenos">1312</span><span class="w">    </span><span class="c1">// Make the choices.</span>
<span class="linenos">1313</span><span class="w">    </span><span class="n">makeYDiffusionChoices</span><span class="p">(</span><span class="n">window</span><span class="p">,</span><span class="w"> </span><span class="n">sitesWindow</span><span class="p">,</span><span class="w"> </span><span class="n">choices</span><span class="p">,</span><span class="w"> </span><span class="n">latticeIndex</span><span class="p">,</span><span class="w"> </span><span class="n">latticeYIndex</span><span class="p">,</span><span class="w"> </span><span class="n">windowIndex</span><span class="p">,</span><span class="w"> </span><span class="n">windowYIndex</span><span class="p">,</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">);</span>
<span class="linenos">1314</span><span class="w">    </span><span class="nf">__syncthreads</span><span class="p">();</span>
<span class="linenos">1315</span>
<span class="linenos">1316</span><span class="w">    </span><span class="c1">//////////////////////////////////////////////////////////</span>
<span class="linenos">1317</span><span class="w">    </span><span class="c1">// Create version of the lattice at the next time step. //</span>
<span class="linenos">1318</span><span class="w">    </span><span class="c1">//////////////////////////////////////////////////////////</span>
<span class="linenos">1319</span>
<span class="linenos">1320</span><span class="w">    </span><span class="c1">// Progate the choices to the new lattice segment.</span>
<span class="linenos">1321</span><span class="w">    </span><span class="n">performPropagation</span><span class="p">(</span><span class="n">outLattice</span><span class="p">,</span><span class="w"> </span><span class="n">window</span><span class="p">,</span><span class="w"> </span><span class="n">choices</span><span class="p">,</span><span class="w"> </span><span class="n">latticeIndex</span><span class="p">,</span><span class="w"> </span><span class="n">windowIndex</span><span class="o">-</span><span class="n">TUNE_MPD_Y_BLOCK_X_SIZE</span><span class="p">,</span><span class="w"> </span><span class="n">windowIndex</span><span class="p">,</span><span class="w"> </span><span class="n">windowIndex</span><span class="o">+</span><span class="n">TUNE_MPD_Y_BLOCK_X_SIZE</span><span class="p">,</span><span class="w"> </span><span class="n">MPD_Y_WINDOW_SIZE</span><span class="p">,</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">);</span>
<span class="linenos">1322</span><span class="p">}</span>
<span class="linenos">1323</span>
<span class="linenos">1324</span><span class="cm">/**</span>
<span class="linenos">1325</span><span class="cm"> * Multiparticle diffusion performed by copying the lattice section to shared memory, making a choice for each lattice</span>
<span class="linenos">1326</span><span class="cm"> * site, storing the new lattice into shared memory, and then updating the global lattice.</span>
<span class="linenos">1327</span><span class="cm"> */</span>
<span class="linenos">1328</span><span class="cp">#ifdef MPD_CUDA_3D_GRID_LAUNCH</span>
<span class="linenos">1329</span><span class="kr">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">__launch_bounds__</span><span class="p">(</span><span class="n">TUNE_MPD_Z_BLOCK_X_SIZE</span><span class="o">*</span><span class="n">TUNE_MPD_Z_BLOCK_Z_SIZE</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="n">mpd_z_kernel</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">inLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">inSites</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">outLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">)</span>
<span class="linenos">1330</span><span class="p">{</span>
<span class="linenos">1331</span><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">bx</span><span class="o">=</span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">by</span><span class="o">=</span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">bz</span><span class="o">=</span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">z</span><span class="p">;</span>
<span class="linenos">1332</span><span class="cp">#else</span>
<span class="linenos">1333</span><span class="kr">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">__launch_bounds__</span><span class="p">(</span><span class="n">TUNE_MPD_Z_BLOCK_X_SIZE</span><span class="o">*</span><span class="n">TUNE_MPD_Z_BLOCK_Z_SIZE</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="n">mpd_z_kernel</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">inLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">inSites</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">outLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">gridXSize</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">)</span>
<span class="linenos">1334</span><span class="p">{</span>
<span class="linenos">1335</span><span class="w">    </span><span class="kt">__shared__</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">bx</span><span class="p">,</span><span class="w"> </span><span class="n">by</span><span class="p">,</span><span class="w"> </span><span class="n">bz</span><span class="p">;</span>
<span class="linenos">1336</span><span class="w">    </span><span class="n">calculateBlockPosition</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bx</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">by</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">bz</span><span class="p">,</span><span class="w"> </span><span class="n">gridXSize</span><span class="p">);</span>
<span class="linenos">1337</span><span class="cp">#endif</span>
<span class="linenos">1338</span>
<span class="linenos">1339</span><span class="w">    </span><span class="c1">// Figure out the offset of this thread in the lattice and the lattice segment.</span>
<span class="linenos">1340</span><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeZIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">bz</span><span class="o">*</span><span class="nb">blockDim</span><span class="p">.</span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">z</span><span class="p">;</span>
<span class="linenos">1341</span><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">latticeZIndex</span><span class="o">*</span><span class="n">latticeXYSizeC</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">by</span><span class="o">*</span><span class="n">latticeXSizeC</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">bx</span><span class="o">*</span><span class="nb">blockDim</span><span class="p">.</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
<span class="linenos">1342</span><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">windowZIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">z</span><span class="o">+</span><span class="n">MPD_APRON_SIZE</span><span class="p">;</span>
<span class="linenos">1343</span><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">windowIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">windowZIndex</span><span class="o">*</span><span class="nb">blockDim</span><span class="p">.</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
<span class="linenos">1344</span>
<span class="linenos">1345</span><span class="w">    </span><span class="c1">///////////////////////////////////////////</span>
<span class="linenos">1346</span><span class="w">    </span><span class="c1">// Load the lattice into shared memory. //</span>
<span class="linenos">1347</span><span class="w">    </span><span class="c1">///////////////////////////////////////////</span>
<span class="linenos">1348</span>
<span class="linenos">1349</span><span class="w">    </span><span class="c1">// Shared memory to store the lattice segment. Each lattice site has four particles, eight bits for each particle.</span>
<span class="linenos">1350</span><span class="w">    </span><span class="kt">__shared__</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">window</span><span class="p">[</span><span class="n">MPD_Z_WINDOW_SIZE</span><span class="o">*</span><span class="n">MPD_WORDS_PER_SITE</span><span class="p">];</span>
<span class="linenos">1351</span><span class="w">    </span><span class="kt">__shared__</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">sitesWindow</span><span class="p">[</span><span class="n">MPD_Z_WINDOW_SIZE</span><span class="p">];</span>
<span class="linenos">1352</span>
<span class="linenos">1353</span><span class="w">    </span><span class="c1">// Copy the x window from device memory into shared memory.</span>
<span class="linenos">1354</span><span class="w">    </span><span class="n">copyZWindowFromLattice</span><span class="p">(</span><span class="n">inLattice</span><span class="p">,</span><span class="w"> </span><span class="n">window</span><span class="p">,</span><span class="w"> </span><span class="n">latticeIndex</span><span class="p">,</span><span class="w"> </span><span class="n">latticeZIndex</span><span class="p">,</span><span class="w"> </span><span class="n">windowIndex</span><span class="p">,</span><span class="w"> </span><span class="n">windowZIndex</span><span class="p">);</span>
<span class="linenos">1355</span><span class="w">    </span><span class="n">copyZWindowFromSites</span><span class="p">(</span><span class="n">inSites</span><span class="p">,</span><span class="w"> </span><span class="n">sitesWindow</span><span class="p">,</span><span class="w"> </span><span class="n">latticeIndex</span><span class="p">,</span><span class="w"> </span><span class="n">latticeZIndex</span><span class="p">,</span><span class="w"> </span><span class="n">windowIndex</span><span class="p">,</span><span class="w"> </span><span class="n">windowZIndex</span><span class="p">);</span>
<span class="linenos">1356</span><span class="w">    </span><span class="nf">__syncthreads</span><span class="p">();</span>
<span class="linenos">1357</span>
<span class="linenos">1358</span><span class="w">    </span><span class="c1">////////////////////////////////////////</span>
<span class="linenos">1359</span><span class="w">    </span><span class="c1">// Make the choice for each particle. //</span>
<span class="linenos">1360</span><span class="w">    </span><span class="c1">////////////////////////////////////////</span>
<span class="linenos">1361</span>
<span class="linenos">1362</span><span class="w">    </span><span class="kt">__shared__</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">choices</span><span class="p">[</span><span class="n">MPD_Z_WINDOW_SIZE</span><span class="o">*</span><span class="n">MPD_WORDS_PER_SITE</span><span class="p">];</span>
<span class="linenos">1363</span>
<span class="linenos">1364</span><span class="w">    </span><span class="c1">// Make the choices.</span>
<span class="linenos">1365</span><span class="w">    </span><span class="n">makeZDiffusionChoices</span><span class="p">(</span><span class="n">window</span><span class="p">,</span><span class="w"> </span><span class="n">sitesWindow</span><span class="p">,</span><span class="w"> </span><span class="n">choices</span><span class="p">,</span><span class="w"> </span><span class="n">latticeIndex</span><span class="p">,</span><span class="w"> </span><span class="n">latticeZIndex</span><span class="p">,</span><span class="w"> </span><span class="n">windowIndex</span><span class="p">,</span><span class="w"> </span><span class="n">windowZIndex</span><span class="p">,</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">);</span>
<span class="linenos">1366</span><span class="w">    </span><span class="nf">__syncthreads</span><span class="p">();</span>
<span class="linenos">1367</span>
<span class="linenos">1368</span><span class="w">    </span><span class="c1">//////////////////////////////////////////////////////////</span>
<span class="linenos">1369</span><span class="w">    </span><span class="c1">// Create version of the lattice at the next time step. //</span>
<span class="linenos">1370</span><span class="w">    </span><span class="c1">//////////////////////////////////////////////////////////</span>
<span class="linenos">1371</span>
<span class="linenos">1372</span><span class="w">    </span><span class="c1">// Progate the choices to the new lattice segment.</span>
<span class="linenos">1373</span><span class="w">    </span><span class="n">performPropagation</span><span class="p">(</span><span class="n">outLattice</span><span class="p">,</span><span class="w"> </span><span class="n">window</span><span class="p">,</span><span class="w"> </span><span class="n">choices</span><span class="p">,</span><span class="w"> </span><span class="n">latticeIndex</span><span class="p">,</span><span class="w"> </span><span class="n">windowIndex</span><span class="o">-</span><span class="n">TUNE_MPD_Z_BLOCK_X_SIZE</span><span class="p">,</span><span class="w"> </span><span class="n">windowIndex</span><span class="p">,</span><span class="w"> </span><span class="n">windowIndex</span><span class="o">+</span><span class="n">TUNE_MPD_Z_BLOCK_X_SIZE</span><span class="p">,</span><span class="w"> </span><span class="n">MPD_Z_WINDOW_SIZE</span><span class="p">,</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">);</span>
<span class="linenos">1374</span><span class="p">}</span>
<span class="linenos">1375</span>
<span class="linenos">1376</span><span class="cm">/**</span>
<span class="linenos">1377</span><span class="cm"> * Multiparticle diffusion performed by copying the lattice section to shared memory, making a choice for each lattice</span>
<span class="linenos">1378</span><span class="cm"> * site, storing the new lattice into shared memory, and then updating the global lattice.</span>
<span class="linenos">1379</span><span class="cm"> */</span>
<span class="linenos">1380</span><span class="cp">#ifdef MPD_CUDA_3D_GRID_LAUNCH</span>
<span class="linenos">1381</span><span class="cp">#ifdef MPD_GLOBAL_S_MATRIX</span>
<span class="linenos">1382</span><span class="cp">#ifdef MPD_GLOBAL_R_MATRIX</span>
<span class="linenos">1383</span><span class="kr">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">__launch_bounds__</span><span class="p">(</span><span class="n">TUNE_MPD_REACTION_BLOCK_X_SIZE</span><span class="o">*</span><span class="n">TUNE_MPD_REACTION_BLOCK_Y_SIZE</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="n">reaction_kernel</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">inLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">inSites</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">outLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="kt">int8_t</span><span class="w"> </span><span class="o">*</span><span class="n">SG</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="n">RLG</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="n">reactionOrdersG</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="n">reactionSitesG</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="n">D1G</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="n">D2G</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="n">reactionRatesG</span><span class="p">)</span>
<span class="linenos">1384</span><span class="cp">#else</span>
<span class="linenos">1385</span><span class="kr">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">__launch_bounds__</span><span class="p">(</span><span class="n">TUNE_MPD_REACTION_BLOCK_X_SIZE</span><span class="o">*</span><span class="n">TUNE_MPD_REACTION_BLOCK_Y_SIZE</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="n">reaction_kernel</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">inLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">inSites</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">outLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="kt">int8_t</span><span class="w"> </span><span class="o">*</span><span class="n">SG</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="n">RLG</span><span class="p">)</span>
<span class="linenos">1386</span><span class="cp">#endif</span>
<span class="linenos">1387</span><span class="cp">#else</span>
<span class="linenos">1388</span><span class="kr">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">__launch_bounds__</span><span class="p">(</span><span class="n">TUNE_MPD_REACTION_BLOCK_X_SIZE</span><span class="o">*</span><span class="n">TUNE_MPD_REACTION_BLOCK_Y_SIZE</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="n">reaction_kernel</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">inLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">inSites</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">outLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">)</span>
<span class="linenos">1389</span><span class="cp">#endif</span>
<span class="linenos">1390</span><span class="p">{</span>
<span class="linenos">1391</span><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">bx</span><span class="o">=</span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">by</span><span class="o">=</span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">bz</span><span class="o">=</span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">z</span><span class="p">;</span>
<span class="linenos">1392</span><span class="cp">#else</span>
<span class="linenos">1393</span><span class="cp">#ifdef MPD_GLOBAL_S_MATRIX</span>
<span class="linenos">1394</span><span class="cp">#ifdef MPD_GLOBAL_R_MATRIX</span>
<span class="linenos">1395</span><span class="kr">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">__launch_bounds__</span><span class="p">(</span><span class="n">TUNE_MPD_REACTION_BLOCK_X_SIZE</span><span class="o">*</span><span class="n">TUNE_MPD_REACTION_BLOCK_Y_SIZE</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="n">reaction_kernel</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">inLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">inSites</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">outLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">gridXSize</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="kt">int8_t</span><span class="w"> </span><span class="o">*</span><span class="n">SG</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="n">RLG</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="n">reactionOrdersG</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="n">reactionSitesG</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="n">D1G</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="n">D2G</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="n">reactionRatesG</span><span class="p">)</span>
<span class="linenos">1396</span><span class="cp">#else</span>
<span class="linenos">1397</span><span class="kr">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">__launch_bounds__</span><span class="p">(</span><span class="n">TUNE_MPD_REACTION_BLOCK_X_SIZE</span><span class="o">*</span><span class="n">TUNE_MPD_REACTION_BLOCK_Y_SIZE</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="n">reaction_kernel</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">inLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">inSites</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">outLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">gridXSize</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="kt">int8_t</span><span class="w"> </span><span class="o">*</span><span class="n">SG</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="n">RLG</span><span class="p">)</span>
<span class="linenos">1398</span><span class="cp">#endif</span>
<span class="linenos">1399</span><span class="cp">#else</span>
<span class="linenos">1400</span><span class="kr">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">__launch_bounds__</span><span class="p">(</span><span class="n">TUNE_MPD_REACTION_BLOCK_X_SIZE</span><span class="o">*</span><span class="n">TUNE_MPD_REACTION_BLOCK_Y_SIZE</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="n">reaction_kernel</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">inLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">inSites</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">outLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">gridXSize</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">)</span>
<span class="linenos">1401</span><span class="cp">#endif</span>
<span class="linenos">1402</span><span class="p">{</span>
<span class="linenos">1403</span><span class="w">    </span><span class="kt">__shared__</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">bx</span><span class="p">,</span><span class="w"> </span><span class="n">by</span><span class="p">,</span><span class="w"> </span><span class="n">bz</span><span class="p">;</span>
<span class="linenos">1404</span><span class="w">    </span><span class="n">calculateBlockPosition</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bx</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">by</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">bz</span><span class="p">,</span><span class="w"> </span><span class="n">gridXSize</span><span class="p">);</span>
<span class="linenos">1405</span><span class="cp">#endif</span>
<span class="linenos">1406</span>
<span class="linenos">1407</span><span class="w">    </span><span class="c1">// Figure out the offset of this thread in the lattice and the lattice segment.</span>
<span class="linenos">1408</span><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeYIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">by</span><span class="o">*</span><span class="nb">blockDim</span><span class="p">.</span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
<span class="linenos">1409</span><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">bz</span><span class="o">*</span><span class="n">latticeXYSizeC</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">latticeYIndex</span><span class="o">*</span><span class="n">latticeXSizeC</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">bx</span><span class="o">*</span><span class="nb">blockDim</span><span class="p">.</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
<span class="linenos">1410</span>
<span class="linenos">1411</span><span class="w">    </span><span class="c1">///////////////////////////////////////////</span>
<span class="linenos">1412</span><span class="w">    </span><span class="c1">// Load the particles and site.          //</span>
<span class="linenos">1413</span><span class="w">    </span><span class="c1">///////////////////////////////////////////</span>
<span class="linenos">1414</span>
<span class="linenos">1415</span><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">particles</span><span class="p">[</span><span class="n">MPD_WORDS_PER_SITE</span><span class="p">];</span>
<span class="linenos">1416</span><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">w</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">latticeOffset</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">w</span><span class="o">&lt;</span><span class="n">MPD_WORDS_PER_SITE</span><span class="p">;</span><span class="w"> </span><span class="n">w</span><span class="o">++</span><span class="p">,</span><span class="w"> </span><span class="n">latticeOffset</span><span class="o">+=</span><span class="n">latticeXYZSizeC</span><span class="p">)</span>
<span class="linenos">1417</span><span class="w">        </span><span class="n">particles</span><span class="p">[</span><span class="n">w</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inLattice</span><span class="p">[</span><span class="n">latticeIndex</span><span class="o">+</span><span class="n">latticeOffset</span><span class="p">];</span>
<span class="linenos">1418</span><span class="w">    </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">siteType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inSites</span><span class="p">[</span><span class="n">latticeIndex</span><span class="p">];</span>
<span class="linenos">1419</span>
<span class="linenos">1420</span><span class="w">    </span><span class="c1">////////////////////////////////////////</span>
<span class="linenos">1421</span><span class="w">    </span><span class="c1">// Perform the reactions.             //</span>
<span class="linenos">1422</span><span class="w">    </span><span class="c1">////////////////////////////////////////</span>
<span class="linenos">1423</span>
<span class="linenos">1424</span><span class="w">    </span><span class="c1">// Calculate the kinetic rate for each reaction at this site.</span>
<span class="linenos">1425</span><span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">totalReactionPropensity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">;</span>
<span class="linenos">1426</span><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">numberReactionsC</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">1427</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">1428</span><span class="cp">#ifdef MPD_GLOBAL_S_MATRIX</span>
<span class="linenos">1429</span><span class="cp">#ifdef MPD_GLOBAL_R_MATRIX</span>
<span class="linenos">1430</span><span class="w">        </span><span class="n">totalReactionPropensity</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">calculateReactionPropensity</span><span class="p">(</span><span class="n">siteType</span><span class="p">,</span><span class="w"> </span><span class="n">particles</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">RLG</span><span class="p">,</span><span class="w"> </span><span class="n">reactionOrdersG</span><span class="p">,</span><span class="w"> </span><span class="n">reactionSitesG</span><span class="p">,</span><span class="w"> </span><span class="n">D1G</span><span class="p">,</span><span class="w"> </span><span class="n">D2G</span><span class="p">,</span><span class="w"> </span><span class="n">reactionRatesG</span><span class="p">);</span>
<span class="linenos">1431</span><span class="cp">#else</span>
<span class="linenos">1432</span><span class="w">        </span><span class="n">totalReactionPropensity</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">calculateReactionPropensity</span><span class="p">(</span><span class="n">siteType</span><span class="p">,</span><span class="w"> </span><span class="n">particles</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">RLG</span><span class="p">);</span>
<span class="linenos">1433</span><span class="cp">#endif</span>
<span class="linenos">1434</span><span class="cp">#else</span>
<span class="linenos">1435</span><span class="w">        </span><span class="n">totalReactionPropensity</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">calculateReactionPropensity</span><span class="p">(</span><span class="n">siteType</span><span class="p">,</span><span class="w"> </span><span class="n">particles</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">);</span>
<span class="linenos">1436</span><span class="cp">#endif</span>
<span class="linenos">1437</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">1438</span>
<span class="linenos">1439</span><span class="w">	</span><span class="c1">// If propensity is zero, no reaction can occur.</span>
<span class="linenos">1440</span><span class="w">	</span><span class="k">if</span><span class="p">(</span><span class="n">totalReactionPropensity</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">)</span>
<span class="linenos">1441</span><span class="w">		</span><span class="k">return</span><span class="p">;</span>
<span class="linenos">1442</span>
<span class="linenos">1443</span><span class="w">    </span><span class="c1">// See if a reaction occurred at the site.</span>
<span class="linenos">1444</span><span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">reactionProbability</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">calculateReactionProbability</span><span class="p">(</span><span class="n">totalReactionPropensity</span><span class="p">);</span>
<span class="linenos">1445</span><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">reactionOccurred</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">checkForReaction</span><span class="p">(</span><span class="n">latticeIndex</span><span class="p">,</span><span class="w"> </span><span class="n">reactionProbability</span><span class="p">,</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">);</span>
<span class="linenos">1446</span>
<span class="linenos">1447</span><span class="w">    </span><span class="c1">// If there was a reaction, process it.</span>
<span class="linenos">1448</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">reactionOccurred</span><span class="p">)</span>
<span class="linenos">1449</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">1450</span><span class="w">        </span><span class="c1">// Figure out which reaction occurred.</span>
<span class="linenos">1451</span><span class="cp">#ifdef MPD_GLOBAL_S_MATRIX</span>
<span class="linenos">1452</span><span class="cp">#ifdef MPD_GLOBAL_R_MATRIX</span>
<span class="linenos">1453</span><span class="w">        </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">reactionIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">determineReactionIndex</span><span class="p">(</span><span class="n">siteType</span><span class="p">,</span><span class="w"> </span><span class="n">particles</span><span class="p">,</span><span class="w"> </span><span class="n">latticeIndex</span><span class="p">,</span><span class="w"> </span><span class="n">totalReactionPropensity</span><span class="p">,</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">,</span><span class="w"> </span><span class="n">RLG</span><span class="p">,</span><span class="w"> </span><span class="n">reactionOrdersG</span><span class="p">,</span><span class="w"> </span><span class="n">reactionSitesG</span><span class="p">,</span><span class="w"> </span><span class="n">D1G</span><span class="p">,</span><span class="w"> </span><span class="n">D2G</span><span class="p">,</span><span class="w"> </span><span class="n">reactionRatesG</span><span class="p">);</span>
<span class="linenos">1454</span><span class="cp">#else</span>
<span class="linenos">1455</span><span class="w">        </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">reactionIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">determineReactionIndex</span><span class="p">(</span><span class="n">siteType</span><span class="p">,</span><span class="w"> </span><span class="n">particles</span><span class="p">,</span><span class="w"> </span><span class="n">latticeIndex</span><span class="p">,</span><span class="w"> </span><span class="n">totalReactionPropensity</span><span class="p">,</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">,</span><span class="w"> </span><span class="n">RLG</span><span class="p">);</span>
<span class="linenos">1456</span><span class="cp">#endif</span>
<span class="linenos">1457</span><span class="cp">#else</span>
<span class="linenos">1458</span><span class="w">        </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">reactionIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">determineReactionIndex</span><span class="p">(</span><span class="n">siteType</span><span class="p">,</span><span class="w"> </span><span class="n">particles</span><span class="p">,</span><span class="w"> </span><span class="n">latticeIndex</span><span class="p">,</span><span class="w"> </span><span class="n">totalReactionPropensity</span><span class="p">,</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">);</span>
<span class="linenos">1459</span><span class="cp">#endif</span>
<span class="linenos">1460</span>
<span class="linenos">1461</span><span class="w">        </span><span class="c1">// Construct the new site.</span>
<span class="linenos">1462</span><span class="cp">#ifdef MPD_GLOBAL_S_MATRIX</span>
<span class="linenos">1463</span><span class="w">        </span><span class="n">evaluateReaction</span><span class="p">(</span><span class="n">latticeIndex</span><span class="p">,</span><span class="w"> </span><span class="n">siteType</span><span class="p">,</span><span class="w"> </span><span class="n">particles</span><span class="p">,</span><span class="w"> </span><span class="n">reactionIndex</span><span class="p">,</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">,</span><span class="w"> </span><span class="n">SG</span><span class="p">);</span>
<span class="linenos">1464</span><span class="cp">#else</span>
<span class="linenos">1465</span><span class="w">        </span><span class="n">evaluateReaction</span><span class="p">(</span><span class="n">latticeIndex</span><span class="p">,</span><span class="w"> </span><span class="n">siteType</span><span class="p">,</span><span class="w"> </span><span class="n">particles</span><span class="p">,</span><span class="w"> </span><span class="n">reactionIndex</span><span class="p">,</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">);</span>
<span class="linenos">1466</span><span class="cp">#endif</span>
<span class="linenos">1467</span>
<span class="linenos">1468</span><span class="w">        </span><span class="c1">// Copy the new particles back into the lattice.</span>
<span class="linenos">1469</span><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">w</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">latticeOffset</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">w</span><span class="o">&lt;</span><span class="n">MPD_WORDS_PER_SITE</span><span class="p">;</span><span class="w"> </span><span class="n">w</span><span class="o">++</span><span class="p">,</span><span class="w"> </span><span class="n">latticeOffset</span><span class="o">+=</span><span class="n">latticeXYZSizeC</span><span class="p">)</span>
<span class="linenos">1470</span><span class="w">             </span><span class="n">outLattice</span><span class="p">[</span><span class="n">latticeIndex</span><span class="o">+</span><span class="n">latticeOffset</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">particles</span><span class="p">[</span><span class="n">w</span><span class="p">];</span>
<span class="linenos">1471</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">1472</span><span class="p">}</span>
<span class="linenos">1473</span>
<span class="linenos">1474</span><span class="cp">#ifdef MPD_GLOBAL_R_MATRIX</span>
<span class="linenos">1475</span><span class="kr">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">__launch_bounds__</span><span class="p">(</span><span class="n">TUNE_MPD_REACTION_BLOCK_X_SIZE</span><span class="o">*</span><span class="n">TUNE_MPD_REACTION_BLOCK_Y_SIZE</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="n">precomp_reaction_kernel</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">inLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">inSites</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">outLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="kt">int8_t</span><span class="w"> </span><span class="o">*</span><span class="n">SG</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="n">RLG</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="n">reactionOrdersG</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="n">reactionSitesG</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="n">D1G</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="n">D2G</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="n">reactionRatesG</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="n">qp0</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="n">qp1</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="n">qp2</span><span class="p">)</span>
<span class="linenos">1476</span><span class="cp">#else</span>
<span class="linenos">1477</span><span class="kr">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">__launch_bounds__</span><span class="p">(</span><span class="n">TUNE_MPD_REACTION_BLOCK_X_SIZE</span><span class="o">*</span><span class="n">TUNE_MPD_REACTION_BLOCK_Y_SIZE</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="n">precomp_reaction_kernel</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">inLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">inSites</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">outLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="kt">int8_t</span><span class="w"> </span><span class="o">*</span><span class="n">SG</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="n">RLG</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="n">qp0</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="n">qp1</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="n">qp2</span><span class="p">)</span>
<span class="linenos">1478</span><span class="cp">#endif</span>
<span class="linenos">1479</span><span class="p">{</span>
<span class="linenos">1480</span><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">bx</span><span class="o">=</span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">by</span><span class="o">=</span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">bz</span><span class="o">=</span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">z</span><span class="p">;</span>
<span class="linenos">1481</span>
<span class="linenos">1482</span><span class="w">    </span><span class="c1">// Figure out the offset of this thread in the lattice and the lattice segment.</span>
<span class="linenos">1483</span><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeYIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">by</span><span class="o">*</span><span class="nb">blockDim</span><span class="p">.</span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
<span class="linenos">1484</span><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">bz</span><span class="o">*</span><span class="n">latticeXYSizeC</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">latticeYIndex</span><span class="o">*</span><span class="n">latticeXSizeC</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">bx</span><span class="o">*</span><span class="nb">blockDim</span><span class="p">.</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
<span class="linenos">1485</span>
<span class="linenos">1486</span><span class="w">    </span><span class="c1">///////////////////////////////////////////</span>
<span class="linenos">1487</span><span class="w">    </span><span class="c1">// Load the particles and site.          //</span>
<span class="linenos">1488</span><span class="w">    </span><span class="c1">///////////////////////////////////////////</span>
<span class="linenos">1489</span>
<span class="linenos">1490</span><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">particles</span><span class="p">[</span><span class="n">MPD_WORDS_PER_SITE</span><span class="p">];</span>
<span class="linenos">1491</span><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">w</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">latticeOffset</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">w</span><span class="o">&lt;</span><span class="n">MPD_WORDS_PER_SITE</span><span class="p">;</span><span class="w"> </span><span class="n">w</span><span class="o">++</span><span class="p">,</span><span class="w"> </span><span class="n">latticeOffset</span><span class="o">+=</span><span class="n">latticeXYZSizeC</span><span class="p">)</span>
<span class="linenos">1492</span><span class="w">        </span><span class="n">particles</span><span class="p">[</span><span class="n">w</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inLattice</span><span class="p">[</span><span class="n">latticeIndex</span><span class="o">+</span><span class="n">latticeOffset</span><span class="p">];</span>
<span class="linenos">1493</span><span class="w">    </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">siteType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inSites</span><span class="p">[</span><span class="n">latticeIndex</span><span class="p">];</span>
<span class="linenos">1494</span>
<span class="linenos">1495</span><span class="w">    </span><span class="c1">////////////////////////////////////////</span>
<span class="linenos">1496</span><span class="w">    </span><span class="c1">// Perform the reactions.             //</span>
<span class="linenos">1497</span><span class="w">    </span><span class="c1">////////////////////////////////////////</span>
<span class="linenos">1498</span>
<span class="linenos">1499</span><span class="w">    </span><span class="c1">// Calculate the kinetic rate for each reaction at this site.</span>
<span class="linenos">1500</span><span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">totalReactionPropensity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_element</span><span class="p">(</span><span class="n">qp0</span><span class="p">,</span><span class="n">siteType</span><span class="p">);</span>
<span class="linenos">1501</span><span class="w">    </span><span class="c1">//float totalReactionPropensity = qp0[siteType];</span>
<span class="linenos">1502</span><span class="w">	</span><span class="k">for</span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">MPD_PARTICLES_PER_SITE</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">1503</span><span class="w">	</span><span class="p">{</span>
<span class="linenos">1504</span><span class="w">		</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">p1</span><span class="o">=</span><span class="n">particles</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="linenos">1505</span><span class="w">		</span><span class="k">if</span><span class="p">(</span><span class="n">p1</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">1506</span><span class="w">		</span><span class="p">{</span>
<span class="linenos">1507</span><span class="w">			</span><span class="n">totalReactionPropensity</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">read_element</span><span class="p">(</span><span class="n">qp1</span><span class="p">,(</span><span class="n">siteType</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">numberSpeciesC</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">p1</span><span class="mi">-1</span><span class="p">)));</span>
<span class="linenos">1508</span><span class="w">			</span><span class="c1">//totalReactionPropensity += qp1[(siteType * numberSpeciesC + (p1-1))];</span>
<span class="linenos">1509</span><span class="w">			</span><span class="k">for</span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">j</span><span class="o">=</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">&lt;</span><span class="n">MPD_PARTICLES_PER_SITE</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">1510</span><span class="w">			</span><span class="p">{</span>
<span class="linenos">1511</span><span class="w">				</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">p2</span><span class="o">=</span><span class="n">particles</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
<span class="linenos">1512</span><span class="w">				</span><span class="k">if</span><span class="p">(</span><span class="n">p2</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">1513</span><span class="w">				</span><span class="p">{</span>
<span class="linenos">1514</span><span class="w">					</span><span class="n">totalReactionPropensity</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">read_element</span><span class="p">(</span><span class="n">qp2</span><span class="p">,</span><span class="n">siteType</span><span class="o">*</span><span class="n">numberSpeciesC</span><span class="o">*</span><span class="n">numberSpeciesC</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">p1</span><span class="mi">-1</span><span class="p">)</span><span class="o">*</span><span class="n">numberSpeciesC</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">p2</span><span class="mi">-1</span><span class="p">));</span>
<span class="linenos">1515</span><span class="w">					</span><span class="c1">//totalReactionPropensity += qp2[siteType*numberSpeciesC*numberSpeciesC + (p1-1)*numberSpeciesC + (p2-1)];</span>
<span class="linenos">1516</span><span class="w">				</span><span class="p">}</span>
<span class="linenos">1517</span><span class="w">			</span><span class="p">}</span>
<span class="linenos">1518</span><span class="w">		</span><span class="p">}</span>
<span class="linenos">1519</span><span class="w">	</span><span class="p">}</span>
<span class="linenos">1520</span>
<span class="linenos">1521</span>
<span class="linenos">1522</span><span class="w">	</span><span class="c1">// If propensity is zero, no reaction can occur.</span>
<span class="linenos">1523</span><span class="w">	</span><span class="k">if</span><span class="p">(</span><span class="n">totalReactionPropensity</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">)</span>
<span class="linenos">1524</span><span class="w">		</span><span class="k">return</span><span class="p">;</span>
<span class="linenos">1525</span>
<span class="linenos">1526</span><span class="w">    </span><span class="c1">// See if a reaction occurred at the site.</span>
<span class="linenos">1527</span><span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">reactionProbability</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">calculateReactionProbability</span><span class="p">(</span><span class="n">totalReactionPropensity</span><span class="p">);</span>
<span class="linenos">1528</span><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">reactionOccurred</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">checkForReaction</span><span class="p">(</span><span class="n">latticeIndex</span><span class="p">,</span><span class="w"> </span><span class="n">reactionProbability</span><span class="p">,</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">);</span>
<span class="linenos">1529</span>
<span class="linenos">1530</span><span class="w">    </span><span class="c1">// If there was a reaction, process it.</span>
<span class="linenos">1531</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">reactionOccurred</span><span class="p">)</span>
<span class="linenos">1532</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">1533</span><span class="w">        </span><span class="c1">// Figure out which reaction occurred.</span>
<span class="linenos">1534</span><span class="cp">#ifdef MPD_GLOBAL_S_MATRIX</span>
<span class="linenos">1535</span><span class="cp">#ifdef MPD_GLOBAL_R_MATRIX</span>
<span class="linenos">1536</span><span class="w">        </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">reactionIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">determineReactionIndex</span><span class="p">(</span><span class="n">siteType</span><span class="p">,</span><span class="w"> </span><span class="n">particles</span><span class="p">,</span><span class="w"> </span><span class="n">latticeIndex</span><span class="p">,</span><span class="w"> </span><span class="n">totalReactionPropensity</span><span class="p">,</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">,</span><span class="w"> </span><span class="n">RLG</span><span class="p">,</span><span class="w"> </span><span class="n">reactionOrdersG</span><span class="p">,</span><span class="w"> </span><span class="n">reactionSitesG</span><span class="p">,</span><span class="w"> </span><span class="n">D1G</span><span class="p">,</span><span class="w"> </span><span class="n">D2G</span><span class="p">,</span><span class="w"> </span><span class="n">reactionRatesG</span><span class="p">);</span>
<span class="linenos">1537</span><span class="cp">#else</span>
<span class="linenos">1538</span><span class="w">        </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">reactionIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">determineReactionIndex</span><span class="p">(</span><span class="n">siteType</span><span class="p">,</span><span class="w"> </span><span class="n">particles</span><span class="p">,</span><span class="w"> </span><span class="n">latticeIndex</span><span class="p">,</span><span class="w"> </span><span class="n">totalReactionPropensity</span><span class="p">,</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">,</span><span class="w"> </span><span class="n">RLG</span><span class="p">);</span>
<span class="linenos">1539</span><span class="cp">#endif</span>
<span class="linenos">1540</span><span class="cp">#else</span>
<span class="linenos">1541</span><span class="w">        </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">reactionIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">determineReactionIndex</span><span class="p">(</span><span class="n">siteType</span><span class="p">,</span><span class="w"> </span><span class="n">particles</span><span class="p">,</span><span class="w"> </span><span class="n">latticeIndex</span><span class="p">,</span><span class="w"> </span><span class="n">totalReactionPropensity</span><span class="p">,</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">);</span>
<span class="linenos">1542</span><span class="cp">#endif</span>
<span class="linenos">1543</span>
<span class="linenos">1544</span><span class="w">        </span><span class="c1">// Construct the new site.</span>
<span class="linenos">1545</span><span class="cp">#ifdef MPD_GLOBAL_S_MATRIX</span>
<span class="linenos">1546</span><span class="w">        </span><span class="n">evaluateReaction</span><span class="p">(</span><span class="n">latticeIndex</span><span class="p">,</span><span class="w"> </span><span class="n">siteType</span><span class="p">,</span><span class="w"> </span><span class="n">particles</span><span class="p">,</span><span class="w"> </span><span class="n">reactionIndex</span><span class="p">,</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">,</span><span class="w"> </span><span class="n">SG</span><span class="p">);</span>
<span class="linenos">1547</span><span class="cp">#else</span>
<span class="linenos">1548</span><span class="w">        </span><span class="n">evaluateReaction</span><span class="p">(</span><span class="n">latticeIndex</span><span class="p">,</span><span class="w"> </span><span class="n">siteType</span><span class="p">,</span><span class="w"> </span><span class="n">particles</span><span class="p">,</span><span class="w"> </span><span class="n">reactionIndex</span><span class="p">,</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">);</span>
<span class="linenos">1549</span><span class="cp">#endif</span>
<span class="linenos">1550</span>
<span class="linenos">1551</span><span class="w">        </span><span class="c1">// Copy the new particles back into the lattice.</span>
<span class="linenos">1552</span><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">w</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">latticeOffset</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">w</span><span class="o">&lt;</span><span class="n">MPD_WORDS_PER_SITE</span><span class="p">;</span><span class="w"> </span><span class="n">w</span><span class="o">++</span><span class="p">,</span><span class="w"> </span><span class="n">latticeOffset</span><span class="o">+=</span><span class="n">latticeXYZSizeC</span><span class="p">)</span>
<span class="linenos">1553</span><span class="w">             </span><span class="n">outLattice</span><span class="p">[</span><span class="n">latticeIndex</span><span class="o">+</span><span class="n">latticeOffset</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">particles</span><span class="p">[</span><span class="n">w</span><span class="p">];</span>
<span class="linenos">1554</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">1555</span><span class="p">}</span>
<span class="linenos">1556</span><span class="p">}</span>
<span class="linenos">1557</span>
<span class="linenos">1558</span><span class="p">}</span>
<span class="linenos">1559</span><span class="p">}</span>
</pre></div>
</div>
</section>
<section id="mgpumpdrdmesolver-h">
<h3>MGPUMpdRdmeSolver.h<a class="headerlink" href="#mgpumpdrdmesolver-h" title="Link to this heading">#</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="linenos">  1</span><span class="cm">/*</span>
<span class="linenos">  2</span><span class="cm"> * University of Illinois Open Source License</span>
<span class="linenos">  3</span><span class="cm"> * Copyright 2008-2018 Luthey-Schulten Group,</span>
<span class="linenos">  4</span><span class="cm"> * Copyright 2012 Roberts Group,</span>
<span class="linenos">  5</span><span class="cm"> * All rights reserved.</span>
<span class="linenos">  6</span><span class="cm"> * </span>
<span class="linenos">  7</span><span class="cm"> * Developed by: Luthey-Schulten Group</span>
<span class="linenos">  8</span><span class="cm"> * 			     University of Illinois at Urbana-Champaign</span>
<span class="linenos">  9</span><span class="cm"> * 			     http://www.scs.uiuc.edu/~schulten</span>
<span class="linenos"> 10</span><span class="cm"> * </span>
<span class="linenos"> 11</span><span class="cm"> * Developed by: Roberts Group</span>
<span class="linenos"> 12</span><span class="cm"> * 			     Johns Hopkins University</span>
<span class="linenos"> 13</span><span class="cm"> * 			     http://biophysics.jhu.edu/roberts/</span>
<span class="linenos"> 14</span><span class="cm"> *</span>
<span class="linenos"> 15</span><span class="cm"> * Permission is hereby granted, free of charge, to any person obtaining a copy of</span>
<span class="linenos"> 16</span><span class="cm"> * this software and associated documentation files (the Software), to deal with </span>
<span class="linenos"> 17</span><span class="cm"> * the Software without restriction, including without limitation the rights to </span>
<span class="linenos"> 18</span><span class="cm"> * use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies </span>
<span class="linenos"> 19</span><span class="cm"> * of the Software, and to permit persons to whom the Software is furnished to </span>
<span class="linenos"> 20</span><span class="cm"> * do so, subject to the following conditions:</span>
<span class="linenos"> 21</span><span class="cm"> * </span>
<span class="linenos"> 22</span><span class="cm"> * - Redistributions of source code must retain the above copyright notice, </span>
<span class="linenos"> 23</span><span class="cm"> * this list of conditions and the following disclaimers.</span>
<span class="linenos"> 24</span><span class="cm"> * </span>
<span class="linenos"> 25</span><span class="cm"> * - Redistributions in binary form must reproduce the above copyright notice, </span>
<span class="linenos"> 26</span><span class="cm"> * this list of conditions and the following disclaimers in the documentation </span>
<span class="linenos"> 27</span><span class="cm"> * and/or other materials provided with the distribution.</span>
<span class="linenos"> 28</span><span class="cm"> * </span>
<span class="linenos"> 29</span><span class="cm"> * - Neither the names of the Luthey-Schulten Group, University of Illinois at</span>
<span class="linenos"> 30</span><span class="cm"> * Urbana-Champaign, the Roberts Group, Johns Hopkins University, nor the names</span>
<span class="linenos"> 31</span><span class="cm"> * of its contributors may be used to endorse or promote products derived from</span>
<span class="linenos"> 32</span><span class="cm"> * this Software without specific prior written permission.</span>
<span class="linenos"> 33</span><span class="cm"> * </span>
<span class="linenos"> 34</span><span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR </span>
<span class="linenos"> 35</span><span class="cm"> * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, </span>
<span class="linenos"> 36</span><span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL </span>
<span class="linenos"> 37</span><span class="cm"> * THE CONTRIBUTORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR </span>
<span class="linenos"> 38</span><span class="cm"> * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, </span>
<span class="linenos"> 39</span><span class="cm"> * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR </span>
<span class="linenos"> 40</span><span class="cm"> * OTHER DEALINGS WITH THE SOFTWARE.</span>
<span class="linenos"> 41</span><span class="cm"> *</span>
<span class="linenos"> 42</span><span class="cm"> * Author(s): Elijah Roberts, Mike Hallock, Zane Thornburg</span>
<span class="linenos"> 43</span><span class="cm"> */</span>
<span class="linenos"> 44</span>
<span class="linenos"> 45</span><span class="cp">#ifndef LM_RDME_MGPUMPDRDMESOLVER_H_</span>
<span class="linenos"> 46</span><span class="cp">#define LM_RDME_MGPUMPDRDMESOLVER_H_</span>
<span class="linenos"> 47</span>
<span class="linenos"> 48</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;cuda/lm_cuda.h&quot;</span>
<span class="linenos"> 49</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;core/ResourceAllocator.h&quot;</span>
<span class="linenos"> 50</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;rdme/RDMESolver.h&quot;</span>
<span class="linenos"> 51</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;rdme/ByteLattice.h&quot;</span>
<span class="linenos"> 52</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;rdme/GPUMapper/MultiGPUMapper.h&quot;</span>
<span class="linenos"> 53</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;rdme/GPUMapper/SegmentDescriptor.h&quot;</span>
<span class="linenos"> 54</span>
<span class="linenos"> 55</span><span class="cp">#if defined(MACOSX)</span>
<span class="linenos"> 56</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;GPUMapper/osx_barrier.h&quot;</span>
<span class="linenos"> 57</span><span class="cp">#endif</span>
<span class="linenos"> 58</span>
<span class="linenos"> 59</span><span class="cp">#define OVERFLOW_MODE_CLASSIC 0</span>
<span class="linenos"> 60</span><span class="cp">#define OVERFLOW_MODE_RELAXED 1</span>
<span class="linenos"> 61</span>
<span class="linenos"> 62</span><span class="k">using</span><span class="w"> </span><span class="n">lm</span><span class="o">::</span><span class="n">main</span><span class="o">::</span><span class="n">ResourceAllocator</span><span class="p">;</span>
<span class="linenos"> 63</span><span class="k">using</span><span class="w"> </span><span class="n">lm</span><span class="o">::</span><span class="n">rdme</span><span class="o">::</span><span class="n">RDMESolver</span><span class="p">;</span>
<span class="linenos"> 64</span><span class="k">using</span><span class="w"> </span><span class="n">lm</span><span class="o">::</span><span class="n">rdme</span><span class="o">::</span><span class="n">Lattice</span><span class="p">;</span>
<span class="linenos"> 65</span>
<span class="linenos"> 66</span><span class="k">namespace</span><span class="w"> </span><span class="nn">lm</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 67</span>
<span class="linenos"> 68</span><span class="k">namespace</span><span class="w"> </span><span class="nn">io</span><span class="p">{</span>
<span class="linenos"> 69</span><span class="k">class</span><span class="w"> </span><span class="nc">Lattice</span><span class="p">;</span>
<span class="linenos"> 70</span><span class="k">class</span><span class="w"> </span><span class="nc">SpeciesCounts</span><span class="p">;</span>
<span class="linenos"> 71</span><span class="p">}</span>
<span class="linenos"> 72</span><span class="k">namespace</span><span class="w"> </span><span class="nn">rdme</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 73</span>
<span class="linenos"> 74</span><span class="k">struct</span><span class="w"> </span><span class="nc">gpu_worker_thread_params</span><span class="p">;</span>
<span class="linenos"> 75</span>
<span class="linenos"> 76</span><span class="k">class</span><span class="w"> </span><span class="nc">MGPUMpdRdmeSolver</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">RDMESolver</span>
<span class="linenos"> 77</span><span class="p">{</span>
<span class="linenos"> 78</span><span class="w">    </span><span class="k">using</span><span class="w"> </span><span class="n">CMESolver</span><span class="o">::</span><span class="n">hookSimulation</span><span class="p">;</span>
<span class="linenos"> 79</span><span class="w">    </span><span class="k">using</span><span class="w"> </span><span class="n">RDMESolver</span><span class="o">::</span><span class="n">buildDiffusionModel</span><span class="p">;</span>
<span class="linenos"> 80</span>
<span class="linenos"> 81</span><span class="k">public</span><span class="o">:</span>
<span class="linenos"> 82</span><span class="w">    </span><span class="n">MGPUMpdRdmeSolver</span><span class="p">();</span>
<span class="linenos"> 83</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="o">~</span><span class="n">MGPUMpdRdmeSolver</span><span class="p">();</span>
<span class="linenos"> 84</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">initialize</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">replicate</span><span class="p">,</span><span class="w"> </span><span class="n">map</span><span class="o">&lt;</span><span class="n">string</span><span class="p">,</span><span class="n">string</span><span class="o">&gt;</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">parameters</span><span class="p">,</span><span class="w"> </span><span class="n">ResourceAllocator</span><span class="o">::</span><span class="n">ComputeResources</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">resources</span><span class="p">);</span>
<span class="linenos"> 85</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="nf">needsReactionModel</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;}</span>
<span class="linenos"> 86</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="nf">needsDiffusionModel</span><span class="p">()</span><span class="w">  </span><span class="p">{</span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;}</span>
<span class="linenos"> 87</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">buildModel</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">uint</span><span class="w"> </span><span class="n">numberSpeciesA</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">uint</span><span class="w"> </span><span class="n">numberReactionsA</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">uint</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">initialSpeciesCountsA</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">uint</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">reactionTypeA</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">kA</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">SA</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">uint</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">DA</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">uint</span><span class="w"> </span><span class="n">kCols</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span>
<span class="linenos"> 88</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">buildDiffusionModel</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">uint</span><span class="w"> </span><span class="n">numberSiteTypesA</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">DFA</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">uint</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">RLA</span><span class="p">,</span><span class="w"> </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">latticeXSize</span><span class="p">,</span><span class="w"> </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">latticeYSize</span><span class="p">,</span><span class="w"> </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">latticeZSize</span><span class="p">,</span><span class="w"> </span><span class="n">site_size_t</span><span class="w"> </span><span class="n">particlesPerSite</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">bytes_per_particle</span><span class="p">,</span><span class="w"> </span><span class="n">si_dist_t</span><span class="w"> </span><span class="n">latticeSpacing</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">latticeData</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">latticeSitesData</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">rowMajorData</span><span class="o">=</span><span class="nb">true</span><span class="p">);</span>
<span class="linenos"> 89</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">generateTrajectory</span><span class="p">();</span>
<span class="linenos"> 90</span><span class="w">	</span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setReactionRate</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">rxid</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">rate</span><span class="p">);</span>
<span class="linenos"> 91</span>
<span class="linenos"> 92</span><span class="k">protected</span><span class="o">:</span>
<span class="linenos"> 93</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">allocateLattice</span><span class="p">(</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">latticeXSize</span><span class="p">,</span><span class="w"> </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">latticeYSize</span><span class="p">,</span><span class="w"> </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">latticeZSize</span><span class="p">,</span><span class="w"> </span><span class="n">site_size_t</span><span class="w"> </span><span class="n">particlesPerSite</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">bytes_per_particle</span><span class="p">,</span><span class="w"> </span><span class="n">si_dist_t</span><span class="w"> </span><span class="n">latticeSpacing</span><span class="p">);</span>
<span class="linenos"> 94</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">writeLatticeData</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="n">ByteLattice</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">lattice</span><span class="p">,</span><span class="w"> </span><span class="n">lm</span><span class="o">::</span><span class="n">io</span><span class="o">::</span><span class="n">Lattice</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">latticeDataSet</span><span class="p">);</span>
<span class="linenos"> 95</span><span class="w">	</span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">writeLatticeSites</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="n">ByteLattice</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">lattice</span><span class="p">);</span>
<span class="linenos"> 96</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">recordSpeciesCounts</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="n">ByteLattice</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">lattice</span><span class="p">,</span><span class="w"> </span><span class="n">lm</span><span class="o">::</span><span class="n">io</span><span class="o">::</span><span class="n">SpeciesCounts</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">speciesCountsDataSet</span><span class="p">);</span>
<span class="linenos"> 97</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">writeSpeciesCounts</span><span class="p">(</span><span class="n">lm</span><span class="o">::</span><span class="n">io</span><span class="o">::</span><span class="n">SpeciesCounts</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">speciesCountsDataSet</span><span class="p">);</span>
<span class="linenos"> 98</span><span class="w">	</span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">hookCheckSimulation</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="n">ByteLattice</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">lattice</span><span class="p">);</span>
<span class="linenos"> 99</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">run_next_timestep</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">gpu</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">timestep</span><span class="p">);</span>
<span class="linenos">100</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">uint64_t</span><span class="w"> </span><span class="nf">getTimestepSeed</span><span class="p">(</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">timestep</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">substep</span><span class="p">);</span>
<span class="linenos">101</span><span class="w">	</span>
<span class="linenos">102</span><span class="w">	</span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">copyModelsToDevice</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">gpu</span><span class="p">);</span>
<span class="linenos">103</span><span class="w">	</span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">initialize_decomposition</span><span class="p">();</span>
<span class="linenos">104</span><span class="w">	</span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">start_threads</span><span class="p">();</span>
<span class="linenos">105</span><span class="w">	</span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">stop_threads</span><span class="p">();</span>
<span class="linenos">106</span><span class="w">	</span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">computePropensities</span><span class="p">();</span>
<span class="linenos">107</span>
<span class="linenos">108</span><span class="w">	</span><span class="c1">// declare the child thread entry point as a friend function</span>
<span class="linenos">109</span><span class="w">	</span><span class="c1">// so that it may call the run_thread method</span>
<span class="linenos">110</span><span class="w">	</span><span class="k">friend</span><span class="w"> </span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="nf">gpu_worker_thread</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">arg</span><span class="p">);</span>
<span class="linenos">111</span><span class="w">	</span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="nf">run_thread</span><span class="p">(</span><span class="kt">int</span><span class="p">);</span>
<span class="linenos">112</span><span class="w">	</span><span class="k">virtual</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">handle_all_overflows</span><span class="p">();</span>
<span class="linenos">113</span><span class="w">	</span><span class="k">virtual</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">handle_overflows</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">gpu</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">hptr</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">dptr</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ts</span><span class="p">);</span>
<span class="linenos">114</span><span class="w">	</span><span class="k">virtual</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">hookSimulation</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="n">ByteLattice</span><span class="w"> </span><span class="o">*</span><span class="n">lattice</span><span class="p">);</span>
<span class="linenos">115</span>
<span class="linenos">116</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">calculateXLaunchParameters</span><span class="p">(</span><span class="n">dim3</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">gridSize</span><span class="p">,</span><span class="w"> </span><span class="n">dim3</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">threadBlockSize</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">maxXBlockSize</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeXSize</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeYSize</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeZSize</span><span class="p">);</span>
<span class="linenos">117</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">calculateYLaunchParameters</span><span class="p">(</span><span class="n">dim3</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">gridSize</span><span class="p">,</span><span class="w"> </span><span class="n">dim3</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">threadBlockSize</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">blockXSize</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">blockYSize</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeXSize</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeYSize</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeZSize</span><span class="p">);</span>
<span class="linenos">118</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">calculateZLaunchParameters</span><span class="p">(</span><span class="n">dim3</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">gridSize</span><span class="p">,</span><span class="w"> </span><span class="n">dim3</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">threadBlockSize</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">blockXSize</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">blockZSize</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeXSize</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeYSize</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeZSize</span><span class="p">);</span>
<span class="linenos">119</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">calculateReactionLaunchParameters</span><span class="p">(</span><span class="n">dim3</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">gridSize</span><span class="p">,</span><span class="w"> </span><span class="n">dim3</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">threadBlockSize</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">blockXSize</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">blockYSize</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeXSize</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeYSize</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeZSize</span><span class="p">);</span>
<span class="linenos">120</span>
<span class="linenos">121</span><span class="k">protected</span><span class="o">:</span>
<span class="linenos">122</span><span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">seed</span><span class="p">;</span>
<span class="linenos">123</span><span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">tau</span><span class="p">;</span>
<span class="linenos">124</span>
<span class="linenos">125</span><span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">overflowTimesteps</span><span class="p">;</span>
<span class="linenos">126</span><span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">overflowListUses</span><span class="p">;</span>
<span class="linenos">127</span><span class="w">    </span><span class="kt">int</span><span class="w">      </span><span class="n">overflow_handling</span><span class="p">;</span>
<span class="linenos">128</span>
<span class="linenos">129</span><span class="w">	</span><span class="c1">// Stored model parameters for const memory</span>
<span class="linenos">130</span><span class="w">	</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">model_reactionOrders</span><span class="p">;</span>
<span class="linenos">131</span><span class="w">	</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">model_reactionSites</span><span class="p">;</span>
<span class="linenos">132</span><span class="w">	</span><span class="kt">float</span><span class="o">*</span><span class="w">        </span><span class="n">model_reactionRates</span><span class="p">;</span>
<span class="linenos">133</span>
<span class="linenos">134</span><span class="w">	</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">model_D1</span><span class="p">;</span>
<span class="linenos">135</span><span class="w">	</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">model_D2</span><span class="p">;</span>
<span class="linenos">136</span>
<span class="linenos">137</span><span class="w">	</span><span class="kt">int8_t</span><span class="o">*</span><span class="w">  </span><span class="n">model_S</span><span class="p">;</span>
<span class="linenos">138</span><span class="w">	</span><span class="kt">float</span><span class="o">*</span><span class="w">   </span><span class="n">model_T</span><span class="p">;</span>
<span class="linenos">139</span><span class="w">	</span><span class="kt">uint8_t</span><span class="o">*</span><span class="w"> </span><span class="n">model_RL</span><span class="p">;</span>
<span class="linenos">140</span>
<span class="linenos">141</span><span class="w">	</span><span class="kt">size_t</span><span class="w"> </span><span class="n">zeroOrderSize</span><span class="p">,</span><span class="w"> </span><span class="n">firstOrderSize</span><span class="p">,</span><span class="w"> </span><span class="n">secondOrderSize</span><span class="p">;</span>
<span class="linenos">142</span><span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="n">zeroOrder</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">firstOrder</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">secondOrder</span><span class="p">;</span>
<span class="linenos">143</span>
<span class="linenos">144</span><span class="w">	</span><span class="n">pthread_barrier_t</span><span class="w"> </span><span class="n">start_barrier</span><span class="p">,</span><span class="w"> </span><span class="n">stop_barrier</span><span class="p">,</span><span class="w"> </span><span class="n">simulation_barrier</span><span class="p">;</span>
<span class="linenos">145</span><span class="w">	</span><span class="n">pthread_barrier_t</span><span class="w"> </span><span class="n">overflow_barrier1</span><span class="p">,</span><span class="w"> </span><span class="n">overflow_barrier2</span><span class="p">;</span>
<span class="linenos">146</span><span class="w">	</span><span class="n">MultiGPUMapper</span><span class="w"> </span><span class="o">*</span><span class="n">mapper</span><span class="p">;</span>
<span class="linenos">147</span><span class="w">	</span><span class="n">ResourceAllocator</span><span class="o">::</span><span class="n">ComputeResources</span><span class="w"> </span><span class="o">*</span><span class="n">resources</span><span class="p">;</span>
<span class="linenos">148</span><span class="w">	</span><span class="n">gpu_worker_thread_params</span><span class="w"> </span><span class="o">*</span><span class="n">threads</span><span class="p">;</span>
<span class="linenos">149</span>
<span class="linenos">150</span><span class="w">	</span><span class="kt">int</span><span class="w"> </span><span class="n">timesteps_to_run</span><span class="p">;</span>
<span class="linenos">151</span><span class="w">	</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">current_timestep</span><span class="p">;</span>
<span class="linenos">152</span><span class="w">	</span><span class="kt">bool</span><span class="w"> </span><span class="n">reactionModelModified</span><span class="p">;</span>
<span class="linenos">153</span><span class="w">	</span><span class="kt">double</span><span class="w"> </span><span class="n">printPerfInterval</span><span class="p">;</span>
<span class="linenos">154</span><span class="w">	</span>
<span class="linenos">155</span><span class="w">	</span><span class="kt">bool</span><span class="w"> </span><span class="n">aggcopy_x_unpack</span><span class="p">;</span>
<span class="linenos">156</span><span class="w">	</span><span class="kt">bool</span><span class="w"> </span><span class="n">aggcopy_r_pack</span><span class="p">;</span>
<span class="linenos">157</span><span class="w">	</span><span class="kt">bool</span><span class="w"> </span><span class="n">use_spin_barrier</span><span class="p">;</span>
<span class="linenos">158</span><span class="p">};</span>
<span class="linenos">159</span>
<span class="linenos">160</span><span class="k">struct</span><span class="w"> </span><span class="nc">gpu_worker_thread_params</span>
<span class="linenos">161</span><span class="p">{</span>
<span class="linenos">162</span><span class="w">    </span><span class="n">pthread_t</span><span class="w"> </span><span class="kr">thread</span><span class="p">;</span>
<span class="linenos">163</span><span class="w">    </span><span class="c1">//MultiCUDALattice *lattice;</span>
<span class="linenos">164</span><span class="w">    </span><span class="n">MGPUMpdRdmeSolver</span><span class="w"> </span><span class="o">*</span><span class="n">runner</span><span class="p">;</span>
<span class="linenos">165</span><span class="w">    </span><span class="n">MultiGPUMapper</span><span class="w"> </span><span class="o">*</span><span class="n">mapper</span><span class="p">;</span>
<span class="linenos">166</span><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">gpu</span><span class="p">;</span>
<span class="linenos">167</span><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">ngpus</span><span class="p">;</span>
<span class="linenos">168</span><span class="w">    </span><span class="n">pthread_barrier_t</span><span class="w"> </span><span class="o">*</span><span class="n">runner_sync</span><span class="p">;</span>
<span class="linenos">169</span><span class="w">    </span><span class="n">pthread_barrier_t</span><span class="w"> </span><span class="o">*</span><span class="n">worker_sync</span><span class="p">;</span>
<span class="linenos">170</span><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">timesteps_to_run</span><span class="p">;</span>
<span class="linenos">171</span><span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">lattice_synched</span><span class="p">;</span>
<span class="linenos">172</span><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">load_balance_counter</span><span class="p">;</span>
<span class="linenos">173</span>
<span class="linenos">174</span><span class="w">	</span><span class="c1">// cuda objects</span>
<span class="linenos">175</span><span class="w">	</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">dLattice</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">dLatticeTmp</span><span class="p">;</span>
<span class="linenos">176</span><span class="w">	</span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="n">dSites</span><span class="p">;</span>
<span class="linenos">177</span><span class="w">	</span><span class="n">cudaStream_t</span><span class="w"> </span><span class="n">stream1</span><span class="p">;</span>
<span class="linenos">178</span><span class="w">	</span><span class="n">cudaEvent_t</span><span class="w"> </span><span class="n">x_finish</span><span class="p">,</span><span class="w"> </span><span class="n">diffusion_finished</span><span class="p">,</span><span class="w"> </span><span class="n">rx_finish</span><span class="p">;</span>
<span class="linenos">179</span><span class="w">	</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">h_overflows</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">d_overflows</span><span class="p">;</span>
<span class="linenos">180</span>
<span class="linenos">181</span><span class="w">	</span><span class="c1">// kernel launch params</span>
<span class="linenos">182</span><span class="w">	</span><span class="n">dim3</span><span class="w"> </span><span class="n">grid_x</span><span class="p">,</span><span class="w"> </span><span class="n">grid_y</span><span class="p">,</span><span class="w"> </span><span class="n">grid_z</span><span class="p">,</span><span class="w"> </span><span class="n">grid_r</span><span class="p">;</span>
<span class="linenos">183</span><span class="w">	</span><span class="n">dim3</span><span class="w"> </span><span class="n">threads_x</span><span class="p">,</span><span class="w"> </span><span class="n">threads_y</span><span class="p">,</span><span class="w"> </span><span class="n">threads_z</span><span class="p">,</span><span class="w"> </span><span class="n">threads_r</span><span class="p">;</span>
<span class="linenos">184</span>
<span class="linenos">185</span><span class="w">	</span><span class="c1">// lattice segment geometry provided by the mapper</span>
<span class="linenos">186</span><span class="w">    </span><span class="n">SegmentDescriptor_s</span><span class="w"> </span><span class="o">*</span><span class="n">segment</span><span class="p">;</span>
<span class="linenos">187</span>
<span class="linenos">188</span><span class="cp">#ifdef MPD_GLOBAL_S_MATRIX</span>
<span class="linenos">189</span><span class="w">	</span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="n">RLG</span><span class="p">;</span><span class="w">   </span><span class="c1">// Device global memory pointer for RL matrix</span>
<span class="linenos">190</span><span class="w">	</span><span class="kt">int8_t</span><span class="w"> </span><span class="o">*</span><span class="n">SG</span><span class="p">;</span><span class="w">     </span><span class="c1">// Device global memory pointer for S matrix</span>
<span class="linenos">191</span><span class="cp">#endif</span>
<span class="linenos">192</span><span class="cp">#ifdef MPD_GLOBAL_T_MATRIX</span>
<span class="linenos">193</span><span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="n">TG</span><span class="p">;</span>
<span class="linenos">194</span><span class="cp">#endif</span>
<span class="linenos">195</span>
<span class="linenos">196</span><span class="cp">#ifdef MPD_GLOBAL_R_MATRIX</span>
<span class="linenos">197</span><span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="n">reactionRatesG</span><span class="p">;</span>
<span class="linenos">198</span><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">reactionOrdersG</span><span class="p">;</span>
<span class="linenos">199</span><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">reactionSitesG</span><span class="p">;</span>
<span class="linenos">200</span><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">D1G</span><span class="p">;</span>
<span class="linenos">201</span><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">D2G</span><span class="p">;</span>
<span class="linenos">202</span><span class="cp">#endif</span>
<span class="linenos">203</span>
<span class="linenos">204</span><span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="n">propZeroOrder</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">propFirstOrder</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">propSecondOrder</span><span class="p">;</span>
<span class="linenos">205</span><span class="w">	</span>
<span class="linenos">206</span>
<span class="linenos">207</span><span class="p">};</span>
<span class="linenos">208</span>
<span class="linenos">209</span>
<span class="linenos">210</span>
<span class="linenos">211</span><span class="k">namespace</span><span class="w"> </span><span class="nn">mgpumpdrdme_dev</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">212</span><span class="n">__device__</span><span class="w"> </span><span class="kr">inline</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">local_to_global</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">z</span><span class="p">);</span>
<span class="linenos">213</span><span class="n">__device__</span><span class="w"> </span><span class="kr">inline</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">local_index</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">z</span><span class="p">);</span>
<span class="linenos">214</span><span class="n">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">correct_overflows_mgpu</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">lattice</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">);</span>
<span class="linenos">215</span>
<span class="linenos">216</span><span class="cp">#ifdef MPD_GLOBAL_S_MATRIX</span>
<span class="linenos">217</span><span class="cp">#ifdef MPD_GLOBAL_R_MATRIX</span>
<span class="linenos">218</span><span class="n">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">MGPU_precomp_reaction_kernel</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">inLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">inSites</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">outLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">z_start</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="kt">int8_t</span><span class="w"> </span><span class="o">*</span><span class="n">SG</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="n">RLG</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="n">reactionOrderG</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="n">reactionSitesG</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="n">D1G</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="n">D2G</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="n">reactionRatesG</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="n">qp0</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="n">qp1</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="n">qp2</span><span class="p">);</span>
<span class="linenos">219</span><span class="cp">#else</span>
<span class="linenos">220</span><span class="n">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">MGPU_precomp_reaction_kernel</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">inLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">inSites</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">outLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">z_start</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="kt">int8_t</span><span class="w"> </span><span class="o">*</span><span class="n">SG</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="n">RLG</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="n">qp0</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="n">qp1</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="n">qp2</span><span class="p">);</span>
<span class="linenos">221</span><span class="cp">#endif</span>
<span class="linenos">222</span><span class="cp">#else</span>
<span class="linenos">223</span><span class="n">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">MGPU_precomp_reaction_kernel</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">inLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">inSites</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">outLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">z_start</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="n">qp0</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="n">qp1</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="n">qp2</span><span class="p">);</span>
<span class="linenos">224</span><span class="cp">#endif</span>
<span class="linenos">225</span>
<span class="linenos">226</span>
<span class="linenos">227</span><span class="cp">#ifdef MPD_GLOBAL_S_MATRIX</span>
<span class="linenos">228</span><span class="cp">#ifdef MPD_GLOBAL_R_MATRIX</span>
<span class="linenos">229</span><span class="n">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">MGPU_precomp_reaction_kernel_packing</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">inLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">inSites</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">outLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">z_start</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="kt">int8_t</span><span class="w"> </span><span class="o">*</span><span class="n">SG</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="n">RLG</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="n">reactionOrdersG</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="n">reactionSitesG</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="n">D1G</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="n">D2G</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="n">reactionRatesG</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="n">qp0</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="n">qp1</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="n">qp2</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">buf_top</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">buf_bot</span><span class="p">);</span>
<span class="linenos">230</span><span class="cp">#else</span>
<span class="linenos">231</span><span class="n">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">MGPU_precomp_reaction_kernel_packing</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">inLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">inSites</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">outLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">z_start</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="kt">int8_t</span><span class="w"> </span><span class="o">*</span><span class="n">SG</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="n">RLG</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="n">qp0</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="n">qp1</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="n">qp2</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">buf_top</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">buf_bot</span><span class="p">);</span>
<span class="linenos">232</span><span class="cp">#endif</span>
<span class="linenos">233</span><span class="cp">#else</span>
<span class="linenos">234</span><span class="n">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">MGPU_precomp_reaction_kernel_packing</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">inLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">inSites</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">outLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">z_start</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="n">qp0</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="n">qp1</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="n">qp2</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">buf_top</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">buf_bot</span><span class="p">);</span>
<span class="linenos">235</span><span class="cp">#endif</span>
<span class="linenos">236</span>
<span class="linenos">237</span><span class="n">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">MGPU_x_kernel_unpack</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">inLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">inSites</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">outLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">z_start</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">buf_top</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">buf_bot</span><span class="p">);</span>
<span class="linenos">238</span>
<span class="linenos">239</span><span class="n">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">MGPU_x_kernel</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">inLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">inSites</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">outLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">z_start</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">);</span>
<span class="linenos">240</span><span class="n">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">MGPU_y_kernel</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">inLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">inSites</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">outLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">);</span>
<span class="linenos">241</span><span class="n">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">MGPU_z_kernel</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">inLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">inSites</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">outLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">z_start</span><span class="p">);</span>
<span class="linenos">242</span><span class="cp">#ifdef MPD_GLOBAL_S_MATRIX</span>
<span class="linenos">243</span><span class="cp">#ifdef MPD_GLOBAL_R_MATRIX</span>
<span class="linenos">244</span><span class="n">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">MGPU_reaction_kernel</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">inLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">inSites</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">outLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">z_start</span><span class="p">,</span><span class="w">   </span><span class="k">const</span><span class="w"> </span><span class="kt">int8_t</span><span class="o">*</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="n">SG</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="o">*</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="n">RLG</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="n">reactionOrdersG</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="n">reactionSitesG</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="n">D1G</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="n">D2G</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="n">reactionRatesG</span><span class="p">);</span>
<span class="linenos">245</span><span class="cp">#else</span>
<span class="linenos">246</span><span class="n">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">MGPU_reaction_kernel</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">inLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">inSites</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">outLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">z_start</span><span class="p">,</span><span class="w">   </span><span class="k">const</span><span class="w"> </span><span class="kt">int8_t</span><span class="o">*</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="n">SG</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="o">*</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="n">RLG</span><span class="p">);</span>
<span class="linenos">247</span><span class="cp">#endif</span>
<span class="linenos">248</span><span class="cp">#else</span>
<span class="linenos">249</span><span class="n">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">MGPU_reaction_kernel</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">inLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">inSites</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">outLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">z_start</span><span class="p">);</span>
<span class="linenos">250</span><span class="cp">#endif</span>
<span class="linenos">251</span>
<span class="linenos">252</span>
<span class="linenos">253</span><span class="p">}</span>
<span class="linenos">254</span>
<span class="linenos">255</span><span class="p">}</span>
<span class="linenos">256</span><span class="p">}</span>
<span class="linenos">257</span>
<span class="linenos">258</span><span class="cp">#endif</span>
</pre></div>
</div>
</section>
<section id="mgpumpdrdmesolver-cu">
<h3>MGPUMpdRdmeSolver.cu<a class="headerlink" href="#mgpumpdrdmesolver-cu" title="Link to this heading">#</a></h3>
<div class="highlight-cuda notranslate"><div class="highlight"><pre><span></span><span class="linenos">   1</span><span class="cm">/*</span>
<span class="linenos">   2</span><span class="cm"> * University of Illinois Open Source License</span>
<span class="linenos">   3</span><span class="cm"> * Copyright 2008-2018 Luthey-Schulten Group,</span>
<span class="linenos">   4</span><span class="cm"> * Copyright 2012 Roberts Group,</span>
<span class="linenos">   5</span><span class="cm"> * All rights reserved.</span>
<span class="linenos">   6</span><span class="cm"> * </span>
<span class="linenos">   7</span><span class="cm"> * Developed by: Luthey-Schulten Group</span>
<span class="linenos">   8</span><span class="cm"> *               University of Illinois at Urbana-Champaign</span>
<span class="linenos">   9</span><span class="cm"> *               http://www.scs.uiuc.edu/~schulten</span>
<span class="linenos">  10</span><span class="cm"> * </span>
<span class="linenos">  11</span><span class="cm"> * Developed by: Roberts Group</span>
<span class="linenos">  12</span><span class="cm"> *               Johns Hopkins University</span>
<span class="linenos">  13</span><span class="cm"> *               http://biophysics.jhu.edu/roberts/</span>
<span class="linenos">  14</span><span class="cm"> *</span>
<span class="linenos">  15</span><span class="cm"> * Permission is hereby granted, free of charge, to any person obtaining a copy of</span>
<span class="linenos">  16</span><span class="cm"> * this software and associated documentation files (the Software), to deal with </span>
<span class="linenos">  17</span><span class="cm"> * the Software without restriction, including without limitation the rights to </span>
<span class="linenos">  18</span><span class="cm"> * use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies </span>
<span class="linenos">  19</span><span class="cm"> * of the Software, and to permit persons to whom the Software is furnished to </span>
<span class="linenos">  20</span><span class="cm"> * do so, subject to the following conditions:</span>
<span class="linenos">  21</span><span class="cm"> * </span>
<span class="linenos">  22</span><span class="cm"> * - Redistributions of source code must retain the above copyright notice, </span>
<span class="linenos">  23</span><span class="cm"> * this list of conditions and the following disclaimers.</span>
<span class="linenos">  24</span><span class="cm"> * </span>
<span class="linenos">  25</span><span class="cm"> * - Redistributions in binary form must reproduce the above copyright notice, </span>
<span class="linenos">  26</span><span class="cm"> * this list of conditions and the following disclaimers in the documentation </span>
<span class="linenos">  27</span><span class="cm"> * and/or other materials provided with the distribution.</span>
<span class="linenos">  28</span><span class="cm"> * </span>
<span class="linenos">  29</span><span class="cm"> * - Neither the names of the Luthey-Schulten Group, University of Illinois at</span>
<span class="linenos">  30</span><span class="cm"> * Urbana-Champaign, the Roberts Group, Johns Hopkins University, nor the names</span>
<span class="linenos">  31</span><span class="cm"> * of its contributors may be used to endorse or promote products derived from</span>
<span class="linenos">  32</span><span class="cm"> * this Software without specific prior written permission.</span>
<span class="linenos">  33</span><span class="cm"> * </span>
<span class="linenos">  34</span><span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR </span>
<span class="linenos">  35</span><span class="cm"> * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, </span>
<span class="linenos">  36</span><span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL </span>
<span class="linenos">  37</span><span class="cm"> * THE CONTRIBUTORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR </span>
<span class="linenos">  38</span><span class="cm"> * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, </span>
<span class="linenos">  39</span><span class="cm"> * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR </span>
<span class="linenos">  40</span><span class="cm"> * OTHER DEALINGS WITH THE SOFTWARE.</span>
<span class="linenos">  41</span><span class="cm"> *</span>
<span class="linenos">  42</span><span class="cm"> * Author(s): Mike Hallock, Zane Thornburg</span>
<span class="linenos">  43</span><span class="cm"> */</span>
<span class="linenos">  44</span>
<span class="linenos">  45</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;map&gt;</span>
<span class="linenos">  46</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;string&gt;</span>
<span class="linenos">  47</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;cstdlib&gt;</span>
<span class="linenos">  48</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;config.h&quot;</span>
<span class="linenos">  49</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;chrono&gt;</span>
<span class="linenos">  50</span><span class="cp">#if defined(MACOSX)</span>
<span class="linenos">  51</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;mach/mach_time.h&gt;</span>
<span class="linenos">  52</span><span class="cp">#elif defined(LINUX)</span>
<span class="linenos">  53</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;time.h&gt;</span>
<span class="linenos">  54</span><span class="cp">#endif</span>
<span class="linenos">  55</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;cuda/lm_cuda.h&quot;</span>
<span class="linenos">  56</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;cuda/ldg.h&quot;</span>
<span class="linenos">  57</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;core/Math.h&quot;</span>
<span class="linenos">  58</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;core/Print.h&quot;</span>
<span class="linenos">  59</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;cme/CMESolver.h&quot;</span>
<span class="linenos">  60</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;DiffusionModel.pb.h&quot;</span>
<span class="linenos">  61</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;Lattice.pb.h&quot;</span>
<span class="linenos">  62</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;SpeciesCounts.pb.h&quot;</span>
<span class="linenos">  63</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;core/DataOutputQueue.h&quot;</span>
<span class="linenos">  64</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;core/ResourceAllocator.h&quot;</span>
<span class="linenos">  65</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;rdme/ByteLattice.h&quot;</span>
<span class="linenos">  66</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;rdme/MGPUMpdRdmeSolver.h&quot;</span>
<span class="linenos">  67</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;rng/RandomGenerator.h&quot;</span>
<span class="linenos">  68</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;lptf/Profile.h&quot;</span>
<span class="linenos">  69</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;core/Timer.h&quot;</span>
<span class="linenos">  70</span>
<span class="linenos">  71</span><span class="cp">#define MPD_WORDS_PER_SITE              (MPD_LATTICE_MAX_OCCUPANCY / 4)</span>
<span class="linenos">  72</span><span class="cp">#define MPD_APRON_SIZE                  1</span>
<span class="linenos">  73</span>
<span class="linenos">  74</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;cuda/constant.cuh&quot;</span>
<span class="linenos">  75</span><span class="n">namespace</span><span class="w"> </span><span class="n">lm</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">  76</span><span class="n">namespace</span><span class="w"> </span><span class="n">rdme</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">  77</span><span class="n">namespace</span><span class="w"> </span><span class="n">mgpumpdrdme_dev</span><span class="p">{</span>
<span class="linenos">  78</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;rdme/dev/xor_random_dev.cu&quot;</span>
<span class="linenos">  79</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;rdme/dev/lattice_sim_1d_dev.cu&quot;</span>
<span class="linenos">  80</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;rdme/dev/byte_diffusion_1d_dev.cu&quot;</span>
<span class="linenos">  81</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;rdme/dev/byte_reaction_dev.cu&quot;</span>
<span class="linenos">  82</span><span class="p">}}}</span>
<span class="linenos">  83</span>
<span class="linenos">  84</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;rdme/GPUMapper/MultiGPUMapper.h&quot;</span>
<span class="linenos">  85</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;rdme/GPUMapper/SegmentDescriptor.h&quot;</span>
<span class="linenos">  86</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;rdme/GPUMapper/ZDivMultiGPUMapper.h&quot;</span>
<span class="linenos">  87</span>
<span class="linenos">  88</span><span class="cp">#define L3INDEX(_x,_y,_z, _g) ((_x)+((_y)*(_g.x))+((_z)*(_g.x)*(_g.y)))</span>
<span class="linenos">  89</span>
<span class="linenos">  90</span>
<span class="linenos">  91</span><span class="k">extern</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">globalAbort</span><span class="p">;</span>
<span class="linenos">  92</span>
<span class="linenos">  93</span>
<span class="linenos">  94</span><span class="n">using</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="p">;</span>
<span class="linenos">  95</span><span class="n">using</span><span class="w"> </span><span class="n">lm</span><span class="o">::</span><span class="n">io</span><span class="o">::</span><span class="n">DiffusionModel</span><span class="p">;</span>
<span class="linenos">  96</span><span class="n">using</span><span class="w"> </span><span class="n">lm</span><span class="o">::</span><span class="n">rdme</span><span class="o">::</span><span class="n">Lattice</span><span class="p">;</span>
<span class="linenos">  97</span><span class="n">using</span><span class="w"> </span><span class="n">lm</span><span class="o">::</span><span class="n">rng</span><span class="o">::</span><span class="n">RandomGenerator</span><span class="p">;</span>
<span class="linenos">  98</span>
<span class="linenos">  99</span><span class="n">namespace</span><span class="w"> </span><span class="n">lm</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 100</span><span class="n">namespace</span><span class="w"> </span><span class="n">rdme</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 101</span>
<span class="linenos"> 102</span>
<span class="linenos"> 103</span><span class="k">volatile</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">mclkr_overflow_counter</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<span class="linenos"> 104</span><span class="k">volatile</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">mclkr_total_overflows</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<span class="linenos"> 105</span><span class="k">volatile</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">mclkr_overflow_reporters</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<span class="linenos"> 106</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">mclkr_worker_count</span><span class="p">;</span>
<span class="linenos"> 107</span><span class="n">pthread_mutex_t</span><span class="w"> </span><span class="n">mclkr_overflow_mutex</span><span class="o">=</span><span class="n">PTHREAD_MUTEX_INITIALIZER</span><span class="p">;</span>
<span class="linenos"> 108</span><span class="n">pthread_cond_t</span><span class="w"> </span><span class="n">mclkr_overflow_cond</span><span class="o">=</span><span class="n">PTHREAD_COND_INITIALIZER</span><span class="p">;</span>
<span class="linenos"> 109</span>
<span class="linenos"> 110</span><span class="k">volatile</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">mclkr_generation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos"> 111</span><span class="n">pthread_spinlock_t</span><span class="w"> </span><span class="n">mclkr_spin</span><span class="p">;</span>
<span class="linenos"> 112</span>
<span class="linenos"> 113</span>
<span class="linenos"> 114</span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="nf">gpu_worker_thread</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="linenos"> 115</span><span class="p">{</span>
<span class="linenos"> 116</span><span class="w">	</span><span class="n">Print</span><span class="o">::</span><span class="n">printf</span><span class="p">(</span><span class="n">Print</span><span class="o">::</span><span class="n">VERBOSE_DEBUG</span><span class="p">,</span><span class="s">&quot;thread %p launched with arg %p&quot;</span><span class="p">,</span><span class="n">pthread_self</span><span class="p">(),</span><span class="w"> </span><span class="n">arg</span><span class="p">);</span>
<span class="linenos"> 117</span><span class="w">	</span><span class="n">gpu_worker_thread_params</span><span class="w"> </span><span class="o">*</span><span class="n">params</span><span class="o">=</span><span class="p">(</span><span class="n">gpu_worker_thread_params</span><span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>
<span class="linenos"> 118</span><span class="w">	</span><span class="n">MGPUMpdRdmeSolver</span><span class="w"> </span><span class="o">*</span><span class="n">solver</span><span class="o">=</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">runner</span><span class="p">;</span>
<span class="linenos"> 119</span>
<span class="linenos"> 120</span><span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="n">solver</span><span class="o">-&gt;</span><span class="n">run_thread</span><span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">gpu</span><span class="p">);</span>
<span class="linenos"> 121</span><span class="p">}</span>
<span class="linenos"> 122</span>
<span class="linenos"> 123</span><span class="kr">inline</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">mclkr_barrier_spin</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">overflows</span><span class="p">)</span>
<span class="linenos"> 124</span><span class="p">{</span>
<span class="linenos"> 125</span><span class="w">	</span><span class="n">PROF_BEGIN</span><span class="p">(</span><span class="n">MPD_MCLKR_BARRIER</span><span class="p">);</span>
<span class="linenos"> 126</span>
<span class="linenos"> 127</span><span class="w">	</span><span class="kt">int</span><span class="w"> </span><span class="n">gen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mclkr_generation</span><span class="p">;</span>
<span class="linenos"> 128</span><span class="w">	</span><span class="n">pthread_spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mclkr_spin</span><span class="p">);</span>
<span class="linenos"> 129</span>
<span class="linenos"> 130</span><span class="w">    </span><span class="c1">// Update shared counters</span>
<span class="linenos"> 131</span><span class="w">    </span><span class="n">mclkr_overflow_reporters</span><span class="o">++</span><span class="p">;</span>
<span class="linenos"> 132</span><span class="w">    </span><span class="n">mclkr_overflow_counter</span><span class="o">+=</span><span class="n">overflows</span><span class="p">;</span>
<span class="linenos"> 133</span>
<span class="linenos"> 134</span><span class="w">	</span><span class="n">pthread_spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mclkr_spin</span><span class="p">);</span>
<span class="linenos"> 135</span>
<span class="linenos"> 136</span><span class="w">    </span><span class="c1">// simulate barrier</span>
<span class="linenos"> 137</span><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">mclkr_overflow_reporters</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">mclkr_worker_count</span><span class="p">)</span>
<span class="linenos"> 138</span><span class="w">    </span><span class="p">{</span>
<span class="linenos"> 139</span><span class="w">        </span><span class="n">mclkr_total_overflows</span><span class="o">=</span><span class="n">mclkr_overflow_counter</span><span class="p">;</span>
<span class="linenos"> 140</span><span class="w">        </span><span class="n">mclkr_overflow_reporters</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<span class="linenos"> 141</span><span class="w">		</span><span class="n">mclkr_generation</span><span class="o">++</span><span class="p">;</span>
<span class="linenos"> 142</span><span class="w">    </span><span class="p">}</span>
<span class="linenos"> 143</span><span class="w">    </span><span class="k">else</span>
<span class="linenos"> 144</span><span class="w">    </span><span class="p">{</span>
<span class="linenos"> 145</span><span class="w">		</span><span class="k">while</span><span class="p">(</span><span class="n">mclkr_generation</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">gen</span><span class="p">)</span><span class="w"> </span><span class="p">{}</span><span class="w"> </span>
<span class="linenos"> 146</span><span class="w">    </span><span class="p">}</span>
<span class="linenos"> 147</span>
<span class="linenos"> 148</span><span class="w">	</span><span class="n">PROF_END</span><span class="p">(</span><span class="n">MPD_MCLKR_BARRIER</span><span class="p">);</span>
<span class="linenos"> 149</span><span class="p">}</span>
<span class="linenos"> 150</span>
<span class="linenos"> 151</span><span class="kr">inline</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">mclkr_barrier_cond</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">overflows</span><span class="p">)</span>
<span class="linenos"> 152</span><span class="p">{</span>
<span class="linenos"> 153</span><span class="w">	</span><span class="n">PROF_BEGIN</span><span class="p">(</span><span class="n">MPD_MCLKR_BARRIER</span><span class="p">);</span>
<span class="linenos"> 154</span>
<span class="linenos"> 155</span><span class="w">	</span><span class="n">pthread_mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mclkr_overflow_mutex</span><span class="p">);</span>
<span class="linenos"> 156</span>
<span class="linenos"> 157</span><span class="w">    </span><span class="c1">// Update shared counters</span>
<span class="linenos"> 158</span><span class="w">    </span><span class="n">mclkr_overflow_reporters</span><span class="o">++</span><span class="p">;</span>
<span class="linenos"> 159</span><span class="w">    </span><span class="n">mclkr_overflow_counter</span><span class="o">+=</span><span class="n">overflows</span><span class="p">;</span>
<span class="linenos"> 160</span>
<span class="linenos"> 161</span><span class="w">    </span><span class="c1">// simulate barrier</span>
<span class="linenos"> 162</span><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">mclkr_overflow_reporters</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">mclkr_worker_count</span><span class="p">)</span>
<span class="linenos"> 163</span><span class="w">    </span><span class="p">{</span>
<span class="linenos"> 164</span><span class="w">        </span><span class="n">mclkr_total_overflows</span><span class="o">=</span><span class="n">mclkr_overflow_counter</span><span class="p">;</span>
<span class="linenos"> 165</span><span class="w">        </span><span class="n">mclkr_overflow_reporters</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<span class="linenos"> 166</span><span class="w">		</span><span class="n">pthread_cond_broadcast</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mclkr_overflow_cond</span><span class="p">);</span>
<span class="linenos"> 167</span><span class="w">    </span><span class="p">}</span>
<span class="linenos"> 168</span><span class="w">    </span><span class="k">else</span>
<span class="linenos"> 169</span><span class="w">    </span><span class="p">{</span>
<span class="linenos"> 170</span><span class="w">		</span><span class="n">pthread_cond_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mclkr_overflow_cond</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">mclkr_overflow_mutex</span><span class="p">);</span>
<span class="linenos"> 171</span><span class="w">    </span><span class="p">}</span>
<span class="linenos"> 172</span>
<span class="linenos"> 173</span><span class="w">	</span><span class="n">pthread_mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mclkr_overflow_mutex</span><span class="p">);</span>
<span class="linenos"> 174</span>
<span class="linenos"> 175</span><span class="w">	</span><span class="n">PROF_END</span><span class="p">(</span><span class="n">MPD_MCLKR_BARRIER</span><span class="p">);</span>
<span class="linenos"> 176</span><span class="p">}</span>
<span class="linenos"> 177</span>
<span class="linenos"> 178</span><span class="w">	</span>
<span class="linenos"> 179</span>
<span class="linenos"> 180</span><span class="n">MGPUMpdRdmeSolver</span><span class="o">::</span><span class="n">MGPUMpdRdmeSolver</span><span class="p">()</span>
<span class="linenos"> 181</span><span class="o">:</span><span class="n">RDMESolver</span><span class="p">(</span><span class="n">lm</span><span class="o">::</span><span class="n">rng</span><span class="o">::</span><span class="n">RandomGenerator</span><span class="o">::</span><span class="n">NONE</span><span class="p">),</span>
<span class="linenos"> 182</span><span class="w"> </span><span class="n">seed</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="n">tau</span><span class="p">(</span><span class="mf">0.0</span><span class="p">),</span><span class="w"> </span><span class="n">threads</span><span class="p">(</span><span class="nb">NULL</span><span class="p">),</span>
<span class="linenos"> 183</span><span class="w"> </span><span class="n">overflowTimesteps</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="n">overflowListUses</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
<span class="linenos"> 184</span><span class="w"> </span><span class="n">model_reactionOrders</span><span class="p">(</span><span class="nb">NULL</span><span class="p">),</span><span class="w"> </span><span class="n">model_reactionSites</span><span class="p">(</span><span class="nb">NULL</span><span class="p">),</span><span class="w"> </span><span class="n">model_reactionRates</span><span class="p">(</span><span class="nb">NULL</span><span class="p">),</span>
<span class="linenos"> 185</span><span class="w"> </span><span class="n">model_D1</span><span class="p">(</span><span class="nb">NULL</span><span class="p">),</span><span class="w"> </span><span class="n">model_D2</span><span class="p">(</span><span class="nb">NULL</span><span class="p">),</span>
<span class="linenos"> 186</span><span class="w"> </span><span class="n">model_S</span><span class="p">(</span><span class="nb">NULL</span><span class="p">),</span><span class="w"> </span><span class="n">model_T</span><span class="p">(</span><span class="nb">NULL</span><span class="p">),</span><span class="w"> </span><span class="n">model_RL</span><span class="p">(</span><span class="nb">NULL</span><span class="p">),</span>
<span class="linenos"> 187</span><span class="w"> </span><span class="n">zeroOrder</span><span class="p">(</span><span class="nb">NULL</span><span class="p">),</span><span class="w"> </span><span class="n">firstOrder</span><span class="p">(</span><span class="nb">NULL</span><span class="p">),</span><span class="w"> </span><span class="n">secondOrder</span><span class="p">(</span><span class="nb">NULL</span><span class="p">)</span>
<span class="linenos"> 188</span><span class="p">{</span>
<span class="linenos"> 189</span><span class="w">	</span><span class="c1">// set defaults features</span>
<span class="linenos"> 190</span><span class="w">	</span><span class="n">aggcopy_x_unpack</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="linenos"> 191</span><span class="w">	</span><span class="n">aggcopy_r_pack</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="linenos"> 192</span><span class="w">	</span><span class="n">use_spin_barrier</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="linenos"> 193</span><span class="p">}</span>
<span class="linenos"> 194</span>
<span class="linenos"> 195</span><span class="kt">void</span><span class="w"> </span><span class="n">MGPUMpdRdmeSolver</span><span class="o">::</span><span class="n">initialize</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">replicate</span><span class="p">,</span><span class="w"> </span><span class="n">map</span><span class="o">&lt;</span><span class="n">string</span><span class="p">,</span><span class="n">string</span><span class="o">&gt;</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">parameters</span><span class="p">,</span><span class="w"> </span><span class="n">ResourceAllocator</span><span class="o">::</span><span class="n">ComputeResources</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">resourcesA</span><span class="p">)</span>
<span class="linenos"> 196</span><span class="p">{</span>
<span class="linenos"> 197</span><span class="w">	</span><span class="n">pthread_spin_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mclkr_spin</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="linenos"> 198</span>
<span class="linenos"> 199</span><span class="w">	</span><span class="n">RDMESolver</span><span class="o">::</span><span class="n">initialize</span><span class="p">(</span><span class="n">replicate</span><span class="p">,</span><span class="w"> </span><span class="n">parameters</span><span class="p">,</span><span class="w"> </span><span class="n">resourcesA</span><span class="p">);</span>
<span class="linenos"> 200</span>
<span class="linenos"> 201</span><span class="w">    </span><span class="c1">// Figure out the random seed.</span>
<span class="linenos"> 202</span><span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">seedTop</span><span class="o">=</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="p">)</span><span class="n">atoi</span><span class="p">((</span><span class="o">*</span><span class="n">parameters</span><span class="p">)[</span><span class="s">&quot;seed&quot;</span><span class="p">].</span><span class="n">c_str</span><span class="p">());</span>
<span class="linenos"> 203</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">seedTop</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="linenos"> 204</span><span class="w">    </span><span class="p">{</span>
<span class="linenos"> 205</span><span class="w">        </span><span class="cp">#if defined(MACOSX)</span>
<span class="linenos"> 206</span><span class="w">        </span><span class="n">seedTop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span><span class="n">mach_absolute_time</span><span class="p">();</span>
<span class="linenos"> 207</span><span class="w">        </span><span class="cp">#elif defined(LINUX)</span>
<span class="linenos"> 208</span><span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">timespec</span><span class="w"> </span><span class="n">seed_timespec</span><span class="p">;</span>
<span class="linenos"> 209</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">clock_gettime</span><span class="p">(</span><span class="n">CLOCK_REALTIME</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">seed_timespec</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="n">throw</span><span class="w"> </span><span class="n">lm</span><span class="o">::</span><span class="n">Exception</span><span class="p">(</span><span class="s">&quot;Error getting time to use for random seed.&quot;</span><span class="p">);</span>
<span class="linenos"> 210</span><span class="w">        </span><span class="n">seedTop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">seed_timespec</span><span class="p">.</span><span class="n">tv_nsec</span><span class="p">;</span>
<span class="linenos"> 211</span><span class="w">        </span><span class="cp">#endif</span>
<span class="linenos"> 212</span><span class="w">    </span><span class="p">}</span>
<span class="linenos"> 213</span><span class="w">    </span><span class="n">seed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">seedTop</span><span class="o">&lt;&lt;</span><span class="mi">16</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="n">replicate</span><span class="o">&amp;</span><span class="mh">0x0000FFFF</span><span class="p">);</span>
<span class="linenos"> 214</span><span class="w">    </span><span class="n">Print</span><span class="o">::</span><span class="n">printf</span><span class="p">(</span><span class="n">Print</span><span class="o">::</span><span class="n">INFO</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;MPDRDME: Rng seed: top word %u, bottom word %u&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">seed</span><span class="o">&gt;&gt;</span><span class="mi">16</span><span class="p">)</span><span class="o">*</span><span class="mh">0xffff</span><span class="p">,</span><span class="w"> </span><span class="n">seed</span><span class="o">&amp;</span><span class="mh">0xFFFF</span><span class="p">);</span>
<span class="linenos"> 215</span>
<span class="linenos"> 216</span><span class="w">	</span><span class="n">resources</span><span class="o">=</span><span class="n">resourcesA</span><span class="p">;</span>
<span class="linenos"> 217</span>
<span class="linenos"> 218</span><span class="w">	</span><span class="c1">//Verify that core count is at least as large as the gpu count.</span>
<span class="linenos"> 219</span><span class="w">	</span><span class="c1">//Otherwise, threads compete and speedups are not realized.</span>
<span class="linenos"> 220</span><span class="w">	</span><span class="kt">int</span><span class="w"> </span><span class="n">cpu_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">resources</span><span class="o">-&gt;</span><span class="n">cpuCores</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
<span class="linenos"> 221</span><span class="w">	</span><span class="kt">int</span><span class="w"> </span><span class="n">gpu_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">resources</span><span class="o">-&gt;</span><span class="n">cudaDevices</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
<span class="linenos"> 222</span>
<span class="linenos"> 223</span><span class="w">	</span><span class="k">if</span><span class="p">(</span><span class="n">cpu_count</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">gpu_count</span><span class="p">)</span>
<span class="linenos"> 224</span><span class="w">	</span><span class="p">{</span>
<span class="linenos"> 225</span><span class="w">		</span><span class="n">Print</span><span class="o">::</span><span class="n">printf</span><span class="p">(</span><span class="n">Print</span><span class="o">::</span><span class="n">FATAL</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;GPU count (%d) exceeds CPU count (%d)&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">gpu_count</span><span class="p">,</span><span class="w"> </span><span class="n">cpu_count</span><span class="p">);</span>
<span class="linenos"> 226</span><span class="w">		</span><span class="n">throw</span><span class="w"> </span><span class="n">lm</span><span class="o">::</span><span class="n">Exception</span><span class="p">(</span><span class="s">&quot;Not enough cpu cores to run solver&quot;</span><span class="p">);</span>
<span class="linenos"> 227</span><span class="w">	</span><span class="p">}</span>
<span class="linenos"> 228</span>
<span class="linenos"> 229</span><span class="w">	</span><span class="n">string</span><span class="w"> </span><span class="o">&amp;</span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">parameters</span><span class="p">)[</span><span class="s">&quot;rdme.mpd.overflowhandler&quot;</span><span class="p">];</span>
<span class="linenos"> 230</span><span class="w">	</span><span class="k">if</span><span class="p">(</span><span class="n">s</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;classic&quot;</span><span class="p">)</span>
<span class="linenos"> 231</span><span class="w">	</span><span class="p">{</span>
<span class="linenos"> 232</span><span class="w">		</span><span class="n">overflow_handling</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">OVERFLOW_MODE_CLASSIC</span><span class="p">;</span>
<span class="linenos"> 233</span><span class="w">		</span><span class="n">Print</span><span class="o">::</span><span class="n">printf</span><span class="p">(</span><span class="n">Print</span><span class="o">::</span><span class="n">DEBUG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Overflow handler set to classic&quot;</span><span class="p">);</span>
<span class="linenos"> 234</span><span class="w">	</span><span class="p">}</span>
<span class="linenos"> 235</span><span class="w">	</span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="p">(</span><span class="n">s</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;relaxed&quot;</span><span class="p">)</span>
<span class="linenos"> 236</span><span class="w">	</span><span class="p">{</span>
<span class="linenos"> 237</span><span class="w">		</span><span class="n">overflow_handling</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">OVERFLOW_MODE_RELAXED</span><span class="p">;</span>
<span class="linenos"> 238</span><span class="w">		</span><span class="n">Print</span><span class="o">::</span><span class="n">printf</span><span class="p">(</span><span class="n">Print</span><span class="o">::</span><span class="n">DEBUG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Overflow handler set to relaxed&quot;</span><span class="p">);</span>
<span class="linenos"> 239</span><span class="w">	</span><span class="p">}</span>
<span class="linenos"> 240</span><span class="w">	</span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="p">(</span><span class="n">s</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">)</span>
<span class="linenos"> 241</span><span class="w">	</span><span class="p">{</span>
<span class="linenos"> 242</span><span class="w">		</span><span class="n">overflow_handling</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">OVERFLOW_MODE_CLASSIC</span><span class="p">;</span>
<span class="linenos"> 243</span><span class="w">		</span><span class="n">Print</span><span class="o">::</span><span class="n">printf</span><span class="p">(</span><span class="n">Print</span><span class="o">::</span><span class="n">DEBUG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Overflow handler set to default (classic)&quot;</span><span class="p">);</span>
<span class="linenos"> 244</span><span class="w">	</span><span class="p">}</span>
<span class="linenos"> 245</span><span class="w">	</span><span class="k">else</span>
<span class="linenos"> 246</span><span class="w">	</span><span class="p">{</span>
<span class="linenos"> 247</span><span class="w">		</span><span class="n">overflow_handling</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">OVERFLOW_MODE_CLASSIC</span><span class="p">;</span>
<span class="linenos"> 248</span><span class="w">		</span><span class="n">Print</span><span class="o">::</span><span class="n">printf</span><span class="p">(</span><span class="n">Print</span><span class="o">::</span><span class="n">WARNING</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Unknown overflow handler requested: &#39;%s&#39;&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
<span class="linenos"> 249</span><span class="w">	</span><span class="p">}</span>
<span class="linenos"> 250</span>
<span class="linenos"> 251</span><span class="w">	</span><span class="k">if</span><span class="p">((</span><span class="o">*</span><span class="n">parameters</span><span class="p">)[</span><span class="s">&quot;mgpu.x_unpack&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">)</span>
<span class="linenos"> 252</span><span class="w">		</span><span class="n">aggcopy_x_unpack</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">atoi</span><span class="p">((</span><span class="o">*</span><span class="n">parameters</span><span class="p">)[</span><span class="s">&quot;mgpu.x_unpack&quot;</span><span class="p">].</span><span class="n">c_str</span><span class="p">());</span>
<span class="linenos"> 253</span>
<span class="linenos"> 254</span><span class="w">	</span><span class="k">if</span><span class="p">((</span><span class="o">*</span><span class="n">parameters</span><span class="p">)[</span><span class="s">&quot;mgpu.r_pack&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">)</span>
<span class="linenos"> 255</span><span class="w">		</span><span class="n">aggcopy_r_pack</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">atoi</span><span class="p">((</span><span class="o">*</span><span class="n">parameters</span><span class="p">)[</span><span class="s">&quot;mgpu.r_pack&quot;</span><span class="p">].</span><span class="n">c_str</span><span class="p">());</span>
<span class="linenos"> 256</span>
<span class="linenos"> 257</span><span class="w">	</span><span class="k">if</span><span class="p">((</span><span class="o">*</span><span class="n">parameters</span><span class="p">)[</span><span class="s">&quot;mgpu.spinlock&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">)</span>
<span class="linenos"> 258</span><span class="w">		</span><span class="n">use_spin_barrier</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">atoi</span><span class="p">((</span><span class="o">*</span><span class="n">parameters</span><span class="p">)[</span><span class="s">&quot;mgpu.spinlock&quot;</span><span class="p">].</span><span class="n">c_str</span><span class="p">());</span>
<span class="linenos"> 259</span><span class="p">}</span>
<span class="linenos"> 260</span>
<span class="linenos"> 261</span><span class="kt">void</span><span class="w"> </span><span class="n">MGPUMpdRdmeSolver</span><span class="o">::</span><span class="n">initialize_decomposition</span><span class="p">()</span>
<span class="linenos"> 262</span><span class="p">{</span>
<span class="linenos"> 263</span><span class="w">	</span><span class="c1">// Create mapper</span>
<span class="linenos"> 264</span><span class="w">	</span><span class="kt">int</span><span class="w"> </span><span class="n">latx</span><span class="p">,</span><span class="w"> </span><span class="n">laty</span><span class="p">,</span><span class="w"> </span><span class="n">latz</span><span class="p">;</span>
<span class="linenos"> 265</span><span class="w">	</span><span class="kt">int</span><span class="w"> </span><span class="n">apron</span><span class="p">,</span><span class="w"> </span><span class="n">overlap</span><span class="p">;</span>
<span class="linenos"> 266</span><span class="w">	</span><span class="kt">int</span><span class="w"> </span><span class="n">gpus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">resources</span><span class="o">-&gt;</span><span class="n">cudaDevices</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
<span class="linenos"> 267</span>
<span class="linenos"> 268</span><span class="cp">#if defined MPD_BOUNDARY_PERIODIC</span>
<span class="linenos"> 269</span><span class="w">	</span><span class="kt">bool</span><span class="w"> </span><span class="n">pz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="linenos"> 270</span><span class="cp">#else</span>
<span class="linenos"> 271</span><span class="w">	</span><span class="kt">bool</span><span class="w"> </span><span class="n">pz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="linenos"> 272</span><span class="cp">#endif</span>
<span class="linenos"> 273</span>
<span class="linenos"> 274</span><span class="w">	</span><span class="n">apron</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<span class="linenos"> 275</span><span class="w">	</span><span class="n">overlap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos"> 276</span>
<span class="linenos"> 277</span><span class="w">	</span><span class="n">latx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getXSize</span><span class="p">();</span>
<span class="linenos"> 278</span><span class="w">	</span><span class="n">laty</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getYSize</span><span class="p">();</span>
<span class="linenos"> 279</span><span class="w">	</span><span class="n">latz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getZSize</span><span class="p">();</span>
<span class="linenos"> 280</span>
<span class="linenos"> 281</span><span class="w">	</span><span class="kt">int</span><span class="w"> </span><span class="n">site_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">);</span>
<span class="linenos"> 282</span><span class="w">	</span><span class="kt">int</span><span class="w"> </span><span class="n">pagecount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MPD_WORDS_PER_SITE</span><span class="p">;</span>
<span class="linenos"> 283</span>
<span class="linenos"> 284</span><span class="w">	</span><span class="n">mapper</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">ZDivMultiGPUMapper</span><span class="p">(</span><span class="n">latx</span><span class="p">,</span><span class="w"> </span><span class="n">laty</span><span class="p">,</span><span class="w"> </span><span class="n">latz</span><span class="p">,</span>
<span class="linenos"> 285</span><span class="w">	                                </span><span class="n">site_size</span><span class="p">,</span><span class="w"> </span><span class="n">apron</span><span class="p">,</span><span class="w"> </span><span class="n">overlap</span><span class="p">,</span>
<span class="linenos"> 286</span><span class="w">								    </span><span class="n">gpus</span><span class="p">,</span><span class="w"> </span><span class="n">resources</span><span class="o">-&gt;</span><span class="n">cudaDevices</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span><span class="w"> </span><span class="n">pz</span><span class="p">,</span><span class="w"> </span><span class="n">pagecount</span><span class="p">);</span>
<span class="linenos"> 287</span>
<span class="linenos"> 288</span><span class="w">    </span><span class="n">pthread_barrier_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">start_barrier</span><span class="p">,</span><span class="w">      </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">gpus</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
<span class="linenos"> 289</span><span class="w">    </span><span class="n">pthread_barrier_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stop_barrier</span><span class="p">,</span><span class="w">       </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">gpus</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
<span class="linenos"> 290</span><span class="w">    </span><span class="n">pthread_barrier_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">simulation_barrier</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">gpus</span><span class="p">);</span>
<span class="linenos"> 291</span><span class="w">    </span><span class="n">pthread_barrier_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">overflow_barrier1</span><span class="p">,</span><span class="w">  </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">gpus</span><span class="p">);</span>
<span class="linenos"> 292</span><span class="w">    </span><span class="n">pthread_barrier_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">overflow_barrier2</span><span class="p">,</span><span class="w">  </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">gpus</span><span class="p">);</span>
<span class="linenos"> 293</span>
<span class="linenos"> 294</span><span class="w">	</span><span class="n">mclkr_worker_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gpus</span><span class="p">;</span>
<span class="linenos"> 295</span><span class="p">}</span>
<span class="linenos"> 296</span>
<span class="linenos"> 297</span><span class="kt">void</span><span class="w"> </span><span class="n">MGPUMpdRdmeSolver</span><span class="o">::</span><span class="n">start_threads</span><span class="p">()</span>
<span class="linenos"> 298</span><span class="p">{</span>
<span class="linenos"> 299</span><span class="w">	</span><span class="c1">// TODO FIXME: Think about this.  Perhaps each thread should be assigned a core</span>
<span class="linenos"> 300</span><span class="w">	</span><span class="c1">// or perhaps we should be reusing the threading infrastructure already provided</span>
<span class="linenos"> 301</span><span class="w">	</span><span class="c1">// to us via the core.  We also need NUMA awareness, which is another TODO.</span>
<span class="linenos"> 302</span><span class="w">	</span><span class="c1">// For now, lets just open up our pinning to be over all the cores that we&#39;ve</span>
<span class="linenos"> 303</span><span class="w">	</span><span class="c1">// been graciously handed to us.</span>
<span class="linenos"> 304</span><span class="cp">#if defined(LINUX) &amp;&amp; !defined(ARM)</span>
<span class="linenos"> 305</span><span class="w">	</span><span class="kt">cpu_set_t</span><span class="w"> </span><span class="n">cpuset</span><span class="p">;</span>
<span class="linenos"> 306</span><span class="w">	</span><span class="n">CPU_ZERO</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cpuset</span><span class="p">);</span>
<span class="linenos"> 307</span>
<span class="linenos"> 308</span><span class="w">	</span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">c</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">c</span><span class="o">&lt;</span><span class="n">resources</span><span class="o">-&gt;</span><span class="n">cpuCores</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="w"> </span><span class="n">c</span><span class="o">++</span><span class="p">)</span>
<span class="linenos"> 309</span><span class="w">	</span><span class="p">{</span>
<span class="linenos"> 310</span><span class="w">		</span><span class="n">Print</span><span class="o">::</span><span class="n">printf</span><span class="p">(</span><span class="n">Print</span><span class="o">::</span><span class="n">DEBUG</span><span class="p">,</span><span class="s">&quot;Adding CPU %d to our cpuset&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">resources</span><span class="o">-&gt;</span><span class="n">cpuCores</span><span class="p">[</span><span class="n">c</span><span class="p">]);</span>
<span class="linenos"> 311</span><span class="w">		</span><span class="n">CPU_SET</span><span class="p">(</span><span class="n">resources</span><span class="o">-&gt;</span><span class="n">cpuCores</span><span class="p">[</span><span class="n">c</span><span class="p">],</span><span class="w"> </span><span class="o">&amp;</span><span class="n">cpuset</span><span class="p">);</span>
<span class="linenos"> 312</span><span class="w">	</span><span class="p">}</span>
<span class="linenos"> 313</span><span class="w">	</span><span class="n">pthread_setaffinity_np</span><span class="p">(</span><span class="n">pthread_self</span><span class="p">(),</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">cpu_set_t</span><span class="p">),</span><span class="w"> </span><span class="o">&amp;</span><span class="n">cpuset</span><span class="p">);</span>
<span class="linenos"> 314</span><span class="cp">#endif</span>
<span class="linenos"> 315</span>
<span class="linenos"> 316</span><span class="w">	</span><span class="kt">int</span><span class="w"> </span><span class="n">gpus</span><span class="o">=</span><span class="n">resources</span><span class="o">-&gt;</span><span class="n">cudaDevices</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
<span class="linenos"> 317</span><span class="w">	</span><span class="n">threads</span><span class="o">=</span><span class="n">new</span><span class="w"> </span><span class="n">gpu_worker_thread_params</span><span class="p">[</span><span class="n">gpus</span><span class="p">];</span>
<span class="linenos"> 318</span>
<span class="linenos"> 319</span><span class="w">	</span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">gpus</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="linenos"> 320</span><span class="w">	</span><span class="p">{</span>
<span class="linenos"> 321</span><span class="w">        </span><span class="n">threads</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">runner</span><span class="o">=</span><span class="n">this</span><span class="p">;</span>
<span class="linenos"> 322</span><span class="w">        </span><span class="c1">//threads[i].lattice=lattice;</span>
<span class="linenos"> 323</span><span class="w">        </span><span class="n">threads</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mapper</span><span class="o">=</span><span class="n">mapper</span><span class="p">;</span>
<span class="linenos"> 324</span><span class="w">        </span><span class="n">threads</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">gpu</span><span class="o">=</span><span class="n">i</span><span class="p">;</span>
<span class="linenos"> 325</span><span class="w">        </span><span class="n">threads</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ngpus</span><span class="o">=</span><span class="n">gpus</span><span class="p">;</span>
<span class="linenos"> 326</span><span class="w">        </span><span class="n">threads</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">runner_sync</span><span class="o">=</span><span class="nb">NULL</span><span class="p">;</span>
<span class="linenos"> 327</span><span class="w">        </span><span class="n">threads</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">worker_sync</span><span class="o">=</span><span class="nb">NULL</span><span class="p">;</span>
<span class="linenos"> 328</span><span class="w">        </span><span class="n">threads</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">timesteps_to_run</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<span class="linenos"> 329</span><span class="w">		</span><span class="n">threads</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">segment</span><span class="o">=</span><span class="n">mapper</span><span class="o">-&gt;</span><span class="n">getSegmentDescriptor</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
<span class="linenos"> 330</span><span class="w">		</span>
<span class="linenos"> 331</span><span class="w">		</span><span class="n">Print</span><span class="o">::</span><span class="n">printf</span><span class="p">(</span><span class="n">Print</span><span class="o">::</span><span class="n">DEBUG</span><span class="p">,</span><span class="s">&quot;Creating GPU thread %d&quot;</span><span class="p">,</span><span class="n">i</span><span class="p">);</span>
<span class="linenos"> 332</span><span class="w">        </span><span class="n">pthread_create</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">threads</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="kr">thread</span><span class="p">),</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">gpu_worker_thread</span><span class="p">,</span>
<span class="linenos"> 333</span><span class="w">                       </span><span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">threads</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span>
<span class="linenos"> 334</span><span class="w">	</span><span class="p">}</span>
<span class="linenos"> 335</span><span class="p">}</span>
<span class="linenos"> 336</span>
<span class="linenos"> 337</span><span class="kt">void</span><span class="w"> </span><span class="n">MGPUMpdRdmeSolver</span><span class="o">::</span><span class="n">stop_threads</span><span class="p">()</span>
<span class="linenos"> 338</span><span class="p">{</span>
<span class="linenos"> 339</span><span class="w">	</span><span class="kt">int</span><span class="w"> </span><span class="n">gpus</span><span class="o">=</span><span class="n">resources</span><span class="o">-&gt;</span><span class="n">cudaDevices</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
<span class="linenos"> 340</span><span class="w">	</span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">gpus</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="linenos"> 341</span><span class="w">	</span><span class="p">{</span>
<span class="linenos"> 342</span><span class="w">		</span><span class="n">Print</span><span class="o">::</span><span class="n">printf</span><span class="p">(</span><span class="n">Print</span><span class="o">::</span><span class="n">DEBUG</span><span class="p">,</span><span class="s">&quot;Waiting to join GPU thread %d&quot;</span><span class="p">,</span><span class="n">i</span><span class="p">);</span>
<span class="linenos"> 343</span><span class="w">		</span><span class="n">pthread_join</span><span class="p">(</span><span class="n">threads</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="kr">thread</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
<span class="linenos"> 344</span><span class="w">	</span><span class="p">}</span>
<span class="linenos"> 345</span><span class="p">}</span>
<span class="linenos"> 346</span>
<span class="linenos"> 347</span><span class="n">MGPUMpdRdmeSolver</span><span class="o">::~</span><span class="n">MGPUMpdRdmeSolver</span><span class="p">()</span>
<span class="linenos"> 348</span><span class="p">{</span>
<span class="linenos"> 349</span><span class="w">	</span><span class="c1">// Free allocated memory in MGPUMpdRdmeSolver</span>
<span class="linenos"> 350</span><span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">model_reactionOrders</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="n">delete</span><span class="w"> </span><span class="p">[]</span><span class="w"> </span><span class="n">model_reactionOrders</span><span class="p">;}</span>
<span class="linenos"> 351</span><span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">model_reactionSites</span><span class="p">)</span><span class="w">  </span><span class="p">{</span><span class="n">delete</span><span class="w"> </span><span class="p">[]</span><span class="w"> </span><span class="n">model_reactionSites</span><span class="p">;}</span>
<span class="linenos"> 352</span><span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">model_reactionRates</span><span class="p">)</span><span class="w">  </span><span class="p">{</span><span class="n">delete</span><span class="w"> </span><span class="p">[]</span><span class="w"> </span><span class="n">model_reactionRates</span><span class="p">;}</span>
<span class="linenos"> 353</span>
<span class="linenos"> 354</span><span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">model_D1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="n">delete</span><span class="w"> </span><span class="p">[]</span><span class="w"> </span><span class="n">model_D1</span><span class="p">;}</span>
<span class="linenos"> 355</span><span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">model_D2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="n">delete</span><span class="w"> </span><span class="p">[]</span><span class="w"> </span><span class="n">model_D2</span><span class="p">;}</span>
<span class="linenos"> 356</span>
<span class="linenos"> 357</span><span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">model_S</span><span class="p">)</span><span class="w">  </span><span class="p">{</span><span class="n">delete</span><span class="w"> </span><span class="p">[]</span><span class="w"> </span><span class="n">model_S</span><span class="p">;}</span>
<span class="linenos"> 358</span><span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">model_T</span><span class="p">)</span><span class="w">  </span><span class="p">{</span><span class="n">delete</span><span class="w"> </span><span class="p">[]</span><span class="w"> </span><span class="n">model_T</span><span class="p">;}</span>
<span class="linenos"> 359</span><span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">model_RL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="n">delete</span><span class="w"> </span><span class="p">[]</span><span class="w"> </span><span class="n">model_RL</span><span class="p">;}</span>
<span class="linenos"> 360</span>
<span class="linenos"> 361</span><span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">zeroOrder</span><span class="p">)</span><span class="w">   </span><span class="p">{</span><span class="n">delete</span><span class="w"> </span><span class="p">[]</span><span class="w"> </span><span class="n">zeroOrder</span><span class="p">;}</span>
<span class="linenos"> 362</span><span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">firstOrder</span><span class="p">)</span><span class="w">  </span><span class="p">{</span><span class="n">delete</span><span class="w"> </span><span class="p">[]</span><span class="w"> </span><span class="n">firstOrder</span><span class="p">;}</span>
<span class="linenos"> 363</span><span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">secondOrder</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="n">delete</span><span class="w"> </span><span class="p">[]</span><span class="w"> </span><span class="n">secondOrder</span><span class="p">;}</span>
<span class="linenos"> 364</span>
<span class="linenos"> 365</span><span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">threads</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="n">delete</span><span class="w"> </span><span class="p">[]</span><span class="w"> </span><span class="n">threads</span><span class="p">;}</span>
<span class="linenos"> 366</span><span class="p">}</span>
<span class="linenos"> 367</span>
<span class="linenos"> 368</span><span class="kt">void</span><span class="w"> </span><span class="n">MGPUMpdRdmeSolver</span><span class="o">::</span><span class="n">allocateLattice</span><span class="p">(</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">latticeXSize</span><span class="p">,</span><span class="w"> </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">latticeYSize</span><span class="p">,</span><span class="w"> </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">latticeZSize</span><span class="p">,</span><span class="w"> </span><span class="n">site_size_t</span><span class="w"> </span><span class="n">particlesPerSite</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">bytes_per_particle</span><span class="p">,</span><span class="w"> </span><span class="n">si_dist_t</span><span class="w"> </span><span class="n">latticeSpacing</span><span class="p">)</span>
<span class="linenos"> 369</span><span class="p">{</span>
<span class="linenos"> 370</span><span class="w">	</span><span class="n">assert</span><span class="p">(</span><span class="n">bytes_per_particle</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="linenos"> 371</span><span class="w">    </span><span class="n">lattice</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Lattice</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">new</span><span class="w"> </span><span class="n">ByteLattice</span><span class="p">(</span><span class="n">latticeXSize</span><span class="p">,</span><span class="w"> </span><span class="n">latticeYSize</span><span class="p">,</span><span class="w"> </span><span class="n">latticeZSize</span><span class="p">,</span><span class="w"> </span><span class="n">latticeSpacing</span><span class="p">,</span><span class="w"> </span><span class="n">particlesPerSite</span><span class="p">);</span>
<span class="linenos"> 372</span><span class="p">}</span>
<span class="linenos"> 373</span>
<span class="linenos"> 374</span><span class="kt">void</span><span class="w"> </span><span class="n">MGPUMpdRdmeSolver</span><span class="o">::</span><span class="n">buildModel</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">uint</span><span class="w"> </span><span class="n">numberSpeciesA</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">uint</span><span class="w"> </span><span class="n">numberReactionsA</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">uint</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">initialSpeciesCountsA</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">uint</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">reactionTypesA</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">KA</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">SA</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">uint</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">DA</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">uint</span><span class="w"> </span><span class="n">kCols</span><span class="p">)</span>
<span class="linenos"> 375</span><span class="p">{</span>
<span class="linenos"> 376</span><span class="w">    </span><span class="n">CMESolver</span><span class="o">::</span><span class="n">buildModel</span><span class="p">(</span><span class="n">numberSpeciesA</span><span class="p">,</span><span class="w"> </span><span class="n">numberReactionsA</span><span class="p">,</span><span class="w"> </span><span class="n">initialSpeciesCountsA</span><span class="p">,</span><span class="w"> </span><span class="n">reactionTypesA</span><span class="p">,</span><span class="w"> </span><span class="n">KA</span><span class="p">,</span><span class="w"> </span><span class="n">SA</span><span class="p">,</span><span class="w"> </span><span class="n">DA</span><span class="p">,</span><span class="w"> </span><span class="n">kCols</span><span class="p">);</span>
<span class="linenos"> 377</span>
<span class="linenos"> 378</span><span class="w">    </span><span class="c1">// Get the time step.</span>
<span class="linenos"> 379</span><span class="w">    </span><span class="n">tau</span><span class="o">=</span><span class="n">atof</span><span class="p">((</span><span class="o">*</span><span class="n">parameters</span><span class="p">)[</span><span class="s">&quot;timestep&quot;</span><span class="p">].</span><span class="n">c_str</span><span class="p">());</span>
<span class="linenos"> 380</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tau</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">)</span><span class="w"> </span><span class="n">throw</span><span class="w"> </span><span class="n">InvalidArgException</span><span class="p">(</span><span class="s">&quot;timestep&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;A positive timestep must be specified for the solver.&quot;</span><span class="p">);</span>
<span class="linenos"> 381</span>
<span class="linenos"> 382</span><span class="w">    </span><span class="c1">// Make sure we can support the reaction model.</span>
<span class="linenos"> 383</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">numberReactions</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">MPD_MAX_REACTION_TABLE_ENTRIES</span><span class="p">)</span><span class="w"> </span><span class="n">throw</span><span class="w"> </span><span class="n">Exception</span><span class="p">(</span><span class="s">&quot;The number of reaction table entries exceeds the maximum supported by the solver.&quot;</span><span class="p">);</span>
<span class="linenos"> 384</span><span class="cp">#ifndef MPD_GLOBAL_S_MATRIX</span>
<span class="linenos"> 385</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">numberSpecies</span><span class="o">*</span><span class="n">numberReactions</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">MPD_MAX_S_MATRIX_ENTRIES</span><span class="p">)</span><span class="w"> </span><span class="n">throw</span><span class="w"> </span><span class="n">Exception</span><span class="p">(</span><span class="s">&quot;The number of S matrix entries exceeds the maximum supported by the solver.&quot;</span><span class="p">);</span>
<span class="linenos"> 386</span><span class="cp">#endif</span>
<span class="linenos"> 387</span>
<span class="linenos"> 388</span><span class="w">    </span><span class="c1">// Setup the cuda reaction model.</span>
<span class="linenos"> 389</span><span class="w">    </span><span class="n">model_reactionOrders</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="p">[</span><span class="n">numberReactions</span><span class="p">];</span>
<span class="linenos"> 390</span><span class="w">    </span><span class="n">model_reactionSites</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="p">[</span><span class="n">numberReactions</span><span class="p">];</span>
<span class="linenos"> 391</span><span class="w">    </span><span class="n">model_D1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="p">[</span><span class="n">numberReactions</span><span class="p">];</span>
<span class="linenos"> 392</span><span class="w">    </span><span class="n">model_D2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="p">[</span><span class="n">numberReactions</span><span class="p">];</span>
<span class="linenos"> 393</span><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">numberReactions</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="linenos"> 394</span><span class="w">    </span><span class="p">{</span>
<span class="linenos"> 395</span><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">reactionTypes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ZerothOrderPropensityArgs</span><span class="o">::</span><span class="n">REACTION_TYPE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 396</span><span class="w">        	</span><span class="n">model_reactionOrders</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MPD_ZERO_ORDER_REACTION</span><span class="p">;</span>
<span class="linenos"> 397</span><span class="w">        	</span><span class="n">model_reactionSites</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos"> 398</span><span class="w">        	</span><span class="n">model_D1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span>
<span class="linenos"> 399</span><span class="w">        	</span><span class="n">model_D2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos"> 400</span><span class="w">        </span><span class="p">}</span>
<span class="linenos"> 401</span><span class="w">    	</span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">reactionTypes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">FirstOrderPropensityArgs</span><span class="o">::</span><span class="n">REACTION_TYPE</span><span class="p">)</span>
<span class="linenos"> 402</span><span class="w">    	</span><span class="p">{</span>
<span class="linenos"> 403</span><span class="w">    		</span><span class="n">model_reactionOrders</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MPD_FIRST_ORDER_REACTION</span><span class="p">;</span>
<span class="linenos"> 404</span><span class="w">    		</span><span class="n">model_reactionSites</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos"> 405</span><span class="w">    		</span><span class="n">model_D1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="n">FirstOrderPropensityArgs</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">propensityFunctionArgs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">-&gt;</span><span class="n">si</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
<span class="linenos"> 406</span><span class="w">    		</span><span class="n">model_D2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos"> 407</span><span class="w">    	</span><span class="p">}</span>
<span class="linenos"> 408</span><span class="w">    	</span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">reactionTypes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">SecondOrderPropensityArgs</span><span class="o">::</span><span class="n">REACTION_TYPE</span><span class="p">)</span>
<span class="linenos"> 409</span><span class="w">    	</span><span class="p">{</span>
<span class="linenos"> 410</span><span class="w">    		</span><span class="n">model_reactionOrders</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MPD_SECOND_ORDER_REACTION</span><span class="p">;</span>
<span class="linenos"> 411</span><span class="w">    		</span><span class="n">model_reactionSites</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos"> 412</span><span class="w">    		</span><span class="n">model_D1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="n">SecondOrderPropensityArgs</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">propensityFunctionArgs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">-&gt;</span><span class="n">s1i</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
<span class="linenos"> 413</span><span class="w">    		</span><span class="n">model_D2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="n">SecondOrderPropensityArgs</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">propensityFunctionArgs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">-&gt;</span><span class="n">s2i</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
<span class="linenos"> 414</span><span class="w">    	</span><span class="p">}</span>
<span class="linenos"> 415</span><span class="w">    	</span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">reactionTypes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">SecondOrderSelfPropensityArgs</span><span class="o">::</span><span class="n">REACTION_TYPE</span><span class="p">)</span>
<span class="linenos"> 416</span><span class="w">    	</span><span class="p">{</span>
<span class="linenos"> 417</span><span class="w">    		</span><span class="n">model_reactionOrders</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MPD_SECOND_ORDER_SELF_REACTION</span><span class="p">;</span>
<span class="linenos"> 418</span><span class="w">    		</span><span class="n">model_reactionSites</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos"> 419</span><span class="w">    		</span><span class="n">model_D1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="n">SecondOrderSelfPropensityArgs</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">propensityFunctionArgs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">-&gt;</span><span class="n">si</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
<span class="linenos"> 420</span><span class="w">    		</span><span class="n">model_D2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos"> 421</span><span class="w">    	</span><span class="p">}</span>
<span class="linenos"> 422</span><span class="w">    	</span><span class="k">else</span>
<span class="linenos"> 423</span><span class="w">    	</span><span class="p">{</span>
<span class="linenos"> 424</span><span class="w">    		</span><span class="n">throw</span><span class="w"> </span><span class="n">InvalidArgException</span><span class="p">(</span><span class="s">&quot;reactionTypeA&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;the reaction type was not supported by the solver&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">reactionTypes</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="linenos"> 425</span><span class="w">    	</span><span class="p">}</span>
<span class="linenos"> 426</span><span class="w">    </span><span class="p">}</span>
<span class="linenos"> 427</span>
<span class="linenos"> 428</span><span class="w">    </span><span class="c1">// Setup the cuda S matrix.</span>
<span class="linenos"> 429</span><span class="w">    </span><span class="n">model_S</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="kt">int8_t</span><span class="p">[</span><span class="n">numberSpecies</span><span class="o">*</span><span class="n">numberReactions</span><span class="p">];</span>
<span class="linenos"> 430</span>
<span class="linenos"> 431</span><span class="w">	</span><span class="k">for</span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">rx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">rx</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">numberReactions</span><span class="p">;</span><span class="w"> </span><span class="n">rx</span><span class="o">++</span><span class="p">)</span>
<span class="linenos"> 432</span><span class="w">	</span><span class="p">{</span>
<span class="linenos"> 433</span><span class="w">		</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">p</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">p</span><span class="o">&lt;</span><span class="n">numberSpecies</span><span class="p">;</span><span class="w"> </span><span class="n">p</span><span class="o">++</span><span class="p">)</span>
<span class="linenos"> 434</span><span class="w">		</span><span class="p">{</span>
<span class="linenos"> 435</span><span class="w">			</span><span class="c1">//tmpS[numberSpecies*rx + p] = S[numberSpecies*rx + p];</span>
<span class="linenos"> 436</span><span class="w">			</span><span class="n">model_S</span><span class="p">[</span><span class="n">rx</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">numberSpecies</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">p</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">S</span><span class="p">[</span><span class="n">numberReactions</span><span class="o">*</span><span class="n">p</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">rx</span><span class="p">];</span>
<span class="linenos"> 437</span><span class="w">		</span><span class="p">}</span>
<span class="linenos"> 438</span><span class="w">	</span><span class="p">}</span>
<span class="linenos"> 439</span><span class="p">}</span>
<span class="linenos"> 440</span>
<span class="linenos"> 441</span><span class="kt">void</span><span class="w"> </span><span class="n">MGPUMpdRdmeSolver</span><span class="o">::</span><span class="n">buildDiffusionModel</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">uint</span><span class="w"> </span><span class="n">numberSiteTypesA</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">DFA</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">uint</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">RLA</span><span class="p">,</span><span class="w"> </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">latticeXSize</span><span class="p">,</span><span class="w"> </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">latticeYSize</span><span class="p">,</span><span class="w"> </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">latticeZSize</span><span class="p">,</span><span class="w"> </span><span class="n">site_size_t</span><span class="w"> </span><span class="n">particlesPerSite</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">bytes_per_particle</span><span class="p">,</span><span class="w"> </span><span class="n">si_dist_t</span><span class="w"> </span><span class="n">latticeSpacing</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">latticeData</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">latticeSitesData</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">rowMajorData</span><span class="p">)</span>
<span class="linenos"> 442</span><span class="p">{</span>
<span class="linenos"> 443</span><span class="w">    </span><span class="n">RDMESolver</span><span class="o">::</span><span class="n">buildDiffusionModel</span><span class="p">(</span><span class="n">numberSiteTypesA</span><span class="p">,</span><span class="w"> </span><span class="n">DFA</span><span class="p">,</span><span class="w"> </span><span class="n">RLA</span><span class="p">,</span><span class="w"> </span><span class="n">latticeXSize</span><span class="p">,</span><span class="w"> </span><span class="n">latticeYSize</span><span class="p">,</span><span class="w"> </span><span class="n">latticeZSize</span><span class="p">,</span><span class="w"> </span><span class="n">particlesPerSite</span><span class="p">,</span><span class="w"> </span><span class="n">bytes_per_particle</span><span class="p">,</span><span class="w"> </span><span class="n">latticeSpacing</span><span class="p">,</span><span class="w"> </span><span class="n">latticeData</span><span class="p">,</span><span class="w"> </span><span class="n">latticeSitesData</span><span class="p">,</span><span class="w"> </span><span class="n">rowMajorData</span><span class="p">);</span>
<span class="linenos"> 444</span>
<span class="linenos"> 445</span><span class="w">    </span><span class="c1">// Get the time step.</span>
<span class="linenos"> 446</span><span class="w">    </span><span class="n">tau</span><span class="o">=</span><span class="n">atof</span><span class="p">((</span><span class="o">*</span><span class="n">parameters</span><span class="p">)[</span><span class="s">&quot;timestep&quot;</span><span class="p">].</span><span class="n">c_str</span><span class="p">());</span>
<span class="linenos"> 447</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tau</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">)</span><span class="w"> </span><span class="n">throw</span><span class="w"> </span><span class="n">InvalidArgException</span><span class="p">(</span><span class="s">&quot;timestep&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;A positive timestep must be specified for the solver.&quot;</span><span class="p">);</span>
<span class="linenos"> 448</span>
<span class="linenos"> 449</span><span class="w">    </span><span class="c1">// Setup the cuda transition matrix.</span>
<span class="linenos"> 450</span><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">DFmatrixSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">numberSpecies</span><span class="o">*</span><span class="n">numberSiteTypes</span><span class="o">*</span><span class="n">numberSiteTypes</span><span class="p">;</span>
<span class="linenos"> 451</span>
<span class="linenos"> 452</span><span class="cp">#ifndef MPD_GLOBAL_T_MATRIX</span>
<span class="linenos"> 453</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">DFmatrixSize</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">MPD_MAX_TRANSITION_TABLE_ENTRIES</span><span class="p">)</span><span class="w"> </span><span class="n">throw</span><span class="w"> </span><span class="n">Exception</span><span class="p">(</span><span class="s">&quot;The number of transition table entries exceeds the maximum supported by the solver.&quot;</span><span class="p">);</span>
<span class="linenos"> 454</span><span class="cp">#endif</span>
<span class="linenos"> 455</span>
<span class="linenos"> 456</span><span class="cp">#ifndef MPD_GLOBAL_S_MATRIX</span>
<span class="linenos"> 457</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">numberReactions</span><span class="o">*</span><span class="n">numberSiteTypes</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">MPD_MAX_RL_MATRIX_ENTRIES</span><span class="p">)</span><span class="w"> </span><span class="n">throw</span><span class="w"> </span><span class="n">Exception</span><span class="p">(</span><span class="s">&quot;The number of RL matrix entries exceeds the maximum supported by the solver.&quot;</span><span class="p">);</span>
<span class="linenos"> 458</span><span class="cp">#endif</span>
<span class="linenos"> 459</span>
<span class="linenos"> 460</span><span class="w">    </span><span class="c1">// Calculate the probability from the diffusion coefficient and the lattice properties.</span>
<span class="linenos"> 461</span><span class="w">    </span><span class="cm">/*</span>
<span class="linenos"> 462</span><span class="cm">     * p0 = probability of staying at the site, q = probability of moving in plus or minus direction</span>
<span class="linenos"> 463</span><span class="cm">     *</span>
<span class="linenos"> 464</span><span class="cm">     * D=(1-p0)*lambda^2/2*tau</span>
<span class="linenos"> 465</span><span class="cm">     * q=(1-p0)/2</span>
<span class="linenos"> 466</span><span class="cm">     * D=2q*lambda^2/2*tau</span>
<span class="linenos"> 467</span><span class="cm">     * q=D*tau/lambda^2</span>
<span class="linenos"> 468</span><span class="cm">     */</span>
<span class="linenos"> 469</span><span class="w">    </span><span class="n">model_T</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="kt">float</span><span class="p">[</span><span class="n">DFmatrixSize</span><span class="p">];</span>
<span class="linenos"> 470</span><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">DFmatrixSize</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="linenos"> 471</span><span class="w">    </span><span class="p">{</span>
<span class="linenos"> 472</span><span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">q</span><span class="o">=</span><span class="p">(</span><span class="kt">float</span><span class="p">)(</span><span class="n">DF</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">tau</span><span class="o">/</span><span class="n">pow</span><span class="p">(</span><span class="n">latticeSpacing</span><span class="p">,</span><span class="mi">2</span><span class="p">));</span>
<span class="linenos"> 473</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">q</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0.50f</span><span class="p">)</span><span class="w"> </span><span class="n">throw</span><span class="w"> </span><span class="n">InvalidArgException</span><span class="p">(</span><span class="s">&quot;D&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;The specified diffusion coefficient is too high for the diffusion model.&quot;</span><span class="p">);</span>
<span class="linenos"> 474</span><span class="w">        </span><span class="n">model_T</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">q</span><span class="p">;</span>
<span class="linenos"> 475</span><span class="w">    </span><span class="p">}</span>
<span class="linenos"> 476</span>
<span class="linenos"> 477</span><span class="w">    </span><span class="c1">// Setup the cuda reaction location matrix.</span>
<span class="linenos"> 478</span><span class="w">    </span><span class="n">model_RL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="kt">uint8_t</span><span class="p">[</span><span class="n">numberReactions</span><span class="o">*</span><span class="n">numberSiteTypes</span><span class="p">];</span>
<span class="linenos"> 479</span><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">numberReactions</span><span class="o">*</span><span class="n">numberSiteTypes</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="linenos"> 480</span><span class="w">    </span><span class="p">{</span>
<span class="linenos"> 481</span><span class="w">    	</span><span class="n">model_RL</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">RL</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="linenos"> 482</span><span class="w">    </span><span class="p">}</span>
<span class="linenos"> 483</span>
<span class="linenos"> 484</span><span class="w">    </span><span class="c1">// Set the cuda reaction model rates now that we have the subvolume size.</span>
<span class="linenos"> 485</span><span class="w">    </span><span class="n">model_reactionRates</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="kt">float</span><span class="p">[</span><span class="n">numberReactions</span><span class="p">];</span>
<span class="linenos"> 486</span>
<span class="linenos"> 487</span><span class="w">	</span><span class="c1">// Set up pre-configured propensity matrices</span>
<span class="linenos"> 488</span><span class="w">	</span><span class="n">zeroOrderSize</span><span class="o">=</span><span class="n">numberSiteTypes</span><span class="p">;</span>
<span class="linenos"> 489</span><span class="w">	</span><span class="n">firstOrderSize</span><span class="o">=</span><span class="n">numberSpecies</span><span class="o">*</span><span class="n">numberSiteTypes</span><span class="p">;</span>
<span class="linenos"> 490</span><span class="w">	</span><span class="n">secondOrderSize</span><span class="o">=</span><span class="n">numberSpecies</span><span class="o">*</span><span class="n">numberSpecies</span><span class="o">*</span><span class="n">numberSiteTypes</span><span class="p">;</span>
<span class="linenos"> 491</span><span class="w">	</span><span class="n">zeroOrder</span><span class="o">=</span><span class="n">new</span><span class="w"> </span><span class="kt">float</span><span class="p">[</span><span class="n">zeroOrderSize</span><span class="p">];</span>
<span class="linenos"> 492</span><span class="w">	</span><span class="n">firstOrder</span><span class="o">=</span><span class="n">new</span><span class="w"> </span><span class="kt">float</span><span class="p">[</span><span class="n">firstOrderSize</span><span class="p">];</span>
<span class="linenos"> 493</span><span class="w">	</span><span class="n">secondOrder</span><span class="o">=</span><span class="n">new</span><span class="w"> </span><span class="kt">float</span><span class="p">[</span><span class="n">secondOrderSize</span><span class="p">];</span>
<span class="linenos"> 494</span>
<span class="linenos"> 495</span><span class="w">	</span><span class="n">computePropensities</span><span class="p">();</span>
<span class="linenos"> 496</span><span class="w">	</span><span class="n">reactionModelModified</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="linenos"> 497</span><span class="p">}</span>
<span class="linenos"> 498</span>
<span class="linenos"> 499</span><span class="kt">void</span><span class="w"> </span><span class="n">MGPUMpdRdmeSolver</span><span class="o">::</span><span class="n">computePropensities</span><span class="p">()</span>
<span class="linenos"> 500</span><span class="p">{</span>
<span class="linenos"> 501</span><span class="w">	</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeXSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getXSize</span><span class="p">();</span>
<span class="linenos"> 502</span><span class="w">	</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeYSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getYSize</span><span class="p">();</span>
<span class="linenos"> 503</span><span class="w">	</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeZSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getZSize</span><span class="p">();</span>
<span class="linenos"> 504</span><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">numberReactions</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="linenos"> 505</span><span class="w">    </span><span class="p">{</span>
<span class="linenos"> 506</span><span class="w">    	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">reactionTypes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ZerothOrderPropensityArgs</span><span class="o">::</span><span class="n">REACTION_TYPE</span><span class="p">)</span>
<span class="linenos"> 507</span><span class="w">    	</span><span class="p">{</span>
<span class="linenos"> 508</span><span class="w">    		</span><span class="n">model_reactionRates</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="n">ZerothOrderPropensityArgs</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">propensityFunctionArgs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">-&gt;</span><span class="n">k</span><span class="o">*</span><span class="n">tau</span><span class="o">/</span><span class="p">(</span><span class="n">latticeXSize</span><span class="o">*</span><span class="n">latticeYSize</span><span class="o">*</span><span class="n">latticeZSize</span><span class="p">);</span>
<span class="linenos"> 509</span><span class="w">    	</span><span class="p">}</span>
<span class="linenos"> 510</span><span class="w">    	</span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">reactionTypes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">FirstOrderPropensityArgs</span><span class="o">::</span><span class="n">REACTION_TYPE</span><span class="p">)</span>
<span class="linenos"> 511</span><span class="w">    	</span><span class="p">{</span>
<span class="linenos"> 512</span><span class="w">    		</span><span class="n">model_reactionRates</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="n">FirstOrderPropensityArgs</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">propensityFunctionArgs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">-&gt;</span><span class="n">k</span><span class="o">*</span><span class="n">tau</span><span class="p">;</span>
<span class="linenos"> 513</span><span class="w">    	</span><span class="p">}</span>
<span class="linenos"> 514</span><span class="w">    	</span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">reactionTypes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">SecondOrderPropensityArgs</span><span class="o">::</span><span class="n">REACTION_TYPE</span><span class="p">)</span>
<span class="linenos"> 515</span><span class="w">    	</span><span class="p">{</span>
<span class="linenos"> 516</span><span class="w">    		</span><span class="n">model_reactionRates</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="n">SecondOrderPropensityArgs</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">propensityFunctionArgs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">-&gt;</span><span class="n">k</span><span class="o">*</span><span class="n">tau</span><span class="o">*</span><span class="n">latticeXSize</span><span class="o">*</span><span class="n">latticeYSize</span><span class="o">*</span><span class="n">latticeZSize</span><span class="p">;</span>
<span class="linenos"> 517</span><span class="w">    	</span><span class="p">}</span>
<span class="linenos"> 518</span><span class="w">    	</span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">reactionTypes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">SecondOrderSelfPropensityArgs</span><span class="o">::</span><span class="n">REACTION_TYPE</span><span class="p">)</span>
<span class="linenos"> 519</span><span class="w">    	</span><span class="p">{</span>
<span class="linenos"> 520</span><span class="w">    		</span><span class="n">model_reactionRates</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="n">SecondOrderSelfPropensityArgs</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">propensityFunctionArgs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">-&gt;</span><span class="n">k</span><span class="o">*</span><span class="n">tau</span><span class="o">*</span><span class="n">latticeXSize</span><span class="o">*</span><span class="n">latticeYSize</span><span class="o">*</span><span class="n">latticeZSize</span><span class="p">;</span>
<span class="linenos"> 521</span><span class="w">    	</span><span class="p">}</span>
<span class="linenos"> 522</span><span class="w">    	</span><span class="k">else</span>
<span class="linenos"> 523</span><span class="w">    	</span><span class="p">{</span>
<span class="linenos"> 524</span><span class="w">    		</span><span class="n">throw</span><span class="w"> </span><span class="n">InvalidArgException</span><span class="p">(</span><span class="s">&quot;reactionTypeA&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;the reaction type was not supported by the solver&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">reactionTypes</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="linenos"> 525</span><span class="w">    	</span><span class="p">}</span>
<span class="linenos"> 526</span><span class="w">    </span><span class="p">}</span>
<span class="linenos"> 527</span>
<span class="linenos"> 528</span><span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">scale</span><span class="o">=</span><span class="n">latticeXSize</span><span class="o">*</span><span class="n">latticeYSize</span><span class="o">*</span><span class="n">latticeZSize</span><span class="p">;</span>
<span class="linenos"> 529</span><span class="w">	</span><span class="k">for</span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">site</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">site</span><span class="o">&lt;</span><span class="n">numberSiteTypes</span><span class="p">;</span><span class="w"> </span><span class="n">site</span><span class="o">++</span><span class="p">)</span>
<span class="linenos"> 530</span><span class="w">	</span><span class="p">{</span>
<span class="linenos"> 531</span><span class="w">		</span><span class="n">uint</span><span class="w"> </span><span class="n">o1</span><span class="o">=</span><span class="n">site</span><span class="o">*</span><span class="n">numberSpecies</span><span class="p">;</span>
<span class="linenos"> 532</span><span class="w">		</span><span class="n">uint</span><span class="w"> </span><span class="n">o2</span><span class="o">=</span><span class="n">site</span><span class="o">*</span><span class="n">numberSpecies</span><span class="o">*</span><span class="n">numberSpecies</span><span class="p">;</span>
<span class="linenos"> 533</span>
<span class="linenos"> 534</span><span class="w">		</span><span class="n">zeroOrder</span><span class="p">[</span><span class="n">site</span><span class="p">]</span><span class="o">=</span><span class="mf">0.0f</span><span class="p">;</span>
<span class="linenos"> 535</span><span class="w">		</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">numberSpecies</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="linenos"> 536</span><span class="w">		</span><span class="p">{</span>
<span class="linenos"> 537</span><span class="w">			</span><span class="n">firstOrder</span><span class="p">[</span><span class="n">o1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="mf">0.0f</span><span class="p">;</span>
<span class="linenos"> 538</span><span class="w">			</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">&lt;</span><span class="n">numberSpecies</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">++</span><span class="p">)</span>
<span class="linenos"> 539</span><span class="w">				</span><span class="n">secondOrder</span><span class="p">[</span><span class="n">o2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="o">*</span><span class="n">numberSpecies</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="p">]</span><span class="o">=</span><span class="mf">0.0f</span><span class="p">;</span><span class="w">	</span>
<span class="linenos"> 540</span><span class="w">		</span><span class="p">}</span>
<span class="linenos"> 541</span>
<span class="linenos"> 542</span><span class="w">		</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">numberReactions</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="linenos"> 543</span><span class="w">		</span><span class="p">{</span>
<span class="linenos"> 544</span><span class="w">			</span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="w"> </span><span class="n">RL</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="n">numberSiteTypes</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">site</span><span class="p">])</span>
<span class="linenos"> 545</span><span class="w">				</span><span class="k">continue</span><span class="p">;</span>
<span class="linenos"> 546</span>
<span class="linenos"> 547</span><span class="w">			</span><span class="k">switch</span><span class="p">(</span><span class="n">reactionTypes</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
<span class="linenos"> 548</span><span class="w">			</span><span class="p">{</span>
<span class="linenos"> 549</span><span class="w">				</span><span class="k">case</span><span class="w"> </span><span class="no">ZerothOrderPropensityArgs</span><span class="o">::</span><span class="no">REACTION_TYPE</span><span class="p">:</span>
<span class="linenos"> 550</span><span class="w">				</span><span class="p">{</span>
<span class="linenos"> 551</span><span class="w">					</span><span class="n">ZerothOrderPropensityArgs</span><span class="w"> </span><span class="o">*</span><span class="n">rx</span><span class="o">=</span><span class="p">(</span><span class="n">ZerothOrderPropensityArgs</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">propensityFunctionArgs</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="linenos"> 552</span><span class="w">					</span><span class="n">zeroOrder</span><span class="p">[</span><span class="n">site</span><span class="p">]</span><span class="o">+=</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">k</span><span class="o">*</span><span class="n">tau</span><span class="o">/</span><span class="n">scale</span><span class="p">;</span>
<span class="linenos"> 553</span><span class="w">				</span><span class="p">}</span><span class="w">   </span><span class="k">break</span><span class="p">;</span>
<span class="linenos"> 554</span>
<span class="linenos"> 555</span><span class="w">				</span><span class="k">case</span><span class="w"> </span><span class="no">FirstOrderPropensityArgs</span><span class="o">::</span><span class="no">REACTION_TYPE</span><span class="p">:</span>
<span class="linenos"> 556</span><span class="w">				</span><span class="p">{</span>
<span class="linenos"> 557</span><span class="w">					</span><span class="n">FirstOrderPropensityArgs</span><span class="w"> </span><span class="o">*</span><span class="n">rx</span><span class="o">=</span><span class="p">(</span><span class="n">FirstOrderPropensityArgs</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">propensityFunctionArgs</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="linenos"> 558</span><span class="w">					</span><span class="n">firstOrder</span><span class="p">[</span><span class="n">o1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">si</span><span class="p">]</span><span class="o">+=</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">k</span><span class="o">*</span><span class="n">tau</span><span class="p">;</span>
<span class="linenos"> 559</span><span class="w">				</span><span class="p">}</span><span class="w">   </span><span class="k">break</span><span class="p">;</span>
<span class="linenos"> 560</span><span class="w">				</span>
<span class="linenos"> 561</span><span class="w">				</span><span class="k">case</span><span class="w"> </span><span class="no">SecondOrderPropensityArgs</span><span class="o">::</span><span class="no">REACTION_TYPE</span><span class="p">:</span>
<span class="linenos"> 562</span><span class="w">				</span><span class="p">{</span>
<span class="linenos"> 563</span><span class="w">					</span><span class="n">SecondOrderPropensityArgs</span><span class="w"> </span><span class="o">*</span><span class="n">rx</span><span class="o">=</span><span class="p">(</span><span class="n">SecondOrderPropensityArgs</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">propensityFunctionArgs</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="linenos"> 564</span><span class="w">					</span><span class="n">secondOrder</span><span class="p">[</span><span class="n">o2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">s1i</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">numberSpecies</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">s2i</span><span class="p">)]</span><span class="o">=</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">k</span><span class="o">*</span><span class="n">tau</span><span class="o">*</span><span class="n">scale</span><span class="p">;</span>
<span class="linenos"> 565</span><span class="w">					</span><span class="n">secondOrder</span><span class="p">[</span><span class="n">o2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">s2i</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">numberSpecies</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">s1i</span><span class="p">)]</span><span class="o">=</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">k</span><span class="o">*</span><span class="n">tau</span><span class="o">*</span><span class="n">scale</span><span class="p">;</span>
<span class="linenos"> 566</span><span class="w">				</span><span class="p">}</span><span class="w">   </span><span class="k">break</span><span class="p">;</span><span class="w"> </span>
<span class="linenos"> 567</span>
<span class="linenos"> 568</span><span class="w">				</span><span class="k">case</span><span class="w"> </span><span class="no">SecondOrderSelfPropensityArgs</span><span class="o">::</span><span class="no">REACTION_TYPE</span><span class="p">:</span>
<span class="linenos"> 569</span><span class="w">				</span><span class="p">{</span>
<span class="linenos"> 570</span><span class="w">					</span><span class="n">SecondOrderSelfPropensityArgs</span><span class="w"> </span><span class="o">*</span><span class="n">rx</span><span class="o">=</span><span class="p">(</span><span class="n">SecondOrderSelfPropensityArgs</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">propensityFunctionArgs</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="linenos"> 571</span><span class="w">					</span><span class="n">secondOrder</span><span class="p">[</span><span class="n">o2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">si</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">numberSpecies</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">si</span><span class="p">)]</span><span class="o">+=</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">k</span><span class="o">*</span><span class="n">tau</span><span class="o">*</span><span class="n">scale</span><span class="o">*</span><span class="mi">2</span><span class="p">;</span>
<span class="linenos"> 572</span><span class="w">				</span><span class="p">}</span>
<span class="linenos"> 573</span><span class="w">			</span><span class="p">}</span>
<span class="linenos"> 574</span><span class="w">		</span><span class="p">}</span>
<span class="linenos"> 575</span><span class="w">	</span><span class="p">}</span>
<span class="linenos"> 576</span><span class="p">}</span>
<span class="linenos"> 577</span>
<span class="linenos"> 578</span><span class="kt">void</span><span class="w"> </span><span class="n">MGPUMpdRdmeSolver</span><span class="o">::</span><span class="n">copyModelsToDevice</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">gpu</span><span class="p">)</span>
<span class="linenos"> 579</span><span class="p">{</span>
<span class="linenos"> 580</span><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">DFmatrixSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">numberSpecies</span><span class="o">*</span><span class="n">numberSiteTypes</span><span class="o">*</span><span class="n">numberSiteTypes</span><span class="p">;</span>
<span class="linenos"> 581</span><span class="w">	</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeXSize</span><span class="o">=</span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">segment</span><span class="o">-&gt;</span><span class="n">local_dimensions</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
<span class="linenos"> 582</span><span class="w">	</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeYSize</span><span class="o">=</span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">segment</span><span class="o">-&gt;</span><span class="n">local_dimensions</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
<span class="linenos"> 583</span><span class="w">	</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeZSize</span><span class="o">=</span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">segment</span><span class="o">-&gt;</span><span class="n">local_dimensions</span><span class="p">.</span><span class="n">z</span><span class="p">;</span>
<span class="linenos"> 584</span><span class="w">	</span>
<span class="linenos"> 585</span><span class="w">	</span><span class="c1">// the lattice{X,XY,XYZ}SizeC refer to sizes of the LOCAL lattice.</span>
<span class="linenos"> 586</span><span class="w">	</span><span class="c1">// NOTE that since we have 1D diffusion only, the global X and XY sizes are the same.</span>
<span class="linenos"> 587</span><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeXYSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">latticeXSize</span><span class="o">*</span><span class="n">latticeYSize</span><span class="p">;</span>
<span class="linenos"> 588</span><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeXYZSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">latticeXSize</span><span class="o">*</span><span class="n">latticeYSize</span><span class="o">*</span><span class="n">latticeZSize</span><span class="p">;</span>
<span class="linenos"> 589</span>
<span class="linenos"> 590</span><span class="w">	</span><span class="c1">// gloal_latticeXYZSizeC is the full lattice XYZ size.  </span>
<span class="linenos"> 591</span><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">global_latticeZSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getZSize</span><span class="p">();</span>
<span class="linenos"> 592</span><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">global_latticeXYZSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">latticeXSize</span><span class="o">*</span><span class="n">latticeYSize</span><span class="o">*</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getZSize</span><span class="p">();</span>
<span class="linenos"> 593</span>
<span class="linenos"> 594</span><span class="w">    </span><span class="c1">// Copy the reaction model and S matrix to constant memory on the GPU.</span>
<span class="linenos"> 595</span><span class="cp">#ifdef MPD_GLOBAL_R_MATRIX</span>
<span class="linenos"> 596</span><span class="w">    </span><span class="c1">// R matrix put in global memory</span>
<span class="linenos"> 597</span><span class="w">    </span><span class="c1">//cudaMalloc(&amp;numberReactionsG, sizeof(unsigned int));</span>
<span class="linenos"> 598</span><span class="w">    </span><span class="c1">//cudaMemcpy(numberReactionsG, &amp;numberReactions, sizeof(unsigned int), cudaMemcpyHostToDevice);</span>
<span class="linenos"> 599</span><span class="w">    </span><span class="n">CUDA_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">cudaMemcpyToSymbol</span><span class="p">(</span><span class="n">numberReactionsC</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">numberReactions</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="p">)));</span>
<span class="linenos"> 600</span><span class="w">    </span><span class="n">cudaMalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">reactionOrdersG</span><span class="p">),</span><span class="w"> </span><span class="n">numberReactions</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="p">));</span>
<span class="linenos"> 601</span><span class="w">    </span><span class="n">cudaMemcpy</span><span class="p">(</span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">reactionOrdersG</span><span class="p">,</span><span class="w"> </span><span class="n">model_reactionOrders</span><span class="p">,</span><span class="w"> </span><span class="n">numberReactions</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="p">),</span><span class="w"> </span><span class="n">cudaMemcpyHostToDevice</span><span class="p">);</span>
<span class="linenos"> 602</span><span class="w">    </span><span class="n">cudaMalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">reactionSitesG</span><span class="p">),</span><span class="w"> </span><span class="n">numberReactions</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="p">));</span>
<span class="linenos"> 603</span><span class="w">    </span><span class="n">cudaMemcpy</span><span class="p">(</span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">reactionSitesG</span><span class="p">,</span><span class="w"> </span><span class="n">model_reactionSites</span><span class="p">,</span><span class="w"> </span><span class="n">numberReactions</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="p">),</span><span class="w"> </span><span class="n">cudaMemcpyHostToDevice</span><span class="p">);</span>
<span class="linenos"> 604</span><span class="w">    </span><span class="n">cudaMalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">D1G</span><span class="p">),</span><span class="w"> </span><span class="n">numberReactions</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="p">));</span>
<span class="linenos"> 605</span><span class="w">    </span><span class="n">cudaMemcpy</span><span class="p">(</span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">D1G</span><span class="p">,</span><span class="w"> </span><span class="n">model_D1</span><span class="p">,</span><span class="w"> </span><span class="n">numberReactions</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="p">),</span><span class="w"> </span><span class="n">cudaMemcpyHostToDevice</span><span class="p">);</span>
<span class="linenos"> 606</span><span class="w">    </span><span class="n">cudaMalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">D2G</span><span class="p">),</span><span class="w"> </span><span class="n">numberReactions</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="p">));</span>
<span class="linenos"> 607</span><span class="w">    </span><span class="n">cudaMemcpy</span><span class="p">(</span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">D2G</span><span class="p">,</span><span class="w"> </span><span class="n">model_D2</span><span class="p">,</span><span class="w"> </span><span class="n">numberReactions</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="p">),</span><span class="w"> </span><span class="n">cudaMemcpyHostToDevice</span><span class="p">);</span>
<span class="linenos"> 608</span><span class="cp">#else</span>
<span class="linenos"> 609</span><span class="w">    </span><span class="n">CUDA_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">cudaMemcpyToSymbol</span><span class="p">(</span><span class="n">numberReactionsC</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">numberReactions</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="p">)));</span>
<span class="linenos"> 610</span><span class="w">    </span><span class="n">CUDA_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">cudaMemcpyToSymbol</span><span class="p">(</span><span class="n">reactionOrdersC</span><span class="p">,</span><span class="w"> </span><span class="n">model_reactionOrders</span><span class="p">,</span><span class="w"> </span><span class="n">numberReactions</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="p">)));</span>
<span class="linenos"> 611</span><span class="w">    </span><span class="n">CUDA_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">cudaMemcpyToSymbol</span><span class="p">(</span><span class="n">reactionSitesC</span><span class="p">,</span><span class="w"> </span><span class="n">model_reactionSites</span><span class="p">,</span><span class="w"> </span><span class="n">numberReactions</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="p">)));</span>
<span class="linenos"> 612</span><span class="w">    </span><span class="n">CUDA_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">cudaMemcpyToSymbol</span><span class="p">(</span><span class="n">D1C</span><span class="p">,</span><span class="w"> </span><span class="n">model_D1</span><span class="p">,</span><span class="w"> </span><span class="n">numberReactions</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="p">)));</span>
<span class="linenos"> 613</span><span class="w">    </span><span class="n">CUDA_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">cudaMemcpyToSymbol</span><span class="p">(</span><span class="n">D2C</span><span class="p">,</span><span class="w"> </span><span class="n">model_D2</span><span class="p">,</span><span class="w"> </span><span class="n">numberReactions</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="p">)));</span>
<span class="linenos"> 614</span><span class="cp">#endif</span>
<span class="linenos"> 615</span>
<span class="linenos"> 616</span><span class="cp">#ifdef MPD_GLOBAL_S_MATRIX</span>
<span class="linenos"> 617</span><span class="w">	</span><span class="c1">// If S matrix stored in global memory, allocate space and perform copy</span>
<span class="linenos"> 618</span><span class="w">	</span><span class="n">cudaMalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">SG</span><span class="p">),</span><span class="w"> </span><span class="n">numberSpecies</span><span class="o">*</span><span class="n">numberReactions</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int8_t</span><span class="p">));</span>
<span class="linenos"> 619</span><span class="w">	</span><span class="n">cudaMemcpy</span><span class="p">(</span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">SG</span><span class="p">,</span><span class="w"> </span><span class="n">model_S</span><span class="p">,</span><span class="w"> </span><span class="n">numberSpecies</span><span class="o">*</span><span class="n">numberReactions</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int8_t</span><span class="p">),</span><span class="w"> </span><span class="n">cudaMemcpyHostToDevice</span><span class="p">);</span>
<span class="linenos"> 620</span><span class="cp">#else</span>
<span class="linenos"> 621</span><span class="w">	</span><span class="c1">// S matrix is in constant memory</span>
<span class="linenos"> 622</span><span class="w">    </span><span class="n">CUDA_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">cudaMemcpyToSymbol</span><span class="p">(</span><span class="n">SC</span><span class="p">,</span><span class="w"> </span><span class="n">model_S</span><span class="p">,</span><span class="w"> </span><span class="n">numberSpecies</span><span class="o">*</span><span class="n">numberReactions</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int8_t</span><span class="p">)));</span>
<span class="linenos"> 623</span><span class="cp">#endif</span>
<span class="linenos"> 624</span>
<span class="linenos"> 625</span><span class="cp">#ifdef MPD_GLOBAL_T_MATRIX</span>
<span class="linenos"> 626</span><span class="w">	</span><span class="n">CUDA_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">cudaMalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">TG</span><span class="p">),</span><span class="w"> </span><span class="n">DFmatrixSize</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">)));</span>
<span class="linenos"> 627</span><span class="w">	</span><span class="n">CUDA_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">cudaMemcpy</span><span class="p">(</span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">TG</span><span class="p">,</span><span class="w"> </span><span class="n">model_T</span><span class="p">,</span><span class="w"> </span><span class="n">DFmatrixSize</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">),</span><span class="w"> </span><span class="n">cudaMemcpyHostToDevice</span><span class="p">));</span>
<span class="linenos"> 628</span><span class="w">    </span><span class="n">CUDA_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">cudaMemcpyToSymbol</span><span class="p">(</span><span class="n">TC</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="p">(</span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">TG</span><span class="p">),</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="o">*</span><span class="p">)));</span>
<span class="linenos"> 629</span><span class="cp">#else</span>
<span class="linenos"> 630</span><span class="w">    </span><span class="n">CUDA_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">cudaMemcpyToSymbol</span><span class="p">(</span><span class="n">TC</span><span class="p">,</span><span class="w"> </span><span class="n">model_T</span><span class="p">,</span><span class="w"> </span><span class="n">DFmatrixSize</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">)));</span>
<span class="linenos"> 631</span><span class="cp">#endif</span>
<span class="linenos"> 632</span>
<span class="linenos"> 633</span><span class="w">    </span><span class="n">CUDA_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">cudaMemcpyToSymbol</span><span class="p">(</span><span class="n">numberSpeciesC</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">numberSpecies</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">numberSpeciesC</span><span class="p">)));</span>
<span class="linenos"> 634</span><span class="w">    </span><span class="n">CUDA_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">cudaMemcpyToSymbol</span><span class="p">(</span><span class="n">numberSiteTypesC</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">numberSiteTypes</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">numberSiteTypesC</span><span class="p">)));</span>
<span class="linenos"> 635</span><span class="w">    </span><span class="n">CUDA_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">cudaMemcpyToSymbol</span><span class="p">(</span><span class="n">latticeXSizeC</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">latticeXSize</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">latticeYSizeC</span><span class="p">)));</span>
<span class="linenos"> 636</span><span class="w">    </span><span class="n">CUDA_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">cudaMemcpyToSymbol</span><span class="p">(</span><span class="n">latticeYSizeC</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">latticeYSize</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">latticeYSizeC</span><span class="p">)));</span>
<span class="linenos"> 637</span><span class="w">    </span><span class="n">CUDA_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">cudaMemcpyToSymbol</span><span class="p">(</span><span class="n">latticeZSizeC</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">latticeZSize</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">latticeZSizeC</span><span class="p">)));</span>
<span class="linenos"> 638</span><span class="w">    </span><span class="n">CUDA_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">cudaMemcpyToSymbol</span><span class="p">(</span><span class="n">latticeXYSizeC</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">latticeXYSize</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">latticeXYSizeC</span><span class="p">)));</span>
<span class="linenos"> 639</span><span class="w">    </span><span class="n">CUDA_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">cudaMemcpyToSymbol</span><span class="p">(</span><span class="n">latticeXYZSizeC</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">latticeXYZSize</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">latticeXYZSizeC</span><span class="p">)));</span>
<span class="linenos"> 640</span><span class="w">    </span><span class="n">CUDA_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">cudaMemcpyToSymbol</span><span class="p">(</span><span class="n">global_latticeZSizeC</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">global_latticeZSize</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">global_latticeZSizeC</span><span class="p">)));</span>
<span class="linenos"> 641</span><span class="w">    </span><span class="n">CUDA_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">cudaMemcpyToSymbol</span><span class="p">(</span><span class="n">global_latticeXYZSizeC</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">global_latticeXYZSize</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">global_latticeXYZSizeC</span><span class="p">)));</span>
<span class="linenos"> 642</span><span class="cp">#ifdef MPD_GLOBAL_S_MATRIX</span>
<span class="linenos"> 643</span><span class="w">	</span><span class="c1">// Store RL in global memory too, since I&#39;m going to assume if S is too big, then RL is too.</span>
<span class="linenos"> 644</span><span class="w">	</span><span class="n">cudaMalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">RLG</span><span class="p">),</span><span class="w"> </span><span class="n">numberReactions</span><span class="o">*</span><span class="n">numberSiteTypes</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">uint8_t</span><span class="p">));</span>
<span class="linenos"> 645</span><span class="w">	</span><span class="n">cudaMemcpy</span><span class="p">(</span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">RLG</span><span class="p">,</span><span class="w"> </span><span class="n">model_RL</span><span class="p">,</span><span class="w"> </span><span class="n">numberReactions</span><span class="o">*</span><span class="n">numberSiteTypes</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">uint8_t</span><span class="p">),</span><span class="w"> </span><span class="n">cudaMemcpyHostToDevice</span><span class="p">);</span>
<span class="linenos"> 646</span><span class="cp">#else</span>
<span class="linenos"> 647</span><span class="w">	</span><span class="c1">// RL is stored in constant memory</span>
<span class="linenos"> 648</span><span class="w">    </span><span class="n">CUDA_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">cudaMemcpyToSymbol</span><span class="p">(</span><span class="n">RLC</span><span class="p">,</span><span class="w"> </span><span class="n">model_RL</span><span class="p">,</span><span class="w"> </span><span class="n">numberReactions</span><span class="o">*</span><span class="n">numberSiteTypes</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">uint8_t</span><span class="p">)));</span>
<span class="linenos"> 649</span><span class="cp">#endif</span>
<span class="linenos"> 650</span>
<span class="linenos"> 651</span><span class="cp">#ifdef MPD_GLOBAL_R_MATRIX</span>
<span class="linenos"> 652</span><span class="w">    </span><span class="n">cudaMalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">reactionRatesG</span><span class="p">),</span><span class="w"> </span><span class="n">numberReactions</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">));</span>
<span class="linenos"> 653</span><span class="w">    </span><span class="n">cudaMemcpy</span><span class="p">(</span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">reactionRatesG</span><span class="p">,</span><span class="w"> </span><span class="n">model_reactionRates</span><span class="p">,</span><span class="w"> </span><span class="n">numberReactions</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">),</span><span class="w"> </span><span class="n">cudaMemcpyHostToDevice</span><span class="p">);</span>
<span class="linenos"> 654</span><span class="cp">#else</span>
<span class="linenos"> 655</span><span class="w">    </span><span class="n">CUDA_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">cudaMemcpyToSymbol</span><span class="p">(</span><span class="n">reactionRatesC</span><span class="p">,</span><span class="w"> </span><span class="n">model_reactionRates</span><span class="p">,</span><span class="w"> </span><span class="n">numberReactions</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">)));</span>
<span class="linenos"> 656</span><span class="cp">#endif</span>
<span class="linenos"> 657</span>
<span class="linenos"> 658</span><span class="w">	</span><span class="c1">// Copy per-GPU global offsets</span>
<span class="linenos"> 659</span><span class="w">    </span><span class="c1">//CUDA_EXCEPTION_CHECK(cudaMemcpyToSymbol(lsizeXC, &amp;(threads[gpu].local_dimensions.x), sizeof(unsigned int)));</span>
<span class="linenos"> 660</span><span class="w">    </span><span class="c1">//CUDA_EXCEPTION_CHECK(cudaMemcpyToSymbol(lsizeYC, &amp;(threads[gpu].local_dimensions.y), sizeof(unsigned int)));</span>
<span class="linenos"> 661</span><span class="w">    </span><span class="c1">//CUDA_EXCEPTION_CHECK(cudaMemcpyToSymbol(lsizeZC, &amp;(threads[gpu].local_dimensions.z), sizeof(unsigned int)));</span>
<span class="linenos"> 662</span><span class="w">    </span><span class="n">CUDA_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">cudaMemcpyToSymbol</span><span class="p">(</span><span class="n">goffsetXC</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="p">(</span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">segment</span><span class="o">-&gt;</span><span class="n">global_offset</span><span class="p">.</span><span class="n">x</span><span class="p">),</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">)));</span>
<span class="linenos"> 663</span><span class="w">    </span><span class="n">CUDA_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">cudaMemcpyToSymbol</span><span class="p">(</span><span class="n">goffsetYC</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="p">(</span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">segment</span><span class="o">-&gt;</span><span class="n">global_offset</span><span class="p">.</span><span class="n">y</span><span class="p">),</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">)));</span>
<span class="linenos"> 664</span><span class="w">    </span><span class="n">CUDA_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">cudaMemcpyToSymbol</span><span class="p">(</span><span class="n">goffsetZC</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="p">(</span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">segment</span><span class="o">-&gt;</span><span class="n">global_offset</span><span class="p">.</span><span class="n">z</span><span class="p">),</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">)));</span>
<span class="linenos"> 665</span>
<span class="linenos"> 666</span><span class="w">    </span><span class="n">CUDA_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">cudaMemcpyToSymbol</span><span class="p">(</span><span class="n">gpuidC</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">gpu</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="p">)));</span>
<span class="linenos"> 667</span>
<span class="linenos"> 668</span><span class="w">	</span><span class="n">cudaMalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">propZeroOrder</span><span class="p">),</span><span class="w"> </span><span class="n">zeroOrderSize</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">));</span>
<span class="linenos"> 669</span><span class="w">	</span><span class="n">cudaMemcpy</span><span class="p">(</span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">propZeroOrder</span><span class="p">,</span><span class="w"> </span><span class="n">zeroOrder</span><span class="p">,</span><span class="w"> </span><span class="n">zeroOrderSize</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">),</span><span class="w"> </span><span class="n">cudaMemcpyHostToDevice</span><span class="p">);</span>
<span class="linenos"> 670</span><span class="w">	</span><span class="n">cudaMalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">propFirstOrder</span><span class="p">),</span><span class="w"> </span><span class="n">firstOrderSize</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">));</span>
<span class="linenos"> 671</span><span class="w">	</span><span class="n">cudaMemcpy</span><span class="p">(</span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">propFirstOrder</span><span class="p">,</span><span class="w"> </span><span class="n">firstOrder</span><span class="p">,</span><span class="w"> </span><span class="n">firstOrderSize</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">),</span><span class="w"> </span><span class="n">cudaMemcpyHostToDevice</span><span class="p">);</span>
<span class="linenos"> 672</span><span class="w">	</span><span class="n">cudaMalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">propSecondOrder</span><span class="p">),</span><span class="w"> </span><span class="n">secondOrderSize</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">));</span>
<span class="linenos"> 673</span><span class="w">	</span><span class="n">cudaMemcpy</span><span class="p">(</span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">propSecondOrder</span><span class="p">,</span><span class="w"> </span><span class="n">secondOrder</span><span class="p">,</span><span class="w"> </span><span class="n">secondOrderSize</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">),</span><span class="w"> </span><span class="n">cudaMemcpyHostToDevice</span><span class="p">);</span>
<span class="linenos"> 674</span><span class="w">	</span>
<span class="linenos"> 675</span><span class="w">	</span><span class="n">ZDivMultiGPUMapper</span><span class="w"> </span><span class="o">*</span><span class="n">zmap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">ZDivMultiGPUMapper</span><span class="o">*</span><span class="p">)</span><span class="n">mapper</span><span class="p">;</span>
<span class="linenos"> 676</span><span class="w">	</span><span class="n">gpu_info</span><span class="w"> </span><span class="o">*</span><span class="n">g</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zmap</span><span class="o">-&gt;</span><span class="n">getinfo</span><span class="p">(</span><span class="n">gpu</span><span class="p">);</span>
<span class="linenos"> 677</span><span class="w">	</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">tmp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">g</span><span class="o">-&gt;</span><span class="n">overlap_send</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">z</span><span class="p">;</span>
<span class="linenos"> 678</span><span class="w">	</span><span class="n">CUDA_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">cudaMemcpyToSymbol</span><span class="p">(</span><span class="n">top_send_z</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">)));</span>
<span class="linenos"> 679</span><span class="w">	</span><span class="n">tmp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">g</span><span class="o">-&gt;</span><span class="n">overlap_dim</span><span class="p">.</span><span class="n">z</span><span class="p">;</span>
<span class="linenos"> 680</span><span class="w">	</span><span class="n">CUDA_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">cudaMemcpyToSymbol</span><span class="p">(</span><span class="n">top_dim_z</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">)));</span>
<span class="linenos"> 681</span><span class="w">	</span><span class="n">tmp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DIMSIZE</span><span class="p">(</span><span class="n">g</span><span class="o">-&gt;</span><span class="n">overlap_dim</span><span class="p">);</span>
<span class="linenos"> 682</span><span class="w">	</span><span class="n">CUDA_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">cudaMemcpyToSymbol</span><span class="p">(</span><span class="n">top_dim_size</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">)));</span>
<span class="linenos"> 683</span>
<span class="linenos"> 684</span><span class="w">	</span><span class="n">tmp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">g</span><span class="o">-&gt;</span><span class="n">overlap_send</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">z</span><span class="p">;</span>
<span class="linenos"> 685</span><span class="w">	</span><span class="n">CUDA_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">cudaMemcpyToSymbol</span><span class="p">(</span><span class="n">bot_send_z</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">)));</span>
<span class="linenos"> 686</span><span class="w">	</span><span class="n">tmp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">g</span><span class="o">-&gt;</span><span class="n">overlap_dim</span><span class="p">.</span><span class="n">z</span><span class="p">;</span>
<span class="linenos"> 687</span><span class="w">	</span><span class="n">CUDA_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">cudaMemcpyToSymbol</span><span class="p">(</span><span class="n">bot_dim_z</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">)));</span>
<span class="linenos"> 688</span><span class="w">	</span><span class="n">tmp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DIMSIZE</span><span class="p">(</span><span class="n">g</span><span class="o">-&gt;</span><span class="n">overlap_dim</span><span class="p">);</span>
<span class="linenos"> 689</span><span class="w">	</span><span class="n">CUDA_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">cudaMemcpyToSymbol</span><span class="p">(</span><span class="n">bot_dim_size</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">)));</span>
<span class="linenos"> 690</span>
<span class="linenos"> 691</span><span class="w">	</span><span class="n">tmp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">g</span><span class="o">-&gt;</span><span class="n">overlap_recv</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">z</span><span class="p">;</span>
<span class="linenos"> 692</span><span class="w">	</span><span class="n">CUDA_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">cudaMemcpyToSymbol</span><span class="p">(</span><span class="n">top_recv_z</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">)));</span>
<span class="linenos"> 693</span>
<span class="linenos"> 694</span><span class="w">	</span><span class="n">tmp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">g</span><span class="o">-&gt;</span><span class="n">overlap_recv</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">z</span><span class="p">;</span>
<span class="linenos"> 695</span><span class="w">	</span><span class="n">CUDA_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">cudaMemcpyToSymbol</span><span class="p">(</span><span class="n">bot_recv_z</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">)));</span>
<span class="linenos"> 696</span><span class="p">}</span>
<span class="linenos"> 697</span>
<span class="linenos"> 698</span><span class="kt">void</span><span class="w"> </span><span class="n">MGPUMpdRdmeSolver</span><span class="o">::</span><span class="n">setReactionRate</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">rxid</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">rate</span><span class="p">)</span>
<span class="linenos"> 699</span><span class="p">{</span>
<span class="linenos"> 700</span><span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">reactionTypes</span><span class="p">[</span><span class="n">rxid</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ZerothOrderPropensityArgs</span><span class="o">::</span><span class="n">REACTION_TYPE</span><span class="p">)</span>
<span class="linenos"> 701</span><span class="w">	</span><span class="p">{</span>
<span class="linenos"> 702</span><span class="w">		</span><span class="p">((</span><span class="n">ZerothOrderPropensityArgs</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">propensityFunctionArgs</span><span class="p">[</span><span class="n">rxid</span><span class="p">])</span><span class="o">-&gt;</span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rate</span><span class="p">;</span>
<span class="linenos"> 703</span><span class="w">	</span><span class="p">}</span>
<span class="linenos"> 704</span><span class="w">	</span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">reactionTypes</span><span class="p">[</span><span class="n">rxid</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">FirstOrderPropensityArgs</span><span class="o">::</span><span class="n">REACTION_TYPE</span><span class="p">)</span>
<span class="linenos"> 705</span><span class="w">	</span><span class="p">{</span>
<span class="linenos"> 706</span><span class="w">		</span><span class="p">((</span><span class="n">FirstOrderPropensityArgs</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">propensityFunctionArgs</span><span class="p">[</span><span class="n">rxid</span><span class="p">])</span><span class="o">-&gt;</span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rate</span><span class="p">;</span>
<span class="linenos"> 707</span><span class="w">	</span><span class="p">}</span>
<span class="linenos"> 708</span><span class="w">	</span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">reactionTypes</span><span class="p">[</span><span class="n">rxid</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">SecondOrderPropensityArgs</span><span class="o">::</span><span class="n">REACTION_TYPE</span><span class="p">)</span>
<span class="linenos"> 709</span><span class="w">	</span><span class="p">{</span>
<span class="linenos"> 710</span><span class="w">		</span><span class="p">((</span><span class="n">SecondOrderPropensityArgs</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">propensityFunctionArgs</span><span class="p">[</span><span class="n">rxid</span><span class="p">])</span><span class="o">-&gt;</span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rate</span><span class="p">;</span>
<span class="linenos"> 711</span><span class="w">	</span><span class="p">}</span>
<span class="linenos"> 712</span><span class="w">	</span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">reactionTypes</span><span class="p">[</span><span class="n">rxid</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">SecondOrderSelfPropensityArgs</span><span class="o">::</span><span class="n">REACTION_TYPE</span><span class="p">)</span>
<span class="linenos"> 713</span><span class="w">	</span><span class="p">{</span>
<span class="linenos"> 714</span><span class="w">		</span><span class="p">((</span><span class="n">SecondOrderSelfPropensityArgs</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">propensityFunctionArgs</span><span class="p">[</span><span class="n">rxid</span><span class="p">])</span><span class="o">-&gt;</span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rate</span><span class="p">;</span>
<span class="linenos"> 715</span><span class="w">	</span><span class="p">}</span>
<span class="linenos"> 716</span><span class="w">	</span><span class="k">else</span>
<span class="linenos"> 717</span><span class="w">    </span><span class="p">{</span>
<span class="linenos"> 718</span><span class="w">    	</span><span class="n">throw</span><span class="w"> </span><span class="n">InvalidArgException</span><span class="p">(</span><span class="s">&quot;reactionTypeA&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;the reaction type was not supported by the solver&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">reactionTypes</span><span class="p">[</span><span class="n">rxid</span><span class="p">]);</span>
<span class="linenos"> 719</span><span class="w">    </span><span class="p">}</span>
<span class="linenos"> 720</span>
<span class="linenos"> 721</span><span class="w">	</span><span class="c1">// Flag to trigger re-computation of rdme propensities</span>
<span class="linenos"> 722</span><span class="w">	</span><span class="n">reactionModelModified</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="linenos"> 723</span><span class="p">}</span>
<span class="linenos"> 724</span>
<span class="linenos"> 725</span><span class="kt">void</span><span class="w"> </span><span class="n">MGPUMpdRdmeSolver</span><span class="o">::</span><span class="n">generateTrajectory</span><span class="p">()</span>
<span class="linenos"> 726</span><span class="p">{</span>
<span class="linenos"> 727</span><span class="w">	</span><span class="c1">// Determine how to divide the lattice</span>
<span class="linenos"> 728</span><span class="w">	</span><span class="n">initialize_decomposition</span><span class="p">();</span>
<span class="linenos"> 729</span>
<span class="linenos"> 730</span><span class="w">	</span><span class="c1">// Start worker threads</span>
<span class="linenos"> 731</span><span class="w">	</span><span class="n">start_threads</span><span class="p">();</span>
<span class="linenos"> 732</span>
<span class="linenos"> 733</span><span class="w">    </span><span class="c1">// Shadow the lattice member as a cuda lattice.</span>
<span class="linenos"> 734</span><span class="w">    </span><span class="n">ByteLattice</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">lattice</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">ByteLattice</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">lattice</span><span class="p">;</span>
<span class="linenos"> 735</span>
<span class="linenos"> 736</span><span class="w">    </span><span class="c1">// Get the interval for writing species counts and lattices.</span>
<span class="linenos"> 737</span><span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">speciesCountsWriteInterval</span><span class="o">=</span><span class="n">atol</span><span class="p">((</span><span class="o">*</span><span class="n">parameters</span><span class="p">)[</span><span class="s">&quot;writeInterval&quot;</span><span class="p">].</span><span class="n">c_str</span><span class="p">());</span>
<span class="linenos"> 738</span><span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">nextSpeciesCountsWriteTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">speciesCountsWriteInterval</span><span class="p">;</span>
<span class="linenos"> 739</span><span class="w">    </span><span class="n">lm</span><span class="o">::</span><span class="n">io</span><span class="o">::</span><span class="n">SpeciesCounts</span><span class="w"> </span><span class="n">speciesCountsDataSet</span><span class="p">;</span>
<span class="linenos"> 740</span><span class="w">    </span><span class="n">speciesCountsDataSet</span><span class="p">.</span><span class="n">set_number_species</span><span class="p">(</span><span class="n">numberSpeciesToTrack</span><span class="p">);</span>
<span class="linenos"> 741</span><span class="w">    </span><span class="n">speciesCountsDataSet</span><span class="p">.</span><span class="n">set_number_entries</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="linenos"> 742</span><span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">latticeWriteInterval</span><span class="o">=</span><span class="n">atol</span><span class="p">((</span><span class="o">*</span><span class="n">parameters</span><span class="p">)[</span><span class="s">&quot;latticeWriteInterval&quot;</span><span class="p">].</span><span class="n">c_str</span><span class="p">());</span>
<span class="linenos"> 743</span><span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">nextLatticeWriteTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">latticeWriteInterval</span><span class="p">;</span>
<span class="linenos"> 744</span><span class="w">    </span><span class="n">lm</span><span class="o">::</span><span class="n">io</span><span class="o">::</span><span class="n">Lattice</span><span class="w"> </span><span class="n">latticeDataSet</span><span class="p">;</span>
<span class="linenos"> 745</span>
<span class="linenos"> 746</span><span class="w">    </span><span class="c1">// Get the simulation time limit. </span>
<span class="linenos"> 747</span><span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">maxTime</span><span class="o">=</span><span class="n">atof</span><span class="p">((</span><span class="o">*</span><span class="n">parameters</span><span class="p">)[</span><span class="s">&quot;maxTime&quot;</span><span class="p">].</span><span class="n">c_str</span><span class="p">());</span>
<span class="linenos"> 748</span>
<span class="linenos"> 749</span><span class="w">    </span><span class="n">Print</span><span class="o">::</span><span class="n">printf</span><span class="p">(</span><span class="n">Print</span><span class="o">::</span><span class="n">INFO</span><span class="p">,</span>
<span class="linenos"> 750</span><span class="w">	              </span><span class="s">&quot;Running mpd rdme simulation with %d species, %d reactions, %d site types for %e s with tau %e. Writing species at %d and lattice at %d intervals&quot;</span><span class="p">,</span>
<span class="linenos"> 751</span><span class="w">				  </span><span class="n">numberSpecies</span><span class="p">,</span><span class="w"> </span><span class="n">numberReactions</span><span class="p">,</span><span class="w"> </span><span class="n">numberSiteTypes</span><span class="p">,</span>
<span class="linenos"> 752</span><span class="w">				  </span><span class="n">maxTime</span><span class="p">,</span><span class="w"> </span><span class="n">tau</span><span class="p">,</span>
<span class="linenos"> 753</span><span class="w">				  </span><span class="n">speciesCountsWriteInterval</span><span class="p">,</span><span class="w"> </span><span class="n">latticeWriteInterval</span><span class="p">);</span>
<span class="linenos"> 754</span><span class="w">    </span>
<span class="linenos"> 755</span><span class="w">    </span><span class="c1">// Set the initial time.</span>
<span class="linenos"> 756</span><span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>
<span class="linenos"> 757</span><span class="w">	</span><span class="n">current_timestep</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos"> 758</span>
<span class="linenos"> 759</span><span class="w">	</span><span class="kt">bool</span><span class="w"> </span><span class="n">hookEnabled</span><span class="o">=</span><span class="nb">false</span><span class="p">;</span>
<span class="linenos"> 760</span><span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">nextHookTime</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<span class="linenos"> 761</span><span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">hookInterval</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<span class="linenos"> 762</span><span class="w">	</span><span class="c1">//timer for record</span>
<span class="linenos"> 763</span><span class="w">	</span><span class="n">Timer</span><span class="w"> </span><span class="n">timer</span><span class="p">;</span>
<span class="linenos"> 764</span><span class="w">	</span><span class="n">timer</span><span class="p">.</span><span class="n">tick</span><span class="p">();</span>
<span class="linenos"> 765</span><span class="w">	</span><span class="kt">double</span><span class="w"> </span><span class="n">lastT</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<span class="linenos"> 766</span><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">lastSteps</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<span class="linenos"> 767</span><span class="w">	</span><span class="c1">// Find out at what interval to write status messages</span>
<span class="linenos"> 768</span><span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">printPerfInterval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">60</span><span class="p">;</span><span class="w">   </span><span class="c1">//in sec</span>
<span class="linenos"> 769</span><span class="w">    </span><span class="k">if</span><span class="p">((</span><span class="o">*</span><span class="n">parameters</span><span class="p">)[</span><span class="s">&quot;perfPrintInterval&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">)</span>
<span class="linenos"> 770</span><span class="w">    </span><span class="p">{</span>
<span class="linenos"> 771</span><span class="w">        </span><span class="n">printPerfInterval</span><span class="o">=</span><span class="n">atof</span><span class="p">((</span><span class="o">*</span><span class="n">parameters</span><span class="p">)[</span><span class="s">&quot;perfPrintInterval&quot;</span><span class="p">].</span><span class="n">c_str</span><span class="p">());</span>
<span class="linenos"> 772</span><span class="w">    </span><span class="p">}</span>
<span class="linenos"> 773</span><span class="w">    </span><span class="c1">// Find out at what interval to hook simulations</span>
<span class="linenos"> 774</span><span class="w">	</span><span class="k">if</span><span class="p">((</span><span class="o">*</span><span class="n">parameters</span><span class="p">)[</span><span class="s">&quot;hookInterval&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">)</span>
<span class="linenos"> 775</span><span class="w">    </span><span class="p">{</span>
<span class="linenos"> 776</span><span class="w">        </span><span class="n">hookInterval</span><span class="o">=</span><span class="n">atol</span><span class="p">((</span><span class="o">*</span><span class="n">parameters</span><span class="p">)[</span><span class="s">&quot;hookInterval&quot;</span><span class="p">].</span><span class="n">c_str</span><span class="p">());</span>
<span class="linenos"> 777</span><span class="w">        </span><span class="n">hookEnabled</span><span class="o">=</span><span class="nb">true</span><span class="p">;</span>
<span class="linenos"> 778</span><span class="w">        </span><span class="n">nextHookTime</span><span class="o">=</span><span class="n">hookInterval</span><span class="p">;</span>
<span class="linenos"> 779</span><span class="w">    </span><span class="p">}</span>
<span class="linenos"> 780</span>
<span class="linenos"> 781</span><span class="w">	</span><span class="c1">// Find out at what interval to write status messages</span>
<span class="linenos"> 782</span><span class="w">    </span><span class="n">printPerfInterval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">60</span><span class="p">;</span>
<span class="linenos"> 783</span><span class="w">    </span><span class="k">if</span><span class="p">((</span><span class="o">*</span><span class="n">parameters</span><span class="p">)[</span><span class="s">&quot;perfPrintInterval&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">)</span>
<span class="linenos"> 784</span><span class="w">    </span><span class="p">{</span>
<span class="linenos"> 785</span><span class="w">        </span><span class="n">printPerfInterval</span><span class="o">=</span><span class="n">atof</span><span class="p">((</span><span class="o">*</span><span class="n">parameters</span><span class="p">)[</span><span class="s">&quot;perfPrintInterval&quot;</span><span class="p">].</span><span class="n">c_str</span><span class="p">());</span>
<span class="linenos"> 786</span><span class="w">    </span><span class="p">}</span>
<span class="linenos"> 787</span>
<span class="linenos"> 788</span><span class="w">    </span><span class="c1">// Record the initial species counts.</span>
<span class="linenos"> 789</span><span class="w">    </span><span class="n">recordSpeciesCounts</span><span class="p">(</span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="n">lattice</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">speciesCountsDataSet</span><span class="p">);</span>
<span class="linenos"> 790</span>
<span class="linenos"> 791</span><span class="w">    </span><span class="c1">// Write the initial lattice.</span>
<span class="linenos"> 792</span><span class="w">    </span><span class="n">writeLatticeData</span><span class="p">(</span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="n">lattice</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">latticeDataSet</span><span class="p">);</span>
<span class="linenos"> 793</span>
<span class="linenos"> 794</span><span class="w">	</span><span class="c1">// Perform an initial hook check</span>
<span class="linenos"> 795</span><span class="w">    </span><span class="n">hookCheckSimulation</span><span class="p">(</span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="n">lattice</span><span class="p">);</span>
<span class="linenos"> 796</span>
<span class="linenos"> 797</span><span class="w">    </span><span class="c1">// Loop until we have finished the simulation.</span>
<span class="linenos"> 798</span><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">time</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">maxTime</span><span class="p">)</span>
<span class="linenos"> 799</span><span class="w">    </span><span class="p">{</span>
<span class="linenos"> 800</span><span class="w">		</span><span class="k">if</span><span class="p">(</span><span class="n">globalAbort</span><span class="p">)</span>
<span class="linenos"> 801</span><span class="w">		</span><span class="p">{</span>
<span class="linenos"> 802</span><span class="w">			</span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Global abort: terminating solver&quot;</span><span class="p">);</span>
<span class="linenos"> 803</span><span class="w">			</span><span class="k">break</span><span class="p">;</span>
<span class="linenos"> 804</span><span class="w">		</span><span class="p">}</span>
<span class="linenos"> 805</span><span class="w">		</span><span class="c1">// compute number of steps to batch</span>
<span class="linenos"> 806</span><span class="w">		</span><span class="n">lastT</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">timer</span><span class="p">.</span><span class="n">tock</span><span class="p">();</span>
<span class="linenos"> 807</span><span class="w">		</span><span class="kt">int</span><span class="w"> </span><span class="n">nSteps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">min</span><span class="p">(</span><span class="n">nextLatticeWriteTime</span><span class="o">-</span><span class="n">current_timestep</span><span class="p">,</span>
<span class="linenos"> 808</span><span class="w">			         </span><span class="n">min</span><span class="p">(</span><span class="n">nextSpeciesCountsWriteTime</span><span class="o">-</span><span class="n">current_timestep</span><span class="p">,</span>
<span class="linenos"> 809</span><span class="w">			         </span><span class="n">min</span><span class="p">(</span><span class="n">nextHookTime</span><span class="o">-</span><span class="n">current_timestep</span><span class="p">,</span>
<span class="linenos"> 810</span><span class="w">					 </span><span class="p">((</span><span class="kt">uint32_t</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">ceil</span><span class="p">(</span><span class="n">maxTime</span><span class="o">/</span><span class="n">tau</span><span class="p">)</span><span class="o">-</span><span class="n">current_timestep</span><span class="p">)))));</span>
<span class="linenos"> 811</span>
<span class="linenos"> 812</span><span class="w">		</span><span class="k">if</span><span class="p">(</span><span class="n">nSteps</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="n">nSteps</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
<span class="linenos"> 813</span><span class="w">		</span><span class="n">assert</span><span class="p">(</span><span class="n">nSteps</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="linenos"> 814</span><span class="w">		</span><span class="c1">//add timer here</span>
<span class="linenos"> 815</span><span class="w">		</span><span class="c1">//current_timestep += nSteps;</span>
<span class="linenos"> 816</span><span class="w">		</span><span class="n">lastSteps</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">nSteps</span><span class="p">;</span>
<span class="linenos"> 817</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">lastT</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">printPerfInterval</span><span class="p">)</span>
<span class="linenos"> 818</span><span class="w">        </span><span class="p">{</span>
<span class="linenos"> 819</span><span class="w">            </span><span class="kt">double</span><span class="w"> </span><span class="n">stepTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lastT</span><span class="o">/</span><span class="n">lastSteps</span><span class="p">;</span>
<span class="linenos"> 820</span><span class="w">            </span><span class="kt">double</span><span class="w"> </span><span class="n">completionTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stepTime</span><span class="o">*</span><span class="p">(</span><span class="n">maxTime</span><span class="o">-</span><span class="n">time</span><span class="p">)</span><span class="o">/</span><span class="n">tau</span><span class="p">;</span>
<span class="linenos"> 821</span><span class="w">            </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">units</span><span class="p">;</span>
<span class="linenos"> 822</span><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">completionTime</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">24</span><span class="o">*</span><span class="mi">365</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 823</span><span class="w">                </span><span class="n">units</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;weeks&quot;</span><span class="p">;</span>
<span class="linenos"> 824</span><span class="w">                </span><span class="n">completionTime</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">24</span><span class="o">*</span><span class="mi">365</span><span class="p">;</span>
<span class="linenos"> 825</span><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">completionTime</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">24</span><span class="o">*</span><span class="mi">30</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 826</span><span class="w">                </span><span class="n">units</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;months&quot;</span><span class="p">;</span>
<span class="linenos"> 827</span><span class="w">                </span><span class="n">completionTime</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">24</span><span class="o">*</span><span class="mi">30</span><span class="p">;</span>
<span class="linenos"> 828</span><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">completionTime</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">24</span><span class="o">*</span><span class="mi">7</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 829</span><span class="w">                </span><span class="n">units</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;weeks&quot;</span><span class="p">;</span>
<span class="linenos"> 830</span><span class="w">                </span><span class="n">completionTime</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">24</span><span class="o">*</span><span class="mi">7</span><span class="p">;</span>
<span class="linenos"> 831</span><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">completionTime</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">24</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 832</span><span class="w">                </span><span class="n">units</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;days&quot;</span><span class="p">;</span>
<span class="linenos"> 833</span><span class="w">                </span><span class="n">completionTime</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">24</span><span class="p">;</span>
<span class="linenos"> 834</span><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">completionTime</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 835</span><span class="w">                </span><span class="n">units</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;hours&quot;</span><span class="p">;</span>
<span class="linenos"> 836</span><span class="w">                </span><span class="n">completionTime</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="p">;</span>
<span class="linenos"> 837</span><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">completionTime</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">60</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 838</span><span class="w">                </span><span class="n">units</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;minutes&quot;</span><span class="p">;</span>
<span class="linenos"> 839</span><span class="w">                </span><span class="n">completionTime</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="mi">60</span><span class="p">;</span>
<span class="linenos"> 840</span><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 841</span><span class="w">                </span><span class="n">units</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;seconds&quot;</span><span class="p">;</span>
<span class="linenos"> 842</span><span class="w">            </span><span class="p">}</span>
<span class="linenos"> 843</span>
<span class="linenos"> 844</span><span class="w">            </span><span class="n">Print</span><span class="o">::</span><span class="n">printf</span><span class="p">(</span><span class="n">Print</span><span class="o">::</span><span class="n">INFO</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Average walltime per timestep: %.2f ms. Progress: %.4fs/%.4fs (% .3g%% done / %.2g %s walltime remaining)&quot;</span><span class="p">,</span>
<span class="linenos"> 845</span><span class="w">                                       </span><span class="mf">1000.0</span><span class="o">*</span><span class="n">stepTime</span><span class="p">,</span><span class="w"> </span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="n">maxTime</span><span class="p">,</span><span class="w"> </span><span class="mf">100.0</span><span class="o">*</span><span class="n">time</span><span class="o">/</span><span class="n">maxTime</span><span class="p">,</span><span class="w"> </span><span class="n">completionTime</span><span class="p">,</span><span class="w"> </span><span class="n">units</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
<span class="linenos"> 846</span>
<span class="linenos"> 847</span><span class="w">            </span><span class="n">lastT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos"> 848</span><span class="w">            </span><span class="n">lastSteps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos"> 849</span><span class="w">        </span><span class="p">}</span>
<span class="linenos"> 850</span><span class="w">		</span><span class="c1">// normal program continue</span>
<span class="linenos"> 851</span><span class="w">		</span><span class="n">timesteps_to_run</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nSteps</span><span class="p">;</span>
<span class="linenos"> 852</span><span class="w">	</span>
<span class="linenos"> 853</span><span class="w">		</span><span class="c1">// wake up threads</span>
<span class="linenos"> 854</span><span class="w">		</span><span class="n">pthread_barrier_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">start_barrier</span><span class="p">);</span>
<span class="linenos"> 855</span><span class="w">		</span>
<span class="linenos"> 856</span><span class="w">		</span><span class="c1">// ... and wait.</span>
<span class="linenos"> 857</span><span class="w">		</span><span class="n">pthread_barrier_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stop_barrier</span><span class="p">);</span>
<span class="linenos"> 858</span><span class="w">		</span>
<span class="linenos"> 859</span><span class="w">		</span><span class="k">if</span><span class="p">(</span><span class="n">globalAbort</span><span class="p">)</span>
<span class="linenos"> 860</span><span class="w">		</span><span class="p">{</span>
<span class="linenos"> 861</span><span class="w">			</span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Global abort: terminating solver&quot;</span><span class="p">);</span>
<span class="linenos"> 862</span><span class="w">			</span><span class="k">break</span><span class="p">;</span>
<span class="linenos"> 863</span><span class="w">		</span><span class="p">}</span>
<span class="linenos"> 864</span><span class="w">	</span>
<span class="linenos"> 865</span><span class="w">        </span><span class="c1">// Advance the timestep counter</span>
<span class="linenos"> 866</span><span class="w">		</span><span class="n">current_timestep</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">nSteps</span><span class="p">;</span>
<span class="linenos"> 867</span>
<span class="linenos"> 868</span><span class="w">		</span><span class="c1">// Update the time</span>
<span class="linenos"> 869</span><span class="w">        </span><span class="n">time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">current_timestep</span><span class="o">*</span><span class="n">tau</span><span class="p">;</span>
<span class="linenos"> 870</span>
<span class="linenos"> 871</span><span class="w">		</span><span class="c1">// No need to sync from gpus first; each gpu thread does a stage_out</span>
<span class="linenos"> 872</span><span class="w">		</span><span class="c1">// prior to entering the stop barrier</span>
<span class="linenos"> 873</span><span class="w">		</span><span class="c1">// clear the flag for if reaction model has changed</span>
<span class="linenos"> 874</span><span class="w">		</span><span class="n">reactionModelModified</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="linenos"> 875</span><span class="w">		</span><span class="c1">// Also no need to check the return value of the hook as a stage in is always done</span>
<span class="linenos"> 876</span><span class="w">		</span><span class="c1">// at the beginning of the timestep batch</span>
<span class="linenos"> 877</span>
<span class="linenos"> 878</span><span class="w">		</span><span class="c1">// Check if we need to execute the hook</span>
<span class="linenos"> 879</span><span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">hookEnabled</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">current_timestep</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">nextHookTime</span><span class="p">)</span>
<span class="linenos"> 880</span><span class="w">        </span><span class="p">{</span>
<span class="linenos"> 881</span><span class="w">            </span><span class="c1">// lattice-&gt;copyFromGPU();</span>
<span class="linenos"> 882</span><span class="w">            </span><span class="n">Print</span><span class="o">::</span><span class="n">printf</span><span class="p">(</span><span class="n">Print</span><span class="o">::</span><span class="n">INFO</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Hook time is %.14f, in steps is %d&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="n">nextHookTime</span><span class="p">);</span>
<span class="linenos"> 883</span><span class="w">            </span><span class="n">hookCheckSimulation</span><span class="p">(</span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="n">lattice</span><span class="p">);</span>
<span class="linenos"> 884</span><span class="w">            </span><span class="n">nextHookTime</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">hookInterval</span><span class="p">;</span>
<span class="linenos"> 885</span><span class="w">            </span><span class="n">Print</span><span class="o">::</span><span class="n">printf</span><span class="p">(</span><span class="n">Print</span><span class="o">::</span><span class="n">INFO</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Next hook time is %d&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">nextHookTime</span><span class="p">);</span>
<span class="linenos"> 886</span><span class="w">        </span><span class="p">}</span>
<span class="linenos"> 887</span><span class="w">			</span>
<span class="linenos"> 888</span><span class="w">        </span><span class="c1">// See if we need to write the lattice.</span>
<span class="linenos"> 889</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">current_timestep</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">nextLatticeWriteTime</span><span class="p">)</span>
<span class="linenos"> 890</span><span class="w">        </span><span class="p">{</span>
<span class="linenos"> 891</span><span class="w">            </span><span class="n">PROF_BEGIN</span><span class="p">(</span><span class="n">PROF_SERIALIZE_LATTICE</span><span class="p">);</span>
<span class="linenos"> 892</span><span class="w">            </span><span class="n">writeLatticeData</span><span class="p">(</span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="n">lattice</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">latticeDataSet</span><span class="p">);</span>
<span class="linenos"> 893</span><span class="w">            </span><span class="n">nextLatticeWriteTime</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">latticeWriteInterval</span><span class="p">;</span>
<span class="linenos"> 894</span><span class="w">            </span><span class="n">PROF_END</span><span class="p">(</span><span class="n">PROF_SERIALIZE_LATTICE</span><span class="p">);</span>
<span class="linenos"> 895</span><span class="w">        </span><span class="p">}</span>
<span class="linenos"> 896</span>
<span class="linenos"> 897</span><span class="w">        </span><span class="c1">// See if we need to write the species counts.</span>
<span class="linenos"> 898</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">current_timestep</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">nextSpeciesCountsWriteTime</span><span class="p">)</span>
<span class="linenos"> 899</span><span class="w">        </span><span class="p">{</span>
<span class="linenos"> 900</span><span class="w">            </span><span class="n">PROF_BEGIN</span><span class="p">(</span><span class="n">PROF_DETERMINE_COUNTS</span><span class="p">);</span>
<span class="linenos"> 901</span><span class="w">            </span><span class="n">recordSpeciesCounts</span><span class="p">(</span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="n">lattice</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">speciesCountsDataSet</span><span class="p">);</span>
<span class="linenos"> 902</span><span class="w">            </span><span class="n">nextSpeciesCountsWriteTime</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">speciesCountsWriteInterval</span><span class="p">;</span>
<span class="linenos"> 903</span><span class="w">            </span><span class="n">PROF_END</span><span class="p">(</span><span class="n">PROF_DETERMINE_COUNTS</span><span class="p">);</span>
<span class="linenos"> 904</span>
<span class="linenos"> 905</span><span class="w">            </span><span class="c1">// See if we have accumulated enough species counts to send.</span>
<span class="linenos"> 906</span><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">speciesCountsDataSet</span><span class="p">.</span><span class="n">number_entries</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">TUNE_SPECIES_COUNTS_BUFFER_SIZE</span><span class="p">)</span>
<span class="linenos"> 907</span><span class="w">            </span><span class="p">{</span>
<span class="linenos"> 908</span><span class="w">                </span><span class="n">PROF_BEGIN</span><span class="p">(</span><span class="n">PROF_SERIALIZE_COUNTS</span><span class="p">);</span>
<span class="linenos"> 909</span><span class="w">                </span><span class="n">writeSpeciesCounts</span><span class="p">(</span><span class="o">&amp;</span><span class="n">speciesCountsDataSet</span><span class="p">);</span>
<span class="linenos"> 910</span><span class="w">                </span><span class="n">PROF_END</span><span class="p">(</span><span class="n">PROF_SERIALIZE_COUNTS</span><span class="p">);</span>
<span class="linenos"> 911</span><span class="w">            </span><span class="p">}</span>
<span class="linenos"> 912</span><span class="w">        </span><span class="p">}</span>
<span class="linenos"> 913</span><span class="w">    </span><span class="p">}</span>
<span class="linenos"> 914</span>
<span class="linenos"> 915</span><span class="w">    </span><span class="c1">// Write any remaining species counts.</span>
<span class="linenos"> 916</span><span class="w">    </span><span class="n">writeSpeciesCounts</span><span class="p">(</span><span class="o">&amp;</span><span class="n">speciesCountsDataSet</span><span class="p">);</span>
<span class="linenos"> 917</span>
<span class="linenos"> 918</span><span class="w">	</span><span class="c1">// take down threads</span>
<span class="linenos"> 919</span><span class="w">	</span><span class="n">timesteps_to_run</span><span class="o">=</span><span class="mi">-1</span><span class="p">;</span>
<span class="linenos"> 920</span><span class="w">	</span><span class="n">Print</span><span class="o">::</span><span class="n">printf</span><span class="p">(</span><span class="n">Print</span><span class="o">::</span><span class="n">DEBUG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;all done, tear down&quot;</span><span class="p">);</span>
<span class="linenos"> 921</span><span class="w">	</span><span class="n">pthread_barrier_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">start_barrier</span><span class="p">);</span>
<span class="linenos"> 922</span><span class="w">	</span><span class="n">Print</span><span class="o">::</span><span class="n">printf</span><span class="p">(</span><span class="n">Print</span><span class="o">::</span><span class="n">DEBUG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;stop all threads&quot;</span><span class="p">);</span>
<span class="linenos"> 923</span>
<span class="linenos"> 924</span><span class="w">	</span><span class="n">stop_threads</span><span class="p">();</span>
<span class="linenos"> 925</span><span class="p">}</span>
<span class="linenos"> 926</span>
<span class="linenos"> 927</span><span class="kt">void</span><span class="w"> </span><span class="n">MGPUMpdRdmeSolver</span><span class="o">::</span><span class="n">writeLatticeData</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="n">ByteLattice</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">lattice</span><span class="p">,</span><span class="w"> </span><span class="n">lm</span><span class="o">::</span><span class="n">io</span><span class="o">::</span><span class="n">Lattice</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">latticeDataSet</span><span class="p">)</span>
<span class="linenos"> 928</span><span class="p">{</span>
<span class="linenos"> 929</span><span class="w">    </span><span class="n">Print</span><span class="o">::</span><span class="n">printf</span><span class="p">(</span><span class="n">Print</span><span class="o">::</span><span class="n">DEBUG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Writing lattice at %e s&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">time</span><span class="p">);</span>
<span class="linenos"> 930</span>
<span class="linenos"> 931</span><span class="w">    </span><span class="c1">// Record the lattice data.</span>
<span class="linenos"> 932</span><span class="w">    </span><span class="n">latticeDataSet</span><span class="o">-&gt;</span><span class="n">Clear</span><span class="p">();</span>
<span class="linenos"> 933</span><span class="w">    </span><span class="n">latticeDataSet</span><span class="o">-&gt;</span><span class="n">set_lattice_x_size</span><span class="p">(</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getSize</span><span class="p">().</span><span class="n">x</span><span class="p">);</span>
<span class="linenos"> 934</span><span class="w">    </span><span class="n">latticeDataSet</span><span class="o">-&gt;</span><span class="n">set_lattice_y_size</span><span class="p">(</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getSize</span><span class="p">().</span><span class="n">y</span><span class="p">);</span>
<span class="linenos"> 935</span><span class="w">    </span><span class="n">latticeDataSet</span><span class="o">-&gt;</span><span class="n">set_lattice_z_size</span><span class="p">(</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getSize</span><span class="p">().</span><span class="n">z</span><span class="p">);</span>
<span class="linenos"> 936</span><span class="w">    </span><span class="n">latticeDataSet</span><span class="o">-&gt;</span><span class="n">set_particles_per_site</span><span class="p">(</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getMaxOccupancy</span><span class="p">());</span>
<span class="linenos"> 937</span><span class="w">    </span><span class="n">latticeDataSet</span><span class="o">-&gt;</span><span class="n">set_time</span><span class="p">(</span><span class="n">time</span><span class="p">);</span>
<span class="linenos"> 938</span>
<span class="linenos"> 939</span><span class="w">    </span><span class="c1">// Push it to the output queue.</span>
<span class="linenos"> 940</span><span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">payloadSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">size_t</span><span class="p">(</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getSize</span><span class="p">().</span><span class="n">x</span><span class="p">)</span><span class="o">*</span><span class="kt">size_t</span><span class="p">(</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getSize</span><span class="p">().</span><span class="n">y</span><span class="p">)</span><span class="o">*</span><span class="kt">size_t</span><span class="p">(</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getSize</span><span class="p">().</span><span class="n">z</span><span class="p">)</span><span class="o">*</span><span class="kt">size_t</span><span class="p">(</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getMaxOccupancy</span><span class="p">())</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">uint8_t</span><span class="p">);</span>
<span class="linenos"> 941</span><span class="w">    </span><span class="n">lm</span><span class="o">::</span><span class="n">main</span><span class="o">::</span><span class="n">DataOutputQueue</span><span class="o">::</span><span class="n">getInstance</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">pushDataSet</span><span class="p">(</span><span class="n">lm</span><span class="o">::</span><span class="n">main</span><span class="o">::</span><span class="n">DataOutputQueue</span><span class="o">::</span><span class="n">BYTE_LATTICE</span><span class="p">,</span><span class="w"> </span><span class="n">replicate</span><span class="p">,</span><span class="w"> </span><span class="n">latticeDataSet</span><span class="p">,</span><span class="w"> </span><span class="n">lattice</span><span class="p">,</span><span class="w"> </span><span class="n">payloadSize</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">lm</span><span class="o">::</span><span class="n">rdme</span><span class="o">::</span><span class="n">ByteLattice</span><span class="o">::</span><span class="n">nativeSerialize</span><span class="p">);</span>
<span class="linenos"> 942</span><span class="p">}</span>
<span class="linenos"> 943</span>
<span class="linenos"> 944</span><span class="kt">void</span><span class="w"> </span><span class="n">MGPUMpdRdmeSolver</span><span class="o">::</span><span class="n">writeLatticeSites</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="n">ByteLattice</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">lattice</span><span class="p">)</span>
<span class="linenos"> 945</span><span class="p">{</span>
<span class="linenos"> 946</span><span class="w">    </span><span class="n">Print</span><span class="o">::</span><span class="n">printf</span><span class="p">(</span><span class="n">Print</span><span class="o">::</span><span class="n">DEBUG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Writing lattice sites at %e s&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">time</span><span class="p">);</span>
<span class="linenos"> 947</span>
<span class="linenos"> 948</span><span class="w">    </span><span class="n">lm</span><span class="o">::</span><span class="n">io</span><span class="o">::</span><span class="n">Lattice</span><span class="w"> </span><span class="n">latticeDataSet</span><span class="p">;</span>
<span class="linenos"> 949</span><span class="w">    </span><span class="c1">// Record the lattice data.</span>
<span class="linenos"> 950</span><span class="w">    </span><span class="n">latticeDataSet</span><span class="p">.</span><span class="n">Clear</span><span class="p">();</span>
<span class="linenos"> 951</span><span class="w">    </span><span class="n">latticeDataSet</span><span class="p">.</span><span class="n">set_lattice_x_size</span><span class="p">(</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getSize</span><span class="p">().</span><span class="n">x</span><span class="p">);</span>
<span class="linenos"> 952</span><span class="w">    </span><span class="n">latticeDataSet</span><span class="p">.</span><span class="n">set_lattice_y_size</span><span class="p">(</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getSize</span><span class="p">().</span><span class="n">y</span><span class="p">);</span>
<span class="linenos"> 953</span><span class="w">    </span><span class="n">latticeDataSet</span><span class="p">.</span><span class="n">set_lattice_z_size</span><span class="p">(</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getSize</span><span class="p">().</span><span class="n">z</span><span class="p">);</span>
<span class="linenos"> 954</span><span class="w">    </span><span class="n">latticeDataSet</span><span class="p">.</span><span class="n">set_particles_per_site</span><span class="p">(</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getMaxOccupancy</span><span class="p">());</span>
<span class="linenos"> 955</span><span class="w">    </span><span class="n">latticeDataSet</span><span class="p">.</span><span class="n">set_time</span><span class="p">(</span><span class="n">time</span><span class="p">);</span>
<span class="linenos"> 956</span>
<span class="linenos"> 957</span><span class="w">    </span><span class="c1">// Push it to the output queue.</span>
<span class="linenos"> 958</span><span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">payloadSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getSize</span><span class="p">().</span><span class="n">x</span><span class="o">*</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getSize</span><span class="p">().</span><span class="n">y</span><span class="o">*</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getSize</span><span class="p">().</span><span class="n">z</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">uint8_t</span><span class="p">);</span>
<span class="linenos"> 959</span><span class="w">    </span><span class="n">lm</span><span class="o">::</span><span class="n">main</span><span class="o">::</span><span class="n">DataOutputQueue</span><span class="o">::</span><span class="n">getInstance</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">pushDataSet</span><span class="p">(</span><span class="n">lm</span><span class="o">::</span><span class="n">main</span><span class="o">::</span><span class="n">DataOutputQueue</span><span class="o">::</span><span class="n">SITE_LATTICE</span><span class="p">,</span>
<span class="linenos"> 960</span><span class="w">	                                                      </span><span class="n">replicate</span><span class="p">,</span>
<span class="linenos"> 961</span><span class="w">														  </span><span class="o">&amp;</span><span class="n">latticeDataSet</span><span class="p">,</span>
<span class="linenos"> 962</span><span class="w">														  </span><span class="n">lattice</span><span class="p">,</span>
<span class="linenos"> 963</span><span class="w">														  </span><span class="n">payloadSize</span><span class="p">,</span>
<span class="linenos"> 964</span><span class="w">														  </span><span class="o">&amp;</span><span class="n">lm</span><span class="o">::</span><span class="n">rdme</span><span class="o">::</span><span class="n">ByteLattice</span><span class="o">::</span><span class="n">nativeSerializeSites</span><span class="p">);</span>
<span class="linenos"> 965</span><span class="p">}</span>
<span class="linenos"> 966</span>
<span class="linenos"> 967</span><span class="kt">void</span><span class="w"> </span><span class="n">MGPUMpdRdmeSolver</span><span class="o">::</span><span class="n">recordSpeciesCounts</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="n">ByteLattice</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">lattice</span><span class="p">,</span><span class="w"> </span><span class="n">lm</span><span class="o">::</span><span class="n">io</span><span class="o">::</span><span class="n">SpeciesCounts</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">speciesCountsDataSet</span><span class="p">)</span>
<span class="linenos"> 968</span><span class="p">{</span>
<span class="linenos"> 969</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">particle_t</span><span class="p">,</span><span class="n">uint</span><span class="o">&gt;</span><span class="w"> </span><span class="n">particleCounts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getParticleCounts</span><span class="p">();</span>
<span class="linenos"> 970</span>
<span class="linenos"> 971</span><span class="w">    </span><span class="n">speciesCountsDataSet</span><span class="o">-&gt;</span><span class="n">set_number_entries</span><span class="p">(</span><span class="n">speciesCountsDataSet</span><span class="o">-&gt;</span><span class="n">number_entries</span><span class="p">()</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
<span class="linenos"> 972</span><span class="w">    </span><span class="n">speciesCountsDataSet</span><span class="o">-&gt;</span><span class="n">add_time</span><span class="p">(</span><span class="n">time</span><span class="p">);</span>
<span class="linenos"> 973</span>
<span class="linenos"> 974</span><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">particle_t</span><span class="w"> </span><span class="n">p</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">p</span><span class="o">&lt;</span><span class="n">numberSpeciesToTrack</span><span class="p">;</span><span class="w"> </span><span class="n">p</span><span class="o">++</span><span class="p">)</span>
<span class="linenos"> 975</span><span class="w">    </span><span class="p">{</span>
<span class="linenos"> 976</span><span class="w">        </span><span class="n">speciesCountsDataSet</span><span class="o">-&gt;</span><span class="n">add_species_count</span><span class="p">((</span><span class="n">particleCounts</span><span class="p">.</span><span class="n">count</span><span class="p">(</span><span class="n">p</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span><span class="o">?</span><span class="n">particleCounts</span><span class="p">[</span><span class="n">p</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">:</span><span class="mi">0</span><span class="p">);</span>
<span class="linenos"> 977</span><span class="w">    </span><span class="p">}</span>
<span class="linenos"> 978</span><span class="p">}</span>
<span class="linenos"> 979</span>
<span class="linenos"> 980</span><span class="kt">void</span><span class="w"> </span><span class="n">MGPUMpdRdmeSolver</span><span class="o">::</span><span class="n">writeSpeciesCounts</span><span class="p">(</span><span class="n">lm</span><span class="o">::</span><span class="n">io</span><span class="o">::</span><span class="n">SpeciesCounts</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">speciesCountsDataSet</span><span class="p">)</span>
<span class="linenos"> 981</span><span class="p">{</span>
<span class="linenos"> 982</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">speciesCountsDataSet</span><span class="o">-&gt;</span><span class="n">number_entries</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="linenos"> 983</span><span class="w">    </span><span class="p">{</span>
<span class="linenos"> 984</span><span class="w">        </span><span class="c1">// Push it to the output queue.</span>
<span class="linenos"> 985</span><span class="w">        </span><span class="n">lm</span><span class="o">::</span><span class="n">main</span><span class="o">::</span><span class="n">DataOutputQueue</span><span class="o">::</span><span class="n">getInstance</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">pushDataSet</span><span class="p">(</span><span class="n">lm</span><span class="o">::</span><span class="n">main</span><span class="o">::</span><span class="n">DataOutputQueue</span><span class="o">::</span><span class="n">SPECIES_COUNTS</span><span class="p">,</span><span class="w"> </span><span class="n">replicate</span><span class="p">,</span><span class="w"> </span><span class="n">speciesCountsDataSet</span><span class="p">);</span>
<span class="linenos"> 986</span>
<span class="linenos"> 987</span><span class="w">        </span><span class="c1">// Reset the data set.</span>
<span class="linenos"> 988</span><span class="w">        </span><span class="n">speciesCountsDataSet</span><span class="o">-&gt;</span><span class="n">Clear</span><span class="p">();</span>
<span class="linenos"> 989</span><span class="w">        </span><span class="n">speciesCountsDataSet</span><span class="o">-&gt;</span><span class="n">set_number_species</span><span class="p">(</span><span class="n">numberSpeciesToTrack</span><span class="p">);</span>
<span class="linenos"> 990</span><span class="w">        </span><span class="n">speciesCountsDataSet</span><span class="o">-&gt;</span><span class="n">set_number_entries</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="linenos"> 991</span><span class="w">    </span><span class="p">}</span>
<span class="linenos"> 992</span><span class="p">}</span>
<span class="linenos"> 993</span>
<span class="linenos"> 994</span><span class="kt">void</span><span class="w"> </span><span class="n">MGPUMpdRdmeSolver</span><span class="o">::</span><span class="n">hookCheckSimulation</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="n">ByteLattice</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">lattice</span><span class="p">)</span>
<span class="linenos"> 995</span><span class="p">{</span>
<span class="linenos"> 996</span><span class="w">	</span><span class="k">switch</span><span class="p">(</span><span class="n">hookSimulation</span><span class="p">(</span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="n">lattice</span><span class="p">))</span>
<span class="linenos"> 997</span><span class="w">    </span><span class="p">{</span>
<span class="linenos"> 998</span><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="mi">0</span><span class="p">:</span>
<span class="linenos"> 999</span><span class="w">            </span><span class="k">break</span><span class="p">;</span>
<span class="linenos">1000</span>
<span class="linenos">1001</span><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span>
<span class="linenos">1002</span><span class="w">            </span><span class="c1">// lattice-&gt;copyToGPU();</span>
<span class="linenos">1003</span><span class="w">            </span><span class="k">break</span><span class="p">;</span>
<span class="linenos">1004</span>
<span class="linenos">1005</span><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="mi">2</span><span class="p">:</span>
<span class="linenos">1006</span><span class="w">            </span><span class="c1">// lattice-&gt;copyToGPU();</span>
<span class="linenos">1007</span><span class="w">            </span><span class="n">writeLatticeSites</span><span class="p">(</span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="n">lattice</span><span class="p">);</span>
<span class="linenos">1008</span><span class="w">            </span><span class="k">break</span><span class="p">;</span>
<span class="linenos">1009</span>
<span class="linenos">1010</span><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="mi">3</span><span class="p">:</span>
<span class="linenos">1011</span><span class="w">            </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;hook return value is 3, force to stop.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="linenos">1012</span><span class="w">			</span><span class="n">writeLatticeSites</span><span class="p">(</span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="n">lattice</span><span class="p">);</span>
<span class="linenos">1013</span><span class="w">            </span><span class="k">return</span><span class="p">;</span>
<span class="linenos">1014</span>
<span class="linenos">1015</span><span class="w">        </span><span class="k">default</span><span class="o">:</span>
<span class="linenos">1016</span><span class="w">            </span><span class="n">throw</span><span class="p">(</span><span class="s">&quot;Unknown hook return value&quot;</span><span class="p">);</span>
<span class="linenos">1017</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">1018</span>
<span class="linenos">1019</span><span class="w">	</span><span class="k">if</span><span class="p">(</span><span class="n">reactionModelModified</span><span class="p">)</span>
<span class="linenos">1020</span><span class="w">		</span><span class="n">computePropensities</span><span class="p">();</span>
<span class="linenos">1021</span><span class="p">}</span>
<span class="linenos">1022</span>
<span class="linenos">1023</span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">MGPUMpdRdmeSolver</span><span class="o">::</span><span class="n">getTimestepSeed</span><span class="p">(</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">timestep</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">substep</span><span class="p">)</span>
<span class="linenos">1024</span><span class="p">{</span>
<span class="linenos">1025</span><span class="w">    </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">timestepHash</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(((((</span><span class="kt">uint64_t</span><span class="p">)</span><span class="n">seed</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="mi">30</span><span class="p">)</span><span class="o">+</span><span class="n">timestep</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="n">substep</span><span class="p">;</span>
<span class="linenos">1026</span><span class="w">    </span><span class="n">timestepHash</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">timestepHash</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">3202034522624059733ULL</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">4354685564936845319ULL</span><span class="p">;</span>
<span class="linenos">1027</span><span class="w">    </span><span class="n">timestepHash</span><span class="w"> </span><span class="o">^=</span><span class="w"> </span><span class="n">timestepHash</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">20</span><span class="p">;</span><span class="w"> </span><span class="n">timestepHash</span><span class="w"> </span><span class="o">^=</span><span class="w"> </span><span class="n">timestepHash</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">41</span><span class="p">;</span><span class="w"> </span><span class="n">timestepHash</span><span class="w"> </span><span class="o">^=</span><span class="w"> </span><span class="n">timestepHash</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span>
<span class="linenos">1028</span><span class="w">    </span><span class="n">timestepHash</span><span class="w"> </span><span class="o">*=</span><span class="w"> </span><span class="mi">7664345821815920749ULL</span><span class="p">;</span>
<span class="linenos">1029</span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">;</span>
<span class="linenos">1030</span><span class="p">}</span>
<span class="linenos">1031</span>
<span class="linenos">1032</span><span class="kt">int</span><span class="w"> </span><span class="n">MGPUMpdRdmeSolver</span><span class="o">::</span><span class="n">run_next_timestep</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">gpu</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">timestep</span><span class="p">)</span>
<span class="linenos">1033</span><span class="p">{</span>
<span class="linenos">1034</span><span class="w">    </span><span class="n">PROF_BEGIN</span><span class="p">(</span><span class="n">PROF_MPD_TIMESTEP</span><span class="p">);</span>
<span class="linenos">1035</span>
<span class="linenos">1036</span><span class="w">	</span><span class="kt">int</span><span class="w"> </span><span class="n">z_start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">1037</span><span class="w">	</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">dlat</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">dLattice</span><span class="p">;</span>
<span class="linenos">1038</span><span class="w">	</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">dtmp</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">dLatticeTmp</span><span class="p">;</span>
<span class="linenos">1039</span><span class="w">	</span><span class="kt">uint8_t</span><span class="w">      </span><span class="o">*</span><span class="n">sites</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">dSites</span><span class="p">;</span>
<span class="linenos">1040</span><span class="w">	</span><span class="n">cudaStream_t</span><span class="w"> </span><span class="n">cudaStream</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">stream1</span><span class="p">;</span>
<span class="linenos">1041</span><span class="w">	</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">d_overflows</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">d_overflows</span><span class="p">;</span>
<span class="linenos">1042</span><span class="w">	</span>
<span class="linenos">1043</span><span class="w">    </span><span class="kt">dim3</span><span class="w"> </span><span class="n">gridSize</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">grid_x</span><span class="p">;</span>
<span class="linenos">1044</span><span class="w">	</span><span class="kt">dim3</span><span class="w"> </span><span class="n">threadBlockSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">threads_x</span><span class="p">;</span>
<span class="linenos">1045</span>
<span class="linenos">1046</span><span class="w">	</span><span class="n">ZDivMultiGPUMapper</span><span class="o">*</span><span class="w"> </span><span class="n">zmap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">ZDivMultiGPUMapper</span><span class="o">*</span><span class="p">)</span><span class="n">mapper</span><span class="p">;</span>
<span class="linenos">1047</span>
<span class="linenos">1048</span><span class="w">    </span><span class="c1">// Execute the kernel for the x direction.</span>
<span class="linenos">1049</span><span class="w">    </span><span class="n">PROF_CUDA_START</span><span class="p">(</span><span class="n">cudaStream</span><span class="p">);</span>
<span class="linenos">1050</span>
<span class="linenos">1051</span><span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">aggcopy_x_unpack</span><span class="p">)</span>
<span class="linenos">1052</span><span class="w">	</span><span class="p">{</span>
<span class="linenos">1053</span><span class="w">		</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">rbuf_top</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zmap</span><span class="o">-&gt;</span><span class="n">getrbuf</span><span class="p">(</span><span class="n">gpu</span><span class="p">,</span><span class="w"> </span><span class="n">timestep</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="linenos">1054</span><span class="w">		</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">rbuf_bot</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zmap</span><span class="o">-&gt;</span><span class="n">getrbuf</span><span class="p">(</span><span class="n">gpu</span><span class="p">,</span><span class="w"> </span><span class="n">timestep</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="linenos">1055</span>
<span class="linenos">1056</span><span class="w">		</span><span class="n">PROF_CUDA_BEGIN</span><span class="p">(</span><span class="n">PROF_MPD_X_DIFFUSION</span><span class="p">,</span><span class="w"> </span><span class="n">cudaStream</span><span class="p">);</span>
<span class="linenos">1057</span><span class="w">		</span><span class="n">CUDA_EXCEPTION_EXECUTE</span><span class="p">((</span>
<span class="linenos">1058</span><span class="w">			</span><span class="n">mgpumpdrdme_dev</span><span class="o">::</span><span class="n">MGPU_x_kernel_unpack</span><span class="o">&lt;&lt;&lt;</span><span class="n">gridSize</span><span class="p">,</span><span class="w"> </span><span class="n">threadBlockSize</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">cudaStream</span><span class="o">&gt;&gt;&gt;</span>
<span class="linenos">1059</span><span class="w">			</span><span class="p">(</span><span class="n">dlat</span><span class="p">,</span><span class="w"> </span><span class="n">sites</span><span class="p">,</span><span class="w"> </span><span class="n">dtmp</span><span class="p">,</span><span class="w"> </span><span class="n">z_start</span><span class="p">,</span>
<span class="linenos">1060</span><span class="w">			 </span><span class="n">getTimestepSeed</span><span class="p">(</span><span class="n">timestep</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">),</span>
<span class="linenos">1061</span><span class="w">			 </span><span class="n">d_overflows</span><span class="p">,</span>
<span class="linenos">1062</span><span class="w">			 </span><span class="n">rbuf_top</span><span class="p">,</span><span class="w"> </span><span class="n">rbuf_bot</span><span class="p">)</span>
<span class="linenos">1063</span><span class="w">		</span><span class="p">));</span>
<span class="linenos">1064</span><span class="w">		</span><span class="n">PROF_CUDA_END</span><span class="p">(</span><span class="n">PROF_MPD_X_DIFFUSION</span><span class="p">,</span><span class="w"> </span><span class="n">cudaStream</span><span class="p">);</span>
<span class="linenos">1065</span><span class="w">	</span><span class="p">}</span>
<span class="linenos">1066</span><span class="w">	</span><span class="k">else</span>
<span class="linenos">1067</span><span class="w">	</span><span class="p">{</span>
<span class="linenos">1068</span><span class="w">		</span><span class="n">mapper</span><span class="o">-&gt;</span><span class="n">schedule_recv</span><span class="p">(</span><span class="n">gpu</span><span class="p">,</span><span class="w"> </span><span class="n">dlat</span><span class="p">,</span><span class="w"> </span><span class="n">timestep</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">cudaStream</span><span class="p">);</span>
<span class="linenos">1069</span><span class="w">		</span><span class="n">mapper</span><span class="o">-&gt;</span><span class="n">schedule_recv</span><span class="p">(</span><span class="n">gpu</span><span class="p">,</span><span class="w"> </span><span class="n">dlat</span><span class="p">,</span><span class="w"> </span><span class="n">timestep</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">cudaStream</span><span class="p">);</span>
<span class="linenos">1070</span>
<span class="linenos">1071</span><span class="w">		</span><span class="n">PROF_CUDA_BEGIN</span><span class="p">(</span><span class="n">PROF_MPD_X_DIFFUSION</span><span class="p">,</span><span class="w"> </span><span class="n">cudaStream</span><span class="p">);</span>
<span class="linenos">1072</span><span class="w">		</span><span class="n">CUDA_EXCEPTION_EXECUTE</span><span class="p">((</span>
<span class="linenos">1073</span><span class="w">			</span><span class="n">mgpumpdrdme_dev</span><span class="o">::</span><span class="n">MGPU_x_kernel</span><span class="o">&lt;&lt;&lt;</span><span class="n">gridSize</span><span class="p">,</span><span class="w"> </span><span class="n">threadBlockSize</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">cudaStream</span><span class="o">&gt;&gt;&gt;</span>
<span class="linenos">1074</span><span class="w">			</span><span class="p">(</span><span class="n">dlat</span><span class="p">,</span><span class="w"> </span><span class="n">sites</span><span class="p">,</span><span class="w"> </span><span class="n">dtmp</span><span class="p">,</span><span class="w"> </span><span class="n">z_start</span><span class="p">,</span>
<span class="linenos">1075</span><span class="w">			 </span><span class="n">getTimestepSeed</span><span class="p">(</span><span class="n">timestep</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">),</span>
<span class="linenos">1076</span><span class="w">			 </span><span class="n">d_overflows</span><span class="p">)</span>
<span class="linenos">1077</span><span class="w">		</span><span class="p">));</span>
<span class="linenos">1078</span><span class="w">		</span><span class="n">PROF_CUDA_END</span><span class="p">(</span><span class="n">PROF_MPD_X_DIFFUSION</span><span class="p">,</span><span class="w"> </span><span class="n">cudaStream</span><span class="p">);</span>
<span class="linenos">1079</span><span class="w">	</span><span class="p">}</span>
<span class="linenos">1080</span>
<span class="linenos">1081</span><span class="w">    </span><span class="n">gridSize</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">grid_y</span><span class="p">;</span>
<span class="linenos">1082</span><span class="w">	</span><span class="n">threadBlockSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">threads_y</span><span class="p">;</span>
<span class="linenos">1083</span>
<span class="linenos">1084</span><span class="w">    </span><span class="c1">// Execute the kernel for the y direction.</span>
<span class="linenos">1085</span><span class="w">    </span><span class="n">PROF_CUDA_BEGIN</span><span class="p">(</span><span class="n">PROF_MPD_Y_DIFFUSION</span><span class="p">,</span><span class="w"> </span><span class="n">cudaStream</span><span class="p">);</span>
<span class="linenos">1086</span><span class="w">    </span><span class="n">CUDA_EXCEPTION_EXECUTE</span><span class="p">((</span>
<span class="linenos">1087</span><span class="w">		</span><span class="n">mgpumpdrdme_dev</span><span class="o">::</span><span class="n">MGPU_y_kernel</span><span class="o">&lt;&lt;&lt;</span><span class="n">gridSize</span><span class="p">,</span><span class="w"> </span><span class="n">threadBlockSize</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">cudaStream</span><span class="o">&gt;&gt;&gt;</span>
<span class="linenos">1088</span><span class="w">		</span><span class="p">(</span><span class="n">dtmp</span><span class="p">,</span><span class="w"> </span><span class="n">sites</span><span class="p">,</span><span class="w"> </span><span class="n">dlat</span><span class="p">,</span>
<span class="linenos">1089</span><span class="w">	     </span><span class="n">getTimestepSeed</span><span class="p">(</span><span class="n">timestep</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">),</span>
<span class="linenos">1090</span><span class="w">		 </span><span class="n">d_overflows</span><span class="p">)</span>
<span class="linenos">1091</span><span class="w">	</span><span class="p">));</span>
<span class="linenos">1092</span><span class="w">    </span><span class="n">PROF_CUDA_END</span><span class="p">(</span><span class="n">PROF_MPD_Y_DIFFUSION</span><span class="p">,</span><span class="w"> </span><span class="n">cudaStream</span><span class="p">);</span>
<span class="linenos">1093</span>
<span class="linenos">1094</span><span class="w">    </span><span class="n">gridSize</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">grid_z</span><span class="p">;</span>
<span class="linenos">1095</span><span class="w">	</span><span class="n">threadBlockSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">threads_z</span><span class="p">;</span>
<span class="linenos">1096</span>
<span class="linenos">1097</span><span class="w">    </span><span class="c1">// Execute the kernel for the z direction.</span>
<span class="linenos">1098</span><span class="w">    </span><span class="n">PROF_CUDA_BEGIN</span><span class="p">(</span><span class="n">PROF_MPD_Z_DIFFUSION</span><span class="p">,</span><span class="w"> </span><span class="n">cudaStream</span><span class="p">);</span>
<span class="linenos">1099</span><span class="w">    </span><span class="n">CUDA_EXCEPTION_EXECUTE</span><span class="p">((</span>
<span class="linenos">1100</span><span class="w">		</span><span class="n">mgpumpdrdme_dev</span><span class="o">::</span><span class="n">MGPU_z_kernel</span><span class="o">&lt;&lt;&lt;</span><span class="n">gridSize</span><span class="p">,</span><span class="w"> </span><span class="n">threadBlockSize</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">cudaStream</span><span class="o">&gt;&gt;&gt;</span>
<span class="linenos">1101</span><span class="w">		</span><span class="p">(</span><span class="n">dlat</span><span class="p">,</span><span class="w"> </span><span class="n">sites</span><span class="p">,</span><span class="w"> </span><span class="n">dtmp</span><span class="p">,</span>
<span class="linenos">1102</span><span class="w">		 </span><span class="n">getTimestepSeed</span><span class="p">(</span><span class="n">timestep</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">),</span>
<span class="linenos">1103</span><span class="w">		 </span><span class="n">d_overflows</span><span class="p">,</span>
<span class="linenos">1104</span><span class="w">		 </span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">segment</span><span class="o">-&gt;</span><span class="n">active_offset</span><span class="p">.</span><span class="n">z</span><span class="p">)</span>
<span class="linenos">1105</span><span class="w">	</span><span class="p">));</span>
<span class="linenos">1106</span><span class="w">    </span><span class="n">PROF_CUDA_END</span><span class="p">(</span><span class="n">PROF_MPD_Z_DIFFUSION</span><span class="p">,</span><span class="w"> </span><span class="n">cudaStream</span><span class="p">);</span>
<span class="linenos">1107</span>
<span class="linenos">1108</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">numberReactions</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">1109</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">1110</span><span class="w">		</span><span class="n">gridSize</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">grid_r</span><span class="p">;</span>
<span class="linenos">1111</span><span class="w">		</span><span class="n">threadBlockSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">threads_r</span><span class="p">;</span>
<span class="linenos">1112</span>
<span class="linenos">1113</span><span class="w">        </span><span class="c1">// Execute the kernel for the reaction.</span>
<span class="linenos">1114</span><span class="w">		</span><span class="c1">// This kernel updates the lattice in-place, so only the src pointer is passed.</span>
<span class="linenos">1115</span><span class="w">        </span><span class="n">PROF_CUDA_BEGIN</span><span class="p">(</span><span class="n">PROF_MPD_REACTION</span><span class="p">,</span><span class="w"> </span><span class="n">cudaStream</span><span class="p">);</span>
<span class="linenos">1116</span>
<span class="linenos">1117</span><span class="w">		</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">buf_top</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zmap</span><span class="o">-&gt;</span><span class="n">gettbuf</span><span class="p">(</span><span class="n">gpu</span><span class="p">,</span><span class="w"> </span><span class="n">timestep</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="linenos">1118</span><span class="w">		</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">buf_bot</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zmap</span><span class="o">-&gt;</span><span class="n">gettbuf</span><span class="p">(</span><span class="n">gpu</span><span class="p">,</span><span class="w"> </span><span class="n">timestep</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="linenos">1119</span>
<span class="linenos">1120</span><span class="w">	</span><span class="cp">#ifdef MPD_FREAKYFAST</span>
<span class="linenos">1121</span><span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">aggcopy_r_pack</span><span class="p">)</span>
<span class="linenos">1122</span><span class="w">		</span><span class="p">{</span>
<span class="linenos">1123</span><span class="w">			</span><span class="n">CUDA_EXCEPTION_EXECUTE</span><span class="p">((</span>
<span class="linenos">1124</span><span class="w">				</span><span class="n">mgpumpdrdme_dev</span><span class="o">::</span><span class="n">MGPU_precomp_reaction_kernel_packing</span><span class="o">&lt;&lt;&lt;</span><span class="n">gridSize</span><span class="p">,</span><span class="w"> </span><span class="n">threadBlockSize</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">cudaStream</span><span class="o">&gt;&gt;&gt;</span>
<span class="linenos">1125</span><span class="w">				</span><span class="p">(</span><span class="n">dtmp</span><span class="p">,</span><span class="w"> </span><span class="n">sites</span><span class="p">,</span><span class="w"> </span><span class="n">dtmp</span><span class="p">,</span>
<span class="linenos">1126</span><span class="w">				 </span><span class="n">getTimestepSeed</span><span class="p">(</span><span class="n">timestep</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">),</span>
<span class="linenos">1127</span><span class="w">				 </span><span class="n">d_overflows</span><span class="p">,</span>
<span class="linenos">1128</span><span class="w">				 </span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">segment</span><span class="o">-&gt;</span><span class="n">active_offset</span><span class="p">.</span><span class="n">z</span><span class="p">,</span>
<span class="linenos">1129</span><span class="w">	            </span><span class="cp">#ifdef MPD_GLOBAL_S_MATRIX</span>
<span class="linenos">1130</span><span class="w">				 </span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">SG</span><span class="p">,</span>
<span class="linenos">1131</span><span class="w">				 </span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">RLG</span><span class="p">,</span>
<span class="linenos">1132</span><span class="w">				</span><span class="cp">#endif</span>
<span class="linenos">1133</span><span class="w">				</span><span class="cp">#ifdef MPD_GLOBAL_R_MATRIX</span>
<span class="linenos">1134</span><span class="w">				 </span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">reactionOrdersG</span><span class="p">,</span>
<span class="linenos">1135</span><span class="w">				 </span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">reactionSitesG</span><span class="p">,</span>
<span class="linenos">1136</span><span class="w">				 </span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">D1G</span><span class="p">,</span>
<span class="linenos">1137</span><span class="w">				 </span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">D2G</span><span class="p">,</span>
<span class="linenos">1138</span><span class="w">				 </span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">reactionRatesG</span><span class="p">,</span>
<span class="linenos">1139</span><span class="w">				</span><span class="cp">#endif</span>
<span class="linenos">1140</span><span class="w">				 </span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">propZeroOrder</span><span class="p">,</span>
<span class="linenos">1141</span><span class="w">				 </span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">propFirstOrder</span><span class="p">,</span>
<span class="linenos">1142</span><span class="w">				 </span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">propSecondOrder</span><span class="p">,</span>
<span class="linenos">1143</span><span class="w">				 </span><span class="n">buf_top</span><span class="p">,</span><span class="w"> </span><span class="n">buf_bot</span><span class="p">)</span>
<span class="linenos">1144</span><span class="w">			</span><span class="p">));</span>
<span class="linenos">1145</span><span class="w">		</span><span class="p">}</span>
<span class="linenos">1146</span><span class="w">		</span><span class="k">else</span>
<span class="linenos">1147</span><span class="w">		</span><span class="p">{</span>
<span class="linenos">1148</span><span class="w">			</span><span class="n">CUDA_EXCEPTION_EXECUTE</span><span class="p">((</span>
<span class="linenos">1149</span><span class="w">				</span><span class="n">mgpumpdrdme_dev</span><span class="o">::</span><span class="n">MGPU_precomp_reaction_kernel</span><span class="o">&lt;&lt;&lt;</span><span class="n">gridSize</span><span class="p">,</span><span class="w"> </span><span class="n">threadBlockSize</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">cudaStream</span><span class="o">&gt;&gt;&gt;</span>
<span class="linenos">1150</span><span class="w">				</span><span class="p">(</span><span class="n">dtmp</span><span class="p">,</span><span class="w"> </span><span class="n">sites</span><span class="p">,</span><span class="w"> </span><span class="n">dtmp</span><span class="p">,</span>
<span class="linenos">1151</span><span class="w">				 </span><span class="n">getTimestepSeed</span><span class="p">(</span><span class="n">timestep</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">),</span>
<span class="linenos">1152</span><span class="w">				 </span><span class="n">d_overflows</span><span class="p">,</span>
<span class="linenos">1153</span><span class="w">				 </span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">segment</span><span class="o">-&gt;</span><span class="n">active_offset</span><span class="p">.</span><span class="n">z</span><span class="p">,</span>
<span class="linenos">1154</span><span class="w">				</span><span class="cp">#ifdef MPD_GLOBAL_S_MATRIX</span>
<span class="linenos">1155</span><span class="w">				 </span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">SG</span><span class="p">,</span>
<span class="linenos">1156</span><span class="w">				 </span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">RLG</span><span class="p">,</span>
<span class="linenos">1157</span><span class="w">				</span><span class="cp">#endif</span>
<span class="linenos">1158</span><span class="w">				</span><span class="cp">#ifdef MPD_GLOBAL_R_MATRIX</span>
<span class="linenos">1159</span><span class="w">				 </span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">reactionOrdersG</span><span class="p">,</span>
<span class="linenos">1160</span><span class="w">				 </span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">reactionSitesG</span><span class="p">,</span>
<span class="linenos">1161</span><span class="w">				 </span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">D1G</span><span class="p">,</span>
<span class="linenos">1162</span><span class="w">				 </span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">D2G</span><span class="p">,</span>
<span class="linenos">1163</span><span class="w">				 </span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">reactionRatesG</span><span class="p">,</span>
<span class="linenos">1164</span><span class="w">				</span><span class="cp">#endif</span>
<span class="linenos">1165</span><span class="w">				 </span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">propZeroOrder</span><span class="p">,</span>
<span class="linenos">1166</span><span class="w">				 </span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">propFirstOrder</span><span class="p">,</span>
<span class="linenos">1167</span><span class="w">				 </span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">propSecondOrder</span><span class="p">)</span>
<span class="linenos">1168</span><span class="w">			</span><span class="p">));</span>
<span class="linenos">1169</span><span class="w">		</span><span class="p">}</span>
<span class="linenos">1170</span><span class="w">	</span><span class="cp">#else</span>
<span class="linenos">1171</span><span class="w">    	</span><span class="n">CUDA_EXCEPTION_EXECUTE</span><span class="p">((</span>
<span class="linenos">1172</span><span class="w">			</span><span class="n">mgpumpdrdme_dev</span><span class="o">::</span><span class="n">MGPU_reaction_kernel</span><span class="o">&lt;&lt;&lt;</span><span class="n">gridSize</span><span class="p">,</span><span class="w"> </span><span class="n">threadBlockSize</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">cudaStream</span><span class="o">&gt;&gt;&gt;</span>
<span class="linenos">1173</span><span class="w">			</span><span class="p">(</span><span class="n">dtmp</span><span class="p">,</span><span class="w"> </span><span class="n">sites</span><span class="p">,</span><span class="w"> </span><span class="n">dtmp</span><span class="p">,</span>
<span class="linenos">1174</span><span class="w">			 </span><span class="n">getTimestepSeed</span><span class="p">(</span><span class="n">timestep</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">),</span>
<span class="linenos">1175</span><span class="w">			 </span><span class="n">d_overflows</span><span class="p">,</span>
<span class="linenos">1176</span><span class="w">			 </span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">segment</span><span class="o">-&gt;</span><span class="n">active_offset</span><span class="p">.</span><span class="n">z</span><span class="p">,</span>
<span class="linenos">1177</span><span class="w">			</span><span class="cp">#ifdef MPD_GLOBAL_S_MATRIX</span>
<span class="linenos">1178</span><span class="w">			 </span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">SG</span><span class="p">,</span>
<span class="linenos">1179</span><span class="w">			 </span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">RLG</span><span class="p">,</span>
<span class="linenos">1180</span><span class="w">			</span><span class="cp">#endif</span>
<span class="linenos">1181</span><span class="w">			</span><span class="cp">#ifdef MPD_GLOBAL_R_MATRIX</span>
<span class="linenos">1182</span><span class="w">             </span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">reactionOrdersG</span><span class="p">,</span>
<span class="linenos">1183</span><span class="w">			 </span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">reactionSitesG</span><span class="p">,</span>
<span class="linenos">1184</span><span class="w">			 </span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">D1G</span><span class="p">,</span>
<span class="linenos">1185</span><span class="w">			 </span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">D2G</span><span class="p">,</span>
<span class="linenos">1186</span><span class="w">			 </span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">reactionRatesG</span>
<span class="linenos">1187</span><span class="w">        	</span><span class="cp">#endif</span>
<span class="linenos">1188</span><span class="w">		</span><span class="p">)));</span>
<span class="linenos">1189</span><span class="w">	</span><span class="cp">#endif</span>
<span class="linenos">1190</span>
<span class="linenos">1191</span><span class="w">        </span><span class="n">PROF_CUDA_END</span><span class="p">(</span><span class="n">PROF_MPD_REACTION</span><span class="p">,</span><span class="w"> </span><span class="n">cudaStream</span><span class="p">);</span>
<span class="linenos">1192</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">1193</span>
<span class="linenos">1194</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">overflow_handling</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">OVERFLOW_MODE_RELAXED</span><span class="p">)</span>
<span class="linenos">1195</span><span class="w">		</span><span class="n">mgpumpdrdme_dev</span><span class="o">::</span><span class="n">correct_overflows_mgpu</span><span class="o">&lt;&lt;&lt;</span><span class="kt">dim3</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span>
<span class="linenos">1196</span><span class="w">	                                              </span><span class="kt">dim3</span><span class="p">(</span><span class="n">TUNE_MPD_MAX_PARTICLE_OVERFLOWS</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span>
<span class="linenos">1197</span><span class="w">												  </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">cudaStream</span><span class="o">&gt;&gt;&gt;</span><span class="p">(</span><span class="n">dtmp</span><span class="p">,</span><span class="w"> </span><span class="n">d_overflows</span><span class="p">);</span>
<span class="linenos">1198</span>
<span class="linenos">1199</span><span class="w">	</span><span class="c1">// send data</span>
<span class="linenos">1200</span><span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">aggcopy_r_pack</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">numberReactions</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">1201</span><span class="w">	</span><span class="p">{</span>
<span class="linenos">1202</span><span class="w">		</span><span class="n">zmap</span><span class="o">-&gt;</span><span class="n">send_tbuf</span><span class="p">(</span><span class="n">gpu</span><span class="p">,</span><span class="w"> </span><span class="n">timestep</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">cudaStream</span><span class="p">);</span>
<span class="linenos">1203</span><span class="w">		</span><span class="n">zmap</span><span class="o">-&gt;</span><span class="n">send_tbuf</span><span class="p">(</span><span class="n">gpu</span><span class="p">,</span><span class="w"> </span><span class="n">timestep</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">cudaStream</span><span class="p">);</span>
<span class="linenos">1204</span><span class="w">	</span><span class="p">}</span>
<span class="linenos">1205</span><span class="w">	</span><span class="k">else</span>
<span class="linenos">1206</span><span class="w">	</span><span class="p">{</span>
<span class="linenos">1207</span><span class="w">		</span><span class="n">mapper</span><span class="o">-&gt;</span><span class="n">schedule_send</span><span class="p">(</span><span class="n">gpu</span><span class="p">,</span><span class="w"> </span><span class="n">dtmp</span><span class="p">,</span><span class="w"> </span><span class="n">timestep</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">cudaStream</span><span class="p">);</span>
<span class="linenos">1208</span><span class="w">		</span><span class="n">mapper</span><span class="o">-&gt;</span><span class="n">schedule_send</span><span class="p">(</span><span class="n">gpu</span><span class="p">,</span><span class="w"> </span><span class="n">dtmp</span><span class="p">,</span><span class="w"> </span><span class="n">timestep</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">cudaStream</span><span class="p">);</span>
<span class="linenos">1209</span><span class="w">	</span><span class="p">}</span>
<span class="linenos">1210</span><span class="w">	</span>
<span class="linenos">1211</span><span class="w">    </span><span class="c1">// Wait for the kernels to complete.</span>
<span class="linenos">1212</span><span class="w">    </span><span class="n">PROF_BEGIN</span><span class="p">(</span><span class="n">PROF_MPD_SYNCHRONIZE</span><span class="p">);</span>
<span class="linenos">1213</span><span class="w">    </span><span class="n">CUDA_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">cudaStreamSynchronize</span><span class="p">(</span><span class="n">cudaStream</span><span class="p">));</span>
<span class="linenos">1214</span><span class="w">    </span><span class="n">PROF_END</span><span class="p">(</span><span class="n">PROF_MPD_SYNCHRONIZE</span><span class="p">);</span>
<span class="linenos">1215</span>
<span class="linenos">1216</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">overflow_handling</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">OVERFLOW_MODE_RELAXED</span><span class="p">)</span>
<span class="linenos">1217</span><span class="w">	</span><span class="p">{</span>
<span class="linenos">1218</span><span class="w">		</span><span class="n">uint</span><span class="w"> </span><span class="n">unresolved</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="p">)</span><span class="n">d_overflows</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
<span class="linenos">1219</span><span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">unresolved</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">1220</span><span class="w">		</span><span class="p">{</span>
<span class="linenos">1221</span><span class="w">            </span><span class="n">Print</span><span class="o">::</span><span class="n">printf</span><span class="p">(</span><span class="n">Print</span><span class="o">::</span><span class="n">WARNING</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;[gpu %d] %d unresolved overflows&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">gpu</span><span class="p">,</span><span class="w"> </span><span class="n">unresolved</span><span class="p">);</span>
<span class="linenos">1222</span><span class="w">		</span><span class="p">}</span>
<span class="linenos">1223</span><span class="w">	</span><span class="p">}</span>
<span class="linenos">1224</span>
<span class="linenos">1225</span><span class="w">	</span><span class="c1">// Save correct pointers for current data</span>
<span class="linenos">1226</span><span class="w">	</span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">dLattice</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="n">dtmp</span><span class="p">;</span>
<span class="linenos">1227</span><span class="w">	</span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">dLatticeTmp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dlat</span><span class="p">;</span>
<span class="linenos">1228</span>
<span class="linenos">1229</span><span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">overflow_handling</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">OVERFLOW_MODE_CLASSIC</span><span class="p">)</span>
<span class="linenos">1230</span><span class="w">	</span><span class="p">{</span>
<span class="linenos">1231</span><span class="w">	</span><span class="cp">#ifndef MPD_MAPPED_OVERFLOWS</span>
<span class="linenos">1232</span><span class="w">		</span><span class="n">cudaMemcpy</span><span class="p">(</span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">h_overflows</span><span class="p">,</span><span class="w"> </span><span class="n">d_overflows</span><span class="p">,</span><span class="w"> </span><span class="n">MPD_OVERFLOW_LIST_SIZE</span><span class="p">,</span><span class="w"> </span><span class="n">cudaMemcpyDeviceToHost</span><span class="p">);</span>
<span class="linenos">1233</span><span class="w">	</span><span class="cp">#endif</span>
<span class="linenos">1234</span>
<span class="linenos">1235</span><span class="w">    	</span><span class="n">PROF_END</span><span class="p">(</span><span class="n">PROF_MPD_TIMESTEP</span><span class="p">);</span>
<span class="linenos">1236</span><span class="w">		</span><span class="k">return</span><span class="w"> </span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">h_overflows</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="linenos">1237</span><span class="w">	</span><span class="p">}</span>
<span class="linenos">1238</span><span class="w">	</span>
<span class="linenos">1239</span><span class="w">	</span><span class="c1">// relaxed overflow mode</span>
<span class="linenos">1240</span><span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">1241</span><span class="p">}</span>
<span class="linenos">1242</span>
<span class="linenos">1243</span>
<span class="linenos">1244</span><span class="kt">int</span><span class="w"> </span><span class="n">MGPUMpdRdmeSolver</span><span class="o">::</span><span class="n">handle_overflows</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">gpu</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">hptr</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">dptr</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ts</span><span class="p">)</span>
<span class="linenos">1245</span><span class="p">{</span>
<span class="linenos">1246</span><span class="w">	</span><span class="c1">// Copy data back from GPUs</span>
<span class="linenos">1247</span><span class="w">	</span><span class="n">mapper</span><span class="o">-&gt;</span><span class="n">stage_out</span><span class="p">(</span><span class="n">gpu</span><span class="p">,</span><span class="w"> </span><span class="n">hptr</span><span class="p">,</span><span class="w"> </span><span class="n">dptr</span><span class="p">);</span>
<span class="linenos">1248</span><span class="w">	</span><span class="c1">//	Print::printf(Print::DEBUG,&quot;[GPU Thread %d] entering ob1.&quot;,gpu);</span>
<span class="linenos">1249</span><span class="w">	</span><span class="n">pthread_barrier_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">overflow_barrier1</span><span class="p">);</span>
<span class="linenos">1250</span>
<span class="linenos">1251</span><span class="w">	</span><span class="c1">// Resolve overflows</span>
<span class="linenos">1252</span><span class="w">	</span><span class="k">if</span><span class="p">(</span><span class="n">gpu</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">1253</span><span class="w">	</span><span class="p">{</span>
<span class="linenos">1254</span><span class="w">		</span><span class="n">handle_all_overflows</span><span class="p">();</span>
<span class="linenos">1255</span><span class="w">		</span><span class="n">mclkr_total_overflows</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">1256</span><span class="w">		</span><span class="n">mclkr_overflow_counter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">1257</span><span class="w">	</span><span class="p">}</span>
<span class="linenos">1258</span><span class="w">	</span><span class="c1">//	Print::printf(Print::DEBUG,&quot;[GPU Thread %d] entering ob2.&quot;,gpu);</span>
<span class="linenos">1259</span><span class="w">	</span><span class="n">pthread_barrier_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">overflow_barrier2</span><span class="p">);</span>
<span class="linenos">1260</span>
<span class="linenos">1261</span><span class="w">	</span><span class="c1">// Return to GPU</span>
<span class="linenos">1262</span><span class="w">	</span><span class="n">mapper</span><span class="o">-&gt;</span><span class="n">stage_in</span><span class="p">(</span><span class="n">gpu</span><span class="p">,</span><span class="w"> </span><span class="n">dptr</span><span class="p">,</span><span class="w"> </span><span class="n">hptr</span><span class="p">);</span>
<span class="linenos">1263</span><span class="w">	</span><span class="n">mapper</span><span class="o">-&gt;</span><span class="n">publish_state</span><span class="p">(</span><span class="n">gpu</span><span class="p">,</span><span class="w"> </span><span class="n">dptr</span><span class="p">,</span><span class="w"> </span><span class="n">ts</span><span class="p">);</span>
<span class="linenos">1264</span><span class="w">	</span><span class="n">cudaMemsetAsync</span><span class="p">(</span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">d_overflows</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="p">));</span>
<span class="linenos">1265</span><span class="w">	</span><span class="c1">//	Print::printf(Print::DEBUG,&quot;[GPU Thread %d] entering ob3.&quot;,gpu);</span>
<span class="linenos">1266</span><span class="w">	</span><span class="n">pthread_barrier_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">overflow_barrier1</span><span class="p">);</span>
<span class="linenos">1267</span>
<span class="linenos">1268</span>
<span class="linenos">1269</span><span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">1270</span><span class="p">}</span>
<span class="linenos">1271</span>
<span class="linenos">1272</span><span class="kt">int</span><span class="w"> </span><span class="n">MGPUMpdRdmeSolver</span><span class="o">::</span><span class="n">handle_all_overflows</span><span class="p">()</span>
<span class="linenos">1273</span><span class="p">{</span>
<span class="linenos">1274</span><span class="w">    </span><span class="c1">// Handle any particle overflows.</span>
<span class="linenos">1275</span><span class="w">    </span><span class="n">PROF_BEGIN</span><span class="p">(</span><span class="n">PROF_MPD_OVERFLOW</span><span class="p">);</span>
<span class="linenos">1276</span>
<span class="linenos">1277</span><span class="w">    </span><span class="n">overflowTimesteps</span><span class="o">++</span><span class="p">;</span>
<span class="linenos">1278</span><span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">overflowList</span><span class="p">[</span><span class="mi">1</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">TUNE_MPD_MAX_PARTICLE_OVERFLOWS</span><span class="p">];</span>
<span class="linenos">1279</span><span class="w">    </span><span class="n">uint</span><span class="w"> </span><span class="n">numberExceptions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">1280</span>
<span class="linenos">1281</span><span class="w">	</span><span class="c1">// LOOP OVER EACH GPU</span>
<span class="linenos">1282</span><span class="w">	</span><span class="kt">int</span><span class="w"> </span><span class="n">gpus</span><span class="o">=</span><span class="n">resources</span><span class="o">-&gt;</span><span class="n">cudaDevices</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
<span class="linenos">1283</span><span class="w">	</span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">gpus</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">1284</span><span class="w">	</span><span class="p">{</span>
<span class="linenos">1285</span><span class="w">		</span><span class="n">uint</span><span class="o">*</span><span class="w"> </span><span class="n">gpulist</span><span class="o">=</span><span class="n">threads</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">h_overflows</span><span class="p">;</span>
<span class="linenos">1286</span><span class="w">		</span><span class="kt">ssize_t</span><span class="w"> </span><span class="n">min_index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mapper</span><span class="o">-&gt;</span><span class="n">get_authority_offset</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
<span class="linenos">1287</span><span class="w">		</span><span class="kt">ssize_t</span><span class="w"> </span><span class="n">max_index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DIMSIZE</span><span class="p">(</span><span class="n">mapper</span><span class="o">-&gt;</span><span class="n">get_global_dim</span><span class="p">(</span><span class="n">i</span><span class="p">))</span><span class="o">+</span><span class="n">min_index</span><span class="p">;</span>
<span class="linenos">1288</span><span class="w">		</span><span class="c1">//printf(&quot;gpu %d: min %d max %d\n&quot;, i, min_index, max_index);</span>
<span class="linenos">1289</span>
<span class="linenos">1290</span><span class="w">		</span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">e</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">e</span><span class="o">&lt;</span><span class="n">gpulist</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span><span class="w"> </span><span class="n">e</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">1291</span><span class="w">		</span><span class="p">{</span>
<span class="linenos">1292</span><span class="w">			</span><span class="c1">// DECODE INDEX</span>
<span class="linenos">1293</span><span class="w">            </span><span class="kt">size_t</span><span class="w"> </span><span class="n">latticeIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gpulist</span><span class="p">[</span><span class="n">e</span><span class="o">*</span><span class="mi">2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">];</span>
<span class="linenos">1294</span><span class="w">            </span><span class="n">particle_t</span><span class="w"> </span><span class="n">particle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gpulist</span><span class="p">[</span><span class="n">e</span><span class="o">*</span><span class="mi">2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="p">];</span>
<span class="linenos">1295</span><span class="w">			</span>
<span class="linenos">1296</span><span class="w">			</span><span class="kt">ssize_t</span><span class="w"> </span><span class="n">globalIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">latticeIndex</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">mapper</span><span class="o">-&gt;</span><span class="n">get_global_input_offset</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
<span class="linenos">1297</span><span class="w">			</span><span class="c1">//printf(&quot;Overflow of particle type %d at local index %d on gpu %d ==&gt; index %d\n&quot;, particle, latticeIndex, i, globalIndex);</span>
<span class="linenos">1298</span><span class="w">			</span><span class="k">if</span><span class="p">(</span><span class="n">latticeIndex</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">min_index</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">latticeIndex</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">max_index</span><span class="p">)</span>
<span class="linenos">1299</span><span class="w">				</span><span class="k">continue</span><span class="p">;</span>
<span class="linenos">1300</span>
<span class="linenos">1301</span><span class="w">			</span><span class="c1">// FILL list</span>
<span class="linenos">1302</span><span class="w">            </span><span class="n">overflowList</span><span class="p">[(</span><span class="n">numberExceptions</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">globalIndex</span><span class="p">;</span>
<span class="linenos">1303</span><span class="w">			</span><span class="n">overflowList</span><span class="p">[(</span><span class="n">numberExceptions</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">particle</span><span class="p">;</span>
<span class="linenos">1304</span><span class="w">			</span><span class="n">numberExceptions</span><span class="o">++</span><span class="p">;</span>
<span class="linenos">1305</span><span class="w">		</span><span class="p">}</span>
<span class="linenos">1306</span><span class="w">	</span><span class="p">}</span>
<span class="linenos">1307</span>
<span class="linenos">1308</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">numberExceptions</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">1309</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">1310</span><span class="w">        </span><span class="n">Print</span><span class="o">::</span><span class="n">printf</span><span class="p">(</span><span class="n">Print</span><span class="o">::</span><span class="n">DEBUG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;%d overflows&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">numberExceptions</span><span class="p">);</span>
<span class="linenos">1311</span><span class="w">        </span>
<span class="linenos">1312</span><span class="w">        </span><span class="c1">// Make sure we did not exceed the overflow buffer.</span>
<span class="linenos">1313</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">numberExceptions</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">TUNE_MPD_MAX_PARTICLE_OVERFLOWS</span><span class="p">)</span>
<span class="linenos">1314</span><span class="w">            </span><span class="n">throw</span><span class="w"> </span><span class="n">Exception</span><span class="p">(</span><span class="s">&quot;Too many particle overflows for the available buffer&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">numberExceptions</span><span class="p">);</span>
<span class="linenos">1315</span><span class="w">            </span>
<span class="linenos">1316</span><span class="w">        </span><span class="c1">// Go through each exception.</span>
<span class="linenos">1317</span><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">numberExceptions</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">1318</span><span class="w">        </span><span class="p">{</span>
<span class="linenos">1319</span><span class="w">            </span><span class="c1">// Extract the index and particle type.</span>
<span class="linenos">1320</span><span class="w">            </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">latticeIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">overflowList</span><span class="p">[(</span><span class="n">i</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
<span class="linenos">1321</span><span class="w">            </span><span class="n">particle_t</span><span class="w"> </span><span class="n">particle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">overflowList</span><span class="p">[(</span><span class="n">i</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="mi">2</span><span class="p">];</span>
<span class="linenos">1322</span><span class="w">            </span>
<span class="linenos">1323</span><span class="w">            </span><span class="c1">// Get the x, y, and z coordiantes.</span>
<span class="linenos">1324</span><span class="w">            </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">latticeIndex</span><span class="o">%</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getXSize</span><span class="p">();</span>
<span class="linenos">1325</span><span class="w">            </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">latticeIndex</span><span class="o">/</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getXSize</span><span class="p">())</span><span class="o">%</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getYSize</span><span class="p">();</span>
<span class="linenos">1326</span><span class="w">            </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">latticeIndex</span><span class="o">/</span><span class="p">(</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getXSize</span><span class="p">()</span><span class="o">*</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getYSize</span><span class="p">());</span>
<span class="linenos">1327</span><span class="w">            </span>
<span class="linenos">1328</span><span class="w">            </span><span class="c1">// Put the particles back into a nearby lattice site.</span>
<span class="linenos">1329</span><span class="w">            </span><span class="kt">bool</span><span class="w"> </span><span class="n">replacedParticle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="linenos">1330</span><span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">searchRadius</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="o">!</span><span class="n">replacedParticle</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">searchRadius</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">TUNE_MPD_MAX_OVERFLOW_REPLACEMENT_DIST</span><span class="p">;</span><span class="w"> </span><span class="n">searchRadius</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">1331</span><span class="w">            </span><span class="p">{</span>
<span class="linenos">1332</span><span class="w">                </span><span class="c1">// Get the nearby sites.</span>
<span class="linenos">1333</span><span class="w">                </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">lattice_coord_t</span><span class="o">&gt;</span><span class="w"> </span><span class="n">sites</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getNearbySites</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">,(</span><span class="n">searchRadius</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span><span class="o">?</span><span class="n">searchRadius</span><span class="mi">-1</span><span class="o">:</span><span class="mi">0</span><span class="p">,</span><span class="n">searchRadius</span><span class="p">);</span>
<span class="linenos">1334</span><span class="w">                </span>
<span class="linenos">1335</span><span class="w">                </span><span class="c1">// TODO: Shuffle the sites.</span>
<span class="linenos">1336</span><span class="w">                </span>
<span class="linenos">1337</span><span class="w">                </span><span class="c1">// Try to find one that in not fully occupied and of the same type.</span>
<span class="linenos">1338</span><span class="w">                </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">lattice_coord_t</span><span class="o">&gt;::</span><span class="n">iterator</span><span class="w"> </span><span class="n">it</span><span class="o">=</span><span class="n">sites</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span><span class="w"> </span><span class="n">it</span><span class="o">&lt;</span><span class="n">sites</span><span class="p">.</span><span class="n">end</span><span class="p">();</span><span class="w"> </span><span class="n">it</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">1339</span><span class="w">                </span><span class="p">{</span>
<span class="linenos">1340</span><span class="w">                    </span><span class="n">lattice_coord_t</span><span class="w"> </span><span class="n">site</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">it</span><span class="p">;</span>
<span class="linenos">1341</span><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getOccupancy</span><span class="p">(</span><span class="n">site</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="n">site</span><span class="p">.</span><span class="n">y</span><span class="p">,</span><span class="n">site</span><span class="p">.</span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getMaxOccupancy</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getSiteType</span><span class="p">(</span><span class="n">site</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="n">site</span><span class="p">.</span><span class="n">y</span><span class="p">,</span><span class="n">site</span><span class="p">.</span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getSiteType</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">))</span>
<span class="linenos">1342</span><span class="w">                    </span><span class="p">{</span>
<span class="linenos">1343</span><span class="w">                        </span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">addParticle</span><span class="p">(</span><span class="n">site</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">site</span><span class="p">.</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">site</span><span class="p">.</span><span class="n">z</span><span class="p">,</span><span class="w"> </span><span class="n">particle</span><span class="p">);</span>
<span class="linenos">1344</span><span class="w">                        </span><span class="n">replacedParticle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="linenos">1345</span><span class="w">                        </span><span class="n">Print</span><span class="o">::</span><span class="n">printf</span><span class="p">(</span><span class="n">Print</span><span class="o">::</span><span class="n">VERBOSE_DEBUG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Handled overflow of particle %d at site %d,%d,%d type=%d occ=%d by placing at site %d,%d,%d type=%d newocc=%d dist=%0.2f&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">particle</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">z</span><span class="p">,</span><span class="w"> </span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getSiteType</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">),</span><span class="w"> </span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getOccupancy</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">),</span><span class="w"> </span><span class="n">site</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">site</span><span class="p">.</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">site</span><span class="p">.</span><span class="n">z</span><span class="p">,</span><span class="w"> </span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getSiteType</span><span class="p">(</span><span class="n">site</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="n">site</span><span class="p">.</span><span class="n">y</span><span class="p">,</span><span class="n">site</span><span class="p">.</span><span class="n">z</span><span class="p">),</span><span class="w"> </span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getOccupancy</span><span class="p">(</span><span class="n">site</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="n">site</span><span class="p">.</span><span class="n">y</span><span class="p">,</span><span class="n">site</span><span class="p">.</span><span class="n">z</span><span class="p">),</span><span class="w"> </span><span class="n">sqrt</span><span class="p">(</span><span class="n">pow</span><span class="p">((</span><span class="kt">double</span><span class="p">)</span><span class="n">x</span><span class="o">-</span><span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="n">site</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="mf">2.0</span><span class="p">)</span><span class="o">+</span><span class="n">pow</span><span class="p">((</span><span class="kt">double</span><span class="p">)</span><span class="n">y</span><span class="o">-</span><span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="n">site</span><span class="p">.</span><span class="n">y</span><span class="p">,</span><span class="mf">2.0</span><span class="p">)</span><span class="o">+</span><span class="n">pow</span><span class="p">((</span><span class="kt">double</span><span class="p">)</span><span class="n">z</span><span class="o">-</span><span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="n">site</span><span class="p">.</span><span class="n">z</span><span class="p">,</span><span class="mf">2.0</span><span class="p">)));</span>
<span class="linenos">1346</span><span class="w">                        </span><span class="k">break</span><span class="p">;</span>
<span class="linenos">1347</span><span class="w">                    </span><span class="p">}</span>
<span class="linenos">1348</span><span class="w">                </span><span class="p">}</span>
<span class="linenos">1349</span><span class="w">            </span><span class="p">}</span>
<span class="linenos">1350</span><span class="w">            </span>
<span class="linenos">1351</span><span class="w">            </span><span class="c1">// If we were not able to fix the exception, throw an error.</span>
<span class="linenos">1352</span><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">replacedParticle</span><span class="p">)</span>
<span class="linenos">1353</span><span class="w">                </span><span class="n">throw</span><span class="w"> </span><span class="n">Exception</span><span class="p">(</span><span class="s">&quot;Unable to find an available site to handle a particle overflow.&quot;</span><span class="p">);</span>
<span class="linenos">1354</span><span class="w">        </span><span class="p">}</span>
<span class="linenos">1355</span><span class="w">        </span>
<span class="linenos">1356</span><span class="w">        </span><span class="c1">// Track that we used the overflow list.</span>
<span class="linenos">1357</span><span class="w">        </span><span class="n">overflowListUses</span><span class="o">++</span><span class="p">;</span>
<span class="linenos">1358</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">1359</span><span class="w">    </span>
<span class="linenos">1360</span><span class="w">    </span><span class="c1">// If the overflow lsit is being used too often, print a warning.</span>
<span class="linenos">1361</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">overflowTimesteps</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">1000</span><span class="p">)</span>
<span class="linenos">1362</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">1363</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">overflowListUses</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">10</span><span class="p">)</span>
<span class="linenos">1364</span><span class="w">            </span><span class="n">Print</span><span class="o">::</span><span class="n">printf</span><span class="p">(</span><span class="n">Print</span><span class="o">::</span><span class="n">WARNING</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;%d uses of the particle overflow list in the last 1000 timesteps, performance may be degraded.&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">overflowListUses</span><span class="p">);</span>
<span class="linenos">1365</span><span class="w">        </span><span class="n">overflowTimesteps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">1366</span><span class="w">        </span><span class="n">overflowListUses</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">1367</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">1368</span><span class="w">    </span><span class="n">PROF_END</span><span class="p">(</span><span class="n">PROF_MPD_OVERFLOW</span><span class="p">);</span>
<span class="linenos">1369</span>
<span class="linenos">1370</span><span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">1371</span><span class="p">}</span>
<span class="linenos">1372</span>
<span class="linenos">1373</span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="n">MGPUMpdRdmeSolver</span><span class="o">::</span><span class="n">run_thread</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">gpu</span><span class="p">)</span>
<span class="linenos">1374</span><span class="p">{</span>
<span class="linenos">1375</span><span class="w">	</span><span class="n">mapper</span><span class="o">-&gt;</span><span class="n">numa_bind_thread</span><span class="p">(</span><span class="n">gpu</span><span class="p">);</span>
<span class="linenos">1376</span><span class="w">	</span><span class="n">mapper</span><span class="o">-&gt;</span><span class="n">initialize_gpu</span><span class="p">(</span><span class="n">gpu</span><span class="p">);</span>
<span class="linenos">1377</span><span class="w">	</span><span class="n">pthread_barrier_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">simulation_barrier</span><span class="p">);</span>
<span class="linenos">1378</span><span class="w">	</span><span class="n">mapper</span><span class="o">-&gt;</span><span class="n">set_affinity</span><span class="p">(</span><span class="n">gpu</span><span class="p">);</span>
<span class="linenos">1379</span><span class="w">	</span>
<span class="linenos">1380</span><span class="w">	</span><span class="n">gpu_worker_thread_params</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">];</span>
<span class="linenos">1381</span>
<span class="linenos">1382</span><span class="w">	</span><span class="c1">// allocate device memory for lattice stuctures</span>
<span class="linenos">1383</span><span class="w">	</span><span class="n">cudaMalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dLattice</span><span class="p">,</span><span class="w">    </span><span class="n">mapper</span><span class="o">-&gt;</span><span class="n">get_local_size</span><span class="p">(</span><span class="n">gpu</span><span class="p">)</span><span class="o">*</span><span class="n">MPD_WORDS_PER_SITE</span><span class="p">);</span>
<span class="linenos">1384</span><span class="w">	</span><span class="n">cudaMalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dLatticeTmp</span><span class="p">,</span><span class="w"> </span><span class="n">mapper</span><span class="o">-&gt;</span><span class="n">get_local_size</span><span class="p">(</span><span class="n">gpu</span><span class="p">)</span><span class="o">*</span><span class="n">MPD_WORDS_PER_SITE</span><span class="p">);</span>
<span class="linenos">1385</span><span class="w">	</span><span class="n">cudaMalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dSites</span><span class="p">,</span><span class="w">      </span><span class="n">DIMSIZE</span><span class="p">(</span><span class="n">mapper</span><span class="o">-&gt;</span><span class="n">get_local_dim</span><span class="p">(</span><span class="n">gpu</span><span class="p">)));</span>
<span class="linenos">1386</span>
<span class="linenos">1387</span><span class="w">	</span><span class="c1">// allocate device and host space for overflow lists</span>
<span class="linenos">1388</span><span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">overflow_handling</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">OVERFLOW_MODE_CLASSIC</span><span class="p">)</span>
<span class="linenos">1389</span><span class="w">	</span><span class="p">{</span>
<span class="linenos">1390</span><span class="w">	</span><span class="cp">#ifdef MPD_MAPPED_OVERFLOWS</span>
<span class="linenos">1391</span><span class="w">	    </span><span class="n">CUDA_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">cudaHostAlloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">h_overflows</span><span class="p">,</span>
<span class="linenos">1392</span><span class="w">		                                   </span><span class="n">MPD_OVERFLOW_LIST_SIZE</span><span class="p">,</span>
<span class="linenos">1393</span><span class="w">										   </span><span class="n">cudaHostAllocPortable</span><span class="o">|</span><span class="n">cudaHostAllocMapped</span><span class="p">));</span>
<span class="linenos">1394</span><span class="w">		</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">d_overflows</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">h_overflows</span><span class="p">;</span>
<span class="linenos">1395</span><span class="w">	</span><span class="cp">#else</span>
<span class="linenos">1396</span><span class="w">	    </span><span class="n">CUDA_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">cudaHostAlloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">h_overflows</span><span class="p">,</span>
<span class="linenos">1397</span><span class="w">		                                   </span><span class="n">MPD_OVERFLOW_LIST_SIZE</span><span class="p">,</span>
<span class="linenos">1398</span><span class="w">										   </span><span class="n">cudaHostAllocPortable</span><span class="p">));</span>
<span class="linenos">1399</span><span class="w">	    </span><span class="n">CUDA_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">cudaMalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">d_overflows</span><span class="p">,</span>
<span class="linenos">1400</span><span class="w">		                                </span><span class="n">MPD_OVERFLOW_LIST_SIZE</span><span class="p">));</span>
<span class="linenos">1401</span><span class="w">		</span><span class="n">cudaMemsetAsync</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">d_overflows</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">MPD_OVERFLOW_LIST_SIZE</span><span class="p">);</span>
<span class="linenos">1402</span><span class="w">	</span><span class="cp">#endif</span>
<span class="linenos">1403</span>
<span class="linenos">1404</span><span class="w">		</span><span class="n">memset</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">h_overflows</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">MPD_OVERFLOW_LIST_SIZE</span><span class="p">);</span>
<span class="linenos">1405</span><span class="w">	</span><span class="p">}</span>
<span class="linenos">1406</span><span class="w">	</span><span class="k">else</span>
<span class="linenos">1407</span><span class="w">	</span><span class="p">{</span>
<span class="linenos">1408</span><span class="w">		</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">h_overflows</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="linenos">1409</span><span class="w">	    </span><span class="n">CUDA_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">cudaMalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">d_overflows</span><span class="p">,</span>
<span class="linenos">1410</span><span class="w">		                                </span><span class="n">MPD_OVERFLOW_LIST_SIZE</span><span class="p">));</span>
<span class="linenos">1411</span><span class="w">		</span><span class="n">cudaMemsetAsync</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">d_overflows</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">MPD_OVERFLOW_LIST_SIZE</span><span class="p">);</span>
<span class="linenos">1412</span><span class="w">	</span><span class="p">}</span>
<span class="linenos">1413</span>
<span class="linenos">1414</span><span class="w">    </span><span class="c1">// Create data exchange streams and events</span>
<span class="linenos">1415</span><span class="w">    </span><span class="n">CUDA_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">cudaStreamCreate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">stream1</span><span class="p">));</span>
<span class="linenos">1416</span>
<span class="linenos">1417</span><span class="cp">#ifdef PROF_USE_CUEVENT</span>
<span class="linenos">1418</span><span class="w">    </span><span class="n">CUDA_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">cudaEventCreate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">x_finish</span><span class="p">));</span>
<span class="linenos">1419</span><span class="w">    </span><span class="n">CUDA_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">cudaEventCreate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">diffusion_finished</span><span class="p">));</span>
<span class="linenos">1420</span><span class="w">    </span><span class="n">CUDA_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">cudaEventCreate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">rx_finish</span><span class="p">));</span>
<span class="linenos">1421</span><span class="cp">#else</span>
<span class="linenos">1422</span><span class="w">    </span><span class="n">CUDA_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">cudaEventCreateWithFlags</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">x_finish</span><span class="p">,</span>
<span class="linenos">1423</span><span class="w">	                                              </span><span class="n">cudaEventDisableTiming</span><span class="p">));</span>
<span class="linenos">1424</span><span class="w">    </span><span class="n">CUDA_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">cudaEventCreateWithFlags</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">diffusion_finished</span><span class="p">,</span>
<span class="linenos">1425</span><span class="w">	                                              </span><span class="n">cudaEventDisableTiming</span><span class="p">));</span>
<span class="linenos">1426</span><span class="w">    </span><span class="n">CUDA_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">cudaEventCreateWithFlags</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">rx_finish</span><span class="p">,</span>
<span class="linenos">1427</span><span class="w">	                                              </span><span class="n">cudaEventDisableTiming</span><span class="p">));</span>
<span class="linenos">1428</span><span class="cp">#endif</span>
<span class="linenos">1429</span>
<span class="linenos">1430</span><span class="w">	</span><span class="kt">dim3</span><span class="w"> </span><span class="n">ldim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mapper</span><span class="o">-&gt;</span><span class="n">get_local_dim</span><span class="p">(</span><span class="n">gpu</span><span class="p">);</span>
<span class="linenos">1431</span><span class="w">	</span><span class="kt">dim3</span><span class="w"> </span><span class="n">gdim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mapper</span><span class="o">-&gt;</span><span class="n">get_global_dim</span><span class="p">(</span><span class="n">gpu</span><span class="p">);</span>
<span class="linenos">1432</span>
<span class="linenos">1433</span><span class="w">	</span><span class="c1">// calculate launch params</span>
<span class="linenos">1434</span><span class="w">    </span><span class="n">calculateXLaunchParameters</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">grid_x</span><span class="p">),</span><span class="w"> </span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">threads_x</span><span class="p">,</span>
<span class="linenos">1435</span><span class="w">	                           </span><span class="n">TUNE_MPD_X_BLOCK_MAX_X_SIZE</span><span class="p">,</span>
<span class="linenos">1436</span><span class="w">							   </span><span class="n">ldim</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">ldim</span><span class="p">.</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">ldim</span><span class="p">.</span><span class="n">z</span><span class="p">);</span>
<span class="linenos">1437</span><span class="w">    </span><span class="n">calculateYLaunchParameters</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">grid_y</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">threads_y</span><span class="p">,</span>
<span class="linenos">1438</span><span class="w">	                           </span><span class="n">TUNE_MPD_Y_BLOCK_X_SIZE</span><span class="p">,</span><span class="w"> </span><span class="n">TUNE_MPD_Y_BLOCK_Y_SIZE</span><span class="p">,</span>
<span class="linenos">1439</span><span class="w">							   </span><span class="n">ldim</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">ldim</span><span class="p">.</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">ldim</span><span class="p">.</span><span class="n">z</span><span class="p">);</span>
<span class="linenos">1440</span><span class="w">    </span><span class="n">calculateZLaunchParameters</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">grid_z</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">threads_z</span><span class="p">,</span>
<span class="linenos">1441</span><span class="w">	                           </span><span class="n">TUNE_MPD_Z_BLOCK_X_SIZE</span><span class="p">,</span><span class="w"> </span><span class="n">TUNE_MPD_Z_BLOCK_Z_SIZE</span><span class="p">,</span>
<span class="linenos">1442</span><span class="w">							   </span><span class="n">ldim</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">ldim</span><span class="p">.</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">gdim</span><span class="p">.</span><span class="n">z</span><span class="p">);</span>
<span class="linenos">1443</span><span class="w">	</span><span class="n">calculateReactionLaunchParameters</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">grid_r</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">threads_r</span><span class="p">,</span>
<span class="linenos">1444</span><span class="w">	                                  </span><span class="n">TUNE_MPD_REACTION_BLOCK_X_SIZE</span><span class="p">,</span><span class="w"> </span><span class="n">TUNE_MPD_REACTION_BLOCK_Y_SIZE</span><span class="p">,</span>
<span class="linenos">1445</span><span class="w">									  </span><span class="n">ldim</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">ldim</span><span class="p">.</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">gdim</span><span class="p">.</span><span class="n">z</span><span class="p">);</span>
<span class="linenos">1446</span>
<span class="linenos">1447</span><span class="w">	</span><span class="c1">// Now here, do not copy model every time</span>
<span class="linenos">1448</span><span class="w">	</span><span class="n">copyModelsToDevice</span><span class="p">(</span><span class="n">gpu</span><span class="p">);</span>
<span class="linenos">1449</span>
<span class="linenos">1450</span><span class="w">	</span><span class="c1">// Copy the initialized data into GPU memory</span>
<span class="linenos">1451</span><span class="w">	</span><span class="n">mapper</span><span class="o">-&gt;</span><span class="n">stage_in</span><span class="p">(</span><span class="n">gpu</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dLattice</span><span class="p">,</span><span class="w"> </span><span class="p">((</span><span class="n">ByteLattice</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">lattice</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">getParticlesMemory</span><span class="p">());</span>
<span class="linenos">1452</span><span class="w">	</span><span class="n">mapper</span><span class="o">-&gt;</span><span class="n">stage_in_sites</span><span class="p">(</span><span class="n">gpu</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dSites</span><span class="p">,</span><span class="w"> </span><span class="p">((</span><span class="n">ByteLattice</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">lattice</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">getSitesMemory</span><span class="p">());</span>
<span class="linenos">1453</span><span class="w">	</span><span class="n">mapper</span><span class="o">-&gt;</span><span class="n">publish_state</span><span class="p">(</span><span class="n">gpu</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dLattice</span><span class="p">,</span><span class="w"> </span><span class="n">current_timestep</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
<span class="linenos">1454</span><span class="w">	</span>
<span class="linenos">1455</span><span class="w">	</span><span class="n">Timer</span><span class="w"> </span><span class="n">timer</span><span class="p">;</span>
<span class="linenos">1456</span><span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">lastT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">1457</span><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">lastSteps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">1458</span><span class="w">	</span><span class="kt">size_t</span><span class="w"> </span><span class="n">maxTS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">atof</span><span class="p">((</span><span class="o">*</span><span class="n">parameters</span><span class="p">)[</span><span class="s">&quot;maxTime&quot;</span><span class="p">].</span><span class="n">c_str</span><span class="p">())</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">tau</span><span class="p">;</span>
<span class="linenos">1459</span><span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">gpu</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">1460</span><span class="w">		</span><span class="n">timer</span><span class="p">.</span><span class="n">tick</span><span class="p">();</span>
<span class="linenos">1461</span>
<span class="linenos">1462</span><span class="w">	</span><span class="k">do</span>
<span class="linenos">1463</span><span class="w">	</span><span class="p">{</span>
<span class="linenos">1464</span><span class="w">		</span><span class="c1">// wait for master wakeup</span>
<span class="linenos">1465</span><span class="w">		</span><span class="n">pthread_barrier_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">start_barrier</span><span class="p">);</span>
<span class="linenos">1466</span>
<span class="linenos">1467</span><span class="w">		</span><span class="kt">int</span><span class="w"> </span><span class="n">steps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">timesteps_to_run</span><span class="p">;</span>
<span class="linenos">1468</span><span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">steps</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">1469</span><span class="w">			</span><span class="k">break</span><span class="p">;</span>
<span class="linenos">1470</span>
<span class="linenos">1471</span><span class="w">		</span><span class="c1">// Don&#39;t copy models in on every step set</span>
<span class="linenos">1472</span><span class="w">		</span><span class="c1">// This was to accomodate changing lattice dims from lb changes</span>
<span class="linenos">1473</span><span class="w">		</span><span class="c1">// Unless the reaction model has changed</span>
<span class="linenos">1474</span><span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">reactionModelModified</span><span class="p">)</span><span class="w"> </span>
<span class="linenos">1475</span><span class="w">		</span><span class="p">{</span>
<span class="linenos">1476</span><span class="w">			</span><span class="n">copyModelsToDevice</span><span class="p">(</span><span class="n">gpu</span><span class="p">);</span>
<span class="linenos">1477</span><span class="w">		</span><span class="p">}</span>
<span class="linenos">1478</span>
<span class="linenos">1479</span><span class="w">		</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">ts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">ts</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">steps</span><span class="p">;</span><span class="w"> </span><span class="n">ts</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">1480</span><span class="w">		</span><span class="p">{</span>
<span class="linenos">1481</span><span class="w">			</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">gpu</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">1482</span><span class="w">			</span><span class="p">{</span>
<span class="linenos">1483</span><span class="w">				</span><span class="n">lastT</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">timer</span><span class="p">.</span><span class="n">tock</span><span class="p">();</span>
<span class="linenos">1484</span><span class="w">				</span><span class="n">lastSteps</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="linenos">1485</span>
<span class="linenos">1486</span><span class="w">				</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">lastT</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">printPerfInterval</span><span class="p">)</span>
<span class="linenos">1487</span><span class="w">				</span><span class="p">{</span>
<span class="linenos">1488</span><span class="w">					</span><span class="kt">double</span><span class="w"> </span><span class="n">stepTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lastT</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">lastSteps</span><span class="p">;</span>
<span class="linenos">1489</span><span class="w">					</span><span class="kt">double</span><span class="w"> </span><span class="n">completionTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stepTime</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">maxTS</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">current_timestep</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">ts</span><span class="p">);</span>
<span class="linenos">1490</span><span class="w">					</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">units</span><span class="p">;</span>
<span class="linenos">1491</span><span class="w">					</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">completionTime</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">24</span><span class="o">*</span><span class="mi">365</span><span class="p">)</span>
<span class="linenos">1492</span><span class="w">					</span><span class="p">{</span>
<span class="linenos">1493</span><span class="w">						</span><span class="n">units</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;weeks&quot;</span><span class="p">;</span>
<span class="linenos">1494</span><span class="w">						</span><span class="n">completionTime</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">24</span><span class="o">*</span><span class="mi">365</span><span class="p">;</span>
<span class="linenos">1495</span><span class="w">					</span><span class="p">}</span>
<span class="linenos">1496</span><span class="w">					</span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">completionTime</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">24</span><span class="o">*</span><span class="mi">30</span><span class="p">)</span>
<span class="linenos">1497</span><span class="w">					</span><span class="p">{</span>
<span class="linenos">1498</span><span class="w">						</span><span class="n">units</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;months&quot;</span><span class="p">;</span>
<span class="linenos">1499</span><span class="w">						</span><span class="n">completionTime</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">24</span><span class="o">*</span><span class="mi">30</span><span class="p">;</span>
<span class="linenos">1500</span><span class="w">					</span><span class="p">}</span>
<span class="linenos">1501</span><span class="w">					</span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">completionTime</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">24</span><span class="o">*</span><span class="mi">7</span><span class="p">)</span>
<span class="linenos">1502</span><span class="w">					</span><span class="p">{</span>
<span class="linenos">1503</span><span class="w">						</span><span class="n">units</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;weeks&quot;</span><span class="p">;</span>
<span class="linenos">1504</span><span class="w">						</span><span class="n">completionTime</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">24</span><span class="o">*</span><span class="mi">7</span><span class="p">;</span>
<span class="linenos">1505</span><span class="w">					</span><span class="p">}</span>
<span class="linenos">1506</span><span class="w">					</span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">completionTime</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">24</span><span class="p">)</span>
<span class="linenos">1507</span><span class="w">					</span><span class="p">{</span>
<span class="linenos">1508</span><span class="w">						</span><span class="n">units</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;days&quot;</span><span class="p">;</span>
<span class="linenos">1509</span><span class="w">						</span><span class="n">completionTime</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">24</span><span class="p">;</span>
<span class="linenos">1510</span><span class="w">					</span><span class="p">}</span>
<span class="linenos">1511</span><span class="w">					</span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">completionTime</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>
<span class="linenos">1512</span><span class="w">					</span><span class="p">{</span>
<span class="linenos">1513</span><span class="w">						</span><span class="n">units</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;hours&quot;</span><span class="p">;</span>
<span class="linenos">1514</span><span class="w">						</span><span class="n">completionTime</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="p">;</span>
<span class="linenos">1515</span><span class="w">					</span><span class="p">}</span>
<span class="linenos">1516</span><span class="w">					</span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">completionTime</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">60</span><span class="p">)</span>
<span class="linenos">1517</span><span class="w">					</span><span class="p">{</span>
<span class="linenos">1518</span><span class="w">						</span><span class="n">units</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;minutes&quot;</span><span class="p">;</span>
<span class="linenos">1519</span><span class="w">						</span><span class="n">completionTime</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="mi">60</span><span class="p">;</span>
<span class="linenos">1520</span><span class="w">					</span><span class="p">}</span>
<span class="linenos">1521</span><span class="w">					</span><span class="k">else</span>
<span class="linenos">1522</span><span class="w">					</span><span class="p">{</span>
<span class="linenos">1523</span><span class="w">						</span><span class="n">units</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;seconds&quot;</span><span class="p">;</span>
<span class="linenos">1524</span><span class="w">					</span><span class="p">}</span>
<span class="linenos">1525</span>
<span class="linenos">1526</span><span class="w">					</span><span class="n">Print</span><span class="o">::</span><span class="n">printf</span><span class="p">(</span><span class="n">Print</span><span class="o">::</span><span class="n">INFO</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Average walltime per timestep: %.2f ms. Progress: %.4fs/%.4fs (% .3g%% done / %.2g %s walltime remaining)&quot;</span><span class="p">,</span>
<span class="linenos">1527</span><span class="w">								  </span><span class="mf">1000.0</span><span class="o">*</span><span class="n">stepTime</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">ts</span><span class="o">+</span><span class="n">current_timestep</span><span class="p">)</span><span class="o">*</span><span class="n">tau</span><span class="p">,</span><span class="w"> </span><span class="n">maxTS</span><span class="o">*</span><span class="n">tau</span><span class="p">,</span><span class="w"> </span><span class="mf">100.0</span><span class="o">*</span><span class="p">(</span><span class="n">ts</span><span class="o">+</span><span class="n">current_timestep</span><span class="p">)</span><span class="o">/</span><span class="n">maxTS</span><span class="p">,</span><span class="w"> </span><span class="n">completionTime</span><span class="p">,</span><span class="w"> </span><span class="n">units</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
<span class="linenos">1528</span>
<span class="linenos">1529</span><span class="w">					</span><span class="n">lastT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">1530</span><span class="w">					</span><span class="n">lastSteps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">1531</span><span class="w">				</span><span class="p">}</span>
<span class="linenos">1532</span>
<span class="linenos">1533</span><span class="w">				</span><span class="n">timer</span><span class="p">.</span><span class="n">tick</span><span class="p">();</span>
<span class="linenos">1534</span><span class="w">			</span><span class="p">}</span>
<span class="linenos">1535</span>
<span class="linenos">1536</span><span class="w">			</span><span class="kt">int</span><span class="w"> </span><span class="n">overflows</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">run_next_timestep</span><span class="p">(</span><span class="n">gpu</span><span class="p">,</span><span class="w"> </span><span class="n">ts</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">current_timestep</span><span class="p">);</span>
<span class="linenos">1537</span>
<span class="linenos">1538</span><span class="w">			</span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">overflow_handling</span><span class="p">)</span>
<span class="linenos">1539</span><span class="w">			</span><span class="p">{</span>
<span class="linenos">1540</span><span class="w">				</span><span class="k">case</span><span class="w"> </span><span class="no">OVERFLOW_MODE_CLASSIC</span><span class="p">:</span>
<span class="linenos">1541</span><span class="w">					</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">use_spin_barrier</span><span class="p">)</span>
<span class="linenos">1542</span><span class="w">						</span><span class="n">mclkr_barrier_spin</span><span class="p">(</span><span class="n">overflows</span><span class="p">);</span>
<span class="linenos">1543</span><span class="w">					</span><span class="k">else</span>
<span class="linenos">1544</span><span class="w">						</span><span class="n">mclkr_barrier_cond</span><span class="p">(</span><span class="n">overflows</span><span class="p">);</span>
<span class="linenos">1545</span>
<span class="linenos">1546</span><span class="w">					</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mclkr_total_overflows</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">1547</span><span class="w">					</span><span class="p">{</span>
<span class="linenos">1548</span><span class="w">						</span><span class="n">Print</span><span class="o">::</span><span class="n">printf</span><span class="p">(</span><span class="n">Print</span><span class="o">::</span><span class="n">DEBUG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;[GPU Thread %d] encountered %d overflows&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">gpu</span><span class="p">,</span><span class="w"> </span><span class="n">overflows</span><span class="p">);</span>
<span class="linenos">1549</span><span class="w">						</span><span class="n">handle_overflows</span><span class="p">(</span><span class="n">gpu</span><span class="p">,</span><span class="w"> </span><span class="p">((</span><span class="n">ByteLattice</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">lattice</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">getParticlesMemory</span><span class="p">(),</span>
<span class="linenos">1550</span><span class="w">						                 </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dLattice</span><span class="p">,</span><span class="w"> </span><span class="n">ts</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">current_timestep</span><span class="p">);</span>
<span class="linenos">1551</span><span class="w">					</span><span class="p">}</span>
<span class="linenos">1552</span><span class="w">					</span><span class="k">break</span><span class="p">;</span>
<span class="linenos">1553</span>
<span class="linenos">1554</span><span class="w">				</span><span class="k">case</span><span class="w"> </span><span class="no">OVERFLOW_MODE_RELAXED</span><span class="p">:</span>
<span class="linenos">1555</span><span class="w">					</span><span class="c1">// All overflows are handled by the gpu. No need to communicate.</span>
<span class="linenos">1556</span><span class="w">					</span><span class="n">pthread_barrier_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">simulation_barrier</span><span class="p">);</span>
<span class="linenos">1557</span><span class="w">					</span><span class="k">break</span><span class="p">;</span>
<span class="linenos">1558</span>
<span class="linenos">1559</span><span class="w">				</span><span class="k">default</span><span class="o">:</span>
<span class="linenos">1560</span><span class="w">					</span><span class="n">throw</span><span class="p">(</span><span class="s">&quot;Unimplemented overflow handler&quot;</span><span class="p">);</span>
<span class="linenos">1561</span><span class="w">			</span><span class="p">}</span>
<span class="linenos">1562</span><span class="w">		</span><span class="p">}</span>
<span class="linenos">1563</span>
<span class="linenos">1564</span><span class="w">		</span><span class="n">mapper</span><span class="o">-&gt;</span><span class="n">stage_out</span><span class="p">(</span><span class="n">gpu</span><span class="p">,</span><span class="w"> </span><span class="p">((</span><span class="n">ByteLattice</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">lattice</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">getParticlesMemory</span><span class="p">(),</span><span class="w"> </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dLattice</span><span class="p">);</span>
<span class="linenos">1565</span><span class="w">		</span><span class="n">pthread_barrier_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stop_barrier</span><span class="p">);</span>
<span class="linenos">1566</span>
<span class="linenos">1567</span><span class="w">	</span><span class="p">}</span><span class="w"> </span><span class="k">while</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
<span class="linenos">1568</span>
<span class="linenos">1569</span><span class="w">	</span><span class="n">Print</span><span class="o">::</span><span class="n">printf</span><span class="p">(</span><span class="n">Print</span><span class="o">::</span><span class="n">DEBUG</span><span class="p">,</span><span class="s">&quot;[GPU Thread %d] leaving.&quot;</span><span class="p">,</span><span class="n">gpu</span><span class="p">);</span>
<span class="linenos">1570</span>
<span class="linenos">1571</span><span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="linenos">1572</span><span class="p">}</span>
<span class="linenos">1573</span>
<span class="linenos">1574</span><span class="kt">int</span><span class="w"> </span><span class="n">MGPUMpdRdmeSolver</span><span class="o">::</span><span class="n">hookSimulation</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="n">ByteLattice</span><span class="w"> </span><span class="o">*</span><span class="n">lattice</span><span class="p">)</span>
<span class="linenos">1575</span><span class="p">{</span>
<span class="linenos">1576</span><span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">1577</span><span class="p">}</span>
<span class="linenos">1578</span>
<span class="linenos">1579</span><span class="kt">void</span><span class="w"> </span><span class="n">MGPUMpdRdmeSolver</span><span class="o">::</span><span class="n">calculateXLaunchParameters</span><span class="p">(</span><span class="kt">dim3</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">gridSize</span><span class="p">,</span>
<span class="linenos">1580</span><span class="w">                                                   </span><span class="kt">dim3</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">threadBlockSize</span><span class="p">,</span>
<span class="linenos">1581</span><span class="w">												   </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">maxXBlockSize</span><span class="p">,</span>
<span class="linenos">1582</span><span class="w">												   </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeXSize</span><span class="p">,</span>
<span class="linenos">1583</span><span class="w">												   </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeYSize</span><span class="p">,</span>
<span class="linenos">1584</span><span class="w">												   </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeZSize</span><span class="p">)</span>
<span class="linenos">1585</span><span class="p">{</span>
<span class="linenos">1586</span><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">xBlockXSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">min</span><span class="p">(</span><span class="n">maxXBlockSize</span><span class="p">,</span><span class="w"> </span><span class="n">latticeXSize</span><span class="p">);</span>
<span class="linenos">1587</span><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">gridXSize</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">latticeXSize</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">xBlockXSize</span><span class="p">;</span>
<span class="linenos">1588</span><span class="w">	</span>
<span class="linenos">1589</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">gridXSize</span><span class="o">*</span><span class="n">xBlockXSize</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">latticeXSize</span><span class="p">)</span>
<span class="linenos">1590</span><span class="w">	</span><span class="p">{</span>
<span class="linenos">1591</span><span class="w">		</span><span class="c1">// Find the largest number of warps that is divisible</span>
<span class="linenos">1592</span><span class="w">		</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">tryx</span><span class="o">=</span><span class="mi">32</span><span class="p">;</span>
<span class="linenos">1593</span><span class="w">		</span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">tryx</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">maxXBlockSize</span><span class="p">)</span>
<span class="linenos">1594</span><span class="w">		</span><span class="p">{</span>
<span class="linenos">1595</span><span class="w">			</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">latticeXSize</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">tryx</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">1596</span><span class="w">				</span><span class="n">xBlockXSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tryx</span><span class="p">;</span>
<span class="linenos">1597</span><span class="w">			</span><span class="n">tryx</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">32</span><span class="p">;</span>
<span class="linenos">1598</span><span class="w">		</span><span class="p">}</span>
<span class="linenos">1599</span><span class="w">		</span><span class="n">gridXSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">latticeXSize</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">xBlockXSize</span><span class="p">;</span>
<span class="linenos">1600</span><span class="w">	</span><span class="p">}</span>
<span class="linenos">1601</span><span class="w">			</span>
<span class="linenos">1602</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">gridSize</span><span class="p">).</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gridXSize</span><span class="p">;</span>
<span class="linenos">1603</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">gridSize</span><span class="p">).</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">latticeYSize</span><span class="p">;</span>
<span class="linenos">1604</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">gridSize</span><span class="p">).</span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">latticeZSize</span><span class="p">;</span>
<span class="linenos">1605</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">threadBlockSize</span><span class="p">).</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">xBlockXSize</span><span class="p">;</span>
<span class="linenos">1606</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">threadBlockSize</span><span class="p">).</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="linenos">1607</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">threadBlockSize</span><span class="p">).</span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="linenos">1608</span><span class="p">}</span>
<span class="linenos">1609</span>
<span class="linenos">1610</span><span class="kt">void</span><span class="w"> </span><span class="n">MGPUMpdRdmeSolver</span><span class="o">::</span><span class="n">calculateYLaunchParameters</span><span class="p">(</span><span class="kt">dim3</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">gridSize</span><span class="p">,</span>
<span class="linenos">1611</span><span class="w">                                                   </span><span class="kt">dim3</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">threadBlockSize</span><span class="p">,</span>
<span class="linenos">1612</span><span class="w">												   </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">blockXSize</span><span class="p">,</span>
<span class="linenos">1613</span><span class="w">												   </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">blockYSize</span><span class="p">,</span>
<span class="linenos">1614</span><span class="w">												   </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeXSize</span><span class="p">,</span>
<span class="linenos">1615</span><span class="w">												   </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeYSize</span><span class="p">,</span>
<span class="linenos">1616</span><span class="w">												   </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeZSize</span><span class="p">)</span>
<span class="linenos">1617</span><span class="p">{</span>
<span class="linenos">1618</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">gridSize</span><span class="p">).</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">latticeXSize</span><span class="o">/</span><span class="n">blockXSize</span><span class="p">;</span>
<span class="linenos">1619</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">gridSize</span><span class="p">).</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">latticeYSize</span><span class="o">/</span><span class="n">blockYSize</span><span class="p">;</span>
<span class="linenos">1620</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">gridSize</span><span class="p">).</span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">latticeZSize</span><span class="p">;</span>
<span class="linenos">1621</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">threadBlockSize</span><span class="p">).</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blockXSize</span><span class="p">;</span>
<span class="linenos">1622</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">threadBlockSize</span><span class="p">).</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blockYSize</span><span class="p">;</span>
<span class="linenos">1623</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">threadBlockSize</span><span class="p">).</span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="linenos">1624</span><span class="p">}</span>
<span class="linenos">1625</span>
<span class="linenos">1626</span><span class="kt">void</span><span class="w"> </span><span class="n">MGPUMpdRdmeSolver</span><span class="o">::</span><span class="n">calculateZLaunchParameters</span><span class="p">(</span><span class="kt">dim3</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">gridSize</span><span class="p">,</span>
<span class="linenos">1627</span><span class="w">                                                   </span><span class="kt">dim3</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">threadBlockSize</span><span class="p">,</span>
<span class="linenos">1628</span><span class="w">												   </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">blockXSize</span><span class="p">,</span>
<span class="linenos">1629</span><span class="w">												   </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">blockZSize</span><span class="p">,</span>
<span class="linenos">1630</span><span class="w">												   </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeXSize</span><span class="p">,</span>
<span class="linenos">1631</span><span class="w">												   </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeYSize</span><span class="p">,</span>
<span class="linenos">1632</span><span class="w">												   </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeZSize</span><span class="p">)</span>
<span class="linenos">1633</span><span class="p">{</span>
<span class="linenos">1634</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">gridSize</span><span class="p">).</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">latticeXSize</span><span class="o">/</span><span class="n">blockXSize</span><span class="p">;</span>
<span class="linenos">1635</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">gridSize</span><span class="p">).</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">latticeYSize</span><span class="p">;</span>
<span class="linenos">1636</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">gridSize</span><span class="p">).</span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">latticeZSize</span><span class="o">/</span><span class="n">blockZSize</span><span class="p">;</span>
<span class="linenos">1637</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">threadBlockSize</span><span class="p">).</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blockXSize</span><span class="p">;</span>
<span class="linenos">1638</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">threadBlockSize</span><span class="p">).</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="linenos">1639</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">threadBlockSize</span><span class="p">).</span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blockZSize</span><span class="p">;</span>
<span class="linenos">1640</span><span class="p">}</span>
<span class="linenos">1641</span>
<span class="linenos">1642</span><span class="kt">void</span><span class="w"> </span><span class="n">MGPUMpdRdmeSolver</span><span class="o">::</span><span class="n">calculateReactionLaunchParameters</span><span class="p">(</span><span class="kt">dim3</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">gridSize</span><span class="p">,</span>
<span class="linenos">1643</span><span class="w">                                                          </span><span class="kt">dim3</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">threadBlockSize</span><span class="p">,</span>
<span class="linenos">1644</span><span class="w">														  </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">blockXSize</span><span class="p">,</span>
<span class="linenos">1645</span><span class="w">														  </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">blockYSize</span><span class="p">,</span>
<span class="linenos">1646</span><span class="w">														  </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeXSize</span><span class="p">,</span>
<span class="linenos">1647</span><span class="w">														  </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeYSize</span><span class="p">,</span>
<span class="linenos">1648</span><span class="w">														  </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeZSize</span><span class="p">)</span>
<span class="linenos">1649</span><span class="p">{</span>
<span class="linenos">1650</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">gridSize</span><span class="p">).</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">latticeXSize</span><span class="o">/</span><span class="n">blockXSize</span><span class="p">;</span>
<span class="linenos">1651</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">gridSize</span><span class="p">).</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">latticeYSize</span><span class="o">/</span><span class="n">blockYSize</span><span class="p">;</span>
<span class="linenos">1652</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">gridSize</span><span class="p">).</span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">latticeZSize</span><span class="p">;</span>
<span class="linenos">1653</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">threadBlockSize</span><span class="p">).</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blockXSize</span><span class="p">;</span>
<span class="linenos">1654</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">threadBlockSize</span><span class="p">).</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blockYSize</span><span class="p">;</span>
<span class="linenos">1655</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">threadBlockSize</span><span class="p">).</span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="linenos">1656</span><span class="p">}</span>
<span class="linenos">1657</span>
<span class="linenos">1658</span><span class="n">namespace</span><span class="w"> </span><span class="n">mgpumpdrdme_dev</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">1659</span><span class="cm">/**</span>
<span class="linenos">1660</span><span class="cm"> * Multiparticle diffusion performed by copying the lattice section to shared memory, making a choice for each lattice</span>
<span class="linenos">1661</span><span class="cm"> * site, storing the new lattice into shared memory, and then updating the global lattice.</span>
<span class="linenos">1662</span><span class="cm"> */</span>
<span class="linenos">1663</span><span class="kr">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">MGPU_x_kernel</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">inLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">inSites</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">outLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">z_start</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">)</span>
<span class="linenos">1664</span><span class="p">{</span>
<span class="linenos">1665</span><span class="w">	</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nb">blockDim</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
<span class="linenos">1666</span><span class="w">	</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nb">blockDim</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
<span class="linenos">1667</span><span class="w">	</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">z</span><span class="o">+</span><span class="n">z_start</span><span class="p">;</span>
<span class="linenos">1668</span><span class="w">	</span>
<span class="linenos">1669</span><span class="w">    </span><span class="c1">// Figure out the offset of this thread in the lattice and the lattice segment.</span>
<span class="linenos">1670</span><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeXIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="p">;</span>
<span class="linenos">1671</span><span class="w">	</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">local_index</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">z</span><span class="p">);</span>
<span class="linenos">1672</span><span class="w">	</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">globalIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">local_to_global</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">z</span><span class="p">);</span><span class="w"> </span><span class="c1">// Use the global lattice index for RNG</span>
<span class="linenos">1673</span><span class="w">	</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">windowIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="o">+</span><span class="n">MPD_APRON_SIZE</span><span class="p">;</span>
<span class="linenos">1674</span>
<span class="linenos">1675</span><span class="w">    </span><span class="c1">///////////////////////////////////////////</span>
<span class="linenos">1676</span><span class="w">    </span><span class="c1">// Load the lattice into shared memory. //</span>
<span class="linenos">1677</span><span class="w">    </span><span class="c1">///////////////////////////////////////////</span>
<span class="linenos">1678</span>
<span class="linenos">1679</span><span class="w">    </span><span class="c1">// Shared memory to store the lattice segment.</span>
<span class="linenos">1680</span><span class="w">    </span><span class="kt">__shared__</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">window</span><span class="p">[</span><span class="n">MPD_X_WINDOW_SIZE</span><span class="o">*</span><span class="n">MPD_WORDS_PER_SITE</span><span class="p">];</span>
<span class="linenos">1681</span><span class="w">    </span><span class="kt">__shared__</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">sitesWindow</span><span class="p">[</span><span class="n">MPD_X_WINDOW_SIZE</span><span class="p">];</span>
<span class="linenos">1682</span>
<span class="linenos">1683</span><span class="w">    </span><span class="c1">// Copy the x window from device memory into shared memory.</span>
<span class="linenos">1684</span><span class="w">    </span><span class="n">copyXWindowFromLattice</span><span class="p">(</span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">inLattice</span><span class="p">,</span><span class="w"> </span><span class="n">window</span><span class="p">,</span><span class="w"> </span><span class="n">latticeIndex</span><span class="p">,</span><span class="w"> </span><span class="n">latticeXIndex</span><span class="p">,</span><span class="w"> </span><span class="n">windowIndex</span><span class="p">);</span>
<span class="linenos">1685</span><span class="w">    </span><span class="n">copyXWindowFromSites</span><span class="p">(</span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">inSites</span><span class="p">,</span><span class="w"> </span><span class="n">sitesWindow</span><span class="p">,</span><span class="w"> </span><span class="n">latticeIndex</span><span class="p">,</span><span class="w"> </span><span class="n">latticeXIndex</span><span class="p">,</span><span class="w"> </span><span class="n">windowIndex</span><span class="p">);</span>
<span class="linenos">1686</span><span class="w">    </span><span class="nf">__syncthreads</span><span class="p">();</span>
<span class="linenos">1687</span>
<span class="linenos">1688</span><span class="w">    </span><span class="c1">////////////////////////////////////////</span>
<span class="linenos">1689</span><span class="w">    </span><span class="c1">// Make the choice for each particle. //</span>
<span class="linenos">1690</span><span class="w">    </span><span class="c1">////////////////////////////////////////</span>
<span class="linenos">1691</span>
<span class="linenos">1692</span><span class="w">    </span><span class="kt">__shared__</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">choices</span><span class="p">[</span><span class="n">MPD_X_WINDOW_SIZE</span><span class="o">*</span><span class="n">MPD_WORDS_PER_SITE</span><span class="p">];</span>
<span class="linenos">1693</span>
<span class="linenos">1694</span><span class="w">    </span><span class="c1">// Make the choices.</span>
<span class="linenos">1695</span><span class="w">    </span><span class="n">makeXDiffusionChoices</span><span class="p">(</span><span class="n">window</span><span class="p">,</span><span class="w"> </span><span class="n">sitesWindow</span><span class="p">,</span><span class="w"> </span><span class="n">choices</span><span class="p">,</span><span class="w"> </span><span class="n">globalIndex</span><span class="p">,</span><span class="w"> </span><span class="n">latticeXIndex</span><span class="p">,</span><span class="w"> </span><span class="n">windowIndex</span><span class="p">,</span><span class="w"> </span><span class="nb">blockDim</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">);</span>
<span class="linenos">1696</span><span class="w">	</span><span class="nf">__syncthreads</span><span class="p">();</span>
<span class="linenos">1697</span>
<span class="linenos">1698</span><span class="w">    </span><span class="c1">//////////////////////////////////////////////////////////</span>
<span class="linenos">1699</span><span class="w">    </span><span class="c1">// Create version of the lattice at the next time step. //</span>
<span class="linenos">1700</span><span class="w">    </span><span class="c1">//////////////////////////////////////////////////////////</span>
<span class="linenos">1701</span>
<span class="linenos">1702</span><span class="w">    </span><span class="c1">// Propagate the choices to the new lattice segment.</span>
<span class="linenos">1703</span><span class="w">    </span><span class="n">performPropagation</span><span class="p">(</span><span class="n">outLattice</span><span class="p">,</span><span class="w"> </span><span class="n">window</span><span class="p">,</span><span class="w"> </span><span class="n">choices</span><span class="p">,</span><span class="w"> </span><span class="n">latticeIndex</span><span class="p">,</span><span class="w"> </span><span class="n">windowIndex</span><span class="mi">-1</span><span class="p">,</span><span class="w"> </span><span class="n">windowIndex</span><span class="p">,</span><span class="w"> </span><span class="n">windowIndex</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">MPD_X_WINDOW_SIZE</span><span class="p">,</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">);</span>
<span class="linenos">1704</span><span class="p">}</span>
<span class="linenos">1705</span>
<span class="linenos">1706</span>
<span class="linenos">1707</span><span class="cm">/**</span>
<span class="linenos">1708</span><span class="cm"> * Multiparticle diffusion performed by copying the lattice section to shared memory, making a choice for each lattice</span>
<span class="linenos">1709</span><span class="cm"> * site, storing the new lattice into shared memory, and then updating the global lattice.</span>
<span class="linenos">1710</span><span class="cm"> */</span>
<span class="linenos">1711</span><span class="kr">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">MGPU_y_kernel</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">inLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">inSites</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">outLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">)</span>
<span class="linenos">1712</span><span class="p">{</span>
<span class="linenos">1713</span>
<span class="linenos">1714</span><span class="w">	</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nb">blockDim</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
<span class="linenos">1715</span><span class="w">	</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nb">blockDim</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
<span class="linenos">1716</span><span class="w">	</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">z</span><span class="p">;</span>
<span class="linenos">1717</span>
<span class="linenos">1718</span><span class="w">    </span><span class="c1">// Figure out the offset of this thread in the lattice and the lattice segment.</span>
<span class="linenos">1719</span><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeYIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">y</span><span class="o">*</span><span class="nb">blockDim</span><span class="p">.</span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
<span class="linenos">1720</span><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">windowYIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">y</span><span class="o">+</span><span class="n">MPD_APRON_SIZE</span><span class="p">;</span>
<span class="linenos">1721</span><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">windowIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">windowYIndex</span><span class="o">*</span><span class="nb">blockDim</span><span class="p">.</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
<span class="linenos">1722</span>
<span class="linenos">1723</span><span class="w">	</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">local_index</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">z</span><span class="p">);</span>
<span class="linenos">1724</span><span class="w">	</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">globalIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">local_to_global</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">z</span><span class="p">);</span><span class="w"> </span><span class="c1">// Use the global lattice index for RNG</span>
<span class="linenos">1725</span>
<span class="linenos">1726</span><span class="w">    </span><span class="c1">///////////////////////////////////////////</span>
<span class="linenos">1727</span><span class="w">    </span><span class="c1">// Load the lattice into shared memory. //</span>
<span class="linenos">1728</span><span class="w">    </span><span class="c1">///////////////////////////////////////////</span>
<span class="linenos">1729</span>
<span class="linenos">1730</span><span class="w">    </span><span class="c1">// Shared memory to store the lattice segment. Each lattice site has four particles, eight bits for each particle.</span>
<span class="linenos">1731</span><span class="w">    </span><span class="kt">__shared__</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">window</span><span class="p">[</span><span class="n">MPD_Y_WINDOW_SIZE</span><span class="o">*</span><span class="n">MPD_WORDS_PER_SITE</span><span class="p">];</span>
<span class="linenos">1732</span><span class="w">    </span><span class="kt">__shared__</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">sitesWindow</span><span class="p">[</span><span class="n">MPD_Y_WINDOW_SIZE</span><span class="p">];</span>
<span class="linenos">1733</span>
<span class="linenos">1734</span><span class="w">    </span><span class="c1">// Copy the x window from device memory into shared memory.</span>
<span class="linenos">1735</span><span class="w">    </span><span class="n">copyYWindowFromLattice</span><span class="p">(</span><span class="n">inLattice</span><span class="p">,</span><span class="w"> </span><span class="n">window</span><span class="p">,</span><span class="w"> </span><span class="n">latticeIndex</span><span class="p">,</span><span class="w"> </span><span class="n">latticeYIndex</span><span class="p">,</span><span class="w"> </span><span class="n">windowIndex</span><span class="p">,</span><span class="w"> </span><span class="n">windowYIndex</span><span class="p">);</span>
<span class="linenos">1736</span><span class="w">    </span><span class="n">copyYWindowFromSites</span><span class="p">(</span><span class="n">inSites</span><span class="p">,</span><span class="w"> </span><span class="n">sitesWindow</span><span class="p">,</span><span class="w"> </span><span class="n">latticeIndex</span><span class="p">,</span><span class="w"> </span><span class="n">latticeYIndex</span><span class="p">,</span><span class="w"> </span><span class="n">windowIndex</span><span class="p">,</span><span class="w"> </span><span class="n">windowYIndex</span><span class="p">);</span>
<span class="linenos">1737</span><span class="w">    </span><span class="nf">__syncthreads</span><span class="p">();</span>
<span class="linenos">1738</span>
<span class="linenos">1739</span><span class="w">    </span><span class="c1">////////////////////////////////////////</span>
<span class="linenos">1740</span><span class="w">    </span><span class="c1">// Make the choice for each particle. //</span>
<span class="linenos">1741</span><span class="w">    </span><span class="c1">////////////////////////////////////////</span>
<span class="linenos">1742</span>
<span class="linenos">1743</span><span class="w">    </span><span class="kt">__shared__</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">choices</span><span class="p">[</span><span class="n">MPD_Y_WINDOW_SIZE</span><span class="o">*</span><span class="n">MPD_WORDS_PER_SITE</span><span class="p">];</span>
<span class="linenos">1744</span>
<span class="linenos">1745</span><span class="w">    </span><span class="c1">// Make the choices.</span>
<span class="linenos">1746</span><span class="w">    </span><span class="n">makeYDiffusionChoices</span><span class="p">(</span><span class="n">window</span><span class="p">,</span><span class="w"> </span><span class="n">sitesWindow</span><span class="p">,</span><span class="w"> </span><span class="n">choices</span><span class="p">,</span><span class="w"> </span><span class="n">globalIndex</span><span class="p">,</span><span class="w"> </span><span class="n">latticeYIndex</span><span class="p">,</span><span class="w"> </span><span class="n">windowIndex</span><span class="p">,</span><span class="w"> </span><span class="n">windowYIndex</span><span class="p">,</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">);</span>
<span class="linenos">1747</span><span class="w">	</span><span class="nf">__syncthreads</span><span class="p">();</span>
<span class="linenos">1748</span>
<span class="linenos">1749</span><span class="w">    </span><span class="c1">//////////////////////////////////////////////////////////</span>
<span class="linenos">1750</span><span class="w">    </span><span class="c1">// Create version of the lattice at the next time step. //</span>
<span class="linenos">1751</span><span class="w">    </span><span class="c1">//////////////////////////////////////////////////////////</span>
<span class="linenos">1752</span>
<span class="linenos">1753</span><span class="w">    </span><span class="c1">// Progate the choices to the new lattice segment.</span>
<span class="linenos">1754</span><span class="w">    </span><span class="n">performPropagation</span><span class="p">(</span><span class="n">outLattice</span><span class="p">,</span><span class="w"> </span><span class="n">window</span><span class="p">,</span><span class="w"> </span><span class="n">choices</span><span class="p">,</span><span class="w"> </span><span class="n">latticeIndex</span><span class="p">,</span><span class="w"> </span><span class="n">windowIndex</span><span class="o">-</span><span class="n">TUNE_MPD_Y_BLOCK_X_SIZE</span><span class="p">,</span><span class="w"> </span><span class="n">windowIndex</span><span class="p">,</span><span class="w"> </span><span class="n">windowIndex</span><span class="o">+</span><span class="n">TUNE_MPD_Y_BLOCK_X_SIZE</span><span class="p">,</span><span class="w"> </span><span class="n">MPD_Y_WINDOW_SIZE</span><span class="p">,</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">);</span>
<span class="linenos">1755</span><span class="p">}</span>
<span class="linenos">1756</span>
<span class="linenos">1757</span><span class="cm">/**</span>
<span class="linenos">1758</span><span class="cm"> * Multiparticle diffusion performed by copying the lattice section to shared memory, making a choice for each lattice</span>
<span class="linenos">1759</span><span class="cm"> * site, storing the new lattice into shared memory, and then updating the global lattice.</span>
<span class="linenos">1760</span><span class="cm"> */</span>
<span class="linenos">1761</span><span class="kr">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">MGPU_z_kernel</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">inLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">inSites</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">outLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">z_start</span><span class="p">)</span>
<span class="linenos">1762</span><span class="p">{</span>
<span class="linenos">1763</span><span class="w">	</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nb">blockDim</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
<span class="linenos">1764</span><span class="w">	</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
<span class="linenos">1765</span><span class="w">	</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nb">blockDim</span><span class="p">.</span><span class="n">z</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">z</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">z_start</span><span class="p">;</span>
<span class="linenos">1766</span>
<span class="linenos">1767</span><span class="w">    </span><span class="c1">// Figure out the offset of this thread in the lattice and the lattice segment.</span>
<span class="linenos">1768</span><span class="w">	</span><span class="kt">int</span><span class="w"> </span><span class="n">global_z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">z</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">goffsetZC</span><span class="p">;</span>
<span class="linenos">1769</span><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">windowZIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">z</span><span class="o">+</span><span class="n">MPD_APRON_SIZE</span><span class="p">;</span>
<span class="linenos">1770</span><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">windowIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">windowZIndex</span><span class="o">*</span><span class="nb">blockDim</span><span class="p">.</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
<span class="linenos">1771</span>
<span class="linenos">1772</span><span class="w">	</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">local_index</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">z</span><span class="p">);</span>
<span class="linenos">1773</span><span class="w">	</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">globalIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">local_to_global</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">z</span><span class="p">);</span><span class="w"> </span><span class="c1">// Use the global lattice index for RNG</span>
<span class="linenos">1774</span>
<span class="linenos">1775</span><span class="w">    </span><span class="c1">///////////////////////////////////////////</span>
<span class="linenos">1776</span><span class="w">    </span><span class="c1">// Load the lattice into shared memory. //</span>
<span class="linenos">1777</span><span class="w">    </span><span class="c1">///////////////////////////////////////////</span>
<span class="linenos">1778</span>
<span class="linenos">1779</span><span class="w">    </span><span class="c1">// Shared memory to store the lattice segment. Each lattice site has four particles, eight bits for each particle.</span>
<span class="linenos">1780</span><span class="w">    </span><span class="kt">__shared__</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">window</span><span class="p">[</span><span class="n">MPD_Z_WINDOW_SIZE</span><span class="o">*</span><span class="n">MPD_WORDS_PER_SITE</span><span class="p">];</span>
<span class="linenos">1781</span><span class="w">    </span><span class="kt">__shared__</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">sitesWindow</span><span class="p">[</span><span class="n">MPD_Z_WINDOW_SIZE</span><span class="p">];</span>
<span class="linenos">1782</span>
<span class="linenos">1783</span><span class="w">    </span><span class="c1">// Copy the x window from device memory into shared memory.</span>
<span class="linenos">1784</span><span class="w">    </span><span class="n">copyZWindowFromLattice_MGPU</span><span class="p">(</span><span class="n">inLattice</span><span class="p">,</span><span class="w"> </span><span class="n">window</span><span class="p">,</span><span class="w"> </span><span class="n">latticeIndex</span><span class="p">,</span><span class="w"> </span><span class="n">global_z</span><span class="p">,</span><span class="w"> </span><span class="n">windowIndex</span><span class="p">,</span><span class="w"> </span><span class="n">windowZIndex</span><span class="p">);</span>
<span class="linenos">1785</span><span class="w">    </span><span class="n">copyZWindowFromSites_MGPU</span><span class="p">(</span><span class="n">inSites</span><span class="p">,</span><span class="w"> </span><span class="n">sitesWindow</span><span class="p">,</span><span class="w"> </span><span class="n">latticeIndex</span><span class="p">,</span><span class="w"> </span><span class="n">global_z</span><span class="p">,</span><span class="w"> </span><span class="n">windowIndex</span><span class="p">,</span><span class="w"> </span><span class="n">windowZIndex</span><span class="p">);</span>
<span class="linenos">1786</span><span class="w">    </span><span class="nf">__syncthreads</span><span class="p">();</span>
<span class="linenos">1787</span>
<span class="linenos">1788</span><span class="w">    </span><span class="c1">////////////////////////////////////////</span>
<span class="linenos">1789</span><span class="w">    </span><span class="c1">// Make the choice for each particle. //</span>
<span class="linenos">1790</span><span class="w">    </span><span class="c1">////////////////////////////////////////</span>
<span class="linenos">1791</span>
<span class="linenos">1792</span><span class="w">    </span><span class="kt">__shared__</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">choices</span><span class="p">[</span><span class="n">MPD_Z_WINDOW_SIZE</span><span class="o">*</span><span class="n">MPD_WORDS_PER_SITE</span><span class="p">];</span>
<span class="linenos">1793</span>
<span class="linenos">1794</span><span class="w">    </span><span class="c1">// Make the choices.</span>
<span class="linenos">1795</span><span class="w">    </span><span class="n">makeZDiffusionChoices</span><span class="p">(</span><span class="n">window</span><span class="p">,</span><span class="w"> </span><span class="n">sitesWindow</span><span class="p">,</span><span class="w"> </span><span class="n">choices</span><span class="p">,</span><span class="w"> </span><span class="n">globalIndex</span><span class="p">,</span><span class="w"> </span><span class="n">global_z</span><span class="p">,</span><span class="w"> </span><span class="n">windowIndex</span><span class="p">,</span><span class="w"> </span><span class="n">windowZIndex</span><span class="p">,</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">);</span>
<span class="linenos">1796</span><span class="w">	</span><span class="nf">__syncthreads</span><span class="p">();</span>
<span class="linenos">1797</span>
<span class="linenos">1798</span><span class="w">    </span><span class="c1">//////////////////////////////////////////////////////////</span>
<span class="linenos">1799</span><span class="w">    </span><span class="c1">// Create version of the lattice at the next time step. //</span>
<span class="linenos">1800</span><span class="w">    </span><span class="c1">//////////////////////////////////////////////////////////</span>
<span class="linenos">1801</span>
<span class="linenos">1802</span><span class="w">    </span><span class="c1">// Progate the choices to the new lattice segment.</span>
<span class="linenos">1803</span><span class="w">    </span><span class="n">performPropagation</span><span class="p">(</span><span class="n">outLattice</span><span class="p">,</span><span class="w"> </span><span class="n">window</span><span class="p">,</span><span class="w"> </span><span class="n">choices</span><span class="p">,</span><span class="w"> </span><span class="n">latticeIndex</span><span class="p">,</span><span class="w"> </span><span class="n">windowIndex</span><span class="o">-</span><span class="n">TUNE_MPD_Z_BLOCK_X_SIZE</span><span class="p">,</span><span class="w"> </span><span class="n">windowIndex</span><span class="p">,</span><span class="w"> </span><span class="n">windowIndex</span><span class="o">+</span><span class="n">TUNE_MPD_Z_BLOCK_X_SIZE</span><span class="p">,</span><span class="w"> </span><span class="n">MPD_Z_WINDOW_SIZE</span><span class="p">,</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">);</span>
<span class="linenos">1804</span><span class="p">}</span>
<span class="linenos">1805</span>
<span class="linenos">1806</span><span class="cm">/**</span>
<span class="linenos">1807</span><span class="cm"> * Multiparticle diffusion performed by copying the lattice section to shared memory, making a choice for each lattice</span>
<span class="linenos">1808</span><span class="cm"> * site, storing the new lattice into shared memory, and then updating the global lattice.</span>
<span class="linenos">1809</span><span class="cm"> */</span>
<span class="linenos">1810</span><span class="cp">#ifdef MPD_GLOBAL_S_MATRIX</span>
<span class="linenos">1811</span><span class="cp">#ifdef MPD_GLOBAL_R_MATRIX</span>
<span class="linenos">1812</span><span class="kr">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">MGPU_reaction_kernel</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">inLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">inSites</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">outLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">z_start</span><span class="p">,</span><span class="w">   </span><span class="k">const</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="kt">int8_t</span><span class="w"> </span><span class="o">*</span><span class="n">SG</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="n">RLG</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="n">reactionOrdersG</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="n">reactionSitesG</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="n">D1G</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="n">D2G</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="n">reactionRatesG</span><span class="p">)</span>
<span class="linenos">1813</span><span class="cp">#else</span>
<span class="linenos">1814</span><span class="kr">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">MGPU_reaction_kernel</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">inLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">inSites</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">outLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">z_start</span><span class="p">,</span><span class="w">   </span><span class="k">const</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="kt">int8_t</span><span class="w"> </span><span class="o">*</span><span class="n">SG</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="n">RLG</span><span class="p">)</span>
<span class="linenos">1815</span><span class="cp">#endif</span>
<span class="linenos">1816</span><span class="cp">#else</span>
<span class="linenos">1817</span><span class="kr">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">MGPU_reaction_kernel</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">inLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">inSites</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">outLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">z_start</span><span class="p">)</span>
<span class="linenos">1818</span><span class="cp">#endif</span>
<span class="linenos">1819</span><span class="p">{</span>
<span class="linenos">1820</span><span class="w">	</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">blockDim</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
<span class="linenos">1821</span><span class="w">	</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">blockDim</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
<span class="linenos">1822</span><span class="w">	</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">z</span><span class="o">+</span><span class="n">z_start</span><span class="p">;</span>
<span class="linenos">1823</span>
<span class="linenos">1824</span><span class="w">    </span><span class="c1">// Figure out the offset of this thread in the lattice and the lattice segment.</span>
<span class="linenos">1825</span><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">local_index</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">z</span><span class="p">);</span>
<span class="linenos">1826</span><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">globalIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">local_to_global</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">z</span><span class="p">);</span><span class="w"> </span><span class="c1">// Use the global lattice index for RNG</span>
<span class="linenos">1827</span>
<span class="linenos">1828</span><span class="w">    </span><span class="c1">///////////////////////////////////////////</span>
<span class="linenos">1829</span><span class="w">    </span><span class="c1">// Load the particles and site.          //</span>
<span class="linenos">1830</span><span class="w">    </span><span class="c1">///////////////////////////////////////////</span>
<span class="linenos">1831</span>
<span class="linenos">1832</span><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">particles</span><span class="p">[</span><span class="n">MPD_WORDS_PER_SITE</span><span class="p">];</span>
<span class="linenos">1833</span><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">w</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">latticeOffset</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">w</span><span class="o">&lt;</span><span class="n">MPD_WORDS_PER_SITE</span><span class="p">;</span><span class="w"> </span><span class="n">w</span><span class="o">++</span><span class="p">,</span><span class="w"> </span><span class="n">latticeOffset</span><span class="o">+=</span><span class="n">latticeXYZSizeC</span><span class="p">)</span>
<span class="linenos">1834</span><span class="w">        </span><span class="n">particles</span><span class="p">[</span><span class="n">w</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inLattice</span><span class="p">[</span><span class="n">latticeIndex</span><span class="o">+</span><span class="n">latticeOffset</span><span class="p">];</span>
<span class="linenos">1835</span><span class="w">    </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">siteType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inSites</span><span class="p">[</span><span class="n">latticeIndex</span><span class="p">];</span>
<span class="linenos">1836</span>
<span class="linenos">1837</span><span class="w">    </span><span class="c1">////////////////////////////////////////</span>
<span class="linenos">1838</span><span class="w">    </span><span class="c1">// Perform the reactions.             //</span>
<span class="linenos">1839</span><span class="w">    </span><span class="c1">////////////////////////////////////////</span>
<span class="linenos">1840</span>
<span class="linenos">1841</span><span class="w">    </span><span class="c1">// Calculate the kinetic rate for each reaction at this site.</span>
<span class="linenos">1842</span><span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">totalReactionPropensity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">;</span>
<span class="linenos">1843</span><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">numberReactionsC</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">1844</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">1845</span><span class="cp">#ifdef MPD_GLOBAL_S_MATRIX</span>
<span class="linenos">1846</span><span class="cp">#ifdef MPD_GLOBAL_R_MATRIX</span>
<span class="linenos">1847</span><span class="w">        </span><span class="n">totalReactionPropensity</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">calculateReactionPropensity</span><span class="p">(</span><span class="n">siteType</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="o">*</span><span class="p">)</span><span class="n">particles</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">RLG</span><span class="p">,</span><span class="w"> </span><span class="n">reactionOrdersG</span><span class="p">,</span><span class="w"> </span><span class="n">reactionSitesG</span><span class="p">,</span><span class="w"> </span><span class="n">D1G</span><span class="p">,</span><span class="w"> </span><span class="n">D2G</span><span class="p">,</span><span class="w"> </span><span class="n">reactionRatesG</span><span class="p">);</span>
<span class="linenos">1848</span><span class="cp">#else</span>
<span class="linenos">1849</span><span class="w">        </span><span class="n">totalReactionPropensity</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">calculateReactionPropensity</span><span class="p">(</span><span class="n">siteType</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="o">*</span><span class="p">)</span><span class="n">particles</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">RLG</span><span class="p">);</span>
<span class="linenos">1850</span><span class="cp">#endif</span>
<span class="linenos">1851</span><span class="cp">#else</span>
<span class="linenos">1852</span><span class="w">        </span><span class="n">totalReactionPropensity</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">calculateReactionPropensity</span><span class="p">(</span><span class="n">siteType</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="o">*</span><span class="p">)</span><span class="n">particles</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">);</span>
<span class="linenos">1853</span><span class="cp">#endif</span>
<span class="linenos">1854</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">1855</span>
<span class="linenos">1856</span>
<span class="linenos">1857</span><span class="w">    </span><span class="c1">// See if a reaction occurred at the site.</span>
<span class="linenos">1858</span><span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">reactionProbability</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">calculateReactionProbability</span><span class="p">(</span><span class="n">totalReactionPropensity</span><span class="p">);</span>
<span class="linenos">1859</span><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">reactionOccurred</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">checkForReaction</span><span class="p">(</span><span class="n">globalIndex</span><span class="p">,</span><span class="w"> </span><span class="n">reactionProbability</span><span class="p">,</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">);</span>
<span class="linenos">1860</span>
<span class="linenos">1861</span><span class="w">    </span><span class="c1">// If there was a reaction, process it.</span>
<span class="linenos">1862</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">reactionOccurred</span><span class="p">)</span>
<span class="linenos">1863</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">1864</span><span class="w">        </span><span class="c1">// Figure out which reaction occurred.</span>
<span class="linenos">1865</span><span class="cp">#ifdef MPD_GLOBAL_S_MATRIX</span>
<span class="linenos">1866</span><span class="cp">#ifdef MPD_GLOBAL_R_MATRIX</span>
<span class="linenos">1867</span><span class="w">        </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">reactionIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">determineReactionIndex</span><span class="p">(</span><span class="n">siteType</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="o">*</span><span class="p">)</span><span class="n">particles</span><span class="p">,</span><span class="w"> </span><span class="n">globalIndex</span><span class="p">,</span><span class="w"> </span><span class="n">totalReactionPropensity</span><span class="p">,</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">,</span><span class="w"> </span><span class="n">RLG</span><span class="p">,</span><span class="w"> </span><span class="n">reactionOrdersG</span><span class="p">,</span><span class="w"> </span><span class="n">reactionSitesG</span><span class="p">,</span><span class="w"> </span><span class="n">D1G</span><span class="p">,</span><span class="w"> </span><span class="n">D2G</span><span class="p">,</span><span class="w"> </span><span class="n">reactionRatesG</span><span class="p">);</span>
<span class="linenos">1868</span><span class="cp">#else</span>
<span class="linenos">1869</span><span class="w">        </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">reactionIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">determineReactionIndex</span><span class="p">(</span><span class="n">siteType</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="o">*</span><span class="p">)</span><span class="n">particles</span><span class="p">,</span><span class="w"> </span><span class="n">globalIndex</span><span class="p">,</span><span class="w"> </span><span class="n">totalReactionPropensity</span><span class="p">,</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">,</span><span class="w"> </span><span class="n">RLG</span><span class="p">);</span>
<span class="linenos">1870</span><span class="cp">#endif</span>
<span class="linenos">1871</span><span class="cp">#else</span>
<span class="linenos">1872</span><span class="w">        </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">reactionIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">determineReactionIndex</span><span class="p">(</span><span class="n">siteType</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="o">*</span><span class="p">)</span><span class="n">particles</span><span class="p">,</span><span class="w"> </span><span class="n">globalIndex</span><span class="p">,</span><span class="w"> </span><span class="n">totalReactionPropensity</span><span class="p">,</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">);</span>
<span class="linenos">1873</span><span class="cp">#endif</span>
<span class="linenos">1874</span>
<span class="linenos">1875</span><span class="w">        </span><span class="c1">// Construct the new site.</span>
<span class="linenos">1876</span><span class="cp">#ifdef MPD_GLOBAL_S_MATRIX</span>
<span class="linenos">1877</span><span class="w">        </span><span class="n">evaluateReaction</span><span class="p">(</span><span class="n">latticeIndex</span><span class="p">,</span><span class="w"> </span><span class="n">siteType</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="o">*</span><span class="p">)</span><span class="n">particles</span><span class="p">,</span><span class="w"> </span><span class="n">reactionIndex</span><span class="p">,</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">,</span><span class="w"> </span><span class="n">SG</span><span class="p">);</span>
<span class="linenos">1878</span><span class="cp">#else</span>
<span class="linenos">1879</span><span class="w">        </span><span class="n">evaluateReaction</span><span class="p">(</span><span class="n">latticeIndex</span><span class="p">,</span><span class="w"> </span><span class="n">siteType</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="o">*</span><span class="p">)</span><span class="n">particles</span><span class="p">,</span><span class="w"> </span><span class="n">reactionIndex</span><span class="p">,</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">);</span>
<span class="linenos">1880</span><span class="cp">#endif</span>
<span class="linenos">1881</span>
<span class="linenos">1882</span><span class="w">        </span><span class="c1">// Copy the new particles back into the lattice.</span>
<span class="linenos">1883</span><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">w</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">latticeOffset</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">w</span><span class="o">&lt;</span><span class="n">MPD_WORDS_PER_SITE</span><span class="p">;</span><span class="w"> </span><span class="n">w</span><span class="o">++</span><span class="p">,</span><span class="w"> </span><span class="n">latticeOffset</span><span class="o">+=</span><span class="n">latticeXYZSizeC</span><span class="p">)</span>
<span class="linenos">1884</span><span class="w">             </span><span class="n">outLattice</span><span class="p">[</span><span class="n">latticeIndex</span><span class="o">+</span><span class="n">latticeOffset</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">particles</span><span class="p">[</span><span class="n">w</span><span class="p">];</span>
<span class="linenos">1885</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">1886</span><span class="p">}</span>
<span class="linenos">1887</span>
<span class="linenos">1888</span><span class="cp">#ifdef MPD_GLOBAL_S_MATRIX</span>
<span class="linenos">1889</span><span class="cp">#ifdef MPD_GLOBAL_R_MATRIX</span>
<span class="linenos">1890</span><span class="kr">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">__launch_bounds__</span><span class="p">(</span><span class="n">TUNE_MPD_REACTION_BLOCK_X_SIZE</span><span class="o">*</span><span class="n">TUNE_MPD_REACTION_BLOCK_Y_SIZE</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="n">MGPU_precomp_reaction_kernel</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">inLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">inSites</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">outLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">z_start</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="kt">int8_t</span><span class="w"> </span><span class="o">*</span><span class="n">SG</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="n">RLG</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="n">reactionOrdersG</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="n">reactionSitesG</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="n">D1G</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="n">D2G</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="n">reactionRatesG</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="n">qp0</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="n">qp1</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="n">qp2</span><span class="p">)</span>
<span class="linenos">1891</span><span class="cp">#else</span>
<span class="linenos">1892</span><span class="kr">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">__launch_bounds__</span><span class="p">(</span><span class="n">TUNE_MPD_REACTION_BLOCK_X_SIZE</span><span class="o">*</span><span class="n">TUNE_MPD_REACTION_BLOCK_Y_SIZE</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="n">MGPU_precomp_reaction_kernel</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">inLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">inSites</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">outLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">z_start</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="kt">int8_t</span><span class="w"> </span><span class="o">*</span><span class="n">SG</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="n">RLG</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="n">qp0</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="n">qp1</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="n">qp2</span><span class="p">)</span>
<span class="linenos">1893</span><span class="cp">#endif</span>
<span class="linenos">1894</span><span class="cp">#else</span>
<span class="linenos">1895</span><span class="kr">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">__launch_bounds__</span><span class="p">(</span><span class="n">TUNE_MPD_REACTION_BLOCK_X_SIZE</span><span class="o">*</span><span class="n">TUNE_MPD_REACTION_BLOCK_Y_SIZE</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="n">MGPU_precomp_reaction_kernel</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">inLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">inSites</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">outLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">z_start</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="n">qp0</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="n">qp1</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="n">qp2</span><span class="p">)</span>
<span class="linenos">1896</span><span class="cp">#endif</span>
<span class="linenos">1897</span><span class="p">{</span>
<span class="linenos">1898</span><span class="w">	</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">blockDim</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
<span class="linenos">1899</span><span class="w">	</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">blockDim</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
<span class="linenos">1900</span><span class="w">	</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">z</span><span class="o">+</span><span class="n">z_start</span><span class="p">;</span>
<span class="linenos">1901</span>
<span class="linenos">1902</span><span class="w">    </span><span class="c1">// Figure out the offset of this thread in the lattice and the lattice segment.</span>
<span class="linenos">1903</span><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">local_index</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">z</span><span class="p">);</span>
<span class="linenos">1904</span><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">globalIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">local_to_global</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">z</span><span class="p">);</span><span class="w"> </span><span class="c1">// Use the global lattice index for RNG</span>
<span class="linenos">1905</span>
<span class="linenos">1906</span><span class="w">    </span><span class="c1">///////////////////////////////////////////</span>
<span class="linenos">1907</span><span class="w">    </span><span class="c1">// Load the particles and site.          //</span>
<span class="linenos">1908</span><span class="w">    </span><span class="c1">///////////////////////////////////////////</span>
<span class="linenos">1909</span>
<span class="linenos">1910</span><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">particles</span><span class="p">[</span><span class="n">MPD_WORDS_PER_SITE</span><span class="p">];</span>
<span class="linenos">1911</span><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">w</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">latticeOffset</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">w</span><span class="o">&lt;</span><span class="n">MPD_WORDS_PER_SITE</span><span class="p">;</span><span class="w"> </span><span class="n">w</span><span class="o">++</span><span class="p">,</span><span class="w"> </span><span class="n">latticeOffset</span><span class="o">+=</span><span class="n">latticeXYZSizeC</span><span class="p">)</span>
<span class="linenos">1912</span><span class="w">        </span><span class="n">particles</span><span class="p">[</span><span class="n">w</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inLattice</span><span class="p">[</span><span class="n">latticeIndex</span><span class="o">+</span><span class="n">latticeOffset</span><span class="p">];</span>
<span class="linenos">1913</span><span class="w">    </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">siteType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inSites</span><span class="p">[</span><span class="n">latticeIndex</span><span class="p">];</span>
<span class="linenos">1914</span>
<span class="linenos">1915</span><span class="w">    </span><span class="c1">////////////////////////////////////////</span>
<span class="linenos">1916</span><span class="w">    </span><span class="c1">// Perform the reactions.             //</span>
<span class="linenos">1917</span><span class="w">    </span><span class="c1">////////////////////////////////////////</span>
<span class="linenos">1918</span>
<span class="linenos">1919</span><span class="w">    </span><span class="c1">// Calculate the kinetic rate for each reaction at this site.</span>
<span class="linenos">1920</span><span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">totalReactionPropensity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_element</span><span class="p">(</span><span class="n">qp0</span><span class="p">,</span><span class="n">siteType</span><span class="p">);</span>
<span class="linenos">1921</span><span class="w">    </span><span class="c1">//float totalReactionPropensity = qp0[siteType];</span>
<span class="linenos">1922</span><span class="w">	</span><span class="k">for</span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">MPD_PARTICLES_PER_SITE</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">1923</span><span class="w">	</span><span class="p">{</span>
<span class="linenos">1924</span><span class="w">		</span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">p1</span><span class="o">=</span><span class="p">((</span><span class="kt">uint8_t</span><span class="o">*</span><span class="p">)</span><span class="n">particles</span><span class="p">)[</span><span class="n">i</span><span class="p">];</span>
<span class="linenos">1925</span><span class="w">		</span><span class="k">if</span><span class="p">(</span><span class="n">p1</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">1926</span><span class="w">		</span><span class="p">{</span>
<span class="linenos">1927</span><span class="w">			</span><span class="n">totalReactionPropensity</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">read_element</span><span class="p">(</span><span class="n">qp1</span><span class="p">,(</span><span class="n">siteType</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">numberSpeciesC</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">p1</span><span class="mi">-1</span><span class="p">)));</span>
<span class="linenos">1928</span><span class="w">			</span><span class="c1">//totalReactionPropensity += qp1[(siteType * numberSpeciesC + (p1-1))];</span>
<span class="linenos">1929</span><span class="w">			</span><span class="k">for</span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">j</span><span class="o">=</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">&lt;</span><span class="n">MPD_PARTICLES_PER_SITE</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">1930</span><span class="w">			</span><span class="p">{</span>
<span class="linenos">1931</span><span class="w">				</span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">p2</span><span class="o">=</span><span class="p">((</span><span class="kt">uint8_t</span><span class="o">*</span><span class="p">)</span><span class="n">particles</span><span class="p">)[</span><span class="n">j</span><span class="p">];</span>
<span class="linenos">1932</span><span class="w">				</span><span class="k">if</span><span class="p">(</span><span class="n">p2</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">1933</span><span class="w">				</span><span class="p">{</span>
<span class="linenos">1934</span><span class="w">					</span><span class="n">totalReactionPropensity</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">read_element</span><span class="p">(</span><span class="n">qp2</span><span class="p">,</span><span class="n">siteType</span><span class="o">*</span><span class="n">numberSpeciesC</span><span class="o">*</span><span class="n">numberSpeciesC</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">p1</span><span class="mi">-1</span><span class="p">)</span><span class="o">*</span><span class="n">numberSpeciesC</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">p2</span><span class="mi">-1</span><span class="p">));</span>
<span class="linenos">1935</span><span class="w">					</span><span class="c1">//totalReactionPropensity += qp2[siteType*numberSpeciesC*numberSpeciesC + (p1-1)*numberSpeciesC + (p2-1)];</span>
<span class="linenos">1936</span><span class="w">				</span><span class="p">}</span>
<span class="linenos">1937</span><span class="w">			</span><span class="p">}</span>
<span class="linenos">1938</span><span class="w">		</span><span class="p">}</span>
<span class="linenos">1939</span><span class="w">	</span><span class="p">}</span>
<span class="linenos">1940</span>
<span class="linenos">1941</span>
<span class="linenos">1942</span><span class="w">	</span><span class="c1">// If propensity is zero, no reaction can occur.</span>
<span class="linenos">1943</span><span class="w">	</span><span class="k">if</span><span class="p">(</span><span class="n">totalReactionPropensity</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">)</span>
<span class="linenos">1944</span><span class="w">		</span><span class="k">return</span><span class="p">;</span>
<span class="linenos">1945</span>
<span class="linenos">1946</span><span class="w">    </span><span class="c1">// See if a reaction occurred at the site.</span>
<span class="linenos">1947</span><span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">reactionProbability</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">calculateReactionProbability</span><span class="p">(</span><span class="n">totalReactionPropensity</span><span class="p">);</span>
<span class="linenos">1948</span><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">reactionOccurred</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">checkForReaction</span><span class="p">(</span><span class="n">globalIndex</span><span class="p">,</span><span class="w"> </span><span class="n">reactionProbability</span><span class="p">,</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">);</span>
<span class="linenos">1949</span>
<span class="linenos">1950</span><span class="w">    </span><span class="c1">// If there was a reaction, process it.</span>
<span class="linenos">1951</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">reactionOccurred</span><span class="p">)</span>
<span class="linenos">1952</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">1953</span><span class="w">        </span><span class="c1">// Figure out which reaction occurred.</span>
<span class="linenos">1954</span><span class="cp">#ifdef MPD_GLOBAL_S_MATRIX</span>
<span class="linenos">1955</span><span class="cp">#ifdef MPD_GLOBAL_R_MATRIX</span>
<span class="linenos">1956</span><span class="w">        </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">reactionIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">determineReactionIndex</span><span class="p">(</span><span class="n">siteType</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="o">*</span><span class="p">)</span><span class="n">particles</span><span class="p">,</span><span class="w"> </span><span class="n">globalIndex</span><span class="p">,</span><span class="w"> </span><span class="n">totalReactionPropensity</span><span class="p">,</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">,</span><span class="w"> </span><span class="n">RLG</span><span class="p">,</span><span class="w"> </span><span class="n">reactionOrdersG</span><span class="p">,</span><span class="w"> </span><span class="n">reactionSitesG</span><span class="p">,</span><span class="w"> </span><span class="n">D1G</span><span class="p">,</span><span class="w"> </span><span class="n">D2G</span><span class="p">,</span><span class="w"> </span><span class="n">reactionRatesG</span><span class="p">);</span>
<span class="linenos">1957</span><span class="cp">#else</span>
<span class="linenos">1958</span><span class="w">        </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">reactionIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">determineReactionIndex</span><span class="p">(</span><span class="n">siteType</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="o">*</span><span class="p">)</span><span class="n">particles</span><span class="p">,</span><span class="w"> </span><span class="n">globalIndex</span><span class="p">,</span><span class="w"> </span><span class="n">totalReactionPropensity</span><span class="p">,</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">,</span><span class="w"> </span><span class="n">RLG</span><span class="p">);</span>
<span class="linenos">1959</span><span class="cp">#endif</span>
<span class="linenos">1960</span><span class="cp">#else</span>
<span class="linenos">1961</span><span class="w">        </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">reactionIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">determineReactionIndex</span><span class="p">(</span><span class="n">siteType</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="o">*</span><span class="p">)</span><span class="n">particles</span><span class="p">,</span><span class="w"> </span><span class="n">globalIndex</span><span class="p">,</span><span class="w"> </span><span class="n">totalReactionPropensity</span><span class="p">,</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">);</span>
<span class="linenos">1962</span><span class="cp">#endif</span>
<span class="linenos">1963</span>
<span class="linenos">1964</span><span class="w">        </span><span class="c1">// Construct the new site.</span>
<span class="linenos">1965</span><span class="cp">#ifdef MPD_GLOBAL_S_MATRIX</span>
<span class="linenos">1966</span><span class="w">        </span><span class="n">evaluateReaction</span><span class="p">(</span><span class="n">latticeIndex</span><span class="p">,</span><span class="w"> </span><span class="n">siteType</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="o">*</span><span class="p">)</span><span class="n">particles</span><span class="p">,</span><span class="w"> </span><span class="n">reactionIndex</span><span class="p">,</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">,</span><span class="w"> </span><span class="n">SG</span><span class="p">);</span>
<span class="linenos">1967</span><span class="cp">#else</span>
<span class="linenos">1968</span><span class="w">        </span><span class="n">evaluateReaction</span><span class="p">(</span><span class="n">latticeIndex</span><span class="p">,</span><span class="w"> </span><span class="n">siteType</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="o">*</span><span class="p">)</span><span class="n">particles</span><span class="p">,</span><span class="w"> </span><span class="n">reactionIndex</span><span class="p">,</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">);</span>
<span class="linenos">1969</span><span class="cp">#endif</span>
<span class="linenos">1970</span>
<span class="linenos">1971</span><span class="w">        </span><span class="c1">// Copy the new particles back into the lattice.</span>
<span class="linenos">1972</span><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">w</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">latticeOffset</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">w</span><span class="o">&lt;</span><span class="n">MPD_WORDS_PER_SITE</span><span class="p">;</span><span class="w"> </span><span class="n">w</span><span class="o">++</span><span class="p">,</span><span class="w"> </span><span class="n">latticeOffset</span><span class="o">+=</span><span class="n">latticeXYZSizeC</span><span class="p">)</span>
<span class="linenos">1973</span><span class="w">             </span><span class="n">outLattice</span><span class="p">[</span><span class="n">latticeIndex</span><span class="o">+</span><span class="n">latticeOffset</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">particles</span><span class="p">[</span><span class="n">w</span><span class="p">];</span>
<span class="linenos">1974</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">1975</span><span class="p">}</span>
<span class="linenos">1976</span>
<span class="linenos">1977</span><span class="kr">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">correct_overflows_mgpu</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">lattice</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">)</span>
<span class="linenos">1978</span><span class="p">{</span>
<span class="linenos">1979</span><span class="w">	</span><span class="c1">// Remember: #define MPD_OVERFLOW_LIST_SIZE       1+2*TUNE_MPD_MAX_PARTICLE_OVERFLOWS*sizeof(uint32_t)</span>
<span class="linenos">1980</span><span class="w">	</span><span class="c1">// Requirement: one block with TUNE_MPD_MAX_PARTICLE_OVERFLOWS threads</span>
<span class="linenos">1981</span><span class="w">	</span>
<span class="linenos">1982</span><span class="w">	</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
<span class="linenos">1983</span><span class="w">	</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">total</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="linenos">1984</span>
<span class="linenos">1985</span><span class="w">	</span><span class="kt">__shared__</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">indexes</span><span class="p">[</span><span class="n">TUNE_MPD_MAX_PARTICLE_OVERFLOWS</span><span class="p">];</span>
<span class="linenos">1986</span><span class="w">	</span><span class="kt">__shared__</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">maxround</span><span class="p">;</span>
<span class="linenos">1987</span>
<span class="linenos">1988</span><span class="w">	</span><span class="c1">// Do I have an overflow to look at?</span>
<span class="linenos">1989</span><span class="w">	</span><span class="k">if</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">total</span><span class="p">)</span>
<span class="linenos">1990</span><span class="w">		</span><span class="k">return</span><span class="p">;</span>
<span class="linenos">1991</span>
<span class="linenos">1992</span><span class="w">	</span><span class="c1">// Abort if overflows have overflown</span>
<span class="linenos">1993</span><span class="w">	</span><span class="k">if</span><span class="p">(</span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="n">assert</span><span class="p">(</span><span class="n">total</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">TUNE_MPD_MAX_PARTICLE_OVERFLOWS</span><span class="p">);</span>
<span class="linenos">1994</span>
<span class="linenos">1995</span><span class="w">	</span><span class="c1">// load our index</span>
<span class="linenos">1996</span><span class="w">	</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">latticeIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">[(</span><span class="n">i</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
<span class="linenos">1997</span><span class="w">	</span><span class="n">particle_t</span><span class="w"> </span><span class="n">particle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">[(</span><span class="n">i</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="mi">2</span><span class="p">];</span>
<span class="linenos">1998</span>
<span class="linenos">1999</span><span class="w">	</span><span class="n">indexes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">latticeIndex</span><span class="p">;</span>
<span class="linenos">2000</span>
<span class="linenos">2001</span><span class="w">	</span><span class="c1">// zero out list</span>
<span class="linenos">2002</span><span class="w">	</span><span class="n">maxround</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">2003</span><span class="w">	</span><span class="nf">__syncthreads</span><span class="p">();</span>
<span class="linenos">2004</span><span class="w">	</span><span class="n">siteOverflowList</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">2005</span>
<span class="linenos">2006</span><span class="w">	</span><span class="c1">// Discover which round I should go in.  To prevent situations where two threads</span>
<span class="linenos">2007</span><span class="w">	</span><span class="c1">// will try and add a particle to the same site at the same time, and thus</span>
<span class="linenos">2008</span><span class="w">	</span><span class="c1">// negating the others, each thread determines what round it is allowed to make</span>
<span class="linenos">2009</span><span class="w">	</span><span class="c1">// edits in, by determining how many previous overflows are occuring at the </span>
<span class="linenos">2010</span><span class="w">	</span><span class="c1">// same index.</span>
<span class="linenos">2011</span><span class="w">	</span><span class="kt">int</span><span class="w"> </span><span class="n">round</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">2012</span><span class="w">	</span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">i</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">2013</span><span class="w">	</span><span class="p">{</span>
<span class="linenos">2014</span><span class="w">		</span><span class="k">if</span><span class="p">(</span><span class="n">indexes</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">latticeIndex</span><span class="p">)</span>
<span class="linenos">2015</span><span class="w">			</span><span class="n">round</span><span class="o">++</span><span class="p">;</span>
<span class="linenos">2016</span><span class="w">	</span><span class="p">}</span>
<span class="linenos">2017</span><span class="w">	</span><span class="n">atomicMax</span><span class="p">(</span><span class="o">&amp;</span><span class="n">maxround</span><span class="p">,</span><span class="w"> </span><span class="n">round</span><span class="p">);</span>
<span class="linenos">2018</span><span class="w">	</span><span class="nf">__syncthreads</span><span class="p">();</span>
<span class="linenos">2019</span>
<span class="linenos">2020</span><span class="w">	</span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">r</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">maxround</span><span class="p">;</span><span class="w"> </span><span class="n">r</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">2021</span><span class="w">	</span><span class="p">{</span>
<span class="linenos">2022</span><span class="w">		</span><span class="k">if</span><span class="p">(</span><span class="n">round</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">r</span><span class="p">)</span>
<span class="linenos">2023</span><span class="w">		</span><span class="p">{</span>
<span class="linenos">2024</span><span class="w">			</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">particles</span><span class="p">[</span><span class="n">MPD_WORDS_PER_SITE</span><span class="p">];</span>
<span class="linenos">2025</span><span class="w">			</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">w</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">latticeOffset</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">w</span><span class="o">&lt;</span><span class="n">MPD_WORDS_PER_SITE</span><span class="p">;</span><span class="w"> </span><span class="n">w</span><span class="o">++</span><span class="p">,</span><span class="w"> </span><span class="n">latticeOffset</span><span class="o">+=</span><span class="n">latticeXYZSizeC</span><span class="p">)</span>
<span class="linenos">2026</span><span class="w">				</span><span class="n">particles</span><span class="p">[</span><span class="n">w</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lattice</span><span class="p">[</span><span class="n">latticeIndex</span><span class="o">+</span><span class="n">latticeOffset</span><span class="p">];</span>
<span class="linenos">2027</span><span class="w">			</span>
<span class="linenos">2028</span><span class="w">			</span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="o">=</span><span class="p">(</span><span class="kt">uint8_t</span><span class="o">*</span><span class="p">)</span><span class="n">particles</span><span class="p">;</span>
<span class="linenos">2029</span><span class="w">			</span><span class="kt">int</span><span class="w"> </span><span class="n">ok</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">2030</span><span class="w">			</span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">pi</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">pi</span><span class="o">&lt;</span><span class="n">MPD_PARTICLES_PER_SITE</span><span class="p">;</span><span class="w"> </span><span class="n">pi</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">2031</span><span class="w">			</span><span class="p">{</span>
<span class="linenos">2032</span><span class="w">				</span><span class="k">if</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">pi</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">2033</span><span class="w">				</span><span class="p">{</span>
<span class="linenos">2034</span><span class="w">					</span><span class="n">p</span><span class="p">[</span><span class="n">pi</span><span class="p">]</span><span class="o">=</span><span class="n">particle</span><span class="p">;</span>
<span class="linenos">2035</span><span class="w">					</span><span class="n">ok</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
<span class="linenos">2036</span><span class="w">					</span><span class="c1">//printf(&quot;(round %d) Corrected overflow of particle %d at index %d\n&quot;, r, particle, latticeIndex);</span>
<span class="linenos">2037</span><span class="w">					</span><span class="k">break</span><span class="p">;</span>
<span class="linenos">2038</span><span class="w">				</span><span class="p">}</span>
<span class="linenos">2039</span><span class="w">			</span><span class="p">}</span>
<span class="linenos">2040</span>
<span class="linenos">2041</span><span class="w">			</span><span class="k">if</span><span class="p">(</span><span class="n">ok</span><span class="p">)</span>
<span class="linenos">2042</span><span class="w">			</span><span class="p">{</span>
<span class="linenos">2043</span><span class="w">				</span><span class="c1">// Copy the new particles back into the lattice.</span>
<span class="linenos">2044</span><span class="w">				</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">w</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">latticeOffset</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">w</span><span class="o">&lt;</span><span class="n">MPD_WORDS_PER_SITE</span><span class="p">;</span><span class="w"> </span><span class="n">w</span><span class="o">++</span><span class="p">,</span><span class="w"> </span><span class="n">latticeOffset</span><span class="o">+=</span><span class="n">latticeXYZSizeC</span><span class="p">)</span>
<span class="linenos">2045</span><span class="w">				     </span><span class="n">lattice</span><span class="p">[</span><span class="n">latticeIndex</span><span class="o">+</span><span class="n">latticeOffset</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">particles</span><span class="p">[</span><span class="n">w</span><span class="p">];</span>
<span class="linenos">2046</span><span class="w">			</span><span class="p">}</span>
<span class="linenos">2047</span><span class="w">			</span><span class="k">else</span>
<span class="linenos">2048</span><span class="w">			</span><span class="p">{</span>
<span class="linenos">2049</span><span class="w">				</span><span class="kt">int</span><span class="w"> </span><span class="n">exceptionIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">atomicAdd</span><span class="p">(</span><span class="n">siteOverflowList</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="linenos">2050</span><span class="w">				</span><span class="n">siteOverflowList</span><span class="p">[(</span><span class="n">exceptionIndex</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">latticeIndex</span><span class="p">;</span>
<span class="linenos">2051</span><span class="w">				</span><span class="n">siteOverflowList</span><span class="p">[(</span><span class="n">exceptionIndex</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">particle</span><span class="p">;</span>
<span class="linenos">2052</span><span class="w">				</span><span class="c1">//printf(&quot;(round %d) Failed to correct overflow of particle %d at index %d\n&quot;, r, particle, latticeIndex);</span>
<span class="linenos">2053</span><span class="w">			</span><span class="p">}</span>
<span class="linenos">2054</span><span class="w">		</span><span class="p">}</span>
<span class="linenos">2055</span><span class="w">		</span><span class="nf">__syncthreads</span><span class="p">();</span>
<span class="linenos">2056</span><span class="w">	</span><span class="p">}</span>
<span class="linenos">2057</span>
<span class="linenos">2058</span><span class="w">	</span><span class="c1">//if(i  == 0)</span>
<span class="linenos">2059</span><span class="w">		</span><span class="c1">//printf(&quot;%d) in: %d overflows, out: %d\n&quot;, gpuidC, total, siteOverflowList[0]);</span>
<span class="linenos">2060</span>
<span class="linenos">2061</span><span class="p">}</span>
<span class="linenos">2062</span>
<span class="linenos">2063</span><span class="cp">#ifdef MPD_GLOBAL_S_MATRIX</span>
<span class="linenos">2064</span><span class="cp">#ifdef MPD_GLOBAL_R_MATRIX</span>
<span class="linenos">2065</span><span class="kr">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">__launch_bounds__</span><span class="p">(</span><span class="n">TUNE_MPD_REACTION_BLOCK_X_SIZE</span><span class="o">*</span><span class="n">TUNE_MPD_REACTION_BLOCK_Y_SIZE</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="n">MGPU_precomp_reaction_kernel_packing</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">inLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">inSites</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">outLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">z_start</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="kt">int8_t</span><span class="w"> </span><span class="o">*</span><span class="n">SG</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="n">RLG</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="n">reactionOrdersG</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="n">reactionSitesG</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="n">D1G</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="n">D2G</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="n">reactionRatesG</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="n">qp0</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="n">qp1</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="n">qp2</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">buf_top</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">buf_bot</span><span class="p">)</span>
<span class="linenos">2066</span><span class="cp">#else</span>
<span class="linenos">2067</span><span class="kr">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">__launch_bounds__</span><span class="p">(</span><span class="n">TUNE_MPD_REACTION_BLOCK_X_SIZE</span><span class="o">*</span><span class="n">TUNE_MPD_REACTION_BLOCK_Y_SIZE</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="n">MGPU_precomp_reaction_kernel_packing</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">inLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">inSites</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">outLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">z_start</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="kt">int8_t</span><span class="w"> </span><span class="o">*</span><span class="n">SG</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="n">RLG</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="n">qp0</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="n">qp1</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="n">qp2</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">buf_top</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">buf_bot</span><span class="p">)</span>
<span class="linenos">2068</span><span class="cp">#endif</span>
<span class="linenos">2069</span><span class="cp">#else</span>
<span class="linenos">2070</span><span class="kr">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">__launch_bounds__</span><span class="p">(</span><span class="n">TUNE_MPD_REACTION_BLOCK_X_SIZE</span><span class="o">*</span><span class="n">TUNE_MPD_REACTION_BLOCK_Y_SIZE</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="n">MGPU_precomp_reaction_kernel_packing</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">inLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">inSites</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">outLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">z_start</span><span class="p">,</span><span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="n">qp0</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="n">qp1</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="n">qp2</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">buf_top</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">buf_bot</span><span class="p">)</span>
<span class="linenos">2071</span><span class="cp">#endif</span>
<span class="linenos">2072</span><span class="p">{</span>
<span class="linenos">2073</span><span class="w">	</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">blockDim</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
<span class="linenos">2074</span><span class="w">	</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">blockDim</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
<span class="linenos">2075</span><span class="w">	</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">z</span><span class="o">+</span><span class="n">z_start</span><span class="p">;</span>
<span class="linenos">2076</span>
<span class="linenos">2077</span><span class="w">    </span><span class="c1">// Figure out the offset of this thread in the lattice and the lattice segment.</span>
<span class="linenos">2078</span><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">local_index</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">z</span><span class="p">);</span>
<span class="linenos">2079</span><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">globalIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">local_to_global</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">z</span><span class="p">);</span><span class="w"> </span><span class="c1">// Use the global lattice index for RNG</span>
<span class="linenos">2080</span>
<span class="linenos">2081</span><span class="w">    </span><span class="c1">///////////////////////////////////////////</span>
<span class="linenos">2082</span><span class="w">    </span><span class="c1">// Load the particles and site.          //</span>
<span class="linenos">2083</span><span class="w">    </span><span class="c1">///////////////////////////////////////////</span>
<span class="linenos">2084</span>
<span class="linenos">2085</span><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">particles</span><span class="p">[</span><span class="n">MPD_WORDS_PER_SITE</span><span class="p">];</span>
<span class="linenos">2086</span><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">w</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">latticeOffset</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">w</span><span class="o">&lt;</span><span class="n">MPD_WORDS_PER_SITE</span><span class="p">;</span><span class="w"> </span><span class="n">w</span><span class="o">++</span><span class="p">,</span><span class="w"> </span><span class="n">latticeOffset</span><span class="o">+=</span><span class="n">latticeXYZSizeC</span><span class="p">)</span>
<span class="linenos">2087</span><span class="w">        </span><span class="n">particles</span><span class="p">[</span><span class="n">w</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inLattice</span><span class="p">[</span><span class="n">latticeIndex</span><span class="o">+</span><span class="n">latticeOffset</span><span class="p">];</span>
<span class="linenos">2088</span><span class="w">    </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">siteType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inSites</span><span class="p">[</span><span class="n">latticeIndex</span><span class="p">];</span>
<span class="linenos">2089</span>
<span class="linenos">2090</span><span class="w">    </span><span class="c1">////////////////////////////////////////</span>
<span class="linenos">2091</span><span class="w">    </span><span class="c1">// Perform the reactions.             //</span>
<span class="linenos">2092</span><span class="w">    </span><span class="c1">////////////////////////////////////////</span>
<span class="linenos">2093</span>
<span class="linenos">2094</span><span class="w">    </span><span class="c1">// Calculate the kinetic rate for each reaction at this site.</span>
<span class="linenos">2095</span><span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">totalReactionPropensity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_element</span><span class="p">(</span><span class="n">qp0</span><span class="p">,</span><span class="n">siteType</span><span class="p">);</span>
<span class="linenos">2096</span><span class="w">    </span><span class="c1">//float totalReactionPropensity = qp0[siteType];</span>
<span class="linenos">2097</span><span class="w">	</span><span class="k">for</span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">MPD_PARTICLES_PER_SITE</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">2098</span><span class="w">	</span><span class="p">{</span>
<span class="linenos">2099</span><span class="w">		</span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">p1</span><span class="o">=</span><span class="p">((</span><span class="kt">uint8_t</span><span class="o">*</span><span class="p">)</span><span class="n">particles</span><span class="p">)[</span><span class="n">i</span><span class="p">];</span>
<span class="linenos">2100</span><span class="w">		</span><span class="k">if</span><span class="p">(</span><span class="n">p1</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">2101</span><span class="w">		</span><span class="p">{</span>
<span class="linenos">2102</span><span class="w">			</span><span class="n">totalReactionPropensity</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">read_element</span><span class="p">(</span><span class="n">qp1</span><span class="p">,(</span><span class="n">siteType</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">numberSpeciesC</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">p1</span><span class="mi">-1</span><span class="p">)));</span>
<span class="linenos">2103</span><span class="w">			</span><span class="c1">//totalReactionPropensity += qp1[(siteType * numberSpeciesC + (p1-1))];</span>
<span class="linenos">2104</span><span class="w">			</span><span class="k">for</span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">j</span><span class="o">=</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">&lt;</span><span class="n">MPD_PARTICLES_PER_SITE</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">2105</span><span class="w">			</span><span class="p">{</span>
<span class="linenos">2106</span><span class="w">				</span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">p2</span><span class="o">=</span><span class="p">((</span><span class="kt">uint8_t</span><span class="o">*</span><span class="p">)</span><span class="n">particles</span><span class="p">)[</span><span class="n">j</span><span class="p">];</span>
<span class="linenos">2107</span><span class="w">				</span><span class="k">if</span><span class="p">(</span><span class="n">p2</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">2108</span><span class="w">				</span><span class="p">{</span>
<span class="linenos">2109</span><span class="w">					</span><span class="n">totalReactionPropensity</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">read_element</span><span class="p">(</span><span class="n">qp2</span><span class="p">,</span><span class="n">siteType</span><span class="o">*</span><span class="n">numberSpeciesC</span><span class="o">*</span><span class="n">numberSpeciesC</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">p1</span><span class="mi">-1</span><span class="p">)</span><span class="o">*</span><span class="n">numberSpeciesC</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">p2</span><span class="mi">-1</span><span class="p">));</span>
<span class="linenos">2110</span><span class="w">					</span><span class="c1">//totalReactionPropensity += qp2[siteType*numberSpeciesC*numberSpeciesC + (p1-1)*numberSpeciesC + (p2-1)];</span>
<span class="linenos">2111</span><span class="w">				</span><span class="p">}</span>
<span class="linenos">2112</span><span class="w">			</span><span class="p">}</span>
<span class="linenos">2113</span><span class="w">		</span><span class="p">}</span>
<span class="linenos">2114</span><span class="w">	</span><span class="p">}</span>
<span class="linenos">2115</span>
<span class="linenos">2116</span><span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">reactionProbability</span><span class="p">;</span>
<span class="linenos">2117</span><span class="w">	</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">reactionOccurred</span><span class="p">;</span>
<span class="linenos">2118</span>
<span class="linenos">2119</span><span class="w">	</span><span class="c1">// If propensity is zero, no reaction can occur.</span>
<span class="linenos">2120</span><span class="w">	</span><span class="k">if</span><span class="p">(</span><span class="n">totalReactionPropensity</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">)</span>
<span class="linenos">2121</span><span class="w">		</span><span class="k">goto</span><span class="w"> </span><span class="n">letspackitup</span><span class="p">;</span>
<span class="linenos">2122</span>
<span class="linenos">2123</span><span class="w">    </span><span class="c1">// See if a reaction occurred at the site.</span>
<span class="linenos">2124</span><span class="w">    </span><span class="n">reactionProbability</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">calculateReactionProbability</span><span class="p">(</span><span class="n">totalReactionPropensity</span><span class="p">);</span>
<span class="linenos">2125</span><span class="w">    </span><span class="n">reactionOccurred</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">checkForReaction</span><span class="p">(</span><span class="n">globalIndex</span><span class="p">,</span><span class="w"> </span><span class="n">reactionProbability</span><span class="p">,</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">);</span>
<span class="linenos">2126</span>
<span class="linenos">2127</span><span class="w">    </span><span class="c1">// If there was a reaction, process it.</span>
<span class="linenos">2128</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">reactionOccurred</span><span class="p">)</span>
<span class="linenos">2129</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">2130</span><span class="w">        </span><span class="c1">// Figure out which reaction occurred.</span>
<span class="linenos">2131</span><span class="cp">#ifdef MPD_GLOBAL_S_MATRIX</span>
<span class="linenos">2132</span><span class="cp">#ifdef MPD_GLOBAL_R_MATRIX</span>
<span class="linenos">2133</span><span class="w">        </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">reactionIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">determineReactionIndex</span><span class="p">(</span><span class="n">siteType</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="o">*</span><span class="p">)</span><span class="n">particles</span><span class="p">,</span><span class="w"> </span><span class="n">globalIndex</span><span class="p">,</span><span class="w"> </span><span class="n">totalReactionPropensity</span><span class="p">,</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">,</span><span class="w"> </span><span class="n">RLG</span><span class="p">,</span><span class="w"> </span><span class="n">reactionOrdersG</span><span class="p">,</span><span class="w"> </span><span class="n">reactionSitesG</span><span class="p">,</span><span class="w"> </span><span class="n">D1G</span><span class="p">,</span><span class="w"> </span><span class="n">D2G</span><span class="p">,</span><span class="w"> </span><span class="n">reactionRatesG</span><span class="p">);</span>
<span class="linenos">2134</span><span class="cp">#else</span>
<span class="linenos">2135</span><span class="w">        </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">reactionIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">determineReactionIndex</span><span class="p">(</span><span class="n">siteType</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="o">*</span><span class="p">)</span><span class="n">particles</span><span class="p">,</span><span class="w"> </span><span class="n">globalIndex</span><span class="p">,</span><span class="w"> </span><span class="n">totalReactionPropensity</span><span class="p">,</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">,</span><span class="w"> </span><span class="n">RLG</span><span class="p">);</span>
<span class="linenos">2136</span><span class="cp">#endif</span>
<span class="linenos">2137</span><span class="cp">#else</span>
<span class="linenos">2138</span><span class="w">        </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">reactionIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">determineReactionIndex</span><span class="p">(</span><span class="n">siteType</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="o">*</span><span class="p">)</span><span class="n">particles</span><span class="p">,</span><span class="w"> </span><span class="n">globalIndex</span><span class="p">,</span><span class="w"> </span><span class="n">totalReactionPropensity</span><span class="p">,</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">);</span>
<span class="linenos">2139</span><span class="cp">#endif</span>
<span class="linenos">2140</span>
<span class="linenos">2141</span><span class="w">        </span><span class="c1">// Construct the new site.</span>
<span class="linenos">2142</span><span class="cp">#ifdef MPD_GLOBAL_S_MATRIX</span>
<span class="linenos">2143</span><span class="w">        </span><span class="n">evaluateReaction</span><span class="p">(</span><span class="n">latticeIndex</span><span class="p">,</span><span class="w"> </span><span class="n">siteType</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="o">*</span><span class="p">)</span><span class="n">particles</span><span class="p">,</span><span class="w"> </span><span class="n">reactionIndex</span><span class="p">,</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">,</span><span class="w"> </span><span class="n">SG</span><span class="p">);</span>
<span class="linenos">2144</span><span class="cp">#else</span>
<span class="linenos">2145</span><span class="w">        </span><span class="n">evaluateReaction</span><span class="p">(</span><span class="n">latticeIndex</span><span class="p">,</span><span class="w"> </span><span class="n">siteType</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="o">*</span><span class="p">)</span><span class="n">particles</span><span class="p">,</span><span class="w"> </span><span class="n">reactionIndex</span><span class="p">,</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">);</span>
<span class="linenos">2146</span><span class="cp">#endif</span>
<span class="linenos">2147</span>
<span class="linenos">2148</span><span class="w">        </span><span class="c1">// Copy the new particles back into the lattice.</span>
<span class="linenos">2149</span><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">w</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">latticeOffset</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">w</span><span class="o">&lt;</span><span class="n">MPD_WORDS_PER_SITE</span><span class="p">;</span><span class="w"> </span><span class="n">w</span><span class="o">++</span><span class="p">,</span><span class="w"> </span><span class="n">latticeOffset</span><span class="o">+=</span><span class="n">latticeXYZSizeC</span><span class="p">)</span>
<span class="linenos">2150</span><span class="w">             </span><span class="n">outLattice</span><span class="p">[</span><span class="n">latticeIndex</span><span class="o">+</span><span class="n">latticeOffset</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">particles</span><span class="p">[</span><span class="n">w</span><span class="p">];</span>
<span class="linenos">2151</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">2152</span>
<span class="linenos">2153</span><span class="nl">letspackitup</span><span class="p">:</span>
<span class="linenos">2154</span>
<span class="linenos">2155</span><span class="w">	</span><span class="kt">bool</span><span class="w"> </span><span class="n">in_top_send</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">z</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="p">(</span><span class="n">top_send_z</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">top_dim_z</span><span class="p">));</span>
<span class="linenos">2156</span><span class="w">	</span><span class="kt">bool</span><span class="w"> </span><span class="n">in_bot_send</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">z</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">bot_send_z</span><span class="p">);</span>
<span class="linenos">2157</span>
<span class="linenos">2158</span><span class="cm">/*</span>
<span class="linenos">2159</span><span class="cm">	if(x == 0 &amp;&amp; y == 0 &amp;&amp; in_top_send)</span>
<span class="linenos">2160</span><span class="cm">		printf(&quot;%d, %d, %d in top send send z =%d, dim z = %d, sz=%d\n&quot;, x, y, z, top_send_z, top_dim_z, top_dim_size);</span>
<span class="linenos">2161</span><span class="cm">	if(x == 0 &amp;&amp; y == 0 &amp;&amp; in_bot_send)</span>
<span class="linenos">2162</span><span class="cm">		printf(&quot;%d, %d, %d in bot send send z =%d, dim z = %d, sz=%d\n&quot;, x, y, z, bot_send_z, bot_dim_z, bot_dim_size);</span>
<span class="linenos">2163</span><span class="cm">*/</span>
<span class="linenos">2164</span>
<span class="linenos">2165</span><span class="w">	</span><span class="k">if</span><span class="p">(</span><span class="n">in_top_send</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">buf_top</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span>
<span class="linenos">2166</span><span class="w">	</span><span class="p">{</span>
<span class="linenos">2167</span><span class="w">		</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">packidx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">y</span><span class="o">*</span><span class="n">latticeXSizeC</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">z</span><span class="o">-</span><span class="n">top_send_z</span><span class="p">)</span><span class="o">*</span><span class="n">latticeXYSizeC</span><span class="p">;</span>
<span class="linenos">2168</span><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">w</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">packOffset</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">w</span><span class="o">&lt;</span><span class="n">MPD_WORDS_PER_SITE</span><span class="p">;</span><span class="w"> </span><span class="n">w</span><span class="o">++</span><span class="p">,</span><span class="w"> </span><span class="n">packOffset</span><span class="o">+=</span><span class="n">top_dim_size</span><span class="p">)</span>
<span class="linenos">2169</span><span class="w">             </span><span class="n">buf_top</span><span class="p">[</span><span class="n">packidx</span><span class="o">+</span><span class="n">packOffset</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">particles</span><span class="p">[</span><span class="n">w</span><span class="p">];</span>
<span class="linenos">2170</span><span class="w">	</span><span class="p">}</span>
<span class="linenos">2171</span>
<span class="linenos">2172</span><span class="w">	</span><span class="k">if</span><span class="p">(</span><span class="n">in_bot_send</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">buf_bot</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span>
<span class="linenos">2173</span><span class="w">	</span><span class="p">{</span>
<span class="linenos">2174</span><span class="w">		</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">packidx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">y</span><span class="o">*</span><span class="n">latticeXSizeC</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">z</span><span class="o">-</span><span class="n">bot_send_z</span><span class="p">)</span><span class="o">*</span><span class="n">latticeXYSizeC</span><span class="p">;</span>
<span class="linenos">2175</span><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">w</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">packOffset</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">w</span><span class="o">&lt;</span><span class="n">MPD_WORDS_PER_SITE</span><span class="p">;</span><span class="w"> </span><span class="n">w</span><span class="o">++</span><span class="p">,</span><span class="w"> </span><span class="n">packOffset</span><span class="o">+=</span><span class="n">bot_dim_size</span><span class="p">)</span>
<span class="linenos">2176</span><span class="w">             </span><span class="n">buf_bot</span><span class="p">[</span><span class="n">packidx</span><span class="o">+</span><span class="n">packOffset</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">particles</span><span class="p">[</span><span class="n">w</span><span class="p">];</span>
<span class="linenos">2177</span><span class="w">	</span><span class="p">}</span>
<span class="linenos">2178</span><span class="p">}</span>
<span class="linenos">2179</span>
<span class="linenos">2180</span><span class="kr">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">MGPU_x_kernel_unpack</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">inLattice</span><span class="p">,</span>
<span class="linenos">2181</span><span class="w">                                     </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">inSites</span><span class="p">,</span>
<span class="linenos">2182</span><span class="w">									 </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">outLattice</span><span class="p">,</span>
<span class="linenos">2183</span><span class="w">									 </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">z_start</span><span class="p">,</span>
<span class="linenos">2184</span><span class="w">									 </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">,</span>
<span class="linenos">2185</span><span class="w">									 </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">,</span>
<span class="linenos">2186</span><span class="w">									 </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">buf_top</span><span class="p">,</span>
<span class="linenos">2187</span><span class="w">									 </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">buf_bot</span><span class="p">)</span>
<span class="linenos">2188</span><span class="p">{</span>
<span class="linenos">2189</span><span class="w">	</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nb">blockDim</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
<span class="linenos">2190</span><span class="w">	</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nb">blockDim</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
<span class="linenos">2191</span><span class="w">	</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">z</span><span class="o">+</span><span class="n">z_start</span><span class="p">;</span>
<span class="linenos">2192</span><span class="w">	</span>
<span class="linenos">2193</span><span class="w">    </span><span class="c1">// Figure out the offset of this thread in the lattice and the lattice segment.</span>
<span class="linenos">2194</span><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeXIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="p">;</span>
<span class="linenos">2195</span><span class="w">	</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">local_index</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">z</span><span class="p">);</span>
<span class="linenos">2196</span><span class="w">	</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">globalIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">local_to_global</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">z</span><span class="p">);</span><span class="w"> </span><span class="c1">// Use the global lattice index for RNG</span>
<span class="linenos">2197</span><span class="w">	</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">windowIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="o">+</span><span class="n">MPD_APRON_SIZE</span><span class="p">;</span>
<span class="linenos">2198</span>
<span class="linenos">2199</span><span class="w">	</span><span class="c1">// Check if I need to read from buffer and not lattice</span>
<span class="linenos">2200</span><span class="w">	</span><span class="kt">bool</span><span class="w"> </span><span class="n">in_top_recv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">z</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="p">(</span><span class="n">top_recv_z</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">top_dim_z</span><span class="p">));</span>
<span class="linenos">2201</span><span class="w">	</span><span class="kt">bool</span><span class="w"> </span><span class="n">in_bot_recv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">z</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">bot_recv_z</span><span class="p">);</span>
<span class="linenos">2202</span>
<span class="linenos">2203</span><span class="w">    </span><span class="c1">///////////////////////////////////////////</span>
<span class="linenos">2204</span><span class="w">    </span><span class="c1">// Load the lattice into shared memory. //</span>
<span class="linenos">2205</span><span class="w">    </span><span class="c1">///////////////////////////////////////////</span>
<span class="linenos">2206</span>
<span class="linenos">2207</span><span class="w">    </span><span class="c1">// Shared memory to store the lattice segment.</span>
<span class="linenos">2208</span><span class="w">    </span><span class="kt">__shared__</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">window</span><span class="p">[</span><span class="n">MPD_X_WINDOW_SIZE</span><span class="o">*</span><span class="n">MPD_WORDS_PER_SITE</span><span class="p">];</span>
<span class="linenos">2209</span><span class="w">    </span><span class="kt">__shared__</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">sitesWindow</span><span class="p">[</span><span class="n">MPD_X_WINDOW_SIZE</span><span class="p">];</span>
<span class="linenos">2210</span>
<span class="linenos">2211</span><span class="w">	</span><span class="k">if</span><span class="p">(</span><span class="n">in_top_recv</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">buf_top</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span>
<span class="linenos">2212</span><span class="w">	</span><span class="p">{</span>
<span class="linenos">2213</span><span class="w">		</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">packidx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">y</span><span class="o">*</span><span class="n">latticeXSizeC</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">z</span><span class="o">-</span><span class="n">top_recv_z</span><span class="p">)</span><span class="o">*</span><span class="n">latticeXYSizeC</span><span class="p">;</span>
<span class="linenos">2214</span><span class="w">		</span><span class="n">copyXWindowFromBuffer</span><span class="p">(</span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">buf_top</span><span class="p">,</span><span class="w"> </span><span class="n">window</span><span class="p">,</span><span class="w"> </span><span class="n">packidx</span><span class="p">,</span><span class="w"> </span><span class="n">latticeXIndex</span><span class="p">,</span><span class="w"> </span><span class="n">windowIndex</span><span class="p">,</span><span class="w"> </span><span class="n">top_dim_size</span><span class="p">);</span>
<span class="linenos">2215</span><span class="w">	</span><span class="p">}</span>
<span class="linenos">2216</span><span class="w">	</span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="p">(</span><span class="n">in_bot_recv</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">buf_bot</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span>
<span class="linenos">2217</span><span class="w">	</span><span class="p">{</span>
<span class="linenos">2218</span><span class="w">		</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">packidx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">y</span><span class="o">*</span><span class="n">latticeXSizeC</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">z</span><span class="o">-</span><span class="n">bot_recv_z</span><span class="p">)</span><span class="o">*</span><span class="n">latticeXYSizeC</span><span class="p">;</span>
<span class="linenos">2219</span><span class="w">		</span><span class="n">copyXWindowFromBuffer</span><span class="p">(</span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">buf_bot</span><span class="p">,</span><span class="w"> </span><span class="n">window</span><span class="p">,</span><span class="w"> </span><span class="n">packidx</span><span class="p">,</span><span class="w"> </span><span class="n">latticeXIndex</span><span class="p">,</span><span class="w"> </span><span class="n">windowIndex</span><span class="p">,</span><span class="w"> </span><span class="n">bot_dim_size</span><span class="p">);</span>
<span class="linenos">2220</span><span class="w">	</span><span class="p">}</span>
<span class="linenos">2221</span><span class="w">	</span><span class="k">else</span>
<span class="linenos">2222</span><span class="w">	</span><span class="p">{</span>
<span class="linenos">2223</span><span class="w">		</span><span class="c1">// Copy the x window from device memory into shared memory.</span>
<span class="linenos">2224</span><span class="w">		</span><span class="n">copyXWindowFromLattice</span><span class="p">(</span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">inLattice</span><span class="p">,</span><span class="w"> </span><span class="n">window</span><span class="p">,</span><span class="w"> </span><span class="n">latticeIndex</span><span class="p">,</span><span class="w"> </span><span class="n">latticeXIndex</span><span class="p">,</span><span class="w"> </span><span class="n">windowIndex</span><span class="p">);</span>
<span class="linenos">2225</span><span class="w">	</span><span class="p">}</span>
<span class="linenos">2226</span>
<span class="linenos">2227</span><span class="w">    </span><span class="n">copyXWindowFromSites</span><span class="p">(</span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">inSites</span><span class="p">,</span><span class="w"> </span><span class="n">sitesWindow</span><span class="p">,</span><span class="w"> </span><span class="n">latticeIndex</span><span class="p">,</span><span class="w"> </span><span class="n">latticeXIndex</span><span class="p">,</span><span class="w"> </span><span class="n">windowIndex</span><span class="p">);</span>
<span class="linenos">2228</span><span class="w">    </span><span class="nf">__syncthreads</span><span class="p">();</span>
<span class="linenos">2229</span>
<span class="linenos">2230</span><span class="w">    </span><span class="c1">////////////////////////////////////////</span>
<span class="linenos">2231</span><span class="w">    </span><span class="c1">// Make the choice for each particle. //</span>
<span class="linenos">2232</span><span class="w">    </span><span class="c1">////////////////////////////////////////</span>
<span class="linenos">2233</span>
<span class="linenos">2234</span><span class="w">    </span><span class="kt">__shared__</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">choices</span><span class="p">[</span><span class="n">MPD_X_WINDOW_SIZE</span><span class="o">*</span><span class="n">MPD_WORDS_PER_SITE</span><span class="p">];</span>
<span class="linenos">2235</span>
<span class="linenos">2236</span><span class="w">    </span><span class="c1">// Make the choices.</span>
<span class="linenos">2237</span><span class="w">    </span><span class="n">makeXDiffusionChoices</span><span class="p">(</span><span class="n">window</span><span class="p">,</span><span class="w"> </span><span class="n">sitesWindow</span><span class="p">,</span><span class="w"> </span><span class="n">choices</span><span class="p">,</span><span class="w"> </span><span class="n">globalIndex</span><span class="p">,</span><span class="w"> </span><span class="n">latticeXIndex</span><span class="p">,</span><span class="w"> </span><span class="n">windowIndex</span><span class="p">,</span><span class="w"> </span><span class="nb">blockDim</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">);</span>
<span class="linenos">2238</span><span class="w">	</span><span class="nf">__syncthreads</span><span class="p">();</span>
<span class="linenos">2239</span>
<span class="linenos">2240</span><span class="w">    </span><span class="c1">//////////////////////////////////////////////////////////</span>
<span class="linenos">2241</span><span class="w">    </span><span class="c1">// Create version of the lattice at the next time step. //</span>
<span class="linenos">2242</span><span class="w">    </span><span class="c1">//////////////////////////////////////////////////////////</span>
<span class="linenos">2243</span>
<span class="linenos">2244</span><span class="w">    </span><span class="c1">// Propagate the choices to the new lattice segment.</span>
<span class="linenos">2245</span><span class="w">    </span><span class="n">performPropagation</span><span class="p">(</span><span class="n">outLattice</span><span class="p">,</span><span class="w"> </span><span class="n">window</span><span class="p">,</span><span class="w"> </span><span class="n">choices</span><span class="p">,</span><span class="w"> </span><span class="n">latticeIndex</span><span class="p">,</span><span class="w"> </span><span class="n">windowIndex</span><span class="mi">-1</span><span class="p">,</span><span class="w"> </span><span class="n">windowIndex</span><span class="p">,</span><span class="w"> </span><span class="n">windowIndex</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">MPD_X_WINDOW_SIZE</span><span class="p">,</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">);</span>
<span class="linenos">2246</span><span class="p">}</span>
<span class="linenos">2247</span>
<span class="linenos">2248</span><span class="c1">// For periodic lattices with a potentially negative offset</span>
<span class="linenos">2249</span><span class="kt">__device__</span><span class="w"> </span><span class="kr">inline</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">local_to_global</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="linenos">2250</span><span class="p">{</span>
<span class="linenos">2251</span><span class="w">    </span><span class="kt">ssize_t</span><span class="w"> </span><span class="n">ix</span><span class="o">=</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">x</span><span class="o">+</span><span class="n">goffsetXC</span><span class="p">;</span>
<span class="linenos">2252</span><span class="w">    </span><span class="n">ix</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">y</span><span class="o">+</span><span class="n">goffsetYC</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">latticeXSizeC</span><span class="p">;</span>
<span class="linenos">2253</span><span class="w">    </span><span class="n">ix</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">z</span><span class="o">+</span><span class="n">goffsetZC</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">latticeXYSizeC</span><span class="p">;</span>
<span class="linenos">2254</span><span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">max_index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">global_latticeXYZSizeC</span><span class="p">;</span>
<span class="linenos">2255</span><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">ix</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">2256</span><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">ix</span><span class="o">+</span><span class="n">max_index</span><span class="p">;</span>
<span class="linenos">2257</span><span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="p">(</span><span class="n">ix</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">max_index</span><span class="p">)</span>
<span class="linenos">2258</span><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">ix</span><span class="o">-</span><span class="n">max_index</span><span class="p">;</span>
<span class="linenos">2259</span><span class="w">    </span><span class="k">else</span>
<span class="linenos">2260</span><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">ix</span><span class="p">;</span>
<span class="linenos">2261</span><span class="p">}</span>
<span class="linenos">2262</span><span class="cm">/*</span>
<span class="linenos">2263</span><span class="cm">// For non-periodic lattices with a strictly positive offset</span>
<span class="linenos">2264</span><span class="cm">__device__ inline size_t local_to_global(unsigned int x, unsigned int y, unsigned int z)</span>
<span class="linenos">2265</span><span class="cm">{</span>
<span class="linenos">2266</span><span class="cm">    size_t ix=x+goffsetXC;</span>
<span class="linenos">2267</span><span class="cm">    ix += (y+goffsetYC)*latticeXSizeC;</span>
<span class="linenos">2268</span><span class="cm">    ix += (z+goffsetZC)*latticeXYSizeC;</span>
<span class="linenos">2269</span><span class="cm">	return ix;</span>
<span class="linenos">2270</span><span class="cm">}</span>
<span class="linenos">2271</span><span class="cm">*/</span>
<span class="linenos">2272</span>
<span class="linenos">2273</span><span class="kt">__device__</span><span class="w"> </span><span class="kr">inline</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">local_index</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="linenos">2274</span><span class="p">{</span>
<span class="linenos">2275</span><span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">y</span><span class="o">*</span><span class="n">latticeXSizeC</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">z</span><span class="o">*</span><span class="n">latticeXYSizeC</span><span class="p">;</span>
<span class="linenos">2276</span><span class="p">}</span>
<span class="linenos">2277</span>
<span class="linenos">2278</span><span class="p">}</span>
<span class="linenos">2279</span><span class="p">}</span>
<span class="linenos">2280</span><span class="p">}</span>
</pre></div>
</div>
</section>
<section id="mgpuintmpdrdmesolver-h">
<h3>MGPUIntMpdRdmeSolver.h<a class="headerlink" href="#mgpuintmpdrdmesolver-h" title="Link to this heading">#</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="linenos">  1</span><span class="cm">/*</span>
<span class="linenos">  2</span><span class="cm"> * University of Illinois Open Source License</span>
<span class="linenos">  3</span><span class="cm"> * Copyright 2008-2018 Luthey-Schulten Group,</span>
<span class="linenos">  4</span><span class="cm"> * Copyright 2012 Roberts Group,</span>
<span class="linenos">  5</span><span class="cm"> * All rights reserved.</span>
<span class="linenos">  6</span><span class="cm"> * </span>
<span class="linenos">  7</span><span class="cm"> * Developed by: Luthey-Schulten Group</span>
<span class="linenos">  8</span><span class="cm"> * 			     University of Illinois at Urbana-Champaign</span>
<span class="linenos">  9</span><span class="cm"> * 			     http://www.scs.uiuc.edu/~schulten</span>
<span class="linenos"> 10</span><span class="cm"> * </span>
<span class="linenos"> 11</span><span class="cm"> * Developed by: Roberts Group</span>
<span class="linenos"> 12</span><span class="cm"> * 			     Johns Hopkins University</span>
<span class="linenos"> 13</span><span class="cm"> * 			     http://biophysics.jhu.edu/roberts/</span>
<span class="linenos"> 14</span><span class="cm"> *</span>
<span class="linenos"> 15</span><span class="cm"> * Permission is hereby granted, free of charge, to any person obtaining a copy of</span>
<span class="linenos"> 16</span><span class="cm"> * this software and associated documentation files (the Software), to deal with </span>
<span class="linenos"> 17</span><span class="cm"> * the Software without restriction, including without limitation the rights to </span>
<span class="linenos"> 18</span><span class="cm"> * use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies </span>
<span class="linenos"> 19</span><span class="cm"> * of the Software, and to permit persons to whom the Software is furnished to </span>
<span class="linenos"> 20</span><span class="cm"> * do so, subject to the following conditions:</span>
<span class="linenos"> 21</span><span class="cm"> * </span>
<span class="linenos"> 22</span><span class="cm"> * - Redistributions of source code must retain the above copyright notice, </span>
<span class="linenos"> 23</span><span class="cm"> * this list of conditions and the following disclaimers.</span>
<span class="linenos"> 24</span><span class="cm"> * </span>
<span class="linenos"> 25</span><span class="cm"> * - Redistributions in binary form must reproduce the above copyright notice, </span>
<span class="linenos"> 26</span><span class="cm"> * this list of conditions and the following disclaimers in the documentation </span>
<span class="linenos"> 27</span><span class="cm"> * and/or other materials provided with the distribution.</span>
<span class="linenos"> 28</span><span class="cm"> * </span>
<span class="linenos"> 29</span><span class="cm"> * - Neither the names of the Luthey-Schulten Group, University of Illinois at</span>
<span class="linenos"> 30</span><span class="cm"> * Urbana-Champaign, the Roberts Group, Johns Hopkins University, nor the names</span>
<span class="linenos"> 31</span><span class="cm"> * of its contributors may be used to endorse or promote products derived from</span>
<span class="linenos"> 32</span><span class="cm"> * this Software without specific prior written permission.</span>
<span class="linenos"> 33</span><span class="cm"> * </span>
<span class="linenos"> 34</span><span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR </span>
<span class="linenos"> 35</span><span class="cm"> * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, </span>
<span class="linenos"> 36</span><span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL </span>
<span class="linenos"> 37</span><span class="cm"> * THE CONTRIBUTORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR </span>
<span class="linenos"> 38</span><span class="cm"> * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, </span>
<span class="linenos"> 39</span><span class="cm"> * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR </span>
<span class="linenos"> 40</span><span class="cm"> * OTHER DEALINGS WITH THE SOFTWARE.</span>
<span class="linenos"> 41</span><span class="cm"> *</span>
<span class="linenos"> 42</span><span class="cm"> * Author(s): Elijah Roberts, Mike Hallock, Zane Thornburg</span>
<span class="linenos"> 43</span><span class="cm"> */</span>
<span class="linenos"> 44</span>
<span class="linenos"> 45</span><span class="cp">#ifndef LM_RDME_MGPUINTMPDRDMESOLVER_H_</span>
<span class="linenos"> 46</span><span class="cp">#define LM_RDME_MGPUINTMPDRDMESOLVER_H_</span>
<span class="linenos"> 47</span>
<span class="linenos"> 48</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;cuda/lm_cuda.h&quot;</span>
<span class="linenos"> 49</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;core/ResourceAllocator.h&quot;</span>
<span class="linenos"> 50</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;rdme/RDMESolver.h&quot;</span>
<span class="linenos"> 51</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;rdme/CudaIntLattice.h&quot;</span>
<span class="linenos"> 52</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;rdme/GPUMapper/MultiGPUMapper.h&quot;</span>
<span class="linenos"> 53</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;rdme/GPUMapper/SegmentDescriptor.h&quot;</span>
<span class="linenos"> 54</span>
<span class="linenos"> 55</span><span class="cp">#if defined(MACOSX)</span>
<span class="linenos"> 56</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;GPUMapper/osx_barrier.h&quot;</span>
<span class="linenos"> 57</span><span class="cp">#endif</span>
<span class="linenos"> 58</span>
<span class="linenos"> 59</span><span class="cp">#define OVERFLOW_MODE_CLASSIC 0</span>
<span class="linenos"> 60</span><span class="cp">#define OVERFLOW_MODE_RELAXED 1</span>
<span class="linenos"> 61</span>
<span class="linenos"> 62</span><span class="k">using</span><span class="w"> </span><span class="n">lm</span><span class="o">::</span><span class="n">main</span><span class="o">::</span><span class="n">ResourceAllocator</span><span class="p">;</span>
<span class="linenos"> 63</span><span class="k">using</span><span class="w"> </span><span class="n">lm</span><span class="o">::</span><span class="n">rdme</span><span class="o">::</span><span class="n">RDMESolver</span><span class="p">;</span>
<span class="linenos"> 64</span><span class="k">using</span><span class="w"> </span><span class="n">lm</span><span class="o">::</span><span class="n">rdme</span><span class="o">::</span><span class="n">Lattice</span><span class="p">;</span>
<span class="linenos"> 65</span>
<span class="linenos"> 66</span><span class="k">namespace</span><span class="w"> </span><span class="nn">lm</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 67</span>
<span class="linenos"> 68</span><span class="k">namespace</span><span class="w"> </span><span class="nn">io</span><span class="p">{</span>
<span class="linenos"> 69</span><span class="k">class</span><span class="w"> </span><span class="nc">Lattice</span><span class="p">;</span>
<span class="linenos"> 70</span><span class="k">class</span><span class="w"> </span><span class="nc">SpeciesCounts</span><span class="p">;</span>
<span class="linenos"> 71</span><span class="p">}</span>
<span class="linenos"> 72</span><span class="k">namespace</span><span class="w"> </span><span class="nn">rdme</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 73</span>
<span class="linenos"> 74</span><span class="k">struct</span><span class="w"> </span><span class="nc">gpu_worker_thread_int_params</span><span class="p">;</span>
<span class="linenos"> 75</span>
<span class="linenos"> 76</span><span class="k">class</span><span class="w"> </span><span class="nc">MGPUIntMpdRdmeSolver</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">RDMESolver</span>
<span class="linenos"> 77</span><span class="p">{</span>
<span class="linenos"> 78</span><span class="w">    </span><span class="k">using</span><span class="w"> </span><span class="n">CMESolver</span><span class="o">::</span><span class="n">hookSimulation</span><span class="p">;</span>
<span class="linenos"> 79</span><span class="w">    </span><span class="k">using</span><span class="w"> </span><span class="n">RDMESolver</span><span class="o">::</span><span class="n">buildDiffusionModel</span><span class="p">;</span>
<span class="linenos"> 80</span>
<span class="linenos"> 81</span><span class="k">public</span><span class="o">:</span>
<span class="linenos"> 82</span><span class="w">    </span><span class="n">MGPUIntMpdRdmeSolver</span><span class="p">();</span>
<span class="linenos"> 83</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="o">~</span><span class="n">MGPUIntMpdRdmeSolver</span><span class="p">();</span>
<span class="linenos"> 84</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">initialize</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">replicate</span><span class="p">,</span><span class="w"> </span><span class="n">map</span><span class="o">&lt;</span><span class="n">string</span><span class="p">,</span><span class="n">string</span><span class="o">&gt;</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">parameters</span><span class="p">,</span><span class="w"> </span><span class="n">ResourceAllocator</span><span class="o">::</span><span class="n">ComputeResources</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">resources</span><span class="p">);</span>
<span class="linenos"> 85</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="nf">needsReactionModel</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;}</span>
<span class="linenos"> 86</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="nf">needsDiffusionModel</span><span class="p">()</span><span class="w">  </span><span class="p">{</span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;}</span>
<span class="linenos"> 87</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">buildModel</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">uint</span><span class="w"> </span><span class="n">numberSpeciesA</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">uint</span><span class="w"> </span><span class="n">numberReactionsA</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">uint</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">initialSpeciesCountsA</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">uint</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">reactionTypeA</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">kA</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">SA</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">uint</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">DA</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">uint</span><span class="w"> </span><span class="n">kCols</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span>
<span class="linenos"> 88</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">buildDiffusionModel</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">uint</span><span class="w"> </span><span class="n">numberSiteTypesA</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">DFA</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">uint</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">RLA</span><span class="p">,</span><span class="w"> </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">latticeXSize</span><span class="p">,</span><span class="w"> </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">latticeYSize</span><span class="p">,</span><span class="w"> </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">latticeZSize</span><span class="p">,</span><span class="w"> </span><span class="n">site_size_t</span><span class="w"> </span><span class="n">particlesPerSite</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">bytes_per_particle</span><span class="p">,</span><span class="w"> </span><span class="n">si_dist_t</span><span class="w"> </span><span class="n">latticeSpacing</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">latticeData</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">latticeSitesData</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">rowMajorData</span><span class="o">=</span><span class="nb">true</span><span class="p">);</span>
<span class="linenos"> 89</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">generateTrajectory</span><span class="p">();</span>
<span class="linenos"> 90</span><span class="w">	</span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setReactionRate</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">rxid</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">rate</span><span class="p">);</span>
<span class="linenos"> 91</span>
<span class="linenos"> 92</span><span class="k">protected</span><span class="o">:</span>
<span class="linenos"> 93</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">allocateLattice</span><span class="p">(</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">latticeXSize</span><span class="p">,</span><span class="w"> </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">latticeYSize</span><span class="p">,</span><span class="w"> </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">latticeZSize</span><span class="p">,</span><span class="w"> </span><span class="n">site_size_t</span><span class="w"> </span><span class="n">particlesPerSite</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">bytes_per_particle</span><span class="p">,</span><span class="w"> </span><span class="n">si_dist_t</span><span class="w"> </span><span class="n">latticeSpacing</span><span class="p">);</span>
<span class="linenos"> 94</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">writeLatticeData</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="n">CudaIntLattice</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">lattice</span><span class="p">,</span><span class="w"> </span><span class="n">lm</span><span class="o">::</span><span class="n">io</span><span class="o">::</span><span class="n">Lattice</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">latticeDataSet</span><span class="p">);</span>
<span class="linenos"> 95</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">writeLatticeSites</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="n">CudaIntLattice</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">lattice</span><span class="p">);</span>
<span class="linenos"> 96</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">recordSpeciesCounts</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="n">CudaIntLattice</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">lattice</span><span class="p">,</span><span class="w"> </span><span class="n">lm</span><span class="o">::</span><span class="n">io</span><span class="o">::</span><span class="n">SpeciesCounts</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">speciesCountsDataSet</span><span class="p">);</span>
<span class="linenos"> 97</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">writeSpeciesCounts</span><span class="p">(</span><span class="n">lm</span><span class="o">::</span><span class="n">io</span><span class="o">::</span><span class="n">SpeciesCounts</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">speciesCountsDataSet</span><span class="p">);</span>
<span class="linenos"> 98</span><span class="w">	</span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">hookCheckSimulation</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="n">CudaIntLattice</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">lattice</span><span class="p">);</span>
<span class="linenos"> 99</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">run_next_timestep</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">gpu</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">timestep</span><span class="p">);</span>
<span class="linenos">100</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">uint64_t</span><span class="w"> </span><span class="nf">getTimestepSeed</span><span class="p">(</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">timestep</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">substep</span><span class="p">);</span>
<span class="linenos">101</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setLatticeData</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="o">*</span><span class="w"> </span><span class="n">latticeData</span><span class="p">);</span>
<span class="linenos">102</span><span class="w">    </span>
<span class="linenos">103</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">copyModelsToDevice</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">gpu</span><span class="p">);</span>
<span class="linenos">104</span><span class="w">	</span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">initialize_decomposition</span><span class="p">();</span>
<span class="linenos">105</span><span class="w">	</span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">start_threads</span><span class="p">();</span>
<span class="linenos">106</span><span class="w">	</span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">stop_threads</span><span class="p">();</span>
<span class="linenos">107</span><span class="w">	</span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">computePropensities</span><span class="p">();</span>
<span class="linenos">108</span>
<span class="linenos">109</span><span class="w">	</span><span class="c1">// declare the child thread entry point as a friend function</span>
<span class="linenos">110</span><span class="w">	</span><span class="c1">// so that it may call the run_thread method</span>
<span class="linenos">111</span><span class="w">	</span><span class="k">friend</span><span class="w"> </span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="nf">gpu_worker_thread_int</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">arg</span><span class="p">);</span>
<span class="linenos">112</span><span class="w">	</span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="nf">run_thread</span><span class="p">(</span><span class="kt">int</span><span class="p">);</span>
<span class="linenos">113</span><span class="w">	</span><span class="k">virtual</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">handle_all_overflows</span><span class="p">();</span>
<span class="linenos">114</span><span class="w">	</span><span class="k">virtual</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">handle_overflows</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">gpu</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">hptr</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">dptr</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ts</span><span class="p">);</span>
<span class="linenos">115</span><span class="w">	</span><span class="k">virtual</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">hookSimulation</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="n">CudaIntLattice</span><span class="w"> </span><span class="o">*</span><span class="n">lattice</span><span class="p">);</span>
<span class="linenos">116</span>
<span class="linenos">117</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">calculateXLaunchParameters</span><span class="p">(</span><span class="n">dim3</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">gridSize</span><span class="p">,</span><span class="w"> </span><span class="n">dim3</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">threadBlockSize</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">maxXBlockSize</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeXSize</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeYSize</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeZSize</span><span class="p">);</span>
<span class="linenos">118</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">calculateYLaunchParameters</span><span class="p">(</span><span class="n">dim3</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">gridSize</span><span class="p">,</span><span class="w"> </span><span class="n">dim3</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">threadBlockSize</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">blockXSize</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">blockYSize</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeXSize</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeYSize</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeZSize</span><span class="p">);</span>
<span class="linenos">119</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">calculateZLaunchParameters</span><span class="p">(</span><span class="n">dim3</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">gridSize</span><span class="p">,</span><span class="w"> </span><span class="n">dim3</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">threadBlockSize</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">blockXSize</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">blockZSize</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeXSize</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeYSize</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeZSize</span><span class="p">);</span>
<span class="linenos">120</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">calculateReactionLaunchParameters</span><span class="p">(</span><span class="n">dim3</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">gridSize</span><span class="p">,</span><span class="w"> </span><span class="n">dim3</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">threadBlockSize</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">blockXSize</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">blockYSize</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeXSize</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeYSize</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeZSize</span><span class="p">);</span>
<span class="linenos">121</span>
<span class="linenos">122</span><span class="k">protected</span><span class="o">:</span>
<span class="linenos">123</span><span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">seed</span><span class="p">;</span>
<span class="linenos">124</span><span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">tau</span><span class="p">;</span>
<span class="linenos">125</span>
<span class="linenos">126</span><span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">overflowTimesteps</span><span class="p">;</span>
<span class="linenos">127</span><span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">overflowListUses</span><span class="p">;</span>
<span class="linenos">128</span><span class="w">    </span><span class="kt">int</span><span class="w">      </span><span class="n">overflow_handling</span><span class="p">;</span>
<span class="linenos">129</span>
<span class="linenos">130</span><span class="w">	</span><span class="c1">// Stored model parameters for const memory</span>
<span class="linenos">131</span><span class="w">	</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">model_reactionOrders</span><span class="p">;</span>
<span class="linenos">132</span><span class="w">	</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">model_reactionSites</span><span class="p">;</span>
<span class="linenos">133</span><span class="w">	</span><span class="kt">float</span><span class="o">*</span><span class="w">        </span><span class="n">model_reactionRates</span><span class="p">;</span>
<span class="linenos">134</span>
<span class="linenos">135</span><span class="w">	</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">model_D1</span><span class="p">;</span>
<span class="linenos">136</span><span class="w">	</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">model_D2</span><span class="p">;</span>
<span class="linenos">137</span>
<span class="linenos">138</span><span class="w">	</span><span class="kt">int8_t</span><span class="o">*</span><span class="w">  </span><span class="n">model_S</span><span class="p">;</span>
<span class="linenos">139</span><span class="w">	</span><span class="kt">float</span><span class="o">*</span><span class="w">   </span><span class="n">model_T</span><span class="p">;</span>
<span class="linenos">140</span><span class="w">	</span><span class="kt">uint8_t</span><span class="o">*</span><span class="w"> </span><span class="n">model_RL</span><span class="p">;</span>
<span class="linenos">141</span>
<span class="linenos">142</span><span class="w">	</span><span class="kt">size_t</span><span class="w"> </span><span class="n">zeroOrderSize</span><span class="p">,</span><span class="w"> </span><span class="n">firstOrderSize</span><span class="p">,</span><span class="w"> </span><span class="n">secondOrderSize</span><span class="p">;</span>
<span class="linenos">143</span><span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="n">zeroOrder</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">firstOrder</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">secondOrder</span><span class="p">;</span>
<span class="linenos">144</span>
<span class="linenos">145</span><span class="w">	</span><span class="n">pthread_barrier_t</span><span class="w"> </span><span class="n">start_barrier</span><span class="p">,</span><span class="w"> </span><span class="n">stop_barrier</span><span class="p">,</span><span class="w"> </span><span class="n">simulation_barrier</span><span class="p">;</span>
<span class="linenos">146</span><span class="w">	</span><span class="n">pthread_barrier_t</span><span class="w"> </span><span class="n">overflow_barrier1</span><span class="p">,</span><span class="w"> </span><span class="n">overflow_barrier2</span><span class="p">;</span>
<span class="linenos">147</span><span class="w">	</span><span class="n">MultiGPUMapper</span><span class="w"> </span><span class="o">*</span><span class="n">mapper</span><span class="p">;</span>
<span class="linenos">148</span><span class="w">	</span><span class="n">ResourceAllocator</span><span class="o">::</span><span class="n">ComputeResources</span><span class="w"> </span><span class="o">*</span><span class="n">resources</span><span class="p">;</span>
<span class="linenos">149</span><span class="w">	</span><span class="n">gpu_worker_thread_int_params</span><span class="w"> </span><span class="o">*</span><span class="n">threads</span><span class="p">;</span>
<span class="linenos">150</span>
<span class="linenos">151</span><span class="w">	</span><span class="kt">int</span><span class="w"> </span><span class="n">timesteps_to_run</span><span class="p">;</span>
<span class="linenos">152</span><span class="w">	</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">current_timestep</span><span class="p">;</span>
<span class="linenos">153</span><span class="w">	</span><span class="kt">bool</span><span class="w"> </span><span class="n">reactionModelModified</span><span class="p">;</span>
<span class="linenos">154</span><span class="w">	</span><span class="kt">double</span><span class="w"> </span><span class="n">printPerfInterval</span><span class="p">;</span>
<span class="linenos">155</span><span class="w">	</span>
<span class="linenos">156</span><span class="w">	</span><span class="kt">bool</span><span class="w"> </span><span class="n">aggcopy_x_unpack</span><span class="p">;</span>
<span class="linenos">157</span><span class="w">	</span><span class="kt">bool</span><span class="w"> </span><span class="n">aggcopy_r_pack</span><span class="p">;</span>
<span class="linenos">158</span><span class="w">	</span><span class="kt">bool</span><span class="w"> </span><span class="n">use_spin_barrier</span><span class="p">;</span>
<span class="linenos">159</span><span class="p">};</span>
<span class="linenos">160</span>
<span class="linenos">161</span><span class="k">struct</span><span class="w"> </span><span class="nc">gpu_worker_thread_int_params</span>
<span class="linenos">162</span><span class="p">{</span>
<span class="linenos">163</span><span class="w">    </span><span class="n">pthread_t</span><span class="w"> </span><span class="kr">thread</span><span class="p">;</span>
<span class="linenos">164</span><span class="w">    </span><span class="c1">//MultiCUDALattice *lattice;</span>
<span class="linenos">165</span><span class="w">    </span><span class="n">MGPUIntMpdRdmeSolver</span><span class="w"> </span><span class="o">*</span><span class="n">runner</span><span class="p">;</span>
<span class="linenos">166</span><span class="w">    </span><span class="n">MultiGPUMapper</span><span class="w"> </span><span class="o">*</span><span class="n">mapper</span><span class="p">;</span>
<span class="linenos">167</span><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">gpu</span><span class="p">;</span>
<span class="linenos">168</span><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">ngpus</span><span class="p">;</span>
<span class="linenos">169</span><span class="w">    </span><span class="n">pthread_barrier_t</span><span class="w"> </span><span class="o">*</span><span class="n">runner_sync</span><span class="p">;</span>
<span class="linenos">170</span><span class="w">    </span><span class="n">pthread_barrier_t</span><span class="w"> </span><span class="o">*</span><span class="n">worker_sync</span><span class="p">;</span>
<span class="linenos">171</span><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">timesteps_to_run</span><span class="p">;</span>
<span class="linenos">172</span><span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">lattice_synched</span><span class="p">;</span>
<span class="linenos">173</span><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">load_balance_counter</span><span class="p">;</span>
<span class="linenos">174</span>
<span class="linenos">175</span><span class="w">	</span><span class="c1">// cuda objects</span>
<span class="linenos">176</span><span class="w">	</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">dLattice</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">dLatticeTmp</span><span class="p">;</span>
<span class="linenos">177</span><span class="w">	</span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="n">dSites</span><span class="p">;</span>
<span class="linenos">178</span><span class="w">	</span><span class="n">cudaStream_t</span><span class="w"> </span><span class="n">stream1</span><span class="p">;</span>
<span class="linenos">179</span><span class="w">	</span><span class="n">cudaEvent_t</span><span class="w"> </span><span class="n">x_finish</span><span class="p">,</span><span class="w"> </span><span class="n">diffusion_finished</span><span class="p">,</span><span class="w"> </span><span class="n">rx_finish</span><span class="p">;</span>
<span class="linenos">180</span><span class="w">	</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">h_overflows</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">d_overflows</span><span class="p">;</span>
<span class="linenos">181</span>
<span class="linenos">182</span><span class="w">	</span><span class="c1">// kernel launch params</span>
<span class="linenos">183</span><span class="w">	</span><span class="n">dim3</span><span class="w"> </span><span class="n">grid_x</span><span class="p">,</span><span class="w"> </span><span class="n">grid_y</span><span class="p">,</span><span class="w"> </span><span class="n">grid_z</span><span class="p">,</span><span class="w"> </span><span class="n">grid_r</span><span class="p">;</span>
<span class="linenos">184</span><span class="w">	</span><span class="n">dim3</span><span class="w"> </span><span class="n">threads_x</span><span class="p">,</span><span class="w"> </span><span class="n">threads_y</span><span class="p">,</span><span class="w"> </span><span class="n">threads_z</span><span class="p">,</span><span class="w"> </span><span class="n">threads_r</span><span class="p">;</span>
<span class="linenos">185</span>
<span class="linenos">186</span><span class="w">	</span><span class="c1">// lattice segment geometry provided by the mapper</span>
<span class="linenos">187</span><span class="w">    </span><span class="n">SegmentDescriptor_s</span><span class="w"> </span><span class="o">*</span><span class="n">segment</span><span class="p">;</span>
<span class="linenos">188</span>
<span class="linenos">189</span><span class="cp">#ifdef MPD_GLOBAL_S_MATRIX</span>
<span class="linenos">190</span><span class="w">	</span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="n">RLG</span><span class="p">;</span><span class="w">   </span><span class="c1">// Device global memory pointer for RL matrix</span>
<span class="linenos">191</span><span class="w">	</span><span class="kt">int8_t</span><span class="w"> </span><span class="o">*</span><span class="n">SG</span><span class="p">;</span><span class="w">     </span><span class="c1">// Device global memory pointer for S matrix</span>
<span class="linenos">192</span><span class="cp">#endif</span>
<span class="linenos">193</span><span class="cp">#ifdef MPD_GLOBAL_T_MATRIX</span>
<span class="linenos">194</span><span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="n">TG</span><span class="p">;</span>
<span class="linenos">195</span><span class="cp">#endif</span>
<span class="linenos">196</span>
<span class="linenos">197</span><span class="cp">#ifdef MPD_GLOBAL_R_MATRIX</span>
<span class="linenos">198</span><span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="n">reactionRatesG</span><span class="p">;</span>
<span class="linenos">199</span><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">reactionOrdersG</span><span class="p">;</span>
<span class="linenos">200</span><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">reactionSitesG</span><span class="p">;</span>
<span class="linenos">201</span><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">D1G</span><span class="p">;</span>
<span class="linenos">202</span><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">D2G</span><span class="p">;</span>
<span class="linenos">203</span><span class="cp">#endif</span>
<span class="linenos">204</span>
<span class="linenos">205</span><span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="n">propZeroOrder</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">propFirstOrder</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">propSecondOrder</span><span class="p">;</span>
<span class="linenos">206</span><span class="w">	</span>
<span class="linenos">207</span>
<span class="linenos">208</span><span class="p">};</span>
<span class="linenos">209</span>
<span class="linenos">210</span>
<span class="linenos">211</span>
<span class="linenos">212</span><span class="k">namespace</span><span class="w"> </span><span class="nn">mgpuintmpdrdme_dev</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">213</span><span class="n">__device__</span><span class="w"> </span><span class="kr">inline</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">local_to_global</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">z</span><span class="p">);</span>
<span class="linenos">214</span><span class="n">__device__</span><span class="w"> </span><span class="kr">inline</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">local_index</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">z</span><span class="p">);</span>
<span class="linenos">215</span><span class="n">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">correct_overflows_mgpu</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">lattice</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">);</span>
<span class="linenos">216</span>
<span class="linenos">217</span><span class="cp">#ifdef MPD_GLOBAL_S_MATRIX</span>
<span class="linenos">218</span><span class="cp">#ifdef MPD_GLOBAL_R_MATRIX</span>
<span class="linenos">219</span><span class="n">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">MGPU_precomp_reaction_kernel</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">inLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">inSites</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">outLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">z_start</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="kt">int8_t</span><span class="w"> </span><span class="o">*</span><span class="n">SG</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="n">RLG</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="n">reactionOrderG</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="n">reactionSitesG</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="n">D1G</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="n">D2G</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="n">reactionRatesG</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="n">qp0</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="n">qp1</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="n">qp2</span><span class="p">);</span>
<span class="linenos">220</span><span class="cp">#else</span>
<span class="linenos">221</span><span class="n">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">MGPU_precomp_reaction_kernel</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">inLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">inSites</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">outLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">z_start</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="kt">int8_t</span><span class="w"> </span><span class="o">*</span><span class="n">SG</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="n">RLG</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="n">qp0</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="n">qp1</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="n">qp2</span><span class="p">);</span>
<span class="linenos">222</span><span class="cp">#endif</span>
<span class="linenos">223</span><span class="cp">#else</span>
<span class="linenos">224</span><span class="n">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">MGPU_precomp_reaction_kernel</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">inLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">inSites</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">outLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">z_start</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="n">qp0</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="n">qp1</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="n">qp2</span><span class="p">);</span>
<span class="linenos">225</span><span class="cp">#endif</span>
<span class="linenos">226</span>
<span class="linenos">227</span>
<span class="linenos">228</span><span class="cp">#ifdef MPD_GLOBAL_S_MATRIX</span>
<span class="linenos">229</span><span class="cp">#ifdef MPD_GLOBAL_R_MATRIX</span>
<span class="linenos">230</span><span class="n">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">MGPU_precomp_reaction_kernel_packing</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">inLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">inSites</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">outLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">z_start</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="kt">int8_t</span><span class="w"> </span><span class="o">*</span><span class="n">SG</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="n">RLG</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="n">reactionOrdersG</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="n">reactionSitesG</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="n">D1G</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="n">D2G</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="n">reactionRatesG</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="n">qp0</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="n">qp1</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="n">qp2</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">buf_top</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">buf_bot</span><span class="p">);</span>
<span class="linenos">231</span><span class="cp">#else</span>
<span class="linenos">232</span><span class="n">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">MGPU_precomp_reaction_kernel_packing</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">inLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">inSites</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">outLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">z_start</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="kt">int8_t</span><span class="w"> </span><span class="o">*</span><span class="n">SG</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="n">RLG</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="n">qp0</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="n">qp1</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="n">qp2</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">buf_top</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">buf_bot</span><span class="p">);</span>
<span class="linenos">233</span><span class="cp">#endif</span>
<span class="linenos">234</span><span class="cp">#else</span>
<span class="linenos">235</span><span class="n">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">MGPU_precomp_reaction_kernel_packing</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">inLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">inSites</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">outLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">z_start</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="n">qp0</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="n">qp1</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="n">qp2</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">buf_top</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">buf_bot</span><span class="p">);</span>
<span class="linenos">236</span><span class="cp">#endif</span>
<span class="linenos">237</span>
<span class="linenos">238</span><span class="n">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">MGPU_x_kernel_unpack</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">inLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">inSites</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">outLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">z_start</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">buf_top</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">buf_bot</span><span class="p">);</span>
<span class="linenos">239</span>
<span class="linenos">240</span><span class="n">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">MGPU_x_kernel</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">inLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">inSites</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">outLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">z_start</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">);</span>
<span class="linenos">241</span><span class="n">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">MGPU_y_kernel</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">inLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">inSites</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">outLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">);</span>
<span class="linenos">242</span><span class="n">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">MGPU_z_kernel</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">inLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">inSites</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">outLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">z_start</span><span class="p">);</span>
<span class="linenos">243</span><span class="cp">#ifdef MPD_GLOBAL_S_MATRIX</span>
<span class="linenos">244</span><span class="cp">#ifdef MPD_GLOBAL_R_MATRIX</span>
<span class="linenos">245</span><span class="n">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">MGPU_reaction_kernel</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">inLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">inSites</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">outLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">z_start</span><span class="p">,</span><span class="w">   </span><span class="k">const</span><span class="w"> </span><span class="kt">int8_t</span><span class="o">*</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="n">SG</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="o">*</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="n">RLG</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="n">reactionOrdersG</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="n">reactionSitesG</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="n">D1G</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="n">D2G</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="n">reactionRatesG</span><span class="p">);</span>
<span class="linenos">246</span><span class="cp">#else</span>
<span class="linenos">247</span><span class="n">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">MGPU_reaction_kernel</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">inLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">inSites</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">outLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">z_start</span><span class="p">,</span><span class="w">   </span><span class="k">const</span><span class="w"> </span><span class="kt">int8_t</span><span class="o">*</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="n">SG</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="o">*</span><span class="w"> </span><span class="n">__restrict__</span><span class="w"> </span><span class="n">RLG</span><span class="p">);</span>
<span class="linenos">248</span><span class="cp">#endif</span>
<span class="linenos">249</span><span class="cp">#else</span>
<span class="linenos">250</span><span class="n">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">MGPU_reaction_kernel</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">inLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">inSites</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">outLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">z_start</span><span class="p">);</span>
<span class="linenos">251</span><span class="cp">#endif</span>
<span class="linenos">252</span>
<span class="linenos">253</span>
<span class="linenos">254</span><span class="p">}</span>
<span class="linenos">255</span>
<span class="linenos">256</span><span class="p">}</span>
<span class="linenos">257</span><span class="p">}</span>
<span class="linenos">258</span>
<span class="linenos">259</span><span class="cp">#endif</span>
</pre></div>
</div>
</section>
<section id="mgpuintmpdrdmesolver-cu">
<h3>MGPUIntMpdRdmeSolver.cu<a class="headerlink" href="#mgpuintmpdrdmesolver-cu" title="Link to this heading">#</a></h3>
<div class="highlight-cuda notranslate"><div class="highlight"><pre><span></span><span class="linenos">   1</span><span class="cm">/*</span>
<span class="linenos">   2</span><span class="cm"> * University of Illinois Open Source License</span>
<span class="linenos">   3</span><span class="cm"> * Copyright 2008-2018 Luthey-Schulten Group,</span>
<span class="linenos">   4</span><span class="cm"> * Copyright 2012 Roberts Group,</span>
<span class="linenos">   5</span><span class="cm"> * All rights reserved.</span>
<span class="linenos">   6</span><span class="cm"> * </span>
<span class="linenos">   7</span><span class="cm"> * Developed by: Luthey-Schulten Group</span>
<span class="linenos">   8</span><span class="cm"> *               University of Illinois at Urbana-Champaign</span>
<span class="linenos">   9</span><span class="cm"> *               http://www.scs.uiuc.edu/~schulten</span>
<span class="linenos">  10</span><span class="cm"> * </span>
<span class="linenos">  11</span><span class="cm"> * Developed by: Roberts Group</span>
<span class="linenos">  12</span><span class="cm"> *               Johns Hopkins University</span>
<span class="linenos">  13</span><span class="cm"> *               http://biophysics.jhu.edu/roberts/</span>
<span class="linenos">  14</span><span class="cm"> *</span>
<span class="linenos">  15</span><span class="cm"> * Permission is hereby granted, free of charge, to any person obtaining a copy of</span>
<span class="linenos">  16</span><span class="cm"> * this software and associated documentation files (the Software), to deal with </span>
<span class="linenos">  17</span><span class="cm"> * the Software without restriction, including without limitation the rights to </span>
<span class="linenos">  18</span><span class="cm"> * use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies </span>
<span class="linenos">  19</span><span class="cm"> * of the Software, and to permit persons to whom the Software is furnished to </span>
<span class="linenos">  20</span><span class="cm"> * do so, subject to the following conditions:</span>
<span class="linenos">  21</span><span class="cm"> * </span>
<span class="linenos">  22</span><span class="cm"> * - Redistributions of source code must retain the above copyright notice, </span>
<span class="linenos">  23</span><span class="cm"> * this list of conditions and the following disclaimers.</span>
<span class="linenos">  24</span><span class="cm"> * </span>
<span class="linenos">  25</span><span class="cm"> * - Redistributions in binary form must reproduce the above copyright notice, </span>
<span class="linenos">  26</span><span class="cm"> * this list of conditions and the following disclaimers in the documentation </span>
<span class="linenos">  27</span><span class="cm"> * and/or other materials provided with the distribution.</span>
<span class="linenos">  28</span><span class="cm"> * </span>
<span class="linenos">  29</span><span class="cm"> * - Neither the names of the Luthey-Schulten Group, University of Illinois at</span>
<span class="linenos">  30</span><span class="cm"> * Urbana-Champaign, the Roberts Group, Johns Hopkins University, nor the names</span>
<span class="linenos">  31</span><span class="cm"> * of its contributors may be used to endorse or promote products derived from</span>
<span class="linenos">  32</span><span class="cm"> * this Software without specific prior written permission.</span>
<span class="linenos">  33</span><span class="cm"> * </span>
<span class="linenos">  34</span><span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR </span>
<span class="linenos">  35</span><span class="cm"> * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, </span>
<span class="linenos">  36</span><span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL </span>
<span class="linenos">  37</span><span class="cm"> * THE CONTRIBUTORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR </span>
<span class="linenos">  38</span><span class="cm"> * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, </span>
<span class="linenos">  39</span><span class="cm"> * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR </span>
<span class="linenos">  40</span><span class="cm"> * OTHER DEALINGS WITH THE SOFTWARE.</span>
<span class="linenos">  41</span><span class="cm"> *</span>
<span class="linenos">  42</span><span class="cm"> * Author(s): Mike Hallock, Zane Thornburg</span>
<span class="linenos">  43</span><span class="cm"> */</span>
<span class="linenos">  44</span>
<span class="linenos">  45</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;map&gt;</span>
<span class="linenos">  46</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;string&gt;</span>
<span class="linenos">  47</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;cstdlib&gt;</span>
<span class="linenos">  48</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;config.h&quot;</span>
<span class="linenos">  49</span><span class="cp">#if defined(MACOSX)</span>
<span class="linenos">  50</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;mach/mach_time.h&gt;</span>
<span class="linenos">  51</span><span class="cp">#elif defined(LINUX)</span>
<span class="linenos">  52</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;time.h&gt;</span>
<span class="linenos">  53</span><span class="cp">#endif</span>
<span class="linenos">  54</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;cuda/lm_cuda.h&quot;</span>
<span class="linenos">  55</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;cuda/ldg.h&quot;</span>
<span class="linenos">  56</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;core/Math.h&quot;</span>
<span class="linenos">  57</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;core/Print.h&quot;</span>
<span class="linenos">  58</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;cme/CMESolver.h&quot;</span>
<span class="linenos">  59</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;DiffusionModel.pb.h&quot;</span>
<span class="linenos">  60</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;Lattice.pb.h&quot;</span>
<span class="linenos">  61</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;SpeciesCounts.pb.h&quot;</span>
<span class="linenos">  62</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;core/DataOutputQueue.h&quot;</span>
<span class="linenos">  63</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;core/ResourceAllocator.h&quot;</span>
<span class="linenos">  64</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;rdme/ByteLattice.h&quot;</span>
<span class="linenos">  65</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;rdme/IntLattice.h&quot;</span>
<span class="linenos">  66</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;rdme/CudaIntLattice.h&quot;</span>
<span class="linenos">  67</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;rdme/MGPUIntMpdRdmeSolver.h&quot;</span>
<span class="linenos">  68</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;rng/RandomGenerator.h&quot;</span>
<span class="linenos">  69</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;lptf/Profile.h&quot;</span>
<span class="linenos">  70</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;core/Timer.h&quot;</span>
<span class="linenos">  71</span>
<span class="linenos">  72</span><span class="cp">#define MPD_WORDS_PER_SITE              (MPD_LATTICE_MAX_OCCUPANCY) </span><span class="c1">// 4</span>
<span class="linenos">  73</span><span class="cp">#define MPD_APRON_SIZE                  1</span>
<span class="linenos">  74</span>
<span class="linenos">  75</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;cuda/constant.cuh&quot;</span>
<span class="linenos">  76</span><span class="n">namespace</span><span class="w"> </span><span class="n">lm</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">  77</span><span class="n">namespace</span><span class="w"> </span><span class="n">rdme</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">  78</span><span class="n">namespace</span><span class="w"> </span><span class="n">mgpuintmpdrdme_dev</span><span class="p">{</span>
<span class="linenos">  79</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;rdme/dev/xor_random_dev.cu&quot;</span>
<span class="linenos">  80</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;rdme/dev/lattice_sim_1d_dev.cu&quot;</span>
<span class="linenos">  81</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;rdme/dev/word_diffusion_1d_dev.cu&quot;</span>
<span class="linenos">  82</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;rdme/dev/word_reaction_dev.cu&quot;</span>
<span class="linenos">  83</span><span class="p">}}}</span>
<span class="linenos">  84</span>
<span class="linenos">  85</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;rdme/GPUMapper/MultiGPUMapper.h&quot;</span>
<span class="linenos">  86</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;rdme/GPUMapper/SegmentDescriptor.h&quot;</span>
<span class="linenos">  87</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;rdme/GPUMapper/ZDivMultiGPUMapper.h&quot;</span>
<span class="linenos">  88</span>
<span class="linenos">  89</span><span class="cp">#define L3INDEX(_x,_y,_z, _g) ((_x)+((_y)*(_g.x))+((_z)*(_g.x)*(_g.y)))</span>
<span class="linenos">  90</span>
<span class="linenos">  91</span>
<span class="linenos">  92</span><span class="k">extern</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">globalAbort</span><span class="p">;</span>
<span class="linenos">  93</span>
<span class="linenos">  94</span>
<span class="linenos">  95</span><span class="n">using</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="p">;</span>
<span class="linenos">  96</span><span class="n">using</span><span class="w"> </span><span class="n">lm</span><span class="o">::</span><span class="n">io</span><span class="o">::</span><span class="n">DiffusionModel</span><span class="p">;</span>
<span class="linenos">  97</span><span class="n">using</span><span class="w"> </span><span class="n">lm</span><span class="o">::</span><span class="n">rdme</span><span class="o">::</span><span class="n">Lattice</span><span class="p">;</span>
<span class="linenos">  98</span><span class="n">using</span><span class="w"> </span><span class="n">lm</span><span class="o">::</span><span class="n">rng</span><span class="o">::</span><span class="n">RandomGenerator</span><span class="p">;</span>
<span class="linenos">  99</span>
<span class="linenos"> 100</span><span class="n">namespace</span><span class="w"> </span><span class="n">lm</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 101</span><span class="n">namespace</span><span class="w"> </span><span class="n">rdme</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 102</span>
<span class="linenos"> 103</span>
<span class="linenos"> 104</span><span class="k">volatile</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">mclkr_int_overflow_counter</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<span class="linenos"> 105</span><span class="k">volatile</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">mclkr_int_total_overflows</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<span class="linenos"> 106</span><span class="k">volatile</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">mclkr_int_overflow_reporters</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<span class="linenos"> 107</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">mclkr_int_worker_count</span><span class="p">;</span>
<span class="linenos"> 108</span><span class="n">pthread_mutex_t</span><span class="w"> </span><span class="n">mclkr_int_overflow_mutex</span><span class="o">=</span><span class="n">PTHREAD_MUTEX_INITIALIZER</span><span class="p">;</span>
<span class="linenos"> 109</span><span class="n">pthread_cond_t</span><span class="w"> </span><span class="n">mclkr_int_overflow_cond</span><span class="o">=</span><span class="n">PTHREAD_COND_INITIALIZER</span><span class="p">;</span>
<span class="linenos"> 110</span>
<span class="linenos"> 111</span><span class="k">volatile</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">mclkr_int_generation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos"> 112</span><span class="n">pthread_spinlock_t</span><span class="w"> </span><span class="n">mclkr_int_spin</span><span class="p">;</span>
<span class="linenos"> 113</span>
<span class="linenos"> 114</span>
<span class="linenos"> 115</span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="nf">gpu_worker_thread_int</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="linenos"> 116</span><span class="p">{</span>
<span class="linenos"> 117</span><span class="w">	</span><span class="n">Print</span><span class="o">::</span><span class="n">printf</span><span class="p">(</span><span class="n">Print</span><span class="o">::</span><span class="n">VERBOSE_DEBUG</span><span class="p">,</span><span class="s">&quot;thread %p launched with arg %p&quot;</span><span class="p">,</span><span class="n">pthread_self</span><span class="p">(),</span><span class="w"> </span><span class="n">arg</span><span class="p">);</span>
<span class="linenos"> 118</span><span class="w">	</span><span class="n">gpu_worker_thread_int_params</span><span class="w"> </span><span class="o">*</span><span class="n">params</span><span class="o">=</span><span class="p">(</span><span class="n">gpu_worker_thread_int_params</span><span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>
<span class="linenos"> 119</span><span class="w">	</span><span class="n">MGPUIntMpdRdmeSolver</span><span class="w"> </span><span class="o">*</span><span class="n">solver</span><span class="o">=</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">runner</span><span class="p">;</span>
<span class="linenos"> 120</span>
<span class="linenos"> 121</span><span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="n">solver</span><span class="o">-&gt;</span><span class="n">run_thread</span><span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">gpu</span><span class="p">);</span>
<span class="linenos"> 122</span><span class="p">}</span>
<span class="linenos"> 123</span>
<span class="linenos"> 124</span><span class="kr">inline</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">mclkr_int_barrier_spin</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">overflows</span><span class="p">)</span>
<span class="linenos"> 125</span><span class="p">{</span>
<span class="linenos"> 126</span><span class="w">	</span><span class="n">PROF_BEGIN</span><span class="p">(</span><span class="n">MPD_MCLKR_BARRIER</span><span class="p">);</span>
<span class="linenos"> 127</span>
<span class="linenos"> 128</span><span class="w">	</span><span class="kt">int</span><span class="w"> </span><span class="n">gen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mclkr_int_generation</span><span class="p">;</span>
<span class="linenos"> 129</span><span class="w">	</span><span class="n">pthread_spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mclkr_int_spin</span><span class="p">);</span>
<span class="linenos"> 130</span>
<span class="linenos"> 131</span><span class="w">    </span><span class="c1">// Update shared counters</span>
<span class="linenos"> 132</span><span class="w">    </span><span class="n">mclkr_int_overflow_reporters</span><span class="o">++</span><span class="p">;</span>
<span class="linenos"> 133</span><span class="w">    </span><span class="n">mclkr_int_overflow_counter</span><span class="o">+=</span><span class="n">overflows</span><span class="p">;</span>
<span class="linenos"> 134</span>
<span class="linenos"> 135</span><span class="w">	</span><span class="n">pthread_spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mclkr_int_spin</span><span class="p">);</span>
<span class="linenos"> 136</span>
<span class="linenos"> 137</span><span class="w">    </span><span class="c1">// simulate barrier</span>
<span class="linenos"> 138</span><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">mclkr_int_overflow_reporters</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">mclkr_int_worker_count</span><span class="p">)</span>
<span class="linenos"> 139</span><span class="w">    </span><span class="p">{</span>
<span class="linenos"> 140</span><span class="w">        </span><span class="n">mclkr_int_total_overflows</span><span class="o">=</span><span class="n">mclkr_int_overflow_counter</span><span class="p">;</span>
<span class="linenos"> 141</span><span class="w">        </span><span class="n">mclkr_int_overflow_reporters</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<span class="linenos"> 142</span><span class="w">		</span><span class="n">mclkr_int_generation</span><span class="o">++</span><span class="p">;</span>
<span class="linenos"> 143</span><span class="w">    </span><span class="p">}</span>
<span class="linenos"> 144</span><span class="w">    </span><span class="k">else</span>
<span class="linenos"> 145</span><span class="w">    </span><span class="p">{</span>
<span class="linenos"> 146</span><span class="w">		</span><span class="k">while</span><span class="p">(</span><span class="n">mclkr_int_generation</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">gen</span><span class="p">)</span><span class="w"> </span><span class="p">{}</span><span class="w"> </span>
<span class="linenos"> 147</span><span class="w">    </span><span class="p">}</span>
<span class="linenos"> 148</span>
<span class="linenos"> 149</span><span class="w">	</span><span class="n">PROF_END</span><span class="p">(</span><span class="n">MPD_MCLKR_BARRIER</span><span class="p">);</span>
<span class="linenos"> 150</span><span class="p">}</span>
<span class="linenos"> 151</span>
<span class="linenos"> 152</span><span class="kr">inline</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">mclkr_int_barrier_cond</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">overflows</span><span class="p">)</span>
<span class="linenos"> 153</span><span class="p">{</span>
<span class="linenos"> 154</span><span class="w">	</span><span class="n">PROF_BEGIN</span><span class="p">(</span><span class="n">MPD_MCLKR_BARRIER</span><span class="p">);</span>
<span class="linenos"> 155</span>
<span class="linenos"> 156</span><span class="w">	</span><span class="n">pthread_mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mclkr_int_overflow_mutex</span><span class="p">);</span>
<span class="linenos"> 157</span>
<span class="linenos"> 158</span><span class="w">    </span><span class="c1">// Update shared counters</span>
<span class="linenos"> 159</span><span class="w">    </span><span class="n">mclkr_int_overflow_reporters</span><span class="o">++</span><span class="p">;</span>
<span class="linenos"> 160</span><span class="w">    </span><span class="n">mclkr_int_overflow_counter</span><span class="o">+=</span><span class="n">overflows</span><span class="p">;</span>
<span class="linenos"> 161</span>
<span class="linenos"> 162</span><span class="w">    </span><span class="c1">// simulate barrier</span>
<span class="linenos"> 163</span><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">mclkr_int_overflow_reporters</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">mclkr_int_worker_count</span><span class="p">)</span>
<span class="linenos"> 164</span><span class="w">    </span><span class="p">{</span>
<span class="linenos"> 165</span><span class="w">        </span><span class="n">mclkr_int_total_overflows</span><span class="o">=</span><span class="n">mclkr_int_overflow_counter</span><span class="p">;</span>
<span class="linenos"> 166</span><span class="w">        </span><span class="n">mclkr_int_overflow_reporters</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<span class="linenos"> 167</span><span class="w">		</span><span class="n">pthread_cond_broadcast</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mclkr_int_overflow_cond</span><span class="p">);</span>
<span class="linenos"> 168</span><span class="w">    </span><span class="p">}</span>
<span class="linenos"> 169</span><span class="w">    </span><span class="k">else</span>
<span class="linenos"> 170</span><span class="w">    </span><span class="p">{</span>
<span class="linenos"> 171</span><span class="w">		</span><span class="n">pthread_cond_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mclkr_int_overflow_cond</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">mclkr_int_overflow_mutex</span><span class="p">);</span>
<span class="linenos"> 172</span><span class="w">    </span><span class="p">}</span>
<span class="linenos"> 173</span>
<span class="linenos"> 174</span><span class="w">	</span><span class="n">pthread_mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mclkr_int_overflow_mutex</span><span class="p">);</span>
<span class="linenos"> 175</span>
<span class="linenos"> 176</span><span class="w">	</span><span class="n">PROF_END</span><span class="p">(</span><span class="n">MPD_MCLKR_BARRIER</span><span class="p">);</span>
<span class="linenos"> 177</span><span class="p">}</span>
<span class="linenos"> 178</span>
<span class="linenos"> 179</span><span class="w">	</span>
<span class="linenos"> 180</span>
<span class="linenos"> 181</span><span class="n">MGPUIntMpdRdmeSolver</span><span class="o">::</span><span class="n">MGPUIntMpdRdmeSolver</span><span class="p">()</span>
<span class="linenos"> 182</span><span class="o">:</span><span class="n">RDMESolver</span><span class="p">(</span><span class="n">lm</span><span class="o">::</span><span class="n">rng</span><span class="o">::</span><span class="n">RandomGenerator</span><span class="o">::</span><span class="n">NONE</span><span class="p">),</span>
<span class="linenos"> 183</span><span class="w"> </span><span class="n">seed</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="n">tau</span><span class="p">(</span><span class="mf">0.0</span><span class="p">),</span><span class="w"> </span><span class="n">threads</span><span class="p">(</span><span class="nb">NULL</span><span class="p">),</span>
<span class="linenos"> 184</span><span class="w"> </span><span class="n">overflowTimesteps</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="n">overflowListUses</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
<span class="linenos"> 185</span><span class="w"> </span><span class="n">model_reactionOrders</span><span class="p">(</span><span class="nb">NULL</span><span class="p">),</span><span class="w"> </span><span class="n">model_reactionSites</span><span class="p">(</span><span class="nb">NULL</span><span class="p">),</span><span class="w"> </span><span class="n">model_reactionRates</span><span class="p">(</span><span class="nb">NULL</span><span class="p">),</span>
<span class="linenos"> 186</span><span class="w"> </span><span class="n">model_D1</span><span class="p">(</span><span class="nb">NULL</span><span class="p">),</span><span class="w"> </span><span class="n">model_D2</span><span class="p">(</span><span class="nb">NULL</span><span class="p">),</span>
<span class="linenos"> 187</span><span class="w"> </span><span class="n">model_S</span><span class="p">(</span><span class="nb">NULL</span><span class="p">),</span><span class="w"> </span><span class="n">model_T</span><span class="p">(</span><span class="nb">NULL</span><span class="p">),</span><span class="w"> </span><span class="n">model_RL</span><span class="p">(</span><span class="nb">NULL</span><span class="p">),</span>
<span class="linenos"> 188</span><span class="w"> </span><span class="n">zeroOrder</span><span class="p">(</span><span class="nb">NULL</span><span class="p">),</span><span class="w"> </span><span class="n">firstOrder</span><span class="p">(</span><span class="nb">NULL</span><span class="p">),</span><span class="w"> </span><span class="n">secondOrder</span><span class="p">(</span><span class="nb">NULL</span><span class="p">)</span>
<span class="linenos"> 189</span><span class="p">{</span>
<span class="linenos"> 190</span><span class="w">	</span><span class="c1">// set defaults features</span>
<span class="linenos"> 191</span><span class="w">	</span><span class="n">aggcopy_x_unpack</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="linenos"> 192</span><span class="w">	</span><span class="n">aggcopy_r_pack</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="linenos"> 193</span><span class="w">	</span><span class="n">use_spin_barrier</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="linenos"> 194</span><span class="p">}</span>
<span class="linenos"> 195</span>
<span class="linenos"> 196</span><span class="kt">void</span><span class="w"> </span><span class="n">MGPUIntMpdRdmeSolver</span><span class="o">::</span><span class="n">initialize</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">replicate</span><span class="p">,</span><span class="w"> </span><span class="n">map</span><span class="o">&lt;</span><span class="n">string</span><span class="p">,</span><span class="n">string</span><span class="o">&gt;</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">parameters</span><span class="p">,</span><span class="w"> </span><span class="n">ResourceAllocator</span><span class="o">::</span><span class="n">ComputeResources</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">resourcesA</span><span class="p">)</span>
<span class="linenos"> 197</span><span class="p">{</span>
<span class="linenos"> 198</span><span class="w">	</span><span class="n">pthread_spin_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mclkr_int_spin</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="linenos"> 199</span>
<span class="linenos"> 200</span><span class="w">	</span><span class="n">RDMESolver</span><span class="o">::</span><span class="n">initialize</span><span class="p">(</span><span class="n">replicate</span><span class="p">,</span><span class="w"> </span><span class="n">parameters</span><span class="p">,</span><span class="w"> </span><span class="n">resourcesA</span><span class="p">);</span>
<span class="linenos"> 201</span>
<span class="linenos"> 202</span><span class="w">    </span><span class="c1">// Figure out the random seed.</span>
<span class="linenos"> 203</span><span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">seedTop</span><span class="o">=</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="p">)</span><span class="n">atoi</span><span class="p">((</span><span class="o">*</span><span class="n">parameters</span><span class="p">)[</span><span class="s">&quot;seed&quot;</span><span class="p">].</span><span class="n">c_str</span><span class="p">());</span>
<span class="linenos"> 204</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">seedTop</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="linenos"> 205</span><span class="w">    </span><span class="p">{</span>
<span class="linenos"> 206</span><span class="w">        </span><span class="cp">#if defined(MACOSX)</span>
<span class="linenos"> 207</span><span class="w">        </span><span class="n">seedTop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span><span class="n">mach_absolute_time</span><span class="p">();</span>
<span class="linenos"> 208</span><span class="w">        </span><span class="cp">#elif defined(LINUX)</span>
<span class="linenos"> 209</span><span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">timespec</span><span class="w"> </span><span class="n">seed_timespec</span><span class="p">;</span>
<span class="linenos"> 210</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">clock_gettime</span><span class="p">(</span><span class="n">CLOCK_REALTIME</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">seed_timespec</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="n">throw</span><span class="w"> </span><span class="n">lm</span><span class="o">::</span><span class="n">Exception</span><span class="p">(</span><span class="s">&quot;Error getting time to use for random seed.&quot;</span><span class="p">);</span>
<span class="linenos"> 211</span><span class="w">        </span><span class="n">seedTop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">seed_timespec</span><span class="p">.</span><span class="n">tv_nsec</span><span class="p">;</span>
<span class="linenos"> 212</span><span class="w">        </span><span class="cp">#endif</span>
<span class="linenos"> 213</span><span class="w">    </span><span class="p">}</span>
<span class="linenos"> 214</span><span class="w">    </span><span class="n">seed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">seedTop</span><span class="o">&lt;&lt;</span><span class="mi">16</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="n">replicate</span><span class="o">&amp;</span><span class="mh">0x0000FFFF</span><span class="p">);</span>
<span class="linenos"> 215</span><span class="w">    </span><span class="n">Print</span><span class="o">::</span><span class="n">printf</span><span class="p">(</span><span class="n">Print</span><span class="o">::</span><span class="n">INFO</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;MPDRDME: Rng seed: top word %u, bottom word %u&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">seed</span><span class="o">&gt;&gt;</span><span class="mi">16</span><span class="p">)</span><span class="o">*</span><span class="mh">0xffff</span><span class="p">,</span><span class="w"> </span><span class="n">seed</span><span class="o">&amp;</span><span class="mh">0xFFFF</span><span class="p">);</span>
<span class="linenos"> 216</span>
<span class="linenos"> 217</span><span class="w">	</span><span class="n">resources</span><span class="o">=</span><span class="n">resourcesA</span><span class="p">;</span>
<span class="linenos"> 218</span>
<span class="linenos"> 219</span><span class="w">	</span><span class="c1">//Verify that core count is at least as large as the gpu count.</span>
<span class="linenos"> 220</span><span class="w">	</span><span class="c1">//Otherwise, threads compete and speedups are not realized.</span>
<span class="linenos"> 221</span><span class="w">	</span><span class="kt">int</span><span class="w"> </span><span class="n">cpu_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">resources</span><span class="o">-&gt;</span><span class="n">cpuCores</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
<span class="linenos"> 222</span><span class="w">	</span><span class="kt">int</span><span class="w"> </span><span class="n">gpu_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">resources</span><span class="o">-&gt;</span><span class="n">cudaDevices</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
<span class="linenos"> 223</span>
<span class="linenos"> 224</span><span class="w">	</span><span class="k">if</span><span class="p">(</span><span class="n">cpu_count</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">gpu_count</span><span class="p">)</span>
<span class="linenos"> 225</span><span class="w">	</span><span class="p">{</span>
<span class="linenos"> 226</span><span class="w">		</span><span class="n">Print</span><span class="o">::</span><span class="n">printf</span><span class="p">(</span><span class="n">Print</span><span class="o">::</span><span class="n">FATAL</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;GPU count (%d) exceeds CPU count (%d)&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">gpu_count</span><span class="p">,</span><span class="w"> </span><span class="n">cpu_count</span><span class="p">);</span>
<span class="linenos"> 227</span><span class="w">		</span><span class="n">throw</span><span class="w"> </span><span class="n">lm</span><span class="o">::</span><span class="n">Exception</span><span class="p">(</span><span class="s">&quot;Not enough cpu cores to run solver&quot;</span><span class="p">);</span>
<span class="linenos"> 228</span><span class="w">	</span><span class="p">}</span>
<span class="linenos"> 229</span>
<span class="linenos"> 230</span><span class="w">	</span><span class="n">string</span><span class="w"> </span><span class="o">&amp;</span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">parameters</span><span class="p">)[</span><span class="s">&quot;rdme.mpd.overflowhandler&quot;</span><span class="p">];</span>
<span class="linenos"> 231</span><span class="w">	</span><span class="k">if</span><span class="p">(</span><span class="n">s</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;classic&quot;</span><span class="p">)</span>
<span class="linenos"> 232</span><span class="w">	</span><span class="p">{</span>
<span class="linenos"> 233</span><span class="w">		</span><span class="n">overflow_handling</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">OVERFLOW_MODE_CLASSIC</span><span class="p">;</span>
<span class="linenos"> 234</span><span class="w">		</span><span class="n">Print</span><span class="o">::</span><span class="n">printf</span><span class="p">(</span><span class="n">Print</span><span class="o">::</span><span class="n">DEBUG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Overflow handler set to classic&quot;</span><span class="p">);</span>
<span class="linenos"> 235</span><span class="w">	</span><span class="p">}</span>
<span class="linenos"> 236</span><span class="w">	</span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="p">(</span><span class="n">s</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;relaxed&quot;</span><span class="p">)</span>
<span class="linenos"> 237</span><span class="w">	</span><span class="p">{</span>
<span class="linenos"> 238</span><span class="w">		</span><span class="n">overflow_handling</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">OVERFLOW_MODE_RELAXED</span><span class="p">;</span>
<span class="linenos"> 239</span><span class="w">		</span><span class="n">Print</span><span class="o">::</span><span class="n">printf</span><span class="p">(</span><span class="n">Print</span><span class="o">::</span><span class="n">DEBUG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Overflow handler set to relaxed&quot;</span><span class="p">);</span>
<span class="linenos"> 240</span><span class="w">	</span><span class="p">}</span>
<span class="linenos"> 241</span><span class="w">	</span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="p">(</span><span class="n">s</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">)</span>
<span class="linenos"> 242</span><span class="w">	</span><span class="p">{</span>
<span class="linenos"> 243</span><span class="w">		</span><span class="n">overflow_handling</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">OVERFLOW_MODE_CLASSIC</span><span class="p">;</span>
<span class="linenos"> 244</span><span class="w">		</span><span class="n">Print</span><span class="o">::</span><span class="n">printf</span><span class="p">(</span><span class="n">Print</span><span class="o">::</span><span class="n">DEBUG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Overflow handler set to default (classic)&quot;</span><span class="p">);</span>
<span class="linenos"> 245</span><span class="w">	</span><span class="p">}</span>
<span class="linenos"> 246</span><span class="w">	</span><span class="k">else</span>
<span class="linenos"> 247</span><span class="w">	</span><span class="p">{</span>
<span class="linenos"> 248</span><span class="w">		</span><span class="n">overflow_handling</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">OVERFLOW_MODE_CLASSIC</span><span class="p">;</span>
<span class="linenos"> 249</span><span class="w">		</span><span class="n">Print</span><span class="o">::</span><span class="n">printf</span><span class="p">(</span><span class="n">Print</span><span class="o">::</span><span class="n">WARNING</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Unknown overflow handler requested: &#39;%s&#39;&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
<span class="linenos"> 250</span><span class="w">	</span><span class="p">}</span>
<span class="linenos"> 251</span>
<span class="linenos"> 252</span><span class="w">	</span><span class="k">if</span><span class="p">((</span><span class="o">*</span><span class="n">parameters</span><span class="p">)[</span><span class="s">&quot;mgpu.x_unpack&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">)</span>
<span class="linenos"> 253</span><span class="w">		</span><span class="n">aggcopy_x_unpack</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">atoi</span><span class="p">((</span><span class="o">*</span><span class="n">parameters</span><span class="p">)[</span><span class="s">&quot;mgpu.x_unpack&quot;</span><span class="p">].</span><span class="n">c_str</span><span class="p">());</span>
<span class="linenos"> 254</span>
<span class="linenos"> 255</span><span class="w">	</span><span class="k">if</span><span class="p">((</span><span class="o">*</span><span class="n">parameters</span><span class="p">)[</span><span class="s">&quot;mgpu.r_pack&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">)</span>
<span class="linenos"> 256</span><span class="w">		</span><span class="n">aggcopy_r_pack</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">atoi</span><span class="p">((</span><span class="o">*</span><span class="n">parameters</span><span class="p">)[</span><span class="s">&quot;mgpu.r_pack&quot;</span><span class="p">].</span><span class="n">c_str</span><span class="p">());</span>
<span class="linenos"> 257</span>
<span class="linenos"> 258</span><span class="w">	</span><span class="k">if</span><span class="p">((</span><span class="o">*</span><span class="n">parameters</span><span class="p">)[</span><span class="s">&quot;mgpu.spinlock&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">)</span>
<span class="linenos"> 259</span><span class="w">		</span><span class="n">use_spin_barrier</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">atoi</span><span class="p">((</span><span class="o">*</span><span class="n">parameters</span><span class="p">)[</span><span class="s">&quot;mgpu.spinlock&quot;</span><span class="p">].</span><span class="n">c_str</span><span class="p">());</span>
<span class="linenos"> 260</span><span class="p">}</span>
<span class="linenos"> 261</span>
<span class="linenos"> 262</span><span class="kt">void</span><span class="w"> </span><span class="n">MGPUIntMpdRdmeSolver</span><span class="o">::</span><span class="n">initialize_decomposition</span><span class="p">()</span>
<span class="linenos"> 263</span><span class="p">{</span>
<span class="linenos"> 264</span><span class="w">	</span><span class="c1">// Create mapper</span>
<span class="linenos"> 265</span><span class="w">	</span><span class="kt">int</span><span class="w"> </span><span class="n">latx</span><span class="p">,</span><span class="w"> </span><span class="n">laty</span><span class="p">,</span><span class="w"> </span><span class="n">latz</span><span class="p">;</span>
<span class="linenos"> 266</span><span class="w">	</span><span class="kt">int</span><span class="w"> </span><span class="n">apron</span><span class="p">,</span><span class="w"> </span><span class="n">overlap</span><span class="p">;</span>
<span class="linenos"> 267</span><span class="w">	</span><span class="kt">int</span><span class="w"> </span><span class="n">gpus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">resources</span><span class="o">-&gt;</span><span class="n">cudaDevices</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
<span class="linenos"> 268</span>
<span class="linenos"> 269</span><span class="cp">#if defined MPD_BOUNDARY_PERIODIC</span>
<span class="linenos"> 270</span><span class="w">	</span><span class="kt">bool</span><span class="w"> </span><span class="n">pz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="linenos"> 271</span><span class="cp">#else</span>
<span class="linenos"> 272</span><span class="w">	</span><span class="kt">bool</span><span class="w"> </span><span class="n">pz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="linenos"> 273</span><span class="cp">#endif</span>
<span class="linenos"> 274</span>
<span class="linenos"> 275</span><span class="w">	</span><span class="n">apron</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<span class="linenos"> 276</span><span class="w">	</span><span class="n">overlap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos"> 277</span>
<span class="linenos"> 278</span><span class="w">	</span><span class="n">latx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getXSize</span><span class="p">();</span>
<span class="linenos"> 279</span><span class="w">	</span><span class="n">laty</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getYSize</span><span class="p">();</span>
<span class="linenos"> 280</span><span class="w">	</span><span class="n">latz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getZSize</span><span class="p">();</span>
<span class="linenos"> 281</span>
<span class="linenos"> 282</span><span class="w">	</span><span class="kt">int</span><span class="w"> </span><span class="n">site_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">);</span>
<span class="linenos"> 283</span><span class="w">	</span><span class="kt">int</span><span class="w"> </span><span class="n">pagecount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MPD_WORDS_PER_SITE</span><span class="p">;</span>
<span class="linenos"> 284</span>
<span class="linenos"> 285</span><span class="w">	</span><span class="n">mapper</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">ZDivMultiGPUMapper</span><span class="p">(</span><span class="n">latx</span><span class="p">,</span><span class="w"> </span><span class="n">laty</span><span class="p">,</span><span class="w"> </span><span class="n">latz</span><span class="p">,</span>
<span class="linenos"> 286</span><span class="w">	                                </span><span class="n">site_size</span><span class="p">,</span><span class="w"> </span><span class="n">apron</span><span class="p">,</span><span class="w"> </span><span class="n">overlap</span><span class="p">,</span>
<span class="linenos"> 287</span><span class="w">									</span><span class="n">gpus</span><span class="p">,</span><span class="w"> </span><span class="n">resources</span><span class="o">-&gt;</span><span class="n">cudaDevices</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span><span class="w"> </span><span class="n">pz</span><span class="p">,</span><span class="w"> </span><span class="n">pagecount</span><span class="p">);</span>
<span class="linenos"> 288</span>
<span class="linenos"> 289</span><span class="w">    </span><span class="n">pthread_barrier_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">start_barrier</span><span class="p">,</span><span class="w">      </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">gpus</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
<span class="linenos"> 290</span><span class="w">    </span><span class="n">pthread_barrier_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stop_barrier</span><span class="p">,</span><span class="w">       </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">gpus</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
<span class="linenos"> 291</span><span class="w">    </span><span class="n">pthread_barrier_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">simulation_barrier</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">gpus</span><span class="p">);</span>
<span class="linenos"> 292</span><span class="w">    </span><span class="n">pthread_barrier_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">overflow_barrier1</span><span class="p">,</span><span class="w">  </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">gpus</span><span class="p">);</span>
<span class="linenos"> 293</span><span class="w">    </span><span class="n">pthread_barrier_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">overflow_barrier2</span><span class="p">,</span><span class="w">  </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">gpus</span><span class="p">);</span>
<span class="linenos"> 294</span>
<span class="linenos"> 295</span><span class="w">	</span><span class="n">mclkr_int_worker_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gpus</span><span class="p">;</span>
<span class="linenos"> 296</span><span class="p">}</span>
<span class="linenos"> 297</span>
<span class="linenos"> 298</span><span class="kt">void</span><span class="w"> </span><span class="n">MGPUIntMpdRdmeSolver</span><span class="o">::</span><span class="n">start_threads</span><span class="p">()</span>
<span class="linenos"> 299</span><span class="p">{</span>
<span class="linenos"> 300</span><span class="w">	</span><span class="c1">// TODO FIXME: Think about this.  Perhaps each thread should be assigned a core</span>
<span class="linenos"> 301</span><span class="w">	</span><span class="c1">// or perhaps we should be reusing the threading infrastructure already provided</span>
<span class="linenos"> 302</span><span class="w">	</span><span class="c1">// to us via the core.  We also need NUMA awareness, which is another TODO.</span>
<span class="linenos"> 303</span><span class="w">	</span><span class="c1">// For now, lets just open up our pinning to be over all the cores that we&#39;ve</span>
<span class="linenos"> 304</span><span class="w">	</span><span class="c1">// been graciously handed to us.</span>
<span class="linenos"> 305</span><span class="cp">#if defined(LINUX) &amp;&amp; !defined(ARM)</span>
<span class="linenos"> 306</span><span class="w">	</span><span class="kt">cpu_set_t</span><span class="w"> </span><span class="n">cpuset</span><span class="p">;</span>
<span class="linenos"> 307</span><span class="w">	</span><span class="n">CPU_ZERO</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cpuset</span><span class="p">);</span>
<span class="linenos"> 308</span>
<span class="linenos"> 309</span><span class="w">	</span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">c</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">c</span><span class="o">&lt;</span><span class="n">resources</span><span class="o">-&gt;</span><span class="n">cpuCores</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="w"> </span><span class="n">c</span><span class="o">++</span><span class="p">)</span>
<span class="linenos"> 310</span><span class="w">	</span><span class="p">{</span>
<span class="linenos"> 311</span><span class="w">		</span><span class="n">Print</span><span class="o">::</span><span class="n">printf</span><span class="p">(</span><span class="n">Print</span><span class="o">::</span><span class="n">DEBUG</span><span class="p">,</span><span class="s">&quot;Adding CPU %d to our cpuset&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">resources</span><span class="o">-&gt;</span><span class="n">cpuCores</span><span class="p">[</span><span class="n">c</span><span class="p">]);</span>
<span class="linenos"> 312</span><span class="w">		</span><span class="n">CPU_SET</span><span class="p">(</span><span class="n">resources</span><span class="o">-&gt;</span><span class="n">cpuCores</span><span class="p">[</span><span class="n">c</span><span class="p">],</span><span class="w"> </span><span class="o">&amp;</span><span class="n">cpuset</span><span class="p">);</span>
<span class="linenos"> 313</span><span class="w">	</span><span class="p">}</span>
<span class="linenos"> 314</span><span class="w">	</span><span class="n">pthread_setaffinity_np</span><span class="p">(</span><span class="n">pthread_self</span><span class="p">(),</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">cpu_set_t</span><span class="p">),</span><span class="w"> </span><span class="o">&amp;</span><span class="n">cpuset</span><span class="p">);</span>
<span class="linenos"> 315</span><span class="cp">#endif</span>
<span class="linenos"> 316</span>
<span class="linenos"> 317</span><span class="w">	</span><span class="kt">int</span><span class="w"> </span><span class="n">gpus</span><span class="o">=</span><span class="n">resources</span><span class="o">-&gt;</span><span class="n">cudaDevices</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
<span class="linenos"> 318</span><span class="w">	</span><span class="n">threads</span><span class="o">=</span><span class="n">new</span><span class="w"> </span><span class="n">gpu_worker_thread_int_params</span><span class="p">[</span><span class="n">gpus</span><span class="p">];</span>
<span class="linenos"> 319</span>
<span class="linenos"> 320</span><span class="w">	</span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">gpus</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="linenos"> 321</span><span class="w">	</span><span class="p">{</span>
<span class="linenos"> 322</span><span class="w">        </span><span class="n">threads</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">runner</span><span class="o">=</span><span class="n">this</span><span class="p">;</span>
<span class="linenos"> 323</span><span class="w">        </span><span class="c1">//threads[i].lattice=lattice;</span>
<span class="linenos"> 324</span><span class="w">        </span><span class="n">threads</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mapper</span><span class="o">=</span><span class="n">mapper</span><span class="p">;</span>
<span class="linenos"> 325</span><span class="w">        </span><span class="n">threads</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">gpu</span><span class="o">=</span><span class="n">i</span><span class="p">;</span>
<span class="linenos"> 326</span><span class="w">        </span><span class="n">threads</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ngpus</span><span class="o">=</span><span class="n">gpus</span><span class="p">;</span>
<span class="linenos"> 327</span><span class="w">        </span><span class="n">threads</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">runner_sync</span><span class="o">=</span><span class="nb">NULL</span><span class="p">;</span>
<span class="linenos"> 328</span><span class="w">        </span><span class="n">threads</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">worker_sync</span><span class="o">=</span><span class="nb">NULL</span><span class="p">;</span>
<span class="linenos"> 329</span><span class="w">        </span><span class="n">threads</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">timesteps_to_run</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<span class="linenos"> 330</span><span class="w">		</span><span class="n">threads</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">segment</span><span class="o">=</span><span class="n">mapper</span><span class="o">-&gt;</span><span class="n">getSegmentDescriptor</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
<span class="linenos"> 331</span><span class="w">		</span>
<span class="linenos"> 332</span><span class="w">		</span><span class="n">Print</span><span class="o">::</span><span class="n">printf</span><span class="p">(</span><span class="n">Print</span><span class="o">::</span><span class="n">DEBUG</span><span class="p">,</span><span class="s">&quot;Creating GPU thread %d&quot;</span><span class="p">,</span><span class="n">i</span><span class="p">);</span>
<span class="linenos"> 333</span><span class="w">        </span><span class="n">pthread_create</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">threads</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="kr">thread</span><span class="p">),</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">gpu_worker_thread_int</span><span class="p">,</span>
<span class="linenos"> 334</span><span class="w">                       </span><span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">threads</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span>
<span class="linenos"> 335</span><span class="w">	</span><span class="p">}</span>
<span class="linenos"> 336</span><span class="p">}</span>
<span class="linenos"> 337</span>
<span class="linenos"> 338</span><span class="kt">void</span><span class="w"> </span><span class="n">MGPUIntMpdRdmeSolver</span><span class="o">::</span><span class="n">stop_threads</span><span class="p">()</span>
<span class="linenos"> 339</span><span class="p">{</span>
<span class="linenos"> 340</span><span class="w">	</span><span class="kt">int</span><span class="w"> </span><span class="n">gpus</span><span class="o">=</span><span class="n">resources</span><span class="o">-&gt;</span><span class="n">cudaDevices</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
<span class="linenos"> 341</span><span class="w">	</span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">gpus</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="linenos"> 342</span><span class="w">	</span><span class="p">{</span>
<span class="linenos"> 343</span><span class="w">		</span><span class="n">Print</span><span class="o">::</span><span class="n">printf</span><span class="p">(</span><span class="n">Print</span><span class="o">::</span><span class="n">DEBUG</span><span class="p">,</span><span class="s">&quot;Waiting to join GPU thread %d&quot;</span><span class="p">,</span><span class="n">i</span><span class="p">);</span>
<span class="linenos"> 344</span><span class="w">		</span><span class="n">pthread_join</span><span class="p">(</span><span class="n">threads</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="kr">thread</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
<span class="linenos"> 345</span><span class="w">	</span><span class="p">}</span>
<span class="linenos"> 346</span><span class="p">}</span>
<span class="linenos"> 347</span>
<span class="linenos"> 348</span><span class="n">MGPUIntMpdRdmeSolver</span><span class="o">::~</span><span class="n">MGPUIntMpdRdmeSolver</span><span class="p">()</span>
<span class="linenos"> 349</span><span class="p">{</span>
<span class="linenos"> 350</span><span class="w">	</span><span class="c1">// Free allocated memory in MGPUIntMpdRdmeSolver</span>
<span class="linenos"> 351</span><span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">model_reactionOrders</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="n">delete</span><span class="w"> </span><span class="p">[]</span><span class="w"> </span><span class="n">model_reactionOrders</span><span class="p">;}</span>
<span class="linenos"> 352</span><span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">model_reactionSites</span><span class="p">)</span><span class="w">  </span><span class="p">{</span><span class="n">delete</span><span class="w"> </span><span class="p">[]</span><span class="w"> </span><span class="n">model_reactionSites</span><span class="p">;}</span>
<span class="linenos"> 353</span><span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">model_reactionRates</span><span class="p">)</span><span class="w">  </span><span class="p">{</span><span class="n">delete</span><span class="w"> </span><span class="p">[]</span><span class="w"> </span><span class="n">model_reactionRates</span><span class="p">;}</span>
<span class="linenos"> 354</span>
<span class="linenos"> 355</span><span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">model_D1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="n">delete</span><span class="w"> </span><span class="p">[]</span><span class="w"> </span><span class="n">model_D1</span><span class="p">;}</span>
<span class="linenos"> 356</span><span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">model_D2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="n">delete</span><span class="w"> </span><span class="p">[]</span><span class="w"> </span><span class="n">model_D2</span><span class="p">;}</span>
<span class="linenos"> 357</span>
<span class="linenos"> 358</span><span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">model_S</span><span class="p">)</span><span class="w">  </span><span class="p">{</span><span class="n">delete</span><span class="w"> </span><span class="p">[]</span><span class="w"> </span><span class="n">model_S</span><span class="p">;}</span>
<span class="linenos"> 359</span><span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">model_T</span><span class="p">)</span><span class="w">  </span><span class="p">{</span><span class="n">delete</span><span class="w"> </span><span class="p">[]</span><span class="w"> </span><span class="n">model_T</span><span class="p">;}</span>
<span class="linenos"> 360</span><span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">model_RL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="n">delete</span><span class="w"> </span><span class="p">[]</span><span class="w"> </span><span class="n">model_RL</span><span class="p">;}</span>
<span class="linenos"> 361</span>
<span class="linenos"> 362</span><span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">zeroOrder</span><span class="p">)</span><span class="w">   </span><span class="p">{</span><span class="n">delete</span><span class="w"> </span><span class="p">[]</span><span class="w"> </span><span class="n">zeroOrder</span><span class="p">;}</span>
<span class="linenos"> 363</span><span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">firstOrder</span><span class="p">)</span><span class="w">  </span><span class="p">{</span><span class="n">delete</span><span class="w"> </span><span class="p">[]</span><span class="w"> </span><span class="n">firstOrder</span><span class="p">;}</span>
<span class="linenos"> 364</span><span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">secondOrder</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="n">delete</span><span class="w"> </span><span class="p">[]</span><span class="w"> </span><span class="n">secondOrder</span><span class="p">;}</span>
<span class="linenos"> 365</span>
<span class="linenos"> 366</span><span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">threads</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="n">delete</span><span class="w"> </span><span class="p">[]</span><span class="w"> </span><span class="n">threads</span><span class="p">;}</span>
<span class="linenos"> 367</span><span class="p">}</span>
<span class="linenos"> 368</span>
<span class="linenos"> 369</span><span class="kt">void</span><span class="w"> </span><span class="n">MGPUIntMpdRdmeSolver</span><span class="o">::</span><span class="n">allocateLattice</span><span class="p">(</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">latticeXSize</span><span class="p">,</span>
<span class="linenos"> 370</span><span class="w">                                           </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">latticeYSize</span><span class="p">,</span>
<span class="linenos"> 371</span><span class="w">										   </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">latticeZSize</span><span class="p">,</span>
<span class="linenos"> 372</span><span class="w">										   </span><span class="n">site_size_t</span><span class="w"> </span><span class="n">particlesPerSite</span><span class="p">,</span>
<span class="linenos"> 373</span><span class="w">										   </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">bytes_per_particle</span><span class="p">,</span>
<span class="linenos"> 374</span><span class="w">										   </span><span class="n">si_dist_t</span><span class="w"> </span><span class="n">latticeSpacing</span><span class="p">)</span>
<span class="linenos"> 375</span><span class="p">{</span>
<span class="linenos"> 376</span><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">bytes_per_particle</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span>
<span class="linenos"> 377</span><span class="w">    </span><span class="p">{</span>
<span class="linenos"> 378</span><span class="w">        </span><span class="n">Print</span><span class="o">::</span><span class="n">printf</span><span class="p">(</span><span class="n">Print</span><span class="o">::</span><span class="n">ERROR</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;IntMpdRdmeSolver works only with lattices of 4 bytes per particle, not %d&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">bytes_per_particle</span><span class="p">);</span>
<span class="linenos"> 379</span><span class="w">        </span><span class="n">throw</span><span class="w"> </span><span class="n">Exception</span><span class="p">(</span><span class="s">&quot;incorrect lattice data type&quot;</span><span class="p">);</span>
<span class="linenos"> 380</span><span class="w">    </span><span class="p">}</span>
<span class="linenos"> 381</span>
<span class="linenos"> 382</span><span class="w">    </span><span class="n">lattice</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Lattice</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">new</span><span class="w"> </span><span class="n">CudaIntLattice</span><span class="p">(</span><span class="n">latticeXSize</span><span class="p">,</span><span class="w"> </span><span class="n">latticeYSize</span><span class="p">,</span><span class="w"> </span><span class="n">latticeZSize</span><span class="p">,</span><span class="w"> </span><span class="n">latticeSpacing</span><span class="p">,</span><span class="w"> </span><span class="n">particlesPerSite</span><span class="p">);</span>
<span class="linenos"> 383</span><span class="p">}</span>
<span class="linenos"> 384</span>
<span class="linenos"> 385</span><span class="kt">void</span><span class="w"> </span><span class="n">MGPUIntMpdRdmeSolver</span><span class="o">::</span><span class="n">buildModel</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">uint</span><span class="w"> </span><span class="n">numberSpeciesA</span><span class="p">,</span>
<span class="linenos"> 386</span><span class="w">                                      </span><span class="k">const</span><span class="w"> </span><span class="n">uint</span><span class="w"> </span><span class="n">numberReactionsA</span><span class="p">,</span>
<span class="linenos"> 387</span><span class="w">									  </span><span class="k">const</span><span class="w"> </span><span class="n">uint</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">initialSpeciesCountsA</span><span class="p">,</span>
<span class="linenos"> 388</span><span class="w">									  </span><span class="k">const</span><span class="w"> </span><span class="n">uint</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">reactionTypesA</span><span class="p">,</span>
<span class="linenos"> 389</span><span class="w">									  </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">KA</span><span class="p">,</span>
<span class="linenos"> 390</span><span class="w">									  </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">SA</span><span class="p">,</span>
<span class="linenos"> 391</span><span class="w">									  </span><span class="k">const</span><span class="w"> </span><span class="n">uint</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">DA</span><span class="p">,</span>
<span class="linenos"> 392</span><span class="w">									  </span><span class="k">const</span><span class="w"> </span><span class="n">uint</span><span class="w"> </span><span class="n">kCols</span><span class="p">)</span>
<span class="linenos"> 393</span><span class="p">{</span>
<span class="linenos"> 394</span><span class="w">    </span><span class="n">CMESolver</span><span class="o">::</span><span class="n">buildModel</span><span class="p">(</span><span class="n">numberSpeciesA</span><span class="p">,</span><span class="w"> </span><span class="n">numberReactionsA</span><span class="p">,</span><span class="w"> </span><span class="n">initialSpeciesCountsA</span><span class="p">,</span><span class="w"> </span><span class="n">reactionTypesA</span><span class="p">,</span><span class="w"> </span><span class="n">KA</span><span class="p">,</span><span class="w"> </span><span class="n">SA</span><span class="p">,</span><span class="w"> </span><span class="n">DA</span><span class="p">,</span><span class="w"> </span><span class="n">kCols</span><span class="p">);</span>
<span class="linenos"> 395</span>
<span class="linenos"> 396</span><span class="w">    </span><span class="c1">// Get the time step.</span>
<span class="linenos"> 397</span><span class="w">    </span><span class="n">tau</span><span class="o">=</span><span class="n">atof</span><span class="p">((</span><span class="o">*</span><span class="n">parameters</span><span class="p">)[</span><span class="s">&quot;timestep&quot;</span><span class="p">].</span><span class="n">c_str</span><span class="p">());</span>
<span class="linenos"> 398</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tau</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">)</span><span class="w"> </span><span class="n">throw</span><span class="w"> </span><span class="n">InvalidArgException</span><span class="p">(</span><span class="s">&quot;timestep&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;A positive timestep must be specified for the solver.&quot;</span><span class="p">);</span>
<span class="linenos"> 399</span>
<span class="linenos"> 400</span><span class="w">    </span><span class="c1">// Make sure we can support the reaction model.</span>
<span class="linenos"> 401</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">numberReactions</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">MPD_MAX_REACTION_TABLE_ENTRIES</span><span class="p">)</span><span class="w"> </span><span class="n">throw</span><span class="w"> </span><span class="n">Exception</span><span class="p">(</span><span class="s">&quot;The number of reaction table entries exceeds the maximum supported by the solver.&quot;</span><span class="p">);</span>
<span class="linenos"> 402</span><span class="cp">#ifndef MPD_GLOBAL_S_MATRIX</span>
<span class="linenos"> 403</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">numberSpecies</span><span class="o">*</span><span class="n">numberReactions</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">MPD_MAX_S_MATRIX_ENTRIES</span><span class="p">)</span><span class="w"> </span><span class="n">throw</span><span class="w"> </span><span class="n">Exception</span><span class="p">(</span><span class="s">&quot;The number of S matrix entries exceeds the maximum supported by the solver.&quot;</span><span class="p">);</span>
<span class="linenos"> 404</span><span class="cp">#endif</span>
<span class="linenos"> 405</span>
<span class="linenos"> 406</span><span class="w">    </span><span class="c1">// Setup the cuda reaction model.</span>
<span class="linenos"> 407</span><span class="w">    </span><span class="n">model_reactionOrders</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="p">[</span><span class="n">numberReactions</span><span class="p">];</span>
<span class="linenos"> 408</span><span class="w">    </span><span class="n">model_reactionSites</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="p">[</span><span class="n">numberReactions</span><span class="p">];</span>
<span class="linenos"> 409</span><span class="w">    </span><span class="n">model_D1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="p">[</span><span class="n">numberReactions</span><span class="p">];</span>
<span class="linenos"> 410</span><span class="w">    </span><span class="n">model_D2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="p">[</span><span class="n">numberReactions</span><span class="p">];</span>
<span class="linenos"> 411</span><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">numberReactions</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="linenos"> 412</span><span class="w">    </span><span class="p">{</span>
<span class="linenos"> 413</span><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">reactionTypes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ZerothOrderPropensityArgs</span><span class="o">::</span><span class="n">REACTION_TYPE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 414</span><span class="w">        	</span><span class="n">model_reactionOrders</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MPD_ZERO_ORDER_REACTION</span><span class="p">;</span>
<span class="linenos"> 415</span><span class="w">        	</span><span class="n">model_reactionSites</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos"> 416</span><span class="w">        	</span><span class="n">model_D1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span>
<span class="linenos"> 417</span><span class="w">        	</span><span class="n">model_D2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos"> 418</span><span class="w">        </span><span class="p">}</span>
<span class="linenos"> 419</span><span class="w">    	</span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">reactionTypes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">FirstOrderPropensityArgs</span><span class="o">::</span><span class="n">REACTION_TYPE</span><span class="p">)</span>
<span class="linenos"> 420</span><span class="w">    	</span><span class="p">{</span>
<span class="linenos"> 421</span><span class="w">    		</span><span class="n">model_reactionOrders</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MPD_FIRST_ORDER_REACTION</span><span class="p">;</span>
<span class="linenos"> 422</span><span class="w">    		</span><span class="n">model_reactionSites</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos"> 423</span><span class="w">    		</span><span class="n">model_D1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="n">FirstOrderPropensityArgs</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">propensityFunctionArgs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">-&gt;</span><span class="n">si</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
<span class="linenos"> 424</span><span class="w">    		</span><span class="n">model_D2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos"> 425</span><span class="w">    	</span><span class="p">}</span>
<span class="linenos"> 426</span><span class="w">    	</span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">reactionTypes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">SecondOrderPropensityArgs</span><span class="o">::</span><span class="n">REACTION_TYPE</span><span class="p">)</span>
<span class="linenos"> 427</span><span class="w">    	</span><span class="p">{</span>
<span class="linenos"> 428</span><span class="w">    		</span><span class="n">model_reactionOrders</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MPD_SECOND_ORDER_REACTION</span><span class="p">;</span>
<span class="linenos"> 429</span><span class="w">    		</span><span class="n">model_reactionSites</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos"> 430</span><span class="w">    		</span><span class="n">model_D1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="n">SecondOrderPropensityArgs</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">propensityFunctionArgs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">-&gt;</span><span class="n">s1i</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
<span class="linenos"> 431</span><span class="w">    		</span><span class="n">model_D2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="n">SecondOrderPropensityArgs</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">propensityFunctionArgs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">-&gt;</span><span class="n">s2i</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
<span class="linenos"> 432</span><span class="w">    	</span><span class="p">}</span>
<span class="linenos"> 433</span><span class="w">    	</span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">reactionTypes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">SecondOrderSelfPropensityArgs</span><span class="o">::</span><span class="n">REACTION_TYPE</span><span class="p">)</span>
<span class="linenos"> 434</span><span class="w">    	</span><span class="p">{</span>
<span class="linenos"> 435</span><span class="w">    		</span><span class="n">model_reactionOrders</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MPD_SECOND_ORDER_SELF_REACTION</span><span class="p">;</span>
<span class="linenos"> 436</span><span class="w">    		</span><span class="n">model_reactionSites</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos"> 437</span><span class="w">    		</span><span class="n">model_D1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="n">SecondOrderSelfPropensityArgs</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">propensityFunctionArgs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">-&gt;</span><span class="n">si</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
<span class="linenos"> 438</span><span class="w">    		</span><span class="n">model_D2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos"> 439</span><span class="w">    	</span><span class="p">}</span>
<span class="linenos"> 440</span><span class="w">    	</span><span class="k">else</span>
<span class="linenos"> 441</span><span class="w">    	</span><span class="p">{</span>
<span class="linenos"> 442</span><span class="w">    		</span><span class="n">throw</span><span class="w"> </span><span class="n">InvalidArgException</span><span class="p">(</span><span class="s">&quot;reactionTypeA&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;the reaction type was not supported by the solver&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">reactionTypes</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="linenos"> 443</span><span class="w">    	</span><span class="p">}</span>
<span class="linenos"> 444</span><span class="w">    </span><span class="p">}</span>
<span class="linenos"> 445</span>
<span class="linenos"> 446</span><span class="w">    </span><span class="c1">// Setup the cuda S matrix.</span>
<span class="linenos"> 447</span><span class="w">    </span><span class="n">model_S</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="kt">int8_t</span><span class="p">[</span><span class="n">numberSpecies</span><span class="o">*</span><span class="n">numberReactions</span><span class="p">];</span>
<span class="linenos"> 448</span>
<span class="linenos"> 449</span><span class="w">	</span><span class="k">for</span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">rx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">rx</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">numberReactions</span><span class="p">;</span><span class="w"> </span><span class="n">rx</span><span class="o">++</span><span class="p">)</span>
<span class="linenos"> 450</span><span class="w">	</span><span class="p">{</span>
<span class="linenos"> 451</span><span class="w">		</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">p</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">p</span><span class="o">&lt;</span><span class="n">numberSpecies</span><span class="p">;</span><span class="w"> </span><span class="n">p</span><span class="o">++</span><span class="p">)</span>
<span class="linenos"> 452</span><span class="w">		</span><span class="p">{</span>
<span class="linenos"> 453</span><span class="w">			</span><span class="c1">//tmpS[numberSpecies*rx + p] = S[numberSpecies*rx + p];</span>
<span class="linenos"> 454</span><span class="w">			</span><span class="n">model_S</span><span class="p">[</span><span class="n">rx</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">numberSpecies</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">p</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">S</span><span class="p">[</span><span class="n">numberReactions</span><span class="o">*</span><span class="n">p</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">rx</span><span class="p">];</span>
<span class="linenos"> 455</span><span class="w">		</span><span class="p">}</span>
<span class="linenos"> 456</span><span class="w">	</span><span class="p">}</span>
<span class="linenos"> 457</span><span class="p">}</span>
<span class="linenos"> 458</span>
<span class="linenos"> 459</span><span class="kt">void</span><span class="w"> </span><span class="n">MGPUIntMpdRdmeSolver</span><span class="o">::</span><span class="n">buildDiffusionModel</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">uint</span><span class="w"> </span><span class="n">numberSiteTypesA</span><span class="p">,</span>
<span class="linenos"> 460</span><span class="w">                                               </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">DFA</span><span class="p">,</span>
<span class="linenos"> 461</span><span class="w">											   </span><span class="k">const</span><span class="w"> </span><span class="n">uint</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">RLA</span><span class="p">,</span>
<span class="linenos"> 462</span><span class="w">											   </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">latticeXSize</span><span class="p">,</span>
<span class="linenos"> 463</span><span class="w">											   </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">latticeYSize</span><span class="p">,</span>
<span class="linenos"> 464</span><span class="w">											   </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">latticeZSize</span><span class="p">,</span>
<span class="linenos"> 465</span><span class="w">											   </span><span class="n">site_size_t</span><span class="w"> </span><span class="n">particlesPerSite</span><span class="p">,</span>
<span class="linenos"> 466</span><span class="w">											   </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">bytes_per_particle</span><span class="p">,</span>
<span class="linenos"> 467</span><span class="w">											   </span><span class="n">si_dist_t</span><span class="w"> </span><span class="n">latticeSpacing</span><span class="p">,</span>
<span class="linenos"> 468</span><span class="w">											   </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">latticeData</span><span class="p">,</span>
<span class="linenos"> 469</span><span class="w">											   </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">latticeSitesData</span><span class="p">,</span>
<span class="linenos"> 470</span><span class="w">											   </span><span class="kt">bool</span><span class="w"> </span><span class="n">rowMajorData</span><span class="p">)</span>
<span class="linenos"> 471</span><span class="p">{</span>
<span class="linenos"> 472</span><span class="w">    </span><span class="n">RDMESolver</span><span class="o">::</span><span class="n">buildDiffusionModel</span><span class="p">(</span><span class="n">numberSiteTypesA</span><span class="p">,</span><span class="w"> </span><span class="n">DFA</span><span class="p">,</span><span class="w"> </span><span class="n">RLA</span><span class="p">,</span><span class="w"> </span><span class="n">latticeXSize</span><span class="p">,</span>
<span class="linenos"> 473</span><span class="w">	                                </span><span class="n">latticeYSize</span><span class="p">,</span><span class="w"> </span><span class="n">latticeZSize</span><span class="p">,</span><span class="w"> </span><span class="n">particlesPerSite</span><span class="p">,</span>
<span class="linenos"> 474</span><span class="w">									</span><span class="n">bytes_per_particle</span><span class="p">,</span><span class="w"> </span><span class="n">latticeSpacing</span><span class="p">,</span><span class="w"> </span><span class="n">latticeData</span><span class="p">,</span>
<span class="linenos"> 475</span><span class="w">									</span><span class="n">latticeSitesData</span><span class="p">,</span><span class="w"> </span><span class="n">rowMajorData</span><span class="p">);</span>
<span class="linenos"> 476</span>
<span class="linenos"> 477</span><span class="w">    </span><span class="c1">// Get the time step.</span>
<span class="linenos"> 478</span><span class="w">    </span><span class="n">tau</span><span class="o">=</span><span class="n">atof</span><span class="p">((</span><span class="o">*</span><span class="n">parameters</span><span class="p">)[</span><span class="s">&quot;timestep&quot;</span><span class="p">].</span><span class="n">c_str</span><span class="p">());</span>
<span class="linenos"> 479</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tau</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">)</span><span class="w"> </span><span class="n">throw</span><span class="w"> </span><span class="n">InvalidArgException</span><span class="p">(</span><span class="s">&quot;timestep&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;A positive timestep must be specified for the solver.&quot;</span><span class="p">);</span>
<span class="linenos"> 480</span>
<span class="linenos"> 481</span><span class="w">    </span><span class="c1">// Setup the cuda transition matrix.</span>
<span class="linenos"> 482</span><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">DFmatrixSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">numberSpecies</span><span class="o">*</span><span class="n">numberSiteTypes</span><span class="o">*</span><span class="n">numberSiteTypes</span><span class="p">;</span>
<span class="linenos"> 483</span>
<span class="linenos"> 484</span><span class="cp">#ifndef MPD_GLOBAL_T_MATRIX</span>
<span class="linenos"> 485</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">DFmatrixSize</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">MPD_MAX_TRANSITION_TABLE_ENTRIES</span><span class="p">)</span><span class="w"> </span><span class="n">throw</span><span class="w"> </span><span class="n">Exception</span><span class="p">(</span><span class="s">&quot;The number of transition table entries exceeds the maximum supported by the solver.&quot;</span><span class="p">);</span>
<span class="linenos"> 486</span><span class="cp">#endif</span>
<span class="linenos"> 487</span>
<span class="linenos"> 488</span><span class="cp">#ifndef MPD_GLOBAL_S_MATRIX</span>
<span class="linenos"> 489</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">numberReactions</span><span class="o">*</span><span class="n">numberSiteTypes</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">MPD_MAX_RL_MATRIX_ENTRIES</span><span class="p">)</span>
<span class="linenos"> 490</span><span class="w">	</span><span class="p">{</span>
<span class="linenos"> 491</span><span class="w">		</span><span class="n">throw</span><span class="w"> </span><span class="n">Exception</span><span class="p">(</span><span class="s">&quot;The number of RL matrix entries exceeds the maximum supported by the solver.&quot;</span><span class="p">);</span>
<span class="linenos"> 492</span><span class="w">	</span><span class="p">}</span>
<span class="linenos"> 493</span><span class="cp">#endif</span>
<span class="linenos"> 494</span>
<span class="linenos"> 495</span><span class="w">    </span><span class="c1">// Calculate the probability from the diffusion coefficient and the lattice properties.</span>
<span class="linenos"> 496</span><span class="w">    </span><span class="cm">/*</span>
<span class="linenos"> 497</span><span class="cm">     * p0 = probability of staying at the site, q = probability of moving in plus or minus direction</span>
<span class="linenos"> 498</span><span class="cm">     *</span>
<span class="linenos"> 499</span><span class="cm">     * D=(1-p0)*lambda^2/2*tau</span>
<span class="linenos"> 500</span><span class="cm">     * q=(1-p0)/2</span>
<span class="linenos"> 501</span><span class="cm">     * D=2q*lambda^2/2*tau</span>
<span class="linenos"> 502</span><span class="cm">     * q=D*tau/lambda^2</span>
<span class="linenos"> 503</span><span class="cm">     */</span>
<span class="linenos"> 504</span><span class="w">    </span><span class="n">model_T</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="kt">float</span><span class="p">[</span><span class="n">DFmatrixSize</span><span class="p">];</span>
<span class="linenos"> 505</span><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">DFmatrixSize</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="linenos"> 506</span><span class="w">    </span><span class="p">{</span>
<span class="linenos"> 507</span><span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">q</span><span class="o">=</span><span class="p">(</span><span class="kt">float</span><span class="p">)(</span><span class="n">DF</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">tau</span><span class="o">/</span><span class="n">pow</span><span class="p">(</span><span class="n">latticeSpacing</span><span class="p">,</span><span class="mi">2</span><span class="p">));</span>
<span class="linenos"> 508</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">q</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0.50f</span><span class="p">)</span><span class="w"> </span><span class="n">throw</span><span class="w"> </span><span class="n">InvalidArgException</span><span class="p">(</span><span class="s">&quot;D&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;The specified diffusion coefficient is too high for the diffusion model.&quot;</span><span class="p">);</span>
<span class="linenos"> 509</span><span class="w">        </span><span class="n">model_T</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">q</span><span class="p">;</span>
<span class="linenos"> 510</span><span class="w">    </span><span class="p">}</span>
<span class="linenos"> 511</span>
<span class="linenos"> 512</span><span class="w">    </span><span class="c1">// Setup the cuda reaction location matrix.</span>
<span class="linenos"> 513</span><span class="w">    </span><span class="n">model_RL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="kt">uint8_t</span><span class="p">[</span><span class="n">numberReactions</span><span class="o">*</span><span class="n">numberSiteTypes</span><span class="p">];</span>
<span class="linenos"> 514</span><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">numberReactions</span><span class="o">*</span><span class="n">numberSiteTypes</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="linenos"> 515</span><span class="w">    </span><span class="p">{</span>
<span class="linenos"> 516</span><span class="w">    	</span><span class="n">model_RL</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">RL</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="linenos"> 517</span><span class="w">    </span><span class="p">}</span>
<span class="linenos"> 518</span>
<span class="linenos"> 519</span><span class="w">    </span><span class="c1">// Set the cuda reaction model rates now that we have the subvolume size.</span>
<span class="linenos"> 520</span><span class="w">    </span><span class="n">model_reactionRates</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="kt">float</span><span class="p">[</span><span class="n">numberReactions</span><span class="p">];</span>
<span class="linenos"> 521</span>
<span class="linenos"> 522</span><span class="w">	</span><span class="c1">// Set up pre-configured propensity matrices</span>
<span class="linenos"> 523</span><span class="w">	</span><span class="n">zeroOrderSize</span><span class="o">=</span><span class="n">numberSiteTypes</span><span class="p">;</span>
<span class="linenos"> 524</span><span class="w">	</span><span class="n">firstOrderSize</span><span class="o">=</span><span class="n">numberSpecies</span><span class="o">*</span><span class="n">numberSiteTypes</span><span class="p">;</span>
<span class="linenos"> 525</span><span class="w">	</span><span class="n">secondOrderSize</span><span class="o">=</span><span class="n">numberSpecies</span><span class="o">*</span><span class="n">numberSpecies</span><span class="o">*</span><span class="n">numberSiteTypes</span><span class="p">;</span>
<span class="linenos"> 526</span><span class="w">	</span><span class="n">zeroOrder</span><span class="o">=</span><span class="n">new</span><span class="w"> </span><span class="kt">float</span><span class="p">[</span><span class="n">zeroOrderSize</span><span class="p">];</span>
<span class="linenos"> 527</span><span class="w">	</span><span class="n">firstOrder</span><span class="o">=</span><span class="n">new</span><span class="w"> </span><span class="kt">float</span><span class="p">[</span><span class="n">firstOrderSize</span><span class="p">];</span>
<span class="linenos"> 528</span><span class="w">	</span><span class="n">secondOrder</span><span class="o">=</span><span class="n">new</span><span class="w"> </span><span class="kt">float</span><span class="p">[</span><span class="n">secondOrderSize</span><span class="p">];</span>
<span class="linenos"> 529</span>
<span class="linenos"> 530</span><span class="w">	</span><span class="n">computePropensities</span><span class="p">();</span>
<span class="linenos"> 531</span><span class="w">	</span><span class="n">reactionModelModified</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="linenos"> 532</span><span class="p">}</span>
<span class="linenos"> 533</span>
<span class="linenos"> 534</span><span class="kt">void</span><span class="w"> </span><span class="n">MGPUIntMpdRdmeSolver</span><span class="o">::</span><span class="n">setLatticeData</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="o">*</span><span class="w"> </span><span class="n">latticeData</span><span class="p">)</span>
<span class="linenos"> 535</span><span class="p">{</span>
<span class="linenos"> 536</span><span class="w">    </span><span class="n">lattice_coord_t</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getSize</span><span class="p">();</span>
<span class="linenos"> 537</span><span class="w">    </span><span class="n">site_size_t</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getMaxOccupancy</span><span class="p">();</span>
<span class="linenos"> 538</span>
<span class="linenos"> 539</span><span class="w">    </span><span class="c1">// reinterpret the input as a 32-bit array</span>
<span class="linenos"> 540</span><span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="o">*</span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uint32_t</span><span class="o">*</span><span class="p">)</span><span class="n">latticeData</span><span class="p">;</span>
<span class="linenos"> 541</span>
<span class="linenos"> 542</span><span class="w">	</span><span class="n">Print</span><span class="o">::</span><span class="n">printf</span><span class="p">(</span><span class="n">Print</span><span class="o">::</span><span class="n">INFO</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Reinterpreting Lattice Data&quot;</span><span class="p">);</span>
<span class="linenos"> 543</span>
<span class="linenos"> 544</span><span class="w">    </span><span class="c1">// Set the lattice data.</span>
<span class="linenos"> 545</span><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">index</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">s</span><span class="p">.</span><span class="n">x</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="linenos"> 546</span><span class="w">    </span><span class="p">{</span>
<span class="linenos"> 547</span><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">&lt;</span><span class="n">s</span><span class="p">.</span><span class="n">y</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">++</span><span class="p">)</span>
<span class="linenos"> 548</span><span class="w">        </span><span class="p">{</span>
<span class="linenos"> 549</span><span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">k</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">k</span><span class="o">&lt;</span><span class="n">s</span><span class="p">.</span><span class="n">z</span><span class="p">;</span><span class="w"> </span><span class="n">k</span><span class="o">++</span><span class="p">)</span>
<span class="linenos"> 550</span><span class="w">            </span><span class="p">{</span>
<span class="linenos"> 551</span><span class="w">                </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">l</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">l</span><span class="o">&lt;</span><span class="n">p</span><span class="p">;</span><span class="w"> </span><span class="n">l</span><span class="o">++</span><span class="p">,</span><span class="w"> </span><span class="n">index</span><span class="o">++</span><span class="p">)</span>
<span class="linenos"> 552</span><span class="w">                </span><span class="p">{</span>
<span class="linenos"> 553</span><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="linenos"> 554</span><span class="w">                    </span><span class="p">{</span>
<span class="linenos"> 555</span><span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">numberSpecies</span><span class="p">)</span><span class="w"> </span><span class="n">throw</span><span class="w"> </span><span class="n">InvalidArgException</span><span class="p">(</span><span class="s">&quot;latticeData&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;an invalid species was found&quot;</span><span class="p">,</span><span class="n">data</span><span class="p">[</span><span class="n">index</span><span class="p">]);</span>
<span class="linenos"> 556</span><span class="w">                        </span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">addParticle</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">data</span><span class="p">[</span><span class="n">index</span><span class="p">]);</span>
<span class="linenos"> 557</span><span class="w">                    </span><span class="p">}</span>
<span class="linenos"> 558</span><span class="w">                </span><span class="p">}</span>
<span class="linenos"> 559</span><span class="w">            </span><span class="p">}</span>
<span class="linenos"> 560</span><span class="w">        </span><span class="p">}</span>
<span class="linenos"> 561</span><span class="w">    </span><span class="p">}</span>
<span class="linenos"> 562</span><span class="p">}</span>
<span class="linenos"> 563</span>
<span class="linenos"> 564</span><span class="kt">void</span><span class="w"> </span><span class="n">MGPUIntMpdRdmeSolver</span><span class="o">::</span><span class="n">computePropensities</span><span class="p">()</span>
<span class="linenos"> 565</span><span class="p">{</span>
<span class="linenos"> 566</span><span class="w">	</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeXSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getXSize</span><span class="p">();</span>
<span class="linenos"> 567</span><span class="w">	</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeYSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getYSize</span><span class="p">();</span>
<span class="linenos"> 568</span><span class="w">	</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeZSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getZSize</span><span class="p">();</span>
<span class="linenos"> 569</span><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">numberReactions</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="linenos"> 570</span><span class="w">    </span><span class="p">{</span>
<span class="linenos"> 571</span><span class="w">    	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">reactionTypes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ZerothOrderPropensityArgs</span><span class="o">::</span><span class="n">REACTION_TYPE</span><span class="p">)</span>
<span class="linenos"> 572</span><span class="w">    	</span><span class="p">{</span>
<span class="linenos"> 573</span><span class="w">    		</span><span class="n">model_reactionRates</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="n">ZerothOrderPropensityArgs</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">propensityFunctionArgs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">-&gt;</span><span class="n">k</span><span class="o">*</span><span class="n">tau</span><span class="o">/</span><span class="p">(</span><span class="n">latticeXSize</span><span class="o">*</span><span class="n">latticeYSize</span><span class="o">*</span><span class="n">latticeZSize</span><span class="p">);</span>
<span class="linenos"> 574</span><span class="w">    	</span><span class="p">}</span>
<span class="linenos"> 575</span><span class="w">    	</span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">reactionTypes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">FirstOrderPropensityArgs</span><span class="o">::</span><span class="n">REACTION_TYPE</span><span class="p">)</span>
<span class="linenos"> 576</span><span class="w">    	</span><span class="p">{</span>
<span class="linenos"> 577</span><span class="w">    		</span><span class="n">model_reactionRates</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="n">FirstOrderPropensityArgs</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">propensityFunctionArgs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">-&gt;</span><span class="n">k</span><span class="o">*</span><span class="n">tau</span><span class="p">;</span>
<span class="linenos"> 578</span><span class="w">    	</span><span class="p">}</span>
<span class="linenos"> 579</span><span class="w">    	</span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">reactionTypes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">SecondOrderPropensityArgs</span><span class="o">::</span><span class="n">REACTION_TYPE</span><span class="p">)</span>
<span class="linenos"> 580</span><span class="w">    	</span><span class="p">{</span>
<span class="linenos"> 581</span><span class="w">    		</span><span class="n">model_reactionRates</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="n">SecondOrderPropensityArgs</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">propensityFunctionArgs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">-&gt;</span><span class="n">k</span><span class="o">*</span><span class="n">tau</span><span class="o">*</span><span class="n">latticeXSize</span><span class="o">*</span><span class="n">latticeYSize</span><span class="o">*</span><span class="n">latticeZSize</span><span class="p">;</span>
<span class="linenos"> 582</span><span class="w">    	</span><span class="p">}</span>
<span class="linenos"> 583</span><span class="w">    	</span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">reactionTypes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">SecondOrderSelfPropensityArgs</span><span class="o">::</span><span class="n">REACTION_TYPE</span><span class="p">)</span>
<span class="linenos"> 584</span><span class="w">    	</span><span class="p">{</span>
<span class="linenos"> 585</span><span class="w">    		</span><span class="n">model_reactionRates</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="n">SecondOrderSelfPropensityArgs</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">propensityFunctionArgs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">-&gt;</span><span class="n">k</span><span class="o">*</span><span class="n">tau</span><span class="o">*</span><span class="n">latticeXSize</span><span class="o">*</span><span class="n">latticeYSize</span><span class="o">*</span><span class="n">latticeZSize</span><span class="p">;</span>
<span class="linenos"> 586</span><span class="w">    	</span><span class="p">}</span>
<span class="linenos"> 587</span><span class="w">    	</span><span class="k">else</span>
<span class="linenos"> 588</span><span class="w">    	</span><span class="p">{</span>
<span class="linenos"> 589</span><span class="w">    		</span><span class="n">throw</span><span class="w"> </span><span class="n">InvalidArgException</span><span class="p">(</span><span class="s">&quot;reactionTypeA&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;the reaction type was not supported by the solver&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">reactionTypes</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="linenos"> 590</span><span class="w">    	</span><span class="p">}</span>
<span class="linenos"> 591</span><span class="w">    </span><span class="p">}</span>
<span class="linenos"> 592</span>
<span class="linenos"> 593</span><span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">scale</span><span class="o">=</span><span class="n">latticeXSize</span><span class="o">*</span><span class="n">latticeYSize</span><span class="o">*</span><span class="n">latticeZSize</span><span class="p">;</span>
<span class="linenos"> 594</span><span class="w">	</span><span class="k">for</span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">site</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">site</span><span class="o">&lt;</span><span class="n">numberSiteTypes</span><span class="p">;</span><span class="w"> </span><span class="n">site</span><span class="o">++</span><span class="p">)</span>
<span class="linenos"> 595</span><span class="w">	</span><span class="p">{</span>
<span class="linenos"> 596</span><span class="w">		</span><span class="n">uint</span><span class="w"> </span><span class="n">o1</span><span class="o">=</span><span class="n">site</span><span class="o">*</span><span class="n">numberSpecies</span><span class="p">;</span>
<span class="linenos"> 597</span><span class="w">		</span><span class="n">uint</span><span class="w"> </span><span class="n">o2</span><span class="o">=</span><span class="n">site</span><span class="o">*</span><span class="n">numberSpecies</span><span class="o">*</span><span class="n">numberSpecies</span><span class="p">;</span>
<span class="linenos"> 598</span>
<span class="linenos"> 599</span><span class="w">		</span><span class="n">zeroOrder</span><span class="p">[</span><span class="n">site</span><span class="p">]</span><span class="o">=</span><span class="mf">0.0f</span><span class="p">;</span>
<span class="linenos"> 600</span><span class="w">		</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">numberSpecies</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="linenos"> 601</span><span class="w">		</span><span class="p">{</span>
<span class="linenos"> 602</span><span class="w">			</span><span class="n">firstOrder</span><span class="p">[</span><span class="n">o1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="mf">0.0f</span><span class="p">;</span>
<span class="linenos"> 603</span><span class="w">			</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">&lt;</span><span class="n">numberSpecies</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">++</span><span class="p">)</span>
<span class="linenos"> 604</span><span class="w">				</span><span class="n">secondOrder</span><span class="p">[</span><span class="n">o2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="o">*</span><span class="n">numberSpecies</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="p">]</span><span class="o">=</span><span class="mf">0.0f</span><span class="p">;</span><span class="w">	</span>
<span class="linenos"> 605</span><span class="w">		</span><span class="p">}</span>
<span class="linenos"> 606</span>
<span class="linenos"> 607</span><span class="w">		</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">numberReactions</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="linenos"> 608</span><span class="w">		</span><span class="p">{</span>
<span class="linenos"> 609</span><span class="w">			</span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="w"> </span><span class="n">RL</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="n">numberSiteTypes</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">site</span><span class="p">])</span>
<span class="linenos"> 610</span><span class="w">				</span><span class="k">continue</span><span class="p">;</span>
<span class="linenos"> 611</span>
<span class="linenos"> 612</span><span class="w">			</span><span class="k">switch</span><span class="p">(</span><span class="n">reactionTypes</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
<span class="linenos"> 613</span><span class="w">			</span><span class="p">{</span>
<span class="linenos"> 614</span><span class="w">				</span><span class="k">case</span><span class="w"> </span><span class="no">ZerothOrderPropensityArgs</span><span class="o">::</span><span class="no">REACTION_TYPE</span><span class="p">:</span>
<span class="linenos"> 615</span><span class="w">				</span><span class="p">{</span>
<span class="linenos"> 616</span><span class="w">					</span><span class="n">ZerothOrderPropensityArgs</span><span class="w"> </span><span class="o">*</span><span class="n">rx</span><span class="o">=</span><span class="p">(</span><span class="n">ZerothOrderPropensityArgs</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">propensityFunctionArgs</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="linenos"> 617</span><span class="w">					</span><span class="n">zeroOrder</span><span class="p">[</span><span class="n">site</span><span class="p">]</span><span class="o">+=</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">k</span><span class="o">*</span><span class="n">tau</span><span class="o">/</span><span class="n">scale</span><span class="p">;</span>
<span class="linenos"> 618</span><span class="w">				</span><span class="p">}</span><span class="w">   </span><span class="k">break</span><span class="p">;</span>
<span class="linenos"> 619</span>
<span class="linenos"> 620</span><span class="w">				</span><span class="k">case</span><span class="w"> </span><span class="no">FirstOrderPropensityArgs</span><span class="o">::</span><span class="no">REACTION_TYPE</span><span class="p">:</span>
<span class="linenos"> 621</span><span class="w">				</span><span class="p">{</span>
<span class="linenos"> 622</span><span class="w">					</span><span class="n">FirstOrderPropensityArgs</span><span class="w"> </span><span class="o">*</span><span class="n">rx</span><span class="o">=</span><span class="p">(</span><span class="n">FirstOrderPropensityArgs</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">propensityFunctionArgs</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="linenos"> 623</span><span class="w">					</span><span class="n">firstOrder</span><span class="p">[</span><span class="n">o1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">si</span><span class="p">]</span><span class="o">+=</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">k</span><span class="o">*</span><span class="n">tau</span><span class="p">;</span>
<span class="linenos"> 624</span><span class="w">				</span><span class="p">}</span><span class="w">   </span><span class="k">break</span><span class="p">;</span>
<span class="linenos"> 625</span><span class="w">				</span>
<span class="linenos"> 626</span><span class="w">				</span><span class="k">case</span><span class="w"> </span><span class="no">SecondOrderPropensityArgs</span><span class="o">::</span><span class="no">REACTION_TYPE</span><span class="p">:</span>
<span class="linenos"> 627</span><span class="w">				</span><span class="p">{</span>
<span class="linenos"> 628</span><span class="w">					</span><span class="n">SecondOrderPropensityArgs</span><span class="w"> </span><span class="o">*</span><span class="n">rx</span><span class="o">=</span><span class="p">(</span><span class="n">SecondOrderPropensityArgs</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">propensityFunctionArgs</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="linenos"> 629</span><span class="w">					</span><span class="n">secondOrder</span><span class="p">[</span><span class="n">o2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">s1i</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">numberSpecies</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">s2i</span><span class="p">)]</span><span class="o">=</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">k</span><span class="o">*</span><span class="n">tau</span><span class="o">*</span><span class="n">scale</span><span class="p">;</span>
<span class="linenos"> 630</span><span class="w">					</span><span class="n">secondOrder</span><span class="p">[</span><span class="n">o2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">s2i</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">numberSpecies</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">s1i</span><span class="p">)]</span><span class="o">=</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">k</span><span class="o">*</span><span class="n">tau</span><span class="o">*</span><span class="n">scale</span><span class="p">;</span>
<span class="linenos"> 631</span><span class="w">				</span><span class="p">}</span><span class="w">   </span><span class="k">break</span><span class="p">;</span><span class="w"> </span>
<span class="linenos"> 632</span>
<span class="linenos"> 633</span><span class="w">				</span><span class="k">case</span><span class="w"> </span><span class="no">SecondOrderSelfPropensityArgs</span><span class="o">::</span><span class="no">REACTION_TYPE</span><span class="p">:</span>
<span class="linenos"> 634</span><span class="w">				</span><span class="p">{</span>
<span class="linenos"> 635</span><span class="w">					</span><span class="n">SecondOrderSelfPropensityArgs</span><span class="w"> </span><span class="o">*</span><span class="n">rx</span><span class="o">=</span><span class="p">(</span><span class="n">SecondOrderSelfPropensityArgs</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">propensityFunctionArgs</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="linenos"> 636</span><span class="w">					</span><span class="n">secondOrder</span><span class="p">[</span><span class="n">o2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">si</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">numberSpecies</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">si</span><span class="p">)]</span><span class="o">+=</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">k</span><span class="o">*</span><span class="n">tau</span><span class="o">*</span><span class="n">scale</span><span class="o">*</span><span class="mi">2</span><span class="p">;</span>
<span class="linenos"> 637</span><span class="w">				</span><span class="p">}</span>
<span class="linenos"> 638</span><span class="w">			</span><span class="p">}</span>
<span class="linenos"> 639</span><span class="w">		</span><span class="p">}</span>
<span class="linenos"> 640</span><span class="w">	</span><span class="p">}</span>
<span class="linenos"> 641</span><span class="p">}</span>
<span class="linenos"> 642</span>
<span class="linenos"> 643</span><span class="kt">void</span><span class="w"> </span><span class="n">MGPUIntMpdRdmeSolver</span><span class="o">::</span><span class="n">copyModelsToDevice</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">gpu</span><span class="p">)</span>
<span class="linenos"> 644</span><span class="p">{</span>
<span class="linenos"> 645</span><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">DFmatrixSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">numberSpecies</span><span class="o">*</span><span class="n">numberSiteTypes</span><span class="o">*</span><span class="n">numberSiteTypes</span><span class="p">;</span>
<span class="linenos"> 646</span><span class="w">	</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeXSize</span><span class="o">=</span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">segment</span><span class="o">-&gt;</span><span class="n">local_dimensions</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
<span class="linenos"> 647</span><span class="w">	</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeYSize</span><span class="o">=</span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">segment</span><span class="o">-&gt;</span><span class="n">local_dimensions</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
<span class="linenos"> 648</span><span class="w">	</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeZSize</span><span class="o">=</span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">segment</span><span class="o">-&gt;</span><span class="n">local_dimensions</span><span class="p">.</span><span class="n">z</span><span class="p">;</span>
<span class="linenos"> 649</span><span class="w">	</span>
<span class="linenos"> 650</span><span class="w">	</span><span class="c1">// the lattice{X,XY,XYZ}SizeC refer to sizes of the LOCAL lattice.</span>
<span class="linenos"> 651</span><span class="w">	</span><span class="c1">// NOTE that since we have 1D diffusion only, the global X and XY sizes are the same.</span>
<span class="linenos"> 652</span><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeXYSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">latticeXSize</span><span class="o">*</span><span class="n">latticeYSize</span><span class="p">;</span>
<span class="linenos"> 653</span><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeXYZSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">latticeXSize</span><span class="o">*</span><span class="n">latticeYSize</span><span class="o">*</span><span class="n">latticeZSize</span><span class="p">;</span>
<span class="linenos"> 654</span>
<span class="linenos"> 655</span><span class="w">	</span><span class="c1">// gloal_latticeXYZSizeC is the full lattice XYZ size.  </span>
<span class="linenos"> 656</span><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">global_latticeZSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getZSize</span><span class="p">();</span>
<span class="linenos"> 657</span><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">global_latticeXYZSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">latticeXSize</span><span class="o">*</span><span class="n">latticeYSize</span><span class="o">*</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getZSize</span><span class="p">();</span>
<span class="linenos"> 658</span>
<span class="linenos"> 659</span><span class="w">    </span><span class="c1">// Copy the reaction model and S matrix to constant memory on the GPU.</span>
<span class="linenos"> 660</span><span class="cp">#ifdef MPD_GLOBAL_R_MATRIX</span>
<span class="linenos"> 661</span><span class="w">    </span><span class="c1">// R matrix put in global memory</span>
<span class="linenos"> 662</span><span class="w">    </span><span class="c1">//cudaMalloc(&amp;numberReactionsG, sizeof(unsigned int));</span>
<span class="linenos"> 663</span><span class="w">    </span><span class="c1">//cudaMemcpy(numberReactionsG, &amp;numberReactions, sizeof(unsigned int), cudaMemcpyHostToDevice);</span>
<span class="linenos"> 664</span><span class="w">    </span><span class="n">CUDA_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">cudaMemcpyToSymbol</span><span class="p">(</span><span class="n">numberReactionsC</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">numberReactions</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="p">)));</span>
<span class="linenos"> 665</span><span class="w">    </span><span class="n">cudaMalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">reactionOrdersG</span><span class="p">),</span><span class="w"> </span><span class="n">numberReactions</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="p">));</span>
<span class="linenos"> 666</span><span class="w">    </span><span class="n">cudaMemcpy</span><span class="p">(</span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">reactionOrdersG</span><span class="p">,</span><span class="w"> </span><span class="n">model_reactionOrders</span><span class="p">,</span><span class="w"> </span><span class="n">numberReactions</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="p">),</span><span class="w"> </span><span class="n">cudaMemcpyHostToDevice</span><span class="p">);</span>
<span class="linenos"> 667</span><span class="w">    </span><span class="n">cudaMalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">reactionSitesG</span><span class="p">),</span><span class="w"> </span><span class="n">numberReactions</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="p">));</span>
<span class="linenos"> 668</span><span class="w">    </span><span class="n">cudaMemcpy</span><span class="p">(</span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">reactionSitesG</span><span class="p">,</span><span class="w"> </span><span class="n">model_reactionSites</span><span class="p">,</span><span class="w"> </span><span class="n">numberReactions</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="p">),</span><span class="w"> </span><span class="n">cudaMemcpyHostToDevice</span><span class="p">);</span>
<span class="linenos"> 669</span><span class="w">    </span><span class="n">cudaMalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">D1G</span><span class="p">),</span><span class="w"> </span><span class="n">numberReactions</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="p">));</span>
<span class="linenos"> 670</span><span class="w">    </span><span class="n">cudaMemcpy</span><span class="p">(</span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">D1G</span><span class="p">,</span><span class="w"> </span><span class="n">model_D1</span><span class="p">,</span><span class="w"> </span><span class="n">numberReactions</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="p">),</span><span class="w"> </span><span class="n">cudaMemcpyHostToDevice</span><span class="p">);</span>
<span class="linenos"> 671</span><span class="w">    </span><span class="n">cudaMalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">D2G</span><span class="p">),</span><span class="w"> </span><span class="n">numberReactions</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="p">));</span>
<span class="linenos"> 672</span><span class="w">    </span><span class="n">cudaMemcpy</span><span class="p">(</span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">D2G</span><span class="p">,</span><span class="w"> </span><span class="n">model_D2</span><span class="p">,</span><span class="w"> </span><span class="n">numberReactions</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="p">),</span><span class="w"> </span><span class="n">cudaMemcpyHostToDevice</span><span class="p">);</span>
<span class="linenos"> 673</span><span class="cp">#else</span>
<span class="linenos"> 674</span><span class="w">    </span><span class="n">CUDA_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">cudaMemcpyToSymbol</span><span class="p">(</span><span class="n">numberReactionsC</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">numberReactions</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="p">)));</span>
<span class="linenos"> 675</span><span class="w">    </span><span class="n">CUDA_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">cudaMemcpyToSymbol</span><span class="p">(</span><span class="n">reactionOrdersC</span><span class="p">,</span><span class="w"> </span><span class="n">model_reactionOrders</span><span class="p">,</span><span class="w"> </span><span class="n">numberReactions</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="p">)));</span>
<span class="linenos"> 676</span><span class="w">    </span><span class="n">CUDA_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">cudaMemcpyToSymbol</span><span class="p">(</span><span class="n">reactionSitesC</span><span class="p">,</span><span class="w"> </span><span class="n">model_reactionSites</span><span class="p">,</span><span class="w"> </span><span class="n">numberReactions</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="p">)));</span>
<span class="linenos"> 677</span><span class="w">    </span><span class="n">CUDA_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">cudaMemcpyToSymbol</span><span class="p">(</span><span class="n">D1C</span><span class="p">,</span><span class="w"> </span><span class="n">model_D1</span><span class="p">,</span><span class="w"> </span><span class="n">numberReactions</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="p">)));</span>
<span class="linenos"> 678</span><span class="w">    </span><span class="n">CUDA_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">cudaMemcpyToSymbol</span><span class="p">(</span><span class="n">D2C</span><span class="p">,</span><span class="w"> </span><span class="n">model_D2</span><span class="p">,</span><span class="w"> </span><span class="n">numberReactions</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="p">)));</span>
<span class="linenos"> 679</span><span class="cp">#endif</span>
<span class="linenos"> 680</span>
<span class="linenos"> 681</span><span class="cp">#ifdef MPD_GLOBAL_S_MATRIX</span>
<span class="linenos"> 682</span><span class="w">	</span><span class="c1">// If S matrix stored in global memory, allocate space and perform copy</span>
<span class="linenos"> 683</span><span class="w">	</span><span class="n">cudaMalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">SG</span><span class="p">),</span><span class="w"> </span><span class="n">numberSpecies</span><span class="o">*</span><span class="n">numberReactions</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int8_t</span><span class="p">));</span>
<span class="linenos"> 684</span><span class="w">	</span><span class="n">cudaMemcpy</span><span class="p">(</span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">SG</span><span class="p">,</span><span class="w"> </span><span class="n">model_S</span><span class="p">,</span><span class="w"> </span><span class="n">numberSpecies</span><span class="o">*</span><span class="n">numberReactions</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int8_t</span><span class="p">),</span><span class="w"> </span><span class="n">cudaMemcpyHostToDevice</span><span class="p">);</span>
<span class="linenos"> 685</span><span class="cp">#else</span>
<span class="linenos"> 686</span><span class="w">	</span><span class="c1">// S matrix is in constant memory</span>
<span class="linenos"> 687</span><span class="w">    </span><span class="n">CUDA_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">cudaMemcpyToSymbol</span><span class="p">(</span><span class="n">SC</span><span class="p">,</span><span class="w"> </span><span class="n">model_S</span><span class="p">,</span><span class="w"> </span><span class="n">numberSpecies</span><span class="o">*</span><span class="n">numberReactions</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int8_t</span><span class="p">)));</span>
<span class="linenos"> 688</span><span class="cp">#endif</span>
<span class="linenos"> 689</span>
<span class="linenos"> 690</span><span class="cp">#ifdef MPD_GLOBAL_T_MATRIX</span>
<span class="linenos"> 691</span><span class="w">	</span><span class="n">CUDA_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">cudaMalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">TG</span><span class="p">),</span><span class="w"> </span><span class="n">DFmatrixSize</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">)));</span>
<span class="linenos"> 692</span><span class="w">	</span><span class="n">CUDA_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">cudaMemcpy</span><span class="p">(</span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">TG</span><span class="p">,</span><span class="w"> </span><span class="n">model_T</span><span class="p">,</span><span class="w"> </span><span class="n">DFmatrixSize</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">),</span><span class="w"> </span><span class="n">cudaMemcpyHostToDevice</span><span class="p">));</span>
<span class="linenos"> 693</span><span class="w">    </span><span class="n">CUDA_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">cudaMemcpyToSymbol</span><span class="p">(</span><span class="n">TC</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="p">(</span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">TG</span><span class="p">),</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="o">*</span><span class="p">)));</span>
<span class="linenos"> 694</span><span class="cp">#else</span>
<span class="linenos"> 695</span><span class="w">    </span><span class="n">CUDA_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">cudaMemcpyToSymbol</span><span class="p">(</span><span class="n">TC</span><span class="p">,</span><span class="w"> </span><span class="n">model_T</span><span class="p">,</span><span class="w"> </span><span class="n">DFmatrixSize</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">)));</span>
<span class="linenos"> 696</span><span class="cp">#endif</span>
<span class="linenos"> 697</span>
<span class="linenos"> 698</span><span class="w">    </span><span class="n">CUDA_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">cudaMemcpyToSymbol</span><span class="p">(</span><span class="n">numberSpeciesC</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">numberSpecies</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">numberSpeciesC</span><span class="p">)));</span>
<span class="linenos"> 699</span><span class="w">    </span><span class="n">CUDA_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">cudaMemcpyToSymbol</span><span class="p">(</span><span class="n">numberSiteTypesC</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">numberSiteTypes</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">numberSiteTypesC</span><span class="p">)));</span>
<span class="linenos"> 700</span><span class="w">    </span><span class="n">CUDA_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">cudaMemcpyToSymbol</span><span class="p">(</span><span class="n">latticeXSizeC</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">latticeXSize</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">latticeYSizeC</span><span class="p">)));</span>
<span class="linenos"> 701</span><span class="w">    </span><span class="n">CUDA_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">cudaMemcpyToSymbol</span><span class="p">(</span><span class="n">latticeYSizeC</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">latticeYSize</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">latticeYSizeC</span><span class="p">)));</span>
<span class="linenos"> 702</span><span class="w">    </span><span class="n">CUDA_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">cudaMemcpyToSymbol</span><span class="p">(</span><span class="n">latticeZSizeC</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">latticeZSize</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">latticeZSizeC</span><span class="p">)));</span>
<span class="linenos"> 703</span><span class="w">    </span><span class="n">CUDA_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">cudaMemcpyToSymbol</span><span class="p">(</span><span class="n">latticeXYSizeC</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">latticeXYSize</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">latticeXYSizeC</span><span class="p">)));</span>
<span class="linenos"> 704</span><span class="w">    </span><span class="n">CUDA_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">cudaMemcpyToSymbol</span><span class="p">(</span><span class="n">latticeXYZSizeC</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">latticeXYZSize</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">latticeXYZSizeC</span><span class="p">)));</span>
<span class="linenos"> 705</span><span class="w">    </span><span class="n">CUDA_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">cudaMemcpyToSymbol</span><span class="p">(</span><span class="n">global_latticeZSizeC</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">global_latticeZSize</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">global_latticeZSizeC</span><span class="p">)));</span>
<span class="linenos"> 706</span><span class="w">    </span><span class="n">CUDA_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">cudaMemcpyToSymbol</span><span class="p">(</span><span class="n">global_latticeXYZSizeC</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">global_latticeXYZSize</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">global_latticeXYZSizeC</span><span class="p">)));</span>
<span class="linenos"> 707</span><span class="cp">#ifdef MPD_GLOBAL_S_MATRIX</span>
<span class="linenos"> 708</span><span class="w">	</span><span class="c1">// Store RL in global memory too, since I&#39;m going to assume if S is too big, then RL is too.</span>
<span class="linenos"> 709</span><span class="w">	</span><span class="n">cudaMalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">RLG</span><span class="p">),</span><span class="w"> </span><span class="n">numberReactions</span><span class="o">*</span><span class="n">numberSiteTypes</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">uint8_t</span><span class="p">));</span>
<span class="linenos"> 710</span><span class="w">	</span><span class="n">cudaMemcpy</span><span class="p">(</span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">RLG</span><span class="p">,</span><span class="w"> </span><span class="n">model_RL</span><span class="p">,</span><span class="w"> </span><span class="n">numberReactions</span><span class="o">*</span><span class="n">numberSiteTypes</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">uint8_t</span><span class="p">),</span><span class="w"> </span><span class="n">cudaMemcpyHostToDevice</span><span class="p">);</span>
<span class="linenos"> 711</span><span class="cp">#else</span>
<span class="linenos"> 712</span><span class="w">	</span><span class="c1">// RL is stored in constant memory</span>
<span class="linenos"> 713</span><span class="w">    </span><span class="n">CUDA_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">cudaMemcpyToSymbol</span><span class="p">(</span><span class="n">RLC</span><span class="p">,</span><span class="w"> </span><span class="n">model_RL</span><span class="p">,</span><span class="w"> </span><span class="n">numberReactions</span><span class="o">*</span><span class="n">numberSiteTypes</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">uint8_t</span><span class="p">)));</span>
<span class="linenos"> 714</span><span class="cp">#endif</span>
<span class="linenos"> 715</span>
<span class="linenos"> 716</span><span class="cp">#ifdef MPD_GLOBAL_R_MATRIX</span>
<span class="linenos"> 717</span><span class="w">    </span><span class="n">cudaMalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">reactionRatesG</span><span class="p">),</span><span class="w"> </span><span class="n">numberReactions</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">));</span>
<span class="linenos"> 718</span><span class="w">    </span><span class="n">cudaMemcpy</span><span class="p">(</span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">reactionRatesG</span><span class="p">,</span><span class="w"> </span><span class="n">model_reactionRates</span><span class="p">,</span><span class="w"> </span><span class="n">numberReactions</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">),</span><span class="w"> </span><span class="n">cudaMemcpyHostToDevice</span><span class="p">);</span>
<span class="linenos"> 719</span><span class="cp">#else</span>
<span class="linenos"> 720</span><span class="w">    </span><span class="n">CUDA_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">cudaMemcpyToSymbol</span><span class="p">(</span><span class="n">reactionRatesC</span><span class="p">,</span><span class="w"> </span><span class="n">model_reactionRates</span><span class="p">,</span><span class="w"> </span><span class="n">numberReactions</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">)));</span>
<span class="linenos"> 721</span><span class="cp">#endif</span>
<span class="linenos"> 722</span>
<span class="linenos"> 723</span><span class="w">	</span><span class="c1">// Copy per-GPU global offsets</span>
<span class="linenos"> 724</span><span class="w">    </span><span class="c1">//CUDA_EXCEPTION_CHECK(cudaMemcpyToSymbol(lsizeXC, &amp;(threads[gpu].local_dimensions.x), sizeof(unsigned int)));</span>
<span class="linenos"> 725</span><span class="w">    </span><span class="c1">//CUDA_EXCEPTION_CHECK(cudaMemcpyToSymbol(lsizeYC, &amp;(threads[gpu].local_dimensions.y), sizeof(unsigned int)));</span>
<span class="linenos"> 726</span><span class="w">    </span><span class="c1">//CUDA_EXCEPTION_CHECK(cudaMemcpyToSymbol(lsizeZC, &amp;(threads[gpu].local_dimensions.z), sizeof(unsigned int)));</span>
<span class="linenos"> 727</span><span class="w">    </span><span class="n">CUDA_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">cudaMemcpyToSymbol</span><span class="p">(</span><span class="n">goffsetXC</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="p">(</span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">segment</span><span class="o">-&gt;</span><span class="n">global_offset</span><span class="p">.</span><span class="n">x</span><span class="p">),</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">)));</span>
<span class="linenos"> 728</span><span class="w">    </span><span class="n">CUDA_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">cudaMemcpyToSymbol</span><span class="p">(</span><span class="n">goffsetYC</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="p">(</span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">segment</span><span class="o">-&gt;</span><span class="n">global_offset</span><span class="p">.</span><span class="n">y</span><span class="p">),</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">)));</span>
<span class="linenos"> 729</span><span class="w">    </span><span class="n">CUDA_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">cudaMemcpyToSymbol</span><span class="p">(</span><span class="n">goffsetZC</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="p">(</span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">segment</span><span class="o">-&gt;</span><span class="n">global_offset</span><span class="p">.</span><span class="n">z</span><span class="p">),</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">)));</span>
<span class="linenos"> 730</span>
<span class="linenos"> 731</span><span class="w">    </span><span class="n">CUDA_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">cudaMemcpyToSymbol</span><span class="p">(</span><span class="n">gpuidC</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">gpu</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="p">)));</span>
<span class="linenos"> 732</span>
<span class="linenos"> 733</span><span class="w">	</span><span class="n">cudaMalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">propZeroOrder</span><span class="p">),</span><span class="w"> </span><span class="n">zeroOrderSize</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">));</span>
<span class="linenos"> 734</span><span class="w">	</span><span class="n">cudaMemcpy</span><span class="p">(</span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">propZeroOrder</span><span class="p">,</span><span class="w"> </span><span class="n">zeroOrder</span><span class="p">,</span><span class="w"> </span><span class="n">zeroOrderSize</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">),</span><span class="w"> </span><span class="n">cudaMemcpyHostToDevice</span><span class="p">);</span>
<span class="linenos"> 735</span><span class="w">	</span><span class="n">cudaMalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">propFirstOrder</span><span class="p">),</span><span class="w"> </span><span class="n">firstOrderSize</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">));</span>
<span class="linenos"> 736</span><span class="w">	</span><span class="n">cudaMemcpy</span><span class="p">(</span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">propFirstOrder</span><span class="p">,</span><span class="w"> </span><span class="n">firstOrder</span><span class="p">,</span><span class="w"> </span><span class="n">firstOrderSize</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">),</span><span class="w"> </span><span class="n">cudaMemcpyHostToDevice</span><span class="p">);</span>
<span class="linenos"> 737</span><span class="w">	</span><span class="n">cudaMalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">propSecondOrder</span><span class="p">),</span><span class="w"> </span><span class="n">secondOrderSize</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">));</span>
<span class="linenos"> 738</span><span class="w">	</span><span class="n">cudaMemcpy</span><span class="p">(</span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">propSecondOrder</span><span class="p">,</span><span class="w"> </span><span class="n">secondOrder</span><span class="p">,</span><span class="w"> </span><span class="n">secondOrderSize</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">),</span><span class="w"> </span><span class="n">cudaMemcpyHostToDevice</span><span class="p">);</span>
<span class="linenos"> 739</span><span class="w">	</span>
<span class="linenos"> 740</span><span class="w">	</span><span class="n">ZDivMultiGPUMapper</span><span class="w"> </span><span class="o">*</span><span class="n">zmap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">ZDivMultiGPUMapper</span><span class="o">*</span><span class="p">)</span><span class="n">mapper</span><span class="p">;</span>
<span class="linenos"> 741</span><span class="w">	</span><span class="n">gpu_info</span><span class="w"> </span><span class="o">*</span><span class="n">g</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zmap</span><span class="o">-&gt;</span><span class="n">getinfo</span><span class="p">(</span><span class="n">gpu</span><span class="p">);</span>
<span class="linenos"> 742</span><span class="w">	</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">tmp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">g</span><span class="o">-&gt;</span><span class="n">overlap_send</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">z</span><span class="p">;</span>
<span class="linenos"> 743</span><span class="w">	</span><span class="c1">// this is where give out the problem</span>
<span class="linenos"> 744</span><span class="w">	</span><span class="n">CUDA_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">cudaMemcpyToSymbol</span><span class="p">(</span><span class="n">top_send_z</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">)));</span>
<span class="linenos"> 745</span><span class="w">	</span><span class="n">tmp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">g</span><span class="o">-&gt;</span><span class="n">overlap_dim</span><span class="p">.</span><span class="n">z</span><span class="p">;</span>
<span class="linenos"> 746</span><span class="w">	</span><span class="n">CUDA_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">cudaMemcpyToSymbol</span><span class="p">(</span><span class="n">top_dim_z</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">)));</span>
<span class="linenos"> 747</span><span class="w">	</span><span class="n">tmp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DIMSIZE</span><span class="p">(</span><span class="n">g</span><span class="o">-&gt;</span><span class="n">overlap_dim</span><span class="p">);</span>
<span class="linenos"> 748</span><span class="w">	</span><span class="n">CUDA_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">cudaMemcpyToSymbol</span><span class="p">(</span><span class="n">top_dim_size</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">)));</span>
<span class="linenos"> 749</span>
<span class="linenos"> 750</span><span class="w">	</span><span class="n">tmp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">g</span><span class="o">-&gt;</span><span class="n">overlap_send</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">z</span><span class="p">;</span>
<span class="linenos"> 751</span><span class="w">	</span><span class="n">CUDA_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">cudaMemcpyToSymbol</span><span class="p">(</span><span class="n">bot_send_z</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">)));</span>
<span class="linenos"> 752</span><span class="w">	</span><span class="n">tmp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">g</span><span class="o">-&gt;</span><span class="n">overlap_dim</span><span class="p">.</span><span class="n">z</span><span class="p">;</span>
<span class="linenos"> 753</span><span class="w">	</span><span class="n">CUDA_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">cudaMemcpyToSymbol</span><span class="p">(</span><span class="n">bot_dim_z</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">)));</span>
<span class="linenos"> 754</span><span class="w">	</span><span class="n">tmp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DIMSIZE</span><span class="p">(</span><span class="n">g</span><span class="o">-&gt;</span><span class="n">overlap_dim</span><span class="p">);</span>
<span class="linenos"> 755</span><span class="w">	</span><span class="n">CUDA_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">cudaMemcpyToSymbol</span><span class="p">(</span><span class="n">bot_dim_size</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">)));</span>
<span class="linenos"> 756</span>
<span class="linenos"> 757</span><span class="w">	</span><span class="n">tmp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">g</span><span class="o">-&gt;</span><span class="n">overlap_recv</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">z</span><span class="p">;</span>
<span class="linenos"> 758</span><span class="w">	</span><span class="n">CUDA_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">cudaMemcpyToSymbol</span><span class="p">(</span><span class="n">top_recv_z</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">)));</span>
<span class="linenos"> 759</span>
<span class="linenos"> 760</span><span class="w">	</span><span class="n">tmp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">g</span><span class="o">-&gt;</span><span class="n">overlap_recv</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">z</span><span class="p">;</span>
<span class="linenos"> 761</span><span class="w">	</span><span class="n">CUDA_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">cudaMemcpyToSymbol</span><span class="p">(</span><span class="n">bot_recv_z</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">)));</span>
<span class="linenos"> 762</span><span class="p">}</span>
<span class="linenos"> 763</span>
<span class="linenos"> 764</span><span class="kt">void</span><span class="w"> </span><span class="n">MGPUIntMpdRdmeSolver</span><span class="o">::</span><span class="n">setReactionRate</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">rxid</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">rate</span><span class="p">)</span>
<span class="linenos"> 765</span><span class="p">{</span>
<span class="linenos"> 766</span><span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">reactionTypes</span><span class="p">[</span><span class="n">rxid</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ZerothOrderPropensityArgs</span><span class="o">::</span><span class="n">REACTION_TYPE</span><span class="p">)</span>
<span class="linenos"> 767</span><span class="w">	</span><span class="p">{</span>
<span class="linenos"> 768</span><span class="w">		</span><span class="p">((</span><span class="n">ZerothOrderPropensityArgs</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">propensityFunctionArgs</span><span class="p">[</span><span class="n">rxid</span><span class="p">])</span><span class="o">-&gt;</span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rate</span><span class="p">;</span>
<span class="linenos"> 769</span><span class="w">	</span><span class="p">}</span>
<span class="linenos"> 770</span><span class="w">	</span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">reactionTypes</span><span class="p">[</span><span class="n">rxid</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">FirstOrderPropensityArgs</span><span class="o">::</span><span class="n">REACTION_TYPE</span><span class="p">)</span>
<span class="linenos"> 771</span><span class="w">	</span><span class="p">{</span>
<span class="linenos"> 772</span><span class="w">		</span><span class="p">((</span><span class="n">FirstOrderPropensityArgs</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">propensityFunctionArgs</span><span class="p">[</span><span class="n">rxid</span><span class="p">])</span><span class="o">-&gt;</span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rate</span><span class="p">;</span>
<span class="linenos"> 773</span><span class="w">	</span><span class="p">}</span>
<span class="linenos"> 774</span><span class="w">	</span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">reactionTypes</span><span class="p">[</span><span class="n">rxid</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">SecondOrderPropensityArgs</span><span class="o">::</span><span class="n">REACTION_TYPE</span><span class="p">)</span>
<span class="linenos"> 775</span><span class="w">	</span><span class="p">{</span>
<span class="linenos"> 776</span><span class="w">		</span><span class="p">((</span><span class="n">SecondOrderPropensityArgs</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">propensityFunctionArgs</span><span class="p">[</span><span class="n">rxid</span><span class="p">])</span><span class="o">-&gt;</span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rate</span><span class="p">;</span>
<span class="linenos"> 777</span><span class="w">	</span><span class="p">}</span>
<span class="linenos"> 778</span><span class="w">	</span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">reactionTypes</span><span class="p">[</span><span class="n">rxid</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">SecondOrderSelfPropensityArgs</span><span class="o">::</span><span class="n">REACTION_TYPE</span><span class="p">)</span>
<span class="linenos"> 779</span><span class="w">	</span><span class="p">{</span>
<span class="linenos"> 780</span><span class="w">		</span><span class="p">((</span><span class="n">SecondOrderSelfPropensityArgs</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">propensityFunctionArgs</span><span class="p">[</span><span class="n">rxid</span><span class="p">])</span><span class="o">-&gt;</span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rate</span><span class="p">;</span>
<span class="linenos"> 781</span><span class="w">	</span><span class="p">}</span>
<span class="linenos"> 782</span><span class="w">	</span><span class="k">else</span>
<span class="linenos"> 783</span><span class="w">    </span><span class="p">{</span>
<span class="linenos"> 784</span><span class="w">    	</span><span class="n">throw</span><span class="w"> </span><span class="n">InvalidArgException</span><span class="p">(</span><span class="s">&quot;reactionTypeA&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;the reaction type was not supported by the solver&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">reactionTypes</span><span class="p">[</span><span class="n">rxid</span><span class="p">]);</span>
<span class="linenos"> 785</span><span class="w">    </span><span class="p">}</span>
<span class="linenos"> 786</span>
<span class="linenos"> 787</span><span class="w">	</span><span class="c1">// Flag to trigger re-computation of rdme propensities</span>
<span class="linenos"> 788</span><span class="w">	</span><span class="n">reactionModelModified</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="linenos"> 789</span><span class="p">}</span>
<span class="linenos"> 790</span>
<span class="linenos"> 791</span>
<span class="linenos"> 792</span><span class="kt">void</span><span class="w"> </span><span class="n">MGPUIntMpdRdmeSolver</span><span class="o">::</span><span class="n">generateTrajectory</span><span class="p">()</span>
<span class="linenos"> 793</span><span class="p">{</span>
<span class="linenos"> 794</span><span class="w">	</span><span class="c1">// Determine how to divide the lattice</span>
<span class="linenos"> 795</span><span class="w">	</span><span class="n">initialize_decomposition</span><span class="p">();</span>
<span class="linenos"> 796</span>
<span class="linenos"> 797</span><span class="w">	</span><span class="c1">// Start worker threads</span>
<span class="linenos"> 798</span><span class="w">	</span><span class="n">start_threads</span><span class="p">();</span>
<span class="linenos"> 799</span>
<span class="linenos"> 800</span><span class="w">    </span><span class="c1">// Shadow the lattice member as a cuda lattice.</span>
<span class="linenos"> 801</span><span class="w">    </span><span class="n">CudaIntLattice</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">lattice</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">CudaIntLattice</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">lattice</span><span class="p">;</span>
<span class="linenos"> 802</span>
<span class="linenos"> 803</span><span class="w">    </span><span class="c1">// Get the interval for writing species counts and lattices.</span>
<span class="linenos"> 804</span><span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">speciesCountsWriteInterval</span><span class="o">=</span><span class="n">atol</span><span class="p">((</span><span class="o">*</span><span class="n">parameters</span><span class="p">)[</span><span class="s">&quot;writeInterval&quot;</span><span class="p">].</span><span class="n">c_str</span><span class="p">());</span>
<span class="linenos"> 805</span><span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">nextSpeciesCountsWriteTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">speciesCountsWriteInterval</span><span class="p">;</span>
<span class="linenos"> 806</span><span class="w">    </span><span class="n">lm</span><span class="o">::</span><span class="n">io</span><span class="o">::</span><span class="n">SpeciesCounts</span><span class="w"> </span><span class="n">speciesCountsDataSet</span><span class="p">;</span>
<span class="linenos"> 807</span><span class="w">    </span><span class="n">speciesCountsDataSet</span><span class="p">.</span><span class="n">set_number_species</span><span class="p">(</span><span class="n">numberSpeciesToTrack</span><span class="p">);</span>
<span class="linenos"> 808</span><span class="w">    </span><span class="n">speciesCountsDataSet</span><span class="p">.</span><span class="n">set_number_entries</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="linenos"> 809</span><span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">latticeWriteInterval</span><span class="o">=</span><span class="n">atol</span><span class="p">((</span><span class="o">*</span><span class="n">parameters</span><span class="p">)[</span><span class="s">&quot;latticeWriteInterval&quot;</span><span class="p">].</span><span class="n">c_str</span><span class="p">());</span>
<span class="linenos"> 810</span><span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">nextLatticeWriteTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">latticeWriteInterval</span><span class="p">;</span>
<span class="linenos"> 811</span><span class="w">    </span><span class="n">lm</span><span class="o">::</span><span class="n">io</span><span class="o">::</span><span class="n">Lattice</span><span class="w"> </span><span class="n">latticeDataSet</span><span class="p">;</span>
<span class="linenos"> 812</span>
<span class="linenos"> 813</span><span class="w">    </span><span class="c1">// Get the simulation time limit.</span>
<span class="linenos"> 814</span><span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">maxTime</span><span class="o">=</span><span class="n">atof</span><span class="p">((</span><span class="o">*</span><span class="n">parameters</span><span class="p">)[</span><span class="s">&quot;maxTime&quot;</span><span class="p">].</span><span class="n">c_str</span><span class="p">());</span>
<span class="linenos"> 815</span><span class="w">	</span>
<span class="linenos"> 816</span><span class="w">    </span><span class="n">Print</span><span class="o">::</span><span class="n">printf</span><span class="p">(</span><span class="n">Print</span><span class="o">::</span><span class="n">INFO</span><span class="p">,</span>
<span class="linenos"> 817</span><span class="w">	              </span><span class="s">&quot;Running mpd rdme simulation with %d species, %d reactions, %d site types for %e s with tau %e. Writing species at %d and lattice at %d intervals&quot;</span><span class="p">,</span>
<span class="linenos"> 818</span><span class="w">				  </span><span class="n">numberSpecies</span><span class="p">,</span><span class="w"> </span><span class="n">numberReactions</span><span class="p">,</span><span class="w"> </span><span class="n">numberSiteTypes</span><span class="p">,</span>
<span class="linenos"> 819</span><span class="w">				  </span><span class="n">maxTime</span><span class="p">,</span><span class="w"> </span><span class="n">tau</span><span class="p">,</span>
<span class="linenos"> 820</span><span class="w">				  </span><span class="n">speciesCountsWriteInterval</span><span class="p">,</span><span class="w"> </span><span class="n">latticeWriteInterval</span><span class="p">);</span>
<span class="linenos"> 821</span>
<span class="linenos"> 822</span><span class="w">    </span><span class="c1">// Set the initial time.</span>
<span class="linenos"> 823</span><span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>
<span class="linenos"> 824</span><span class="w">	</span><span class="n">current_timestep</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos"> 825</span>
<span class="linenos"> 826</span><span class="w">	</span><span class="kt">bool</span><span class="w"> </span><span class="n">hookEnabled</span><span class="o">=</span><span class="nb">false</span><span class="p">;</span>
<span class="linenos"> 827</span><span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">nextHookTime</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<span class="linenos"> 828</span><span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">hookInterval</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<span class="linenos"> 829</span>
<span class="linenos"> 830</span><span class="w">	</span><span class="c1">// Find out at what interval to hook simulations</span>
<span class="linenos"> 831</span><span class="w">    </span><span class="k">if</span><span class="p">((</span><span class="o">*</span><span class="n">parameters</span><span class="p">)[</span><span class="s">&quot;hookInterval&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">)</span>
<span class="linenos"> 832</span><span class="w">    </span><span class="p">{</span>
<span class="linenos"> 833</span><span class="w">        </span><span class="n">hookInterval</span><span class="o">=</span><span class="n">atol</span><span class="p">((</span><span class="o">*</span><span class="n">parameters</span><span class="p">)[</span><span class="s">&quot;hookInterval&quot;</span><span class="p">].</span><span class="n">c_str</span><span class="p">());</span>
<span class="linenos"> 834</span><span class="w">        </span><span class="n">hookEnabled</span><span class="o">=</span><span class="nb">true</span><span class="p">;</span>
<span class="linenos"> 835</span><span class="w">        </span><span class="n">nextHookTime</span><span class="o">=</span><span class="n">hookInterval</span><span class="p">;</span>
<span class="linenos"> 836</span><span class="w">    </span><span class="p">}</span>
<span class="linenos"> 837</span><span class="w">	</span><span class="c1">//timer for record</span>
<span class="linenos"> 838</span><span class="w">	</span><span class="n">Timer</span><span class="w"> </span><span class="n">timer</span><span class="p">;</span>
<span class="linenos"> 839</span><span class="w">	</span><span class="n">timer</span><span class="p">.</span><span class="n">tick</span><span class="p">();</span>
<span class="linenos"> 840</span><span class="w">	</span><span class="kt">double</span><span class="w"> </span><span class="n">lastT</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<span class="linenos"> 841</span><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">lastSteps</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<span class="linenos"> 842</span><span class="w">	</span><span class="c1">// Find out at what interval to write status messages</span>
<span class="linenos"> 843</span><span class="w">    </span><span class="n">printPerfInterval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">60</span><span class="p">;</span>
<span class="linenos"> 844</span><span class="w">    </span><span class="k">if</span><span class="p">((</span><span class="o">*</span><span class="n">parameters</span><span class="p">)[</span><span class="s">&quot;perfPrintInterval&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">)</span>
<span class="linenos"> 845</span><span class="w">    </span><span class="p">{</span>
<span class="linenos"> 846</span><span class="w">        </span><span class="n">printPerfInterval</span><span class="o">=</span><span class="n">atof</span><span class="p">((</span><span class="o">*</span><span class="n">parameters</span><span class="p">)[</span><span class="s">&quot;perfPrintInterval&quot;</span><span class="p">].</span><span class="n">c_str</span><span class="p">());</span>
<span class="linenos"> 847</span><span class="w">    </span><span class="p">}</span>
<span class="linenos"> 848</span>
<span class="linenos"> 849</span><span class="w">    </span><span class="c1">// Record the initial species counts.</span>
<span class="linenos"> 850</span><span class="w">    </span><span class="n">recordSpeciesCounts</span><span class="p">(</span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="n">lattice</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">speciesCountsDataSet</span><span class="p">);</span>
<span class="linenos"> 851</span>
<span class="linenos"> 852</span><span class="w">    </span><span class="c1">// Write the initial lattice.</span>
<span class="linenos"> 853</span><span class="w">    </span><span class="n">writeLatticeData</span><span class="p">(</span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="n">lattice</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">latticeDataSet</span><span class="p">);</span>
<span class="linenos"> 854</span>
<span class="linenos"> 855</span><span class="w">	</span><span class="c1">// Perform an initial hook check</span>
<span class="linenos"> 856</span><span class="w">    </span><span class="n">hookCheckSimulation</span><span class="p">(</span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="n">lattice</span><span class="p">);</span>
<span class="linenos"> 857</span>
<span class="linenos"> 858</span><span class="w">    </span><span class="c1">// Loop until we have finished the simulation.</span>
<span class="linenos"> 859</span><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">time</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">maxTime</span><span class="p">)</span>
<span class="linenos"> 860</span><span class="w">    </span><span class="p">{</span>
<span class="linenos"> 861</span><span class="w">		</span><span class="c1">// compute number of steps to batch</span>
<span class="linenos"> 862</span><span class="w">		</span><span class="kt">int</span><span class="w"> </span><span class="n">nSteps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">min</span><span class="p">(</span><span class="n">nextLatticeWriteTime</span><span class="o">-</span><span class="n">current_timestep</span><span class="p">,</span>
<span class="linenos"> 863</span><span class="w">			         </span><span class="n">min</span><span class="p">(</span><span class="n">nextSpeciesCountsWriteTime</span><span class="o">-</span><span class="n">current_timestep</span><span class="p">,</span>
<span class="linenos"> 864</span><span class="w">			         </span><span class="n">min</span><span class="p">(</span><span class="n">nextHookTime</span><span class="o">-</span><span class="n">current_timestep</span><span class="p">,</span>
<span class="linenos"> 865</span><span class="w">					 </span><span class="p">((</span><span class="kt">uint32_t</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">ceil</span><span class="p">(</span><span class="n">maxTime</span><span class="o">/</span><span class="n">tau</span><span class="p">)</span><span class="o">-</span><span class="n">current_timestep</span><span class="p">)))));</span>
<span class="linenos"> 866</span>
<span class="linenos"> 867</span><span class="w">		</span><span class="k">if</span><span class="p">(</span><span class="n">nSteps</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="n">nSteps</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
<span class="linenos"> 868</span><span class="w">		</span><span class="n">assert</span><span class="p">(</span><span class="n">nSteps</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="linenos"> 869</span><span class="w">		</span><span class="c1">//add timer here</span>
<span class="linenos"> 870</span><span class="w">		</span><span class="c1">//current_timestep += nSteps;</span>
<span class="linenos"> 871</span><span class="w">		</span><span class="n">lastSteps</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">nSteps</span><span class="p">;</span>
<span class="linenos"> 872</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">lastT</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">printPerfInterval</span><span class="p">)</span>
<span class="linenos"> 873</span><span class="w">        </span><span class="p">{</span>
<span class="linenos"> 874</span><span class="w">            </span><span class="kt">double</span><span class="w"> </span><span class="n">stepTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lastT</span><span class="o">/</span><span class="n">lastSteps</span><span class="p">;</span>
<span class="linenos"> 875</span><span class="w">            </span><span class="kt">double</span><span class="w"> </span><span class="n">completionTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stepTime</span><span class="o">*</span><span class="p">(</span><span class="n">maxTime</span><span class="o">-</span><span class="n">time</span><span class="p">)</span><span class="o">/</span><span class="n">tau</span><span class="p">;</span>
<span class="linenos"> 876</span><span class="w">            </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">units</span><span class="p">;</span>
<span class="linenos"> 877</span><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">completionTime</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">24</span><span class="o">*</span><span class="mi">365</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 878</span><span class="w">                </span><span class="n">units</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;weeks&quot;</span><span class="p">;</span>
<span class="linenos"> 879</span><span class="w">                </span><span class="n">completionTime</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">24</span><span class="o">*</span><span class="mi">365</span><span class="p">;</span>
<span class="linenos"> 880</span><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">completionTime</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">24</span><span class="o">*</span><span class="mi">30</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 881</span><span class="w">                </span><span class="n">units</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;months&quot;</span><span class="p">;</span>
<span class="linenos"> 882</span><span class="w">                </span><span class="n">completionTime</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">24</span><span class="o">*</span><span class="mi">30</span><span class="p">;</span>
<span class="linenos"> 883</span><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">completionTime</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">24</span><span class="o">*</span><span class="mi">7</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 884</span><span class="w">                </span><span class="n">units</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;weeks&quot;</span><span class="p">;</span>
<span class="linenos"> 885</span><span class="w">                </span><span class="n">completionTime</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">24</span><span class="o">*</span><span class="mi">7</span><span class="p">;</span>
<span class="linenos"> 886</span><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">completionTime</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">24</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 887</span><span class="w">                </span><span class="n">units</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;days&quot;</span><span class="p">;</span>
<span class="linenos"> 888</span><span class="w">                </span><span class="n">completionTime</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">24</span><span class="p">;</span>
<span class="linenos"> 889</span><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">completionTime</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 890</span><span class="w">                </span><span class="n">units</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;hours&quot;</span><span class="p">;</span>
<span class="linenos"> 891</span><span class="w">                </span><span class="n">completionTime</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="p">;</span>
<span class="linenos"> 892</span><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">completionTime</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">60</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 893</span><span class="w">                </span><span class="n">units</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;minutes&quot;</span><span class="p">;</span>
<span class="linenos"> 894</span><span class="w">                </span><span class="n">completionTime</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="mi">60</span><span class="p">;</span>
<span class="linenos"> 895</span><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 896</span><span class="w">                </span><span class="n">units</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;seconds&quot;</span><span class="p">;</span>
<span class="linenos"> 897</span><span class="w">            </span><span class="p">}</span>
<span class="linenos"> 898</span>
<span class="linenos"> 899</span><span class="w">            </span><span class="n">Print</span><span class="o">::</span><span class="n">printf</span><span class="p">(</span><span class="n">Print</span><span class="o">::</span><span class="n">INFO</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Average walltime per timestep: %.2f ms. Progress: %.4fs/%.4fs (% .3g%% done / %.2g %s walltime remaining)&quot;</span><span class="p">,</span>
<span class="linenos"> 900</span><span class="w">                                       </span><span class="mf">1000.0</span><span class="o">*</span><span class="n">stepTime</span><span class="p">,</span><span class="w"> </span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="n">maxTime</span><span class="p">,</span><span class="w"> </span><span class="mf">100.0</span><span class="o">*</span><span class="n">time</span><span class="o">/</span><span class="n">maxTime</span><span class="p">,</span><span class="w"> </span><span class="n">completionTime</span><span class="p">,</span><span class="w"> </span><span class="n">units</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
<span class="linenos"> 901</span>
<span class="linenos"> 902</span><span class="w">            </span><span class="n">lastT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos"> 903</span><span class="w">            </span><span class="n">lastSteps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos"> 904</span><span class="w">        </span><span class="p">}</span>
<span class="linenos"> 905</span><span class="w">		</span><span class="c1">// normal program continue</span>
<span class="linenos"> 906</span><span class="w">		</span><span class="n">timesteps_to_run</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nSteps</span><span class="p">;</span>
<span class="linenos"> 907</span>
<span class="linenos"> 908</span><span class="w">		</span><span class="c1">// wake up threads</span>
<span class="linenos"> 909</span><span class="w">		</span><span class="n">pthread_barrier_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">start_barrier</span><span class="p">);</span>
<span class="linenos"> 910</span>
<span class="linenos"> 911</span><span class="w">		</span><span class="c1">// ... and wait.</span>
<span class="linenos"> 912</span><span class="w">		</span><span class="n">pthread_barrier_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stop_barrier</span><span class="p">);</span>
<span class="linenos"> 913</span><span class="w">		</span>
<span class="linenos"> 914</span><span class="w">		</span><span class="k">if</span><span class="p">(</span><span class="n">globalAbort</span><span class="p">)</span>
<span class="linenos"> 915</span><span class="w">		</span><span class="p">{</span>
<span class="linenos"> 916</span><span class="w">			</span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Global abort: terminating solver&quot;</span><span class="p">);</span>
<span class="linenos"> 917</span><span class="w">			</span><span class="k">break</span><span class="p">;</span>
<span class="linenos"> 918</span><span class="w">		</span><span class="p">}</span>
<span class="linenos"> 919</span>
<span class="linenos"> 920</span><span class="w">        </span><span class="c1">// Advance the timestep counter</span>
<span class="linenos"> 921</span><span class="w">		</span><span class="n">current_timestep</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">nSteps</span><span class="p">;</span>
<span class="linenos"> 922</span>
<span class="linenos"> 923</span><span class="w">		</span><span class="c1">// Update the time</span>
<span class="linenos"> 924</span><span class="w">        </span><span class="n">time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">current_timestep</span><span class="o">*</span><span class="n">tau</span><span class="p">;</span>
<span class="linenos"> 925</span>
<span class="linenos"> 926</span><span class="w">		</span><span class="c1">// No need to sync from gpus first; each gpu thread does a stage_out</span>
<span class="linenos"> 927</span><span class="w">		</span><span class="c1">// prior to entering the stop barrier</span>
<span class="linenos"> 928</span><span class="w">		</span><span class="c1">// clear the flag for if reaction model has changed</span>
<span class="linenos"> 929</span><span class="w">		</span><span class="n">reactionModelModified</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="linenos"> 930</span><span class="w">		</span><span class="c1">// Also no need to check the return value of the hook as a stage in is always done</span>
<span class="linenos"> 931</span><span class="w">		</span><span class="c1">// at the beginning of the timestep batch</span>
<span class="linenos"> 932</span>
<span class="linenos"> 933</span><span class="w">	    </span><span class="c1">// Check if we need to execute the hook</span>
<span class="linenos"> 934</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">hookEnabled</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">current_timestep</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">nextHookTime</span><span class="p">)</span>
<span class="linenos"> 935</span><span class="w">        </span><span class="p">{</span>
<span class="linenos"> 936</span><span class="w">            </span><span class="c1">// lattice-&gt;copyFromGPU();</span>
<span class="linenos"> 937</span><span class="w">            </span><span class="n">Print</span><span class="o">::</span><span class="n">printf</span><span class="p">(</span><span class="n">Print</span><span class="o">::</span><span class="n">INFO</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Hook time is %.14f, in steps is %d&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="n">nextHookTime</span><span class="p">);</span>
<span class="linenos"> 938</span><span class="w">            </span><span class="n">hookCheckSimulation</span><span class="p">(</span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="n">lattice</span><span class="p">);</span>
<span class="linenos"> 939</span><span class="w">            </span><span class="n">nextHookTime</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">hookInterval</span><span class="p">;</span>
<span class="linenos"> 940</span><span class="w">            </span><span class="n">Print</span><span class="o">::</span><span class="n">printf</span><span class="p">(</span><span class="n">Print</span><span class="o">::</span><span class="n">INFO</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Next hook time is %d&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">nextHookTime</span><span class="p">);</span>
<span class="linenos"> 941</span><span class="w">        </span><span class="p">}</span>
<span class="linenos"> 942</span>
<span class="linenos"> 943</span><span class="w">        </span><span class="c1">// See if we need to write the lattice.</span>
<span class="linenos"> 944</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">current_timestep</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">nextLatticeWriteTime</span><span class="p">)</span>
<span class="linenos"> 945</span><span class="w">        </span><span class="p">{</span>
<span class="linenos"> 946</span><span class="w">            </span><span class="n">PROF_BEGIN</span><span class="p">(</span><span class="n">PROF_SERIALIZE_LATTICE</span><span class="p">);</span>
<span class="linenos"> 947</span><span class="w">            </span><span class="n">writeLatticeData</span><span class="p">(</span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="n">lattice</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">latticeDataSet</span><span class="p">);</span>
<span class="linenos"> 948</span><span class="w">            </span><span class="n">nextLatticeWriteTime</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">latticeWriteInterval</span><span class="p">;</span>
<span class="linenos"> 949</span><span class="w">            </span><span class="n">PROF_END</span><span class="p">(</span><span class="n">PROF_SERIALIZE_LATTICE</span><span class="p">);</span>
<span class="linenos"> 950</span><span class="w">        </span><span class="p">}</span>
<span class="linenos"> 951</span>
<span class="linenos"> 952</span><span class="w">        </span><span class="c1">// See if we need to write the species counts.</span>
<span class="linenos"> 953</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">current_timestep</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">nextSpeciesCountsWriteTime</span><span class="p">)</span>
<span class="linenos"> 954</span><span class="w">        </span><span class="p">{</span>
<span class="linenos"> 955</span><span class="w">            </span><span class="n">PROF_BEGIN</span><span class="p">(</span><span class="n">PROF_DETERMINE_COUNTS</span><span class="p">);</span>
<span class="linenos"> 956</span><span class="w">            </span><span class="n">recordSpeciesCounts</span><span class="p">(</span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="n">lattice</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">speciesCountsDataSet</span><span class="p">);</span>
<span class="linenos"> 957</span><span class="w">            </span><span class="n">nextSpeciesCountsWriteTime</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">speciesCountsWriteInterval</span><span class="p">;</span>
<span class="linenos"> 958</span><span class="w">            </span><span class="n">PROF_END</span><span class="p">(</span><span class="n">PROF_DETERMINE_COUNTS</span><span class="p">);</span>
<span class="linenos"> 959</span>
<span class="linenos"> 960</span><span class="w">            </span><span class="c1">// See if we have accumulated enough species counts to send.</span>
<span class="linenos"> 961</span><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">speciesCountsDataSet</span><span class="p">.</span><span class="n">number_entries</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">TUNE_SPECIES_COUNTS_BUFFER_SIZE</span><span class="p">)</span>
<span class="linenos"> 962</span><span class="w">            </span><span class="p">{</span>
<span class="linenos"> 963</span><span class="w">                </span><span class="n">PROF_BEGIN</span><span class="p">(</span><span class="n">PROF_SERIALIZE_COUNTS</span><span class="p">);</span>
<span class="linenos"> 964</span><span class="w">                </span><span class="n">writeSpeciesCounts</span><span class="p">(</span><span class="o">&amp;</span><span class="n">speciesCountsDataSet</span><span class="p">);</span>
<span class="linenos"> 965</span><span class="w">                </span><span class="n">PROF_END</span><span class="p">(</span><span class="n">PROF_SERIALIZE_COUNTS</span><span class="p">);</span>
<span class="linenos"> 966</span><span class="w">            </span><span class="p">}</span>
<span class="linenos"> 967</span><span class="w">        </span><span class="p">}</span>
<span class="linenos"> 968</span><span class="w">    </span><span class="p">}</span>
<span class="linenos"> 969</span>
<span class="linenos"> 970</span><span class="w">    </span><span class="c1">// Write any remaining species counts.</span>
<span class="linenos"> 971</span><span class="w">    </span><span class="n">writeSpeciesCounts</span><span class="p">(</span><span class="o">&amp;</span><span class="n">speciesCountsDataSet</span><span class="p">);</span>
<span class="linenos"> 972</span>
<span class="linenos"> 973</span><span class="w">	</span><span class="c1">// take down threads</span>
<span class="linenos"> 974</span><span class="w">	</span><span class="n">timesteps_to_run</span><span class="o">=</span><span class="mi">-1</span><span class="p">;</span>
<span class="linenos"> 975</span><span class="w">	</span><span class="n">Print</span><span class="o">::</span><span class="n">printf</span><span class="p">(</span><span class="n">Print</span><span class="o">::</span><span class="n">DEBUG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;all done, tear down&quot;</span><span class="p">);</span>
<span class="linenos"> 976</span><span class="w">	</span><span class="n">pthread_barrier_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">start_barrier</span><span class="p">);</span>
<span class="linenos"> 977</span><span class="w">	</span><span class="n">Print</span><span class="o">::</span><span class="n">printf</span><span class="p">(</span><span class="n">Print</span><span class="o">::</span><span class="n">DEBUG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;stop all threads&quot;</span><span class="p">);</span>
<span class="linenos"> 978</span><span class="w">	</span>
<span class="linenos"> 979</span><span class="w">	</span><span class="n">stop_threads</span><span class="p">();</span>
<span class="linenos"> 980</span><span class="p">}</span>
<span class="linenos"> 981</span>
<span class="linenos"> 982</span><span class="kt">void</span><span class="w"> </span><span class="n">MGPUIntMpdRdmeSolver</span><span class="o">::</span><span class="n">writeLatticeData</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="n">CudaIntLattice</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">lattice</span><span class="p">,</span><span class="w"> </span><span class="n">lm</span><span class="o">::</span><span class="n">io</span><span class="o">::</span><span class="n">Lattice</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">latticeDataSet</span><span class="p">)</span>
<span class="linenos"> 983</span><span class="p">{</span>
<span class="linenos"> 984</span><span class="w">    </span><span class="n">Print</span><span class="o">::</span><span class="n">printf</span><span class="p">(</span><span class="n">Print</span><span class="o">::</span><span class="n">DEBUG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Writing lattice at %e s&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">time</span><span class="p">);</span>
<span class="linenos"> 985</span>
<span class="linenos"> 986</span><span class="w">    </span><span class="c1">// Record the lattice data.</span>
<span class="linenos"> 987</span><span class="w">    </span><span class="n">latticeDataSet</span><span class="o">-&gt;</span><span class="n">Clear</span><span class="p">();</span>
<span class="linenos"> 988</span><span class="w">    </span><span class="n">latticeDataSet</span><span class="o">-&gt;</span><span class="n">set_lattice_x_size</span><span class="p">(</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getSize</span><span class="p">().</span><span class="n">x</span><span class="p">);</span>
<span class="linenos"> 989</span><span class="w">    </span><span class="n">latticeDataSet</span><span class="o">-&gt;</span><span class="n">set_lattice_y_size</span><span class="p">(</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getSize</span><span class="p">().</span><span class="n">y</span><span class="p">);</span>
<span class="linenos"> 990</span><span class="w">    </span><span class="n">latticeDataSet</span><span class="o">-&gt;</span><span class="n">set_lattice_z_size</span><span class="p">(</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getSize</span><span class="p">().</span><span class="n">z</span><span class="p">);</span>
<span class="linenos"> 991</span><span class="w">    </span><span class="n">latticeDataSet</span><span class="o">-&gt;</span><span class="n">set_particles_per_site</span><span class="p">(</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getMaxOccupancy</span><span class="p">());</span>
<span class="linenos"> 992</span><span class="w">    </span><span class="n">latticeDataSet</span><span class="o">-&gt;</span><span class="n">set_time</span><span class="p">(</span><span class="n">time</span><span class="p">);</span>
<span class="linenos"> 993</span>
<span class="linenos"> 994</span><span class="w">    </span><span class="c1">// Push it to the output queue.</span>
<span class="linenos"> 995</span><span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">payloadSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">size_t</span><span class="p">(</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getSize</span><span class="p">().</span><span class="n">x</span><span class="p">)</span><span class="o">*</span><span class="kt">size_t</span><span class="p">(</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getSize</span><span class="p">().</span><span class="n">y</span><span class="p">)</span><span class="o">*</span><span class="kt">size_t</span><span class="p">(</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getSize</span><span class="p">().</span><span class="n">z</span><span class="p">)</span><span class="o">*</span><span class="kt">size_t</span><span class="p">(</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getMaxOccupancy</span><span class="p">())</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">);</span>
<span class="linenos"> 996</span>
<span class="linenos"> 997</span><span class="w">    </span><span class="n">lm</span><span class="o">::</span><span class="n">main</span><span class="o">::</span><span class="n">DataOutputQueue</span><span class="o">::</span><span class="n">getInstance</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">pushDataSet</span><span class="p">(</span><span class="n">lm</span><span class="o">::</span><span class="n">main</span><span class="o">::</span><span class="n">DataOutputQueue</span><span class="o">::</span><span class="n">INT_LATTICE</span><span class="p">,</span><span class="w"> </span><span class="n">replicate</span><span class="p">,</span><span class="w"> </span><span class="n">latticeDataSet</span><span class="p">,</span><span class="w"> </span><span class="n">lattice</span><span class="p">,</span><span class="w"> </span><span class="n">payloadSize</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">lm</span><span class="o">::</span><span class="n">rdme</span><span class="o">::</span><span class="n">IntLattice</span><span class="o">::</span><span class="n">nativeSerialize</span><span class="p">);</span>
<span class="linenos"> 998</span><span class="p">}</span>
<span class="linenos"> 999</span>
<span class="linenos">1000</span><span class="kt">void</span><span class="w"> </span><span class="n">MGPUIntMpdRdmeSolver</span><span class="o">::</span><span class="n">writeLatticeSites</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="n">CudaIntLattice</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">lattice</span><span class="p">)</span>
<span class="linenos">1001</span><span class="p">{</span>
<span class="linenos">1002</span><span class="w">    </span><span class="n">Print</span><span class="o">::</span><span class="n">printf</span><span class="p">(</span><span class="n">Print</span><span class="o">::</span><span class="n">DEBUG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Writing lattice sites at %e s&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">time</span><span class="p">);</span>
<span class="linenos">1003</span>
<span class="linenos">1004</span><span class="w">    </span><span class="n">lm</span><span class="o">::</span><span class="n">io</span><span class="o">::</span><span class="n">Lattice</span><span class="w"> </span><span class="n">latticeDataSet</span><span class="p">;</span>
<span class="linenos">1005</span><span class="w">    </span><span class="c1">// Record the lattice data.</span>
<span class="linenos">1006</span><span class="w">    </span><span class="n">latticeDataSet</span><span class="p">.</span><span class="n">Clear</span><span class="p">();</span>
<span class="linenos">1007</span><span class="w">    </span><span class="n">latticeDataSet</span><span class="p">.</span><span class="n">set_lattice_x_size</span><span class="p">(</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getSize</span><span class="p">().</span><span class="n">x</span><span class="p">);</span>
<span class="linenos">1008</span><span class="w">    </span><span class="n">latticeDataSet</span><span class="p">.</span><span class="n">set_lattice_y_size</span><span class="p">(</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getSize</span><span class="p">().</span><span class="n">y</span><span class="p">);</span>
<span class="linenos">1009</span><span class="w">    </span><span class="n">latticeDataSet</span><span class="p">.</span><span class="n">set_lattice_z_size</span><span class="p">(</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getSize</span><span class="p">().</span><span class="n">z</span><span class="p">);</span>
<span class="linenos">1010</span><span class="w">    </span><span class="n">latticeDataSet</span><span class="p">.</span><span class="n">set_particles_per_site</span><span class="p">(</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getMaxOccupancy</span><span class="p">());</span>
<span class="linenos">1011</span><span class="w">    </span><span class="n">latticeDataSet</span><span class="p">.</span><span class="n">set_time</span><span class="p">(</span><span class="n">time</span><span class="p">);</span>
<span class="linenos">1012</span>
<span class="linenos">1013</span><span class="w">    </span><span class="c1">// Push it to the output queue.</span>
<span class="linenos">1014</span><span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">payloadSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getSize</span><span class="p">().</span><span class="n">x</span><span class="o">*</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getSize</span><span class="p">().</span><span class="n">y</span><span class="o">*</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getSize</span><span class="p">().</span><span class="n">z</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">uint8_t</span><span class="p">);</span>
<span class="linenos">1015</span><span class="w">    </span><span class="n">lm</span><span class="o">::</span><span class="n">main</span><span class="o">::</span><span class="n">DataOutputQueue</span><span class="o">::</span><span class="n">getInstance</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">pushDataSet</span><span class="p">(</span><span class="n">lm</span><span class="o">::</span><span class="n">main</span><span class="o">::</span><span class="n">DataOutputQueue</span><span class="o">::</span><span class="n">SITE_LATTICE</span><span class="p">,</span>
<span class="linenos">1016</span><span class="w">	                                                      </span><span class="n">replicate</span><span class="p">,</span>
<span class="linenos">1017</span><span class="w">														  </span><span class="o">&amp;</span><span class="n">latticeDataSet</span><span class="p">,</span>
<span class="linenos">1018</span><span class="w">														  </span><span class="n">lattice</span><span class="p">,</span>
<span class="linenos">1019</span><span class="w">														  </span><span class="n">payloadSize</span><span class="p">,</span>
<span class="linenos">1020</span><span class="w">														  </span><span class="o">&amp;</span><span class="n">lm</span><span class="o">::</span><span class="n">rdme</span><span class="o">::</span><span class="n">ByteLattice</span><span class="o">::</span><span class="n">nativeSerializeSites</span><span class="p">);</span>
<span class="linenos">1021</span><span class="p">}</span>
<span class="linenos">1022</span>
<span class="linenos">1023</span><span class="kt">void</span><span class="w"> </span><span class="n">MGPUIntMpdRdmeSolver</span><span class="o">::</span><span class="n">recordSpeciesCounts</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="n">CudaIntLattice</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">lattice</span><span class="p">,</span><span class="w"> </span><span class="n">lm</span><span class="o">::</span><span class="n">io</span><span class="o">::</span><span class="n">SpeciesCounts</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">speciesCountsDataSet</span><span class="p">)</span>
<span class="linenos">1024</span><span class="p">{</span>
<span class="linenos">1025</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">particle_t</span><span class="p">,</span><span class="n">uint</span><span class="o">&gt;</span><span class="w"> </span><span class="n">particleCounts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getParticleCounts</span><span class="p">();</span>
<span class="linenos">1026</span>
<span class="linenos">1027</span><span class="w">    </span><span class="n">speciesCountsDataSet</span><span class="o">-&gt;</span><span class="n">set_number_entries</span><span class="p">(</span><span class="n">speciesCountsDataSet</span><span class="o">-&gt;</span><span class="n">number_entries</span><span class="p">()</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
<span class="linenos">1028</span><span class="w">    </span><span class="n">speciesCountsDataSet</span><span class="o">-&gt;</span><span class="n">add_time</span><span class="p">(</span><span class="n">time</span><span class="p">);</span>
<span class="linenos">1029</span><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">particle_t</span><span class="w"> </span><span class="n">p</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">p</span><span class="o">&lt;</span><span class="n">numberSpeciesToTrack</span><span class="p">;</span><span class="w"> </span><span class="n">p</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">1030</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">1031</span><span class="w">        </span><span class="n">speciesCountsDataSet</span><span class="o">-&gt;</span><span class="n">add_species_count</span><span class="p">((</span><span class="n">particleCounts</span><span class="p">.</span><span class="n">count</span><span class="p">(</span><span class="n">p</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span><span class="o">?</span><span class="n">particleCounts</span><span class="p">[</span><span class="n">p</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">:</span><span class="mi">0</span><span class="p">);</span>
<span class="linenos">1032</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">1033</span><span class="p">}</span>
<span class="linenos">1034</span>
<span class="linenos">1035</span><span class="kt">void</span><span class="w"> </span><span class="n">MGPUIntMpdRdmeSolver</span><span class="o">::</span><span class="n">writeSpeciesCounts</span><span class="p">(</span><span class="n">lm</span><span class="o">::</span><span class="n">io</span><span class="o">::</span><span class="n">SpeciesCounts</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">speciesCountsDataSet</span><span class="p">)</span>
<span class="linenos">1036</span><span class="p">{</span>
<span class="linenos">1037</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">speciesCountsDataSet</span><span class="o">-&gt;</span><span class="n">number_entries</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">1038</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">1039</span><span class="w">        </span><span class="c1">// Push it to the output queue.</span>
<span class="linenos">1040</span><span class="w">        </span><span class="n">lm</span><span class="o">::</span><span class="n">main</span><span class="o">::</span><span class="n">DataOutputQueue</span><span class="o">::</span><span class="n">getInstance</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">pushDataSet</span><span class="p">(</span><span class="n">lm</span><span class="o">::</span><span class="n">main</span><span class="o">::</span><span class="n">DataOutputQueue</span><span class="o">::</span><span class="n">SPECIES_COUNTS</span><span class="p">,</span><span class="w"> </span><span class="n">replicate</span><span class="p">,</span><span class="w"> </span><span class="n">speciesCountsDataSet</span><span class="p">);</span>
<span class="linenos">1041</span>
<span class="linenos">1042</span><span class="w">        </span><span class="c1">// Reset the data set.</span>
<span class="linenos">1043</span><span class="w">        </span><span class="n">speciesCountsDataSet</span><span class="o">-&gt;</span><span class="n">Clear</span><span class="p">();</span>
<span class="linenos">1044</span><span class="w">        </span><span class="n">speciesCountsDataSet</span><span class="o">-&gt;</span><span class="n">set_number_species</span><span class="p">(</span><span class="n">numberSpeciesToTrack</span><span class="p">);</span>
<span class="linenos">1045</span><span class="w">        </span><span class="n">speciesCountsDataSet</span><span class="o">-&gt;</span><span class="n">set_number_entries</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="linenos">1046</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">1047</span><span class="p">}</span>
<span class="linenos">1048</span>
<span class="linenos">1049</span><span class="kt">void</span><span class="w"> </span><span class="n">MGPUIntMpdRdmeSolver</span><span class="o">::</span><span class="n">hookCheckSimulation</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="n">CudaIntLattice</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">lattice</span><span class="p">)</span>
<span class="linenos">1050</span><span class="p">{</span>
<span class="linenos">1051</span><span class="w">    </span><span class="k">switch</span><span class="p">(</span><span class="n">hookSimulation</span><span class="p">(</span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="n">lattice</span><span class="p">))</span>
<span class="linenos">1052</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">1053</span><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="mi">0</span><span class="p">:</span>
<span class="linenos">1054</span><span class="w">            </span><span class="k">break</span><span class="p">;</span>
<span class="linenos">1055</span>
<span class="linenos">1056</span><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span>
<span class="linenos">1057</span><span class="w">            </span><span class="c1">// lattice-&gt;copyToGPU();</span>
<span class="linenos">1058</span><span class="w">            </span><span class="k">break</span><span class="p">;</span>
<span class="linenos">1059</span>
<span class="linenos">1060</span><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="mi">2</span><span class="p">:</span>
<span class="linenos">1061</span><span class="w">            </span><span class="c1">// lattice-&gt;copyToGPU();</span>
<span class="linenos">1062</span><span class="w">            </span><span class="n">writeLatticeSites</span><span class="p">(</span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="n">lattice</span><span class="p">);</span>
<span class="linenos">1063</span><span class="w">            </span><span class="k">break</span><span class="p">;</span>
<span class="linenos">1064</span>
<span class="linenos">1065</span><span class="w">		</span><span class="k">case</span><span class="w"> </span><span class="mi">3</span><span class="p">:</span>
<span class="linenos">1066</span><span class="w">            </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;hook return value is 3, force to stop.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="linenos">1067</span><span class="w">			</span><span class="n">writeLatticeSites</span><span class="p">(</span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="n">lattice</span><span class="p">);</span>
<span class="linenos">1068</span><span class="w">            </span><span class="k">return</span><span class="p">;</span>
<span class="linenos">1069</span>
<span class="linenos">1070</span><span class="w">        </span><span class="k">default</span><span class="o">:</span>
<span class="linenos">1071</span><span class="w">            </span><span class="n">throw</span><span class="p">(</span><span class="s">&quot;Unknown hook return value&quot;</span><span class="p">);</span>
<span class="linenos">1072</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">1073</span>
<span class="linenos">1074</span><span class="w">	</span><span class="k">if</span><span class="p">(</span><span class="n">reactionModelModified</span><span class="p">)</span>
<span class="linenos">1075</span><span class="w">		</span><span class="n">computePropensities</span><span class="p">();</span>
<span class="linenos">1076</span><span class="p">}</span>
<span class="linenos">1077</span>
<span class="linenos">1078</span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">MGPUIntMpdRdmeSolver</span><span class="o">::</span><span class="n">getTimestepSeed</span><span class="p">(</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">timestep</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">substep</span><span class="p">)</span>
<span class="linenos">1079</span><span class="p">{</span>
<span class="linenos">1080</span><span class="w">    </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">timestepHash</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(((((</span><span class="kt">uint64_t</span><span class="p">)</span><span class="n">seed</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="mi">30</span><span class="p">)</span><span class="o">+</span><span class="n">timestep</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="n">substep</span><span class="p">;</span>
<span class="linenos">1081</span><span class="w">    </span><span class="n">timestepHash</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">timestepHash</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">3202034522624059733ULL</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">4354685564936845319ULL</span><span class="p">;</span>
<span class="linenos">1082</span><span class="w">    </span><span class="n">timestepHash</span><span class="w"> </span><span class="o">^=</span><span class="w"> </span><span class="n">timestepHash</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">20</span><span class="p">;</span><span class="w"> </span><span class="n">timestepHash</span><span class="w"> </span><span class="o">^=</span><span class="w"> </span><span class="n">timestepHash</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">41</span><span class="p">;</span><span class="w"> </span><span class="n">timestepHash</span><span class="w"> </span><span class="o">^=</span><span class="w"> </span><span class="n">timestepHash</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span>
<span class="linenos">1083</span><span class="w">    </span><span class="n">timestepHash</span><span class="w"> </span><span class="o">*=</span><span class="w"> </span><span class="mi">7664345821815920749ULL</span><span class="p">;</span>
<span class="linenos">1084</span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">;</span>
<span class="linenos">1085</span><span class="p">}</span>
<span class="linenos">1086</span>
<span class="linenos">1087</span><span class="kt">int</span><span class="w"> </span><span class="n">MGPUIntMpdRdmeSolver</span><span class="o">::</span><span class="n">run_next_timestep</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">gpu</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">timestep</span><span class="p">)</span>
<span class="linenos">1088</span><span class="p">{</span>
<span class="linenos">1089</span><span class="w">    </span><span class="n">PROF_BEGIN</span><span class="p">(</span><span class="n">PROF_MPD_TIMESTEP</span><span class="p">);</span>
<span class="linenos">1090</span>
<span class="linenos">1091</span><span class="w">	</span><span class="kt">int</span><span class="w"> </span><span class="n">z_start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">1092</span><span class="w">	</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">dlat</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">dLattice</span><span class="p">;</span>
<span class="linenos">1093</span><span class="w">	</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">dtmp</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">dLatticeTmp</span><span class="p">;</span>
<span class="linenos">1094</span><span class="w">	</span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="n">sites</span><span class="w">            </span><span class="o">=</span><span class="w"> </span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">dSites</span><span class="p">;</span>
<span class="linenos">1095</span><span class="w">	</span><span class="n">cudaStream_t</span><span class="w"> </span><span class="n">cudaStream</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">stream1</span><span class="p">;</span>
<span class="linenos">1096</span><span class="w">	</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">d_overflows</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">d_overflows</span><span class="p">;</span>
<span class="linenos">1097</span><span class="w">	</span>
<span class="linenos">1098</span><span class="w">    </span><span class="kt">dim3</span><span class="w"> </span><span class="n">gridSize</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">grid_x</span><span class="p">;</span>
<span class="linenos">1099</span><span class="w">	</span><span class="kt">dim3</span><span class="w"> </span><span class="n">threadBlockSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">threads_x</span><span class="p">;</span>
<span class="linenos">1100</span>
<span class="linenos">1101</span><span class="w">	</span><span class="n">ZDivMultiGPUMapper</span><span class="o">*</span><span class="w"> </span><span class="n">zmap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">ZDivMultiGPUMapper</span><span class="o">*</span><span class="p">)</span><span class="n">mapper</span><span class="p">;</span>
<span class="linenos">1102</span>
<span class="linenos">1103</span><span class="w">    </span><span class="c1">// Execute the kernel for the x direction.</span>
<span class="linenos">1104</span><span class="w">    </span><span class="n">PROF_CUDA_START</span><span class="p">(</span><span class="n">cudaStream</span><span class="p">);</span>
<span class="linenos">1105</span>
<span class="linenos">1106</span><span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">aggcopy_x_unpack</span><span class="p">)</span>
<span class="linenos">1107</span><span class="w">	</span><span class="p">{</span>
<span class="linenos">1108</span><span class="w">		</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">rbuf_top</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zmap</span><span class="o">-&gt;</span><span class="n">getrbuf</span><span class="p">(</span><span class="n">gpu</span><span class="p">,</span><span class="w"> </span><span class="n">timestep</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="linenos">1109</span><span class="w">		</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">rbuf_bot</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zmap</span><span class="o">-&gt;</span><span class="n">getrbuf</span><span class="p">(</span><span class="n">gpu</span><span class="p">,</span><span class="w"> </span><span class="n">timestep</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="linenos">1110</span>
<span class="linenos">1111</span><span class="w">		</span><span class="n">PROF_CUDA_BEGIN</span><span class="p">(</span><span class="n">PROF_MPD_X_DIFFUSION</span><span class="p">,</span><span class="w"> </span><span class="n">cudaStream</span><span class="p">);</span>
<span class="linenos">1112</span><span class="w">		</span><span class="n">CUDA_EXCEPTION_EXECUTE</span><span class="p">((</span>
<span class="linenos">1113</span><span class="w">			</span><span class="n">mgpuintmpdrdme_dev</span><span class="o">::</span><span class="n">MGPU_x_kernel_unpack</span><span class="o">&lt;&lt;&lt;</span><span class="n">gridSize</span><span class="p">,</span><span class="w"> </span><span class="n">threadBlockSize</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">cudaStream</span><span class="o">&gt;&gt;&gt;</span>
<span class="linenos">1114</span><span class="w">			</span><span class="p">(</span><span class="n">dlat</span><span class="p">,</span><span class="w"> </span><span class="n">sites</span><span class="p">,</span><span class="w"> </span><span class="n">dtmp</span><span class="p">,</span><span class="w"> </span><span class="n">z_start</span><span class="p">,</span>
<span class="linenos">1115</span><span class="w">			 </span><span class="n">getTimestepSeed</span><span class="p">(</span><span class="n">timestep</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">),</span>
<span class="linenos">1116</span><span class="w">			 </span><span class="n">d_overflows</span><span class="p">,</span>
<span class="linenos">1117</span><span class="w">			 </span><span class="n">rbuf_top</span><span class="p">,</span><span class="w"> </span><span class="n">rbuf_bot</span><span class="p">)</span>
<span class="linenos">1118</span><span class="w">		</span><span class="p">));</span>
<span class="linenos">1119</span><span class="w">		</span><span class="n">PROF_CUDA_END</span><span class="p">(</span><span class="n">PROF_MPD_X_DIFFUSION</span><span class="p">,</span><span class="w"> </span><span class="n">cudaStream</span><span class="p">);</span>
<span class="linenos">1120</span><span class="w">	</span><span class="p">}</span>
<span class="linenos">1121</span><span class="w">	</span><span class="k">else</span>
<span class="linenos">1122</span><span class="w">	</span><span class="p">{</span>
<span class="linenos">1123</span><span class="w">		</span><span class="n">mapper</span><span class="o">-&gt;</span><span class="n">schedule_recv</span><span class="p">(</span><span class="n">gpu</span><span class="p">,</span><span class="w"> </span><span class="n">dlat</span><span class="p">,</span><span class="w"> </span><span class="n">timestep</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">cudaStream</span><span class="p">);</span>
<span class="linenos">1124</span><span class="w">		</span><span class="n">mapper</span><span class="o">-&gt;</span><span class="n">schedule_recv</span><span class="p">(</span><span class="n">gpu</span><span class="p">,</span><span class="w"> </span><span class="n">dlat</span><span class="p">,</span><span class="w"> </span><span class="n">timestep</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">cudaStream</span><span class="p">);</span>
<span class="linenos">1125</span>
<span class="linenos">1126</span><span class="w">		</span><span class="n">PROF_CUDA_BEGIN</span><span class="p">(</span><span class="n">PROF_MPD_X_DIFFUSION</span><span class="p">,</span><span class="n">cudaStream</span><span class="p">);</span>
<span class="linenos">1127</span><span class="w">		</span><span class="n">CUDA_EXCEPTION_EXECUTE</span><span class="p">((</span>
<span class="linenos">1128</span><span class="w">			</span><span class="n">mgpuintmpdrdme_dev</span><span class="o">::</span><span class="n">MGPU_x_kernel</span><span class="o">&lt;&lt;&lt;</span><span class="n">gridSize</span><span class="p">,</span><span class="w"> </span><span class="n">threadBlockSize</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">cudaStream</span><span class="o">&gt;&gt;&gt;</span>
<span class="linenos">1129</span><span class="w">			</span><span class="p">(</span><span class="n">dlat</span><span class="p">,</span><span class="w"> </span><span class="n">sites</span><span class="p">,</span><span class="w"> </span><span class="n">dtmp</span><span class="p">,</span><span class="w"> </span><span class="n">z_start</span><span class="p">,</span>
<span class="linenos">1130</span><span class="w">			 </span><span class="n">getTimestepSeed</span><span class="p">(</span><span class="n">timestep</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">),</span>
<span class="linenos">1131</span><span class="w">			 </span><span class="n">d_overflows</span><span class="p">)</span>
<span class="linenos">1132</span><span class="w">		</span><span class="p">));</span>
<span class="linenos">1133</span><span class="w">		</span><span class="n">PROF_CUDA_END</span><span class="p">(</span><span class="n">PROF_MPD_X_DIFFUSION</span><span class="p">,</span><span class="w"> </span><span class="n">cudaStream</span><span class="p">);</span>
<span class="linenos">1134</span><span class="w">	</span><span class="p">}</span>
<span class="linenos">1135</span>
<span class="linenos">1136</span><span class="w">    </span><span class="n">gridSize</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">grid_y</span><span class="p">;</span>
<span class="linenos">1137</span><span class="w">	</span><span class="n">threadBlockSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">threads_y</span><span class="p">;</span>
<span class="linenos">1138</span>
<span class="linenos">1139</span><span class="w">    </span><span class="c1">// Execute the kernel for the y direction.</span>
<span class="linenos">1140</span><span class="w">    </span><span class="n">PROF_CUDA_BEGIN</span><span class="p">(</span><span class="n">PROF_MPD_Y_DIFFUSION</span><span class="p">,</span><span class="w"> </span><span class="n">cudaStream</span><span class="p">);</span>
<span class="linenos">1141</span><span class="w">    </span><span class="n">CUDA_EXCEPTION_EXECUTE</span><span class="p">((</span>
<span class="linenos">1142</span><span class="w">		</span><span class="n">mgpuintmpdrdme_dev</span><span class="o">::</span><span class="n">MGPU_y_kernel</span><span class="o">&lt;&lt;&lt;</span><span class="n">gridSize</span><span class="p">,</span><span class="w"> </span><span class="n">threadBlockSize</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">cudaStream</span><span class="o">&gt;&gt;&gt;</span>
<span class="linenos">1143</span><span class="w">		</span><span class="p">(</span><span class="n">dtmp</span><span class="p">,</span><span class="w"> </span><span class="n">sites</span><span class="p">,</span><span class="w"> </span><span class="n">dlat</span><span class="p">,</span>
<span class="linenos">1144</span><span class="w">		 </span><span class="n">getTimestepSeed</span><span class="p">(</span><span class="n">timestep</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">),</span>
<span class="linenos">1145</span><span class="w">		 </span><span class="n">d_overflows</span><span class="p">)</span>
<span class="linenos">1146</span><span class="w">	</span><span class="p">));</span>
<span class="linenos">1147</span><span class="w">    </span><span class="n">PROF_CUDA_END</span><span class="p">(</span><span class="n">PROF_MPD_Y_DIFFUSION</span><span class="p">,</span><span class="w"> </span><span class="n">cudaStream</span><span class="p">);</span>
<span class="linenos">1148</span>
<span class="linenos">1149</span><span class="w">    </span><span class="n">gridSize</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">grid_z</span><span class="p">;</span>
<span class="linenos">1150</span><span class="w">	</span><span class="n">threadBlockSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">threads_z</span><span class="p">;</span>
<span class="linenos">1151</span>
<span class="linenos">1152</span><span class="w">    </span><span class="c1">// Execute the kernel for the z direction.</span>
<span class="linenos">1153</span><span class="w">    </span><span class="n">PROF_CUDA_BEGIN</span><span class="p">(</span><span class="n">PROF_MPD_Z_DIFFUSION</span><span class="p">,</span><span class="w"> </span><span class="n">cudaStream</span><span class="p">);</span>
<span class="linenos">1154</span><span class="w">    </span><span class="n">CUDA_EXCEPTION_EXECUTE</span><span class="p">((</span>
<span class="linenos">1155</span><span class="w">		</span><span class="n">mgpuintmpdrdme_dev</span><span class="o">::</span><span class="n">MGPU_z_kernel</span><span class="o">&lt;&lt;&lt;</span><span class="n">gridSize</span><span class="p">,</span><span class="w"> </span><span class="n">threadBlockSize</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">cudaStream</span><span class="o">&gt;&gt;&gt;</span>
<span class="linenos">1156</span><span class="w">		</span><span class="p">(</span><span class="n">dlat</span><span class="p">,</span><span class="w"> </span><span class="n">sites</span><span class="p">,</span><span class="w"> </span><span class="n">dtmp</span><span class="p">,</span>
<span class="linenos">1157</span><span class="w">		 </span><span class="n">getTimestepSeed</span><span class="p">(</span><span class="n">timestep</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">),</span>
<span class="linenos">1158</span><span class="w">		 </span><span class="n">d_overflows</span><span class="p">,</span>
<span class="linenos">1159</span><span class="w">		 </span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">segment</span><span class="o">-&gt;</span><span class="n">active_offset</span><span class="p">.</span><span class="n">z</span><span class="p">)</span>
<span class="linenos">1160</span><span class="w">	</span><span class="p">));</span>
<span class="linenos">1161</span><span class="w">    </span><span class="n">PROF_CUDA_END</span><span class="p">(</span><span class="n">PROF_MPD_Z_DIFFUSION</span><span class="p">,</span><span class="w"> </span><span class="n">cudaStream</span><span class="p">);</span>
<span class="linenos">1162</span>
<span class="linenos">1163</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">numberReactions</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">1164</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">1165</span><span class="w">		</span><span class="n">gridSize</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">grid_r</span><span class="p">;</span>
<span class="linenos">1166</span><span class="w">		</span><span class="n">threadBlockSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">threads_r</span><span class="p">;</span>
<span class="linenos">1167</span>
<span class="linenos">1168</span><span class="w">        </span><span class="c1">// Execute the kernel for the reaction.</span>
<span class="linenos">1169</span><span class="w">		</span><span class="c1">// This kernel updates the lattice in-place, so only the src pointer is passed.</span>
<span class="linenos">1170</span><span class="w">        </span><span class="n">PROF_CUDA_BEGIN</span><span class="p">(</span><span class="n">PROF_MPD_REACTION</span><span class="p">,</span><span class="w"> </span><span class="n">cudaStream</span><span class="p">);</span>
<span class="linenos">1171</span>
<span class="linenos">1172</span><span class="w">		</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">buf_top</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zmap</span><span class="o">-&gt;</span><span class="n">gettbuf</span><span class="p">(</span><span class="n">gpu</span><span class="p">,</span><span class="w"> </span><span class="n">timestep</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="linenos">1173</span><span class="w">		</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">buf_bot</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zmap</span><span class="o">-&gt;</span><span class="n">gettbuf</span><span class="p">(</span><span class="n">gpu</span><span class="p">,</span><span class="w"> </span><span class="n">timestep</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w">		</span>
<span class="linenos">1174</span>
<span class="linenos">1175</span><span class="w">	</span><span class="cp">#ifdef MPD_FREAKYFAST</span>
<span class="linenos">1176</span><span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">aggcopy_r_pack</span><span class="p">)</span>
<span class="linenos">1177</span><span class="w">		</span><span class="p">{</span>
<span class="linenos">1178</span><span class="w">			</span><span class="n">CUDA_EXCEPTION_EXECUTE</span><span class="p">((</span>
<span class="linenos">1179</span><span class="w">				</span><span class="n">mgpuintmpdrdme_dev</span><span class="o">::</span><span class="n">MGPU_precomp_reaction_kernel_packing</span><span class="o">&lt;&lt;&lt;</span><span class="n">gridSize</span><span class="p">,</span><span class="w"> </span><span class="n">threadBlockSize</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">cudaStream</span><span class="o">&gt;&gt;&gt;</span>
<span class="linenos">1180</span><span class="w">				</span><span class="p">(</span><span class="n">dtmp</span><span class="p">,</span><span class="w"> </span><span class="n">sites</span><span class="p">,</span><span class="w"> </span><span class="n">dtmp</span><span class="p">,</span>
<span class="linenos">1181</span><span class="w">				 </span><span class="n">getTimestepSeed</span><span class="p">(</span><span class="n">timestep</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">),</span>
<span class="linenos">1182</span><span class="w">				 </span><span class="n">d_overflows</span><span class="p">,</span>
<span class="linenos">1183</span><span class="w">				 </span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">segment</span><span class="o">-&gt;</span><span class="n">active_offset</span><span class="p">.</span><span class="n">z</span><span class="p">,</span>
<span class="linenos">1184</span><span class="w">				</span><span class="cp">#ifdef MPD_GLOBAL_S_MATRIX</span>
<span class="linenos">1185</span><span class="w">				 </span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">SG</span><span class="p">,</span>
<span class="linenos">1186</span><span class="w">				 </span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">RLG</span><span class="p">,</span>
<span class="linenos">1187</span><span class="w">				</span><span class="cp">#endif</span>
<span class="linenos">1188</span><span class="w">				</span><span class="cp">#ifdef MPD_GLOBAL_R_MATRIX</span>
<span class="linenos">1189</span><span class="w">				 </span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">reactionOrdersG</span><span class="p">,</span>
<span class="linenos">1190</span><span class="w">				 </span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">reactionSitesG</span><span class="p">,</span>
<span class="linenos">1191</span><span class="w">				 </span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">D1G</span><span class="p">,</span>
<span class="linenos">1192</span><span class="w">				 </span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">D2G</span><span class="p">,</span>
<span class="linenos">1193</span><span class="w">				 </span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">reactionRatesG</span><span class="p">,</span>
<span class="linenos">1194</span><span class="w">				</span><span class="cp">#endif</span>
<span class="linenos">1195</span><span class="w">				 </span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">propZeroOrder</span><span class="p">,</span>
<span class="linenos">1196</span><span class="w">				 </span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">propFirstOrder</span><span class="p">,</span>
<span class="linenos">1197</span><span class="w">				 </span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">propSecondOrder</span><span class="p">,</span>
<span class="linenos">1198</span><span class="w">				 </span><span class="n">buf_top</span><span class="p">,</span><span class="w"> </span><span class="n">buf_bot</span><span class="p">)</span>
<span class="linenos">1199</span><span class="w">			</span><span class="p">));</span>
<span class="linenos">1200</span><span class="w">		</span><span class="p">}</span>
<span class="linenos">1201</span><span class="w">		</span><span class="k">else</span>
<span class="linenos">1202</span><span class="w">		</span><span class="p">{</span>
<span class="linenos">1203</span><span class="w">			</span><span class="n">CUDA_EXCEPTION_EXECUTE</span><span class="p">((</span>
<span class="linenos">1204</span><span class="w">				</span><span class="n">mgpuintmpdrdme_dev</span><span class="o">::</span><span class="n">MGPU_precomp_reaction_kernel</span><span class="o">&lt;&lt;&lt;</span><span class="n">gridSize</span><span class="p">,</span><span class="w"> </span><span class="n">threadBlockSize</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">cudaStream</span><span class="o">&gt;&gt;&gt;</span>
<span class="linenos">1205</span><span class="w">				</span><span class="p">(</span><span class="n">dtmp</span><span class="p">,</span><span class="w"> </span><span class="n">sites</span><span class="p">,</span><span class="w"> </span><span class="n">dtmp</span><span class="p">,</span>
<span class="linenos">1206</span><span class="w">				 </span><span class="n">getTimestepSeed</span><span class="p">(</span><span class="n">timestep</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">),</span>
<span class="linenos">1207</span><span class="w">				 </span><span class="n">d_overflows</span><span class="p">,</span>
<span class="linenos">1208</span><span class="w">				 </span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">segment</span><span class="o">-&gt;</span><span class="n">active_offset</span><span class="p">.</span><span class="n">z</span><span class="p">,</span>
<span class="linenos">1209</span><span class="w">				</span><span class="cp">#ifdef MPD_GLOBAL_S_MATRIX</span>
<span class="linenos">1210</span><span class="w">				 </span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">SG</span><span class="p">,</span>
<span class="linenos">1211</span><span class="w">				 </span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">RLG</span><span class="p">,</span>
<span class="linenos">1212</span><span class="w">				</span><span class="cp">#endif</span>
<span class="linenos">1213</span><span class="w">				</span><span class="cp">#ifdef MPD_GLOBAL_R_MATRIX</span>
<span class="linenos">1214</span><span class="w">				 </span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">reactionOrdersG</span><span class="p">,</span>
<span class="linenos">1215</span><span class="w">				 </span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">reactionSitesG</span><span class="p">,</span>
<span class="linenos">1216</span><span class="w">				 </span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">D1G</span><span class="p">,</span>
<span class="linenos">1217</span><span class="w">				 </span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">D2G</span><span class="p">,</span>
<span class="linenos">1218</span><span class="w">				 </span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">reactionRatesG</span><span class="p">,</span>
<span class="linenos">1219</span><span class="w">				</span><span class="cp">#endif</span>
<span class="linenos">1220</span><span class="w">				 </span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">propZeroOrder</span><span class="p">,</span>
<span class="linenos">1221</span><span class="w">				 </span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">propFirstOrder</span><span class="p">,</span>
<span class="linenos">1222</span><span class="w">				 </span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">propSecondOrder</span><span class="p">)</span>
<span class="linenos">1223</span><span class="w">			</span><span class="p">));</span>
<span class="linenos">1224</span><span class="w">		</span><span class="p">}</span>
<span class="linenos">1225</span><span class="w">	</span><span class="cp">#else</span>
<span class="linenos">1226</span><span class="w">    	</span><span class="n">CUDA_EXCEPTION_EXECUTE</span><span class="p">((</span>
<span class="linenos">1227</span><span class="w">			</span><span class="n">mgpuintmpdrdme_dev</span><span class="o">::</span><span class="n">MGPU_reaction_kernel</span><span class="o">&lt;&lt;&lt;</span><span class="n">gridSize</span><span class="p">,</span><span class="w"> </span><span class="n">threadBlockSize</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">cudaStream</span><span class="o">&gt;&gt;&gt;</span>
<span class="linenos">1228</span><span class="w">			</span><span class="p">(</span><span class="n">dtmp</span><span class="p">,</span><span class="w"> </span><span class="n">sites</span><span class="p">,</span><span class="w"> </span><span class="n">dtmp</span><span class="p">,</span>
<span class="linenos">1229</span><span class="w">			 </span><span class="n">getTimestepSeed</span><span class="p">(</span><span class="n">timestep</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">),</span>
<span class="linenos">1230</span><span class="w">			 </span><span class="n">d_overflows</span><span class="p">,</span>
<span class="linenos">1231</span><span class="w">			 </span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">segment</span><span class="o">-&gt;</span><span class="n">active_offset</span><span class="p">.</span><span class="n">z</span><span class="p">,</span>
<span class="linenos">1232</span><span class="w">			</span><span class="cp">#ifdef MPD_GLOBAL_S_MATRIX</span>
<span class="linenos">1233</span><span class="w">			 </span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">SG</span><span class="p">,</span>
<span class="linenos">1234</span><span class="w">			 </span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">RLG</span><span class="p">,</span>
<span class="linenos">1235</span><span class="w">			</span><span class="cp">#endif</span>
<span class="linenos">1236</span><span class="w">			</span><span class="cp">#ifdef MPD_GLOBAL_R_MATRIX</span>
<span class="linenos">1237</span><span class="w">			 </span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">reactionOrdersG</span><span class="p">,</span>
<span class="linenos">1238</span><span class="w">			 </span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">reactionSitesG</span><span class="p">,</span>
<span class="linenos">1239</span><span class="w">			 </span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">D1G</span><span class="p">,</span>
<span class="linenos">1240</span><span class="w">			 </span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">D2G</span><span class="p">,</span>
<span class="linenos">1241</span><span class="w">			 </span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">reactionRatesG</span>
<span class="linenos">1242</span><span class="w">			</span><span class="cp">#endif</span>
<span class="linenos">1243</span><span class="w">		</span><span class="p">)));</span>
<span class="linenos">1244</span><span class="w">	</span><span class="cp">#endif</span>
<span class="linenos">1245</span>
<span class="linenos">1246</span><span class="w">        </span><span class="n">PROF_CUDA_END</span><span class="p">(</span><span class="n">PROF_MPD_REACTION</span><span class="p">,</span><span class="w"> </span><span class="n">cudaStream</span><span class="p">);</span>
<span class="linenos">1247</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">1248</span>
<span class="linenos">1249</span><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">overflow_handling</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">OVERFLOW_MODE_RELAXED</span><span class="p">)</span>
<span class="linenos">1250</span><span class="w">		</span><span class="n">mgpuintmpdrdme_dev</span><span class="o">::</span><span class="n">correct_overflows_mgpu</span><span class="o">&lt;&lt;&lt;</span><span class="kt">dim3</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span>
<span class="linenos">1251</span><span class="w">	                                                 </span><span class="kt">dim3</span><span class="p">(</span><span class="n">TUNE_MPD_MAX_PARTICLE_OVERFLOWS</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span>
<span class="linenos">1252</span><span class="w">													 </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">cudaStream</span><span class="o">&gt;&gt;&gt;</span><span class="p">(</span><span class="n">dtmp</span><span class="p">,</span><span class="w"> </span><span class="n">d_overflows</span><span class="p">);</span>
<span class="linenos">1253</span>
<span class="linenos">1254</span><span class="w">	</span><span class="c1">// send data</span>
<span class="linenos">1255</span><span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">aggcopy_r_pack</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">numberReactions</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">1256</span><span class="w">	</span><span class="p">{</span>
<span class="linenos">1257</span><span class="w">		</span><span class="n">zmap</span><span class="o">-&gt;</span><span class="n">send_tbuf</span><span class="p">(</span><span class="n">gpu</span><span class="p">,</span><span class="w"> </span><span class="n">timestep</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">cudaStream</span><span class="p">);</span>
<span class="linenos">1258</span><span class="w">		</span><span class="n">zmap</span><span class="o">-&gt;</span><span class="n">send_tbuf</span><span class="p">(</span><span class="n">gpu</span><span class="p">,</span><span class="w"> </span><span class="n">timestep</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">cudaStream</span><span class="p">);</span>
<span class="linenos">1259</span><span class="w">	</span><span class="p">}</span>
<span class="linenos">1260</span><span class="w">	</span><span class="k">else</span>
<span class="linenos">1261</span><span class="w">	</span><span class="p">{</span>
<span class="linenos">1262</span><span class="w">		</span><span class="n">mapper</span><span class="o">-&gt;</span><span class="n">schedule_send</span><span class="p">(</span><span class="n">gpu</span><span class="p">,</span><span class="w"> </span><span class="n">dtmp</span><span class="p">,</span><span class="w"> </span><span class="n">timestep</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">cudaStream</span><span class="p">);</span>
<span class="linenos">1263</span><span class="w">		</span><span class="n">mapper</span><span class="o">-&gt;</span><span class="n">schedule_send</span><span class="p">(</span><span class="n">gpu</span><span class="p">,</span><span class="w"> </span><span class="n">dtmp</span><span class="p">,</span><span class="w"> </span><span class="n">timestep</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">cudaStream</span><span class="p">);</span>
<span class="linenos">1264</span><span class="w">	</span><span class="p">}</span>
<span class="linenos">1265</span><span class="w">	</span>
<span class="linenos">1266</span><span class="w">    </span><span class="c1">// Wait for the kernels to complete.</span>
<span class="linenos">1267</span><span class="w">    </span><span class="n">PROF_BEGIN</span><span class="p">(</span><span class="n">PROF_MPD_SYNCHRONIZE</span><span class="p">);</span>
<span class="linenos">1268</span><span class="w">    </span><span class="n">CUDA_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">cudaStreamSynchronize</span><span class="p">(</span><span class="n">cudaStream</span><span class="p">));</span>
<span class="linenos">1269</span><span class="w">    </span><span class="n">PROF_END</span><span class="p">(</span><span class="n">PROF_MPD_SYNCHRONIZE</span><span class="p">);</span>
<span class="linenos">1270</span>
<span class="linenos">1271</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">overflow_handling</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">OVERFLOW_MODE_RELAXED</span><span class="p">)</span>
<span class="linenos">1272</span><span class="w">	</span><span class="p">{</span>
<span class="linenos">1273</span><span class="w">		</span><span class="n">uint</span><span class="w"> </span><span class="n">unresolved</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="p">)</span><span class="n">d_overflows</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
<span class="linenos">1274</span><span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">unresolved</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">1275</span><span class="w">		</span><span class="p">{</span>
<span class="linenos">1276</span><span class="w">            </span><span class="n">Print</span><span class="o">::</span><span class="n">printf</span><span class="p">(</span><span class="n">Print</span><span class="o">::</span><span class="n">WARNING</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;[gpu %d] %d unresolved overflows&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">gpu</span><span class="p">,</span><span class="w"> </span><span class="n">unresolved</span><span class="p">);</span>
<span class="linenos">1277</span><span class="w">		</span><span class="p">}</span>
<span class="linenos">1278</span><span class="w">	</span><span class="p">}</span>
<span class="linenos">1279</span>
<span class="linenos">1280</span><span class="w">	</span><span class="c1">// Save correct pointers for current data</span>
<span class="linenos">1281</span><span class="w">	</span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">dLattice</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="n">dtmp</span><span class="p">;</span>
<span class="linenos">1282</span><span class="w">	</span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">dLatticeTmp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dlat</span><span class="p">;</span>
<span class="linenos">1283</span>
<span class="linenos">1284</span><span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">overflow_handling</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">OVERFLOW_MODE_CLASSIC</span><span class="p">)</span>
<span class="linenos">1285</span><span class="w">	</span><span class="p">{</span>
<span class="linenos">1286</span><span class="w">	</span><span class="cp">#ifndef MPD_MAPPED_OVERFLOWS</span>
<span class="linenos">1287</span><span class="w">		</span><span class="n">cudaMemcpy</span><span class="p">(</span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">h_overflows</span><span class="p">,</span><span class="w"> </span><span class="n">d_overflows</span><span class="p">,</span><span class="w"> </span><span class="n">MPD_OVERFLOW_LIST_SIZE</span><span class="p">,</span><span class="w"> </span><span class="n">cudaMemcpyDeviceToHost</span><span class="p">);</span>
<span class="linenos">1288</span><span class="w">	</span><span class="cp">#endif</span>
<span class="linenos">1289</span>
<span class="linenos">1290</span><span class="w">		</span><span class="n">PROF_END</span><span class="p">(</span><span class="n">PROF_MPD_TIMESTEP</span><span class="p">);</span>
<span class="linenos">1291</span><span class="w">		</span><span class="k">return</span><span class="w"> </span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">h_overflows</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="linenos">1292</span><span class="w">	</span><span class="p">}</span>
<span class="linenos">1293</span><span class="w">	</span>
<span class="linenos">1294</span><span class="w">	</span><span class="c1">// relaxed overflow mode</span>
<span class="linenos">1295</span><span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">1296</span><span class="p">}</span>
<span class="linenos">1297</span>
<span class="linenos">1298</span>
<span class="linenos">1299</span><span class="kt">int</span><span class="w"> </span><span class="n">MGPUIntMpdRdmeSolver</span><span class="o">::</span><span class="n">handle_overflows</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">gpu</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">hptr</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">dptr</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ts</span><span class="p">)</span>
<span class="linenos">1300</span><span class="p">{</span>
<span class="linenos">1301</span><span class="w">	</span><span class="c1">// Copy data back from GPUs</span>
<span class="linenos">1302</span><span class="w">	</span><span class="n">mapper</span><span class="o">-&gt;</span><span class="n">stage_out</span><span class="p">(</span><span class="n">gpu</span><span class="p">,</span><span class="w"> </span><span class="n">hptr</span><span class="p">,</span><span class="w"> </span><span class="n">dptr</span><span class="p">);</span>
<span class="linenos">1303</span><span class="w">	</span><span class="c1">//	Print::printf(Print::DEBUG,&quot;[GPU Thread %d] entering ob1.&quot;,gpu);</span>
<span class="linenos">1304</span><span class="w">	</span><span class="n">pthread_barrier_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">overflow_barrier1</span><span class="p">);</span>
<span class="linenos">1305</span>
<span class="linenos">1306</span><span class="w">	</span><span class="c1">// Resolve overflows</span>
<span class="linenos">1307</span><span class="w">	</span><span class="k">if</span><span class="p">(</span><span class="n">gpu</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">1308</span><span class="w">	</span><span class="p">{</span>
<span class="linenos">1309</span><span class="w">		</span><span class="n">handle_all_overflows</span><span class="p">();</span>
<span class="linenos">1310</span><span class="w">		</span><span class="n">mclkr_int_total_overflows</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">1311</span><span class="w">		</span><span class="n">mclkr_int_overflow_counter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">1312</span><span class="w">	</span><span class="p">}</span>
<span class="linenos">1313</span><span class="w">	</span><span class="c1">//	Print::printf(Print::DEBUG,&quot;[GPU Thread %d] entering ob2.&quot;,gpu);</span>
<span class="linenos">1314</span><span class="w">	</span><span class="n">pthread_barrier_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">overflow_barrier2</span><span class="p">);</span>
<span class="linenos">1315</span>
<span class="linenos">1316</span><span class="w">	</span><span class="c1">// Return to GPU</span>
<span class="linenos">1317</span><span class="w">	</span><span class="n">mapper</span><span class="o">-&gt;</span><span class="n">stage_in</span><span class="p">(</span><span class="n">gpu</span><span class="p">,</span><span class="w"> </span><span class="n">dptr</span><span class="p">,</span><span class="w"> </span><span class="n">hptr</span><span class="p">);</span>
<span class="linenos">1318</span><span class="w">	</span><span class="n">mapper</span><span class="o">-&gt;</span><span class="n">publish_state</span><span class="p">(</span><span class="n">gpu</span><span class="p">,</span><span class="w"> </span><span class="n">dptr</span><span class="p">,</span><span class="w"> </span><span class="n">ts</span><span class="p">);</span>
<span class="linenos">1319</span><span class="w">	</span><span class="n">cudaMemsetAsync</span><span class="p">(</span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">].</span><span class="n">d_overflows</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="p">));</span>
<span class="linenos">1320</span><span class="w">	</span><span class="c1">//	Print::printf(Print::DEBUG,&quot;[GPU Thread %d] entering ob3.&quot;,gpu);</span>
<span class="linenos">1321</span><span class="w">	</span><span class="n">pthread_barrier_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">overflow_barrier1</span><span class="p">);</span>
<span class="linenos">1322</span>
<span class="linenos">1323</span>
<span class="linenos">1324</span><span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">1325</span><span class="p">}</span>
<span class="linenos">1326</span>
<span class="linenos">1327</span><span class="kt">int</span><span class="w"> </span><span class="n">MGPUIntMpdRdmeSolver</span><span class="o">::</span><span class="n">handle_all_overflows</span><span class="p">()</span>
<span class="linenos">1328</span><span class="p">{</span>
<span class="linenos">1329</span><span class="w">    </span><span class="c1">// Handle any particle overflows.</span>
<span class="linenos">1330</span><span class="w">    </span><span class="n">PROF_BEGIN</span><span class="p">(</span><span class="n">PROF_MPD_OVERFLOW</span><span class="p">);</span>
<span class="linenos">1331</span>
<span class="linenos">1332</span><span class="w">    </span><span class="n">overflowTimesteps</span><span class="o">++</span><span class="p">;</span>
<span class="linenos">1333</span><span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">overflowList</span><span class="p">[</span><span class="mi">1</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">TUNE_MPD_MAX_PARTICLE_OVERFLOWS</span><span class="p">];</span>
<span class="linenos">1334</span><span class="w">    </span><span class="n">uint</span><span class="w"> </span><span class="n">numberExceptions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">1335</span>
<span class="linenos">1336</span><span class="w">	</span><span class="c1">// LOOP OVER EACH GPU</span>
<span class="linenos">1337</span><span class="w">	</span><span class="kt">int</span><span class="w"> </span><span class="n">gpus</span><span class="o">=</span><span class="n">resources</span><span class="o">-&gt;</span><span class="n">cudaDevices</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
<span class="linenos">1338</span><span class="w">	</span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">gpus</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">1339</span><span class="w">	</span><span class="p">{</span>
<span class="linenos">1340</span><span class="w">		</span><span class="n">uint</span><span class="o">*</span><span class="w"> </span><span class="n">gpulist</span><span class="o">=</span><span class="n">threads</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">h_overflows</span><span class="p">;</span>
<span class="linenos">1341</span><span class="w">		</span><span class="kt">ssize_t</span><span class="w"> </span><span class="n">min_index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mapper</span><span class="o">-&gt;</span><span class="n">get_authority_offset</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
<span class="linenos">1342</span><span class="w">		</span><span class="kt">ssize_t</span><span class="w"> </span><span class="n">max_index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DIMSIZE</span><span class="p">(</span><span class="n">mapper</span><span class="o">-&gt;</span><span class="n">get_global_dim</span><span class="p">(</span><span class="n">i</span><span class="p">))</span><span class="o">+</span><span class="n">min_index</span><span class="p">;</span>
<span class="linenos">1343</span><span class="w">		</span><span class="c1">//printf(&quot;gpu %d: min %d max %d\n&quot;, i, min_index, max_index);</span>
<span class="linenos">1344</span>
<span class="linenos">1345</span><span class="w">		</span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">e</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">e</span><span class="o">&lt;</span><span class="n">gpulist</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span><span class="w"> </span><span class="n">e</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">1346</span><span class="w">		</span><span class="p">{</span>
<span class="linenos">1347</span><span class="w">			</span><span class="c1">// DECODE INDEX</span>
<span class="linenos">1348</span><span class="w">            </span><span class="kt">size_t</span><span class="w"> </span><span class="n">latticeIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gpulist</span><span class="p">[</span><span class="n">e</span><span class="o">*</span><span class="mi">2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">];</span>
<span class="linenos">1349</span><span class="w">            </span><span class="n">particle_t</span><span class="w"> </span><span class="n">particle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gpulist</span><span class="p">[</span><span class="n">e</span><span class="o">*</span><span class="mi">2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="p">];</span>
<span class="linenos">1350</span><span class="w">			</span>
<span class="linenos">1351</span><span class="w">			</span><span class="kt">ssize_t</span><span class="w"> </span><span class="n">globalIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">latticeIndex</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">mapper</span><span class="o">-&gt;</span><span class="n">get_global_input_offset</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
<span class="linenos">1352</span><span class="w">			</span><span class="c1">//printf(&quot;Overflow of particle type %d at local index %d on gpu %d ==&gt; index %d\n&quot;, particle, latticeIndex, i, globalIndex);</span>
<span class="linenos">1353</span><span class="w">			</span><span class="k">if</span><span class="p">(</span><span class="n">latticeIndex</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">min_index</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">latticeIndex</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">max_index</span><span class="p">)</span>
<span class="linenos">1354</span><span class="w">				</span><span class="k">continue</span><span class="p">;</span>
<span class="linenos">1355</span>
<span class="linenos">1356</span><span class="w">			</span><span class="c1">// FILL list</span>
<span class="linenos">1357</span><span class="w">            </span><span class="n">overflowList</span><span class="p">[(</span><span class="n">numberExceptions</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">globalIndex</span><span class="p">;</span>
<span class="linenos">1358</span><span class="w">			</span><span class="n">overflowList</span><span class="p">[(</span><span class="n">numberExceptions</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">particle</span><span class="p">;</span>
<span class="linenos">1359</span><span class="w">			</span><span class="n">numberExceptions</span><span class="o">++</span><span class="p">;</span>
<span class="linenos">1360</span><span class="w">		</span><span class="p">}</span>
<span class="linenos">1361</span><span class="w">	</span><span class="p">}</span>
<span class="linenos">1362</span>
<span class="linenos">1363</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">numberExceptions</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">1364</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">1365</span><span class="w">        </span><span class="n">Print</span><span class="o">::</span><span class="n">printf</span><span class="p">(</span><span class="n">Print</span><span class="o">::</span><span class="n">DEBUG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;%d overflows&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">numberExceptions</span><span class="p">);</span>
<span class="linenos">1366</span><span class="w">        </span>
<span class="linenos">1367</span><span class="w">        </span><span class="c1">// Make sure we did not exceed the overflow buffer.</span>
<span class="linenos">1368</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">numberExceptions</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">TUNE_MPD_MAX_PARTICLE_OVERFLOWS</span><span class="p">)</span>
<span class="linenos">1369</span><span class="w">            </span><span class="n">throw</span><span class="w"> </span><span class="n">Exception</span><span class="p">(</span><span class="s">&quot;Too many particle overflows for the available buffer&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">numberExceptions</span><span class="p">);</span>
<span class="linenos">1370</span><span class="w">            </span>
<span class="linenos">1371</span><span class="w">        </span><span class="c1">// Go through each exception.</span>
<span class="linenos">1372</span><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">numberExceptions</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">1373</span><span class="w">        </span><span class="p">{</span>
<span class="linenos">1374</span><span class="w">            </span><span class="c1">// Extract the index and particle type.</span>
<span class="linenos">1375</span><span class="w">            </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">latticeIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">overflowList</span><span class="p">[(</span><span class="n">i</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
<span class="linenos">1376</span><span class="w">            </span><span class="n">particle_t</span><span class="w"> </span><span class="n">particle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">overflowList</span><span class="p">[(</span><span class="n">i</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="mi">2</span><span class="p">];</span>
<span class="linenos">1377</span><span class="w">            </span>
<span class="linenos">1378</span><span class="w">            </span><span class="c1">// Get the x, y, and z coordiantes.</span>
<span class="linenos">1379</span><span class="w">            </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">latticeIndex</span><span class="o">%</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getXSize</span><span class="p">();</span>
<span class="linenos">1380</span><span class="w">            </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">latticeIndex</span><span class="o">/</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getXSize</span><span class="p">())</span><span class="o">%</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getYSize</span><span class="p">();</span>
<span class="linenos">1381</span><span class="w">            </span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">latticeIndex</span><span class="o">/</span><span class="p">(</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getXSize</span><span class="p">()</span><span class="o">*</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getYSize</span><span class="p">());</span>
<span class="linenos">1382</span><span class="w">            </span>
<span class="linenos">1383</span><span class="w">            </span><span class="c1">// Put the particles back into a nearby lattice site.</span>
<span class="linenos">1384</span><span class="w">            </span><span class="kt">bool</span><span class="w"> </span><span class="n">replacedParticle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="linenos">1385</span><span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">searchRadius</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="o">!</span><span class="n">replacedParticle</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">searchRadius</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">TUNE_MPD_MAX_OVERFLOW_REPLACEMENT_DIST</span><span class="p">;</span><span class="w"> </span><span class="n">searchRadius</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">1386</span><span class="w">            </span><span class="p">{</span>
<span class="linenos">1387</span><span class="w">                </span><span class="c1">// Get the nearby sites.</span>
<span class="linenos">1388</span><span class="w">                </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">lattice_coord_t</span><span class="o">&gt;</span><span class="w"> </span><span class="n">sites</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getNearbySites</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">,(</span><span class="n">searchRadius</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span><span class="o">?</span><span class="n">searchRadius</span><span class="mi">-1</span><span class="o">:</span><span class="mi">0</span><span class="p">,</span><span class="n">searchRadius</span><span class="p">);</span>
<span class="linenos">1389</span><span class="w">                </span>
<span class="linenos">1390</span><span class="w">                </span><span class="c1">// TODO: Shuffle the sites.</span>
<span class="linenos">1391</span><span class="w">                </span>
<span class="linenos">1392</span><span class="w">                </span><span class="c1">// Try to find one that in not fully occupied and of the same type.</span>
<span class="linenos">1393</span><span class="w">                </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">lattice_coord_t</span><span class="o">&gt;::</span><span class="n">iterator</span><span class="w"> </span><span class="n">it</span><span class="o">=</span><span class="n">sites</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span><span class="w"> </span><span class="n">it</span><span class="o">&lt;</span><span class="n">sites</span><span class="p">.</span><span class="n">end</span><span class="p">();</span><span class="w"> </span><span class="n">it</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">1394</span><span class="w">                </span><span class="p">{</span>
<span class="linenos">1395</span><span class="w">                    </span><span class="n">lattice_coord_t</span><span class="w"> </span><span class="n">site</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">it</span><span class="p">;</span>
<span class="linenos">1396</span><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getOccupancy</span><span class="p">(</span><span class="n">site</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="n">site</span><span class="p">.</span><span class="n">y</span><span class="p">,</span><span class="n">site</span><span class="p">.</span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getMaxOccupancy</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getSiteType</span><span class="p">(</span><span class="n">site</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="n">site</span><span class="p">.</span><span class="n">y</span><span class="p">,</span><span class="n">site</span><span class="p">.</span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getSiteType</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">))</span>
<span class="linenos">1397</span><span class="w">                    </span><span class="p">{</span>
<span class="linenos">1398</span><span class="w">                        </span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">addParticle</span><span class="p">(</span><span class="n">site</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">site</span><span class="p">.</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">site</span><span class="p">.</span><span class="n">z</span><span class="p">,</span><span class="w"> </span><span class="n">particle</span><span class="p">);</span>
<span class="linenos">1399</span><span class="w">                        </span><span class="n">replacedParticle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="linenos">1400</span><span class="w">                        </span><span class="n">Print</span><span class="o">::</span><span class="n">printf</span><span class="p">(</span><span class="n">Print</span><span class="o">::</span><span class="n">VERBOSE_DEBUG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Handled overflow of particle %d at site %d,%d,%d type=%d occ=%d by placing at site %d,%d,%d type=%d newocc=%d dist=%0.2f&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">particle</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">z</span><span class="p">,</span><span class="w"> </span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getSiteType</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">),</span><span class="w"> </span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getOccupancy</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">),</span><span class="w"> </span><span class="n">site</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">site</span><span class="p">.</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">site</span><span class="p">.</span><span class="n">z</span><span class="p">,</span><span class="w"> </span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getSiteType</span><span class="p">(</span><span class="n">site</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="n">site</span><span class="p">.</span><span class="n">y</span><span class="p">,</span><span class="n">site</span><span class="p">.</span><span class="n">z</span><span class="p">),</span><span class="w"> </span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getOccupancy</span><span class="p">(</span><span class="n">site</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="n">site</span><span class="p">.</span><span class="n">y</span><span class="p">,</span><span class="n">site</span><span class="p">.</span><span class="n">z</span><span class="p">),</span><span class="w"> </span><span class="n">sqrt</span><span class="p">(</span><span class="n">pow</span><span class="p">((</span><span class="kt">double</span><span class="p">)</span><span class="n">x</span><span class="o">-</span><span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="n">site</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="mf">2.0</span><span class="p">)</span><span class="o">+</span><span class="n">pow</span><span class="p">((</span><span class="kt">double</span><span class="p">)</span><span class="n">y</span><span class="o">-</span><span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="n">site</span><span class="p">.</span><span class="n">y</span><span class="p">,</span><span class="mf">2.0</span><span class="p">)</span><span class="o">+</span><span class="n">pow</span><span class="p">((</span><span class="kt">double</span><span class="p">)</span><span class="n">z</span><span class="o">-</span><span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="n">site</span><span class="p">.</span><span class="n">z</span><span class="p">,</span><span class="mf">2.0</span><span class="p">)));</span>
<span class="linenos">1401</span><span class="w">                        </span><span class="k">break</span><span class="p">;</span>
<span class="linenos">1402</span><span class="w">                    </span><span class="p">}</span>
<span class="linenos">1403</span><span class="w">                </span><span class="p">}</span>
<span class="linenos">1404</span><span class="w">            </span><span class="p">}</span>
<span class="linenos">1405</span><span class="w">            </span>
<span class="linenos">1406</span><span class="w">            </span><span class="c1">// If we were not able to fix the exception, throw an error.</span>
<span class="linenos">1407</span><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">replacedParticle</span><span class="p">)</span>
<span class="linenos">1408</span><span class="w">                </span><span class="n">throw</span><span class="w"> </span><span class="n">Exception</span><span class="p">(</span><span class="s">&quot;Unable to find an available site to handle a particle overflow.&quot;</span><span class="p">);</span>
<span class="linenos">1409</span><span class="w">        </span><span class="p">}</span>
<span class="linenos">1410</span><span class="w">        </span>
<span class="linenos">1411</span><span class="w">        </span><span class="c1">// Track that we used the overflow list.</span>
<span class="linenos">1412</span><span class="w">        </span><span class="n">overflowListUses</span><span class="o">++</span><span class="p">;</span>
<span class="linenos">1413</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">1414</span><span class="w">    </span>
<span class="linenos">1415</span><span class="w">    </span><span class="c1">// If the overflow lsit is being used too often, print a warning.</span>
<span class="linenos">1416</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">overflowTimesteps</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">1000</span><span class="p">)</span>
<span class="linenos">1417</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">1418</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">overflowListUses</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">10</span><span class="p">)</span>
<span class="linenos">1419</span><span class="w">            </span><span class="n">Print</span><span class="o">::</span><span class="n">printf</span><span class="p">(</span><span class="n">Print</span><span class="o">::</span><span class="n">WARNING</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;%d uses of the particle overflow list in the last 1000 timesteps, performance may be degraded.&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">overflowListUses</span><span class="p">);</span>
<span class="linenos">1420</span><span class="w">        </span><span class="n">overflowTimesteps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">1421</span><span class="w">        </span><span class="n">overflowListUses</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">1422</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">1423</span><span class="w">    </span><span class="n">PROF_END</span><span class="p">(</span><span class="n">PROF_MPD_OVERFLOW</span><span class="p">);</span>
<span class="linenos">1424</span>
<span class="linenos">1425</span><span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">1426</span><span class="p">}</span>
<span class="linenos">1427</span>
<span class="linenos">1428</span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="n">MGPUIntMpdRdmeSolver</span><span class="o">::</span><span class="n">run_thread</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">gpu</span><span class="p">)</span>
<span class="linenos">1429</span><span class="p">{</span>
<span class="linenos">1430</span><span class="w">	</span><span class="n">mapper</span><span class="o">-&gt;</span><span class="n">numa_bind_thread</span><span class="p">(</span><span class="n">gpu</span><span class="p">);</span>
<span class="linenos">1431</span><span class="w">	</span><span class="n">mapper</span><span class="o">-&gt;</span><span class="n">initialize_gpu</span><span class="p">(</span><span class="n">gpu</span><span class="p">);</span>
<span class="linenos">1432</span><span class="w">	</span><span class="n">pthread_barrier_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">simulation_barrier</span><span class="p">);</span>
<span class="linenos">1433</span><span class="w">	</span><span class="n">mapper</span><span class="o">-&gt;</span><span class="n">set_affinity</span><span class="p">(</span><span class="n">gpu</span><span class="p">);</span>
<span class="linenos">1434</span><span class="w">	</span>
<span class="linenos">1435</span><span class="w">	</span><span class="n">gpu_worker_thread_int_params</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">threads</span><span class="p">[</span><span class="n">gpu</span><span class="p">];</span>
<span class="linenos">1436</span>
<span class="linenos">1437</span><span class="w">	</span><span class="c1">// allocate device memory for lattice stuctures</span>
<span class="linenos">1438</span><span class="w">	</span><span class="n">cudaMalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dLattice</span><span class="p">,</span><span class="w">    </span><span class="n">mapper</span><span class="o">-&gt;</span><span class="n">get_local_size</span><span class="p">(</span><span class="n">gpu</span><span class="p">)</span><span class="o">*</span><span class="n">MPD_WORDS_PER_SITE</span><span class="p">);</span>
<span class="linenos">1439</span><span class="w">	</span><span class="n">cudaMalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dLatticeTmp</span><span class="p">,</span><span class="w"> </span><span class="n">mapper</span><span class="o">-&gt;</span><span class="n">get_local_size</span><span class="p">(</span><span class="n">gpu</span><span class="p">)</span><span class="o">*</span><span class="n">MPD_WORDS_PER_SITE</span><span class="p">);</span>
<span class="linenos">1440</span><span class="w">	</span><span class="n">cudaMalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dSites</span><span class="p">,</span><span class="w">      </span><span class="n">DIMSIZE</span><span class="p">(</span><span class="n">mapper</span><span class="o">-&gt;</span><span class="n">get_local_dim</span><span class="p">(</span><span class="n">gpu</span><span class="p">)));</span>
<span class="linenos">1441</span>
<span class="linenos">1442</span><span class="w">	</span><span class="c1">// allocate device and host space for overflow lists</span>
<span class="linenos">1443</span><span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">overflow_handling</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">OVERFLOW_MODE_CLASSIC</span><span class="p">)</span>
<span class="linenos">1444</span><span class="w">	</span><span class="p">{</span>
<span class="linenos">1445</span><span class="w">	</span><span class="cp">#ifdef MPD_MAPPED_OVERFLOWS</span>
<span class="linenos">1446</span><span class="w">		</span><span class="n">CUDA_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">cudaHostAlloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">h_overflows</span><span class="p">,</span>
<span class="linenos">1447</span><span class="w">		                                   </span><span class="n">MPD_OVERFLOW_LIST_SIZE</span><span class="p">,</span>
<span class="linenos">1448</span><span class="w">										   </span><span class="n">cudaHostAllocPortable</span><span class="o">|</span><span class="n">cudaHostAllocMapped</span><span class="p">));</span>
<span class="linenos">1449</span><span class="w">		</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">d_overflows</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">h_overflows</span><span class="p">;</span>
<span class="linenos">1450</span><span class="w">	</span><span class="cp">#else</span>
<span class="linenos">1451</span><span class="w">	    </span><span class="n">CUDA_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">cudaHostAlloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">h_overflows</span><span class="p">,</span>
<span class="linenos">1452</span><span class="w">		                                   </span><span class="n">MPD_OVERFLOW_LIST_SIZE</span><span class="p">,</span>
<span class="linenos">1453</span><span class="w">										   </span><span class="n">cudaHostAllocPortable</span><span class="p">));</span>
<span class="linenos">1454</span><span class="w">	    </span><span class="n">CUDA_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">cudaMalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">d_overflows</span><span class="p">,</span>
<span class="linenos">1455</span><span class="w">		                                </span><span class="n">MPD_OVERFLOW_LIST_SIZE</span><span class="p">));</span>
<span class="linenos">1456</span><span class="w">		</span><span class="n">cudaMemsetAsync</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">d_overflows</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">MPD_OVERFLOW_LIST_SIZE</span><span class="p">);</span>
<span class="linenos">1457</span><span class="w">	</span><span class="cp">#endif</span>
<span class="linenos">1458</span><span class="w">	</span>
<span class="linenos">1459</span><span class="w">		</span><span class="n">memset</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">h_overflows</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">MPD_OVERFLOW_LIST_SIZE</span><span class="p">);</span>
<span class="linenos">1460</span><span class="w">	</span><span class="p">}</span>
<span class="linenos">1461</span><span class="w">	</span><span class="k">else</span>
<span class="linenos">1462</span><span class="w">	</span><span class="p">{</span>
<span class="linenos">1463</span><span class="w">		</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">h_overflows</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="linenos">1464</span><span class="w">	    </span><span class="n">CUDA_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">cudaMalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">d_overflows</span><span class="p">,</span>
<span class="linenos">1465</span><span class="w">		                                </span><span class="n">MPD_OVERFLOW_LIST_SIZE</span><span class="p">));</span>
<span class="linenos">1466</span><span class="w">		</span><span class="n">cudaMemsetAsync</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">d_overflows</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">MPD_OVERFLOW_LIST_SIZE</span><span class="p">);</span>
<span class="linenos">1467</span><span class="w">	</span><span class="p">}</span>
<span class="linenos">1468</span>
<span class="linenos">1469</span><span class="w">    </span><span class="c1">// Create data exchange streams and events</span>
<span class="linenos">1470</span><span class="w">    </span><span class="n">CUDA_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">cudaStreamCreate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">stream1</span><span class="p">));</span>
<span class="linenos">1471</span>
<span class="linenos">1472</span><span class="cp">#ifdef PROF_USE_CUEVENT</span>
<span class="linenos">1473</span><span class="w">    </span><span class="n">CUDA_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">cudaEventCreate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">x_finish</span><span class="p">));</span>
<span class="linenos">1474</span><span class="w">    </span><span class="n">CUDA_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">cudaEventCreate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">diffusion_finished</span><span class="p">));</span>
<span class="linenos">1475</span><span class="w">    </span><span class="n">CUDA_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">cudaEventCreate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">rx_finish</span><span class="p">));</span>
<span class="linenos">1476</span><span class="cp">#else</span>
<span class="linenos">1477</span><span class="w">    </span><span class="n">CUDA_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">cudaEventCreateWithFlags</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">x_finish</span><span class="p">,</span>
<span class="linenos">1478</span><span class="w">	                                              </span><span class="n">cudaEventDisableTiming</span><span class="p">));</span>
<span class="linenos">1479</span><span class="w">    </span><span class="n">CUDA_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">cudaEventCreateWithFlags</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">diffusion_finished</span><span class="p">,</span>
<span class="linenos">1480</span><span class="w">	                                              </span><span class="n">cudaEventDisableTiming</span><span class="p">));</span>
<span class="linenos">1481</span><span class="w">    </span><span class="n">CUDA_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">cudaEventCreateWithFlags</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">rx_finish</span><span class="p">,</span>
<span class="linenos">1482</span><span class="w">	                                              </span><span class="n">cudaEventDisableTiming</span><span class="p">));</span>
<span class="linenos">1483</span><span class="cp">#endif</span>
<span class="linenos">1484</span>
<span class="linenos">1485</span><span class="w">	</span><span class="kt">dim3</span><span class="w"> </span><span class="n">ldim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mapper</span><span class="o">-&gt;</span><span class="n">get_local_dim</span><span class="p">(</span><span class="n">gpu</span><span class="p">);</span>
<span class="linenos">1486</span><span class="w">	</span><span class="kt">dim3</span><span class="w"> </span><span class="n">gdim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mapper</span><span class="o">-&gt;</span><span class="n">get_global_dim</span><span class="p">(</span><span class="n">gpu</span><span class="p">);</span>
<span class="linenos">1487</span><span class="w">	</span>
<span class="linenos">1488</span><span class="w">	</span><span class="c1">// calculate launch params</span>
<span class="linenos">1489</span><span class="w">    </span><span class="n">calculateXLaunchParameters</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">grid_x</span><span class="p">),</span><span class="w"> </span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">threads_x</span><span class="p">,</span>
<span class="linenos">1490</span><span class="w">	                           </span><span class="n">TUNE_MPD_X_BLOCK_MAX_X_SIZE</span><span class="p">,</span>
<span class="linenos">1491</span><span class="w">							   </span><span class="n">ldim</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">ldim</span><span class="p">.</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">ldim</span><span class="p">.</span><span class="n">z</span><span class="p">);</span>
<span class="linenos">1492</span><span class="w">    </span><span class="n">calculateYLaunchParameters</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">grid_y</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">threads_y</span><span class="p">,</span>
<span class="linenos">1493</span><span class="w">	                           </span><span class="n">TUNE_MPD_Y_BLOCK_X_SIZE</span><span class="p">,</span><span class="w"> </span><span class="n">TUNE_MPD_Y_BLOCK_Y_SIZE</span><span class="p">,</span>
<span class="linenos">1494</span><span class="w">							   </span><span class="n">ldim</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">ldim</span><span class="p">.</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">ldim</span><span class="p">.</span><span class="n">z</span><span class="p">);</span>
<span class="linenos">1495</span><span class="w">    </span><span class="n">calculateZLaunchParameters</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">grid_z</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">threads_z</span><span class="p">,</span>
<span class="linenos">1496</span><span class="w">	                           </span><span class="n">TUNE_MPD_Z_BLOCK_X_SIZE</span><span class="p">,</span><span class="w"> </span><span class="n">TUNE_MPD_Z_BLOCK_Z_SIZE</span><span class="p">,</span>
<span class="linenos">1497</span><span class="w">							   </span><span class="n">ldim</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">ldim</span><span class="p">.</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">gdim</span><span class="p">.</span><span class="n">z</span><span class="p">);</span>
<span class="linenos">1498</span><span class="w">	</span><span class="n">calculateReactionLaunchParameters</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">grid_r</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">threads_r</span><span class="p">,</span>
<span class="linenos">1499</span><span class="w">	                                  </span><span class="n">TUNE_MPD_REACTION_BLOCK_X_SIZE</span><span class="p">,</span><span class="w"> </span><span class="n">TUNE_MPD_REACTION_BLOCK_Y_SIZE</span><span class="p">,</span>
<span class="linenos">1500</span><span class="w">									  </span><span class="n">ldim</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">ldim</span><span class="p">.</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">gdim</span><span class="p">.</span><span class="n">z</span><span class="p">);</span>
<span class="linenos">1501</span>
<span class="linenos">1502</span><span class="w">	</span><span class="c1">// Now here, do not copy model every time</span>
<span class="linenos">1503</span><span class="w">	</span><span class="n">copyModelsToDevice</span><span class="p">(</span><span class="n">gpu</span><span class="p">);</span>
<span class="linenos">1504</span>
<span class="linenos">1505</span><span class="w">	</span><span class="c1">// Copy the initialized data into GPU memory</span>
<span class="linenos">1506</span><span class="w">	</span><span class="n">mapper</span><span class="o">-&gt;</span><span class="n">stage_in</span><span class="p">(</span><span class="n">gpu</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dLattice</span><span class="p">,</span><span class="w"> </span><span class="p">((</span><span class="n">CudaIntLattice</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">lattice</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">getParticlesMemory</span><span class="p">());</span>
<span class="linenos">1507</span><span class="w">	</span><span class="n">mapper</span><span class="o">-&gt;</span><span class="n">stage_in_sites</span><span class="p">(</span><span class="n">gpu</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dSites</span><span class="p">,</span><span class="w"> </span><span class="p">((</span><span class="n">CudaIntLattice</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">lattice</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">getSitesMemory</span><span class="p">());</span>
<span class="linenos">1508</span><span class="w">	</span><span class="n">mapper</span><span class="o">-&gt;</span><span class="n">publish_state</span><span class="p">(</span><span class="n">gpu</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dLattice</span><span class="p">,</span><span class="w"> </span><span class="n">current_timestep</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
<span class="linenos">1509</span><span class="w">	</span>
<span class="linenos">1510</span><span class="w">	</span><span class="n">Timer</span><span class="w"> </span><span class="n">timer</span><span class="p">;</span>
<span class="linenos">1511</span><span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">lastT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">1512</span><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">lastSteps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">1513</span><span class="w">	</span><span class="kt">size_t</span><span class="w"> </span><span class="n">maxTS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">atof</span><span class="p">((</span><span class="o">*</span><span class="n">parameters</span><span class="p">)[</span><span class="s">&quot;maxTime&quot;</span><span class="p">].</span><span class="n">c_str</span><span class="p">())</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">tau</span><span class="p">;</span>
<span class="linenos">1514</span><span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">gpu</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">1515</span><span class="w">		</span><span class="n">timer</span><span class="p">.</span><span class="n">tick</span><span class="p">();</span>
<span class="linenos">1516</span>
<span class="linenos">1517</span><span class="w">	</span><span class="k">do</span>
<span class="linenos">1518</span><span class="w">	</span><span class="p">{</span>
<span class="linenos">1519</span><span class="w">		</span><span class="c1">// wait for master wakeup</span>
<span class="linenos">1520</span><span class="w">		</span><span class="n">pthread_barrier_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">start_barrier</span><span class="p">);</span>
<span class="linenos">1521</span>
<span class="linenos">1522</span><span class="w">		</span><span class="kt">int</span><span class="w"> </span><span class="n">steps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">timesteps_to_run</span><span class="p">;</span>
<span class="linenos">1523</span><span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">steps</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">1524</span><span class="w">			</span><span class="k">break</span><span class="p">;</span>
<span class="linenos">1525</span>
<span class="linenos">1526</span><span class="w">		</span><span class="c1">// Don&#39;t copy models in on every step set</span>
<span class="linenos">1527</span><span class="w">		</span><span class="c1">// This was to accomodate changing lattice dims from lb changes</span>
<span class="linenos">1528</span><span class="w">		</span><span class="c1">// Unless the reaction model has changed</span>
<span class="linenos">1529</span><span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">reactionModelModified</span><span class="p">)</span><span class="w"> </span>
<span class="linenos">1530</span><span class="w">		</span><span class="p">{</span>
<span class="linenos">1531</span><span class="w">			</span><span class="n">copyModelsToDevice</span><span class="p">(</span><span class="n">gpu</span><span class="p">);</span>
<span class="linenos">1532</span><span class="w">		</span><span class="p">}</span>
<span class="linenos">1533</span>
<span class="linenos">1534</span><span class="w">		</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">ts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">ts</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">steps</span><span class="p">;</span><span class="w"> </span><span class="n">ts</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">1535</span><span class="w">		</span><span class="p">{</span>
<span class="linenos">1536</span><span class="w">			</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">gpu</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">1537</span><span class="w">			</span><span class="p">{</span>
<span class="linenos">1538</span><span class="w">				</span><span class="n">lastT</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">timer</span><span class="p">.</span><span class="n">tock</span><span class="p">();</span>
<span class="linenos">1539</span><span class="w">				</span><span class="n">lastSteps</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="linenos">1540</span>
<span class="linenos">1541</span><span class="w">				</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">lastT</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">printPerfInterval</span><span class="p">)</span>
<span class="linenos">1542</span><span class="w">				</span><span class="p">{</span>
<span class="linenos">1543</span><span class="w">					</span><span class="kt">double</span><span class="w"> </span><span class="n">stepTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lastT</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">lastSteps</span><span class="p">;</span>
<span class="linenos">1544</span><span class="w">					</span><span class="kt">double</span><span class="w"> </span><span class="n">completionTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stepTime</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">maxTS</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">current_timestep</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">ts</span><span class="p">);</span>
<span class="linenos">1545</span><span class="w">					</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">units</span><span class="p">;</span>
<span class="linenos">1546</span><span class="w">					</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">completionTime</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">24</span><span class="o">*</span><span class="mi">365</span><span class="p">)</span>
<span class="linenos">1547</span><span class="w">					</span><span class="p">{</span>
<span class="linenos">1548</span><span class="w">						</span><span class="n">units</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;weeks&quot;</span><span class="p">;</span>
<span class="linenos">1549</span><span class="w">						</span><span class="n">completionTime</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">24</span><span class="o">*</span><span class="mi">365</span><span class="p">;</span>
<span class="linenos">1550</span><span class="w">					</span><span class="p">}</span>
<span class="linenos">1551</span><span class="w">					</span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">completionTime</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">24</span><span class="o">*</span><span class="mi">30</span><span class="p">)</span>
<span class="linenos">1552</span><span class="w">					</span><span class="p">{</span>
<span class="linenos">1553</span><span class="w">						</span><span class="n">units</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;months&quot;</span><span class="p">;</span>
<span class="linenos">1554</span><span class="w">						</span><span class="n">completionTime</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">24</span><span class="o">*</span><span class="mi">30</span><span class="p">;</span>
<span class="linenos">1555</span><span class="w">					</span><span class="p">}</span>
<span class="linenos">1556</span><span class="w">					</span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">completionTime</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">24</span><span class="o">*</span><span class="mi">7</span><span class="p">)</span>
<span class="linenos">1557</span><span class="w">					</span><span class="p">{</span>
<span class="linenos">1558</span><span class="w">						</span><span class="n">units</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;weeks&quot;</span><span class="p">;</span>
<span class="linenos">1559</span><span class="w">						</span><span class="n">completionTime</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">24</span><span class="o">*</span><span class="mi">7</span><span class="p">;</span>
<span class="linenos">1560</span><span class="w">					</span><span class="p">}</span>
<span class="linenos">1561</span><span class="w">					</span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">completionTime</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">24</span><span class="p">)</span>
<span class="linenos">1562</span><span class="w">					</span><span class="p">{</span>
<span class="linenos">1563</span><span class="w">						</span><span class="n">units</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;days&quot;</span><span class="p">;</span>
<span class="linenos">1564</span><span class="w">						</span><span class="n">completionTime</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">24</span><span class="p">;</span>
<span class="linenos">1565</span><span class="w">					</span><span class="p">}</span>
<span class="linenos">1566</span><span class="w">					</span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">completionTime</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>
<span class="linenos">1567</span><span class="w">					</span><span class="p">{</span>
<span class="linenos">1568</span><span class="w">						</span><span class="n">units</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;hours&quot;</span><span class="p">;</span>
<span class="linenos">1569</span><span class="w">						</span><span class="n">completionTime</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="p">;</span>
<span class="linenos">1570</span><span class="w">					</span><span class="p">}</span>
<span class="linenos">1571</span><span class="w">					</span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">completionTime</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">60</span><span class="p">)</span>
<span class="linenos">1572</span><span class="w">					</span><span class="p">{</span>
<span class="linenos">1573</span><span class="w">						</span><span class="n">units</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;minutes&quot;</span><span class="p">;</span>
<span class="linenos">1574</span><span class="w">						</span><span class="n">completionTime</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="mi">60</span><span class="p">;</span>
<span class="linenos">1575</span><span class="w">					</span><span class="p">}</span>
<span class="linenos">1576</span><span class="w">					</span><span class="k">else</span>
<span class="linenos">1577</span><span class="w">					</span><span class="p">{</span>
<span class="linenos">1578</span><span class="w">						</span><span class="n">units</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;seconds&quot;</span><span class="p">;</span>
<span class="linenos">1579</span><span class="w">					</span><span class="p">}</span>
<span class="linenos">1580</span>
<span class="linenos">1581</span><span class="w">					</span><span class="n">Print</span><span class="o">::</span><span class="n">printf</span><span class="p">(</span><span class="n">Print</span><span class="o">::</span><span class="n">INFO</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Average walltime per timestep: %.2f ms. Progress: %.4fs/%.4fs (% .3g%% done / %.2g %s walltime remaining)&quot;</span><span class="p">,</span>
<span class="linenos">1582</span><span class="w">								  </span><span class="mf">1000.0</span><span class="o">*</span><span class="n">stepTime</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">ts</span><span class="o">+</span><span class="n">current_timestep</span><span class="p">)</span><span class="o">*</span><span class="n">tau</span><span class="p">,</span><span class="w"> </span><span class="n">maxTS</span><span class="o">*</span><span class="n">tau</span><span class="p">,</span><span class="w"> </span><span class="mf">100.0</span><span class="o">*</span><span class="p">(</span><span class="n">ts</span><span class="o">+</span><span class="n">current_timestep</span><span class="p">)</span><span class="o">/</span><span class="n">maxTS</span><span class="p">,</span><span class="w"> </span><span class="n">completionTime</span><span class="p">,</span><span class="w"> </span><span class="n">units</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
<span class="linenos">1583</span>
<span class="linenos">1584</span><span class="w">					</span><span class="n">lastT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">1585</span><span class="w">					</span><span class="n">lastSteps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">1586</span><span class="w">				</span><span class="p">}</span>
<span class="linenos">1587</span>
<span class="linenos">1588</span><span class="w">				</span><span class="n">timer</span><span class="p">.</span><span class="n">tick</span><span class="p">();</span>
<span class="linenos">1589</span><span class="w">			</span><span class="p">}</span>
<span class="linenos">1590</span>
<span class="linenos">1591</span><span class="w">			</span><span class="kt">int</span><span class="w"> </span><span class="n">overflows</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">run_next_timestep</span><span class="p">(</span><span class="n">gpu</span><span class="p">,</span><span class="w"> </span><span class="n">ts</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">current_timestep</span><span class="p">);</span>
<span class="linenos">1592</span><span class="w">			</span>
<span class="linenos">1593</span><span class="w">			</span><span class="k">switch</span><span class="p">(</span><span class="n">overflow_handling</span><span class="p">)</span>
<span class="linenos">1594</span><span class="w">			</span><span class="p">{</span>
<span class="linenos">1595</span><span class="w">				</span><span class="k">case</span><span class="w"> </span><span class="no">OVERFLOW_MODE_CLASSIC</span><span class="p">:</span>
<span class="linenos">1596</span><span class="w">					</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">use_spin_barrier</span><span class="p">)</span>
<span class="linenos">1597</span><span class="w">						</span><span class="n">mclkr_int_barrier_spin</span><span class="p">(</span><span class="n">overflows</span><span class="p">);</span>
<span class="linenos">1598</span><span class="w">					</span><span class="k">else</span>
<span class="linenos">1599</span><span class="w">						</span><span class="n">mclkr_int_barrier_cond</span><span class="p">(</span><span class="n">overflows</span><span class="p">);</span>
<span class="linenos">1600</span>
<span class="linenos">1601</span><span class="w">					</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mclkr_int_total_overflows</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">1602</span><span class="w">					</span><span class="p">{</span>
<span class="linenos">1603</span><span class="w">						</span><span class="n">Print</span><span class="o">::</span><span class="n">printf</span><span class="p">(</span><span class="n">Print</span><span class="o">::</span><span class="n">DEBUG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;[GPU Thread %d] encountered %d overflows&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">gpu</span><span class="p">,</span><span class="w"> </span><span class="n">overflows</span><span class="p">);</span>
<span class="linenos">1604</span><span class="w">						</span><span class="n">handle_overflows</span><span class="p">(</span><span class="n">gpu</span><span class="p">,</span><span class="w"> </span><span class="p">((</span><span class="n">CudaIntLattice</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">lattice</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">getParticlesMemory</span><span class="p">(),</span>
<span class="linenos">1605</span><span class="w">						                 </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dLattice</span><span class="p">,</span><span class="w"> </span><span class="n">ts</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">current_timestep</span><span class="p">);</span>
<span class="linenos">1606</span><span class="w">					</span><span class="p">}</span>
<span class="linenos">1607</span><span class="w">					</span><span class="k">break</span><span class="p">;</span>
<span class="linenos">1608</span>
<span class="linenos">1609</span><span class="w">				</span><span class="k">case</span><span class="w"> </span><span class="no">OVERFLOW_MODE_RELAXED</span><span class="p">:</span>
<span class="linenos">1610</span><span class="w">					</span><span class="c1">// All overflows are handled by the gpu.  No need to communicate.</span>
<span class="linenos">1611</span><span class="w">					</span><span class="n">pthread_barrier_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">simulation_barrier</span><span class="p">);</span>
<span class="linenos">1612</span><span class="w">					</span><span class="k">break</span><span class="p">;</span>
<span class="linenos">1613</span>
<span class="linenos">1614</span><span class="w">				</span><span class="k">default</span><span class="o">:</span>
<span class="linenos">1615</span><span class="w">					</span><span class="n">throw</span><span class="p">(</span><span class="s">&quot;Unimplemented overflow handler&quot;</span><span class="p">);</span>
<span class="linenos">1616</span><span class="w">			</span><span class="p">}</span>
<span class="linenos">1617</span><span class="w">		</span><span class="p">}</span>
<span class="linenos">1618</span>
<span class="linenos">1619</span><span class="w">		</span><span class="n">mapper</span><span class="o">-&gt;</span><span class="n">stage_out</span><span class="p">(</span><span class="n">gpu</span><span class="p">,</span><span class="w"> </span><span class="p">((</span><span class="n">CudaIntLattice</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">lattice</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">getParticlesMemory</span><span class="p">(),</span><span class="w"> </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dLattice</span><span class="p">);</span>
<span class="linenos">1620</span><span class="w">		</span><span class="n">pthread_barrier_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stop_barrier</span><span class="p">);</span>
<span class="linenos">1621</span>
<span class="linenos">1622</span><span class="w">	</span><span class="p">}</span><span class="w"> </span><span class="k">while</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
<span class="linenos">1623</span>
<span class="linenos">1624</span><span class="w">	</span><span class="n">Print</span><span class="o">::</span><span class="n">printf</span><span class="p">(</span><span class="n">Print</span><span class="o">::</span><span class="n">DEBUG</span><span class="p">,</span><span class="s">&quot;[GPU Thread %d] leaving.&quot;</span><span class="p">,</span><span class="n">gpu</span><span class="p">);</span>
<span class="linenos">1625</span>
<span class="linenos">1626</span><span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="linenos">1627</span><span class="p">}</span>
<span class="linenos">1628</span>
<span class="linenos">1629</span><span class="kt">int</span><span class="w"> </span><span class="n">MGPUIntMpdRdmeSolver</span><span class="o">::</span><span class="n">hookSimulation</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="n">CudaIntLattice</span><span class="w"> </span><span class="o">*</span><span class="n">lattice</span><span class="p">)</span>
<span class="linenos">1630</span><span class="p">{</span>
<span class="linenos">1631</span><span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">1632</span><span class="p">}</span>
<span class="linenos">1633</span>
<span class="linenos">1634</span><span class="kt">void</span><span class="w"> </span><span class="n">MGPUIntMpdRdmeSolver</span><span class="o">::</span><span class="n">calculateXLaunchParameters</span><span class="p">(</span><span class="kt">dim3</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">gridSize</span><span class="p">,</span>
<span class="linenos">1635</span><span class="w">                                                      </span><span class="kt">dim3</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">threadBlockSize</span><span class="p">,</span>
<span class="linenos">1636</span><span class="w">													  </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">maxXBlockSize</span><span class="p">,</span>
<span class="linenos">1637</span><span class="w">													  </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeXSize</span><span class="p">,</span>
<span class="linenos">1638</span><span class="w">													  </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeYSize</span><span class="p">,</span>
<span class="linenos">1639</span><span class="w">													  </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeZSize</span><span class="p">)</span>
<span class="linenos">1640</span><span class="p">{</span>
<span class="linenos">1641</span><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">xBlockXSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">min</span><span class="p">(</span><span class="n">maxXBlockSize</span><span class="p">,</span><span class="w"> </span><span class="n">latticeXSize</span><span class="p">);</span>
<span class="linenos">1642</span><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">gridXSize</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">latticeXSize</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">xBlockXSize</span><span class="p">;</span>
<span class="linenos">1643</span>
<span class="linenos">1644</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">gridXSize</span><span class="o">*</span><span class="n">xBlockXSize</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">latticeXSize</span><span class="p">)</span>
<span class="linenos">1645</span><span class="w">	</span><span class="p">{</span>
<span class="linenos">1646</span><span class="w">		</span><span class="c1">// Find the largest number of warps that is divisible</span>
<span class="linenos">1647</span><span class="w">		</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">tryx</span><span class="o">=</span><span class="mi">32</span><span class="p">;</span>
<span class="linenos">1648</span><span class="w">		</span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">tryx</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">maxXBlockSize</span><span class="p">)</span>
<span class="linenos">1649</span><span class="w">		</span><span class="p">{</span>
<span class="linenos">1650</span><span class="w">			</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">latticeXSize</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">tryx</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">1651</span><span class="w">				</span><span class="n">xBlockXSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tryx</span><span class="p">;</span>
<span class="linenos">1652</span><span class="w">			</span><span class="n">tryx</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">32</span><span class="p">;</span>
<span class="linenos">1653</span><span class="w">		</span><span class="p">}</span>
<span class="linenos">1654</span><span class="w">		</span><span class="n">gridXSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">latticeXSize</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">xBlockXSize</span><span class="p">;</span>
<span class="linenos">1655</span><span class="w">	</span><span class="p">}</span>
<span class="linenos">1656</span><span class="w">			</span>
<span class="linenos">1657</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">gridSize</span><span class="p">).</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gridXSize</span><span class="p">;</span>
<span class="linenos">1658</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">gridSize</span><span class="p">).</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">latticeYSize</span><span class="p">;</span>
<span class="linenos">1659</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">gridSize</span><span class="p">).</span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">latticeZSize</span><span class="p">;</span>
<span class="linenos">1660</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">threadBlockSize</span><span class="p">).</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">xBlockXSize</span><span class="p">;</span>
<span class="linenos">1661</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">threadBlockSize</span><span class="p">).</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="linenos">1662</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">threadBlockSize</span><span class="p">).</span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="linenos">1663</span><span class="p">}</span>
<span class="linenos">1664</span>
<span class="linenos">1665</span><span class="kt">void</span><span class="w"> </span><span class="n">MGPUIntMpdRdmeSolver</span><span class="o">::</span><span class="n">calculateYLaunchParameters</span><span class="p">(</span><span class="kt">dim3</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">gridSize</span><span class="p">,</span>
<span class="linenos">1666</span><span class="w">                                                      </span><span class="kt">dim3</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">threadBlockSize</span><span class="p">,</span>
<span class="linenos">1667</span><span class="w">													  </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">blockXSize</span><span class="p">,</span>
<span class="linenos">1668</span><span class="w">													  </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">blockYSize</span><span class="p">,</span>
<span class="linenos">1669</span><span class="w">													  </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeXSize</span><span class="p">,</span>
<span class="linenos">1670</span><span class="w">													  </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeYSize</span><span class="p">,</span>
<span class="linenos">1671</span><span class="w">													  </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeZSize</span><span class="p">)</span>
<span class="linenos">1672</span><span class="p">{</span>
<span class="linenos">1673</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">gridSize</span><span class="p">).</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">latticeXSize</span><span class="o">/</span><span class="n">blockXSize</span><span class="p">;</span>
<span class="linenos">1674</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">gridSize</span><span class="p">).</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">latticeYSize</span><span class="o">/</span><span class="n">blockYSize</span><span class="p">;</span>
<span class="linenos">1675</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">gridSize</span><span class="p">).</span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">latticeZSize</span><span class="p">;</span>
<span class="linenos">1676</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">threadBlockSize</span><span class="p">).</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blockXSize</span><span class="p">;</span>
<span class="linenos">1677</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">threadBlockSize</span><span class="p">).</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blockYSize</span><span class="p">;</span>
<span class="linenos">1678</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">threadBlockSize</span><span class="p">).</span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="linenos">1679</span><span class="p">}</span>
<span class="linenos">1680</span>
<span class="linenos">1681</span><span class="kt">void</span><span class="w"> </span><span class="n">MGPUIntMpdRdmeSolver</span><span class="o">::</span><span class="n">calculateZLaunchParameters</span><span class="p">(</span><span class="kt">dim3</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">gridSize</span><span class="p">,</span>
<span class="linenos">1682</span><span class="w">                                                      </span><span class="kt">dim3</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">threadBlockSize</span><span class="p">,</span>
<span class="linenos">1683</span><span class="w">													  </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">blockXSize</span><span class="p">,</span>
<span class="linenos">1684</span><span class="w">													  </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">blockZSize</span><span class="p">,</span>
<span class="linenos">1685</span><span class="w">													  </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeXSize</span><span class="p">,</span>
<span class="linenos">1686</span><span class="w">													  </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeYSize</span><span class="p">,</span>
<span class="linenos">1687</span><span class="w">													  </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeZSize</span><span class="p">)</span>
<span class="linenos">1688</span><span class="p">{</span>
<span class="linenos">1689</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">gridSize</span><span class="p">).</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">latticeXSize</span><span class="o">/</span><span class="n">blockXSize</span><span class="p">;</span>
<span class="linenos">1690</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">gridSize</span><span class="p">).</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">latticeYSize</span><span class="p">;</span>
<span class="linenos">1691</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">gridSize</span><span class="p">).</span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">latticeZSize</span><span class="o">/</span><span class="n">blockZSize</span><span class="p">;</span>
<span class="linenos">1692</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">threadBlockSize</span><span class="p">).</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blockXSize</span><span class="p">;</span>
<span class="linenos">1693</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">threadBlockSize</span><span class="p">).</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="linenos">1694</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">threadBlockSize</span><span class="p">).</span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blockZSize</span><span class="p">;</span>
<span class="linenos">1695</span><span class="p">}</span>
<span class="linenos">1696</span>
<span class="linenos">1697</span><span class="kt">void</span><span class="w"> </span><span class="n">MGPUIntMpdRdmeSolver</span><span class="o">::</span><span class="n">calculateReactionLaunchParameters</span><span class="p">(</span><span class="kt">dim3</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">gridSize</span><span class="p">,</span>
<span class="linenos">1698</span><span class="w">                                                             </span><span class="kt">dim3</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">threadBlockSize</span><span class="p">,</span>
<span class="linenos">1699</span><span class="w">															 </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">blockXSize</span><span class="p">,</span>
<span class="linenos">1700</span><span class="w">															 </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">blockYSize</span><span class="p">,</span>
<span class="linenos">1701</span><span class="w">															 </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeXSize</span><span class="p">,</span>
<span class="linenos">1702</span><span class="w">															 </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeYSize</span><span class="p">,</span>
<span class="linenos">1703</span><span class="w">															 </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeZSize</span><span class="p">)</span>
<span class="linenos">1704</span><span class="p">{</span>
<span class="linenos">1705</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">gridSize</span><span class="p">).</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">latticeXSize</span><span class="o">/</span><span class="n">blockXSize</span><span class="p">;</span>
<span class="linenos">1706</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">gridSize</span><span class="p">).</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">latticeYSize</span><span class="o">/</span><span class="n">blockYSize</span><span class="p">;</span>
<span class="linenos">1707</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">gridSize</span><span class="p">).</span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">latticeZSize</span><span class="p">;</span>
<span class="linenos">1708</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">threadBlockSize</span><span class="p">).</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blockXSize</span><span class="p">;</span>
<span class="linenos">1709</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">threadBlockSize</span><span class="p">).</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blockYSize</span><span class="p">;</span>
<span class="linenos">1710</span><span class="w">    </span><span class="p">(</span><span class="o">*</span><span class="n">threadBlockSize</span><span class="p">).</span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="linenos">1711</span><span class="p">}</span>
<span class="linenos">1712</span>
<span class="linenos">1713</span><span class="n">namespace</span><span class="w"> </span><span class="n">mgpuintmpdrdme_dev</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">1714</span><span class="cm">/**</span>
<span class="linenos">1715</span><span class="cm"> * Multiparticle diffusion performed by copying the lattice section to shared memory, making a choice for each lattice</span>
<span class="linenos">1716</span><span class="cm"> * site, storing the new lattice into shared memory, and then updating the global lattice.</span>
<span class="linenos">1717</span><span class="cm"> */</span>
<span class="linenos">1718</span><span class="kr">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">MGPU_x_kernel</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">inLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">inSites</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">outLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">z_start</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">)</span>
<span class="linenos">1719</span><span class="p">{</span>
<span class="linenos">1720</span><span class="w">	</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nb">blockDim</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
<span class="linenos">1721</span><span class="w">	</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nb">blockDim</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
<span class="linenos">1722</span><span class="w">	</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">z</span><span class="o">+</span><span class="n">z_start</span><span class="p">;</span>
<span class="linenos">1723</span><span class="w">	</span>
<span class="linenos">1724</span><span class="w">    </span><span class="c1">// Figure out the offset of this thread in the lattice and the lattice segment.</span>
<span class="linenos">1725</span><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeXIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="p">;</span>
<span class="linenos">1726</span><span class="w">	</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">local_index</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">z</span><span class="p">);</span>
<span class="linenos">1727</span><span class="w">	</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">globalIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">local_to_global</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">z</span><span class="p">);</span><span class="w"> </span><span class="c1">// Use the global lattice index for RNG</span>
<span class="linenos">1728</span><span class="w">	</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">windowIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="o">+</span><span class="n">MPD_APRON_SIZE</span><span class="p">;</span>
<span class="linenos">1729</span>
<span class="linenos">1730</span><span class="w">    </span><span class="c1">///////////////////////////////////////////</span>
<span class="linenos">1731</span><span class="w">    </span><span class="c1">// Load the lattice into shared memory. //</span>
<span class="linenos">1732</span><span class="w">    </span><span class="c1">///////////////////////////////////////////</span>
<span class="linenos">1733</span>
<span class="linenos">1734</span><span class="w">    </span><span class="c1">// Shared memory to store the lattice segment.</span>
<span class="linenos">1735</span><span class="w">    </span><span class="kt">__shared__</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">window</span><span class="p">[</span><span class="n">MPD_X_WINDOW_SIZE</span><span class="o">*</span><span class="n">MPD_WORDS_PER_SITE</span><span class="p">];</span>
<span class="linenos">1736</span><span class="w">    </span><span class="kt">__shared__</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">sitesWindow</span><span class="p">[</span><span class="n">MPD_X_WINDOW_SIZE</span><span class="p">];</span>
<span class="linenos">1737</span>
<span class="linenos">1738</span><span class="w">    </span><span class="c1">// Copy the x window from device memory into shared memory.</span>
<span class="linenos">1739</span><span class="w">    </span><span class="n">copyXWindowFromLattice</span><span class="p">(</span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">inLattice</span><span class="p">,</span><span class="w"> </span><span class="n">window</span><span class="p">,</span><span class="w"> </span><span class="n">latticeIndex</span><span class="p">,</span><span class="w"> </span><span class="n">latticeXIndex</span><span class="p">,</span><span class="w"> </span><span class="n">windowIndex</span><span class="p">);</span>
<span class="linenos">1740</span><span class="w">    </span><span class="n">copyXWindowFromSites</span><span class="p">(</span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">inSites</span><span class="p">,</span><span class="w"> </span><span class="n">sitesWindow</span><span class="p">,</span><span class="w"> </span><span class="n">latticeIndex</span><span class="p">,</span><span class="w"> </span><span class="n">latticeXIndex</span><span class="p">,</span><span class="w"> </span><span class="n">windowIndex</span><span class="p">);</span>
<span class="linenos">1741</span><span class="w">    </span><span class="nf">__syncthreads</span><span class="p">();</span>
<span class="linenos">1742</span>
<span class="linenos">1743</span><span class="w">    </span><span class="c1">////////////////////////////////////////</span>
<span class="linenos">1744</span><span class="w">    </span><span class="c1">// Make the choice for each particle. //</span>
<span class="linenos">1745</span><span class="w">    </span><span class="c1">////////////////////////////////////////</span>
<span class="linenos">1746</span>
<span class="linenos">1747</span><span class="w">    </span><span class="kt">__shared__</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">choices</span><span class="p">[</span><span class="n">MPD_X_WINDOW_SIZE</span><span class="o">*</span><span class="n">MPD_WORDS_PER_SITE</span><span class="p">];</span>
<span class="linenos">1748</span>
<span class="linenos">1749</span><span class="w">    </span><span class="c1">// Make the choices.</span>
<span class="linenos">1750</span><span class="w">    </span><span class="n">makeXDiffusionChoices</span><span class="p">(</span><span class="n">window</span><span class="p">,</span><span class="w"> </span><span class="n">sitesWindow</span><span class="p">,</span><span class="w"> </span><span class="n">choices</span><span class="p">,</span><span class="w"> </span><span class="n">globalIndex</span><span class="p">,</span><span class="w"> </span><span class="n">latticeXIndex</span><span class="p">,</span><span class="w"> </span><span class="n">windowIndex</span><span class="p">,</span><span class="w"> </span><span class="nb">blockDim</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">);</span>
<span class="linenos">1751</span><span class="w">	</span><span class="nf">__syncthreads</span><span class="p">();</span>
<span class="linenos">1752</span>
<span class="linenos">1753</span><span class="w">    </span><span class="c1">//////////////////////////////////////////////////////////</span>
<span class="linenos">1754</span><span class="w">    </span><span class="c1">// Create version of the lattice at the next time step. //</span>
<span class="linenos">1755</span><span class="w">    </span><span class="c1">//////////////////////////////////////////////////////////</span>
<span class="linenos">1756</span>
<span class="linenos">1757</span><span class="w">    </span><span class="c1">// Propagate the choices to the new lattice segment.</span>
<span class="linenos">1758</span><span class="w">    </span><span class="n">performPropagation</span><span class="p">(</span><span class="n">outLattice</span><span class="p">,</span><span class="w"> </span><span class="n">window</span><span class="p">,</span><span class="w"> </span><span class="n">choices</span><span class="p">,</span><span class="w"> </span><span class="n">latticeIndex</span><span class="p">,</span><span class="w"> </span><span class="n">windowIndex</span><span class="mi">-1</span><span class="p">,</span><span class="w"> </span><span class="n">windowIndex</span><span class="p">,</span><span class="w"> </span><span class="n">windowIndex</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">MPD_X_WINDOW_SIZE</span><span class="p">,</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">);</span>
<span class="linenos">1759</span><span class="p">}</span>
<span class="linenos">1760</span>
<span class="linenos">1761</span>
<span class="linenos">1762</span><span class="cm">/**</span>
<span class="linenos">1763</span><span class="cm"> * Multiparticle diffusion performed by copying the lattice section to shared memory, making a choice for each lattice</span>
<span class="linenos">1764</span><span class="cm"> * site, storing the new lattice into shared memory, and then updating the global lattice.</span>
<span class="linenos">1765</span><span class="cm"> */</span>
<span class="linenos">1766</span><span class="kr">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">MGPU_y_kernel</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">inLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">inSites</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">outLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">)</span>
<span class="linenos">1767</span><span class="p">{</span>
<span class="linenos">1768</span>
<span class="linenos">1769</span><span class="w">	</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nb">blockDim</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
<span class="linenos">1770</span><span class="w">	</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nb">blockDim</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
<span class="linenos">1771</span><span class="w">	</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">z</span><span class="p">;</span>
<span class="linenos">1772</span>
<span class="linenos">1773</span><span class="w">    </span><span class="c1">// Figure out the offset of this thread in the lattice and the lattice segment.</span>
<span class="linenos">1774</span><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeYIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">y</span><span class="o">*</span><span class="nb">blockDim</span><span class="p">.</span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
<span class="linenos">1775</span><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">windowYIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">y</span><span class="o">+</span><span class="n">MPD_APRON_SIZE</span><span class="p">;</span>
<span class="linenos">1776</span><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">windowIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">windowYIndex</span><span class="o">*</span><span class="nb">blockDim</span><span class="p">.</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
<span class="linenos">1777</span>
<span class="linenos">1778</span><span class="w">	</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">local_index</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">z</span><span class="p">);</span>
<span class="linenos">1779</span><span class="w">	</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">globalIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">local_to_global</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">z</span><span class="p">);</span><span class="w"> </span><span class="c1">// Use the global lattice index for RNG</span>
<span class="linenos">1780</span>
<span class="linenos">1781</span><span class="w">    </span><span class="c1">///////////////////////////////////////////</span>
<span class="linenos">1782</span><span class="w">    </span><span class="c1">// Load the lattice into shared memory. //</span>
<span class="linenos">1783</span><span class="w">    </span><span class="c1">///////////////////////////////////////////</span>
<span class="linenos">1784</span>
<span class="linenos">1785</span><span class="w">    </span><span class="c1">// Shared memory to store the lattice segment. Each lattice site has four particles, eight bits for each particle.</span>
<span class="linenos">1786</span><span class="w">    </span><span class="kt">__shared__</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">window</span><span class="p">[</span><span class="n">MPD_Y_WINDOW_SIZE</span><span class="o">*</span><span class="n">MPD_WORDS_PER_SITE</span><span class="p">];</span>
<span class="linenos">1787</span><span class="w">    </span><span class="kt">__shared__</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">sitesWindow</span><span class="p">[</span><span class="n">MPD_Y_WINDOW_SIZE</span><span class="p">];</span>
<span class="linenos">1788</span>
<span class="linenos">1789</span><span class="w">    </span><span class="c1">// Copy the x window from device memory into shared memory.</span>
<span class="linenos">1790</span><span class="w">    </span><span class="n">copyYWindowFromLattice</span><span class="p">(</span><span class="n">inLattice</span><span class="p">,</span><span class="w"> </span><span class="n">window</span><span class="p">,</span><span class="w"> </span><span class="n">latticeIndex</span><span class="p">,</span><span class="w"> </span><span class="n">latticeYIndex</span><span class="p">,</span><span class="w"> </span><span class="n">windowIndex</span><span class="p">,</span><span class="w"> </span><span class="n">windowYIndex</span><span class="p">);</span>
<span class="linenos">1791</span><span class="w">    </span><span class="n">copyYWindowFromSites</span><span class="p">(</span><span class="n">inSites</span><span class="p">,</span><span class="w"> </span><span class="n">sitesWindow</span><span class="p">,</span><span class="w"> </span><span class="n">latticeIndex</span><span class="p">,</span><span class="w"> </span><span class="n">latticeYIndex</span><span class="p">,</span><span class="w"> </span><span class="n">windowIndex</span><span class="p">,</span><span class="w"> </span><span class="n">windowYIndex</span><span class="p">);</span>
<span class="linenos">1792</span><span class="w">    </span><span class="nf">__syncthreads</span><span class="p">();</span>
<span class="linenos">1793</span>
<span class="linenos">1794</span><span class="w">    </span><span class="c1">////////////////////////////////////////</span>
<span class="linenos">1795</span><span class="w">    </span><span class="c1">// Make the choice for each particle. //</span>
<span class="linenos">1796</span><span class="w">    </span><span class="c1">////////////////////////////////////////</span>
<span class="linenos">1797</span>
<span class="linenos">1798</span><span class="w">    </span><span class="kt">__shared__</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">choices</span><span class="p">[</span><span class="n">MPD_Y_WINDOW_SIZE</span><span class="o">*</span><span class="n">MPD_WORDS_PER_SITE</span><span class="p">];</span>
<span class="linenos">1799</span>
<span class="linenos">1800</span><span class="w">    </span><span class="c1">// Make the choices.</span>
<span class="linenos">1801</span><span class="w">    </span><span class="n">makeYDiffusionChoices</span><span class="p">(</span><span class="n">window</span><span class="p">,</span><span class="w"> </span><span class="n">sitesWindow</span><span class="p">,</span><span class="w"> </span><span class="n">choices</span><span class="p">,</span><span class="w"> </span><span class="n">globalIndex</span><span class="p">,</span><span class="w"> </span><span class="n">latticeYIndex</span><span class="p">,</span><span class="w"> </span><span class="n">windowIndex</span><span class="p">,</span><span class="w"> </span><span class="n">windowYIndex</span><span class="p">,</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">);</span>
<span class="linenos">1802</span><span class="w">	</span><span class="nf">__syncthreads</span><span class="p">();</span>
<span class="linenos">1803</span>
<span class="linenos">1804</span><span class="w">    </span><span class="c1">//////////////////////////////////////////////////////////</span>
<span class="linenos">1805</span><span class="w">    </span><span class="c1">// Create version of the lattice at the next time step. //</span>
<span class="linenos">1806</span><span class="w">    </span><span class="c1">//////////////////////////////////////////////////////////</span>
<span class="linenos">1807</span>
<span class="linenos">1808</span><span class="w">    </span><span class="c1">// Progate the choices to the new lattice segment.</span>
<span class="linenos">1809</span><span class="w">    </span><span class="n">performPropagation</span><span class="p">(</span><span class="n">outLattice</span><span class="p">,</span><span class="w"> </span><span class="n">window</span><span class="p">,</span><span class="w"> </span><span class="n">choices</span><span class="p">,</span><span class="w"> </span><span class="n">latticeIndex</span><span class="p">,</span><span class="w"> </span><span class="n">windowIndex</span><span class="o">-</span><span class="n">TUNE_MPD_Y_BLOCK_X_SIZE</span><span class="p">,</span><span class="w"> </span><span class="n">windowIndex</span><span class="p">,</span><span class="w"> </span><span class="n">windowIndex</span><span class="o">+</span><span class="n">TUNE_MPD_Y_BLOCK_X_SIZE</span><span class="p">,</span><span class="w"> </span><span class="n">MPD_Y_WINDOW_SIZE</span><span class="p">,</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">);</span>
<span class="linenos">1810</span><span class="p">}</span>
<span class="linenos">1811</span>
<span class="linenos">1812</span><span class="cm">/**</span>
<span class="linenos">1813</span><span class="cm"> * Multiparticle diffusion performed by copying the lattice section to shared memory, making a choice for each lattice</span>
<span class="linenos">1814</span><span class="cm"> * site, storing the new lattice into shared memory, and then updating the global lattice.</span>
<span class="linenos">1815</span><span class="cm"> */</span>
<span class="linenos">1816</span><span class="kr">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">MGPU_z_kernel</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">inLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">inSites</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">outLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">z_start</span><span class="p">)</span>
<span class="linenos">1817</span><span class="p">{</span>
<span class="linenos">1818</span><span class="w">	</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nb">blockDim</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
<span class="linenos">1819</span><span class="w">	</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
<span class="linenos">1820</span><span class="w">	</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nb">blockDim</span><span class="p">.</span><span class="n">z</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">z</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">z_start</span><span class="p">;</span>
<span class="linenos">1821</span>
<span class="linenos">1822</span><span class="w">    </span><span class="c1">// Figure out the offset of this thread in the lattice and the lattice segment.</span>
<span class="linenos">1823</span><span class="w">	</span><span class="kt">int</span><span class="w"> </span><span class="n">global_z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">z</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">goffsetZC</span><span class="p">;</span>
<span class="linenos">1824</span><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">windowZIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">z</span><span class="o">+</span><span class="n">MPD_APRON_SIZE</span><span class="p">;</span>
<span class="linenos">1825</span><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">windowIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">windowZIndex</span><span class="o">*</span><span class="nb">blockDim</span><span class="p">.</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
<span class="linenos">1826</span>
<span class="linenos">1827</span><span class="w">	</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">local_index</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">z</span><span class="p">);</span>
<span class="linenos">1828</span><span class="w">	</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">globalIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">local_to_global</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">z</span><span class="p">);</span><span class="w"> </span><span class="c1">// Use the global lattice index for RNG</span>
<span class="linenos">1829</span>
<span class="linenos">1830</span><span class="w">    </span><span class="c1">///////////////////////////////////////////</span>
<span class="linenos">1831</span><span class="w">    </span><span class="c1">// Load the lattice into shared memory. //</span>
<span class="linenos">1832</span><span class="w">    </span><span class="c1">///////////////////////////////////////////</span>
<span class="linenos">1833</span>
<span class="linenos">1834</span><span class="w">    </span><span class="c1">// Shared memory to store the lattice segment. Each lattice site has four particles, eight bits for each particle.</span>
<span class="linenos">1835</span><span class="w">    </span><span class="kt">__shared__</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">window</span><span class="p">[</span><span class="n">MPD_Z_WINDOW_SIZE</span><span class="o">*</span><span class="n">MPD_WORDS_PER_SITE</span><span class="p">];</span>
<span class="linenos">1836</span><span class="w">    </span><span class="kt">__shared__</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">sitesWindow</span><span class="p">[</span><span class="n">MPD_Z_WINDOW_SIZE</span><span class="p">];</span>
<span class="linenos">1837</span>
<span class="linenos">1838</span><span class="w">    </span><span class="c1">// Copy the x window from device memory into shared memory.</span>
<span class="linenos">1839</span><span class="w">    </span><span class="n">copyZWindowFromLattice_MGPU</span><span class="p">(</span><span class="n">inLattice</span><span class="p">,</span><span class="w"> </span><span class="n">window</span><span class="p">,</span><span class="w"> </span><span class="n">latticeIndex</span><span class="p">,</span><span class="w"> </span><span class="n">global_z</span><span class="p">,</span><span class="w"> </span><span class="n">windowIndex</span><span class="p">,</span><span class="w"> </span><span class="n">windowZIndex</span><span class="p">);</span>
<span class="linenos">1840</span><span class="w">    </span><span class="n">copyZWindowFromSites_MGPU</span><span class="p">(</span><span class="n">inSites</span><span class="p">,</span><span class="w"> </span><span class="n">sitesWindow</span><span class="p">,</span><span class="w"> </span><span class="n">latticeIndex</span><span class="p">,</span><span class="w"> </span><span class="n">global_z</span><span class="p">,</span><span class="w"> </span><span class="n">windowIndex</span><span class="p">,</span><span class="w"> </span><span class="n">windowZIndex</span><span class="p">);</span>
<span class="linenos">1841</span><span class="w">    </span><span class="nf">__syncthreads</span><span class="p">();</span>
<span class="linenos">1842</span>
<span class="linenos">1843</span><span class="w">    </span><span class="c1">////////////////////////////////////////</span>
<span class="linenos">1844</span><span class="w">    </span><span class="c1">// Make the choice for each particle. //</span>
<span class="linenos">1845</span><span class="w">    </span><span class="c1">////////////////////////////////////////</span>
<span class="linenos">1846</span>
<span class="linenos">1847</span><span class="w">    </span><span class="kt">__shared__</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">choices</span><span class="p">[</span><span class="n">MPD_Z_WINDOW_SIZE</span><span class="o">*</span><span class="n">MPD_WORDS_PER_SITE</span><span class="p">];</span>
<span class="linenos">1848</span>
<span class="linenos">1849</span><span class="w">    </span><span class="c1">// Make the choices.</span>
<span class="linenos">1850</span><span class="w">    </span><span class="n">makeZDiffusionChoices</span><span class="p">(</span><span class="n">window</span><span class="p">,</span><span class="w"> </span><span class="n">sitesWindow</span><span class="p">,</span><span class="w"> </span><span class="n">choices</span><span class="p">,</span><span class="w"> </span><span class="n">globalIndex</span><span class="p">,</span><span class="w"> </span><span class="n">global_z</span><span class="p">,</span><span class="w"> </span><span class="n">windowIndex</span><span class="p">,</span><span class="w"> </span><span class="n">windowZIndex</span><span class="p">,</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">);</span>
<span class="linenos">1851</span><span class="w">	</span><span class="nf">__syncthreads</span><span class="p">();</span>
<span class="linenos">1852</span>
<span class="linenos">1853</span><span class="w">    </span><span class="c1">//////////////////////////////////////////////////////////</span>
<span class="linenos">1854</span><span class="w">    </span><span class="c1">// Create version of the lattice at the next time step. //</span>
<span class="linenos">1855</span><span class="w">    </span><span class="c1">//////////////////////////////////////////////////////////</span>
<span class="linenos">1856</span>
<span class="linenos">1857</span><span class="w">    </span><span class="c1">// Progate the choices to the new lattice segment.</span>
<span class="linenos">1858</span><span class="w">    </span><span class="n">performPropagation</span><span class="p">(</span><span class="n">outLattice</span><span class="p">,</span><span class="w"> </span><span class="n">window</span><span class="p">,</span><span class="w"> </span><span class="n">choices</span><span class="p">,</span><span class="w"> </span><span class="n">latticeIndex</span><span class="p">,</span><span class="w"> </span><span class="n">windowIndex</span><span class="o">-</span><span class="n">TUNE_MPD_Z_BLOCK_X_SIZE</span><span class="p">,</span><span class="w"> </span><span class="n">windowIndex</span><span class="p">,</span><span class="w"> </span><span class="n">windowIndex</span><span class="o">+</span><span class="n">TUNE_MPD_Z_BLOCK_X_SIZE</span><span class="p">,</span><span class="w"> </span><span class="n">MPD_Z_WINDOW_SIZE</span><span class="p">,</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">);</span>
<span class="linenos">1859</span><span class="p">}</span>
<span class="linenos">1860</span>
<span class="linenos">1861</span><span class="cm">/**</span>
<span class="linenos">1862</span><span class="cm"> * Multiparticle diffusion performed by copying the lattice section to shared memory, making a choice for each lattice</span>
<span class="linenos">1863</span><span class="cm"> * site, storing the new lattice into shared memory, and then updating the global lattice.</span>
<span class="linenos">1864</span><span class="cm"> */</span>
<span class="linenos">1865</span><span class="cp">#ifdef MPD_GLOBAL_S_MATRIX</span>
<span class="linenos">1866</span><span class="cp">#ifdef MPD_GLOBAL_R_MATRIX</span>
<span class="linenos">1867</span><span class="kr">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">MGPU_reaction_kernel</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">inLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">inSites</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">outLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">z_start</span><span class="p">,</span><span class="w">   </span><span class="k">const</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="kt">int8_t</span><span class="w"> </span><span class="o">*</span><span class="n">SG</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="n">RLG</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="n">reactionOrdersG</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="n">reactionSitesG</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="n">D1G</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="n">D2G</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="n">reactionRatesG</span><span class="p">)</span>
<span class="linenos">1868</span><span class="cp">#else</span>
<span class="linenos">1869</span><span class="kr">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">MGPU_reaction_kernel</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">inLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">inSites</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">outLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">z_start</span><span class="p">,</span><span class="w">   </span><span class="k">const</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="kt">int8_t</span><span class="w"> </span><span class="o">*</span><span class="n">SG</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="n">RLG</span><span class="p">)</span>
<span class="linenos">1870</span><span class="cp">#endif</span>
<span class="linenos">1871</span><span class="cp">#else</span>
<span class="linenos">1872</span><span class="kr">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">MGPU_reaction_kernel</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">inLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">inSites</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">outLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">z_start</span><span class="p">)</span>
<span class="linenos">1873</span><span class="cp">#endif</span>
<span class="linenos">1874</span><span class="p">{</span>
<span class="linenos">1875</span><span class="w">	</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">blockDim</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
<span class="linenos">1876</span><span class="w">	</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">blockDim</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
<span class="linenos">1877</span><span class="w">	</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">z</span><span class="o">+</span><span class="n">z_start</span><span class="p">;</span>
<span class="linenos">1878</span>
<span class="linenos">1879</span><span class="w">    </span><span class="c1">// Figure out the offset of this thread in the lattice and the lattice segment.</span>
<span class="linenos">1880</span><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">local_index</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">z</span><span class="p">);</span>
<span class="linenos">1881</span><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">globalIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">local_to_global</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">z</span><span class="p">);</span><span class="w"> </span><span class="c1">// Use the global lattice index for RNG</span>
<span class="linenos">1882</span>
<span class="linenos">1883</span><span class="w">    </span><span class="c1">///////////////////////////////////////////</span>
<span class="linenos">1884</span><span class="w">    </span><span class="c1">// Load the particles and site.          //</span>
<span class="linenos">1885</span><span class="w">    </span><span class="c1">///////////////////////////////////////////</span>
<span class="linenos">1886</span>
<span class="linenos">1887</span><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">particles</span><span class="p">[</span><span class="n">MPD_WORDS_PER_SITE</span><span class="p">];</span>
<span class="linenos">1888</span><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">w</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">latticeOffset</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">w</span><span class="o">&lt;</span><span class="n">MPD_WORDS_PER_SITE</span><span class="p">;</span><span class="w"> </span><span class="n">w</span><span class="o">++</span><span class="p">,</span><span class="w"> </span><span class="n">latticeOffset</span><span class="o">+=</span><span class="n">latticeXYZSizeC</span><span class="p">)</span>
<span class="linenos">1889</span><span class="w">        </span><span class="n">particles</span><span class="p">[</span><span class="n">w</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inLattice</span><span class="p">[</span><span class="n">latticeIndex</span><span class="o">+</span><span class="n">latticeOffset</span><span class="p">];</span>
<span class="linenos">1890</span><span class="w">    </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">siteType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inSites</span><span class="p">[</span><span class="n">latticeIndex</span><span class="p">];</span>
<span class="linenos">1891</span>
<span class="linenos">1892</span><span class="w">    </span><span class="c1">////////////////////////////////////////</span>
<span class="linenos">1893</span><span class="w">    </span><span class="c1">// Perform the reactions.             //</span>
<span class="linenos">1894</span><span class="w">    </span><span class="c1">////////////////////////////////////////</span>
<span class="linenos">1895</span>
<span class="linenos">1896</span><span class="w">    </span><span class="c1">// Calculate the kinetic rate for each reaction at this site.</span>
<span class="linenos">1897</span><span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">totalReactionPropensity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">;</span>
<span class="linenos">1898</span><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">numberReactionsC</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">1899</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">1900</span><span class="cp">#ifdef MPD_GLOBAL_S_MATRIX</span>
<span class="linenos">1901</span><span class="cp">#ifdef MPD_GLOBAL_R_MATRIX</span>
<span class="linenos">1902</span><span class="w">        </span><span class="n">totalReactionPropensity</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">calculateReactionPropensity</span><span class="p">(</span><span class="n">siteType</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">uint32_t</span><span class="o">*</span><span class="p">)</span><span class="n">particles</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">RLG</span><span class="p">,</span><span class="w"> </span><span class="n">reactionOrdersG</span><span class="p">,</span><span class="w"> </span><span class="n">reactionSitesG</span><span class="p">,</span><span class="w"> </span><span class="n">D1G</span><span class="p">,</span><span class="w"> </span><span class="n">D2G</span><span class="p">,</span><span class="w"> </span><span class="n">reactionRatesG</span><span class="p">);</span>
<span class="linenos">1903</span><span class="cp">#else</span>
<span class="linenos">1904</span><span class="w">        </span><span class="n">totalReactionPropensity</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">calculateReactionPropensity</span><span class="p">(</span><span class="n">siteType</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">uint32_t</span><span class="o">*</span><span class="p">)</span><span class="n">particles</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">RLG</span><span class="p">);</span>
<span class="linenos">1905</span><span class="cp">#endif</span>
<span class="linenos">1906</span><span class="cp">#else</span>
<span class="linenos">1907</span><span class="w">        </span><span class="n">totalReactionPropensity</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">calculateReactionPropensity</span><span class="p">(</span><span class="n">siteType</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">uint32_t</span><span class="o">*</span><span class="p">)</span><span class="n">particles</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">);</span>
<span class="linenos">1908</span><span class="cp">#endif</span>
<span class="linenos">1909</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">1910</span>
<span class="linenos">1911</span>
<span class="linenos">1912</span><span class="w">    </span><span class="c1">// See if a reaction occurred at the site.</span>
<span class="linenos">1913</span><span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">reactionProbability</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">calculateReactionProbability</span><span class="p">(</span><span class="n">totalReactionPropensity</span><span class="p">);</span>
<span class="linenos">1914</span><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">reactionOccurred</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">checkForReaction</span><span class="p">(</span><span class="n">globalIndex</span><span class="p">,</span><span class="w"> </span><span class="n">reactionProbability</span><span class="p">,</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">);</span>
<span class="linenos">1915</span>
<span class="linenos">1916</span><span class="w">    </span><span class="c1">// If there was a reaction, process it.</span>
<span class="linenos">1917</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">reactionOccurred</span><span class="p">)</span>
<span class="linenos">1918</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">1919</span><span class="w">        </span><span class="c1">// Figure out which reaction occurred.</span>
<span class="linenos">1920</span><span class="cp">#ifdef MPD_GLOBAL_S_MATRIX</span>
<span class="linenos">1921</span><span class="cp">#ifdef MPD_GLOBAL_R_MATRIX</span>
<span class="linenos">1922</span><span class="w">        </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">reactionIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">determineReactionIndex</span><span class="p">(</span><span class="n">siteType</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">uint32_t</span><span class="o">*</span><span class="p">)</span><span class="n">particles</span><span class="p">,</span><span class="w"> </span><span class="n">globalIndex</span><span class="p">,</span><span class="w"> </span><span class="n">totalReactionPropensity</span><span class="p">,</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">,</span><span class="w"> </span><span class="n">RLG</span><span class="p">,</span><span class="w"> </span><span class="n">reactionOrdersG</span><span class="p">,</span><span class="w"> </span><span class="n">reactionSitesG</span><span class="p">,</span><span class="w"> </span><span class="n">D1G</span><span class="p">,</span><span class="w"> </span><span class="n">D2G</span><span class="p">,</span><span class="w"> </span><span class="n">reactionRatesG</span><span class="p">);</span>
<span class="linenos">1923</span><span class="cp">#else</span>
<span class="linenos">1924</span><span class="w">        </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">reactionIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">determineReactionIndex</span><span class="p">(</span><span class="n">siteType</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">uint32_t</span><span class="o">*</span><span class="p">)</span><span class="n">particles</span><span class="p">,</span><span class="w"> </span><span class="n">globalIndex</span><span class="p">,</span><span class="w"> </span><span class="n">totalReactionPropensity</span><span class="p">,</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">,</span><span class="w"> </span><span class="n">RLG</span><span class="p">);</span>
<span class="linenos">1925</span><span class="cp">#endif</span>
<span class="linenos">1926</span><span class="cp">#else</span>
<span class="linenos">1927</span><span class="w">        </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">reactionIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">determineReactionIndex</span><span class="p">(</span><span class="n">siteType</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">uint32_t</span><span class="o">*</span><span class="p">)</span><span class="n">particles</span><span class="p">,</span><span class="w"> </span><span class="n">globalIndex</span><span class="p">,</span><span class="w"> </span><span class="n">totalReactionPropensity</span><span class="p">,</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">);</span>
<span class="linenos">1928</span><span class="cp">#endif</span>
<span class="linenos">1929</span>
<span class="linenos">1930</span><span class="w">        </span><span class="c1">// Construct the new site.</span>
<span class="linenos">1931</span><span class="cp">#ifdef MPD_GLOBAL_S_MATRIX</span>
<span class="linenos">1932</span><span class="w">        </span><span class="n">evaluateReaction</span><span class="p">(</span><span class="n">latticeIndex</span><span class="p">,</span><span class="w"> </span><span class="n">siteType</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">uint32_t</span><span class="o">*</span><span class="p">)</span><span class="n">particles</span><span class="p">,</span><span class="w"> </span><span class="n">reactionIndex</span><span class="p">,</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">,</span><span class="w"> </span><span class="n">SG</span><span class="p">);</span>
<span class="linenos">1933</span><span class="cp">#else</span>
<span class="linenos">1934</span><span class="w">        </span><span class="n">evaluateReaction</span><span class="p">(</span><span class="n">latticeIndex</span><span class="p">,</span><span class="w"> </span><span class="n">siteType</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">uint32_t</span><span class="o">*</span><span class="p">)</span><span class="n">particles</span><span class="p">,</span><span class="w"> </span><span class="n">reactionIndex</span><span class="p">,</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">);</span>
<span class="linenos">1935</span><span class="cp">#endif</span>
<span class="linenos">1936</span>
<span class="linenos">1937</span><span class="w">        </span><span class="c1">// Copy the new particles back into the lattice.</span>
<span class="linenos">1938</span><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">w</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">latticeOffset</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">w</span><span class="o">&lt;</span><span class="n">MPD_WORDS_PER_SITE</span><span class="p">;</span><span class="w"> </span><span class="n">w</span><span class="o">++</span><span class="p">,</span><span class="w"> </span><span class="n">latticeOffset</span><span class="o">+=</span><span class="n">latticeXYZSizeC</span><span class="p">)</span>
<span class="linenos">1939</span><span class="w">             </span><span class="n">outLattice</span><span class="p">[</span><span class="n">latticeIndex</span><span class="o">+</span><span class="n">latticeOffset</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">particles</span><span class="p">[</span><span class="n">w</span><span class="p">];</span>
<span class="linenos">1940</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">1941</span><span class="p">}</span>
<span class="linenos">1942</span>
<span class="linenos">1943</span><span class="cp">#ifdef MPD_GLOBAL_S_MATRIX</span>
<span class="linenos">1944</span><span class="cp">#ifdef MPD_GLOBAL_R_MATRIX</span>
<span class="linenos">1945</span><span class="kr">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">__launch_bounds__</span><span class="p">(</span><span class="n">TUNE_MPD_REACTION_BLOCK_X_SIZE</span><span class="o">*</span><span class="n">TUNE_MPD_REACTION_BLOCK_Y_SIZE</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="n">MGPU_precomp_reaction_kernel</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">inLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">inSites</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">outLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">z_start</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="kt">int8_t</span><span class="w"> </span><span class="o">*</span><span class="n">SG</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="n">RLG</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="n">reactionOrdersG</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="n">reactionSitesG</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="n">D1G</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="n">D2G</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="n">reactionRatesG</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="n">qp0</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="n">qp1</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="n">qp2</span><span class="p">)</span>
<span class="linenos">1946</span><span class="cp">#else</span>
<span class="linenos">1947</span><span class="kr">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">__launch_bounds__</span><span class="p">(</span><span class="n">TUNE_MPD_REACTION_BLOCK_X_SIZE</span><span class="o">*</span><span class="n">TUNE_MPD_REACTION_BLOCK_Y_SIZE</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="n">MGPU_precomp_reaction_kernel</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">inLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">inSites</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">outLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">z_start</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="kt">int8_t</span><span class="w"> </span><span class="o">*</span><span class="n">SG</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="n">RLG</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="n">qp0</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="n">qp1</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="n">qp2</span><span class="p">)</span>
<span class="linenos">1948</span><span class="cp">#endif</span>
<span class="linenos">1949</span><span class="cp">#else</span>
<span class="linenos">1950</span><span class="kr">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">__launch_bounds__</span><span class="p">(</span><span class="n">TUNE_MPD_REACTION_BLOCK_X_SIZE</span><span class="o">*</span><span class="n">TUNE_MPD_REACTION_BLOCK_Y_SIZE</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="n">MGPU_precomp_reaction_kernel</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">inLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">inSites</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">outLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">z_start</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="n">qp0</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="n">qp1</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="n">qp2</span><span class="p">)</span>
<span class="linenos">1951</span><span class="cp">#endif</span>
<span class="linenos">1952</span><span class="p">{</span>
<span class="linenos">1953</span><span class="w">	</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">blockDim</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
<span class="linenos">1954</span><span class="w">	</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">blockDim</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
<span class="linenos">1955</span><span class="w">	</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">z</span><span class="o">+</span><span class="n">z_start</span><span class="p">;</span>
<span class="linenos">1956</span>
<span class="linenos">1957</span><span class="w">    </span><span class="c1">// Figure out the offset of this thread in the lattice and the lattice segment.</span>
<span class="linenos">1958</span><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">local_index</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">z</span><span class="p">);</span>
<span class="linenos">1959</span><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">globalIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">local_to_global</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">z</span><span class="p">);</span><span class="w"> </span><span class="c1">// Use the global lattice index for RNG</span>
<span class="linenos">1960</span>
<span class="linenos">1961</span><span class="w">    </span><span class="c1">///////////////////////////////////////////</span>
<span class="linenos">1962</span><span class="w">    </span><span class="c1">// Load the particles and site.          //</span>
<span class="linenos">1963</span><span class="w">    </span><span class="c1">///////////////////////////////////////////</span>
<span class="linenos">1964</span>
<span class="linenos">1965</span><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">particles</span><span class="p">[</span><span class="n">MPD_WORDS_PER_SITE</span><span class="p">];</span>
<span class="linenos">1966</span><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">w</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">latticeOffset</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">w</span><span class="o">&lt;</span><span class="n">MPD_WORDS_PER_SITE</span><span class="p">;</span><span class="w"> </span><span class="n">w</span><span class="o">++</span><span class="p">,</span><span class="w"> </span><span class="n">latticeOffset</span><span class="o">+=</span><span class="n">latticeXYZSizeC</span><span class="p">)</span>
<span class="linenos">1967</span><span class="w">        </span><span class="n">particles</span><span class="p">[</span><span class="n">w</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inLattice</span><span class="p">[</span><span class="n">latticeIndex</span><span class="o">+</span><span class="n">latticeOffset</span><span class="p">];</span>
<span class="linenos">1968</span><span class="w">    </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">siteType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inSites</span><span class="p">[</span><span class="n">latticeIndex</span><span class="p">];</span>
<span class="linenos">1969</span>
<span class="linenos">1970</span><span class="w">    </span><span class="c1">////////////////////////////////////////</span>
<span class="linenos">1971</span><span class="w">    </span><span class="c1">// Perform the reactions.             //</span>
<span class="linenos">1972</span><span class="w">    </span><span class="c1">////////////////////////////////////////</span>
<span class="linenos">1973</span>
<span class="linenos">1974</span><span class="w">    </span><span class="c1">// Calculate the kinetic rate for each reaction at this site.</span>
<span class="linenos">1975</span><span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">totalReactionPropensity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_element</span><span class="p">(</span><span class="n">qp0</span><span class="p">,</span><span class="n">siteType</span><span class="p">);</span>
<span class="linenos">1976</span><span class="w">    </span><span class="c1">//float totalReactionPropensity = qp0[siteType];</span>
<span class="linenos">1977</span><span class="w">	</span><span class="k">for</span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">MPD_PARTICLES_PER_SITE</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">1978</span><span class="w">	</span><span class="p">{</span>
<span class="linenos">1979</span><span class="w">		</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">p1</span><span class="o">=</span><span class="p">((</span><span class="kt">uint32_t</span><span class="o">*</span><span class="p">)</span><span class="n">particles</span><span class="p">)[</span><span class="n">i</span><span class="p">];</span>
<span class="linenos">1980</span><span class="w">		</span><span class="k">if</span><span class="p">(</span><span class="n">p1</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">1981</span><span class="w">		</span><span class="p">{</span>
<span class="linenos">1982</span><span class="w">			</span><span class="n">totalReactionPropensity</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">read_element</span><span class="p">(</span><span class="n">qp1</span><span class="p">,(</span><span class="n">siteType</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">numberSpeciesC</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">p1</span><span class="mi">-1</span><span class="p">)));</span>
<span class="linenos">1983</span><span class="w">			</span><span class="c1">//totalReactionPropensity += qp1[(siteType * numberSpeciesC + (p1-1))];</span>
<span class="linenos">1984</span><span class="w">			</span><span class="k">for</span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">j</span><span class="o">=</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">&lt;</span><span class="n">MPD_PARTICLES_PER_SITE</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">1985</span><span class="w">			</span><span class="p">{</span>
<span class="linenos">1986</span><span class="w">				</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">p2</span><span class="o">=</span><span class="p">((</span><span class="kt">uint32_t</span><span class="o">*</span><span class="p">)</span><span class="n">particles</span><span class="p">)[</span><span class="n">j</span><span class="p">];</span>
<span class="linenos">1987</span><span class="w">				</span><span class="k">if</span><span class="p">(</span><span class="n">p2</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">1988</span><span class="w">				</span><span class="p">{</span>
<span class="linenos">1989</span><span class="w">					</span><span class="n">totalReactionPropensity</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">read_element</span><span class="p">(</span><span class="n">qp2</span><span class="p">,</span><span class="n">siteType</span><span class="o">*</span><span class="n">numberSpeciesC</span><span class="o">*</span><span class="n">numberSpeciesC</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">p1</span><span class="mi">-1</span><span class="p">)</span><span class="o">*</span><span class="n">numberSpeciesC</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">p2</span><span class="mi">-1</span><span class="p">));</span>
<span class="linenos">1990</span><span class="w">					</span><span class="c1">//totalReactionPropensity += qp2[siteType*numberSpeciesC*numberSpeciesC + (p1-1)*numberSpeciesC + (p2-1)];</span>
<span class="linenos">1991</span><span class="w">				</span><span class="p">}</span>
<span class="linenos">1992</span><span class="w">			</span><span class="p">}</span>
<span class="linenos">1993</span><span class="w">		</span><span class="p">}</span>
<span class="linenos">1994</span><span class="w">	</span><span class="p">}</span>
<span class="linenos">1995</span>
<span class="linenos">1996</span>
<span class="linenos">1997</span><span class="w">	</span><span class="c1">// If propensity is zero, no reaction can occur.</span>
<span class="linenos">1998</span><span class="w">	</span><span class="k">if</span><span class="p">(</span><span class="n">totalReactionPropensity</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">)</span>
<span class="linenos">1999</span><span class="w">		</span><span class="k">return</span><span class="p">;</span>
<span class="linenos">2000</span>
<span class="linenos">2001</span><span class="w">    </span><span class="c1">// See if a reaction occurred at the site.</span>
<span class="linenos">2002</span><span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">reactionProbability</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">calculateReactionProbability</span><span class="p">(</span><span class="n">totalReactionPropensity</span><span class="p">);</span>
<span class="linenos">2003</span><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">reactionOccurred</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">checkForReaction</span><span class="p">(</span><span class="n">globalIndex</span><span class="p">,</span><span class="w"> </span><span class="n">reactionProbability</span><span class="p">,</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">);</span>
<span class="linenos">2004</span>
<span class="linenos">2005</span><span class="w">    </span><span class="c1">// If there was a reaction, process it.</span>
<span class="linenos">2006</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">reactionOccurred</span><span class="p">)</span>
<span class="linenos">2007</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">2008</span><span class="w">        </span><span class="c1">// Figure out which reaction occurred.</span>
<span class="linenos">2009</span><span class="cp">#ifdef MPD_GLOBAL_S_MATRIX</span>
<span class="linenos">2010</span><span class="cp">#ifdef MPD_GLOBAL_R_MATRIX</span>
<span class="linenos">2011</span><span class="w">        </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">reactionIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">determineReactionIndex</span><span class="p">(</span><span class="n">siteType</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">uint32_t</span><span class="o">*</span><span class="p">)</span><span class="n">particles</span><span class="p">,</span><span class="w"> </span><span class="n">globalIndex</span><span class="p">,</span><span class="w"> </span><span class="n">totalReactionPropensity</span><span class="p">,</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">,</span><span class="w"> </span><span class="n">RLG</span><span class="p">,</span><span class="w"> </span><span class="n">reactionOrdersG</span><span class="p">,</span><span class="w"> </span><span class="n">reactionSitesG</span><span class="p">,</span><span class="w"> </span><span class="n">D1G</span><span class="p">,</span><span class="w"> </span><span class="n">D2G</span><span class="p">,</span><span class="w"> </span><span class="n">reactionRatesG</span><span class="p">);</span>
<span class="linenos">2012</span><span class="cp">#else</span>
<span class="linenos">2013</span><span class="w">        </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">reactionIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">determineReactionIndex</span><span class="p">(</span><span class="n">siteType</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">uint32_t</span><span class="o">*</span><span class="p">)</span><span class="n">particles</span><span class="p">,</span><span class="w"> </span><span class="n">globalIndex</span><span class="p">,</span><span class="w"> </span><span class="n">totalReactionPropensity</span><span class="p">,</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">,</span><span class="w"> </span><span class="n">RLG</span><span class="p">);</span>
<span class="linenos">2014</span><span class="cp">#endif</span>
<span class="linenos">2015</span><span class="cp">#else</span>
<span class="linenos">2016</span><span class="w">        </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">reactionIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">determineReactionIndex</span><span class="p">(</span><span class="n">siteType</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">uint32_t</span><span class="o">*</span><span class="p">)</span><span class="n">particles</span><span class="p">,</span><span class="w"> </span><span class="n">globalIndex</span><span class="p">,</span><span class="w"> </span><span class="n">totalReactionPropensity</span><span class="p">,</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">);</span>
<span class="linenos">2017</span><span class="cp">#endif</span>
<span class="linenos">2018</span>
<span class="linenos">2019</span><span class="w">        </span><span class="c1">// Construct the new site.</span>
<span class="linenos">2020</span><span class="cp">#ifdef MPD_GLOBAL_S_MATRIX</span>
<span class="linenos">2021</span><span class="w">        </span><span class="n">evaluateReaction</span><span class="p">(</span><span class="n">latticeIndex</span><span class="p">,</span><span class="w"> </span><span class="n">siteType</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">uint32_t</span><span class="o">*</span><span class="p">)</span><span class="n">particles</span><span class="p">,</span><span class="w"> </span><span class="n">reactionIndex</span><span class="p">,</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">,</span><span class="w"> </span><span class="n">SG</span><span class="p">);</span>
<span class="linenos">2022</span><span class="cp">#else</span>
<span class="linenos">2023</span><span class="w">        </span><span class="n">evaluateReaction</span><span class="p">(</span><span class="n">latticeIndex</span><span class="p">,</span><span class="w"> </span><span class="n">siteType</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">uint32_t</span><span class="o">*</span><span class="p">)</span><span class="n">particles</span><span class="p">,</span><span class="w"> </span><span class="n">reactionIndex</span><span class="p">,</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">);</span>
<span class="linenos">2024</span><span class="cp">#endif</span>
<span class="linenos">2025</span>
<span class="linenos">2026</span><span class="w">        </span><span class="c1">// Copy the new particles back into the lattice.</span>
<span class="linenos">2027</span><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">w</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">latticeOffset</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">w</span><span class="o">&lt;</span><span class="n">MPD_WORDS_PER_SITE</span><span class="p">;</span><span class="w"> </span><span class="n">w</span><span class="o">++</span><span class="p">,</span><span class="w"> </span><span class="n">latticeOffset</span><span class="o">+=</span><span class="n">latticeXYZSizeC</span><span class="p">)</span>
<span class="linenos">2028</span><span class="w">             </span><span class="n">outLattice</span><span class="p">[</span><span class="n">latticeIndex</span><span class="o">+</span><span class="n">latticeOffset</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">particles</span><span class="p">[</span><span class="n">w</span><span class="p">];</span>
<span class="linenos">2029</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">2030</span><span class="p">}</span>
<span class="linenos">2031</span>
<span class="linenos">2032</span><span class="kr">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">correct_overflows_mgpu</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">lattice</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">)</span>
<span class="linenos">2033</span><span class="p">{</span>
<span class="linenos">2034</span><span class="w">	</span><span class="c1">// Remember: #define MPD_OVERFLOW_LIST_SIZE       1+2*TUNE_MPD_MAX_PARTICLE_OVERFLOWS*sizeof(uint32_t)</span>
<span class="linenos">2035</span><span class="w">	</span><span class="c1">// Requirement: one block with TUNE_MPD_MAX_PARTICLE_OVERFLOWS threads</span>
<span class="linenos">2036</span><span class="w">	</span>
<span class="linenos">2037</span><span class="w">	</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
<span class="linenos">2038</span><span class="w">	</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">total</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="linenos">2039</span>
<span class="linenos">2040</span><span class="w">	</span><span class="kt">__shared__</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">indexes</span><span class="p">[</span><span class="n">TUNE_MPD_MAX_PARTICLE_OVERFLOWS</span><span class="p">];</span>
<span class="linenos">2041</span><span class="w">	</span><span class="kt">__shared__</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">maxround</span><span class="p">;</span>
<span class="linenos">2042</span>
<span class="linenos">2043</span><span class="w">	</span><span class="c1">// Do I have an overflow to look at?</span>
<span class="linenos">2044</span><span class="w">	</span><span class="k">if</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">total</span><span class="p">)</span>
<span class="linenos">2045</span><span class="w">		</span><span class="k">return</span><span class="p">;</span>
<span class="linenos">2046</span>
<span class="linenos">2047</span><span class="w">	</span><span class="c1">// Abort if overflows have overflown</span>
<span class="linenos">2048</span><span class="w">	</span><span class="k">if</span><span class="p">(</span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="n">assert</span><span class="p">(</span><span class="n">total</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">TUNE_MPD_MAX_PARTICLE_OVERFLOWS</span><span class="p">);</span>
<span class="linenos">2049</span>
<span class="linenos">2050</span><span class="w">	</span><span class="c1">// load our index</span>
<span class="linenos">2051</span><span class="w">	</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">latticeIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">[(</span><span class="n">i</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
<span class="linenos">2052</span><span class="w">	</span><span class="n">particle_t</span><span class="w"> </span><span class="n">particle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">[(</span><span class="n">i</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="mi">2</span><span class="p">];</span>
<span class="linenos">2053</span>
<span class="linenos">2054</span><span class="w">	</span><span class="n">indexes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">latticeIndex</span><span class="p">;</span>
<span class="linenos">2055</span>
<span class="linenos">2056</span><span class="w">	</span><span class="c1">// zero out list</span>
<span class="linenos">2057</span><span class="w">	</span><span class="n">maxround</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">2058</span><span class="w">	</span><span class="nf">__syncthreads</span><span class="p">();</span>
<span class="linenos">2059</span><span class="w">	</span><span class="n">siteOverflowList</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">2060</span>
<span class="linenos">2061</span><span class="w">	</span><span class="c1">// Discover which round I should go in.  To prevent situations where two threads</span>
<span class="linenos">2062</span><span class="w">	</span><span class="c1">// will try and add a particle to the same site at the same time, and thus</span>
<span class="linenos">2063</span><span class="w">	</span><span class="c1">// negating the others, each thread determines what round it is allowed to make</span>
<span class="linenos">2064</span><span class="w">	</span><span class="c1">// edits in, by determining how many previous overflows are occuring at the </span>
<span class="linenos">2065</span><span class="w">	</span><span class="c1">// same index.</span>
<span class="linenos">2066</span><span class="w">	</span><span class="kt">int</span><span class="w"> </span><span class="n">round</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">2067</span><span class="w">	</span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">i</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">2068</span><span class="w">	</span><span class="p">{</span>
<span class="linenos">2069</span><span class="w">		</span><span class="k">if</span><span class="p">(</span><span class="n">indexes</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">latticeIndex</span><span class="p">)</span>
<span class="linenos">2070</span><span class="w">			</span><span class="n">round</span><span class="o">++</span><span class="p">;</span>
<span class="linenos">2071</span><span class="w">	</span><span class="p">}</span>
<span class="linenos">2072</span><span class="w">	</span><span class="n">atomicMax</span><span class="p">(</span><span class="o">&amp;</span><span class="n">maxround</span><span class="p">,</span><span class="w"> </span><span class="n">round</span><span class="p">);</span>
<span class="linenos">2073</span><span class="w">	</span><span class="nf">__syncthreads</span><span class="p">();</span>
<span class="linenos">2074</span>
<span class="linenos">2075</span><span class="w">	</span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">r</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">maxround</span><span class="p">;</span><span class="w"> </span><span class="n">r</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">2076</span><span class="w">	</span><span class="p">{</span>
<span class="linenos">2077</span><span class="w">		</span><span class="k">if</span><span class="p">(</span><span class="n">round</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">r</span><span class="p">)</span>
<span class="linenos">2078</span><span class="w">		</span><span class="p">{</span>
<span class="linenos">2079</span><span class="w">			</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">particles</span><span class="p">[</span><span class="n">MPD_WORDS_PER_SITE</span><span class="p">];</span>
<span class="linenos">2080</span><span class="w">			</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">w</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">latticeOffset</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">w</span><span class="o">&lt;</span><span class="n">MPD_WORDS_PER_SITE</span><span class="p">;</span><span class="w"> </span><span class="n">w</span><span class="o">++</span><span class="p">,</span><span class="w"> </span><span class="n">latticeOffset</span><span class="o">+=</span><span class="n">latticeXYZSizeC</span><span class="p">)</span>
<span class="linenos">2081</span><span class="w">				</span><span class="n">particles</span><span class="p">[</span><span class="n">w</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lattice</span><span class="p">[</span><span class="n">latticeIndex</span><span class="o">+</span><span class="n">latticeOffset</span><span class="p">];</span>
<span class="linenos">2082</span><span class="w">			</span>
<span class="linenos">2083</span><span class="w">			</span><span class="kt">uint32_t</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="o">=</span><span class="p">(</span><span class="kt">uint32_t</span><span class="o">*</span><span class="p">)</span><span class="n">particles</span><span class="p">;</span>
<span class="linenos">2084</span><span class="w">			</span><span class="kt">int</span><span class="w"> </span><span class="n">ok</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">2085</span><span class="w">			</span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">pi</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">pi</span><span class="o">&lt;</span><span class="n">MPD_PARTICLES_PER_SITE</span><span class="p">;</span><span class="w"> </span><span class="n">pi</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">2086</span><span class="w">			</span><span class="p">{</span>
<span class="linenos">2087</span><span class="w">				</span><span class="k">if</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">pi</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">2088</span><span class="w">				</span><span class="p">{</span>
<span class="linenos">2089</span><span class="w">					</span><span class="n">p</span><span class="p">[</span><span class="n">pi</span><span class="p">]</span><span class="o">=</span><span class="n">particle</span><span class="p">;</span>
<span class="linenos">2090</span><span class="w">					</span><span class="n">ok</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
<span class="linenos">2091</span><span class="w">					</span><span class="c1">//printf(&quot;(round %d) Corrected overflow of particle %d at index %d\n&quot;, r, particle, latticeIndex);</span>
<span class="linenos">2092</span><span class="w">					</span><span class="k">break</span><span class="p">;</span>
<span class="linenos">2093</span><span class="w">				</span><span class="p">}</span>
<span class="linenos">2094</span><span class="w">			</span><span class="p">}</span>
<span class="linenos">2095</span>
<span class="linenos">2096</span><span class="w">			</span><span class="k">if</span><span class="p">(</span><span class="n">ok</span><span class="p">)</span>
<span class="linenos">2097</span><span class="w">			</span><span class="p">{</span>
<span class="linenos">2098</span><span class="w">				</span><span class="c1">// Copy the new particles back into the lattice.</span>
<span class="linenos">2099</span><span class="w">				</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">w</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">latticeOffset</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">w</span><span class="o">&lt;</span><span class="n">MPD_WORDS_PER_SITE</span><span class="p">;</span><span class="w"> </span><span class="n">w</span><span class="o">++</span><span class="p">,</span><span class="w"> </span><span class="n">latticeOffset</span><span class="o">+=</span><span class="n">latticeXYZSizeC</span><span class="p">)</span>
<span class="linenos">2100</span><span class="w">				     </span><span class="n">lattice</span><span class="p">[</span><span class="n">latticeIndex</span><span class="o">+</span><span class="n">latticeOffset</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">particles</span><span class="p">[</span><span class="n">w</span><span class="p">];</span>
<span class="linenos">2101</span><span class="w">			</span><span class="p">}</span>
<span class="linenos">2102</span><span class="w">			</span><span class="k">else</span>
<span class="linenos">2103</span><span class="w">			</span><span class="p">{</span>
<span class="linenos">2104</span><span class="w">				</span><span class="kt">int</span><span class="w"> </span><span class="n">exceptionIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">atomicAdd</span><span class="p">(</span><span class="n">siteOverflowList</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="linenos">2105</span><span class="w">				</span><span class="n">siteOverflowList</span><span class="p">[(</span><span class="n">exceptionIndex</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">latticeIndex</span><span class="p">;</span>
<span class="linenos">2106</span><span class="w">				</span><span class="n">siteOverflowList</span><span class="p">[(</span><span class="n">exceptionIndex</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">particle</span><span class="p">;</span>
<span class="linenos">2107</span><span class="w">				</span><span class="c1">//printf(&quot;(round %d) Failed to correct overflow of particle %d at index %d\n&quot;, r, particle, latticeIndex);</span>
<span class="linenos">2108</span><span class="w">			</span><span class="p">}</span>
<span class="linenos">2109</span><span class="w">		</span><span class="p">}</span>
<span class="linenos">2110</span><span class="w">		</span><span class="nf">__syncthreads</span><span class="p">();</span>
<span class="linenos">2111</span><span class="w">	</span><span class="p">}</span>
<span class="linenos">2112</span>
<span class="linenos">2113</span><span class="w">	</span><span class="c1">//if(i  == 0)</span>
<span class="linenos">2114</span><span class="w">		</span><span class="c1">//printf(&quot;%d) in: %d overflows, out: %d\n&quot;, gpuidC, total, siteOverflowList[0]);</span>
<span class="linenos">2115</span>
<span class="linenos">2116</span><span class="p">}</span>
<span class="linenos">2117</span>
<span class="linenos">2118</span><span class="cp">#ifdef MPD_GLOBAL_S_MATRIX</span>
<span class="linenos">2119</span><span class="cp">#ifdef MPD_GLOBAL_R_MATRIX</span>
<span class="linenos">2120</span><span class="kr">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">__launch_bounds__</span><span class="p">(</span><span class="n">TUNE_MPD_REACTION_BLOCK_X_SIZE</span><span class="o">*</span><span class="n">TUNE_MPD_REACTION_BLOCK_Y_SIZE</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="n">MGPU_precomp_reaction_kernel_packing</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">inLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">inSites</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">outLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">z_start</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="kt">int8_t</span><span class="w"> </span><span class="o">*</span><span class="n">SG</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="n">RLG</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="n">reactionOrdersG</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="n">reactionSitesG</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="n">D1G</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="n">D2G</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="n">reactionRatesG</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="n">qp0</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="n">qp1</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="n">qp2</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">buf_top</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">buf_bot</span><span class="p">)</span>
<span class="linenos">2121</span><span class="cp">#else</span>
<span class="linenos">2122</span><span class="kr">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">__launch_bounds__</span><span class="p">(</span><span class="n">TUNE_MPD_REACTION_BLOCK_X_SIZE</span><span class="o">*</span><span class="n">TUNE_MPD_REACTION_BLOCK_Y_SIZE</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="n">MGPU_precomp_reaction_kernel_packing</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">inLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">inSites</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">outLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">z_start</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="kt">int8_t</span><span class="w"> </span><span class="o">*</span><span class="n">SG</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="n">RLG</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="n">qp0</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="n">qp1</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="n">qp2</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">buf_top</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">buf_bot</span><span class="p">)</span>
<span class="linenos">2123</span><span class="cp">#endif</span>
<span class="linenos">2124</span><span class="cp">#else</span>
<span class="linenos">2125</span><span class="kr">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">__launch_bounds__</span><span class="p">(</span><span class="n">TUNE_MPD_REACTION_BLOCK_X_SIZE</span><span class="o">*</span><span class="n">TUNE_MPD_REACTION_BLOCK_Y_SIZE</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="n">MGPU_precomp_reaction_kernel_packing</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">inLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">inSites</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">outLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">z_start</span><span class="p">,</span><span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="n">qp0</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="n">qp1</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="kt">__restrict__</span><span class="w"> </span><span class="n">qp2</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">buf_top</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">buf_bot</span><span class="p">)</span>
<span class="linenos">2126</span><span class="cp">#endif</span>
<span class="linenos">2127</span><span class="p">{</span>
<span class="linenos">2128</span><span class="w">	</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">blockDim</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
<span class="linenos">2129</span><span class="w">	</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">blockDim</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
<span class="linenos">2130</span><span class="w">	</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">z</span><span class="o">+</span><span class="n">z_start</span><span class="p">;</span>
<span class="linenos">2131</span>
<span class="linenos">2132</span><span class="w">    </span><span class="c1">// Figure out the offset of this thread in the lattice and the lattice segment.</span>
<span class="linenos">2133</span><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">local_index</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">z</span><span class="p">);</span>
<span class="linenos">2134</span><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">globalIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">local_to_global</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">z</span><span class="p">);</span><span class="w"> </span><span class="c1">// Use the global lattice index for RNG</span>
<span class="linenos">2135</span>
<span class="linenos">2136</span><span class="w">    </span><span class="c1">///////////////////////////////////////////</span>
<span class="linenos">2137</span><span class="w">    </span><span class="c1">// Load the particles and site.          //</span>
<span class="linenos">2138</span><span class="w">    </span><span class="c1">///////////////////////////////////////////</span>
<span class="linenos">2139</span>
<span class="linenos">2140</span><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">particles</span><span class="p">[</span><span class="n">MPD_WORDS_PER_SITE</span><span class="p">];</span>
<span class="linenos">2141</span><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">w</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">latticeOffset</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">w</span><span class="o">&lt;</span><span class="n">MPD_WORDS_PER_SITE</span><span class="p">;</span><span class="w"> </span><span class="n">w</span><span class="o">++</span><span class="p">,</span><span class="w"> </span><span class="n">latticeOffset</span><span class="o">+=</span><span class="n">latticeXYZSizeC</span><span class="p">)</span>
<span class="linenos">2142</span><span class="w">        </span><span class="n">particles</span><span class="p">[</span><span class="n">w</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inLattice</span><span class="p">[</span><span class="n">latticeIndex</span><span class="o">+</span><span class="n">latticeOffset</span><span class="p">];</span>
<span class="linenos">2143</span><span class="w">    </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">siteType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inSites</span><span class="p">[</span><span class="n">latticeIndex</span><span class="p">];</span>
<span class="linenos">2144</span>
<span class="linenos">2145</span><span class="w">    </span><span class="c1">////////////////////////////////////////</span>
<span class="linenos">2146</span><span class="w">    </span><span class="c1">// Perform the reactions.             //</span>
<span class="linenos">2147</span><span class="w">    </span><span class="c1">////////////////////////////////////////</span>
<span class="linenos">2148</span>
<span class="linenos">2149</span><span class="w">    </span><span class="c1">// Calculate the kinetic rate for each reaction at this site.</span>
<span class="linenos">2150</span><span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">totalReactionPropensity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_element</span><span class="p">(</span><span class="n">qp0</span><span class="p">,</span><span class="n">siteType</span><span class="p">);</span>
<span class="linenos">2151</span><span class="w">    </span><span class="c1">//float totalReactionPropensity = qp0[siteType];</span>
<span class="linenos">2152</span><span class="w">	</span><span class="k">for</span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">MPD_PARTICLES_PER_SITE</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">2153</span><span class="w">	</span><span class="p">{</span>
<span class="linenos">2154</span><span class="w">		</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">p1</span><span class="o">=</span><span class="p">((</span><span class="kt">uint32_t</span><span class="o">*</span><span class="p">)</span><span class="n">particles</span><span class="p">)[</span><span class="n">i</span><span class="p">];</span>
<span class="linenos">2155</span><span class="w">		</span><span class="k">if</span><span class="p">(</span><span class="n">p1</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">2156</span><span class="w">		</span><span class="p">{</span>
<span class="linenos">2157</span><span class="w">			</span><span class="n">totalReactionPropensity</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">read_element</span><span class="p">(</span><span class="n">qp1</span><span class="p">,(</span><span class="n">siteType</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">numberSpeciesC</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">p1</span><span class="mi">-1</span><span class="p">)));</span>
<span class="linenos">2158</span><span class="w">			</span><span class="c1">//totalReactionPropensity += qp1[(siteType * numberSpeciesC + (p1-1))];</span>
<span class="linenos">2159</span><span class="w">			</span><span class="k">for</span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">j</span><span class="o">=</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">&lt;</span><span class="n">MPD_PARTICLES_PER_SITE</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">2160</span><span class="w">			</span><span class="p">{</span>
<span class="linenos">2161</span><span class="w">				</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">p2</span><span class="o">=</span><span class="p">((</span><span class="kt">uint32_t</span><span class="o">*</span><span class="p">)</span><span class="n">particles</span><span class="p">)[</span><span class="n">j</span><span class="p">];</span>
<span class="linenos">2162</span><span class="w">				</span><span class="k">if</span><span class="p">(</span><span class="n">p2</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">2163</span><span class="w">				</span><span class="p">{</span>
<span class="linenos">2164</span><span class="w">					</span><span class="n">totalReactionPropensity</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">read_element</span><span class="p">(</span><span class="n">qp2</span><span class="p">,</span><span class="n">siteType</span><span class="o">*</span><span class="n">numberSpeciesC</span><span class="o">*</span><span class="n">numberSpeciesC</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">p1</span><span class="mi">-1</span><span class="p">)</span><span class="o">*</span><span class="n">numberSpeciesC</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">p2</span><span class="mi">-1</span><span class="p">));</span>
<span class="linenos">2165</span><span class="w">					</span><span class="c1">//totalReactionPropensity += qp2[siteType*numberSpeciesC*numberSpeciesC + (p1-1)*numberSpeciesC + (p2-1)];</span>
<span class="linenos">2166</span><span class="w">				</span><span class="p">}</span>
<span class="linenos">2167</span><span class="w">			</span><span class="p">}</span>
<span class="linenos">2168</span><span class="w">		</span><span class="p">}</span>
<span class="linenos">2169</span><span class="w">	</span><span class="p">}</span>
<span class="linenos">2170</span>
<span class="linenos">2171</span><span class="w">	</span><span class="kt">float</span><span class="w"> </span><span class="n">reactionProbability</span><span class="p">;</span>
<span class="linenos">2172</span><span class="w">	</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">reactionOccurred</span><span class="p">;</span>
<span class="linenos">2173</span>
<span class="linenos">2174</span><span class="w">	</span><span class="c1">// If propensity is zero, no reaction can occur.</span>
<span class="linenos">2175</span><span class="w">	</span><span class="k">if</span><span class="p">(</span><span class="n">totalReactionPropensity</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">)</span>
<span class="linenos">2176</span><span class="w">		</span><span class="k">goto</span><span class="w"> </span><span class="n">letspackitup</span><span class="p">;</span>
<span class="linenos">2177</span>
<span class="linenos">2178</span><span class="w">    </span><span class="c1">// See if a reaction occurred at the site.</span>
<span class="linenos">2179</span><span class="w">    </span><span class="n">reactionProbability</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">calculateReactionProbability</span><span class="p">(</span><span class="n">totalReactionPropensity</span><span class="p">);</span>
<span class="linenos">2180</span><span class="w">    </span><span class="n">reactionOccurred</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">checkForReaction</span><span class="p">(</span><span class="n">globalIndex</span><span class="p">,</span><span class="w"> </span><span class="n">reactionProbability</span><span class="p">,</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">);</span>
<span class="linenos">2181</span>
<span class="linenos">2182</span><span class="w">    </span><span class="c1">// If there was a reaction, process it.</span>
<span class="linenos">2183</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">reactionOccurred</span><span class="p">)</span>
<span class="linenos">2184</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">2185</span><span class="w">        </span><span class="c1">// Figure out which reaction occurred.</span>
<span class="linenos">2186</span><span class="cp">#ifdef MPD_GLOBAL_S_MATRIX</span>
<span class="linenos">2187</span><span class="cp">#ifdef MPD_GLOBAL_R_MATRIX</span>
<span class="linenos">2188</span><span class="w">        </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">reactionIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">determineReactionIndex</span><span class="p">(</span><span class="n">siteType</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">uint32_t</span><span class="o">*</span><span class="p">)</span><span class="n">particles</span><span class="p">,</span><span class="w"> </span><span class="n">globalIndex</span><span class="p">,</span><span class="w"> </span><span class="n">totalReactionPropensity</span><span class="p">,</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">,</span><span class="w"> </span><span class="n">RLG</span><span class="p">,</span><span class="w"> </span><span class="n">reactionOrdersG</span><span class="p">,</span><span class="w"> </span><span class="n">reactionSitesG</span><span class="p">,</span><span class="w"> </span><span class="n">D1G</span><span class="p">,</span><span class="w"> </span><span class="n">D2G</span><span class="p">,</span><span class="w"> </span><span class="n">reactionRatesG</span><span class="p">);</span>
<span class="linenos">2189</span><span class="cp">#else</span>
<span class="linenos">2190</span><span class="w">        </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">reactionIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">determineReactionIndex</span><span class="p">(</span><span class="n">siteType</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">uint32_t</span><span class="o">*</span><span class="p">)</span><span class="n">particles</span><span class="p">,</span><span class="w"> </span><span class="n">globalIndex</span><span class="p">,</span><span class="w"> </span><span class="n">totalReactionPropensity</span><span class="p">,</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">,</span><span class="w"> </span><span class="n">RLG</span><span class="p">);</span>
<span class="linenos">2191</span><span class="cp">#endif</span>
<span class="linenos">2192</span><span class="cp">#else</span>
<span class="linenos">2193</span><span class="w">        </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">reactionIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">determineReactionIndex</span><span class="p">(</span><span class="n">siteType</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">uint32_t</span><span class="o">*</span><span class="p">)</span><span class="n">particles</span><span class="p">,</span><span class="w"> </span><span class="n">globalIndex</span><span class="p">,</span><span class="w"> </span><span class="n">totalReactionPropensity</span><span class="p">,</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">);</span>
<span class="linenos">2194</span><span class="cp">#endif</span>
<span class="linenos">2195</span>
<span class="linenos">2196</span><span class="w">        </span><span class="c1">// Construct the new site.</span>
<span class="linenos">2197</span><span class="cp">#ifdef MPD_GLOBAL_S_MATRIX</span>
<span class="linenos">2198</span><span class="w">        </span><span class="n">evaluateReaction</span><span class="p">(</span><span class="n">latticeIndex</span><span class="p">,</span><span class="w"> </span><span class="n">siteType</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">uint32_t</span><span class="o">*</span><span class="p">)</span><span class="n">particles</span><span class="p">,</span><span class="w"> </span><span class="n">reactionIndex</span><span class="p">,</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">,</span><span class="w"> </span><span class="n">SG</span><span class="p">);</span>
<span class="linenos">2199</span><span class="cp">#else</span>
<span class="linenos">2200</span><span class="w">        </span><span class="n">evaluateReaction</span><span class="p">(</span><span class="n">latticeIndex</span><span class="p">,</span><span class="w"> </span><span class="n">siteType</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">uint32_t</span><span class="o">*</span><span class="p">)</span><span class="n">particles</span><span class="p">,</span><span class="w"> </span><span class="n">reactionIndex</span><span class="p">,</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">);</span>
<span class="linenos">2201</span><span class="cp">#endif</span>
<span class="linenos">2202</span>
<span class="linenos">2203</span><span class="w">        </span><span class="c1">// Copy the new particles back into the lattice.</span>
<span class="linenos">2204</span><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">w</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">latticeOffset</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">w</span><span class="o">&lt;</span><span class="n">MPD_WORDS_PER_SITE</span><span class="p">;</span><span class="w"> </span><span class="n">w</span><span class="o">++</span><span class="p">,</span><span class="w"> </span><span class="n">latticeOffset</span><span class="o">+=</span><span class="n">latticeXYZSizeC</span><span class="p">)</span>
<span class="linenos">2205</span><span class="w">             </span><span class="n">outLattice</span><span class="p">[</span><span class="n">latticeIndex</span><span class="o">+</span><span class="n">latticeOffset</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">particles</span><span class="p">[</span><span class="n">w</span><span class="p">];</span>
<span class="linenos">2206</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">2207</span>
<span class="linenos">2208</span><span class="nl">letspackitup</span><span class="p">:</span>
<span class="linenos">2209</span>
<span class="linenos">2210</span><span class="w">	</span><span class="kt">bool</span><span class="w"> </span><span class="n">in_top_send</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">z</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="p">(</span><span class="n">top_send_z</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">top_dim_z</span><span class="p">));</span>
<span class="linenos">2211</span><span class="w">	</span><span class="kt">bool</span><span class="w"> </span><span class="n">in_bot_send</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">z</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">bot_send_z</span><span class="p">);</span>
<span class="linenos">2212</span>
<span class="linenos">2213</span><span class="cm">/*</span>
<span class="linenos">2214</span><span class="cm">	if(x == 0 &amp;&amp; y == 0 &amp;&amp; in_top_send)</span>
<span class="linenos">2215</span><span class="cm">		printf(&quot;%d, %d, %d in top send send z =%d, dim z = %d, sz=%d\n&quot;, x, y, z, top_send_z, top_dim_z, top_dim_size);</span>
<span class="linenos">2216</span><span class="cm">	if(x == 0 &amp;&amp; y == 0 &amp;&amp; in_bot_send)</span>
<span class="linenos">2217</span><span class="cm">		printf(&quot;%d, %d, %d in bot send send z =%d, dim z = %d, sz=%d\n&quot;, x, y, z, bot_send_z, bot_dim_z, bot_dim_size);</span>
<span class="linenos">2218</span><span class="cm">*/</span>
<span class="linenos">2219</span>
<span class="linenos">2220</span><span class="w">	</span><span class="k">if</span><span class="p">(</span><span class="n">in_top_send</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">buf_top</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span>
<span class="linenos">2221</span><span class="w">	</span><span class="p">{</span>
<span class="linenos">2222</span><span class="w">		</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">packidx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">y</span><span class="o">*</span><span class="n">latticeXSizeC</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">z</span><span class="o">-</span><span class="n">top_send_z</span><span class="p">)</span><span class="o">*</span><span class="n">latticeXYSizeC</span><span class="p">;</span>
<span class="linenos">2223</span><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">w</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">packOffset</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">w</span><span class="o">&lt;</span><span class="n">MPD_WORDS_PER_SITE</span><span class="p">;</span><span class="w"> </span><span class="n">w</span><span class="o">++</span><span class="p">,</span><span class="w"> </span><span class="n">packOffset</span><span class="o">+=</span><span class="n">top_dim_size</span><span class="p">)</span>
<span class="linenos">2224</span><span class="w">             </span><span class="n">buf_top</span><span class="p">[</span><span class="n">packidx</span><span class="o">+</span><span class="n">packOffset</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">particles</span><span class="p">[</span><span class="n">w</span><span class="p">];</span>
<span class="linenos">2225</span><span class="w">	</span><span class="p">}</span>
<span class="linenos">2226</span>
<span class="linenos">2227</span><span class="w">	</span><span class="k">if</span><span class="p">(</span><span class="n">in_bot_send</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">buf_bot</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span>
<span class="linenos">2228</span><span class="w">	</span><span class="p">{</span>
<span class="linenos">2229</span><span class="w">		</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">packidx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">y</span><span class="o">*</span><span class="n">latticeXSizeC</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">z</span><span class="o">-</span><span class="n">bot_send_z</span><span class="p">)</span><span class="o">*</span><span class="n">latticeXYSizeC</span><span class="p">;</span>
<span class="linenos">2230</span><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">w</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">packOffset</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">w</span><span class="o">&lt;</span><span class="n">MPD_WORDS_PER_SITE</span><span class="p">;</span><span class="w"> </span><span class="n">w</span><span class="o">++</span><span class="p">,</span><span class="w"> </span><span class="n">packOffset</span><span class="o">+=</span><span class="n">bot_dim_size</span><span class="p">)</span>
<span class="linenos">2231</span><span class="w">             </span><span class="n">buf_bot</span><span class="p">[</span><span class="n">packidx</span><span class="o">+</span><span class="n">packOffset</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">particles</span><span class="p">[</span><span class="n">w</span><span class="p">];</span>
<span class="linenos">2232</span><span class="w">	</span><span class="p">}</span>
<span class="linenos">2233</span><span class="p">}</span>
<span class="linenos">2234</span>
<span class="linenos">2235</span><span class="kr">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">MGPU_x_kernel_unpack</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">inLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">inSites</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">outLattice</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">z_start</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">buf_top</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">buf_bot</span><span class="p">)</span>
<span class="linenos">2236</span><span class="p">{</span>
<span class="linenos">2237</span><span class="w">	</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nb">blockDim</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
<span class="linenos">2238</span><span class="w">	</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nb">blockDim</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
<span class="linenos">2239</span><span class="w">	</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">z</span><span class="o">+</span><span class="n">z_start</span><span class="p">;</span>
<span class="linenos">2240</span><span class="w">	</span>
<span class="linenos">2241</span><span class="w">    </span><span class="c1">// Figure out the offset of this thread in the lattice and the lattice segment.</span>
<span class="linenos">2242</span><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeXIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="p">;</span>
<span class="linenos">2243</span><span class="w">	</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">local_index</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">z</span><span class="p">);</span>
<span class="linenos">2244</span><span class="w">	</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">globalIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">local_to_global</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">z</span><span class="p">);</span><span class="w"> </span><span class="c1">// Use the global lattice index for RNG</span>
<span class="linenos">2245</span><span class="w">	</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">windowIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="o">+</span><span class="n">MPD_APRON_SIZE</span><span class="p">;</span>
<span class="linenos">2246</span>
<span class="linenos">2247</span><span class="w">	</span><span class="c1">// Check if I need to read from buffer and not lattice</span>
<span class="linenos">2248</span><span class="w">	</span><span class="kt">bool</span><span class="w"> </span><span class="n">in_top_recv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">z</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="p">(</span><span class="n">top_recv_z</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">top_dim_z</span><span class="p">));</span>
<span class="linenos">2249</span><span class="w">	</span><span class="kt">bool</span><span class="w"> </span><span class="n">in_bot_recv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">z</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">bot_recv_z</span><span class="p">);</span>
<span class="linenos">2250</span>
<span class="linenos">2251</span><span class="w">    </span><span class="c1">///////////////////////////////////////////</span>
<span class="linenos">2252</span><span class="w">    </span><span class="c1">// Load the lattice into shared memory. //</span>
<span class="linenos">2253</span><span class="w">    </span><span class="c1">///////////////////////////////////////////</span>
<span class="linenos">2254</span>
<span class="linenos">2255</span><span class="w">    </span><span class="c1">// Shared memory to store the lattice segment.</span>
<span class="linenos">2256</span><span class="w">    </span><span class="kt">__shared__</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">window</span><span class="p">[</span><span class="n">MPD_X_WINDOW_SIZE</span><span class="o">*</span><span class="n">MPD_WORDS_PER_SITE</span><span class="p">];</span>
<span class="linenos">2257</span><span class="w">    </span><span class="kt">__shared__</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">sitesWindow</span><span class="p">[</span><span class="n">MPD_X_WINDOW_SIZE</span><span class="p">];</span>
<span class="linenos">2258</span>
<span class="linenos">2259</span><span class="w">	</span><span class="k">if</span><span class="p">(</span><span class="n">in_top_recv</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">buf_top</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span>
<span class="linenos">2260</span><span class="w">	</span><span class="p">{</span>
<span class="linenos">2261</span><span class="w">		</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">packidx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">y</span><span class="o">*</span><span class="n">latticeXSizeC</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">z</span><span class="o">-</span><span class="n">top_recv_z</span><span class="p">)</span><span class="o">*</span><span class="n">latticeXYSizeC</span><span class="p">;</span>
<span class="linenos">2262</span><span class="w">		</span><span class="n">copyXWindowFromBuffer</span><span class="p">(</span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">buf_top</span><span class="p">,</span><span class="w"> </span><span class="n">window</span><span class="p">,</span><span class="w"> </span><span class="n">packidx</span><span class="p">,</span><span class="w"> </span><span class="n">latticeXIndex</span><span class="p">,</span><span class="w"> </span><span class="n">windowIndex</span><span class="p">,</span><span class="w"> </span><span class="n">top_dim_size</span><span class="p">);</span>
<span class="linenos">2263</span><span class="w">	</span><span class="p">}</span>
<span class="linenos">2264</span><span class="w">	</span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="p">(</span><span class="n">in_bot_recv</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">buf_bot</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span>
<span class="linenos">2265</span><span class="w">	</span><span class="p">{</span>
<span class="linenos">2266</span><span class="w">		</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">packidx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">y</span><span class="o">*</span><span class="n">latticeXSizeC</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">z</span><span class="o">-</span><span class="n">bot_recv_z</span><span class="p">)</span><span class="o">*</span><span class="n">latticeXYSizeC</span><span class="p">;</span>
<span class="linenos">2267</span><span class="w">		</span><span class="n">copyXWindowFromBuffer</span><span class="p">(</span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">buf_bot</span><span class="p">,</span><span class="w"> </span><span class="n">window</span><span class="p">,</span><span class="w"> </span><span class="n">packidx</span><span class="p">,</span><span class="w"> </span><span class="n">latticeXIndex</span><span class="p">,</span><span class="w"> </span><span class="n">windowIndex</span><span class="p">,</span><span class="w"> </span><span class="n">bot_dim_size</span><span class="p">);</span>
<span class="linenos">2268</span><span class="w">	</span><span class="p">}</span>
<span class="linenos">2269</span><span class="w">	</span><span class="k">else</span>
<span class="linenos">2270</span><span class="w">	</span><span class="p">{</span>
<span class="linenos">2271</span><span class="w">		</span><span class="c1">// Copy the x window from device memory into shared memory.</span>
<span class="linenos">2272</span><span class="w">		</span><span class="n">copyXWindowFromLattice</span><span class="p">(</span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">inLattice</span><span class="p">,</span><span class="w"> </span><span class="n">window</span><span class="p">,</span><span class="w"> </span><span class="n">latticeIndex</span><span class="p">,</span><span class="w"> </span><span class="n">latticeXIndex</span><span class="p">,</span><span class="w"> </span><span class="n">windowIndex</span><span class="p">);</span>
<span class="linenos">2273</span><span class="w">	</span><span class="p">}</span>
<span class="linenos">2274</span>
<span class="linenos">2275</span><span class="w">    </span><span class="n">copyXWindowFromSites</span><span class="p">(</span><span class="nb">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">inSites</span><span class="p">,</span><span class="w"> </span><span class="n">sitesWindow</span><span class="p">,</span><span class="w"> </span><span class="n">latticeIndex</span><span class="p">,</span><span class="w"> </span><span class="n">latticeXIndex</span><span class="p">,</span><span class="w"> </span><span class="n">windowIndex</span><span class="p">);</span>
<span class="linenos">2276</span><span class="w">    </span><span class="nf">__syncthreads</span><span class="p">();</span>
<span class="linenos">2277</span>
<span class="linenos">2278</span><span class="w">    </span><span class="c1">////////////////////////////////////////</span>
<span class="linenos">2279</span><span class="w">    </span><span class="c1">// Make the choice for each particle. //</span>
<span class="linenos">2280</span><span class="w">    </span><span class="c1">////////////////////////////////////////</span>
<span class="linenos">2281</span>
<span class="linenos">2282</span><span class="w">    </span><span class="kt">__shared__</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">choices</span><span class="p">[</span><span class="n">MPD_X_WINDOW_SIZE</span><span class="o">*</span><span class="n">MPD_WORDS_PER_SITE</span><span class="p">];</span>
<span class="linenos">2283</span>
<span class="linenos">2284</span><span class="w">    </span><span class="c1">// Make the choices.</span>
<span class="linenos">2285</span><span class="w">    </span><span class="n">makeXDiffusionChoices</span><span class="p">(</span><span class="n">window</span><span class="p">,</span><span class="w"> </span><span class="n">sitesWindow</span><span class="p">,</span><span class="w"> </span><span class="n">choices</span><span class="p">,</span><span class="w"> </span><span class="n">globalIndex</span><span class="p">,</span><span class="w"> </span><span class="n">latticeXIndex</span><span class="p">,</span><span class="w"> </span><span class="n">windowIndex</span><span class="p">,</span><span class="w"> </span><span class="nb">blockDim</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">timestepHash</span><span class="p">);</span>
<span class="linenos">2286</span><span class="w">	</span><span class="nf">__syncthreads</span><span class="p">();</span>
<span class="linenos">2287</span>
<span class="linenos">2288</span><span class="w">    </span><span class="c1">//////////////////////////////////////////////////////////</span>
<span class="linenos">2289</span><span class="w">    </span><span class="c1">// Create version of the lattice at the next time step. //</span>
<span class="linenos">2290</span><span class="w">    </span><span class="c1">//////////////////////////////////////////////////////////</span>
<span class="linenos">2291</span>
<span class="linenos">2292</span><span class="w">    </span><span class="c1">// Propagate the choices to the new lattice segment.</span>
<span class="linenos">2293</span><span class="w">    </span><span class="n">performPropagation</span><span class="p">(</span><span class="n">outLattice</span><span class="p">,</span><span class="w"> </span><span class="n">window</span><span class="p">,</span><span class="w"> </span><span class="n">choices</span><span class="p">,</span><span class="w"> </span><span class="n">latticeIndex</span><span class="p">,</span><span class="w"> </span><span class="n">windowIndex</span><span class="mi">-1</span><span class="p">,</span><span class="w"> </span><span class="n">windowIndex</span><span class="p">,</span><span class="w"> </span><span class="n">windowIndex</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">MPD_X_WINDOW_SIZE</span><span class="p">,</span><span class="w"> </span><span class="n">siteOverflowList</span><span class="p">);</span>
<span class="linenos">2294</span><span class="p">}</span>
<span class="linenos">2295</span>
<span class="linenos">2296</span><span class="c1">// For periodic lattices with a potentially negative offset</span>
<span class="linenos">2297</span><span class="kt">__device__</span><span class="w"> </span><span class="kr">inline</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">local_to_global</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="linenos">2298</span><span class="p">{</span>
<span class="linenos">2299</span><span class="w">    </span><span class="kt">ssize_t</span><span class="w"> </span><span class="n">ix</span><span class="o">=</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">x</span><span class="o">+</span><span class="n">goffsetXC</span><span class="p">;</span>
<span class="linenos">2300</span><span class="w">    </span><span class="n">ix</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">y</span><span class="o">+</span><span class="n">goffsetYC</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">latticeXSizeC</span><span class="p">;</span>
<span class="linenos">2301</span><span class="w">    </span><span class="n">ix</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">z</span><span class="o">+</span><span class="n">goffsetZC</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">latticeXYSizeC</span><span class="p">;</span>
<span class="linenos">2302</span><span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">max_index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">global_latticeXYZSizeC</span><span class="p">;</span>
<span class="linenos">2303</span><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">ix</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">2304</span><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">ix</span><span class="o">+</span><span class="n">max_index</span><span class="p">;</span>
<span class="linenos">2305</span><span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="p">(</span><span class="n">ix</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">max_index</span><span class="p">)</span>
<span class="linenos">2306</span><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">ix</span><span class="o">-</span><span class="n">max_index</span><span class="p">;</span>
<span class="linenos">2307</span><span class="w">    </span><span class="k">else</span>
<span class="linenos">2308</span><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">ix</span><span class="p">;</span>
<span class="linenos">2309</span><span class="p">}</span>
<span class="linenos">2310</span><span class="cm">/*</span>
<span class="linenos">2311</span><span class="cm">// For non-periodic lattices with a strictly positive offset</span>
<span class="linenos">2312</span><span class="cm">__device__ inline size_t local_to_global(unsigned int x, unsigned int y, unsigned int z)</span>
<span class="linenos">2313</span><span class="cm">{</span>
<span class="linenos">2314</span><span class="cm">    size_t ix=x+goffsetXC;</span>
<span class="linenos">2315</span><span class="cm">    ix += (y+goffsetYC)*latticeXSizeC;</span>
<span class="linenos">2316</span><span class="cm">    ix += (z+goffsetZC)*latticeXYSizeC;</span>
<span class="linenos">2317</span><span class="cm">	return ix;</span>
<span class="linenos">2318</span><span class="cm">}</span>
<span class="linenos">2319</span><span class="cm">*/</span>
<span class="linenos">2320</span>
<span class="linenos">2321</span><span class="kt">__device__</span><span class="w"> </span><span class="kr">inline</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">local_index</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="linenos">2322</span><span class="p">{</span>
<span class="linenos">2323</span><span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">y</span><span class="o">*</span><span class="n">latticeXSizeC</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">z</span><span class="o">*</span><span class="n">latticeXYSizeC</span><span class="p">;</span>
<span class="linenos">2324</span><span class="p">}</span>
<span class="linenos">2325</span>
<span class="linenos">2326</span><span class="p">}</span>
<span class="linenos">2327</span><span class="p">}</span>
<span class="linenos">2328</span><span class="p">}</span>
</pre></div>
</div>
</section>
</section>
<section id="shape-classes">
<h2>Shape Classes<a class="headerlink" href="#shape-classes" title="Link to this heading">#</a></h2>
<section id="shape-h">
<h3>Shape.h<a class="headerlink" href="#shape-h" title="Link to this heading">#</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="linenos">  1</span><span class="cm">/*</span>
<span class="linenos">  2</span><span class="cm"> * University of Illinois Open Source License</span>
<span class="linenos">  3</span><span class="cm"> * Copyright 2011-2018 Luthey-Schulten Group,</span>
<span class="linenos">  4</span><span class="cm"> * All rights reserved.</span>
<span class="linenos">  5</span><span class="cm"> *</span>
<span class="linenos">  6</span><span class="cm"> * Developed by: Luthey-Schulten Group</span>
<span class="linenos">  7</span><span class="cm"> *               University of Illinois at Urbana-Champaign</span>
<span class="linenos">  8</span><span class="cm"> *               http://www.scs.uiuc.edu/~schulten</span>
<span class="linenos">  9</span><span class="cm"> *</span>
<span class="linenos"> 10</span><span class="cm"> * Permission is hereby granted, free of charge, to any person obtaining a copy of</span>
<span class="linenos"> 11</span><span class="cm"> * this software and associated documentation files (the Software), to deal with</span>
<span class="linenos"> 12</span><span class="cm"> * the Software without restriction, including without limitation the rights to</span>
<span class="linenos"> 13</span><span class="cm"> * use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies</span>
<span class="linenos"> 14</span><span class="cm"> * of the Software, and to permit persons to whom the Software is furnished to</span>
<span class="linenos"> 15</span><span class="cm"> * do so, subject to the following conditions:</span>
<span class="linenos"> 16</span><span class="cm"> *</span>
<span class="linenos"> 17</span><span class="cm"> * - Redistributions of source code must retain the above copyright notice,</span>
<span class="linenos"> 18</span><span class="cm"> * this list of conditions and the following disclaimers.</span>
<span class="linenos"> 19</span><span class="cm"> *</span>
<span class="linenos"> 20</span><span class="cm"> * - Redistributions in binary form must reproduce the above copyright notice,</span>
<span class="linenos"> 21</span><span class="cm"> * this list of conditions and the following disclaimers in the documentation</span>
<span class="linenos"> 22</span><span class="cm"> * and/or other materials provided with the distribution.</span>
<span class="linenos"> 23</span><span class="cm"> *</span>
<span class="linenos"> 24</span><span class="cm"> * - Neither the names of the Luthey-Schulten Group, University of Illinois at</span>
<span class="linenos"> 25</span><span class="cm"> * Urbana-Champaign, nor the names of its contributors may be used to endorse or</span>
<span class="linenos"> 26</span><span class="cm"> * promote products derived from this Software without specific prior written</span>
<span class="linenos"> 27</span><span class="cm"> * permission.</span>
<span class="linenos"> 28</span><span class="cm"> *</span>
<span class="linenos"> 29</span><span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR</span>
<span class="linenos"> 30</span><span class="cm"> * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,</span>
<span class="linenos"> 31</span><span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL</span>
<span class="linenos"> 32</span><span class="cm"> * THE CONTRIBUTORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR</span>
<span class="linenos"> 33</span><span class="cm"> * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,</span>
<span class="linenos"> 34</span><span class="cm"> * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR</span>
<span class="linenos"> 35</span><span class="cm"> * OTHER DEALINGS WITH THE SOFTWARE.</span>
<span class="linenos"> 36</span><span class="cm"> *</span>
<span class="linenos"> 37</span><span class="cm"> * Author(s): Andrew Magis, Elijah Roberts</span>
<span class="linenos"> 38</span><span class="cm"> */</span>
<span class="linenos"> 39</span>
<span class="linenos"> 40</span><span class="cp">#ifndef LM_BUILDER_SHAPE_H_</span>
<span class="linenos"> 41</span><span class="cp">#define LM_BUILDER_SHAPE_H_</span>
<span class="linenos"> 42</span>
<span class="linenos"> 43</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;cmath&gt;</span>
<span class="linenos"> 44</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;cstdlib&gt;</span>
<span class="linenos"> 45</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;ctime&gt;</span>
<span class="linenos"> 46</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;core/Math.h&quot;</span>
<span class="linenos"> 47</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;core/Types.h&quot;</span>
<span class="linenos"> 48</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;rdme/Lattice.h&quot;</span>
<span class="linenos"> 49</span>
<span class="linenos"> 50</span><span class="k">namespace</span><span class="w"> </span><span class="nn">lm</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 51</span>
<span class="linenos"> 52</span><span class="k">namespace</span><span class="w"> </span><span class="nn">rdme</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 53</span><span class="k">class</span><span class="w"> </span><span class="nc">Lattice</span><span class="p">;</span>
<span class="linenos"> 54</span><span class="p">}</span>
<span class="linenos"> 55</span>
<span class="linenos"> 56</span><span class="k">namespace</span><span class="w"> </span><span class="nn">builder</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 57</span>
<span class="linenos"> 58</span><span class="c1">// Forward declarations</span>
<span class="linenos"> 59</span><span class="k">struct</span><span class="w"> </span><span class="nc">point</span><span class="p">;</span>
<span class="linenos"> 60</span><span class="k">struct</span><span class="w"> </span><span class="nc">vector</span><span class="p">;</span>
<span class="linenos"> 61</span><span class="k">struct</span><span class="w"> </span><span class="nc">matrix</span><span class="p">;</span>
<span class="linenos"> 62</span>
<span class="linenos"> 63</span>
<span class="linenos"> 64</span>
<span class="linenos"> 65</span><span class="c1">/// @struct point</span>
<span class="linenos"> 66</span><span class="c1">/// @brief Type to store a position in space.</span>
<span class="linenos"> 67</span><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">point</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 68</span><span class="w">    </span><span class="c1">/// @brief Create a point</span>
<span class="linenos"> 69</span><span class="w">    </span><span class="c1">/// @param x X location</span>
<span class="linenos"> 70</span><span class="w">    </span><span class="c1">/// @param y Y location</span>
<span class="linenos"> 71</span><span class="w">    </span><span class="c1">/// @param z Z location</span>
<span class="linenos"> 72</span><span class="w">    </span><span class="n">point</span><span class="p">(</span><span class="n">si_dist_t</span><span class="w"> </span><span class="n">x</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="n">si_dist_t</span><span class="w"> </span><span class="n">y</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="n">si_dist_t</span><span class="w"> </span><span class="n">z</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span><span class="o">:</span><span class="n">x</span><span class="p">(</span><span class="n">x</span><span class="p">),</span><span class="n">y</span><span class="p">(</span><span class="n">y</span><span class="p">),</span><span class="n">z</span><span class="p">(</span><span class="n">z</span><span class="p">){}</span>
<span class="linenos"> 73</span><span class="w">    </span><span class="n">si_dist_t</span><span class="w"> </span><span class="n">x</span><span class="p">;</span>
<span class="linenos"> 74</span><span class="w">    </span><span class="n">si_dist_t</span><span class="w"> </span><span class="n">y</span><span class="p">;</span>
<span class="linenos"> 75</span><span class="w">    </span><span class="n">si_dist_t</span><span class="w"> </span><span class="n">z</span><span class="p">;</span>
<span class="linenos"> 76</span>
<span class="linenos"> 77</span><span class="w">	</span><span class="c1">/// @brief Create a point from another point</span>
<span class="linenos"> 78</span><span class="w">	</span><span class="c1">/// @param p2 The point to copy</span>
<span class="linenos"> 79</span><span class="w">	</span><span class="n">point</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">point</span><span class="w"> </span><span class="o">&amp;</span><span class="n">p2</span><span class="p">)</span><span class="o">:</span><span class="n">x</span><span class="p">(</span><span class="n">p2</span><span class="p">.</span><span class="n">x</span><span class="p">),</span><span class="n">y</span><span class="p">(</span><span class="n">p2</span><span class="p">.</span><span class="n">y</span><span class="p">),</span><span class="n">z</span><span class="p">(</span><span class="n">p2</span><span class="p">.</span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">{}</span>
<span class="linenos"> 80</span>
<span class="linenos"> 81</span><span class="w">    </span><span class="c1">/// @brief Determine the distance squared between two points</span>
<span class="linenos"> 82</span><span class="w">    </span><span class="c1">/// @param p2 Second point</span>
<span class="linenos"> 83</span><span class="w">    </span><span class="c1">/// @return scalar distance squared</span>
<span class="linenos"> 84</span><span class="w">    </span><span class="n">si_dist_t</span><span class="w"> </span><span class="n">distanceSquared</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">point</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">p2</span><span class="p">)</span>
<span class="linenos"> 85</span><span class="w">    </span><span class="p">{</span>
<span class="linenos"> 86</span><span class="w">        </span><span class="n">si_dist_t</span><span class="w"> </span><span class="n">dx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p2</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">x</span><span class="p">;</span>
<span class="linenos"> 87</span><span class="w">        </span><span class="n">si_dist_t</span><span class="w"> </span><span class="n">dy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p2</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">y</span><span class="p">;</span>
<span class="linenos"> 88</span><span class="w">        </span><span class="n">si_dist_t</span><span class="w"> </span><span class="n">dz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p2</span><span class="p">.</span><span class="n">z</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">z</span><span class="p">;</span>
<span class="linenos"> 89</span><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">dx</span><span class="o">*</span><span class="n">dx</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">dy</span><span class="o">*</span><span class="n">dy</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">dz</span><span class="o">*</span><span class="n">dz</span><span class="p">);</span>
<span class="linenos"> 90</span><span class="w">    </span><span class="p">}</span>
<span class="linenos"> 91</span>
<span class="linenos"> 92</span><span class="w">	</span><span class="c1">/// @brief Subtract the vector from the point</span>
<span class="linenos"> 93</span><span class="w">	</span><span class="c1">/// @param v The vector to subtract</span>
<span class="linenos"> 94</span><span class="w">	</span><span class="c1">/// @return A new point at that location</span>
<span class="linenos"> 95</span><span class="w">	</span><span class="n">point</span><span class="w"> </span><span class="n">minus</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">vector</span><span class="w"> </span><span class="o">&amp;</span><span class="n">r</span><span class="p">);</span>
<span class="linenos"> 96</span>
<span class="linenos"> 97</span><span class="w">	</span><span class="c1">/// @brief Add the vector from the point</span>
<span class="linenos"> 98</span><span class="w">	</span><span class="c1">/// @param v The vector to add</span>
<span class="linenos"> 99</span><span class="w">	</span><span class="c1">/// @return A new point at that location</span>
<span class="linenos">100</span><span class="w">	</span><span class="n">point</span><span class="w"> </span><span class="nf">plus</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">vector</span><span class="w"> </span><span class="o">&amp;</span><span class="n">r</span><span class="p">);</span>
<span class="linenos">101</span>
<span class="linenos">102</span><span class="w">    </span><span class="c1">/// @brief Determine the distance to another point</span>
<span class="linenos">103</span><span class="w">    </span><span class="c1">/// @param p2 Second point</span>
<span class="linenos">104</span><span class="w">    </span><span class="c1">/// @return scalar distance</span>
<span class="linenos">105</span><span class="w">    </span><span class="n">si_dist_t</span><span class="w"> </span><span class="nf">distance</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">point</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">p2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="k">return</span><span class="w"> </span><span class="n">sqrt</span><span class="p">(</span><span class="n">distanceSquared</span><span class="p">(</span><span class="n">p2</span><span class="p">));}</span>
<span class="linenos">106</span><span class="p">}</span><span class="w"> </span><span class="n">point</span><span class="p">;</span>
<span class="linenos">107</span>
<span class="linenos">108</span><span class="c1">/// @struct bounding_box</span>
<span class="linenos">109</span><span class="c1">/// @brief The bounds for a shape represented as a rectangular box</span>
<span class="linenos">110</span><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">bounding_box</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">111</span><span class="w">    </span><span class="c1">/// @brief Create a bounding box for coordinates</span>
<span class="linenos">112</span><span class="w">    </span><span class="c1">/// @param x1 Bottom x</span>
<span class="linenos">113</span><span class="w">    </span><span class="c1">/// @param y1 Bottom y</span>
<span class="linenos">114</span><span class="w">    </span><span class="c1">/// @param z1 Bottom z</span>
<span class="linenos">115</span><span class="w">    </span><span class="c1">/// @param x2 Top x</span>
<span class="linenos">116</span><span class="w">    </span><span class="c1">/// @param y2 Top y</span>
<span class="linenos">117</span><span class="w">    </span><span class="c1">/// @param z2 Top z</span>
<span class="linenos">118</span><span class="w">    </span><span class="n">bounding_box</span><span class="p">(</span><span class="n">si_dist_t</span><span class="w"> </span><span class="n">x1</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="n">si_dist_t</span><span class="w"> </span><span class="n">y1</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="n">si_dist_t</span><span class="w"> </span><span class="n">z1</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="n">si_dist_t</span><span class="w"> </span><span class="n">x2</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="n">si_dist_t</span><span class="w"> </span><span class="n">y2</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="n">si_dist_t</span><span class="w"> </span><span class="n">z2</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span><span class="o">:</span><span class="n">min</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span><span class="n">y1</span><span class="p">,</span><span class="n">z1</span><span class="p">),</span><span class="n">max</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span><span class="n">y2</span><span class="p">,</span><span class="n">z2</span><span class="p">){}</span>
<span class="linenos">119</span><span class="w">    </span><span class="c1">/// @brief Create a bounding box from points</span>
<span class="linenos">120</span><span class="w">    </span><span class="c1">/// @param min Minimum coordinate</span>
<span class="linenos">121</span><span class="w">    </span><span class="c1">/// @param max Maximum coordinate</span>
<span class="linenos">122</span><span class="w">    </span><span class="n">bounding_box</span><span class="p">(</span><span class="n">point</span><span class="w"> </span><span class="n">min</span><span class="p">,</span><span class="w"> </span><span class="n">point</span><span class="w"> </span><span class="n">max</span><span class="p">)</span><span class="o">:</span><span class="n">min</span><span class="p">(</span><span class="n">min</span><span class="p">),</span><span class="n">max</span><span class="p">(</span><span class="n">max</span><span class="p">){}</span>
<span class="linenos">123</span><span class="w">    </span>
<span class="linenos">124</span><span class="w">    </span><span class="c1">// Actual points of the bounding box</span>
<span class="linenos">125</span><span class="w">    </span><span class="n">point</span><span class="w"> </span><span class="n">min</span><span class="p">,</span><span class="w"> </span><span class="n">max</span><span class="p">;</span>
<span class="linenos">126</span>
<span class="linenos">127</span><span class="w">    </span><span class="c1">/// @brief Return a bounding box spanning the two bounding boxes</span>
<span class="linenos">128</span><span class="w">    </span><span class="c1">/// @param j Other bounding box</span>
<span class="linenos">129</span><span class="w">    </span><span class="c1">/// @return new bounding box</span>
<span class="linenos">130</span><span class="w">    </span><span class="n">bounding_box</span><span class="w"> </span><span class="nf">joinWith</span><span class="p">(</span><span class="n">bounding_box</span><span class="w"> </span><span class="n">j</span><span class="p">)</span>
<span class="linenos">131</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">132</span><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">bounding_box</span><span class="p">(</span><span class="o">::</span><span class="n">min</span><span class="p">(</span><span class="n">j</span><span class="p">.</span><span class="n">min</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="n">min</span><span class="p">.</span><span class="n">x</span><span class="p">),</span><span class="o">::</span><span class="n">min</span><span class="p">(</span><span class="n">j</span><span class="p">.</span><span class="n">min</span><span class="p">.</span><span class="n">y</span><span class="p">,</span><span class="n">min</span><span class="p">.</span><span class="n">y</span><span class="p">),</span><span class="o">::</span><span class="n">min</span><span class="p">(</span><span class="n">j</span><span class="p">.</span><span class="n">min</span><span class="p">.</span><span class="n">z</span><span class="p">,</span><span class="n">min</span><span class="p">.</span><span class="n">z</span><span class="p">),</span><span class="o">::</span><span class="n">max</span><span class="p">(</span><span class="n">j</span><span class="p">.</span><span class="n">max</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="n">max</span><span class="p">.</span><span class="n">x</span><span class="p">),</span><span class="o">::</span><span class="n">max</span><span class="p">(</span><span class="n">j</span><span class="p">.</span><span class="n">max</span><span class="p">.</span><span class="n">y</span><span class="p">,</span><span class="n">max</span><span class="p">.</span><span class="n">y</span><span class="p">),</span><span class="o">::</span><span class="n">max</span><span class="p">(</span><span class="n">j</span><span class="p">.</span><span class="n">max</span><span class="p">.</span><span class="n">z</span><span class="p">,</span><span class="n">max</span><span class="p">.</span><span class="n">z</span><span class="p">));</span>
<span class="linenos">133</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">134</span><span class="w">    </span>
<span class="linenos">135</span><span class="w">    </span><span class="c1">/// @brief Returns the bounding box volume</span>
<span class="linenos">136</span><span class="w">    </span><span class="c1">/// @return volume</span>
<span class="linenos">137</span><span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="nf">volume</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">fabs</span><span class="p">((</span><span class="n">max</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">min</span><span class="p">.</span><span class="n">x</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">max</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">min</span><span class="p">.</span><span class="n">y</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">max</span><span class="p">.</span><span class="n">z</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">min</span><span class="p">.</span><span class="n">z</span><span class="p">));</span><span class="w"> </span><span class="p">}</span>
<span class="linenos">138</span><span class="w">    </span>
<span class="linenos">139</span><span class="w">    </span><span class="c1">/// @brief Retun a random point inside the bounding box</span>
<span class="linenos">140</span><span class="w">    </span><span class="c1">/// @return point</span>
<span class="linenos">141</span><span class="w">    </span><span class="n">point</span><span class="w"> </span><span class="nf">randomPointInside</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">142</span><span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">rx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="n">rand</span><span class="p">()</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="n">RAND_MAX</span><span class="p">;</span>
<span class="linenos">143</span><span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">ry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="n">rand</span><span class="p">()</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="n">RAND_MAX</span><span class="p">;</span>
<span class="linenos">144</span><span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">rz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="n">rand</span><span class="p">()</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="n">RAND_MAX</span><span class="p">;</span>
<span class="linenos">145</span><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">point</span><span class="p">(</span><span class="n">rx</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">max</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">min</span><span class="p">.</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">min</span><span class="p">.</span><span class="n">x</span><span class="p">,</span>
<span class="linenos">146</span><span class="w">                     </span><span class="n">ry</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">max</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">min</span><span class="p">.</span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">min</span><span class="p">.</span><span class="n">y</span><span class="p">,</span>
<span class="linenos">147</span><span class="w">                     </span><span class="n">rz</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">max</span><span class="p">.</span><span class="n">z</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">min</span><span class="p">.</span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">min</span><span class="p">.</span><span class="n">z</span><span class="p">);</span>
<span class="linenos">148</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">149</span><span class="p">}</span><span class="w"> </span><span class="n">bounding_box</span><span class="p">;</span>
<span class="linenos">150</span>
<span class="linenos">151</span><span class="c1">/// @struct vector</span>
<span class="linenos">152</span><span class="c1">/// @brief A vector which points in a direction</span>
<span class="linenos">153</span><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">vector</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">154</span><span class="c1">//////////////////</span>
<span class="linenos">155</span><span class="c1">// Constructors //</span>
<span class="linenos">156</span><span class="c1">//////////////////</span>
<span class="linenos">157</span><span class="w">    </span><span class="c1">/// @brief Create a vector</span>
<span class="linenos">158</span><span class="w">    </span><span class="c1">/// @param x Distance in x</span>
<span class="linenos">159</span><span class="w">    </span><span class="c1">/// @param y Distance in y</span>
<span class="linenos">160</span><span class="w">    </span><span class="c1">/// @param z Distance in z</span>
<span class="linenos">161</span><span class="w">    </span><span class="n">vector</span><span class="p">(</span><span class="n">si_dist_t</span><span class="w"> </span><span class="n">x</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="n">si_dist_t</span><span class="w"> </span><span class="n">y</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="n">si_dist_t</span><span class="w"> </span><span class="n">z</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span><span class="o">:</span><span class="n">x</span><span class="p">(</span><span class="n">x</span><span class="p">),</span><span class="n">y</span><span class="p">(</span><span class="n">y</span><span class="p">),</span><span class="n">z</span><span class="p">(</span><span class="n">z</span><span class="p">){}</span>
<span class="linenos">162</span><span class="w">   </span>
<span class="linenos">163</span><span class="w">    </span><span class="c1">/// @brief Construct a vector pointing from one point to another</span>
<span class="linenos">164</span><span class="w">    </span><span class="c1">/// @param from The point at the root of the vector</span>
<span class="linenos">165</span><span class="w">    </span><span class="c1">/// @param to The point at the end of the vector</span>
<span class="linenos">166</span><span class="w">    </span><span class="n">vector</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">point</span><span class="w"> </span><span class="o">&amp;</span><span class="n">from</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">point</span><span class="w"> </span><span class="o">&amp;</span><span class="n">to</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">167</span><span class="w">      </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">to</span><span class="p">.</span><span class="n">x</span><span class="o">-</span><span class="n">from</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
<span class="linenos">168</span><span class="w">      </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">to</span><span class="p">.</span><span class="n">y</span><span class="o">-</span><span class="n">from</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
<span class="linenos">169</span><span class="w">      </span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">to</span><span class="p">.</span><span class="n">z</span><span class="o">-</span><span class="n">from</span><span class="p">.</span><span class="n">z</span><span class="p">;</span>
<span class="linenos">170</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">171</span>
<span class="linenos">172</span><span class="w">	</span><span class="c1">/// @brief Construct a vector from another vector</span>
<span class="linenos">173</span><span class="w">	</span><span class="c1">/// @param v The vector to copy</span>
<span class="linenos">174</span><span class="w">	</span><span class="n">vector</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">vector</span><span class="w"> </span><span class="o">&amp;</span><span class="n">v</span><span class="p">)</span><span class="o">:</span><span class="n">x</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">x</span><span class="p">),</span><span class="n">y</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">y</span><span class="p">),</span><span class="n">z</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">{}</span>
<span class="linenos">175</span>
<span class="linenos">176</span><span class="w">	</span><span class="c1">/// @brief Construct a vector from a point</span>
<span class="linenos">177</span><span class="w">	</span><span class="c1">/// @param p The point to cast</span>
<span class="linenos">178</span><span class="w">	</span><span class="n">vector</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">point</span><span class="w"> </span><span class="o">&amp;</span><span class="n">p</span><span class="p">)</span><span class="o">:</span><span class="n">x</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">x</span><span class="p">),</span><span class="n">y</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">y</span><span class="p">),</span><span class="n">z</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">{}</span>
<span class="linenos">179</span>
<span class="linenos">180</span><span class="w">	</span><span class="c1">/// @brief convert the vector to a point</span>
<span class="linenos">181</span><span class="w">	</span><span class="n">point</span><span class="w"> </span><span class="n">toPoint</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">182</span><span class="w">		</span><span class="k">return</span><span class="w"> </span><span class="n">point</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">);</span>
<span class="linenos">183</span><span class="w">	</span><span class="p">}</span>
<span class="linenos">184</span>
<span class="linenos">185</span><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="n">vector</span><span class="w"> </span><span class="n">findPerpendicularVector</span><span class="p">(</span><span class="n">vector</span><span class="w"> </span><span class="n">v</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">186</span><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">fabs</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">1.0e-12</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">fabs</span><span class="p">(</span><span class="o">-</span><span class="n">v</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">v</span><span class="p">.</span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">1.0e-12</span><span class="p">)</span>
<span class="linenos">187</span><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">vector</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">z</span><span class="p">,</span><span class="n">v</span><span class="p">.</span><span class="n">z</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="n">v</span><span class="p">.</span><span class="n">x</span><span class="o">-</span><span class="n">v</span><span class="p">.</span><span class="n">y</span><span class="p">);</span>
<span class="linenos">188</span><span class="w">      </span><span class="k">else</span>
<span class="linenos">189</span><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">vector</span><span class="p">(</span><span class="o">-</span><span class="n">v</span><span class="p">.</span><span class="n">y</span><span class="o">-</span><span class="n">v</span><span class="p">.</span><span class="n">z</span><span class="p">,</span><span class="n">v</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="n">v</span><span class="p">.</span><span class="n">x</span><span class="p">);</span>
<span class="linenos">190</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">191</span><span class="c1">////////////////////// </span>
<span class="linenos">192</span><span class="c1">// Unary Operations //</span>
<span class="linenos">193</span><span class="c1">////////////////////// </span>
<span class="linenos">194</span><span class="w">    </span><span class="c1">/// @brief Get the vector length</span>
<span class="linenos">195</span><span class="w">    </span><span class="n">si_dist_t</span><span class="w"> </span><span class="n">length</span><span class="p">();</span>
<span class="linenos">196</span>
<span class="linenos">197</span><span class="w">    </span><span class="c1">/// @brief Get a unit vector pointing in the same direction as this vector</span>
<span class="linenos">198</span><span class="w">    </span><span class="n">vector</span><span class="w"> </span><span class="nf">unitize</span><span class="p">();</span>
<span class="linenos">199</span><span class="c1">/////////////////////// </span>
<span class="linenos">200</span><span class="c1">// Binary Operations //</span>
<span class="linenos">201</span><span class="c1">/////////////////////// </span>
<span class="linenos">202</span><span class="w">    </span><span class="c1">/// @brief Compute the dot product between vectors</span>
<span class="linenos">203</span><span class="w">    </span><span class="c1">/// @param r The right hand vector</span>
<span class="linenos">204</span><span class="w">    </span><span class="n">si_dist_t</span><span class="w"> </span><span class="nf">dot</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">vector</span><span class="w"> </span><span class="o">&amp;</span><span class="n">r</span><span class="p">);</span>
<span class="linenos">205</span>
<span class="linenos">206</span><span class="w">    </span><span class="c1">/// @brief Compute the cross product between vectors</span>
<span class="linenos">207</span><span class="w">    </span><span class="c1">/// @param r The right hand vector</span>
<span class="linenos">208</span><span class="w">    </span><span class="n">vector</span><span class="w"> </span><span class="nf">cross</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">vector</span><span class="w"> </span><span class="o">&amp;</span><span class="n">r</span><span class="p">);</span>
<span class="linenos">209</span>
<span class="linenos">210</span><span class="w">    </span><span class="c1">/// @brief Scale the vector by a constant</span>
<span class="linenos">211</span><span class="w">    </span><span class="c1">/// @param r The scalar</span>
<span class="linenos">212</span><span class="w">    </span><span class="n">vector</span><span class="w"> </span><span class="nf">scale</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">si_dist_t</span><span class="w"> </span><span class="n">r</span><span class="p">);</span>
<span class="linenos">213</span>
<span class="linenos">214</span><span class="w">    </span><span class="c1">/// @brief Multiply with another vector (taking this vector to be a row vector) to form a matrix</span>
<span class="linenos">215</span><span class="w">    </span><span class="c1">/// @param r The column vector</span>
<span class="linenos">216</span><span class="w">    </span><span class="n">matrix</span><span class="w"> </span><span class="nf">mult</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">vector</span><span class="w"> </span><span class="o">&amp;</span><span class="n">r</span><span class="p">);</span>
<span class="linenos">217</span>
<span class="linenos">218</span><span class="w">    </span><span class="c1">/// @brief Multiply with a matrix to form a new vector (assuming this vector is a row vector)</span>
<span class="linenos">219</span><span class="w">    </span><span class="c1">/// @param r The matrix</span>
<span class="linenos">220</span><span class="w">    </span><span class="n">vector</span><span class="w"> </span><span class="nf">mult</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">matrix</span><span class="w"> </span><span class="o">&amp;</span><span class="n">r</span><span class="p">);</span>
<span class="linenos">221</span>
<span class="linenos">222</span><span class="c1">/////////////// </span>
<span class="linenos">223</span><span class="c1">// Variables //</span>
<span class="linenos">224</span><span class="c1">/////////////// </span>
<span class="linenos">225</span><span class="w">    </span><span class="c1">// coordinates</span>
<span class="linenos">226</span><span class="w">    </span><span class="n">si_dist_t</span><span class="w"> </span><span class="n">x</span><span class="p">;</span>
<span class="linenos">227</span><span class="w">    </span><span class="n">si_dist_t</span><span class="w"> </span><span class="n">y</span><span class="p">;</span>
<span class="linenos">228</span><span class="w">    </span><span class="n">si_dist_t</span><span class="w"> </span><span class="n">z</span><span class="p">;</span>
<span class="linenos">229</span><span class="p">}</span><span class="w"> </span><span class="n">vector</span><span class="p">;</span>
<span class="linenos">230</span>
<span class="linenos">231</span>
<span class="linenos">232</span>
<span class="linenos">233</span><span class="c1">/// @struct matrix</span>
<span class="linenos">234</span><span class="c1">/// @brief A matrix used for rotations</span>
<span class="linenos">235</span><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">matrix</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">236</span><span class="c1">//////////////////</span>
<span class="linenos">237</span><span class="c1">// Constructors //</span>
<span class="linenos">238</span><span class="c1">//////////////////</span>
<span class="linenos">239</span><span class="w">    </span><span class="c1">/// @brief Create a matrix with the speficied elements</span>
<span class="linenos">240</span><span class="w">    </span><span class="n">matrix</span><span class="p">(</span><span class="n">si_dist_t</span><span class="w"> </span><span class="n">m11</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="n">si_dist_t</span><span class="w"> </span><span class="n">m12</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">,</span><span class="n">si_dist_t</span><span class="w"> </span><span class="n">m13</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">,</span>
<span class="linenos">241</span><span class="w">           </span><span class="n">si_dist_t</span><span class="w"> </span><span class="n">m21</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="n">si_dist_t</span><span class="w"> </span><span class="n">m22</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">,</span><span class="n">si_dist_t</span><span class="w"> </span><span class="n">m23</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">,</span>
<span class="linenos">242</span><span class="w">           </span><span class="n">si_dist_t</span><span class="w"> </span><span class="n">m31</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="n">si_dist_t</span><span class="w"> </span><span class="n">m32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">,</span><span class="n">si_dist_t</span><span class="w"> </span><span class="n">m33</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">)</span>
<span class="linenos">243</span><span class="w">     </span><span class="o">:</span><span class="w"> </span><span class="n">m11</span><span class="p">(</span><span class="n">m11</span><span class="p">),</span><span class="w"> </span><span class="n">m12</span><span class="p">(</span><span class="n">m12</span><span class="p">),</span><span class="w"> </span><span class="n">m13</span><span class="p">(</span><span class="n">m13</span><span class="p">),</span>
<span class="linenos">244</span><span class="w">       </span><span class="n">m21</span><span class="p">(</span><span class="n">m21</span><span class="p">),</span><span class="w"> </span><span class="n">m22</span><span class="p">(</span><span class="n">m22</span><span class="p">),</span><span class="w"> </span><span class="n">m23</span><span class="p">(</span><span class="n">m23</span><span class="p">),</span>
<span class="linenos">245</span><span class="w">       </span><span class="n">m31</span><span class="p">(</span><span class="n">m31</span><span class="p">),</span><span class="w"> </span><span class="n">m32</span><span class="p">(</span><span class="n">m32</span><span class="p">),</span><span class="w"> </span><span class="n">m33</span><span class="p">(</span><span class="n">m33</span><span class="p">)</span>
<span class="linenos">246</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">247</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">248</span>
<span class="linenos">249</span><span class="w">    </span><span class="c1">/// @brief Get a forward rotation matrix from angles</span>
<span class="linenos">250</span><span class="w">    </span><span class="c1">/// @param phi The angle around x (in radians)</span>
<span class="linenos">251</span><span class="w">    </span><span class="c1">/// @param theta The angle around y (in radians)</span>
<span class="linenos">252</span><span class="w">    </span><span class="c1">/// @param psi The angle around z (in radians)</span>
<span class="linenos">253</span><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="n">matrix</span><span class="w"> </span><span class="n">eulerMatrixFromAngles</span><span class="p">(</span><span class="n">si_dist_t</span><span class="w"> </span><span class="n">phi</span><span class="p">,</span><span class="w"> </span><span class="n">si_dist_t</span><span class="w"> </span><span class="n">theta</span><span class="p">,</span><span class="w"> </span><span class="n">si_dist_t</span><span class="w"> </span><span class="n">psi</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">254</span><span class="w">      </span><span class="n">matrix</span><span class="w"> </span><span class="nf">m</span><span class="p">(</span><span class="w"> </span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">psi</span><span class="p">),</span><span class="w"> </span><span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">psi</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">psi</span><span class="p">),</span><span class="w"> </span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">psi</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">psi</span><span class="p">),</span>
<span class="linenos">255</span><span class="w">               </span><span class="o">-</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">psi</span><span class="p">),</span><span class="w"> </span><span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">psi</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">psi</span><span class="p">),</span><span class="w"> </span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">psi</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">psi</span><span class="p">),</span>
<span class="linenos">256</span><span class="w">                </span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">),</span><span class="w">         </span><span class="o">-</span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">),</span><span class="w">                              </span><span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">));</span>
<span class="linenos">257</span>
<span class="linenos">258</span><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">m</span><span class="p">;</span>
<span class="linenos">259</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">260</span>
<span class="linenos">261</span><span class="w">    </span><span class="c1">/// @brief Get an identity matrix</span>
<span class="linenos">262</span><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="n">matrix</span><span class="w"> </span><span class="n">Identity</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">263</span><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">matrix</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">,</span>
<span class="linenos">264</span><span class="w">                    </span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">,</span>
<span class="linenos">265</span><span class="w">                    </span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">);</span>
<span class="linenos">266</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">267</span>
<span class="linenos">268</span><span class="c1">//////////////////////</span>
<span class="linenos">269</span><span class="c1">// Unary Operations //</span>
<span class="linenos">270</span><span class="c1">//////////////////////</span>
<span class="linenos">271</span><span class="w">    </span><span class="n">matrix</span><span class="w"> </span><span class="n">transpose</span><span class="p">();</span>
<span class="linenos">272</span>
<span class="linenos">273</span><span class="w">    </span><span class="n">si_dist_t</span><span class="w"> </span><span class="nf">determinant</span><span class="p">();</span>
<span class="linenos">274</span>
<span class="linenos">275</span><span class="w">    </span><span class="n">si_dist_t</span><span class="w"> </span><span class="nf">trace</span><span class="p">();</span>
<span class="linenos">276</span>
<span class="linenos">277</span><span class="c1">///////////////////////</span>
<span class="linenos">278</span><span class="c1">// Binary Operations //</span>
<span class="linenos">279</span><span class="c1">///////////////////////</span>
<span class="linenos">280</span><span class="w">    </span><span class="c1">/// @brief Multiply by a vector</span>
<span class="linenos">281</span><span class="w">    </span><span class="n">vector</span><span class="w"> </span><span class="nf">mult</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">vector</span><span class="w"> </span><span class="o">&amp;</span><span class="n">r</span><span class="p">);</span>
<span class="linenos">282</span>
<span class="linenos">283</span><span class="w">    </span><span class="c1">/// @brief Multiply by a matrix</span>
<span class="linenos">284</span><span class="w">    </span><span class="n">matrix</span><span class="w"> </span><span class="nf">mult</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">matrix</span><span class="w"> </span><span class="o">&amp;</span><span class="n">r</span><span class="p">);</span>
<span class="linenos">285</span>
<span class="linenos">286</span><span class="c1">///////////////</span>
<span class="linenos">287</span><span class="c1">// Variables //</span>
<span class="linenos">288</span><span class="c1">///////////////</span>
<span class="linenos">289</span><span class="w">    </span><span class="c1">// Elements</span>
<span class="linenos">290</span><span class="w">    </span><span class="n">si_dist_t</span><span class="w"> </span><span class="n">m11</span><span class="p">;</span>
<span class="linenos">291</span><span class="w">    </span><span class="n">si_dist_t</span><span class="w"> </span><span class="n">m12</span><span class="p">;</span>
<span class="linenos">292</span><span class="w">    </span><span class="n">si_dist_t</span><span class="w"> </span><span class="n">m13</span><span class="p">;</span>
<span class="linenos">293</span><span class="w">    </span><span class="n">si_dist_t</span><span class="w"> </span><span class="n">m21</span><span class="p">;</span>
<span class="linenos">294</span><span class="w">    </span><span class="n">si_dist_t</span><span class="w"> </span><span class="n">m22</span><span class="p">;</span>
<span class="linenos">295</span><span class="w">    </span><span class="n">si_dist_t</span><span class="w"> </span><span class="n">m23</span><span class="p">;</span>
<span class="linenos">296</span><span class="w">    </span><span class="n">si_dist_t</span><span class="w"> </span><span class="n">m31</span><span class="p">;</span>
<span class="linenos">297</span><span class="w">    </span><span class="n">si_dist_t</span><span class="w"> </span><span class="n">m32</span><span class="p">;</span>
<span class="linenos">298</span><span class="w">    </span><span class="n">si_dist_t</span><span class="w"> </span><span class="n">m33</span><span class="p">;</span>
<span class="linenos">299</span><span class="p">}</span><span class="w"> </span><span class="n">matrix</span><span class="p">;</span>
<span class="linenos">300</span>
<span class="linenos">301</span>
<span class="linenos">302</span><span class="c1">/// @class Shape</span>
<span class="linenos">303</span><span class="c1">/// @brief Abstract base class for all the shapes in Lattice Microbes simulation builder</span>
<span class="linenos">304</span><span class="k">class</span><span class="w"> </span><span class="nc">Shape</span>
<span class="linenos">305</span><span class="p">{</span>
<span class="linenos">306</span><span class="k">public</span><span class="o">:</span>
<span class="linenos">307</span><span class="w">    </span><span class="c1">/// @enum ShapeType</span>
<span class="linenos">308</span><span class="w">    </span><span class="c1">/// @brief Possible shape types that can be used in Lattice Microbes</span>
<span class="linenos">309</span><span class="w">    </span><span class="k">enum</span><span class="w"> </span><span class="nc">ShapeType</span>
<span class="linenos">310</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">311</span><span class="w">       </span><span class="n">SPHERE</span><span class="w">           </span><span class="o">=</span><span class="w">  </span><span class="mi">1</span><span class="p">,</span>
<span class="linenos">312</span><span class="w">       </span><span class="n">HEMISPHERE</span><span class="w">       </span><span class="o">=</span><span class="w">  </span><span class="mi">2</span><span class="p">,</span>
<span class="linenos">313</span><span class="w">       </span><span class="n">CYLINDER</span><span class="w">         </span><span class="o">=</span><span class="w">  </span><span class="mi">3</span><span class="p">,</span>
<span class="linenos">314</span><span class="w">       </span><span class="n">CAPSULE</span><span class="w">          </span><span class="o">=</span><span class="w">  </span><span class="mi">4</span><span class="p">,</span>
<span class="linenos">315</span><span class="w">       </span><span class="n">CUBOID</span><span class="w">           </span><span class="o">=</span><span class="w">  </span><span class="mi">5</span><span class="p">,</span>
<span class="linenos">316</span><span class="w">       </span><span class="n">CAPSULE_SHELL</span><span class="w">    </span><span class="o">=</span><span class="w">  </span><span class="mi">6</span><span class="p">,</span>
<span class="linenos">317</span><span class="w">       </span><span class="n">UNION</span><span class="w">            </span><span class="o">=</span><span class="w">  </span><span class="mi">7</span><span class="p">,</span>
<span class="linenos">318</span><span class="w">       </span><span class="n">DIFFERENCE</span><span class="w">       </span><span class="o">=</span><span class="w">  </span><span class="mi">8</span><span class="p">,</span>
<span class="linenos">319</span><span class="w">       </span><span class="n">INTERSECTION</span><span class="w">     </span><span class="o">=</span><span class="w">  </span><span class="mi">9</span><span class="p">,</span>
<span class="linenos">320</span><span class="w">       </span><span class="n">MESH</span><span class="w">             </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span>
<span class="linenos">321</span><span class="w">       </span><span class="n">TORUS</span><span class="w">            </span><span class="o">=</span><span class="w"> </span><span class="mi">11</span><span class="p">,</span>
<span class="linenos">322</span><span class="w">       </span><span class="n">ELLIPSE</span><span class="w">          </span><span class="o">=</span><span class="w"> </span><span class="mi">12</span><span class="p">,</span>
<span class="linenos">323</span><span class="w">       </span><span class="n">CONE</span><span class="w">             </span><span class="o">=</span><span class="w"> </span><span class="mi">13</span><span class="p">,</span>
<span class="linenos">324</span><span class="w">       </span><span class="n">UNIONSET</span><span class="w">         </span><span class="o">=</span><span class="w"> </span><span class="mi">14</span>
<span class="linenos">325</span><span class="w">    </span><span class="p">};</span>
<span class="linenos">326</span>
<span class="linenos">327</span><span class="k">public</span><span class="o">:</span>
<span class="linenos">328</span><span class="w">    </span><span class="c1">/// @brief Create a Shape</span>
<span class="linenos">329</span><span class="w">    </span><span class="c1">/// @param shapeType The type of shape should be of type ShapeType</span>
<span class="linenos">330</span><span class="w">    </span><span class="c1">/// @param boundingBox The extents of the object used for fast collision/contains checking</span>
<span class="linenos">331</span><span class="w">    </span><span class="c1">/// @param type The type of site that the object represents</span>
<span class="linenos">332</span><span class="w">    </span><span class="c1">/// @param at A vector describing what direction the object is pointing &quot;at&quot;; default: (0,0,1)</span>
<span class="linenos">333</span><span class="w">    </span><span class="c1">/// @param up A vector describing what direction is &quot;up&quot; relative to &quot;at&quot;; default: (0,1,0)</span>
<span class="linenos">334</span><span class="w">    </span><span class="n">Shape</span><span class="p">(</span><span class="n">ShapeType</span><span class="w"> </span><span class="n">shapeType</span><span class="p">,</span><span class="w"> </span><span class="n">bounding_box</span><span class="w"> </span><span class="n">boundingBox</span><span class="p">,</span><span class="w"> </span><span class="n">site_t</span><span class="w"> </span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="n">vector</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vector</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">1.0</span><span class="p">),</span><span class="w"> </span><span class="n">vector</span><span class="w"> </span><span class="n">up</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vector</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">1.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">));</span>
<span class="linenos">335</span><span class="w">    </span><span class="c1">/// @brief Destroy the Shape</span>
<span class="linenos">336</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="o">~</span><span class="n">Shape</span><span class="p">();</span>
<span class="linenos">337</span><span class="w">    </span>
<span class="linenos">338</span><span class="w">    </span><span class="c1">/// @brief Checks if another shape&#39;s bounding box interstects with this shape&#39;s bounding box</span>
<span class="linenos">339</span><span class="w">    </span><span class="c1">/// @param query The other shape to test</span>
<span class="linenos">340</span><span class="w">    </span><span class="c1">/// @return true/false</span>
<span class="linenos">341</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="nf">boundingBoxesIntersect</span><span class="p">(</span><span class="n">Shape</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">query</span><span class="p">);</span>
<span class="linenos">342</span><span class="w">    </span><span class="c1">/// @brief Check if two shapes intersect</span>
<span class="linenos">343</span><span class="w">    </span><span class="c1">/// @param query The other shape to check</span>
<span class="linenos">344</span><span class="w">    </span><span class="c1">/// @return true/false</span>
<span class="linenos">345</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="nf">intersects</span><span class="p">(</span><span class="n">Shape</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">query</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">346</span><span class="w">    </span><span class="c1">/// @brief Determine if the shape contains the specified point</span>
<span class="linenos">347</span><span class="w">    </span><span class="c1">/// @param query Point to test</span>
<span class="linenos">348</span><span class="w">    </span><span class="c1">/// @return true/false</span>
<span class="linenos">349</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="nf">contains</span><span class="p">(</span><span class="n">point</span><span class="w"> </span><span class="n">query</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">350</span><span class="w">    </span><span class="c1">/// @brief Determine if the shape contains the specified shape</span>
<span class="linenos">351</span><span class="w">    </span><span class="c1">/// @param query Shape to test</span>
<span class="linenos">352</span><span class="w">    </span><span class="c1">/// @return true/false</span>
<span class="linenos">353</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="nf">contains</span><span class="p">(</span><span class="n">Shape</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">query</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">354</span><span class="w">    </span>
<span class="linenos">355</span><span class="w">    </span><span class="c1">/// @brief Get the bounding box</span>
<span class="linenos">356</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="n">bounding_box</span><span class="w"> </span><span class="nf">getBoundingBox</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="k">return</span><span class="w"> </span><span class="n">boundingBox</span><span class="p">;}</span>
<span class="linenos">357</span><span class="w">    </span><span class="c1">/// @brief Get the site type associated with the shape</span>
<span class="linenos">358</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="n">site_t</span><span class="w"> </span><span class="nf">getType</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="k">return</span><span class="w"> </span><span class="n">type</span><span class="p">;}</span>
<span class="linenos">359</span><span class="w">    </span><span class="c1">/// @brief Get the shape type</span>
<span class="linenos">360</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="n">ShapeType</span><span class="w"> </span><span class="nf">getShapeType</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="k">return</span><span class="w"> </span><span class="n">shapeType</span><span class="p">;}</span>
<span class="linenos">361</span><span class="w">    </span><span class="c1">/// @brief Get the total internal volume of the shape</span>
<span class="linenos">362</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="nf">getVolume</span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">363</span>
<span class="linenos">364</span><span class="w">    </span><span class="c1">/// @brief Discretize the object to the specified lattice</span>
<span class="linenos">365</span><span class="w">    </span><span class="c1">/// @param lattice Lattice in which to discretize the shape</span>
<span class="linenos">366</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">discretizeTo</span><span class="p">(</span><span class="n">lm</span><span class="o">::</span><span class="n">rdme</span><span class="o">::</span><span class="n">Lattice</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">lattice</span><span class="p">);</span>
<span class="linenos">367</span>
<span class="linenos">368</span><span class="k">protected</span><span class="o">:</span>
<span class="linenos">369</span><span class="w">    </span><span class="c1">// Functions used for Monte-Carlo integration of volume</span>
<span class="linenos">370</span><span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">integrateToPercentThreshold</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">percent</span><span class="p">);</span><span class="w"> </span><span class="c1">// Integrate until the fluctuation in value is less than</span>
<span class="linenos">371</span><span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="nf">integrateToCount</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">count</span><span class="p">);</span><span class="w"> </span><span class="c1">// Integrate a static number of steps</span>
<span class="linenos">372</span><span class="w">    </span>
<span class="linenos">373</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="n">point</span><span class="w"> </span><span class="nf">minBounds</span><span class="p">(</span><span class="n">point</span><span class="w"> </span><span class="n">p1</span><span class="p">,</span><span class="w"> </span><span class="n">point</span><span class="w"> </span><span class="n">p2</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span><span class="k">return</span><span class="w"> </span><span class="n">point</span><span class="p">(</span><span class="n">min</span><span class="p">(</span><span class="n">p1</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="n">p2</span><span class="p">.</span><span class="n">x</span><span class="p">),</span><span class="n">min</span><span class="p">(</span><span class="n">p1</span><span class="p">.</span><span class="n">y</span><span class="p">,</span><span class="n">p2</span><span class="p">.</span><span class="n">y</span><span class="p">),</span><span class="n">min</span><span class="p">(</span><span class="n">p1</span><span class="p">.</span><span class="n">z</span><span class="p">,</span><span class="n">p2</span><span class="p">.</span><span class="n">z</span><span class="p">));}</span>
<span class="linenos">374</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="n">point</span><span class="w"> </span><span class="nf">maxBounds</span><span class="p">(</span><span class="n">point</span><span class="w"> </span><span class="n">p1</span><span class="p">,</span><span class="w"> </span><span class="n">point</span><span class="w"> </span><span class="n">p2</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span><span class="k">return</span><span class="w"> </span><span class="n">point</span><span class="p">(</span><span class="n">max</span><span class="p">(</span><span class="n">p1</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="n">p2</span><span class="p">.</span><span class="n">x</span><span class="p">),</span><span class="n">max</span><span class="p">(</span><span class="n">p1</span><span class="p">.</span><span class="n">y</span><span class="p">,</span><span class="n">p2</span><span class="p">.</span><span class="n">y</span><span class="p">),</span><span class="n">max</span><span class="p">(</span><span class="n">p1</span><span class="p">.</span><span class="n">z</span><span class="p">,</span><span class="n">p2</span><span class="p">.</span><span class="n">z</span><span class="p">));}</span>
<span class="linenos">375</span><span class="w">    </span>
<span class="linenos">376</span><span class="w">    </span><span class="n">ShapeType</span><span class="w"> </span><span class="n">shapeType</span><span class="p">;</span>
<span class="linenos">377</span><span class="w">    </span><span class="n">bounding_box</span><span class="w"> </span><span class="n">boundingBox</span><span class="p">;</span>
<span class="linenos">378</span><span class="w">    </span><span class="n">site_t</span><span class="w"> </span><span class="n">type</span><span class="p">;</span>
<span class="linenos">379</span><span class="w">   </span>
<span class="linenos">380</span><span class="w">    </span><span class="c1">// An orientation for the shape</span>
<span class="linenos">381</span><span class="w">    </span><span class="n">vector</span><span class="w"> </span><span class="n">at</span><span class="p">;</span><span class="w"> </span><span class="c1">// A vector pointing to where the object is heading</span>
<span class="linenos">382</span><span class="w">    </span><span class="n">vector</span><span class="w"> </span><span class="n">up</span><span class="p">;</span><span class="w"> </span><span class="c1">// A vector representing &quot;up&quot;</span>
<span class="linenos">383</span><span class="w">	</span><span class="n">matrix</span><span class="w"> </span><span class="n">rotation</span><span class="p">;</span><span class="w"> </span><span class="c1">// The rotation matrix based on Euler angles that converts a point to the same axes as (at, up)</span>
<span class="linenos">384</span><span class="w"> </span>
<span class="linenos">385</span><span class="w">    </span><span class="k">friend</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">LatticeBuilder</span><span class="p">;</span>
<span class="linenos">386</span><span class="p">};</span>
<span class="linenos">387</span>
<span class="linenos">388</span><span class="p">}</span>
<span class="linenos">389</span><span class="p">}</span>
<span class="linenos">390</span>
<span class="linenos">391</span><span class="cp">#endif</span>
</pre></div>
</div>
</section>
<section id="shape-cpp">
<h3>Shape.cpp<a class="headerlink" href="#shape-cpp" title="Link to this heading">#</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="linenos">  1</span><span class="cm">/*</span>
<span class="linenos">  2</span><span class="cm"> * University of Illinois Open Source License</span>
<span class="linenos">  3</span><span class="cm"> * Copyright 2011-2018 Luthey-Schulten Group,</span>
<span class="linenos">  4</span><span class="cm"> * All rights reserved.</span>
<span class="linenos">  5</span><span class="cm"> *</span>
<span class="linenos">  6</span><span class="cm"> * Developed by: Luthey-Schulten Group</span>
<span class="linenos">  7</span><span class="cm"> *               University of Illinois at Urbana-Champaign</span>
<span class="linenos">  8</span><span class="cm"> *               http://www.scs.uiuc.edu/~schulten</span>
<span class="linenos">  9</span><span class="cm"> *</span>
<span class="linenos"> 10</span><span class="cm"> * Permission is hereby granted, free of charge, to any person obtaining a copy of</span>
<span class="linenos"> 11</span><span class="cm"> * this software and associated documentation files (the Software), to deal with</span>
<span class="linenos"> 12</span><span class="cm"> * the Software without restriction, including without limitation the rights to</span>
<span class="linenos"> 13</span><span class="cm"> * use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies</span>
<span class="linenos"> 14</span><span class="cm"> * of the Software, and to permit persons to whom the Software is furnished to</span>
<span class="linenos"> 15</span><span class="cm"> * do so, subject to the following conditions:</span>
<span class="linenos"> 16</span><span class="cm"> *</span>
<span class="linenos"> 17</span><span class="cm"> * - Redistributions of source code must retain the above copyright notice,</span>
<span class="linenos"> 18</span><span class="cm"> * this list of conditions and the following disclaimers.</span>
<span class="linenos"> 19</span><span class="cm"> *</span>
<span class="linenos"> 20</span><span class="cm"> * - Redistributions in binary form must reproduce the above copyright notice,</span>
<span class="linenos"> 21</span><span class="cm"> * this list of conditions and the following disclaimers in the documentation</span>
<span class="linenos"> 22</span><span class="cm"> * and/or other materials provided with the distribution.</span>
<span class="linenos"> 23</span><span class="cm"> *</span>
<span class="linenos"> 24</span><span class="cm"> * - Neither the names of the Luthey-Schulten Group, University of Illinois at</span>
<span class="linenos"> 25</span><span class="cm"> * Urbana-Champaign, nor the names of its contributors may be used to endorse or</span>
<span class="linenos"> 26</span><span class="cm"> * promote products derived from this Software without specific prior written</span>
<span class="linenos"> 27</span><span class="cm"> * permission.</span>
<span class="linenos"> 28</span><span class="cm"> * </span>
<span class="linenos"> 29</span><span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR</span>
<span class="linenos"> 30</span><span class="cm"> * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,</span>
<span class="linenos"> 31</span><span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL</span>
<span class="linenos"> 32</span><span class="cm"> * THE CONTRIBUTORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR</span>
<span class="linenos"> 33</span><span class="cm"> * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,</span>
<span class="linenos"> 34</span><span class="cm"> * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR</span>
<span class="linenos"> 35</span><span class="cm"> * OTHER DEALINGS WITH THE SOFTWARE.</span>
<span class="linenos"> 36</span><span class="cm"> *</span>
<span class="linenos"> 37</span><span class="cm"> * Author(s): Andrew Magis, Elijah Roberts, Joseph R. Peterson</span>
<span class="linenos"> 38</span><span class="cm"> */</span>
<span class="linenos"> 39</span>
<span class="linenos"> 40</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;config.h&quot;</span>
<span class="linenos"> 41</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;core/Print.h&quot;</span>
<span class="linenos"> 42</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;builder/Shape.h&quot;</span>
<span class="linenos"> 43</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;rdme/Lattice.h&quot;</span>
<span class="linenos"> 44</span>
<span class="linenos"> 45</span>
<span class="linenos"> 46</span><span class="k">namespace</span><span class="w"> </span><span class="nn">lm</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 47</span><span class="k">namespace</span><span class="w"> </span><span class="nn">builder</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 48</span>
<span class="linenos"> 49</span>
<span class="linenos"> 50</span><span class="n">point</span><span class="w"> </span><span class="nf">point::minus</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">vector</span><span class="w"> </span><span class="o">&amp;</span><span class="n">r</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 51</span><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">point</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">r</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="o">-</span><span class="n">r</span><span class="p">.</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">z</span><span class="o">-</span><span class="n">r</span><span class="p">.</span><span class="n">z</span><span class="p">);</span>
<span class="linenos"> 52</span><span class="p">}</span>
<span class="linenos"> 53</span>
<span class="linenos"> 54</span><span class="n">point</span><span class="w"> </span><span class="nf">point::plus</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">vector</span><span class="w"> </span><span class="o">&amp;</span><span class="n">r</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 55</span><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">point</span><span class="p">(</span><span class="n">x</span><span class="o">+</span><span class="n">r</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="o">+</span><span class="n">r</span><span class="p">.</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">z</span><span class="o">+</span><span class="n">r</span><span class="p">.</span><span class="n">z</span><span class="p">);</span>
<span class="linenos"> 56</span><span class="p">}</span>
<span class="linenos"> 57</span>
<span class="linenos"> 58</span>
<span class="linenos"> 59</span><span class="n">si_dist_t</span><span class="w"> </span><span class="nf">vector::length</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 60</span><span class="w">   </span><span class="k">return</span><span class="w"> </span><span class="n">sqrtf</span><span class="p">(</span><span class="n">x</span><span class="o">*</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">y</span><span class="o">*</span><span class="n">y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">z</span><span class="o">*</span><span class="n">z</span><span class="p">);</span>
<span class="linenos"> 61</span><span class="p">}</span>
<span class="linenos"> 62</span>
<span class="linenos"> 63</span><span class="n">vector</span><span class="w"> </span><span class="nf">vector::unitize</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 64</span><span class="w">   </span><span class="n">si_dist_t</span><span class="w"> </span><span class="n">l</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">length</span><span class="p">();</span>
<span class="linenos"> 65</span><span class="w">   </span><span class="k">if</span><span class="p">(</span><span class="n">l</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="linenos"> 66</span><span class="w">     </span><span class="k">return</span><span class="w"> </span><span class="n">vector</span><span class="p">(</span><span class="n">x</span><span class="o">/</span><span class="n">l</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="o">/</span><span class="n">l</span><span class="p">,</span><span class="w"> </span><span class="n">z</span><span class="o">/</span><span class="n">l</span><span class="p">);</span>
<span class="linenos"> 67</span><span class="w">   </span><span class="k">else</span>
<span class="linenos"> 68</span><span class="w">     </span><span class="k">return</span><span class="w"> </span><span class="n">vector</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">);</span>
<span class="linenos"> 69</span><span class="p">}</span>
<span class="linenos"> 70</span>
<span class="linenos"> 71</span>
<span class="linenos"> 72</span><span class="n">si_dist_t</span><span class="w"> </span><span class="nf">vector::dot</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">vector</span><span class="w"> </span><span class="o">&amp;</span><span class="n">r</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 73</span><span class="w">   </span><span class="k">return</span><span class="w"> </span><span class="n">x</span><span class="o">*</span><span class="n">r</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">y</span><span class="o">*</span><span class="n">r</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">z</span><span class="o">*</span><span class="n">r</span><span class="p">.</span><span class="n">z</span><span class="p">;</span>
<span class="linenos"> 74</span><span class="p">}</span>
<span class="linenos"> 75</span>
<span class="linenos"> 76</span><span class="n">vector</span><span class="w"> </span><span class="nf">vector::cross</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">vector</span><span class="w"> </span><span class="o">&amp;</span><span class="n">r</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 77</span><span class="w">   </span><span class="k">return</span><span class="w"> </span><span class="n">vector</span><span class="p">(</span><span class="n">y</span><span class="o">*</span><span class="n">r</span><span class="p">.</span><span class="n">z</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">z</span><span class="o">*</span><span class="n">r</span><span class="p">.</span><span class="n">y</span><span class="p">,</span>
<span class="linenos"> 78</span><span class="w">                 </span><span class="n">z</span><span class="o">*</span><span class="n">r</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">x</span><span class="o">*</span><span class="n">r</span><span class="p">.</span><span class="n">z</span><span class="p">,</span>
<span class="linenos"> 79</span><span class="w">                 </span><span class="n">x</span><span class="o">*</span><span class="n">r</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">y</span><span class="o">*</span><span class="n">r</span><span class="p">.</span><span class="n">x</span><span class="p">);</span>
<span class="linenos"> 80</span><span class="p">}</span>
<span class="linenos"> 81</span>
<span class="linenos"> 82</span><span class="n">vector</span><span class="w"> </span><span class="nf">vector::scale</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">si_dist_t</span><span class="w"> </span><span class="n">r</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 83</span><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">vector</span><span class="p">(</span><span class="n">r</span><span class="o">*</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="o">*</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="o">*</span><span class="n">z</span><span class="p">);</span>
<span class="linenos"> 84</span><span class="p">}</span>
<span class="linenos"> 85</span>
<span class="linenos"> 86</span><span class="n">matrix</span><span class="w"> </span><span class="nf">vector::mult</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">vector</span><span class="w"> </span><span class="o">&amp;</span><span class="n">r</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 87</span><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">matrix</span><span class="p">(</span><span class="n">x</span><span class="o">*</span><span class="n">r</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="o">*</span><span class="n">r</span><span class="p">.</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="o">*</span><span class="n">r</span><span class="p">.</span><span class="n">z</span><span class="p">,</span>
<span class="linenos"> 88</span><span class="w">                </span><span class="n">y</span><span class="o">*</span><span class="n">r</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="o">*</span><span class="n">r</span><span class="p">.</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="o">*</span><span class="n">r</span><span class="p">.</span><span class="n">z</span><span class="p">,</span>
<span class="linenos"> 89</span><span class="w">                </span><span class="n">z</span><span class="o">*</span><span class="n">r</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">z</span><span class="o">*</span><span class="n">r</span><span class="p">.</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">z</span><span class="o">*</span><span class="n">r</span><span class="p">.</span><span class="n">z</span><span class="p">);</span>
<span class="linenos"> 90</span><span class="p">}</span>
<span class="linenos"> 91</span>
<span class="linenos"> 92</span><span class="n">vector</span><span class="w"> </span><span class="nf">vector::mult</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">matrix</span><span class="w"> </span><span class="o">&amp;</span><span class="n">r</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 93</span><span class="w">   </span><span class="k">return</span><span class="w"> </span><span class="n">vector</span><span class="p">(</span><span class="n">x</span><span class="o">*</span><span class="n">r</span><span class="p">.</span><span class="n">m11</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">y</span><span class="o">*</span><span class="n">r</span><span class="p">.</span><span class="n">m21</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">z</span><span class="o">*</span><span class="n">r</span><span class="p">.</span><span class="n">m31</span><span class="p">,</span>
<span class="linenos"> 94</span><span class="w">                 </span><span class="n">y</span><span class="o">*</span><span class="n">r</span><span class="p">.</span><span class="n">m12</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">y</span><span class="o">*</span><span class="n">r</span><span class="p">.</span><span class="n">m22</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">z</span><span class="o">*</span><span class="n">r</span><span class="p">.</span><span class="n">m32</span><span class="p">,</span>
<span class="linenos"> 95</span><span class="w">                 </span><span class="n">z</span><span class="o">*</span><span class="n">r</span><span class="p">.</span><span class="n">m13</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">y</span><span class="o">*</span><span class="n">r</span><span class="p">.</span><span class="n">m23</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">z</span><span class="o">*</span><span class="n">r</span><span class="p">.</span><span class="n">m33</span><span class="p">);</span>
<span class="linenos"> 96</span><span class="p">}</span>
<span class="linenos"> 97</span>
<span class="linenos"> 98</span><span class="n">matrix</span><span class="w"> </span><span class="nf">matrix::transpose</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 99</span><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">matrix</span><span class="p">(</span><span class="n">m11</span><span class="p">,</span><span class="w"> </span><span class="n">m21</span><span class="p">,</span><span class="w"> </span><span class="n">m31</span><span class="p">,</span>
<span class="linenos">100</span><span class="w">                </span><span class="n">m12</span><span class="p">,</span><span class="w"> </span><span class="n">m22</span><span class="p">,</span><span class="w"> </span><span class="n">m32</span><span class="p">,</span>
<span class="linenos">101</span><span class="w">                </span><span class="n">m13</span><span class="p">,</span><span class="w"> </span><span class="n">m23</span><span class="p">,</span><span class="w"> </span><span class="n">m33</span><span class="p">);</span>
<span class="linenos">102</span><span class="p">}</span>
<span class="linenos">103</span>
<span class="linenos">104</span><span class="n">si_dist_t</span><span class="w"> </span><span class="nf">matrix::determinant</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">105</span><span class="w">   </span><span class="k">return</span><span class="w"> </span><span class="n">m11</span><span class="o">*</span><span class="n">m22</span><span class="o">*</span><span class="n">m33</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">m12</span><span class="o">*</span><span class="n">m23</span><span class="o">*</span><span class="n">m31</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">m13</span><span class="o">*</span><span class="n">m21</span><span class="o">*</span><span class="n">m32</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="n">m13</span><span class="o">*</span><span class="n">m22</span><span class="o">*</span><span class="n">m31</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">m12</span><span class="o">*</span><span class="n">m21</span><span class="o">*</span><span class="n">m33</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">m11</span><span class="o">*</span><span class="n">m23</span><span class="o">*</span><span class="n">m32</span><span class="p">);</span>
<span class="linenos">106</span><span class="p">}</span>
<span class="linenos">107</span>
<span class="linenos">108</span><span class="n">si_dist_t</span><span class="w"> </span><span class="nf">matrix::trace</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">109</span><span class="w">   </span><span class="k">return</span><span class="w"> </span><span class="n">m11</span><span class="o">*</span><span class="n">m11</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">m22</span><span class="o">*</span><span class="n">m22</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">m33</span><span class="o">*</span><span class="n">m33</span><span class="p">;</span>
<span class="linenos">110</span><span class="p">}</span>
<span class="linenos">111</span>
<span class="linenos">112</span>
<span class="linenos">113</span><span class="n">vector</span><span class="w"> </span><span class="nf">matrix::mult</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">vector</span><span class="w"> </span><span class="o">&amp;</span><span class="n">r</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">114</span><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">vector</span><span class="p">(</span><span class="n">m11</span><span class="o">*</span><span class="n">r</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">m12</span><span class="o">*</span><span class="n">r</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">m13</span><span class="o">*</span><span class="n">r</span><span class="p">.</span><span class="n">z</span><span class="p">,</span>
<span class="linenos">115</span><span class="w">                </span><span class="n">m21</span><span class="o">*</span><span class="n">r</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">m22</span><span class="o">*</span><span class="n">r</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">m23</span><span class="o">*</span><span class="n">r</span><span class="p">.</span><span class="n">z</span><span class="p">,</span>
<span class="linenos">116</span><span class="w">                </span><span class="n">m31</span><span class="o">*</span><span class="n">r</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">m32</span><span class="o">*</span><span class="n">r</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">m33</span><span class="o">*</span><span class="n">r</span><span class="p">.</span><span class="n">z</span><span class="p">);</span>
<span class="linenos">117</span><span class="p">}</span>
<span class="linenos">118</span>
<span class="linenos">119</span><span class="n">matrix</span><span class="w"> </span><span class="nf">matrix::mult</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">matrix</span><span class="w"> </span><span class="o">&amp;</span><span class="n">r</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">120</span><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">matrix</span><span class="p">(</span><span class="n">m11</span><span class="o">*</span><span class="n">r</span><span class="p">.</span><span class="n">m11</span><span class="o">+</span><span class="n">m12</span><span class="o">*</span><span class="n">r</span><span class="p">.</span><span class="n">m21</span><span class="o">+</span><span class="n">m13</span><span class="o">*</span><span class="n">r</span><span class="p">.</span><span class="n">m31</span><span class="p">,</span><span class="w"> </span><span class="n">m11</span><span class="o">*</span><span class="n">r</span><span class="p">.</span><span class="n">m12</span><span class="o">+</span><span class="n">m12</span><span class="o">*</span><span class="n">r</span><span class="p">.</span><span class="n">m22</span><span class="o">+</span><span class="n">m13</span><span class="o">*</span><span class="n">r</span><span class="p">.</span><span class="n">m32</span><span class="p">,</span><span class="w"> </span><span class="n">m11</span><span class="o">*</span><span class="n">r</span><span class="p">.</span><span class="n">m13</span><span class="o">+</span><span class="n">m12</span><span class="o">*</span><span class="n">r</span><span class="p">.</span><span class="n">m23</span><span class="o">+</span><span class="n">m13</span><span class="o">*</span><span class="n">r</span><span class="p">.</span><span class="n">m33</span><span class="p">,</span>
<span class="linenos">121</span><span class="w">                </span><span class="n">m21</span><span class="o">*</span><span class="n">r</span><span class="p">.</span><span class="n">m11</span><span class="o">+</span><span class="n">m22</span><span class="o">*</span><span class="n">r</span><span class="p">.</span><span class="n">m21</span><span class="o">+</span><span class="n">m23</span><span class="o">*</span><span class="n">r</span><span class="p">.</span><span class="n">m31</span><span class="p">,</span><span class="w"> </span><span class="n">m21</span><span class="o">*</span><span class="n">r</span><span class="p">.</span><span class="n">m12</span><span class="o">+</span><span class="n">m22</span><span class="o">*</span><span class="n">r</span><span class="p">.</span><span class="n">m22</span><span class="o">+</span><span class="n">m23</span><span class="o">*</span><span class="n">r</span><span class="p">.</span><span class="n">m32</span><span class="p">,</span><span class="w"> </span><span class="n">m21</span><span class="o">*</span><span class="n">r</span><span class="p">.</span><span class="n">m13</span><span class="o">+</span><span class="n">m22</span><span class="o">*</span><span class="n">r</span><span class="p">.</span><span class="n">m23</span><span class="o">+</span><span class="n">m23</span><span class="o">*</span><span class="n">r</span><span class="p">.</span><span class="n">m33</span><span class="p">,</span>
<span class="linenos">122</span><span class="w">                </span><span class="n">m31</span><span class="o">*</span><span class="n">r</span><span class="p">.</span><span class="n">m11</span><span class="o">+</span><span class="n">m32</span><span class="o">*</span><span class="n">r</span><span class="p">.</span><span class="n">m21</span><span class="o">+</span><span class="n">m33</span><span class="o">*</span><span class="n">r</span><span class="p">.</span><span class="n">m31</span><span class="p">,</span><span class="w"> </span><span class="n">m31</span><span class="o">*</span><span class="n">r</span><span class="p">.</span><span class="n">m12</span><span class="o">+</span><span class="n">m32</span><span class="o">*</span><span class="n">r</span><span class="p">.</span><span class="n">m22</span><span class="o">+</span><span class="n">m33</span><span class="o">*</span><span class="n">r</span><span class="p">.</span><span class="n">m32</span><span class="p">,</span><span class="w"> </span><span class="n">m31</span><span class="o">*</span><span class="n">r</span><span class="p">.</span><span class="n">m13</span><span class="o">+</span><span class="n">m32</span><span class="o">*</span><span class="n">r</span><span class="p">.</span><span class="n">m23</span><span class="o">+</span><span class="n">m33</span><span class="o">*</span><span class="n">r</span><span class="p">.</span><span class="n">m33</span><span class="p">);</span>
<span class="linenos">123</span><span class="p">}</span>
<span class="linenos">124</span>
<span class="linenos">125</span>
<span class="linenos">126</span>
<span class="linenos">127</span>
<span class="linenos">128</span><span class="c1">// Shape Class //</span>
<span class="linenos">129</span><span class="n">Shape</span><span class="o">::</span><span class="n">Shape</span><span class="p">(</span><span class="n">ShapeType</span><span class="w"> </span><span class="n">shapeType</span><span class="p">,</span><span class="w"> </span><span class="n">bounding_box</span><span class="w"> </span><span class="n">boundingBox</span><span class="p">,</span><span class="w"> </span><span class="n">site_t</span><span class="w"> </span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="n">vector</span><span class="w"> </span><span class="n">at</span><span class="p">,</span><span class="w"> </span><span class="n">vector</span><span class="w"> </span><span class="n">up</span><span class="p">)</span>
<span class="linenos">130</span><span class="o">:</span><span class="n">shapeType</span><span class="p">(</span><span class="n">shapeType</span><span class="p">),</span><span class="n">boundingBox</span><span class="p">(</span><span class="n">boundingBox</span><span class="p">),</span><span class="n">type</span><span class="p">(</span><span class="n">type</span><span class="p">),</span><span class="n">at</span><span class="p">(</span><span class="n">at</span><span class="p">),</span><span class="n">up</span><span class="p">(</span><span class="n">up</span><span class="p">)</span>
<span class="linenos">131</span><span class="p">{</span>
<span class="linenos">132</span><span class="w">  </span><span class="c1">// Determine angles between at and up</span>
<span class="linenos">133</span><span class="w">  </span><span class="kt">double</span><span class="w"> </span><span class="n">phi</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span><span class="w"> </span><span class="c1">// Rotation about x</span>
<span class="linenos">134</span><span class="w">  </span><span class="kt">double</span><span class="w"> </span><span class="n">theta</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span><span class="w"> </span><span class="c1">// Rotation about y</span>
<span class="linenos">135</span><span class="w">  </span><span class="kt">double</span><span class="w"> </span><span class="n">psi</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span><span class="w"> </span><span class="c1">// Rotation about z</span>
<span class="linenos">136</span>
<span class="linenos">137</span><span class="w">  </span><span class="c1">// Determine unitized vectors</span>
<span class="linenos">138</span><span class="w">  </span><span class="n">vector</span><span class="w"> </span><span class="n">Xvec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">at</span><span class="p">.</span><span class="n">unitize</span><span class="p">();</span><span class="w">     </span><span class="c1">// X in the rotated frame</span>
<span class="linenos">139</span><span class="w">  </span><span class="n">vector</span><span class="w"> </span><span class="n">Yvec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">up</span><span class="p">.</span><span class="n">unitize</span><span class="p">();</span><span class="w">     </span><span class="c1">// Y in the rotated frame</span>
<span class="linenos">140</span><span class="w">  </span><span class="n">vector</span><span class="w"> </span><span class="n">Zvec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Xvec</span><span class="p">.</span><span class="n">cross</span><span class="p">(</span><span class="n">Yvec</span><span class="p">);</span><span class="w"> </span><span class="c1">// Z in the rotated frame</span>
<span class="linenos">141</span>
<span class="linenos">142</span><span class="c1">//  std::cout &lt;&lt; &quot;X (&quot;&lt;&lt; Xvec.x &lt;&lt; &quot;,&quot; &lt;&lt; Xvec.y &lt;&lt; &quot;,&quot; &lt;&lt; Xvec.z &lt;&lt; &quot;)&quot; &lt;&lt; std::endl;</span>
<span class="linenos">143</span><span class="c1">//  std::cout &lt;&lt; &quot;Y (&quot;&lt;&lt; Yvec.x &lt;&lt; &quot;,&quot; &lt;&lt; Yvec.y &lt;&lt; &quot;,&quot; &lt;&lt; Yvec.z &lt;&lt; &quot;)&quot; &lt;&lt; std::endl;</span>
<span class="linenos">144</span><span class="c1">//  std::cout &lt;&lt; &quot;Z (&quot;&lt;&lt; Zvec.x &lt;&lt; &quot;,&quot; &lt;&lt; Zvec.y &lt;&lt; &quot;,&quot; &lt;&lt; Zvec.z &lt;&lt; &quot;)&quot; &lt;&lt; std::endl &lt;&lt; std::endl;</span>
<span class="linenos">145</span>
<span class="linenos">146</span>
<span class="linenos">147</span><span class="w">  </span><span class="n">phi</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">atan2</span><span class="p">(</span><span class="n">Zvec</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">Zvec</span><span class="p">.</span><span class="n">y</span><span class="p">);</span>
<span class="linenos">148</span><span class="w">  </span><span class="n">theta</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">acos</span><span class="p">(</span><span class="n">Zvec</span><span class="p">.</span><span class="n">z</span><span class="p">);</span>
<span class="linenos">149</span><span class="w">  </span><span class="n">psi</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">atan2</span><span class="p">(</span><span class="n">Yvec</span><span class="p">.</span><span class="n">z</span><span class="p">,</span><span class="w"> </span><span class="n">Xvec</span><span class="p">.</span><span class="n">z</span><span class="p">);</span>
<span class="linenos">150</span>
<span class="linenos">151</span><span class="w">  </span><span class="n">Print</span><span class="o">::</span><span class="n">printf</span><span class="p">(</span><span class="n">Print</span><span class="o">::</span><span class="n">DEBUG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;phi:%.4g</span><span class="se">\t</span><span class="s">theta:%.4g</span><span class="se">\t</span><span class="s">psi:%.4g&quot;</span><span class="p">,</span><span class="n">phi</span><span class="p">,</span><span class="n">theta</span><span class="p">,</span><span class="n">psi</span><span class="p">);</span>
<span class="linenos">152</span>
<span class="linenos">153</span><span class="w">  </span><span class="c1">// Determine the rotation matrix</span>
<span class="linenos">154</span><span class="w">  </span><span class="n">rotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">matrix</span><span class="o">::</span><span class="n">eulerMatrixFromAngles</span><span class="p">(</span><span class="n">phi</span><span class="p">,</span><span class="w"> </span><span class="n">theta</span><span class="p">,</span><span class="w"> </span><span class="n">psi</span><span class="p">);</span>
<span class="linenos">155</span><span class="p">}</span>
<span class="linenos">156</span>
<span class="linenos">157</span><span class="n">Shape</span><span class="o">::~</span><span class="n">Shape</span><span class="p">()</span>
<span class="linenos">158</span><span class="p">{</span>
<span class="linenos">159</span><span class="p">}</span>
<span class="linenos">160</span>
<span class="linenos">161</span><span class="kt">bool</span><span class="w"> </span><span class="n">Shape</span><span class="o">::</span><span class="n">boundingBoxesIntersect</span><span class="p">(</span><span class="n">Shape</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">query</span><span class="p">)</span>
<span class="linenos">162</span><span class="p">{</span>
<span class="linenos">163</span><span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">xOverlap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">query</span><span class="o">-&gt;</span><span class="n">boundingBox</span><span class="p">.</span><span class="n">max</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">boundingBox</span><span class="p">.</span><span class="n">min</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">query</span><span class="o">-&gt;</span><span class="n">boundingBox</span><span class="p">.</span><span class="n">min</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">boundingBox</span><span class="p">.</span><span class="n">max</span><span class="p">.</span><span class="n">x</span><span class="p">);</span>
<span class="linenos">164</span><span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">yOverlap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">query</span><span class="o">-&gt;</span><span class="n">boundingBox</span><span class="p">.</span><span class="n">max</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">boundingBox</span><span class="p">.</span><span class="n">min</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">query</span><span class="o">-&gt;</span><span class="n">boundingBox</span><span class="p">.</span><span class="n">min</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">boundingBox</span><span class="p">.</span><span class="n">max</span><span class="p">.</span><span class="n">y</span><span class="p">);</span>
<span class="linenos">165</span><span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">zOverlap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">query</span><span class="o">-&gt;</span><span class="n">boundingBox</span><span class="p">.</span><span class="n">max</span><span class="p">.</span><span class="n">z</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">boundingBox</span><span class="p">.</span><span class="n">min</span><span class="p">.</span><span class="n">z</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">query</span><span class="o">-&gt;</span><span class="n">boundingBox</span><span class="p">.</span><span class="n">min</span><span class="p">.</span><span class="n">z</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">boundingBox</span><span class="p">.</span><span class="n">max</span><span class="p">.</span><span class="n">z</span><span class="p">);</span>
<span class="linenos">166</span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">xOverlap</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">yOverlap</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">zOverlap</span><span class="p">;</span>
<span class="linenos">167</span><span class="p">}</span>
<span class="linenos">168</span>
<span class="linenos">169</span><span class="kt">void</span><span class="w"> </span><span class="n">Shape</span><span class="o">::</span><span class="n">discretizeTo</span><span class="p">(</span><span class="n">lm</span><span class="o">::</span><span class="n">rdme</span><span class="o">::</span><span class="n">Lattice</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">lattice</span><span class="p">)</span>
<span class="linenos">170</span><span class="p">{</span>
<span class="linenos">171</span><span class="w">	</span><span class="c1">// Get the starting and ending subvolumes coordinates.</span>
<span class="linenos">172</span><span class="w">	</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">x1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">lattice_size_t</span><span class="p">)</span><span class="w"> </span><span class="n">max</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="n">floor</span><span class="p">(</span><span class="n">boundingBox</span><span class="p">.</span><span class="n">min</span><span class="p">.</span><span class="n">x</span><span class="o">/</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getSpacing</span><span class="p">()));</span>
<span class="linenos">173</span><span class="w">	</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">x2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="n">lattice_size_t</span><span class="p">)</span><span class="n">floor</span><span class="p">(</span><span class="n">boundingBox</span><span class="p">.</span><span class="n">max</span><span class="p">.</span><span class="n">x</span><span class="o">/</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getSpacing</span><span class="p">()))</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
<span class="linenos">174</span><span class="w">	</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">y1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">lattice_size_t</span><span class="p">)</span><span class="w"> </span><span class="n">max</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="n">floor</span><span class="p">(</span><span class="n">boundingBox</span><span class="p">.</span><span class="n">min</span><span class="p">.</span><span class="n">y</span><span class="o">/</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getSpacing</span><span class="p">()));</span>
<span class="linenos">175</span><span class="w">	</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">y2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="n">lattice_size_t</span><span class="p">)</span><span class="n">floor</span><span class="p">(</span><span class="n">boundingBox</span><span class="p">.</span><span class="n">max</span><span class="p">.</span><span class="n">y</span><span class="o">/</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getSpacing</span><span class="p">()))</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
<span class="linenos">176</span><span class="w">	</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">lattice_size_t</span><span class="p">)</span><span class="w"> </span><span class="n">max</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="n">floor</span><span class="p">(</span><span class="n">boundingBox</span><span class="p">.</span><span class="n">min</span><span class="p">.</span><span class="n">z</span><span class="o">/</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getSpacing</span><span class="p">()));</span>
<span class="linenos">177</span><span class="w">	</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">z2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="n">lattice_size_t</span><span class="p">)</span><span class="n">floor</span><span class="p">(</span><span class="n">boundingBox</span><span class="p">.</span><span class="n">max</span><span class="p">.</span><span class="n">z</span><span class="o">/</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getSpacing</span><span class="p">()))</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
<span class="linenos">178</span><span class="w">    </span>
<span class="linenos">179</span><span class="w">    </span><span class="c1">// Constrain to the RDME domain</span>
<span class="linenos">180</span><span class="w">    </span><span class="n">x1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">::</span><span class="n">max</span><span class="p">((</span><span class="n">lattice_size_t</span><span class="p">)</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">x1</span><span class="p">);</span>
<span class="linenos">181</span><span class="w">    </span><span class="n">y1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">::</span><span class="n">max</span><span class="p">((</span><span class="n">lattice_size_t</span><span class="p">)</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">y1</span><span class="p">);</span>
<span class="linenos">182</span><span class="w">    </span><span class="n">z1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">::</span><span class="n">max</span><span class="p">((</span><span class="n">lattice_size_t</span><span class="p">)</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">z1</span><span class="p">);</span>
<span class="linenos">183</span><span class="w">    </span><span class="n">x2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">::</span><span class="n">min</span><span class="p">(</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getXSize</span><span class="p">()</span><span class="mi">-1</span><span class="p">,</span><span class="w"> </span><span class="n">x2</span><span class="p">);</span>
<span class="linenos">184</span><span class="w">    </span><span class="n">y2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">::</span><span class="n">min</span><span class="p">(</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getYSize</span><span class="p">()</span><span class="mi">-1</span><span class="p">,</span><span class="w"> </span><span class="n">y2</span><span class="p">);</span>
<span class="linenos">185</span><span class="w">    </span><span class="n">z2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">::</span><span class="n">min</span><span class="p">(</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getZSize</span><span class="p">()</span><span class="mi">-1</span><span class="p">,</span><span class="w"> </span><span class="n">z2</span><span class="p">);</span>
<span class="linenos">186</span>
<span class="linenos">187</span><span class="w">	</span><span class="c1">// Go through each subvolume that contains a portion of this shape.</span>
<span class="linenos">188</span><span class="w">	</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x1</span><span class="p">;</span><span class="w"> </span><span class="n">x</span><span class="o">&lt;=</span><span class="n">x2</span><span class="p">;</span><span class="w"> </span><span class="n">x</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">189</span><span class="w">		</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">y1</span><span class="p">;</span><span class="w"> </span><span class="n">y</span><span class="o">&lt;=</span><span class="n">y2</span><span class="p">;</span><span class="w"> </span><span class="n">y</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">190</span><span class="w">			</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">z1</span><span class="p">;</span><span class="w"> </span><span class="n">z</span><span class="o">&lt;=</span><span class="n">z2</span><span class="p">;</span><span class="w"> </span><span class="n">z</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">191</span><span class="w">			</span><span class="p">{</span>
<span class="linenos">192</span><span class="w">				</span><span class="c1">// If the center of this subvolume is in the cuboid, mark it as part of the shape.</span>
<span class="linenos">193</span><span class="w">				</span><span class="n">point</span><span class="w"> </span><span class="nf">c</span><span class="p">((((</span><span class="kt">double</span><span class="p">)</span><span class="n">x</span><span class="p">)</span><span class="o">+</span><span class="mf">0.5</span><span class="p">)</span><span class="o">*</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getSpacing</span><span class="p">(),</span><span class="w"> </span><span class="p">(((</span><span class="kt">double</span><span class="p">)</span><span class="n">y</span><span class="p">)</span><span class="o">+</span><span class="mf">0.5</span><span class="p">)</span><span class="o">*</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getSpacing</span><span class="p">(),</span><span class="w"> </span><span class="p">(((</span><span class="kt">double</span><span class="p">)</span><span class="n">z</span><span class="p">)</span><span class="o">+</span><span class="mf">0.5</span><span class="p">)</span><span class="o">*</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getSpacing</span><span class="p">());</span>
<span class="linenos">194</span><span class="w">				</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">contains</span><span class="p">(</span><span class="n">c</span><span class="p">))</span><span class="w"> </span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">setSiteType</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">z</span><span class="p">,</span><span class="w"> </span><span class="n">type</span><span class="p">);</span>
<span class="linenos">195</span><span class="w">			</span><span class="p">}</span>
<span class="linenos">196</span><span class="p">}</span>
<span class="linenos">197</span>
<span class="linenos">198</span><span class="w">    </span>
<span class="linenos">199</span><span class="c1">// Functions used for Monte-Carlo integration of volume</span>
<span class="linenos">200</span><span class="kt">double</span><span class="w"> </span><span class="n">Shape</span><span class="o">::</span><span class="n">integrateToPercentThreshold</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">percent</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">201</span><span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">bbVol</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">boundingBox</span><span class="p">.</span><span class="n">volume</span><span class="p">();</span>
<span class="linenos">202</span><span class="w">    </span><span class="n">srand</span><span class="p">(</span><span class="n">time</span><span class="p">(</span><span class="nb">NULL</span><span class="p">));</span>
<span class="linenos">203</span><span class="w">    </span>
<span class="linenos">204</span><span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">totalPoints</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>
<span class="linenos">205</span><span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">pointsInside</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>
<span class="linenos">206</span><span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">volumeThreshold</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">percent</span><span class="o">/</span><span class="mf">100.0</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">bbVol</span><span class="p">;</span>
<span class="linenos">207</span><span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">delta</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">66e6</span><span class="p">;</span>
<span class="linenos">208</span><span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">lastChangedValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">66e6</span><span class="p">;</span>
<span class="linenos">209</span><span class="w">    </span><span class="k">while</span><span class="p">(</span><span class="n">delta</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">volumeThreshold</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">210</span><span class="w">        </span><span class="n">totalPoints</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mf">1.0</span><span class="p">;</span>
<span class="linenos">211</span><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">contains</span><span class="p">(</span><span class="n">boundingBox</span><span class="p">.</span><span class="n">randomPointInside</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">212</span><span class="w">            </span><span class="n">pointsInside</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mf">1.0</span><span class="p">;</span>
<span class="linenos">213</span><span class="w">            </span><span class="n">delta</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fabs</span><span class="p">(</span><span class="n">lastChangedValue</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="n">pointsInside</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">totalPoints</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">bbVol</span><span class="p">);</span>
<span class="linenos">214</span><span class="w">            </span><span class="n">lastChangedValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">pointsInside</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">totalPoints</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">bbVol</span><span class="p">;</span>
<span class="linenos">215</span><span class="w">        </span><span class="p">}</span>
<span class="linenos">216</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">217</span><span class="w">    </span>
<span class="linenos">218</span><span class="w">    </span>
<span class="linenos">219</span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">pointsInside</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">totalPoints</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">bbVol</span><span class="p">;</span>
<span class="linenos">220</span><span class="p">}</span>
<span class="linenos">221</span><span class="kt">double</span><span class="w"> </span><span class="n">Shape</span><span class="o">::</span><span class="n">integrateToCount</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1000000</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">222</span><span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">bbVol</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">boundingBox</span><span class="p">.</span><span class="n">volume</span><span class="p">();</span>
<span class="linenos">223</span><span class="w">    </span><span class="n">srand</span><span class="p">(</span><span class="n">time</span><span class="p">(</span><span class="nb">NULL</span><span class="p">));</span>
<span class="linenos">224</span><span class="w">    </span>
<span class="linenos">225</span><span class="w">    </span><span class="c1">// Count fraction of random points that end up inside</span>
<span class="linenos">226</span><span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">pointsInside</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>
<span class="linenos">227</span><span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">count</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">228</span><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">contains</span><span class="p">(</span><span class="n">boundingBox</span><span class="p">.</span><span class="n">randomPointInside</span><span class="p">()))</span>
<span class="linenos">229</span><span class="w">            </span><span class="n">pointsInside</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mf">1.0</span><span class="p">;</span>
<span class="linenos">230</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">231</span><span class="w">    </span>
<span class="linenos">232</span><span class="w">    </span><span class="c1">// Return fraction of volume that is inside points</span>
<span class="linenos">233</span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">pointsInside</span><span class="o">/</span><span class="n">count</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">bbVol</span><span class="p">;</span>
<span class="linenos">234</span><span class="p">}</span>
<span class="linenos">235</span><span class="w">    </span>
<span class="linenos">236</span><span class="w">    </span>
<span class="linenos">237</span><span class="w">    </span>
<span class="linenos">238</span><span class="p">}</span>
<span class="linenos">239</span><span class="p">}</span>
</pre></div>
</div>
</section>
<section id="hemisphere-h">
<h3>Hemisphere.h<a class="headerlink" href="#hemisphere-h" title="Link to this heading">#</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cm">/*</span>
<span class="linenos"> 2</span><span class="cm"> * University of Illinois Open Source License</span>
<span class="linenos"> 3</span><span class="cm"> * Copyright 2011-2018 Luthey-Schulten Group,</span>
<span class="linenos"> 4</span><span class="cm"> * All rights reserved.</span>
<span class="linenos"> 5</span><span class="cm"> *</span>
<span class="linenos"> 6</span><span class="cm"> * Developed by: Luthey-Schulten Group</span>
<span class="linenos"> 7</span><span class="cm"> *               University of Illinois at Urbana-Champaign</span>
<span class="linenos"> 8</span><span class="cm"> *               http://www.scs.uiuc.edu/~schulten</span>
<span class="linenos"> 9</span><span class="cm"> *</span>
<span class="linenos">10</span><span class="cm"> * Permission is hereby granted, free of charge, to any person obtaining a copy of</span>
<span class="linenos">11</span><span class="cm"> * this software and associated documentation files (the Software), to deal with</span>
<span class="linenos">12</span><span class="cm"> * the Software without restriction, including without limitation the rights to</span>
<span class="linenos">13</span><span class="cm"> * use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies</span>
<span class="linenos">14</span><span class="cm"> * of the Software, and to permit persons to whom the Software is furnished to</span>
<span class="linenos">15</span><span class="cm"> * do so, subject to the following conditions:</span>
<span class="linenos">16</span><span class="cm"> *</span>
<span class="linenos">17</span><span class="cm"> * - Redistributions of source code must retain the above copyright notice,</span>
<span class="linenos">18</span><span class="cm"> * this list of conditions and the following disclaimers.</span>
<span class="linenos">19</span><span class="cm"> *</span>
<span class="linenos">20</span><span class="cm"> * - Redistributions in binary form must reproduce the above copyright notice,</span>
<span class="linenos">21</span><span class="cm"> * this list of conditions and the following disclaimers in the documentation</span>
<span class="linenos">22</span><span class="cm"> * and/or other materials provided with the distribution.</span>
<span class="linenos">23</span><span class="cm"> *</span>
<span class="linenos">24</span><span class="cm"> * - Neither the names of the Luthey-Schulten Group, University of Illinois at</span>
<span class="linenos">25</span><span class="cm"> * Urbana-Champaign, nor the names of its contributors may be used to endorse or</span>
<span class="linenos">26</span><span class="cm"> * promote products derived from this Software without specific prior written</span>
<span class="linenos">27</span><span class="cm"> * permission.</span>
<span class="linenos">28</span><span class="cm"> *</span>
<span class="linenos">29</span><span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR</span>
<span class="linenos">30</span><span class="cm"> * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,</span>
<span class="linenos">31</span><span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL</span>
<span class="linenos">32</span><span class="cm"> * THE CONTRIBUTORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR</span>
<span class="linenos">33</span><span class="cm"> * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,</span>
<span class="linenos">34</span><span class="cm"> * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR</span>
<span class="linenos">35</span><span class="cm"> * OTHER DEALINGS WITH THE SOFTWARE.</span>
<span class="linenos">36</span><span class="cm"> *</span>
<span class="linenos">37</span><span class="cm"> * Author(s): Andrew Magis, Elijah Roberts</span>
<span class="linenos">38</span><span class="cm"> */</span>
<span class="linenos">39</span>
<span class="linenos">40</span><span class="cp">#ifndef LM_BUILDER_HEMISPHERE_H_</span>
<span class="linenos">41</span><span class="cp">#define LM_BUILDER_HEMISPHERE_H_</span>
<span class="linenos">42</span>
<span class="linenos">43</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;builder/Shape.h&quot;</span>
<span class="linenos">44</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;rdme/Lattice.h&quot;</span>
<span class="linenos">45</span>
<span class="linenos">46</span><span class="k">namespace</span><span class="w"> </span><span class="nn">lm</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">47</span><span class="k">namespace</span><span class="w"> </span><span class="nn">builder</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">48</span>
<span class="linenos">49</span><span class="c1">/// @class Hemisphere</span>
<span class="linenos">50</span><span class="c1">/// @brief A hemisphere Shape</span>
<span class="linenos">51</span><span class="k">class</span><span class="w"> </span><span class="nc">Hemisphere</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">Shape</span>
<span class="linenos">52</span><span class="p">{</span>
<span class="linenos">53</span><span class="k">public</span><span class="o">:</span>
<span class="linenos">54</span><span class="w">    </span><span class="c1">/// @brief Create a Hemisphere</span>
<span class="linenos">55</span><span class="w">    </span><span class="c1">/// @param center Point center of the circle of the slice plane through the Hemisphere</span>
<span class="linenos">56</span><span class="w">    </span><span class="c1">/// @param radius Radius of the Hemisphere</span>
<span class="linenos">57</span><span class="w">    </span><span class="c1">/// @param orientation Orientation normal to the center point of the center point in the direction of the curved part of the hemisphere</span>
<span class="linenos">58</span><span class="w">    </span><span class="c1">/// @param type The type of the sites within the hemisphere</span>
<span class="linenos">59</span><span class="w">    </span><span class="n">Hemisphere</span><span class="p">(</span><span class="n">point</span><span class="w"> </span><span class="n">center</span><span class="p">,</span><span class="w"> </span><span class="n">si_dist_t</span><span class="w"> </span><span class="n">radius</span><span class="p">,</span><span class="w"> </span><span class="n">vector</span><span class="w"> </span><span class="n">orientation</span><span class="p">,</span><span class="w"> </span><span class="n">site_t</span><span class="w"> </span><span class="n">type</span><span class="p">);</span>
<span class="linenos">60</span><span class="w">    </span><span class="c1">/// @brief Destroy the Hemisphere</span>
<span class="linenos">61</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="o">~</span><span class="n">Hemisphere</span><span class="p">();</span>
<span class="linenos">62</span><span class="w">    </span>
<span class="linenos">63</span><span class="w">    </span><span class="c1">/// @brief Check if two shapes intersect</span>
<span class="linenos">64</span><span class="w">    </span><span class="c1">/// @param query The other shape to check</span>
<span class="linenos">65</span><span class="w">    </span><span class="c1">/// @return true/false</span>
<span class="linenos">66</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="nf">intersects</span><span class="p">(</span><span class="n">Shape</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">query</span><span class="p">);</span>
<span class="linenos">67</span><span class="w">    </span><span class="c1">/// @brief Determine if the shape contains the specified point</span>
<span class="linenos">68</span><span class="w">    </span><span class="c1">/// @param query Point to test</span>
<span class="linenos">69</span><span class="w">    </span><span class="c1">/// @return true/false</span>
<span class="linenos">70</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="nf">contains</span><span class="p">(</span><span class="n">point</span><span class="w"> </span><span class="n">query</span><span class="p">);</span>
<span class="linenos">71</span><span class="w">    </span><span class="c1">/// @brief Determine if the shape contains the specified shape</span>
<span class="linenos">72</span><span class="w">    </span><span class="c1">/// @param query Shape to test</span>
<span class="linenos">73</span><span class="w">    </span><span class="c1">/// @return true/false</span>
<span class="linenos">74</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="nf">contains</span><span class="p">(</span><span class="n">Shape</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">query</span><span class="p">);</span>
<span class="linenos">75</span><span class="w">    </span><span class="c1">/// @brief Get the center of the Hemisphere</span>
<span class="linenos">76</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="n">point</span><span class="w"> </span><span class="nf">getCenter</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="k">return</span><span class="w"> </span><span class="n">center</span><span class="p">;}</span>
<span class="linenos">77</span><span class="w">    </span><span class="c1">/// @brief Get the radius of the Hemisphere</span>
<span class="linenos">78</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="n">si_dist_t</span><span class="w"> </span><span class="nf">getRadius</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="k">return</span><span class="w"> </span><span class="n">radius</span><span class="p">;}</span>
<span class="linenos">79</span><span class="w">    </span><span class="c1">/// @brief Get the orientation vector of the Hemisphere</span>
<span class="linenos">80</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="n">vector</span><span class="w"> </span><span class="nf">getOrientation</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="k">return</span><span class="w"> </span><span class="n">orientation</span><span class="p">;}</span>
<span class="linenos">81</span><span class="w">    </span><span class="c1">/// @brief Get the volume contained by the Hemisphere</span>
<span class="linenos">82</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="nf">getVolume</span><span class="p">();</span>
<span class="linenos">83</span>
<span class="linenos">84</span><span class="k">protected</span><span class="o">:</span>
<span class="linenos">85</span><span class="w">    </span><span class="n">point</span><span class="w"> </span><span class="n">center</span><span class="p">;</span>
<span class="linenos">86</span><span class="w">    </span><span class="n">si_dist_t</span><span class="w"> </span><span class="n">radius</span><span class="p">;</span>
<span class="linenos">87</span><span class="w">    </span><span class="n">vector</span><span class="w"> </span><span class="n">orientation</span><span class="p">;</span>
<span class="linenos">88</span><span class="p">};</span>
<span class="linenos">89</span>
<span class="linenos">90</span><span class="p">}</span>
<span class="linenos">91</span><span class="p">}</span>
<span class="linenos">92</span>
<span class="linenos">93</span><span class="cp">#endif</span>
</pre></div>
</div>
</section>
<section id="hemisphere-cpp">
<h3>Hemisphere.cpp<a class="headerlink" href="#hemisphere-cpp" title="Link to this heading">#</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="linenos">  1</span><span class="cm">/*</span>
<span class="linenos">  2</span><span class="cm"> * University of Illinois Open Source License</span>
<span class="linenos">  3</span><span class="cm"> * Copyright 2011-2018 Luthey-Schulten Group,</span>
<span class="linenos">  4</span><span class="cm"> * All rights reserved.</span>
<span class="linenos">  5</span><span class="cm"> *</span>
<span class="linenos">  6</span><span class="cm"> * Developed by: Luthey-Schulten Group</span>
<span class="linenos">  7</span><span class="cm"> *               University of Illinois at Urbana-Champaign</span>
<span class="linenos">  8</span><span class="cm"> *               http://www.scs.uiuc.edu/~schulten</span>
<span class="linenos">  9</span><span class="cm"> *</span>
<span class="linenos"> 10</span><span class="cm"> * Permission is hereby granted, free of charge, to any person obtaining a copy of</span>
<span class="linenos"> 11</span><span class="cm"> * this software and associated documentation files (the Software), to deal with</span>
<span class="linenos"> 12</span><span class="cm"> * the Software without restriction, including without limitation the rights to</span>
<span class="linenos"> 13</span><span class="cm"> * use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies</span>
<span class="linenos"> 14</span><span class="cm"> * of the Software, and to permit persons to whom the Software is furnished to</span>
<span class="linenos"> 15</span><span class="cm"> * do so, subject to the following conditions:</span>
<span class="linenos"> 16</span><span class="cm"> *</span>
<span class="linenos"> 17</span><span class="cm"> * - Redistributions of source code must retain the above copyright notice,</span>
<span class="linenos"> 18</span><span class="cm"> * this list of conditions and the following disclaimers.</span>
<span class="linenos"> 19</span><span class="cm"> *</span>
<span class="linenos"> 20</span><span class="cm"> * - Redistributions in binary form must reproduce the above copyright notice,</span>
<span class="linenos"> 21</span><span class="cm"> * this list of conditions and the following disclaimers in the documentation</span>
<span class="linenos"> 22</span><span class="cm"> * and/or other materials provided with the distribution.</span>
<span class="linenos"> 23</span><span class="cm"> *</span>
<span class="linenos"> 24</span><span class="cm"> * - Neither the names of the Luthey-Schulten Group, University of Illinois at</span>
<span class="linenos"> 25</span><span class="cm"> * Urbana-Champaign, nor the names of its contributors may be used to endorse or</span>
<span class="linenos"> 26</span><span class="cm"> * promote products derived from this Software without specific prior written</span>
<span class="linenos"> 27</span><span class="cm"> * permission.</span>
<span class="linenos"> 28</span><span class="cm"> *</span>
<span class="linenos"> 29</span><span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR</span>
<span class="linenos"> 30</span><span class="cm"> * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,</span>
<span class="linenos"> 31</span><span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL</span>
<span class="linenos"> 32</span><span class="cm"> * THE CONTRIBUTORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR</span>
<span class="linenos"> 33</span><span class="cm"> * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,</span>
<span class="linenos"> 34</span><span class="cm"> * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR</span>
<span class="linenos"> 35</span><span class="cm"> * OTHER DEALINGS WITH THE SOFTWARE.</span>
<span class="linenos"> 36</span><span class="cm"> *</span>
<span class="linenos"> 37</span><span class="cm"> * Author(s): Andrew Magis, Elijah Roberts</span>
<span class="linenos"> 38</span><span class="cm"> */</span>
<span class="linenos"> 39</span>
<span class="linenos"> 40</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;config.h&quot;</span>
<span class="linenos"> 41</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;builder/Shape.h&quot;</span>
<span class="linenos"> 42</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;builder/Hemisphere.h&quot;</span>
<span class="linenos"> 43</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;builder/Sphere.h&quot;</span>
<span class="linenos"> 44</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;rdme/Lattice.h&quot;</span>
<span class="linenos"> 45</span>
<span class="linenos"> 46</span><span class="k">namespace</span><span class="w"> </span><span class="nn">lm</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 47</span><span class="k">namespace</span><span class="w"> </span><span class="nn">builder</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 48</span>
<span class="linenos"> 49</span><span class="n">Hemisphere</span><span class="o">::</span><span class="n">Hemisphere</span><span class="p">(</span><span class="n">point</span><span class="w"> </span><span class="n">center</span><span class="p">,</span><span class="w"> </span><span class="n">si_dist_t</span><span class="w"> </span><span class="n">radius</span><span class="p">,</span><span class="w"> </span><span class="n">vector</span><span class="w"> </span><span class="n">orientation</span><span class="p">,</span><span class="w"> </span><span class="n">site_t</span><span class="w"> </span><span class="n">type</span><span class="p">)</span>
<span class="linenos"> 50</span><span class="o">:</span><span class="n">Shape</span><span class="p">(</span><span class="n">HEMISPHERE</span><span class="p">,</span><span class="n">bounding_box</span><span class="p">(</span><span class="n">point</span><span class="p">(</span><span class="n">center</span><span class="p">.</span><span class="n">x</span><span class="o">-</span><span class="n">radius</span><span class="p">,</span><span class="w"> </span><span class="n">center</span><span class="p">.</span><span class="n">y</span><span class="o">-</span><span class="n">radius</span><span class="p">,</span><span class="w"> </span><span class="n">center</span><span class="p">.</span><span class="n">z</span><span class="o">-</span><span class="n">radius</span><span class="p">),</span><span class="n">point</span><span class="p">(</span><span class="n">center</span><span class="p">.</span><span class="n">x</span><span class="o">+</span><span class="n">radius</span><span class="p">,</span><span class="w"> </span><span class="n">center</span><span class="p">.</span><span class="n">y</span><span class="o">+</span><span class="n">radius</span><span class="p">,</span><span class="w"> </span><span class="n">center</span><span class="p">.</span><span class="n">z</span><span class="o">+</span><span class="n">radius</span><span class="p">)),</span><span class="w"> </span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="n">orientation</span><span class="p">,</span><span class="w"> </span><span class="n">vector</span><span class="o">::</span><span class="n">findPerpendicularVector</span><span class="p">(</span><span class="n">orientation</span><span class="p">)),</span><span class="n">center</span><span class="p">(</span><span class="n">center</span><span class="p">),</span><span class="n">radius</span><span class="p">(</span><span class="n">radius</span><span class="p">),</span><span class="n">orientation</span><span class="p">(</span><span class="n">orientation</span><span class="p">)</span>
<span class="linenos"> 51</span><span class="p">{</span>
<span class="linenos"> 52</span><span class="p">}</span>
<span class="linenos"> 53</span>
<span class="linenos"> 54</span><span class="n">Hemisphere</span><span class="o">::~</span><span class="n">Hemisphere</span><span class="p">()</span>
<span class="linenos"> 55</span><span class="p">{</span>
<span class="linenos"> 56</span><span class="p">}</span>
<span class="linenos"> 57</span>
<span class="linenos"> 58</span><span class="kt">bool</span><span class="w"> </span><span class="n">Hemisphere</span><span class="o">::</span><span class="n">intersects</span><span class="p">(</span><span class="n">Shape</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">query</span><span class="p">)</span>
<span class="linenos"> 59</span><span class="p">{</span>
<span class="linenos"> 60</span><span class="w">    </span><span class="c1">// FIXME: NEEDS TO BE IMPLEMENTED //</span>
<span class="linenos"> 61</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">boundingBoxesIntersect</span><span class="p">(</span><span class="n">query</span><span class="p">))</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="linenos"> 62</span>
<span class="linenos"> 63</span><span class="w">    </span><span class="c1">//Sphere * querySphere = dynamic_cast&lt;Sphere *&gt;(query);</span>
<span class="linenos"> 64</span><span class="w">    </span><span class="n">Sphere</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">querySphere</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Sphere</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">query</span><span class="p">;</span>
<span class="linenos"> 65</span><span class="w">    </span><span class="n">point</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">querySphere</span><span class="o">-&gt;</span><span class="n">getCenter</span><span class="p">();</span>
<span class="linenos"> 66</span><span class="w">    </span><span class="n">si_dist_t</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">querySphere</span><span class="o">-&gt;</span><span class="n">getRadius</span><span class="p">();</span>
<span class="linenos"> 67</span>
<span class="linenos"> 68</span><span class="w">    </span><span class="c1">// If the distance between the two centers is less than the sum of their radii, these two spheres intersect</span>
<span class="linenos"> 69</span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">center</span><span class="p">.</span><span class="n">distanceSquared</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="p">(</span><span class="n">radius</span><span class="o">+</span><span class="n">r</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">radius</span><span class="o">+</span><span class="n">r</span><span class="p">));</span>
<span class="linenos"> 70</span><span class="p">}</span>
<span class="linenos"> 71</span>
<span class="linenos"> 72</span><span class="kt">bool</span><span class="w"> </span><span class="n">Hemisphere</span><span class="o">::</span><span class="n">contains</span><span class="p">(</span><span class="n">point</span><span class="w"> </span><span class="n">query</span><span class="p">)</span>
<span class="linenos"> 73</span><span class="p">{</span>
<span class="linenos"> 74</span><span class="w">    </span><span class="c1">// FIXME: NEEDS TO BE IMPLEMENTED //</span>
<span class="linenos"> 75</span><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="w"> </span><span class="n">center</span><span class="p">.</span><span class="n">distanceSquared</span><span class="p">(</span><span class="n">query</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">radius</span><span class="o">*</span><span class="n">radius</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 76</span><span class="w">        </span><span class="n">vector</span><span class="w"> </span><span class="n">vec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vector</span><span class="p">(</span><span class="n">center</span><span class="p">,</span><span class="w"> </span><span class="n">query</span><span class="p">);</span>
<span class="linenos"> 77</span><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="w"> </span><span class="n">orientation</span><span class="p">.</span><span class="n">dot</span><span class="p">(</span><span class="n">vec</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 78</span><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="linenos"> 79</span><span class="w">        </span><span class="p">}</span>
<span class="linenos"> 80</span><span class="w">    </span><span class="p">}</span>
<span class="linenos"> 81</span>
<span class="linenos"> 82</span><span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="linenos"> 83</span><span class="p">}</span>
<span class="linenos"> 84</span>
<span class="linenos"> 85</span><span class="kt">bool</span><span class="w"> </span><span class="n">Hemisphere</span><span class="o">::</span><span class="n">contains</span><span class="p">(</span><span class="n">Shape</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">query</span><span class="p">)</span>
<span class="linenos"> 86</span><span class="p">{</span>
<span class="linenos"> 87</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">boundingBoxesIntersect</span><span class="p">(</span><span class="n">query</span><span class="p">))</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="linenos"> 88</span>
<span class="linenos"> 89</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">query</span><span class="o">-&gt;</span><span class="n">getShapeType</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">SPHERE</span><span class="p">)</span>
<span class="linenos"> 90</span><span class="w">    </span><span class="p">{</span>
<span class="linenos"> 91</span><span class="w">        </span><span class="n">Sphere</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">querySphere</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Sphere</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">query</span><span class="p">;</span>
<span class="linenos"> 92</span>
<span class="linenos"> 93</span><span class="w">        </span><span class="c1">// Transform the sphere as if the hemisphere was oriented in the +z direction and centered at 0,0,0.</span>
<span class="linenos"> 94</span><span class="w">        </span><span class="n">point</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">querySphere</span><span class="o">-&gt;</span><span class="n">getCenter</span><span class="p">();</span>
<span class="linenos"> 95</span><span class="w">        </span><span class="n">si_dist_t</span><span class="w"> </span><span class="n">x</span><span class="o">=</span><span class="n">c</span><span class="p">.</span><span class="n">x</span><span class="o">-</span><span class="n">center</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
<span class="linenos"> 96</span><span class="w">        </span><span class="n">si_dist_t</span><span class="w"> </span><span class="n">y</span><span class="o">=</span><span class="n">c</span><span class="p">.</span><span class="n">y</span><span class="o">-</span><span class="n">center</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
<span class="linenos"> 97</span><span class="w">        </span><span class="n">si_dist_t</span><span class="w"> </span><span class="n">z</span><span class="o">=</span><span class="n">c</span><span class="p">.</span><span class="n">z</span><span class="o">-</span><span class="n">center</span><span class="p">.</span><span class="n">z</span><span class="p">;</span>
<span class="linenos"> 98</span><span class="w">        </span><span class="n">si_dist_t</span><span class="w"> </span><span class="n">r</span><span class="o">=</span><span class="n">querySphere</span><span class="o">-&gt;</span><span class="n">getRadius</span><span class="p">();</span>
<span class="linenos"> 99</span>
<span class="linenos">100</span><span class="w">        </span><span class="c1">// Make sure none of the sphere falls below the xy plane.</span>
<span class="linenos">101</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">z</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">r</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="linenos">102</span>
<span class="linenos">103</span><span class="w">        </span><span class="c1">// Make sure the sphere is not closer than r to the hemisphere surface.</span>
<span class="linenos">104</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">x</span><span class="o">*</span><span class="n">x</span><span class="o">+</span><span class="n">y</span><span class="o">*</span><span class="n">y</span><span class="o">+</span><span class="n">z</span><span class="o">*</span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">radius</span><span class="o">-</span><span class="n">r</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">radius</span><span class="o">-</span><span class="n">r</span><span class="p">))</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="linenos">105</span>
<span class="linenos">106</span><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="linenos">107</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">108</span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="linenos">109</span><span class="p">}</span>
<span class="linenos">110</span>
<span class="linenos">111</span><span class="kt">double</span><span class="w"> </span><span class="n">Hemisphere</span><span class="o">::</span><span class="n">getVolume</span><span class="p">()</span>
<span class="linenos">112</span><span class="p">{</span>
<span class="linenos">113</span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="mf">2.0</span><span class="o">/</span><span class="mf">3.0</span><span class="p">)</span><span class="o">*</span><span class="n">PI</span><span class="o">*</span><span class="n">radius</span><span class="o">*</span><span class="n">radius</span><span class="o">*</span><span class="n">radius</span><span class="p">;</span>
<span class="linenos">114</span><span class="p">}</span>
<span class="linenos">115</span>
<span class="linenos">116</span><span class="p">}</span>
<span class="linenos">117</span><span class="p">}</span>
</pre></div>
</div>
</section>
</section>
<section id="builder-classes">
<h2>Builder Classes<a class="headerlink" href="#builder-classes" title="Link to this heading">#</a></h2>
<section id="latticebuilder-h">
<h3>LatticeBuilder.h<a class="headerlink" href="#latticebuilder-h" title="Link to this heading">#</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="linenos">  1</span><span class="cm">/*</span>
<span class="linenos">  2</span><span class="cm"> * University of Illinois Open Source License</span>
<span class="linenos">  3</span><span class="cm"> * Copyright 2011-2018 Luthey-Schulten Group,</span>
<span class="linenos">  4</span><span class="cm"> * All rights reserved.</span>
<span class="linenos">  5</span><span class="cm"> *</span>
<span class="linenos">  6</span><span class="cm"> * Developed by: Luthey-Schulten Group</span>
<span class="linenos">  7</span><span class="cm"> *               University of Illinois at Urbana-Champaign</span>
<span class="linenos">  8</span><span class="cm"> *               http://www.scs.uiuc.edu/~schulten</span>
<span class="linenos">  9</span><span class="cm"> *</span>
<span class="linenos"> 10</span><span class="cm"> * Permission is hereby granted, free of charge, to any person obtaining a copy of</span>
<span class="linenos"> 11</span><span class="cm"> * this software and associated documentation files (the Software), to deal with</span>
<span class="linenos"> 12</span><span class="cm"> * the Software without restriction, including without limitation the rights to</span>
<span class="linenos"> 13</span><span class="cm"> * use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies</span>
<span class="linenos"> 14</span><span class="cm"> * of the Software, and to permit persons to whom the Software is furnished to</span>
<span class="linenos"> 15</span><span class="cm"> * do so, subject to the following conditions:</span>
<span class="linenos"> 16</span><span class="cm"> *</span>
<span class="linenos"> 17</span><span class="cm"> * - Redistributions of source code must retain the above copyright notice,</span>
<span class="linenos"> 18</span><span class="cm"> * this list of conditions and the following disclaimers.</span>
<span class="linenos"> 19</span><span class="cm"> *</span>
<span class="linenos"> 20</span><span class="cm"> * - Redistributions in binary form must reproduce the above copyright notice,</span>
<span class="linenos"> 21</span><span class="cm"> * this list of conditions and the following disclaimers in the documentation</span>
<span class="linenos"> 22</span><span class="cm"> * and/or other materials provided with the distribution.</span>
<span class="linenos"> 23</span><span class="cm"> *</span>
<span class="linenos"> 24</span><span class="cm"> * - Neither the names of the Luthey-Schulten Group, University of Illinois at</span>
<span class="linenos"> 25</span><span class="cm"> * Urbana-Champaign, nor the names of its contributors may be used to endorse or</span>
<span class="linenos"> 26</span><span class="cm"> * promote products derived from this Software without specific prior written</span>
<span class="linenos"> 27</span><span class="cm"> * permission.</span>
<span class="linenos"> 28</span><span class="cm"> *</span>
<span class="linenos"> 29</span><span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR</span>
<span class="linenos"> 30</span><span class="cm"> * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,</span>
<span class="linenos"> 31</span><span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL</span>
<span class="linenos"> 32</span><span class="cm"> * THE CONTRIBUTORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR</span>
<span class="linenos"> 33</span><span class="cm"> * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,</span>
<span class="linenos"> 34</span><span class="cm"> * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR</span>
<span class="linenos"> 35</span><span class="cm"> * OTHER DEALINGS WITH THE SOFTWARE.</span>
<span class="linenos"> 36</span><span class="cm"> *</span>
<span class="linenos"> 37</span><span class="cm"> * Author(s): Andrew Magis, Elijah Roberts</span>
<span class="linenos"> 38</span><span class="cm"> */</span>
<span class="linenos"> 39</span>
<span class="linenos"> 40</span><span class="cp">#ifndef LM_BUILDER_LATTICEBUILDER_H_</span>
<span class="linenos"> 41</span><span class="cp">#define LM_BUILDER_LATTICEBUILDER_H_</span>
<span class="linenos"> 42</span>
<span class="linenos"> 43</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;map&gt;</span>
<span class="linenos"> 44</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;utility&gt;</span>
<span class="linenos"> 45</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;vector&gt;</span>
<span class="linenos"> 46</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;core/Types.h&quot;</span>
<span class="linenos"> 47</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;builder/Shape.h&quot;</span>
<span class="linenos"> 48</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;rdme/Lattice.h&quot;</span>
<span class="linenos"> 49</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;rng/RandomGenerator.h&quot;</span>
<span class="linenos"> 50</span>
<span class="linenos"> 51</span><span class="k">using</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="p">;</span>
<span class="linenos"> 52</span><span class="k">using</span><span class="w"> </span><span class="n">lm</span><span class="o">::</span><span class="n">rng</span><span class="o">::</span><span class="n">RandomGenerator</span><span class="p">;</span>
<span class="linenos"> 53</span>
<span class="linenos"> 54</span><span class="k">namespace</span><span class="w"> </span><span class="nn">lm</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 55</span>
<span class="linenos"> 56</span><span class="k">namespace</span><span class="w"> </span><span class="nn">io</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 57</span><span class="k">class</span><span class="w"> </span><span class="nc">SpatialModel</span><span class="p">;</span>
<span class="linenos"> 58</span><span class="p">}</span>
<span class="linenos"> 59</span>
<span class="linenos"> 60</span><span class="k">namespace</span><span class="w"> </span><span class="nn">rdme</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 61</span><span class="k">class</span><span class="w"> </span><span class="nc">Lattice</span><span class="p">;</span>
<span class="linenos"> 62</span><span class="p">}</span>
<span class="linenos"> 63</span>
<span class="linenos"> 64</span><span class="k">namespace</span><span class="w"> </span><span class="nn">builder</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 65</span>
<span class="linenos"> 66</span><span class="c1">/// @class LatticeBuilder</span>
<span class="linenos"> 67</span><span class="c1">/// @brief A class that defines regions of a lattice based on a set of geometries defined by shapes.  It also allows packing different types of particles into different regions. </span>
<span class="linenos"> 68</span><span class="k">class</span><span class="w"> </span><span class="nc">LatticeBuilder</span>
<span class="linenos"> 69</span><span class="p">{</span>
<span class="linenos"> 70</span><span class="k">protected</span><span class="o">:</span>
<span class="linenos"> 71</span><span class="w">    </span><span class="c1">/// @struct ParticlePlacement</span>
<span class="linenos"> 72</span><span class="w">    </span><span class="c1">/// @brief A representation of a placement operation that needs to occur (i.e. where to place (siteType), what to place (particleType) and how many (count))</span>
<span class="linenos"> 73</span><span class="w">	</span><span class="k">struct</span><span class="w"> </span><span class="nc">ParticlePlacement</span>
<span class="linenos"> 74</span><span class="w">	</span><span class="p">{</span>
<span class="linenos"> 75</span><span class="w">    	</span><span class="n">particle_t</span><span class="w"> </span><span class="n">particleType</span><span class="p">;</span>
<span class="linenos"> 76</span><span class="w">    	</span><span class="n">site_t</span><span class="w"> </span><span class="n">siteType</span><span class="p">;</span>
<span class="linenos"> 77</span><span class="w">    	</span><span class="n">uint</span><span class="w"> </span><span class="n">count</span><span class="p">;</span>
<span class="linenos"> 78</span><span class="w">        </span><span class="c1">/// @brief Create a ParticlePlacement placement operation</span>
<span class="linenos"> 79</span><span class="w">        </span><span class="c1">/// @param particleType The type of particle to place</span>
<span class="linenos"> 80</span><span class="w">        </span><span class="c1">/// @param siteType The type of site in which to place the particles</span>
<span class="linenos"> 81</span><span class="w">        </span><span class="c1">/// @param count The number of particles to place in that site type</span>
<span class="linenos"> 82</span><span class="w">    	</span><span class="n">ParticlePlacement</span><span class="p">(</span><span class="n">particle_t</span><span class="w"> </span><span class="n">particleType</span><span class="p">,</span><span class="w"> </span><span class="n">site_t</span><span class="w"> </span><span class="n">siteType</span><span class="p">,</span><span class="w"> </span><span class="n">uint</span><span class="w"> </span><span class="n">count</span><span class="p">)</span><span class="o">:</span><span class="n">particleType</span><span class="p">(</span><span class="n">particleType</span><span class="p">),</span><span class="n">siteType</span><span class="p">(</span><span class="n">siteType</span><span class="p">),</span><span class="n">count</span><span class="p">(</span><span class="n">count</span><span class="p">)</span><span class="w"> </span><span class="p">{}</span>
<span class="linenos"> 83</span><span class="w">	</span><span class="p">};</span>
<span class="linenos"> 84</span>
<span class="linenos"> 85</span><span class="k">public</span><span class="o">:</span>
<span class="linenos"> 86</span><span class="w">    </span><span class="c1">/// @brief Create a Lattice Builder</span>
<span class="linenos"> 87</span><span class="w">    </span><span class="c1">/// @param xLen Length of the domain along x-axis</span>
<span class="linenos"> 88</span><span class="w">    </span><span class="c1">/// @param yLen Length of the domain along y-axis</span>
<span class="linenos"> 89</span><span class="w">    </span><span class="c1">/// @param zLen Length of the domain along z-axis</span>
<span class="linenos"> 90</span><span class="w">    </span><span class="c1">/// @param collisionGridSpacing The spacing for collision objects</span>
<span class="linenos"> 91</span><span class="w">    </span><span class="c1">/// @param seedTop High 32 bits of the seed (allows a constant seed for debugging)</span>
<span class="linenos"> 92</span><span class="w">    </span><span class="c1">/// @param seedBottom Low 32 bits of the seed</span>
<span class="linenos"> 93</span><span class="w">    </span><span class="n">LatticeBuilder</span><span class="p">(</span><span class="n">si_dist_t</span><span class="w"> </span><span class="n">xLen</span><span class="p">,</span><span class="w"> </span><span class="n">si_dist_t</span><span class="w"> </span><span class="n">yLen</span><span class="p">,</span><span class="w"> </span><span class="n">si_dist_t</span><span class="w"> </span><span class="n">zLen</span><span class="p">,</span><span class="w"> </span><span class="n">si_dist_t</span><span class="w"> </span><span class="n">collisionGridSpacing</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">seedTop</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">seedBottom</span><span class="o">=</span><span class="mi">0</span><span class="p">);</span>
<span class="linenos"> 94</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="o">~</span><span class="n">LatticeBuilder</span><span class="p">();</span>
<span class="linenos"> 95</span>
<span class="linenos"> 96</span><span class="w">    </span><span class="c1">/// @brief Add a region to the lattice</span>
<span class="linenos"> 97</span><span class="w">    </span><span class="c1">/// @param shape A Shape object to add as a region</span>
<span class="linenos"> 98</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">addRegion</span><span class="p">(</span><span class="n">Shape</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">shape</span><span class="p">);</span>
<span class="linenos"> 99</span><span class="w">    </span><span class="c1">/// @brief Add an shape to the lattice</span>
<span class="linenos">100</span><span class="w">    </span><span class="c1">/// @param shape A Shape object to add as a region</span>
<span class="linenos">101</span><span class="w">    </span><span class="c1">/// @return true if the object to place does not intersect another object</span>
<span class="linenos">102</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="nf">placeObject</span><span class="p">(</span><span class="n">Shape</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">shape</span><span class="p">);</span>
<span class="linenos">103</span><span class="w">    </span><span class="c1">/// @brief Remove the shape from the lattice</span>
<span class="linenos">104</span><span class="w">    </span><span class="c1">/// @brief s Shape to remove</span>
<span class="linenos">105</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">removeObject</span><span class="p">(</span><span class="n">Shape</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">s</span><span class="p">);</span>
<span class="linenos">106</span><span class="w">    </span>
<span class="linenos">107</span><span class="w">    </span><span class="c1">/// @brief Place a sphere in the lattice (for obstacles)</span>
<span class="linenos">108</span><span class="w">    </span><span class="c1">/// @param center The center point of sphere obstacle</span>
<span class="linenos">109</span><span class="w">    </span><span class="c1">/// @param radius Radius of the sphere obstacle</span>
<span class="linenos">110</span><span class="w">    </span><span class="c1">/// @param type The type of site in which to place sphere</span>
<span class="linenos">111</span><span class="w">    </span><span class="c1">/// @return true if the sphere did not intersect</span>
<span class="linenos">112</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="nf">placeSphere</span><span class="p">(</span><span class="n">point</span><span class="w"> </span><span class="n">center</span><span class="p">,</span><span class="w"> </span><span class="n">si_dist_t</span><span class="w"> </span><span class="n">radius</span><span class="p">,</span><span class="w"> </span><span class="n">site_t</span><span class="w"> </span><span class="n">type</span><span class="p">);</span>
<span class="linenos">113</span><span class="w">    </span><span class="c1">/// @brief Remove a sphere in the lattice (for obstacles)</span>
<span class="linenos">114</span><span class="w">    </span><span class="c1">/// @param center The center point of sphere obstacle</span>
<span class="linenos">115</span><span class="w">    </span><span class="c1">/// @param radius Radius of the sphere obstacle</span>
<span class="linenos">116</span><span class="w">    </span><span class="c1">/// @param type The type of site in which to place sphere</span>
<span class="linenos">117</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">removeSphere</span><span class="p">(</span><span class="n">point</span><span class="w"> </span><span class="n">center</span><span class="p">,</span><span class="w"> </span><span class="n">si_dist_t</span><span class="w"> </span><span class="n">radius</span><span class="p">,</span><span class="w"> </span><span class="n">site_t</span><span class="w"> </span><span class="n">type</span><span class="p">);</span>
<span class="linenos">118</span><span class="w">    </span><span class="c1">/// @brief Place a sphere randomly in the lattice (for obstacles)</span>
<span class="linenos">119</span><span class="w">    </span><span class="c1">/// @param radius Radius of the sphere obstacle</span>
<span class="linenos">120</span><span class="w">    </span><span class="c1">/// @param type The type of site in which to place sphere</span>
<span class="linenos">121</span><span class="w">    </span><span class="c1">/// @param region The region in which to place obstacle randomly</span>
<span class="linenos">122</span><span class="w">    </span><span class="c1">/// @return number of times a placement operation occured</span>
<span class="linenos">123</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="n">uint</span><span class="w"> </span><span class="nf">placeRandomSphere</span><span class="p">(</span><span class="n">si_dist_t</span><span class="w"> </span><span class="n">radius</span><span class="p">,</span><span class="w"> </span><span class="n">site_t</span><span class="w"> </span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="n">site_t</span><span class="w"> </span><span class="n">region</span><span class="p">);</span>
<span class="linenos">124</span><span class="w">    </span><span class="c1">/// @brief Place many spheres randomly in the lattice (for obstacles)</span>
<span class="linenos">125</span><span class="w">    </span><span class="c1">/// @param radius Radius of the sphere obstacle</span>
<span class="linenos">126</span><span class="w">    </span><span class="c1">/// @param type The type of site in which to place sphere</span>
<span class="linenos">127</span><span class="w">    </span><span class="c1">/// @param region The region in which to place obstacle randomly</span>
<span class="linenos">128</span><span class="w">    </span><span class="c1">/// @return number of times a placement operation occured</span>
<span class="linenos">129</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">placeRandomSpheres</span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">count</span><span class="p">,</span><span class="w"> </span><span class="n">si_dist_t</span><span class="w"> </span><span class="n">radius</span><span class="p">,</span><span class="w"> </span><span class="n">site_t</span><span class="w"> </span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="n">site_t</span><span class="w"> </span><span class="n">region</span><span class="p">);</span>
<span class="linenos">130</span><span class="w">    </span><span class="c1">/// @brief Fill a region with random spheres to a specified volume fraction</span>
<span class="linenos">131</span><span class="w">    </span><span class="c1">/// @param volumeFraction Total fraction of volume that should be filled with spheres</span>
<span class="linenos">132</span><span class="w">    </span><span class="c1">/// @param radius Radius of spheres</span>
<span class="linenos">133</span><span class="w">    </span><span class="c1">/// @param type The type of site to fill (i.e. the type of site to exclude other objects from)</span>
<span class="linenos">134</span><span class="w">    </span><span class="c1">/// @param region The region of the lattice to place spheres into</span>
<span class="linenos">135</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">fillWithRandomSpheres</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">volumeFraction</span><span class="p">,</span><span class="w"> </span><span class="n">si_dist_t</span><span class="w"> </span><span class="n">radius</span><span class="p">,</span><span class="w"> </span><span class="n">site_t</span><span class="w"> </span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="n">site_t</span><span class="w"> </span><span class="n">region</span><span class="p">);</span>
<span class="linenos">136</span><span class="w">    </span><span class="c1">/// @brief Gets a spatial model of the lattice for interface with python.  NOTE: this operation clears the object passed in from python</span>
<span class="linenos">137</span><span class="w">    </span><span class="c1">/// @param spatialModel An object of a spatial model for interaction in python or HDF5.  The model will be filled with the current lattice</span>
<span class="linenos">138</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">getSpatialModel</span><span class="p">(</span><span class="n">lm</span><span class="o">::</span><span class="n">io</span><span class="o">::</span><span class="n">SpatialModel</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">spatialModel</span><span class="p">);</span>
<span class="linenos">139</span>
<span class="linenos">140</span><span class="w">    </span>
<span class="linenos">141</span><span class="w">    </span><span class="c1">/// @brief Add particles of a given type</span>
<span class="linenos">142</span><span class="w">    </span><span class="c1">/// @param particleType The type of particles to randomly place in the lattice</span>
<span class="linenos">143</span><span class="w">    </span><span class="c1">/// @param siteType Type of lattice site into which to place</span>
<span class="linenos">144</span><span class="w">    </span><span class="c1">/// @param count Number of particles to place</span>
<span class="linenos">145</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">addParticles</span><span class="p">(</span><span class="n">particle_t</span><span class="w"> </span><span class="n">particleType</span><span class="p">,</span><span class="w"> </span><span class="n">site_t</span><span class="w"> </span><span class="n">siteType</span><span class="p">,</span><span class="w"> </span><span class="n">uint</span><span class="w"> </span><span class="n">count</span><span class="p">);</span>
<span class="linenos">146</span>
<span class="linenos">147</span><span class="w">    </span><span class="c1">/// @brief Discretizes the regions to a square lattice</span>
<span class="linenos">148</span><span class="w">    </span><span class="c1">/// @param lattice Lattice object into which to place</span>
<span class="linenos">149</span><span class="w">    </span><span class="c1">/// @param obstacleSiteType An identifier for obstacle sites in the lattice</span>
<span class="linenos">150</span><span class="w">    </span><span class="c1">/// @param fractionObstacleSitesOccupied Percentage of obstacle sites to be filled</span>
<span class="linenos">151</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">discretizeTo</span><span class="p">(</span><span class="n">lm</span><span class="o">::</span><span class="n">rdme</span><span class="o">::</span><span class="n">Lattice</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">lattice</span><span class="p">,</span><span class="w"> </span><span class="n">site_t</span><span class="w"> </span><span class="n">obstacleSiteType</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">fractionObstacleSitesOccupied</span><span class="p">);</span>
<span class="linenos">152</span>
<span class="linenos">153</span><span class="k">protected</span><span class="o">:</span>
<span class="linenos">154</span><span class="w">    </span><span class="c1">/// @brief Discretizes the obstacles to a square lattice</span>
<span class="linenos">155</span><span class="w">    </span><span class="c1">/// @param lattice Lattice object into which to place</span>
<span class="linenos">156</span><span class="w">    </span><span class="c1">/// @param obstacleSiteType An identifier for obstacle sites in the lattice</span>
<span class="linenos">157</span><span class="w">    </span><span class="c1">/// @param fractionObstacleSitesOccupied Percentage of obstacle sites to be filled</span>
<span class="linenos">158</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">discretizeObstaclesTo</span><span class="p">(</span><span class="n">lm</span><span class="o">::</span><span class="n">rdme</span><span class="o">::</span><span class="n">Lattice</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">lattice</span><span class="p">,</span><span class="w"> </span><span class="n">site_t</span><span class="w"> </span><span class="n">obstacleSiteType</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">fractionObstacleSitesOccupied</span><span class="p">);</span>
<span class="linenos">159</span>
<span class="linenos">160</span><span class="k">protected</span><span class="o">:</span>
<span class="linenos">161</span><span class="w">    </span><span class="c1">// Lattice dimensions</span>
<span class="linenos">162</span><span class="w">    </span><span class="n">si_dist_t</span><span class="w"> </span><span class="n">xLen</span><span class="p">,</span><span class="w"> </span><span class="n">yLen</span><span class="p">,</span><span class="w"> </span><span class="n">zLen</span><span class="p">;</span>
<span class="linenos">163</span><span class="w">    </span>
<span class="linenos">164</span><span class="w">    </span><span class="c1">// Regions of the lattice (i.e. cell membrane, cytosol, extracellular space, etc.)</span>
<span class="linenos">165</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">site_t</span><span class="o">&gt;</span><span class="w"> </span><span class="n">definedRegions</span><span class="p">;</span>
<span class="linenos">166</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">site_t</span><span class="p">,</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Shape</span><span class="w"> </span><span class="o">*&gt;</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">regionShapes</span><span class="p">;</span>
<span class="linenos">167</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">site_t</span><span class="p">,</span><span class="n">bounding_box</span><span class="o">&gt;</span><span class="w"> </span><span class="n">regionBounds</span><span class="p">;</span>
<span class="linenos">168</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Shape</span><span class="w"> </span><span class="o">*&gt;</span><span class="w"> </span><span class="n">objects</span><span class="p">;</span>
<span class="linenos">169</span><span class="w">    </span>
<span class="linenos">170</span><span class="w">    </span><span class="c1">// Particle placement operations or in other words how many particles of each type that should be placed and where</span>
<span class="linenos">171</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">ParticlePlacement</span><span class="o">&gt;</span><span class="w"> </span><span class="n">particles</span><span class="p">;</span>
<span class="linenos">172</span><span class="w">    </span>
<span class="linenos">173</span><span class="w">    </span><span class="c1">// Collision objects, collision grid size and percent filled</span>
<span class="linenos">174</span><span class="w">    </span><span class="n">Shape</span><span class="w"> </span><span class="o">***</span><span class="w"> </span><span class="n">collisionGrid</span><span class="p">;</span>
<span class="linenos">175</span><span class="w">    </span><span class="n">uint</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">collisionGridSize</span><span class="p">;</span>
<span class="linenos">176</span><span class="w">    </span><span class="n">uint</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">collisionGridOccupancy</span><span class="p">;</span>
<span class="linenos">177</span><span class="w">    </span><span class="n">si_dist_t</span><span class="w"> </span><span class="n">collisionGridSpacing</span><span class="p">;</span>
<span class="linenos">178</span><span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">recipCollisionGridSpacing</span><span class="p">;</span>
<span class="linenos">179</span><span class="w">    </span><span class="n">uint</span><span class="w"> </span><span class="n">collisionGridXSize</span><span class="p">,</span><span class="w"> </span><span class="n">collisionGridYSize</span><span class="p">,</span><span class="w"> </span><span class="n">collisionGridZSize</span><span class="p">;</span>
<span class="linenos">180</span><span class="w">    </span>
<span class="linenos">181</span><span class="w">    </span><span class="c1">// Random number generator associated with this lattice</span>
<span class="linenos">182</span><span class="w">    </span><span class="n">RandomGenerator</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">rng</span><span class="p">;</span>
<span class="linenos">183</span>
<span class="linenos">184</span><span class="p">};</span>
<span class="linenos">185</span>
<span class="linenos">186</span><span class="p">}</span>
<span class="linenos">187</span><span class="p">}</span>
<span class="linenos">188</span>
<span class="linenos">189</span><span class="cp">#endif</span>
</pre></div>
</div>
</section>
<section id="latticebuilder-cpp">
<h3>LatticeBuilder.cpp<a class="headerlink" href="#latticebuilder-cpp" title="Link to this heading">#</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="linenos">  1</span><span class="cm">/*</span>
<span class="linenos">  2</span><span class="cm"> * University of Illinois Open Source License</span>
<span class="linenos">  3</span><span class="cm"> * Copyright 2011-2018 Luthey-Schulten Group,</span>
<span class="linenos">  4</span><span class="cm"> * All rights reserved.</span>
<span class="linenos">  5</span><span class="cm"> *</span>
<span class="linenos">  6</span><span class="cm"> * Developed by: Luthey-Schulten Group</span>
<span class="linenos">  7</span><span class="cm"> *               University of Illinois at Urbana-Champaign</span>
<span class="linenos">  8</span><span class="cm"> *               http://www.scs.uiuc.edu/~schulten</span>
<span class="linenos">  9</span><span class="cm"> *</span>
<span class="linenos"> 10</span><span class="cm"> * Permission is hereby granted, free of charge, to any person obtaining a copy of</span>
<span class="linenos"> 11</span><span class="cm"> * this software and associated documentation files (the Software), to deal with</span>
<span class="linenos"> 12</span><span class="cm"> * the Software without restriction, including without limitation the rights to</span>
<span class="linenos"> 13</span><span class="cm"> * use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies</span>
<span class="linenos"> 14</span><span class="cm"> * of the Software, and to permit persons to whom the Software is furnished to</span>
<span class="linenos"> 15</span><span class="cm"> * do so, subject to the following conditions:</span>
<span class="linenos"> 16</span><span class="cm"> *</span>
<span class="linenos"> 17</span><span class="cm"> * - Redistributions of source code must retain the above copyright notice,</span>
<span class="linenos"> 18</span><span class="cm"> * this list of conditions and the following disclaimers.</span>
<span class="linenos"> 19</span><span class="cm"> *</span>
<span class="linenos"> 20</span><span class="cm"> * - Redistributions in binary form must reproduce the above copyright notice,</span>
<span class="linenos"> 21</span><span class="cm"> * this list of conditions and the following disclaimers in the documentation</span>
<span class="linenos"> 22</span><span class="cm"> * and/or other materials provided with the distribution.</span>
<span class="linenos"> 23</span><span class="cm"> *</span>
<span class="linenos"> 24</span><span class="cm"> * - Neither the names of the Luthey-Schulten Group, University of Illinois at</span>
<span class="linenos"> 25</span><span class="cm"> * Urbana-Champaign, nor the names of its contributors may be used to endorse or</span>
<span class="linenos"> 26</span><span class="cm"> * promote products derived from this Software without specific prior written</span>
<span class="linenos"> 27</span><span class="cm"> * permission.</span>
<span class="linenos"> 28</span><span class="cm"> * </span>
<span class="linenos"> 29</span><span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR</span>
<span class="linenos"> 30</span><span class="cm"> * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,</span>
<span class="linenos"> 31</span><span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL</span>
<span class="linenos"> 32</span><span class="cm"> * THE CONTRIBUTORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR</span>
<span class="linenos"> 33</span><span class="cm"> * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,</span>
<span class="linenos"> 34</span><span class="cm"> * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR</span>
<span class="linenos"> 35</span><span class="cm"> * OTHER DEALINGS WITH THE SOFTWARE.</span>
<span class="linenos"> 36</span><span class="cm"> *</span>
<span class="linenos"> 37</span><span class="cm"> * Author(s): Andrew Magis, Elijah Roberts</span>
<span class="linenos"> 38</span><span class="cm"> */</span>
<span class="linenos"> 39</span>
<span class="linenos"> 40</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;list&gt;</span>
<span class="linenos"> 41</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;cmath&gt;</span>
<span class="linenos"> 42</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;config.h&quot;</span>
<span class="linenos"> 43</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;core/Exceptions.h&quot;</span>
<span class="linenos"> 44</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;core/Math.h&quot;</span>
<span class="linenos"> 45</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;core/Print.h&quot;</span>
<span class="linenos"> 46</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;builder/Cone.h&quot;</span>
<span class="linenos"> 47</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;builder/Capsule.h&quot;</span>
<span class="linenos"> 48</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;builder/CapsuleShell.h&quot;</span>
<span class="linenos"> 49</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;builder/Cuboid.h&quot;</span>
<span class="linenos"> 50</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;builder/Hemisphere.h&quot;</span>
<span class="linenos"> 51</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;builder/LatticeBuilder.h&quot;</span>
<span class="linenos"> 52</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;builder/Shape.h&quot;</span>
<span class="linenos"> 53</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;builder/Sphere.h&quot;</span>
<span class="linenos"> 54</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;builder/Difference.h&quot;</span>
<span class="linenos"> 55</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;builder/Union.h&quot;</span>
<span class="linenos"> 56</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;builder/UnionSet.h&quot;</span>
<span class="linenos"> 57</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;builder/Intersection.h&quot;</span>
<span class="linenos"> 58</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;builder/Torus.h&quot;</span>
<span class="linenos"> 59</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;builder/Ellipse.h&quot;</span>
<span class="linenos"> 60</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;builder/Cylinder.h&quot;</span>
<span class="linenos"> 61</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;SpatialModel.pb.h&quot;</span>
<span class="linenos"> 62</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;io/SimulationFile.h&quot;</span>
<span class="linenos"> 63</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;rdme/Lattice.h&quot;</span>
<span class="linenos"> 64</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;rng/RandomGenerator.h&quot;</span>
<span class="linenos"> 65</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;rng/XORShift.h&quot;</span>
<span class="linenos"> 66</span><span class="cp">#ifdef OPT_CUDA</span>
<span class="linenos"> 67</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;rng/XORWow.h&quot;</span>
<span class="linenos"> 68</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;cuda/lm_cuda.h&quot;</span>
<span class="linenos"> 69</span><span class="cp">#endif</span>
<span class="linenos"> 70</span>
<span class="linenos"> 71</span><span class="k">using</span><span class="w"> </span><span class="n">lm</span><span class="o">::</span><span class="n">io</span><span class="o">::</span><span class="n">SpatialModel</span><span class="p">;</span>
<span class="linenos"> 72</span>
<span class="linenos"> 73</span><span class="k">namespace</span><span class="w"> </span><span class="nn">lm</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 74</span><span class="k">namespace</span><span class="w"> </span><span class="nn">builder</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 75</span>
<span class="linenos"> 76</span><span class="n">LatticeBuilder</span><span class="o">::</span><span class="n">LatticeBuilder</span><span class="p">(</span><span class="n">si_dist_t</span><span class="w"> </span><span class="n">xLen</span><span class="p">,</span><span class="w"> </span><span class="n">si_dist_t</span><span class="w"> </span><span class="n">yLen</span><span class="p">,</span><span class="w"> </span><span class="n">si_dist_t</span><span class="w"> </span><span class="n">zLen</span><span class="p">,</span><span class="w"> </span><span class="n">si_dist_t</span><span class="w"> </span><span class="n">collisionGridSpacing</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">seedTop</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">seedBottom</span><span class="p">)</span>
<span class="linenos"> 77</span><span class="o">:</span><span class="n">xLen</span><span class="p">(</span><span class="n">xLen</span><span class="p">),</span><span class="n">yLen</span><span class="p">(</span><span class="n">yLen</span><span class="p">),</span><span class="n">zLen</span><span class="p">(</span><span class="n">zLen</span><span class="p">),</span><span class="n">collisionGrid</span><span class="p">(</span><span class="nb">NULL</span><span class="p">),</span><span class="n">collisionGridSize</span><span class="p">(</span><span class="nb">NULL</span><span class="p">),</span><span class="n">collisionGridOccupancy</span><span class="p">(</span><span class="nb">NULL</span><span class="p">),</span><span class="n">collisionGridSpacing</span><span class="p">(</span><span class="n">collisionGridSpacing</span><span class="p">),</span><span class="n">recipCollisionGridSpacing</span><span class="p">(</span><span class="mf">1.0</span><span class="o">/</span><span class="n">collisionGridSpacing</span><span class="p">),</span><span class="n">rng</span><span class="p">(</span><span class="nb">NULL</span><span class="p">)</span>
<span class="linenos"> 78</span><span class="p">{</span>
<span class="linenos"> 79</span><span class="w">    </span><span class="cp">#ifdef OPT_CUDA</span>
<span class="linenos"> 80</span><span class="w">    </span><span class="c1">// Create the cuda based rng, if we are using cuda and we have a cuda device assigned.</span>
<span class="linenos"> 81</span><span class="w">    </span><span class="c1">//if (resources-&gt;cudaDevices.size() &gt; 0)</span>
<span class="linenos"> 82</span><span class="w">   </span><span class="c1">//{</span>
<span class="linenos"> 83</span><span class="w">		</span><span class="k">try</span>
<span class="linenos"> 84</span><span class="w">		</span><span class="p">{</span>
<span class="linenos"> 85</span><span class="w">			</span><span class="n">rng</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">lm</span><span class="o">::</span><span class="n">rng</span><span class="o">::</span><span class="n">XORWow</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">seedTop</span><span class="p">,</span><span class="w"> </span><span class="n">seedBottom</span><span class="p">,</span><span class="w"> </span><span class="n">lm</span><span class="o">::</span><span class="n">rng</span><span class="o">::</span><span class="n">RandomGenerator</span><span class="o">::</span><span class="n">UNIFORM</span><span class="p">);</span>
<span class="linenos"> 86</span><span class="w">        </span><span class="n">Print</span><span class="o">::</span><span class="n">printf</span><span class="p">(</span><span class="n">Print</span><span class="o">::</span><span class="n">DEBUG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Seeding xorwow rng with top word %u and bottom word %u&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="p">)(</span><span class="n">rng</span><span class="o">-&gt;</span><span class="n">getSeed</span><span class="p">()</span><span class="o">&gt;&gt;</span><span class="mi">32</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="p">)(</span><span class="n">rng</span><span class="o">-&gt;</span><span class="n">getSeed</span><span class="p">()</span><span class="o">&amp;</span><span class="mh">0xFFFFFFFFLL</span><span class="p">));</span>
<span class="linenos"> 87</span><span class="w">		</span><span class="p">}</span>
<span class="linenos"> 88</span><span class="w">		</span><span class="k">catch</span><span class="p">(</span><span class="n">lm</span><span class="o">::</span><span class="n">CUDAException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span>
<span class="linenos"> 89</span><span class="w">		</span><span class="p">{</span>
<span class="linenos"> 90</span><span class="w">			</span><span class="n">Print</span><span class="o">::</span><span class="n">printf</span><span class="p">(</span><span class="n">Print</span><span class="o">::</span><span class="n">WARNING</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Initializing GPU random number generator failed: %s.  Falling back to CPU random number generator.&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">what</span><span class="p">());</span>
<span class="linenos"> 91</span><span class="w">			</span><span class="n">rng</span><span class="o">=</span><span class="nb">NULL</span><span class="p">;</span>
<span class="linenos"> 92</span><span class="w">		</span><span class="p">}</span>
<span class="linenos"> 93</span><span class="w">    </span><span class="c1">//}</span>
<span class="linenos"> 94</span><span class="w">    </span><span class="cp">#endif</span>
<span class="linenos"> 95</span>
<span class="linenos"> 96</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rng</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span>
<span class="linenos"> 97</span><span class="w">    </span><span class="p">{</span>
<span class="linenos"> 98</span><span class="w">        </span><span class="n">rng</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">lm</span><span class="o">::</span><span class="n">rng</span><span class="o">::</span><span class="n">XORShift</span><span class="p">(</span><span class="n">seedTop</span><span class="p">,</span><span class="w"> </span><span class="n">seedBottom</span><span class="p">);</span>
<span class="linenos"> 99</span><span class="w">        </span><span class="n">Print</span><span class="o">::</span><span class="n">printf</span><span class="p">(</span><span class="n">Print</span><span class="o">::</span><span class="n">DEBUG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Seeding xorshift rng with top word %u and bottom word %u&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="p">)(</span><span class="n">rng</span><span class="o">-&gt;</span><span class="n">getSeed</span><span class="p">()</span><span class="o">&gt;&gt;</span><span class="mi">32</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="p">)(</span><span class="n">rng</span><span class="o">-&gt;</span><span class="n">getSeed</span><span class="p">()</span><span class="o">&amp;</span><span class="mh">0xFFFFFFFFLL</span><span class="p">));</span>
<span class="linenos">100</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">101</span>
<span class="linenos">102</span><span class="w">    </span><span class="c1">// Allocate the collision detection grid.</span>
<span class="linenos">103</span><span class="w">    </span><span class="n">collisionGridXSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="p">)</span><span class="n">lround</span><span class="p">(</span><span class="n">floor</span><span class="p">(</span><span class="n">xLen</span><span class="o">/</span><span class="n">collisionGridSpacing</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
<span class="linenos">104</span><span class="w">    </span><span class="n">collisionGridYSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="p">)</span><span class="n">lround</span><span class="p">(</span><span class="n">floor</span><span class="p">(</span><span class="n">yLen</span><span class="o">/</span><span class="n">collisionGridSpacing</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
<span class="linenos">105</span><span class="w">    </span><span class="n">collisionGridZSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="p">)</span><span class="n">lround</span><span class="p">(</span><span class="n">floor</span><span class="p">(</span><span class="n">zLen</span><span class="o">/</span><span class="n">collisionGridSpacing</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
<span class="linenos">106</span><span class="w">    </span><span class="n">Print</span><span class="o">::</span><span class="n">printf</span><span class="p">(</span><span class="n">Print</span><span class="o">::</span><span class="n">DEBUG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Creating collision grid of size %d %d %d&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">collisionGridXSize</span><span class="p">,</span><span class="w"> </span><span class="n">collisionGridYSize</span><span class="p">,</span><span class="w"> </span><span class="n">collisionGridZSize</span><span class="p">);</span>
<span class="linenos">107</span><span class="w">    </span><span class="n">collisionGrid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Shape</span><span class="w"> </span><span class="o">**</span><span class="p">[</span><span class="n">collisionGridXSize</span><span class="o">*</span><span class="n">collisionGridYSize</span><span class="o">*</span><span class="n">collisionGridZSize</span><span class="p">];</span>
<span class="linenos">108</span><span class="w">    </span><span class="n">collisionGridOccupancy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">uint</span><span class="p">[</span><span class="n">collisionGridXSize</span><span class="o">*</span><span class="n">collisionGridYSize</span><span class="o">*</span><span class="n">collisionGridZSize</span><span class="p">];</span>
<span class="linenos">109</span><span class="w">    </span><span class="n">collisionGridSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">uint</span><span class="p">[</span><span class="n">collisionGridXSize</span><span class="o">*</span><span class="n">collisionGridYSize</span><span class="o">*</span><span class="n">collisionGridZSize</span><span class="p">];</span>
<span class="linenos">110</span><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">collisionGridXSize</span><span class="o">*</span><span class="n">collisionGridYSize</span><span class="o">*</span><span class="n">collisionGridZSize</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">111</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">112</span><span class="w">        </span><span class="n">collisionGrid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Shape</span><span class="o">*</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<span class="linenos">113</span><span class="w">        </span><span class="n">collisionGridOccupancy</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0U</span><span class="p">;</span>
<span class="linenos">114</span><span class="w">        </span><span class="n">collisionGridSize</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2U</span><span class="p">;</span>
<span class="linenos">115</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">116</span><span class="p">}</span>
<span class="linenos">117</span>
<span class="linenos">118</span><span class="n">LatticeBuilder</span><span class="o">::~</span><span class="n">LatticeBuilder</span><span class="p">()</span>
<span class="linenos">119</span><span class="p">{</span>
<span class="linenos">120</span><span class="w">    </span><span class="c1">// Delete the rng.</span>
<span class="linenos">121</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rng</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">delete</span><span class="w"> </span><span class="n">rng</span><span class="p">;</span><span class="w"> </span><span class="n">rng</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;}</span>
<span class="linenos">122</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">collisionGrid</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span>
<span class="linenos">123</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">124</span><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">collisionGridXSize</span><span class="o">*</span><span class="n">collisionGridYSize</span><span class="o">*</span><span class="n">collisionGridZSize</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">125</span><span class="w">        </span><span class="p">{</span>
<span class="linenos">126</span><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">collisionGrid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="k">delete</span><span class="w"> </span><span class="p">[]</span><span class="w"> </span><span class="n">collisionGrid</span><span class="p">[</span><span class="n">i</span><span class="p">];</span><span class="w"> </span><span class="n">collisionGrid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;}</span>
<span class="linenos">127</span><span class="w">        </span><span class="p">}</span>
<span class="linenos">128</span><span class="w">        </span><span class="k">delete</span><span class="w"> </span><span class="p">[]</span><span class="w"> </span><span class="n">collisionGrid</span><span class="p">;</span><span class="w"> </span><span class="n">collisionGrid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="linenos">129</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">130</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">collisionGridOccupancy</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="k">delete</span><span class="w"> </span><span class="n">collisionGridOccupancy</span><span class="p">;</span><span class="w"> </span><span class="n">collisionGridOccupancy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;}</span>
<span class="linenos">131</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">collisionGridSize</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="k">delete</span><span class="w"> </span><span class="n">collisionGridSize</span><span class="p">;</span><span class="w"> </span><span class="n">collisionGridSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;}</span>
<span class="linenos">132</span><span class="p">}</span>
<span class="linenos">133</span>
<span class="linenos">134</span><span class="kt">void</span><span class="w"> </span><span class="n">LatticeBuilder</span><span class="o">::</span><span class="n">addRegion</span><span class="p">(</span><span class="n">Shape</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">shape</span><span class="p">)</span>
<span class="linenos">135</span><span class="p">{</span>
<span class="linenos">136</span><span class="w">	</span><span class="c1">// Make sure this region is in our defined list.</span>
<span class="linenos">137</span><span class="w">	</span><span class="kt">bool</span><span class="w"> </span><span class="n">found</span><span class="o">=</span><span class="nb">false</span><span class="p">;</span>
<span class="linenos">138</span><span class="w">	</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">definedRegions</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">139</span><span class="w">	</span><span class="p">{</span>
<span class="linenos">140</span><span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">definedRegions</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">shape</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">())</span>
<span class="linenos">141</span><span class="w">		</span><span class="p">{</span>
<span class="linenos">142</span><span class="w">			</span><span class="n">found</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="linenos">143</span><span class="w">			</span><span class="k">break</span><span class="p">;</span>
<span class="linenos">144</span><span class="w">		</span><span class="p">}</span>
<span class="linenos">145</span><span class="w">	</span><span class="p">}</span>
<span class="linenos">146</span><span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">found</span><span class="p">)</span><span class="w"> </span><span class="n">definedRegions</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">shape</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span>
<span class="linenos">147</span>
<span class="linenos">148</span><span class="w">    </span><span class="c1">// Add this region to the list.</span>
<span class="linenos">149</span><span class="w">    </span><span class="n">regionShapes</span><span class="p">[</span><span class="n">shape</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()].</span><span class="n">push_back</span><span class="p">(</span><span class="n">shape</span><span class="p">);</span>
<span class="linenos">150</span>
<span class="linenos">151</span><span class="w">    </span><span class="c1">// Update the region&#39;s bounding box.</span>
<span class="linenos">152</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">regionBounds</span><span class="p">.</span><span class="n">count</span><span class="p">(</span><span class="n">shape</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">())</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">153</span><span class="w">        </span><span class="n">regionBounds</span><span class="p">[</span><span class="n">shape</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">shape</span><span class="o">-&gt;</span><span class="n">getBoundingBox</span><span class="p">();</span>
<span class="linenos">154</span><span class="w">    </span><span class="k">else</span>
<span class="linenos">155</span><span class="w">        </span><span class="n">regionBounds</span><span class="p">[</span><span class="n">shape</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">regionBounds</span><span class="p">[</span><span class="n">shape</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()].</span><span class="n">joinWith</span><span class="p">(</span><span class="n">shape</span><span class="o">-&gt;</span><span class="n">getBoundingBox</span><span class="p">());</span>
<span class="linenos">156</span>
<span class="linenos">157</span><span class="p">}</span>
<span class="linenos">158</span>
<span class="linenos">159</span><span class="kt">bool</span><span class="w"> </span><span class="n">LatticeBuilder</span><span class="o">::</span><span class="n">placeObject</span><span class="p">(</span><span class="n">Shape</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">s</span><span class="p">)</span>
<span class="linenos">160</span><span class="p">{</span>
<span class="linenos">161</span><span class="w">    </span><span class="c1">// Go through all of the grid volumes that this shape&#39;s bounding box intersects with.</span>
<span class="linenos">162</span><span class="w">    </span><span class="n">uint</span><span class="w"> </span><span class="n">zMin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="p">)</span><span class="n">lround</span><span class="p">(</span><span class="n">floor</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">boundingBox</span><span class="p">.</span><span class="n">min</span><span class="p">.</span><span class="n">z</span><span class="o">*</span><span class="n">recipCollisionGridSpacing</span><span class="p">));</span>
<span class="linenos">163</span><span class="w">    </span><span class="n">uint</span><span class="w"> </span><span class="n">zMax</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="p">)</span><span class="n">lround</span><span class="p">(</span><span class="n">floor</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">boundingBox</span><span class="p">.</span><span class="n">max</span><span class="p">.</span><span class="n">z</span><span class="o">*</span><span class="n">recipCollisionGridSpacing</span><span class="p">));</span>
<span class="linenos">164</span><span class="w">    </span><span class="n">uint</span><span class="w"> </span><span class="n">yMin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="p">)</span><span class="n">lround</span><span class="p">(</span><span class="n">floor</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">boundingBox</span><span class="p">.</span><span class="n">min</span><span class="p">.</span><span class="n">y</span><span class="o">*</span><span class="n">recipCollisionGridSpacing</span><span class="p">));</span>
<span class="linenos">165</span><span class="w">    </span><span class="n">uint</span><span class="w"> </span><span class="n">yMax</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="p">)</span><span class="n">lround</span><span class="p">(</span><span class="n">floor</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">boundingBox</span><span class="p">.</span><span class="n">max</span><span class="p">.</span><span class="n">y</span><span class="o">*</span><span class="n">recipCollisionGridSpacing</span><span class="p">));</span>
<span class="linenos">166</span><span class="w">    </span><span class="n">uint</span><span class="w"> </span><span class="n">xMin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="p">)</span><span class="n">lround</span><span class="p">(</span><span class="n">floor</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">boundingBox</span><span class="p">.</span><span class="n">min</span><span class="p">.</span><span class="n">x</span><span class="o">*</span><span class="n">recipCollisionGridSpacing</span><span class="p">));</span>
<span class="linenos">167</span><span class="w">    </span><span class="n">uint</span><span class="w"> </span><span class="n">xMax</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="p">)</span><span class="n">lround</span><span class="p">(</span><span class="n">floor</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">boundingBox</span><span class="p">.</span><span class="n">max</span><span class="p">.</span><span class="n">x</span><span class="o">*</span><span class="n">recipCollisionGridSpacing</span><span class="p">));</span>
<span class="linenos">168</span><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">z</span><span class="o">=</span><span class="n">zMin</span><span class="p">;</span><span class="w"> </span><span class="n">z</span><span class="o">&lt;=</span><span class="n">zMax</span><span class="p">;</span><span class="w"> </span><span class="n">z</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">169</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">170</span><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">y</span><span class="o">=</span><span class="n">yMin</span><span class="p">;</span><span class="w"> </span><span class="n">y</span><span class="o">&lt;=</span><span class="n">yMax</span><span class="p">;</span><span class="w"> </span><span class="n">y</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">171</span><span class="w">        </span><span class="p">{</span>
<span class="linenos">172</span><span class="w">            </span><span class="n">uint</span><span class="w"> </span><span class="n">index</span><span class="o">=</span><span class="n">xMin</span><span class="o">+</span><span class="p">(</span><span class="n">y</span><span class="o">*</span><span class="n">collisionGridXSize</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="n">z</span><span class="o">*</span><span class="n">collisionGridXSize</span><span class="o">*</span><span class="n">collisionGridYSize</span><span class="p">);</span>
<span class="linenos">173</span><span class="w">            </span><span class="n">uint</span><span class="w"> </span><span class="n">maxIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">index</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">xMax</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">xMin</span><span class="p">;</span>
<span class="linenos">174</span><span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(;</span><span class="w"> </span><span class="n">index</span><span class="o">&lt;=</span><span class="n">maxIndex</span><span class="p">;</span><span class="w"> </span><span class="n">index</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">175</span><span class="w">            </span><span class="p">{</span>
<span class="linenos">176</span><span class="w">                </span><span class="n">Print</span><span class="o">::</span><span class="n">printf</span><span class="p">(</span><span class="n">Print</span><span class="o">::</span><span class="n">VERBOSE_DEBUG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Checking box at index %d&quot;</span><span class="p">,</span><span class="n">index</span><span class="p">);</span>
<span class="linenos">177</span>
<span class="linenos">178</span><span class="w">                </span><span class="c1">// Go through all of the shapes in this volume and see if we have a collision.</span>
<span class="linenos">179</span><span class="w">                </span><span class="n">uint</span><span class="w"> </span><span class="n">occupancy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">collisionGridOccupancy</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
<span class="linenos">180</span><span class="w">                </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">occupancy</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">181</span><span class="w">                </span><span class="p">{</span>
<span class="linenos">182</span><span class="w">                    </span><span class="n">Shape</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">shapeToCheck</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">collisionGrid</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="n">i</span><span class="p">];</span>
<span class="linenos">183</span><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">shapeToCheck</span><span class="o">-&gt;</span><span class="n">intersects</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>
<span class="linenos">184</span><span class="w">                    </span><span class="p">{</span>
<span class="linenos">185</span><span class="w">                        </span><span class="n">Print</span><span class="o">::</span><span class="n">printf</span><span class="p">(</span><span class="n">Print</span><span class="o">::</span><span class="n">VERBOSE_DEBUG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Found another object intersecting.&quot;</span><span class="p">);</span>
<span class="linenos">186</span><span class="w">                        </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="linenos">187</span><span class="w">                    </span><span class="p">}</span>
<span class="linenos">188</span><span class="w">                </span><span class="p">}</span>
<span class="linenos">189</span><span class="w">            </span><span class="p">}</span>
<span class="linenos">190</span><span class="w">        </span><span class="p">}</span>
<span class="linenos">191</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">192</span>
<span class="linenos">193</span><span class="w">    </span><span class="c1">// We need to add the shape to each grid volume that this shape&#39;s bounding box intersects with.</span>
<span class="linenos">194</span><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">z</span><span class="o">=</span><span class="n">zMin</span><span class="p">;</span><span class="w"> </span><span class="n">z</span><span class="o">&lt;=</span><span class="n">zMax</span><span class="p">;</span><span class="w"> </span><span class="n">z</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">195</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">196</span><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">y</span><span class="o">=</span><span class="n">yMin</span><span class="p">;</span><span class="w"> </span><span class="n">y</span><span class="o">&lt;=</span><span class="n">yMax</span><span class="p">;</span><span class="w"> </span><span class="n">y</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">197</span><span class="w">        </span><span class="p">{</span>
<span class="linenos">198</span><span class="w">            </span><span class="n">uint</span><span class="w"> </span><span class="n">index</span><span class="o">=</span><span class="n">xMin</span><span class="o">+</span><span class="p">(</span><span class="n">y</span><span class="o">*</span><span class="n">collisionGridXSize</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="n">z</span><span class="o">*</span><span class="n">collisionGridXSize</span><span class="o">*</span><span class="n">collisionGridYSize</span><span class="p">);</span>
<span class="linenos">199</span><span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">x</span><span class="o">=</span><span class="n">xMin</span><span class="p">;</span><span class="w"> </span><span class="n">x</span><span class="o">&lt;=</span><span class="n">xMax</span><span class="p">;</span><span class="w"> </span><span class="n">x</span><span class="o">++</span><span class="p">,</span><span class="w"> </span><span class="n">index</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">200</span><span class="w">            </span><span class="p">{</span>
<span class="linenos">201</span><span class="w">                </span><span class="c1">// If there is no room in the list, increase its size.</span>
<span class="linenos">202</span><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">collisionGridOccupancy</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">collisionGridSize</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>
<span class="linenos">203</span><span class="w">                </span><span class="p">{</span>
<span class="linenos">204</span><span class="w">                    </span><span class="n">uint</span><span class="w"> </span><span class="n">currentSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">collisionGridSize</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
<span class="linenos">205</span><span class="w">                    </span><span class="n">Shape</span><span class="w"> </span><span class="o">**</span><span class="w"> </span><span class="n">newList</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Shape</span><span class="o">*</span><span class="p">[</span><span class="n">currentSize</span><span class="o">*</span><span class="mi">2</span><span class="p">];</span>
<span class="linenos">206</span><span class="w">                    </span><span class="n">memcpy</span><span class="p">(</span><span class="n">newList</span><span class="p">,</span><span class="w"> </span><span class="n">collisionGrid</span><span class="p">[</span><span class="n">index</span><span class="p">],</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">Shape</span><span class="o">*</span><span class="p">)</span><span class="o">*</span><span class="n">currentSize</span><span class="p">);</span>
<span class="linenos">207</span><span class="w">                    </span><span class="n">collisionGridSize</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">=</span><span class="n">currentSize</span><span class="o">*</span><span class="mi">2</span><span class="p">;</span>
<span class="linenos">208</span><span class="w">                    </span><span class="k">delete</span><span class="w"> </span><span class="p">[]</span><span class="w"> </span><span class="n">collisionGrid</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
<span class="linenos">209</span><span class="w">                    </span><span class="n">collisionGrid</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newList</span><span class="p">;</span>
<span class="linenos">210</span><span class="w">                </span><span class="p">}</span>
<span class="linenos">211</span>
<span class="linenos">212</span><span class="w">                </span><span class="c1">// Add the new shape to the list.</span>
<span class="linenos">213</span><span class="w">                </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="n">collisionGridOccupancy</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
<span class="linenos">214</span><span class="w">                </span><span class="n">collisionGrid</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s</span><span class="p">;</span>
<span class="linenos">215</span><span class="w">            </span><span class="p">}</span>
<span class="linenos">216</span><span class="w">        </span><span class="p">}</span>
<span class="linenos">217</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">218</span>
<span class="linenos">219</span><span class="w">    </span><span class="c1">// Add the shape to the list of unique objects.</span>
<span class="linenos">220</span><span class="w">    </span><span class="n">objects</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
<span class="linenos">221</span>
<span class="linenos">222</span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="linenos">223</span><span class="p">}</span>
<span class="linenos">224</span>
<span class="linenos">225</span><span class="kt">void</span><span class="w"> </span><span class="n">LatticeBuilder</span><span class="o">::</span><span class="n">removeObject</span><span class="p">(</span><span class="n">Shape</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">s</span><span class="p">)</span>
<span class="linenos">226</span><span class="p">{</span>
<span class="linenos">227</span><span class="w">	</span><span class="c1">// Add all of the obstacles.</span>
<span class="linenos">228</span><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Shape</span><span class="w"> </span><span class="o">*&gt;::</span><span class="n">iterator</span><span class="w"> </span><span class="n">it</span><span class="o">=</span><span class="n">objects</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span><span class="w"> </span><span class="n">it</span><span class="o">&lt;</span><span class="n">objects</span><span class="p">.</span><span class="n">end</span><span class="p">();</span><span class="w"> </span><span class="n">it</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">229</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">230</span><span class="w">        </span><span class="n">Shape</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">shape</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">it</span><span class="p">;</span>
<span class="linenos">231</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">getShapeType</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Shape</span><span class="o">::</span><span class="n">SPHERE</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">shape</span><span class="o">-&gt;</span><span class="n">getShapeType</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Shape</span><span class="o">::</span><span class="n">SPHERE</span><span class="p">)</span>
<span class="linenos">232</span><span class="w">        </span><span class="p">{</span>
<span class="linenos">233</span><span class="w">        	</span><span class="n">Sphere</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">target</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Sphere</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">s</span><span class="p">;</span>
<span class="linenos">234</span><span class="w">            </span><span class="n">Sphere</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">sphere</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Sphere</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">shape</span><span class="p">;</span>
<span class="linenos">235</span><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">sphere</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">target</span><span class="o">-&gt;</span><span class="n">getCenter</span><span class="p">().</span><span class="n">x</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">sphere</span><span class="o">-&gt;</span><span class="n">getCenter</span><span class="p">().</span><span class="n">x</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">target</span><span class="o">-&gt;</span><span class="n">getCenter</span><span class="p">().</span><span class="n">y</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">sphere</span><span class="o">-&gt;</span><span class="n">getCenter</span><span class="p">().</span><span class="n">y</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">target</span><span class="o">-&gt;</span><span class="n">getCenter</span><span class="p">().</span><span class="n">z</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">sphere</span><span class="o">-&gt;</span><span class="n">getCenter</span><span class="p">().</span><span class="n">z</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">target</span><span class="o">-&gt;</span><span class="n">getRadius</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">sphere</span><span class="o">-&gt;</span><span class="n">getRadius</span><span class="p">())</span>
<span class="linenos">236</span><span class="w">            </span><span class="p">{</span>
<span class="linenos">237</span><span class="w">            	</span><span class="n">objects</span><span class="p">.</span><span class="n">erase</span><span class="p">(</span><span class="n">it</span><span class="p">);</span>
<span class="linenos">238</span><span class="w">            	</span><span class="k">return</span><span class="p">;</span>
<span class="linenos">239</span><span class="w">            </span><span class="p">}</span>
<span class="linenos">240</span><span class="w">        </span><span class="p">}</span>
<span class="linenos">241</span><span class="w">        </span><span class="k">else</span>
<span class="linenos">242</span><span class="w">        </span><span class="p">{</span>
<span class="linenos">243</span><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="n">Exception</span><span class="p">(</span><span class="s">&quot;Unsupported shape type.&quot;</span><span class="p">);</span>
<span class="linenos">244</span><span class="w">        </span><span class="p">}</span>
<span class="linenos">245</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">246</span><span class="p">}</span>
<span class="linenos">247</span>
<span class="linenos">248</span><span class="kt">bool</span><span class="w"> </span><span class="n">LatticeBuilder</span><span class="o">::</span><span class="n">placeSphere</span><span class="p">(</span><span class="n">point</span><span class="w"> </span><span class="n">center</span><span class="p">,</span><span class="w"> </span><span class="n">si_dist_t</span><span class="w"> </span><span class="n">radius</span><span class="p">,</span><span class="w"> </span><span class="n">site_t</span><span class="w"> </span><span class="n">type</span><span class="p">)</span>
<span class="linenos">249</span><span class="p">{</span>
<span class="linenos">250</span><span class="w">	</span><span class="n">Sphere</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Sphere</span><span class="p">(</span><span class="n">center</span><span class="p">,</span><span class="n">radius</span><span class="p">,</span><span class="n">type</span><span class="p">);</span>
<span class="linenos">251</span><span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="n">placeObject</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
<span class="linenos">252</span><span class="p">}</span>
<span class="linenos">253</span>
<span class="linenos">254</span><span class="kt">void</span><span class="w"> </span><span class="n">LatticeBuilder</span><span class="o">::</span><span class="n">removeSphere</span><span class="p">(</span><span class="n">point</span><span class="w"> </span><span class="n">center</span><span class="p">,</span><span class="w"> </span><span class="n">si_dist_t</span><span class="w"> </span><span class="n">radius</span><span class="p">,</span><span class="w"> </span><span class="n">site_t</span><span class="w"> </span><span class="n">type</span><span class="p">)</span>
<span class="linenos">255</span><span class="p">{</span>
<span class="linenos">256</span><span class="w">	</span><span class="n">Sphere</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Sphere</span><span class="p">(</span><span class="n">center</span><span class="p">,</span><span class="n">radius</span><span class="p">,</span><span class="n">type</span><span class="p">);</span>
<span class="linenos">257</span><span class="w">	</span><span class="n">removeObject</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
<span class="linenos">258</span><span class="w">	</span><span class="k">delete</span><span class="w"> </span><span class="n">s</span><span class="p">;</span>
<span class="linenos">259</span><span class="p">}</span>
<span class="linenos">260</span>
<span class="linenos">261</span><span class="n">uint</span><span class="w"> </span><span class="n">LatticeBuilder</span><span class="o">::</span><span class="n">placeRandomSphere</span><span class="p">(</span><span class="n">si_dist_t</span><span class="w"> </span><span class="n">radius</span><span class="p">,</span><span class="w"> </span><span class="n">site_t</span><span class="w"> </span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="n">site_t</span><span class="w"> </span><span class="n">region</span><span class="p">)</span>
<span class="linenos">262</span><span class="p">{</span>
<span class="linenos">263</span><span class="w">    </span><span class="n">uint</span><span class="w"> </span><span class="n">numberAttempts</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">264</span><span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">randomValues</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
<span class="linenos">265</span><span class="w">    </span><span class="n">Sphere</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Sphere</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="n">radius</span><span class="p">,</span><span class="n">type</span><span class="p">);</span>
<span class="linenos">266</span>
<span class="linenos">267</span><span class="w">    </span><span class="c1">// Get the bounding box for this region.</span>
<span class="linenos">268</span><span class="w">    </span><span class="n">bounding_box</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">regionBounds</span><span class="p">[</span><span class="n">region</span><span class="p">];</span>
<span class="linenos">269</span>
<span class="linenos">270</span><span class="w">    </span><span class="c1">// Randomly place the sphere until we find a location for it.</span>
<span class="linenos">271</span><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="nb">true</span><span class="p">)</span>
<span class="linenos">272</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">273</span><span class="w">        </span><span class="c1">// Get a random location in the region&#39;s bounding box.</span>
<span class="linenos">274</span><span class="w">        </span><span class="n">numberAttempts</span><span class="o">++</span><span class="p">;</span>
<span class="linenos">275</span><span class="w">        </span><span class="n">rng</span><span class="o">-&gt;</span><span class="n">getRandomDoubles</span><span class="p">(</span><span class="n">randomValues</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">);</span>
<span class="linenos">276</span><span class="w">        </span><span class="n">point</span><span class="w"> </span><span class="nf">center</span><span class="p">(</span><span class="n">b</span><span class="p">.</span><span class="n">min</span><span class="p">.</span><span class="n">x</span><span class="o">+</span><span class="p">(((</span><span class="n">si_dist_t</span><span class="p">)</span><span class="n">randomValues</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="n">b</span><span class="p">.</span><span class="n">max</span><span class="p">.</span><span class="n">x</span><span class="o">-</span><span class="n">b</span><span class="p">.</span><span class="n">min</span><span class="p">.</span><span class="n">x</span><span class="p">)),</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">min</span><span class="p">.</span><span class="n">y</span><span class="o">+</span><span class="p">(((</span><span class="n">si_dist_t</span><span class="p">)</span><span class="n">randomValues</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="n">b</span><span class="p">.</span><span class="n">max</span><span class="p">.</span><span class="n">y</span><span class="o">-</span><span class="n">b</span><span class="p">.</span><span class="n">min</span><span class="p">.</span><span class="n">y</span><span class="p">)),</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">min</span><span class="p">.</span><span class="n">z</span><span class="o">+</span><span class="p">(((</span><span class="n">si_dist_t</span><span class="p">)</span><span class="n">randomValues</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="n">b</span><span class="p">.</span><span class="n">max</span><span class="p">.</span><span class="n">z</span><span class="o">-</span><span class="n">b</span><span class="p">.</span><span class="n">min</span><span class="p">.</span><span class="n">z</span><span class="p">)));</span>
<span class="linenos">277</span><span class="w">        </span><span class="n">s</span><span class="o">-&gt;</span><span class="n">setCenter</span><span class="p">(</span><span class="n">center</span><span class="p">);</span>
<span class="linenos">278</span>
<span class="linenos">279</span><span class="w">        </span><span class="c1">// Make sure the sphere is within one of the region&#39;s shapes.</span>
<span class="linenos">280</span><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Shape</span><span class="w"> </span><span class="o">*&gt;::</span><span class="n">iterator</span><span class="w"> </span><span class="n">it</span><span class="o">=</span><span class="n">regionShapes</span><span class="p">[</span><span class="n">region</span><span class="p">].</span><span class="n">begin</span><span class="p">();</span><span class="w"> </span><span class="n">it</span><span class="o">&lt;</span><span class="n">regionShapes</span><span class="p">[</span><span class="n">region</span><span class="p">].</span><span class="n">end</span><span class="p">();</span><span class="w"> </span><span class="n">it</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">281</span><span class="w">        </span><span class="p">{</span>
<span class="linenos">282</span><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="o">*</span><span class="n">it</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">contains</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>
<span class="linenos">283</span><span class="w">            </span><span class="p">{</span>
<span class="linenos">284</span><span class="w">            	</span><span class="c1">// Make sure the object does not overlap with regions with a higher type value.</span>
<span class="linenos">285</span><span class="w">            	</span><span class="kt">bool</span><span class="w"> </span><span class="n">overlaps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="linenos">286</span><span class="w">            	</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">definedRegions</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">overlaps</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">287</span><span class="w">            	</span><span class="p">{</span>
<span class="linenos">288</span><span class="w">            		</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">definedRegions</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">region</span><span class="p">)</span>
<span class="linenos">289</span><span class="w">            		</span><span class="p">{</span>
<span class="linenos">290</span><span class="w">            			</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Shape</span><span class="w"> </span><span class="o">*&gt;::</span><span class="n">iterator</span><span class="w"> </span><span class="n">it2</span><span class="o">=</span><span class="n">regionShapes</span><span class="p">[</span><span class="n">definedRegions</span><span class="p">[</span><span class="n">i</span><span class="p">]].</span><span class="n">begin</span><span class="p">();</span><span class="w"> </span><span class="n">it2</span><span class="o">&lt;</span><span class="n">regionShapes</span><span class="p">[</span><span class="n">definedRegions</span><span class="p">[</span><span class="n">i</span><span class="p">]].</span><span class="n">end</span><span class="p">();</span><span class="w"> </span><span class="n">it2</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">291</span><span class="w">            			</span><span class="p">{</span>
<span class="linenos">292</span><span class="w">            				</span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="o">*</span><span class="n">it2</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">contains</span><span class="p">(</span><span class="n">s</span><span class="p">))</span><span class="w"> </span><span class="c1">// TODO: this needs to be changes to intersects() after those methods are all implemented.</span>
<span class="linenos">293</span><span class="w">            				</span><span class="p">{</span>
<span class="linenos">294</span><span class="w">            					</span><span class="n">overlaps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="linenos">295</span><span class="w">            					</span><span class="k">break</span><span class="p">;</span>
<span class="linenos">296</span><span class="w">            				</span><span class="p">}</span>
<span class="linenos">297</span><span class="w">            			</span><span class="p">}</span>
<span class="linenos">298</span><span class="w">            		</span><span class="p">}</span>
<span class="linenos">299</span><span class="w">            	</span><span class="p">}</span>
<span class="linenos">300</span>
<span class="linenos">301</span><span class="w">                </span><span class="c1">//  If it didn&#39;t overlap, try to place the object.</span>
<span class="linenos">302</span><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">overlaps</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">placeObject</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>
<span class="linenos">303</span><span class="w">                </span><span class="p">{</span>
<span class="linenos">304</span><span class="w">					</span><span class="n">Print</span><span class="o">::</span><span class="n">printf</span><span class="p">(</span><span class="n">Print</span><span class="o">::</span><span class="n">VERBOSE_DEBUG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Placed sphere in region %d in %d attempts&quot;</span><span class="p">,</span><span class="n">region</span><span class="p">,</span><span class="n">numberAttempts</span><span class="p">);</span>
<span class="linenos">305</span><span class="w">					</span><span class="k">return</span><span class="w"> </span><span class="n">numberAttempts</span><span class="p">;</span>
<span class="linenos">306</span><span class="w">                </span><span class="p">}</span>
<span class="linenos">307</span><span class="w">            </span><span class="p">}</span>
<span class="linenos">308</span><span class="w">        </span><span class="p">}</span>
<span class="linenos">309</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">310</span><span class="p">}</span>
<span class="linenos">311</span>
<span class="linenos">312</span><span class="kt">void</span><span class="w"> </span><span class="n">LatticeBuilder</span><span class="o">::</span><span class="n">placeRandomSpheres</span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">count</span><span class="p">,</span><span class="w"> </span><span class="n">si_dist_t</span><span class="w"> </span><span class="n">radius</span><span class="p">,</span><span class="w"> </span><span class="n">site_t</span><span class="w"> </span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="n">site_t</span><span class="w"> </span><span class="n">region</span><span class="p">)</span>
<span class="linenos">313</span><span class="p">{</span>
<span class="linenos">314</span><span class="w">    </span><span class="n">uint</span><span class="w"> </span><span class="n">totalAttempts</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">315</span><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">count</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">316</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">317</span><span class="w">        </span><span class="n">totalAttempts</span><span class="o">+=</span><span class="n">placeRandomSphere</span><span class="p">(</span><span class="n">radius</span><span class="p">,</span><span class="w"> </span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="n">region</span><span class="p">);</span>
<span class="linenos">318</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">319</span><span class="w">    </span><span class="n">Print</span><span class="o">::</span><span class="n">printf</span><span class="p">(</span><span class="n">Print</span><span class="o">::</span><span class="n">DEBUG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Placed %d spheres of type %d in region %d in %d total attempts&quot;</span><span class="p">,</span><span class="n">count</span><span class="p">,</span><span class="n">type</span><span class="p">,</span><span class="n">region</span><span class="p">,</span><span class="n">totalAttempts</span><span class="p">);</span>
<span class="linenos">320</span><span class="p">}</span>
<span class="linenos">321</span>
<span class="linenos">322</span><span class="kt">void</span><span class="w"> </span><span class="n">LatticeBuilder</span><span class="o">::</span><span class="n">fillWithRandomSpheres</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">volumeFraction</span><span class="p">,</span><span class="w"> </span><span class="n">si_dist_t</span><span class="w"> </span><span class="n">radius</span><span class="p">,</span><span class="w"> </span><span class="n">site_t</span><span class="w"> </span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="n">site_t</span><span class="w"> </span><span class="n">region</span><span class="p">)</span>
<span class="linenos">323</span><span class="p">{</span>
<span class="linenos">324</span><span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">totalVolume</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>
<span class="linenos">325</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Shape</span><span class="w"> </span><span class="o">*&gt;</span><span class="w"> </span><span class="n">shapes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">regionShapes</span><span class="p">[</span><span class="n">region</span><span class="p">];</span>
<span class="linenos">326</span><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Shape</span><span class="w"> </span><span class="o">*&gt;::</span><span class="n">iterator</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">shapes</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">shapes</span><span class="p">.</span><span class="n">end</span><span class="p">();</span><span class="w"> </span><span class="n">it</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">327</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">328</span><span class="w">        </span><span class="n">Shape</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">shape</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">it</span><span class="p">;</span>
<span class="linenos">329</span><span class="w">        </span><span class="n">totalVolume</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">shape</span><span class="o">-&gt;</span><span class="n">getVolume</span><span class="p">();</span>
<span class="linenos">330</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">331</span>
<span class="linenos">332</span><span class="w">    </span><span class="n">uint</span><span class="w"> </span><span class="n">numberSpheres</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">floor</span><span class="p">((</span><span class="n">totalVolume</span><span class="o">*</span><span class="n">volumeFraction</span><span class="p">)</span><span class="o">/</span><span class="p">((</span><span class="mf">4.0</span><span class="o">/</span><span class="mf">3.0</span><span class="p">)</span><span class="o">*</span><span class="n">PI</span><span class="o">*</span><span class="n">radius</span><span class="o">*</span><span class="n">radius</span><span class="o">*</span><span class="n">radius</span><span class="p">));</span>
<span class="linenos">333</span><span class="w">    </span><span class="n">Print</span><span class="o">::</span><span class="n">printf</span><span class="p">(</span><span class="n">Print</span><span class="o">::</span><span class="n">DEBUG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Placing %d spheres of radius %0.2e in volume of %e m^3&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">numberSpheres</span><span class="p">,</span><span class="w"> </span><span class="n">radius</span><span class="p">,</span><span class="w"> </span><span class="n">totalVolume</span><span class="p">);</span>
<span class="linenos">334</span><span class="w">    </span><span class="n">placeRandomSpheres</span><span class="p">(</span><span class="n">numberSpheres</span><span class="p">,</span><span class="w"> </span><span class="n">radius</span><span class="p">,</span><span class="w"> </span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="n">region</span><span class="p">);</span>
<span class="linenos">335</span>
<span class="linenos">336</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Print</span><span class="o">::</span><span class="n">ifPrinted</span><span class="p">(</span><span class="mi">9</span><span class="p">))</span><span class="w">  </span><span class="p">{</span>
<span class="linenos">337</span><span class="w">       </span><span class="n">uint</span><span class="w"> </span><span class="n">totalGridObjects</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">338</span><span class="w">       </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">collisionGridXSize</span><span class="o">*</span><span class="n">collisionGridYSize</span><span class="o">*</span><span class="n">collisionGridZSize</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">339</span><span class="w">	   </span><span class="n">totalGridObjects</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">collisionGridOccupancy</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="linenos">340</span><span class="w">       </span><span class="n">Print</span><span class="o">::</span><span class="n">printf</span><span class="p">(</span><span class="n">Print</span><span class="o">::</span><span class="n">DEBUG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Number of grid volumes was %d with an mean of %0.2f objects each&quot;</span><span class="p">,</span><span class="n">collisionGridXSize</span><span class="o">*</span><span class="n">collisionGridYSize</span><span class="o">*</span><span class="n">collisionGridZSize</span><span class="p">,((</span><span class="kt">double</span><span class="p">)</span><span class="n">totalGridObjects</span><span class="p">)</span><span class="o">/</span><span class="p">((</span><span class="kt">double</span><span class="p">)</span><span class="n">collisionGridXSize</span><span class="o">*</span><span class="n">collisionGridYSize</span><span class="o">*</span><span class="n">collisionGridZSize</span><span class="p">));</span>
<span class="linenos">341</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">342</span><span class="p">}</span>
<span class="linenos">343</span>
<span class="linenos">344</span><span class="kt">void</span><span class="w"> </span><span class="n">LatticeBuilder</span><span class="o">::</span><span class="n">getSpatialModel</span><span class="p">(</span><span class="n">SpatialModel</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">spatialModel</span><span class="p">)</span>
<span class="linenos">345</span><span class="p">{</span>
<span class="linenos">346</span><span class="w">	</span><span class="n">spatialModel</span><span class="o">-&gt;</span><span class="n">Clear</span><span class="p">();</span>
<span class="linenos">347</span>
<span class="linenos">348</span><span class="w">	</span><span class="c1">// Set all of the regions.</span>
<span class="linenos">349</span><span class="w">	</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">site_t</span><span class="p">,</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Shape</span><span class="w"> </span><span class="o">*&gt;</span><span class="w"> </span><span class="o">&gt;::</span><span class="n">iterator</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">regionShapes</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">regionShapes</span><span class="p">.</span><span class="n">end</span><span class="p">();</span><span class="w"> </span><span class="n">it</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">350</span><span class="w">	</span><span class="p">{</span>
<span class="linenos">351</span><span class="w">		</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Shape</span><span class="w"> </span><span class="o">*&gt;</span><span class="w"> </span><span class="n">shapes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">it</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">;</span>
<span class="linenos">352</span><span class="w">		</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Shape</span><span class="w"> </span><span class="o">*&gt;::</span><span class="n">iterator</span><span class="w"> </span><span class="n">it2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">shapes</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span><span class="w"> </span><span class="n">it2</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">shapes</span><span class="p">.</span><span class="n">end</span><span class="p">();</span><span class="w"> </span><span class="n">it2</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">353</span><span class="w">		</span><span class="p">{</span>
<span class="linenos">354</span><span class="w">			</span><span class="n">Shape</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">shape</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">it2</span><span class="p">;</span>
<span class="linenos">355</span><span class="w">			</span><span class="n">spatialModel</span><span class="o">-&gt;</span><span class="n">add_region</span><span class="p">();</span>
<span class="linenos">356</span><span class="w">			</span><span class="n">uint</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">spatialModel</span><span class="o">-&gt;</span><span class="n">region_size</span><span class="p">()</span><span class="mi">-1</span><span class="p">;</span>
<span class="linenos">357</span><span class="w">			</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">shape</span><span class="o">-&gt;</span><span class="n">getShapeType</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Shape</span><span class="o">::</span><span class="n">SPHERE</span><span class="p">)</span><span class="w"> </span>
<span class="linenos">358</span><span class="w">            </span><span class="p">{</span>
<span class="linenos">359</span><span class="w">				</span><span class="n">Sphere</span><span class="w"> </span><span class="o">*</span><span class="n">sphere</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Sphere</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">shape</span><span class="p">;</span>
<span class="linenos">360</span><span class="w">				</span><span class="n">spatialModel</span><span class="o">-&gt;</span><span class="n">mutable_region</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">set_shape</span><span class="p">(</span><span class="n">sphere</span><span class="o">-&gt;</span><span class="n">getShapeType</span><span class="p">());</span>
<span class="linenos">361</span><span class="w">				</span><span class="n">spatialModel</span><span class="o">-&gt;</span><span class="n">mutable_region</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">set_site_type</span><span class="p">(</span><span class="n">sphere</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span>
<span class="linenos">362</span><span class="w">				</span><span class="n">spatialModel</span><span class="o">-&gt;</span><span class="n">mutable_region</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">add_shape_parameter</span><span class="p">(</span><span class="n">sphere</span><span class="o">-&gt;</span><span class="n">getCenter</span><span class="p">().</span><span class="n">x</span><span class="p">);</span>
<span class="linenos">363</span><span class="w">				</span><span class="n">spatialModel</span><span class="o">-&gt;</span><span class="n">mutable_region</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">add_shape_parameter</span><span class="p">(</span><span class="n">sphere</span><span class="o">-&gt;</span><span class="n">getCenter</span><span class="p">().</span><span class="n">y</span><span class="p">);</span>
<span class="linenos">364</span><span class="w">				</span><span class="n">spatialModel</span><span class="o">-&gt;</span><span class="n">mutable_region</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">add_shape_parameter</span><span class="p">(</span><span class="n">sphere</span><span class="o">-&gt;</span><span class="n">getCenter</span><span class="p">().</span><span class="n">z</span><span class="p">);</span>
<span class="linenos">365</span><span class="w">				</span><span class="n">spatialModel</span><span class="o">-&gt;</span><span class="n">mutable_region</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">add_shape_parameter</span><span class="p">(</span><span class="n">sphere</span><span class="o">-&gt;</span><span class="n">getRadius</span><span class="p">());;</span>
<span class="linenos">366</span><span class="w">            </span><span class="p">}</span>
<span class="linenos">367</span><span class="w">            </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">shape</span><span class="o">-&gt;</span><span class="n">getShapeType</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Shape</span><span class="o">::</span><span class="n">HEMISPHERE</span><span class="p">)</span>
<span class="linenos">368</span><span class="w">            </span><span class="p">{</span>
<span class="linenos">369</span><span class="w">                </span><span class="n">Hemisphere</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">hemisphere</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Hemisphere</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">shape</span><span class="p">;</span>
<span class="linenos">370</span><span class="w">                </span><span class="n">spatialModel</span><span class="o">-&gt;</span><span class="n">mutable_region</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">set_shape</span><span class="p">(</span><span class="n">hemisphere</span><span class="o">-&gt;</span><span class="n">getShapeType</span><span class="p">());</span>
<span class="linenos">371</span><span class="w">                </span><span class="n">spatialModel</span><span class="o">-&gt;</span><span class="n">mutable_region</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">set_site_type</span><span class="p">(</span><span class="n">hemisphere</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span>
<span class="linenos">372</span><span class="w">                </span><span class="n">spatialModel</span><span class="o">-&gt;</span><span class="n">mutable_region</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">add_shape_parameter</span><span class="p">(</span><span class="n">hemisphere</span><span class="o">-&gt;</span><span class="n">getCenter</span><span class="p">().</span><span class="n">x</span><span class="p">);</span>
<span class="linenos">373</span><span class="w">                </span><span class="n">spatialModel</span><span class="o">-&gt;</span><span class="n">mutable_region</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">add_shape_parameter</span><span class="p">(</span><span class="n">hemisphere</span><span class="o">-&gt;</span><span class="n">getCenter</span><span class="p">().</span><span class="n">y</span><span class="p">);</span>
<span class="linenos">374</span><span class="w">                </span><span class="n">spatialModel</span><span class="o">-&gt;</span><span class="n">mutable_region</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">add_shape_parameter</span><span class="p">(</span><span class="n">hemisphere</span><span class="o">-&gt;</span><span class="n">getCenter</span><span class="p">().</span><span class="n">z</span><span class="p">);</span>
<span class="linenos">375</span><span class="w">                </span><span class="n">spatialModel</span><span class="o">-&gt;</span><span class="n">mutable_region</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">add_shape_parameter</span><span class="p">(</span><span class="n">hemisphere</span><span class="o">-&gt;</span><span class="n">getOrientation</span><span class="p">().</span><span class="n">x</span><span class="p">);</span>
<span class="linenos">376</span><span class="w">                </span><span class="n">spatialModel</span><span class="o">-&gt;</span><span class="n">mutable_region</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">add_shape_parameter</span><span class="p">(</span><span class="n">hemisphere</span><span class="o">-&gt;</span><span class="n">getOrientation</span><span class="p">().</span><span class="n">y</span><span class="p">);</span>
<span class="linenos">377</span><span class="w">                </span><span class="n">spatialModel</span><span class="o">-&gt;</span><span class="n">mutable_region</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">add_shape_parameter</span><span class="p">(</span><span class="n">hemisphere</span><span class="o">-&gt;</span><span class="n">getOrientation</span><span class="p">().</span><span class="n">z</span><span class="p">);</span>
<span class="linenos">378</span><span class="w">                </span><span class="n">spatialModel</span><span class="o">-&gt;</span><span class="n">mutable_region</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">add_shape_parameter</span><span class="p">(</span><span class="n">hemisphere</span><span class="o">-&gt;</span><span class="n">getRadius</span><span class="p">());</span>
<span class="linenos">379</span><span class="w">            </span><span class="p">}</span>
<span class="linenos">380</span><span class="w">			</span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">shape</span><span class="o">-&gt;</span><span class="n">getShapeType</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Shape</span><span class="o">::</span><span class="n">CAPSULE</span><span class="p">)</span>
<span class="linenos">381</span><span class="w">			</span><span class="p">{</span>
<span class="linenos">382</span><span class="w">				</span><span class="n">Capsule</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">capsule</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Capsule</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">shape</span><span class="p">;</span>
<span class="linenos">383</span><span class="w">				</span><span class="n">spatialModel</span><span class="o">-&gt;</span><span class="n">mutable_region</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">set_shape</span><span class="p">(</span><span class="n">capsule</span><span class="o">-&gt;</span><span class="n">getShapeType</span><span class="p">());</span>
<span class="linenos">384</span><span class="w">				</span><span class="n">spatialModel</span><span class="o">-&gt;</span><span class="n">mutable_region</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">set_site_type</span><span class="p">(</span><span class="n">capsule</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span>
<span class="linenos">385</span><span class="w">				</span><span class="n">spatialModel</span><span class="o">-&gt;</span><span class="n">mutable_region</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">add_shape_parameter</span><span class="p">(</span><span class="n">capsule</span><span class="o">-&gt;</span><span class="n">getP1</span><span class="p">().</span><span class="n">x</span><span class="p">);</span>
<span class="linenos">386</span><span class="w">				</span><span class="n">spatialModel</span><span class="o">-&gt;</span><span class="n">mutable_region</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">add_shape_parameter</span><span class="p">(</span><span class="n">capsule</span><span class="o">-&gt;</span><span class="n">getP1</span><span class="p">().</span><span class="n">y</span><span class="p">);</span>
<span class="linenos">387</span><span class="w">				</span><span class="n">spatialModel</span><span class="o">-&gt;</span><span class="n">mutable_region</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">add_shape_parameter</span><span class="p">(</span><span class="n">capsule</span><span class="o">-&gt;</span><span class="n">getP1</span><span class="p">().</span><span class="n">z</span><span class="p">);</span>
<span class="linenos">388</span><span class="w">				</span><span class="n">spatialModel</span><span class="o">-&gt;</span><span class="n">mutable_region</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">add_shape_parameter</span><span class="p">(</span><span class="n">capsule</span><span class="o">-&gt;</span><span class="n">getP2</span><span class="p">().</span><span class="n">x</span><span class="p">);</span>
<span class="linenos">389</span><span class="w">				</span><span class="n">spatialModel</span><span class="o">-&gt;</span><span class="n">mutable_region</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">add_shape_parameter</span><span class="p">(</span><span class="n">capsule</span><span class="o">-&gt;</span><span class="n">getP2</span><span class="p">().</span><span class="n">y</span><span class="p">);</span>
<span class="linenos">390</span><span class="w">				</span><span class="n">spatialModel</span><span class="o">-&gt;</span><span class="n">mutable_region</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">add_shape_parameter</span><span class="p">(</span><span class="n">capsule</span><span class="o">-&gt;</span><span class="n">getP2</span><span class="p">().</span><span class="n">z</span><span class="p">);</span>
<span class="linenos">391</span><span class="w">				</span><span class="n">spatialModel</span><span class="o">-&gt;</span><span class="n">mutable_region</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">add_shape_parameter</span><span class="p">(</span><span class="n">capsule</span><span class="o">-&gt;</span><span class="n">getRadius</span><span class="p">());</span>
<span class="linenos">392</span><span class="w">			</span><span class="p">}</span>
<span class="linenos">393</span><span class="w">			</span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">shape</span><span class="o">-&gt;</span><span class="n">getShapeType</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Shape</span><span class="o">::</span><span class="n">CAPSULE_SHELL</span><span class="p">)</span>
<span class="linenos">394</span><span class="w">			</span><span class="p">{</span>
<span class="linenos">395</span><span class="w">				</span><span class="n">CapsuleShell</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">capsuleShell</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">CapsuleShell</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">shape</span><span class="p">;</span>
<span class="linenos">396</span><span class="w">				</span><span class="n">spatialModel</span><span class="o">-&gt;</span><span class="n">mutable_region</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">set_shape</span><span class="p">(</span><span class="n">capsuleShell</span><span class="o">-&gt;</span><span class="n">getShapeType</span><span class="p">());</span>
<span class="linenos">397</span><span class="w">				</span><span class="n">spatialModel</span><span class="o">-&gt;</span><span class="n">mutable_region</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">set_site_type</span><span class="p">(</span><span class="n">capsuleShell</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span>
<span class="linenos">398</span><span class="w">				</span><span class="n">spatialModel</span><span class="o">-&gt;</span><span class="n">mutable_region</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">add_shape_parameter</span><span class="p">(</span><span class="n">capsuleShell</span><span class="o">-&gt;</span><span class="n">getP1</span><span class="p">().</span><span class="n">x</span><span class="p">);</span>
<span class="linenos">399</span><span class="w">				</span><span class="n">spatialModel</span><span class="o">-&gt;</span><span class="n">mutable_region</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">add_shape_parameter</span><span class="p">(</span><span class="n">capsuleShell</span><span class="o">-&gt;</span><span class="n">getP1</span><span class="p">().</span><span class="n">y</span><span class="p">);</span>
<span class="linenos">400</span><span class="w">				</span><span class="n">spatialModel</span><span class="o">-&gt;</span><span class="n">mutable_region</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">add_shape_parameter</span><span class="p">(</span><span class="n">capsuleShell</span><span class="o">-&gt;</span><span class="n">getP1</span><span class="p">().</span><span class="n">z</span><span class="p">);</span>
<span class="linenos">401</span><span class="w">				</span><span class="n">spatialModel</span><span class="o">-&gt;</span><span class="n">mutable_region</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">add_shape_parameter</span><span class="p">(</span><span class="n">capsuleShell</span><span class="o">-&gt;</span><span class="n">getP2</span><span class="p">().</span><span class="n">x</span><span class="p">);</span>
<span class="linenos">402</span><span class="w">				</span><span class="n">spatialModel</span><span class="o">-&gt;</span><span class="n">mutable_region</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">add_shape_parameter</span><span class="p">(</span><span class="n">capsuleShell</span><span class="o">-&gt;</span><span class="n">getP2</span><span class="p">().</span><span class="n">y</span><span class="p">);</span>
<span class="linenos">403</span><span class="w">				</span><span class="n">spatialModel</span><span class="o">-&gt;</span><span class="n">mutable_region</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">add_shape_parameter</span><span class="p">(</span><span class="n">capsuleShell</span><span class="o">-&gt;</span><span class="n">getP2</span><span class="p">().</span><span class="n">z</span><span class="p">);</span>
<span class="linenos">404</span><span class="w">				</span><span class="n">spatialModel</span><span class="o">-&gt;</span><span class="n">mutable_region</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">add_shape_parameter</span><span class="p">(</span><span class="n">capsuleShell</span><span class="o">-&gt;</span><span class="n">getOuterRadius</span><span class="p">());</span>
<span class="linenos">405</span><span class="w">				</span><span class="n">spatialModel</span><span class="o">-&gt;</span><span class="n">mutable_region</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">add_shape_parameter</span><span class="p">(</span><span class="n">capsuleShell</span><span class="o">-&gt;</span><span class="n">getInnerRadius</span><span class="p">());</span>
<span class="linenos">406</span><span class="w">			</span><span class="p">}</span>
<span class="linenos">407</span><span class="w">			</span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">shape</span><span class="o">-&gt;</span><span class="n">getShapeType</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Shape</span><span class="o">::</span><span class="n">CUBOID</span><span class="p">)</span>
<span class="linenos">408</span><span class="w">			</span><span class="p">{</span>
<span class="linenos">409</span><span class="w">				</span><span class="n">Cuboid</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">cuboid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Cuboid</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">shape</span><span class="p">;</span>
<span class="linenos">410</span><span class="w">				</span><span class="n">spatialModel</span><span class="o">-&gt;</span><span class="n">mutable_region</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">set_shape</span><span class="p">(</span><span class="n">cuboid</span><span class="o">-&gt;</span><span class="n">getShapeType</span><span class="p">());</span>
<span class="linenos">411</span><span class="w">				</span><span class="n">spatialModel</span><span class="o">-&gt;</span><span class="n">mutable_region</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">set_site_type</span><span class="p">(</span><span class="n">cuboid</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span>
<span class="linenos">412</span><span class="w">				</span><span class="n">spatialModel</span><span class="o">-&gt;</span><span class="n">mutable_region</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">add_shape_parameter</span><span class="p">(</span><span class="n">cuboid</span><span class="o">-&gt;</span><span class="n">getP1</span><span class="p">().</span><span class="n">x</span><span class="p">);</span>
<span class="linenos">413</span><span class="w">				</span><span class="n">spatialModel</span><span class="o">-&gt;</span><span class="n">mutable_region</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">add_shape_parameter</span><span class="p">(</span><span class="n">cuboid</span><span class="o">-&gt;</span><span class="n">getP1</span><span class="p">().</span><span class="n">y</span><span class="p">);</span>
<span class="linenos">414</span><span class="w">				</span><span class="n">spatialModel</span><span class="o">-&gt;</span><span class="n">mutable_region</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">add_shape_parameter</span><span class="p">(</span><span class="n">cuboid</span><span class="o">-&gt;</span><span class="n">getP1</span><span class="p">().</span><span class="n">z</span><span class="p">);</span>
<span class="linenos">415</span><span class="w">				</span><span class="n">spatialModel</span><span class="o">-&gt;</span><span class="n">mutable_region</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">add_shape_parameter</span><span class="p">(</span><span class="n">cuboid</span><span class="o">-&gt;</span><span class="n">getP2</span><span class="p">().</span><span class="n">x</span><span class="p">);</span>
<span class="linenos">416</span><span class="w">				</span><span class="n">spatialModel</span><span class="o">-&gt;</span><span class="n">mutable_region</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">add_shape_parameter</span><span class="p">(</span><span class="n">cuboid</span><span class="o">-&gt;</span><span class="n">getP2</span><span class="p">().</span><span class="n">y</span><span class="p">);</span>
<span class="linenos">417</span><span class="w">				</span><span class="n">spatialModel</span><span class="o">-&gt;</span><span class="n">mutable_region</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">add_shape_parameter</span><span class="p">(</span><span class="n">cuboid</span><span class="o">-&gt;</span><span class="n">getP2</span><span class="p">().</span><span class="n">z</span><span class="p">);</span>
<span class="linenos">418</span><span class="w">			</span><span class="p">}</span>
<span class="linenos">419</span><span class="w">			</span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">shape</span><span class="o">-&gt;</span><span class="n">getShapeType</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Shape</span><span class="o">::</span><span class="n">UNION</span><span class="p">)</span>
<span class="linenos">420</span><span class="w">			</span><span class="p">{</span>
<span class="linenos">421</span><span class="w">				</span><span class="n">Union</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">uni</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Union</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">shape</span><span class="p">;</span>
<span class="linenos">422</span><span class="w">				</span><span class="n">spatialModel</span><span class="o">-&gt;</span><span class="n">mutable_region</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">set_shape</span><span class="p">(</span><span class="n">uni</span><span class="o">-&gt;</span><span class="n">getShapeType</span><span class="p">());</span>
<span class="linenos">423</span><span class="w">				</span><span class="n">spatialModel</span><span class="o">-&gt;</span><span class="n">mutable_region</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">set_site_type</span><span class="p">(</span><span class="n">uni</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span>
<span class="linenos">424</span><span class="w">                </span><span class="c1">// TODO: add union shape parameters</span>
<span class="linenos">425</span><span class="w">                </span><span class="cm">/*</span>
<span class="linenos">426</span><span class="cm">				spatialModel-&gt;mutable_region(i)-&gt;add_shape_parameter(cuboid-&gt;getP1().x);</span>
<span class="linenos">427</span><span class="cm">				spatialModel-&gt;mutable_region(i)-&gt;add_shape_parameter(cuboid-&gt;getP1().y);</span>
<span class="linenos">428</span><span class="cm">				spatialModel-&gt;mutable_region(i)-&gt;add_shape_parameter(cuboid-&gt;getP1().z);</span>
<span class="linenos">429</span><span class="cm">				spatialModel-&gt;mutable_region(i)-&gt;add_shape_parameter(cuboid-&gt;getP2().x);</span>
<span class="linenos">430</span><span class="cm">				spatialModel-&gt;mutable_region(i)-&gt;add_shape_parameter(cuboid-&gt;getP2().y);</span>
<span class="linenos">431</span><span class="cm">				spatialModel-&gt;mutable_region(i)-&gt;add_shape_parameter(cuboid-&gt;getP2().z);</span>
<span class="linenos">432</span><span class="cm">                 */</span>
<span class="linenos">433</span><span class="w">			</span><span class="p">}</span>
<span class="linenos">434</span><span class="w">			</span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">shape</span><span class="o">-&gt;</span><span class="n">getShapeType</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Shape</span><span class="o">::</span><span class="n">UNIONSET</span><span class="p">)</span>
<span class="linenos">435</span><span class="w">			</span><span class="p">{</span>
<span class="linenos">436</span><span class="w">				</span><span class="n">UnionSet</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">uni</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">UnionSet</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">shape</span><span class="p">;</span>
<span class="linenos">437</span><span class="w">				</span><span class="n">spatialModel</span><span class="o">-&gt;</span><span class="n">mutable_region</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">set_shape</span><span class="p">(</span><span class="n">uni</span><span class="o">-&gt;</span><span class="n">getShapeType</span><span class="p">());</span>
<span class="linenos">438</span><span class="w">				</span><span class="n">spatialModel</span><span class="o">-&gt;</span><span class="n">mutable_region</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">set_site_type</span><span class="p">(</span><span class="n">uni</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span>
<span class="linenos">439</span><span class="w">                </span><span class="c1">// TODO: add union shape parameters</span>
<span class="linenos">440</span><span class="w">                </span><span class="cm">/*</span>
<span class="linenos">441</span><span class="cm">				spatialModel-&gt;mutable_region(i)-&gt;add_shape_parameter(cuboid-&gt;getP1().x);</span>
<span class="linenos">442</span><span class="cm">				spatialModel-&gt;mutable_region(i)-&gt;add_shape_parameter(cuboid-&gt;getP1().y);</span>
<span class="linenos">443</span><span class="cm">				spatialModel-&gt;mutable_region(i)-&gt;add_shape_parameter(cuboid-&gt;getP1().z);</span>
<span class="linenos">444</span><span class="cm">				spatialModel-&gt;mutable_region(i)-&gt;add_shape_parameter(cuboid-&gt;getP2().x);</span>
<span class="linenos">445</span><span class="cm">				spatialModel-&gt;mutable_region(i)-&gt;add_shape_parameter(cuboid-&gt;getP2().y);</span>
<span class="linenos">446</span><span class="cm">				spatialModel-&gt;mutable_region(i)-&gt;add_shape_parameter(cuboid-&gt;getP2().z);</span>
<span class="linenos">447</span><span class="cm">                 */</span>
<span class="linenos">448</span><span class="w">			</span><span class="p">}</span>
<span class="linenos">449</span><span class="w">            </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">shape</span><span class="o">-&gt;</span><span class="n">getShapeType</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Shape</span><span class="o">::</span><span class="n">INTERSECTION</span><span class="p">)</span>
<span class="linenos">450</span><span class="w">			</span><span class="p">{</span>
<span class="linenos">451</span><span class="w">				</span><span class="n">Intersection</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">interObj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Intersection</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">shape</span><span class="p">;</span>
<span class="linenos">452</span><span class="w">				</span><span class="n">spatialModel</span><span class="o">-&gt;</span><span class="n">mutable_region</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">set_shape</span><span class="p">(</span><span class="n">interObj</span><span class="o">-&gt;</span><span class="n">getShapeType</span><span class="p">());</span>
<span class="linenos">453</span><span class="w">				</span><span class="n">spatialModel</span><span class="o">-&gt;</span><span class="n">mutable_region</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">set_site_type</span><span class="p">(</span><span class="n">interObj</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span>
<span class="linenos">454</span><span class="w">                </span><span class="c1">// TODO: add intersection shape parameters</span>
<span class="linenos">455</span><span class="w">                </span><span class="cm">/*</span>
<span class="linenos">456</span><span class="cm">				spatialModel-&gt;mutable_region(i)-&gt;add_shape_parameter(cuboid-&gt;getP1().x);</span>
<span class="linenos">457</span><span class="cm">				spatialModel-&gt;mutable_region(i)-&gt;add_shape_parameter(cuboid-&gt;getP1().y);</span>
<span class="linenos">458</span><span class="cm">				spatialModel-&gt;mutable_region(i)-&gt;add_shape_parameter(cuboid-&gt;getP1().z);</span>
<span class="linenos">459</span><span class="cm">				spatialModel-&gt;mutable_region(i)-&gt;add_shape_parameter(cuboid-&gt;getP2().x);</span>
<span class="linenos">460</span><span class="cm">				spatialModel-&gt;mutable_region(i)-&gt;add_shape_parameter(cuboid-&gt;getP2().y);</span>
<span class="linenos">461</span><span class="cm">				spatialModel-&gt;mutable_region(i)-&gt;add_shape_parameter(cuboid-&gt;getP2().z);</span>
<span class="linenos">462</span><span class="cm">                */</span>
<span class="linenos">463</span><span class="w">			</span><span class="p">}</span>
<span class="linenos">464</span><span class="w">            </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">shape</span><span class="o">-&gt;</span><span class="n">getShapeType</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Shape</span><span class="o">::</span><span class="n">DIFFERENCE</span><span class="p">)</span>
<span class="linenos">465</span><span class="w">			</span><span class="p">{</span>
<span class="linenos">466</span><span class="w">				</span><span class="n">Difference</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">diffObj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Difference</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">shape</span><span class="p">;</span>
<span class="linenos">467</span><span class="w">				</span><span class="n">spatialModel</span><span class="o">-&gt;</span><span class="n">mutable_region</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">set_shape</span><span class="p">(</span><span class="n">diffObj</span><span class="o">-&gt;</span><span class="n">getShapeType</span><span class="p">());</span>
<span class="linenos">468</span><span class="w">				</span><span class="n">spatialModel</span><span class="o">-&gt;</span><span class="n">mutable_region</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">set_site_type</span><span class="p">(</span><span class="n">diffObj</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span>
<span class="linenos">469</span><span class="w">                </span><span class="c1">// TODO: add difference shape parameters</span>
<span class="linenos">470</span><span class="w">                </span><span class="cm">/*</span>
<span class="linenos">471</span><span class="cm">				spatialModel-&gt;mutable_region(i)-&gt;add_shape_parameter(diffObj-&gt;getP1().x);</span>
<span class="linenos">472</span><span class="cm">				spatialModel-&gt;mutable_region(i)-&gt;add_shape_parameter(diffObj-&gt;getP1().y);</span>
<span class="linenos">473</span><span class="cm">				spatialModel-&gt;mutable_region(i)-&gt;add_shape_parameter(diffObj-&gt;getP1().z);</span>
<span class="linenos">474</span><span class="cm">				spatialModel-&gt;mutable_region(i)-&gt;add_shape_parameter(diffObj-&gt;getP2().x);</span>
<span class="linenos">475</span><span class="cm">				spatialModel-&gt;mutable_region(i)-&gt;add_shape_parameter(diffObj-&gt;getP2().y);</span>
<span class="linenos">476</span><span class="cm">				spatialModel-&gt;mutable_region(i)-&gt;add_shape_parameter(diffObj-&gt;getP2().z);</span>
<span class="linenos">477</span><span class="cm">                 */</span>
<span class="linenos">478</span><span class="w">			</span><span class="p">}</span>
<span class="linenos">479</span><span class="w">            </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">shape</span><span class="o">-&gt;</span><span class="n">getShapeType</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Shape</span><span class="o">::</span><span class="n">TORUS</span><span class="p">)</span>
<span class="linenos">480</span><span class="w">			</span><span class="p">{</span>
<span class="linenos">481</span><span class="w">				</span><span class="n">Torus</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">torObj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Torus</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">shape</span><span class="p">;</span>
<span class="linenos">482</span><span class="w">				</span><span class="n">spatialModel</span><span class="o">-&gt;</span><span class="n">mutable_region</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">set_shape</span><span class="p">(</span><span class="n">torObj</span><span class="o">-&gt;</span><span class="n">getShapeType</span><span class="p">());</span>
<span class="linenos">483</span><span class="w">				</span><span class="n">spatialModel</span><span class="o">-&gt;</span><span class="n">mutable_region</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">set_site_type</span><span class="p">(</span><span class="n">torObj</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span>
<span class="linenos">484</span><span class="w">                </span><span class="c1">// TODO: add difference shape parameters</span>
<span class="linenos">485</span><span class="w">                </span><span class="cm">/*</span>
<span class="linenos">486</span><span class="cm">                 spatialModel-&gt;mutable_region(i)-&gt;add_shape_parameter(diffObj-&gt;getP1().x);</span>
<span class="linenos">487</span><span class="cm">                 spatialModel-&gt;mutable_region(i)-&gt;add_shape_parameter(diffObj-&gt;getP1().y);</span>
<span class="linenos">488</span><span class="cm">                 spatialModel-&gt;mutable_region(i)-&gt;add_shape_parameter(diffObj-&gt;getP1().z);</span>
<span class="linenos">489</span><span class="cm">                 spatialModel-&gt;mutable_region(i)-&gt;add_shape_parameter(diffObj-&gt;getP2().x);</span>
<span class="linenos">490</span><span class="cm">                 spatialModel-&gt;mutable_region(i)-&gt;add_shape_parameter(diffObj-&gt;getP2().y);</span>
<span class="linenos">491</span><span class="cm">                 spatialModel-&gt;mutable_region(i)-&gt;add_shape_parameter(diffObj-&gt;getP2().z);</span>
<span class="linenos">492</span><span class="cm">                 */</span>
<span class="linenos">493</span><span class="w">			</span><span class="p">}</span>
<span class="linenos">494</span><span class="w">            </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">shape</span><span class="o">-&gt;</span><span class="n">getShapeType</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Shape</span><span class="o">::</span><span class="n">ELLIPSE</span><span class="p">)</span>
<span class="linenos">495</span><span class="w">			</span><span class="p">{</span>
<span class="linenos">496</span><span class="w">				</span><span class="n">Ellipse</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">ellObj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Ellipse</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">shape</span><span class="p">;</span>
<span class="linenos">497</span><span class="w">				</span><span class="n">spatialModel</span><span class="o">-&gt;</span><span class="n">mutable_region</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">set_shape</span><span class="p">(</span><span class="n">ellObj</span><span class="o">-&gt;</span><span class="n">getShapeType</span><span class="p">());</span>
<span class="linenos">498</span><span class="w">				</span><span class="n">spatialModel</span><span class="o">-&gt;</span><span class="n">mutable_region</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">set_site_type</span><span class="p">(</span><span class="n">ellObj</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span>
<span class="linenos">499</span><span class="w">                </span><span class="c1">// TODO: add difference shape parameters</span>
<span class="linenos">500</span><span class="w">                </span><span class="cm">/*</span>
<span class="linenos">501</span><span class="cm">                 spatialModel-&gt;mutable_region(i)-&gt;add_shape_parameter(diffObj-&gt;getP1().x);</span>
<span class="linenos">502</span><span class="cm">                 spatialModel-&gt;mutable_region(i)-&gt;add_shape_parameter(diffObj-&gt;getP1().y);</span>
<span class="linenos">503</span><span class="cm">                 spatialModel-&gt;mutable_region(i)-&gt;add_shape_parameter(diffObj-&gt;getP1().z);</span>
<span class="linenos">504</span><span class="cm">                 spatialModel-&gt;mutable_region(i)-&gt;add_shape_parameter(diffObj-&gt;getP2().x);</span>
<span class="linenos">505</span><span class="cm">                 spatialModel-&gt;mutable_region(i)-&gt;add_shape_parameter(diffObj-&gt;getP2().y);</span>
<span class="linenos">506</span><span class="cm">                 spatialModel-&gt;mutable_region(i)-&gt;add_shape_parameter(diffObj-&gt;getP2().z);</span>
<span class="linenos">507</span><span class="cm">                 */</span>
<span class="linenos">508</span><span class="w">			</span><span class="p">}</span>
<span class="linenos">509</span><span class="w">            </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">shape</span><span class="o">-&gt;</span><span class="n">getShapeType</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Shape</span><span class="o">::</span><span class="n">CYLINDER</span><span class="p">)</span>
<span class="linenos">510</span><span class="w">			</span><span class="p">{</span>
<span class="linenos">511</span><span class="w">				</span><span class="n">Cylinder</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">cylObj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Cylinder</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">shape</span><span class="p">;</span>
<span class="linenos">512</span><span class="w">				</span><span class="n">spatialModel</span><span class="o">-&gt;</span><span class="n">mutable_region</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">set_shape</span><span class="p">(</span><span class="n">cylObj</span><span class="o">-&gt;</span><span class="n">getShapeType</span><span class="p">());</span>
<span class="linenos">513</span><span class="w">				</span><span class="n">spatialModel</span><span class="o">-&gt;</span><span class="n">mutable_region</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">set_site_type</span><span class="p">(</span><span class="n">cylObj</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span>
<span class="linenos">514</span><span class="w">				</span><span class="n">spatialModel</span><span class="o">-&gt;</span><span class="n">mutable_region</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">add_shape_parameter</span><span class="p">(</span><span class="n">cylObj</span><span class="o">-&gt;</span><span class="n">getP1</span><span class="p">().</span><span class="n">x</span><span class="p">);</span>
<span class="linenos">515</span><span class="w">				</span><span class="n">spatialModel</span><span class="o">-&gt;</span><span class="n">mutable_region</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">add_shape_parameter</span><span class="p">(</span><span class="n">cylObj</span><span class="o">-&gt;</span><span class="n">getP1</span><span class="p">().</span><span class="n">y</span><span class="p">);</span>
<span class="linenos">516</span><span class="w">				</span><span class="n">spatialModel</span><span class="o">-&gt;</span><span class="n">mutable_region</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">add_shape_parameter</span><span class="p">(</span><span class="n">cylObj</span><span class="o">-&gt;</span><span class="n">getP1</span><span class="p">().</span><span class="n">z</span><span class="p">);</span>
<span class="linenos">517</span><span class="w">				</span><span class="n">spatialModel</span><span class="o">-&gt;</span><span class="n">mutable_region</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">add_shape_parameter</span><span class="p">(</span><span class="n">cylObj</span><span class="o">-&gt;</span><span class="n">getP2</span><span class="p">().</span><span class="n">x</span><span class="p">);</span>
<span class="linenos">518</span><span class="w">				</span><span class="n">spatialModel</span><span class="o">-&gt;</span><span class="n">mutable_region</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">add_shape_parameter</span><span class="p">(</span><span class="n">cylObj</span><span class="o">-&gt;</span><span class="n">getP2</span><span class="p">().</span><span class="n">y</span><span class="p">);</span>
<span class="linenos">519</span><span class="w">				</span><span class="n">spatialModel</span><span class="o">-&gt;</span><span class="n">mutable_region</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">add_shape_parameter</span><span class="p">(</span><span class="n">cylObj</span><span class="o">-&gt;</span><span class="n">getP2</span><span class="p">().</span><span class="n">z</span><span class="p">);</span>
<span class="linenos">520</span><span class="w">				</span><span class="n">spatialModel</span><span class="o">-&gt;</span><span class="n">mutable_region</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">add_shape_parameter</span><span class="p">(</span><span class="n">cylObj</span><span class="o">-&gt;</span><span class="n">getRadius</span><span class="p">());</span>
<span class="linenos">521</span><span class="w">			</span><span class="p">}</span>
<span class="linenos">522</span><span class="w">            </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">shape</span><span class="o">-&gt;</span><span class="n">getShapeType</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Shape</span><span class="o">::</span><span class="n">CONE</span><span class="p">)</span>
<span class="linenos">523</span><span class="w">            </span><span class="p">{</span>
<span class="linenos">524</span><span class="w">                </span><span class="n">Cone</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">coneObj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Cone</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">shape</span><span class="p">;</span>
<span class="linenos">525</span><span class="w">                </span><span class="n">spatialModel</span><span class="o">-&gt;</span><span class="n">mutable_region</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">set_shape</span><span class="p">(</span><span class="n">coneObj</span><span class="o">-&gt;</span><span class="n">getShapeType</span><span class="p">());</span>
<span class="linenos">526</span><span class="w">                </span><span class="n">spatialModel</span><span class="o">-&gt;</span><span class="n">mutable_region</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">set_site_type</span><span class="p">(</span><span class="n">coneObj</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span>
<span class="linenos">527</span><span class="w">                </span><span class="n">spatialModel</span><span class="o">-&gt;</span><span class="n">mutable_region</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">add_shape_parameter</span><span class="p">(</span><span class="n">coneObj</span><span class="o">-&gt;</span><span class="n">getCenter</span><span class="p">().</span><span class="n">x</span><span class="p">);</span>
<span class="linenos">528</span><span class="w">                </span><span class="n">spatialModel</span><span class="o">-&gt;</span><span class="n">mutable_region</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">add_shape_parameter</span><span class="p">(</span><span class="n">coneObj</span><span class="o">-&gt;</span><span class="n">getCenter</span><span class="p">().</span><span class="n">y</span><span class="p">);</span>
<span class="linenos">529</span><span class="w">                </span><span class="n">spatialModel</span><span class="o">-&gt;</span><span class="n">mutable_region</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">add_shape_parameter</span><span class="p">(</span><span class="n">coneObj</span><span class="o">-&gt;</span><span class="n">getCenter</span><span class="p">().</span><span class="n">z</span><span class="p">);</span>
<span class="linenos">530</span><span class="w">                </span><span class="n">spatialModel</span><span class="o">-&gt;</span><span class="n">mutable_region</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">add_shape_parameter</span><span class="p">(</span><span class="n">coneObj</span><span class="o">-&gt;</span><span class="n">getRadius</span><span class="p">());</span>
<span class="linenos">531</span><span class="w">                </span><span class="n">spatialModel</span><span class="o">-&gt;</span><span class="n">mutable_region</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">add_shape_parameter</span><span class="p">(</span><span class="n">coneObj</span><span class="o">-&gt;</span><span class="n">getHeight</span><span class="p">());</span>
<span class="linenos">532</span><span class="w">            </span><span class="p">}</span>
<span class="linenos">533</span><span class="w">			</span><span class="k">else</span>
<span class="linenos">534</span><span class="w">			</span><span class="p">{</span>
<span class="linenos">535</span><span class="w">				</span><span class="k">throw</span><span class="w"> </span><span class="n">Exception</span><span class="p">(</span><span class="s">&quot;Unsupported shape type.&quot;</span><span class="p">);</span>
<span class="linenos">536</span><span class="w">			</span><span class="p">}</span>
<span class="linenos">537</span><span class="w">		</span><span class="p">}</span>
<span class="linenos">538</span><span class="w">	</span><span class="p">}</span>
<span class="linenos">539</span>
<span class="linenos">540</span><span class="w">	</span><span class="c1">// Add all of the obstacles.</span>
<span class="linenos">541</span><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Shape</span><span class="w"> </span><span class="o">*&gt;::</span><span class="n">iterator</span><span class="w"> </span><span class="n">it</span><span class="o">=</span><span class="n">objects</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span><span class="w"> </span><span class="n">it</span><span class="o">&lt;</span><span class="n">objects</span><span class="p">.</span><span class="n">end</span><span class="p">();</span><span class="w"> </span><span class="n">it</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">542</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">543</span><span class="w">        </span><span class="n">Shape</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">shape</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">it</span><span class="p">;</span>
<span class="linenos">544</span><span class="w">        </span><span class="n">spatialModel</span><span class="o">-&gt;</span><span class="n">add_obstacle</span><span class="p">();</span>
<span class="linenos">545</span><span class="w">        </span><span class="n">uint</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">spatialModel</span><span class="o">-&gt;</span><span class="n">obstacle_size</span><span class="p">()</span><span class="mi">-1</span><span class="p">;</span>
<span class="linenos">546</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">shape</span><span class="o">-&gt;</span><span class="n">getShapeType</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Shape</span><span class="o">::</span><span class="n">SPHERE</span><span class="p">)</span>
<span class="linenos">547</span><span class="w">        </span><span class="p">{</span>
<span class="linenos">548</span><span class="w">            </span><span class="n">Sphere</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">sphere</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Sphere</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">shape</span><span class="p">;</span>
<span class="linenos">549</span><span class="w">            </span><span class="n">spatialModel</span><span class="o">-&gt;</span><span class="n">mutable_obstacle</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">set_shape</span><span class="p">(</span><span class="n">sphere</span><span class="o">-&gt;</span><span class="n">getShapeType</span><span class="p">());</span>
<span class="linenos">550</span><span class="w">            </span><span class="n">spatialModel</span><span class="o">-&gt;</span><span class="n">mutable_obstacle</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">set_site_type</span><span class="p">(</span><span class="n">sphere</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">());</span>
<span class="linenos">551</span><span class="w">            </span><span class="n">spatialModel</span><span class="o">-&gt;</span><span class="n">mutable_obstacle</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">add_shape_parameter</span><span class="p">(</span><span class="n">sphere</span><span class="o">-&gt;</span><span class="n">getCenter</span><span class="p">().</span><span class="n">x</span><span class="p">);</span>
<span class="linenos">552</span><span class="w">            </span><span class="n">spatialModel</span><span class="o">-&gt;</span><span class="n">mutable_obstacle</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">add_shape_parameter</span><span class="p">(</span><span class="n">sphere</span><span class="o">-&gt;</span><span class="n">getCenter</span><span class="p">().</span><span class="n">y</span><span class="p">);</span>
<span class="linenos">553</span><span class="w">            </span><span class="n">spatialModel</span><span class="o">-&gt;</span><span class="n">mutable_obstacle</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">add_shape_parameter</span><span class="p">(</span><span class="n">sphere</span><span class="o">-&gt;</span><span class="n">getCenter</span><span class="p">().</span><span class="n">z</span><span class="p">);</span>
<span class="linenos">554</span><span class="w">            </span><span class="n">spatialModel</span><span class="o">-&gt;</span><span class="n">mutable_obstacle</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">add_shape_parameter</span><span class="p">(</span><span class="n">sphere</span><span class="o">-&gt;</span><span class="n">getRadius</span><span class="p">());</span>
<span class="linenos">555</span><span class="w">        </span><span class="p">}</span>
<span class="linenos">556</span><span class="w">        </span><span class="k">else</span>
<span class="linenos">557</span><span class="w">        </span><span class="p">{</span>
<span class="linenos">558</span><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="n">Exception</span><span class="p">(</span><span class="s">&quot;Unsupported shape type.&quot;</span><span class="p">);</span>
<span class="linenos">559</span><span class="w">        </span><span class="p">}</span>
<span class="linenos">560</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">561</span><span class="p">}</span>
<span class="linenos">562</span>
<span class="linenos">563</span><span class="kt">void</span><span class="w"> </span><span class="n">LatticeBuilder</span><span class="o">::</span><span class="n">addParticles</span><span class="p">(</span><span class="n">particle_t</span><span class="w"> </span><span class="n">particleType</span><span class="p">,</span><span class="w"> </span><span class="n">site_t</span><span class="w"> </span><span class="n">siteType</span><span class="p">,</span><span class="w"> </span><span class="n">uint</span><span class="w"> </span><span class="n">count</span><span class="p">)</span>
<span class="linenos">564</span><span class="p">{</span>
<span class="linenos">565</span><span class="w">	</span><span class="n">particles</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">ParticlePlacement</span><span class="p">(</span><span class="n">particleType</span><span class="p">,</span><span class="w"> </span><span class="n">siteType</span><span class="p">,</span><span class="w"> </span><span class="n">count</span><span class="p">));</span>
<span class="linenos">566</span><span class="p">}</span>
<span class="linenos">567</span>
<span class="linenos">568</span><span class="kt">void</span><span class="w"> </span><span class="n">LatticeBuilder</span><span class="o">::</span><span class="n">discretizeTo</span><span class="p">(</span><span class="n">lm</span><span class="o">::</span><span class="n">rdme</span><span class="o">::</span><span class="n">Lattice</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">lattice</span><span class="p">,</span><span class="w"> </span><span class="n">site_t</span><span class="w"> </span><span class="n">obstacleSiteType</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">fractionObstacleSitesOccupied</span><span class="p">)</span>
<span class="linenos">569</span><span class="p">{</span>
<span class="linenos">570</span><span class="w">	</span><span class="c1">// Go through each region and discretize it to the lattice.</span>
<span class="linenos">571</span><span class="w">	</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">definedRegions</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">572</span><span class="w">	</span><span class="p">{</span>
<span class="linenos">573</span><span class="w">		</span><span class="n">site_t</span><span class="w"> </span><span class="n">region</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">definedRegions</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="linenos">574</span>
<span class="linenos">575</span><span class="w">		</span><span class="c1">// Go through each shape making up the region.</span>
<span class="linenos">576</span><span class="w">		</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Shape</span><span class="w"> </span><span class="o">*&gt;::</span><span class="n">iterator</span><span class="w"> </span><span class="n">it</span><span class="o">=</span><span class="n">regionShapes</span><span class="p">[</span><span class="n">region</span><span class="p">].</span><span class="n">begin</span><span class="p">();</span><span class="w"> </span><span class="n">it</span><span class="o">&lt;</span><span class="n">regionShapes</span><span class="p">[</span><span class="n">region</span><span class="p">].</span><span class="n">end</span><span class="p">();</span><span class="w"> </span><span class="n">it</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">577</span><span class="w">		</span><span class="p">{</span>
<span class="linenos">578</span><span class="w">			</span><span class="n">Shape</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">shape</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">it</span><span class="p">;</span>
<span class="linenos">579</span><span class="w">			</span><span class="n">shape</span><span class="o">-&gt;</span><span class="n">discretizeTo</span><span class="p">(</span><span class="n">lattice</span><span class="p">);</span>
<span class="linenos">580</span><span class="w">		</span><span class="p">}</span>
<span class="linenos">581</span><span class="w">	</span><span class="p">}</span>
<span class="linenos">582</span>
<span class="linenos">583</span><span class="w">	</span><span class="c1">// Add the obstacles.</span>
<span class="linenos">584</span><span class="w">	</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">discretizeObstaclesTo</span><span class="p">(</span><span class="n">lattice</span><span class="p">,</span><span class="w"> </span><span class="n">obstacleSiteType</span><span class="p">,</span><span class="w"> </span><span class="n">fractionObstacleSitesOccupied</span><span class="p">);</span>
<span class="linenos">585</span>
<span class="linenos">586</span><span class="w">	</span><span class="c1">// Add all of the particles to the lattice.</span>
<span class="linenos">587</span><span class="w">	</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">particles</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">588</span><span class="w">	</span><span class="p">{</span>
<span class="linenos">589</span><span class="w">		</span><span class="n">ParticlePlacement</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">particles</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="linenos">590</span><span class="w">		</span><span class="n">uint</span><span class="w"> </span><span class="n">numberAttempts</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">591</span><span class="w">		</span><span class="n">uint</span><span class="w"> </span><span class="n">placed</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">592</span><span class="w">		</span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">placed</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">count</span><span class="p">)</span>
<span class="linenos">593</span><span class="w">		</span><span class="p">{</span>
<span class="linenos">594</span><span class="w">			</span><span class="n">numberAttempts</span><span class="o">++</span><span class="p">;</span>
<span class="linenos">595</span><span class="w">			</span><span class="kt">double</span><span class="w"> </span><span class="n">randomValues</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
<span class="linenos">596</span><span class="w">			</span><span class="n">rng</span><span class="o">-&gt;</span><span class="n">getRandomDoubles</span><span class="p">(</span><span class="n">randomValues</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">);</span>
<span class="linenos">597</span><span class="w">			</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="p">)</span><span class="n">floor</span><span class="p">(</span><span class="n">randomValues</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getXSize</span><span class="p">());</span>
<span class="linenos">598</span><span class="w">			</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getXSize</span><span class="p">())</span><span class="w"> </span><span class="n">x</span><span class="o">--</span><span class="p">;</span>
<span class="linenos">599</span><span class="w">			</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="p">)</span><span class="n">floor</span><span class="p">(</span><span class="n">randomValues</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getYSize</span><span class="p">());</span>
<span class="linenos">600</span><span class="w">			</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">y</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getYSize</span><span class="p">())</span><span class="w"> </span><span class="n">y</span><span class="o">--</span><span class="p">;</span>
<span class="linenos">601</span><span class="w">			</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="p">)</span><span class="n">floor</span><span class="p">(</span><span class="n">randomValues</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getZSize</span><span class="p">());</span>
<span class="linenos">602</span><span class="w">			</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">z</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getZSize</span><span class="p">())</span><span class="w"> </span><span class="n">z</span><span class="o">--</span><span class="p">;</span>
<span class="linenos">603</span><span class="w">			</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getSiteType</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">siteType</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getOccupancy</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getMaxOccupancy</span><span class="p">())</span>
<span class="linenos">604</span><span class="w">			</span><span class="p">{</span>
<span class="linenos">605</span><span class="w">				</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">addParticle</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">z</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">particleType</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
<span class="linenos">606</span><span class="w">				</span><span class="n">placed</span><span class="o">++</span><span class="p">;</span>
<span class="linenos">607</span><span class="w">			</span><span class="p">}</span>
<span class="linenos">608</span><span class="w">		</span><span class="p">}</span>
<span class="linenos">609</span><span class="w">		</span><span class="n">Print</span><span class="o">::</span><span class="n">printf</span><span class="p">(</span><span class="n">Print</span><span class="o">::</span><span class="n">DEBUG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Placed %d particles of type %d in sites of type %d in %d attempts&quot;</span><span class="p">,</span><span class="n">p</span><span class="p">.</span><span class="n">count</span><span class="p">,</span><span class="n">p</span><span class="p">.</span><span class="n">particleType</span><span class="p">,</span><span class="n">p</span><span class="p">.</span><span class="n">siteType</span><span class="p">,</span><span class="n">numberAttempts</span><span class="p">);</span>
<span class="linenos">610</span><span class="w">	</span><span class="p">}</span>
<span class="linenos">611</span><span class="p">}</span>
<span class="linenos">612</span>
<span class="linenos">613</span><span class="kt">void</span><span class="w"> </span><span class="n">LatticeBuilder</span><span class="o">::</span><span class="n">discretizeObstaclesTo</span><span class="p">(</span><span class="n">lm</span><span class="o">::</span><span class="n">rdme</span><span class="o">::</span><span class="n">Lattice</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">lattice</span><span class="p">,</span><span class="w"> </span><span class="n">site_t</span><span class="w"> </span><span class="n">obstacleSiteType</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">fractionObstacleSitesOccupied</span><span class="p">)</span>
<span class="linenos">614</span><span class="p">{</span>
<span class="linenos">615</span><span class="w">	</span><span class="c1">// Track the occupied volume of each subvolume.</span>
<span class="linenos">616</span><span class="w">	</span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">occupiedVolume</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">double</span><span class="p">[</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getNumberSites</span><span class="p">()];</span>
<span class="linenos">617</span><span class="w">	</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getNumberSites</span><span class="p">();</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="n">occupiedVolume</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>
<span class="linenos">618</span>
<span class="linenos">619</span><span class="w">	</span><span class="c1">// Go through each obstacle and assign its volume to the appropriate subvolume.</span>
<span class="linenos">620</span><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Shape</span><span class="w"> </span><span class="o">*&gt;::</span><span class="n">iterator</span><span class="w"> </span><span class="n">it</span><span class="o">=</span><span class="n">objects</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span><span class="w"> </span><span class="n">it</span><span class="o">&lt;</span><span class="n">objects</span><span class="p">.</span><span class="n">end</span><span class="p">();</span><span class="w"> </span><span class="n">it</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">621</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">622</span><span class="w">        </span><span class="n">Shape</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">shape</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">it</span><span class="p">;</span>
<span class="linenos">623</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">shape</span><span class="o">-&gt;</span><span class="n">getShapeType</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Shape</span><span class="o">::</span><span class="n">SPHERE</span><span class="p">)</span>
<span class="linenos">624</span><span class="w">        </span><span class="p">{</span>
<span class="linenos">625</span><span class="w">            </span><span class="n">Sphere</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">sphere</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Sphere</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">shape</span><span class="p">;</span>
<span class="linenos">626</span>
<span class="linenos">627</span><span class="w">            </span><span class="c1">// If the sphere is much bigger than the subvolume size, occupy all of the sites with which the sphere overlaps.</span>
<span class="linenos">628</span><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">sphere</span><span class="o">-&gt;</span><span class="n">getRadius</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getSpacing</span><span class="p">())</span>
<span class="linenos">629</span><span class="w">            </span><span class="p">{</span>
<span class="linenos">630</span><span class="w">            	</span><span class="n">point</span><span class="w"> </span><span class="n">c</span><span class="o">=</span><span class="n">sphere</span><span class="o">-&gt;</span><span class="n">getCenter</span><span class="p">();</span>
<span class="linenos">631</span><span class="w">            	</span><span class="n">si_dist_t</span><span class="w"> </span><span class="n">r</span><span class="o">=</span><span class="n">sphere</span><span class="o">-&gt;</span><span class="n">getRadius</span><span class="p">();</span>
<span class="linenos">632</span><span class="w">            	</span><span class="n">si_dist_t</span><span class="w"> </span><span class="n">siteSubvolume</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getSpacing</span><span class="p">()</span><span class="o">*</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getSpacing</span><span class="p">()</span><span class="o">*</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getSpacing</span><span class="p">();</span>
<span class="linenos">633</span>
<span class="linenos">634</span><span class="w">        		</span><span class="c1">// Get the bounds of the circle.</span>
<span class="linenos">635</span><span class="w">        		</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">x1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">lattice_size_t</span><span class="p">)</span><span class="n">floor</span><span class="p">((</span><span class="n">c</span><span class="p">.</span><span class="n">x</span><span class="o">-</span><span class="n">r</span><span class="p">)</span><span class="o">/</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getSpacing</span><span class="p">());</span>
<span class="linenos">636</span><span class="w">        		</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">x2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="n">lattice_size_t</span><span class="p">)</span><span class="n">floor</span><span class="p">((</span><span class="n">c</span><span class="p">.</span><span class="n">x</span><span class="o">+</span><span class="n">r</span><span class="p">)</span><span class="o">/</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getSpacing</span><span class="p">()))</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
<span class="linenos">637</span><span class="w">        		</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">y1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">lattice_size_t</span><span class="p">)</span><span class="n">floor</span><span class="p">((</span><span class="n">c</span><span class="p">.</span><span class="n">y</span><span class="o">-</span><span class="n">r</span><span class="p">)</span><span class="o">/</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getSpacing</span><span class="p">());</span>
<span class="linenos">638</span><span class="w">        		</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">y2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="n">lattice_size_t</span><span class="p">)</span><span class="n">floor</span><span class="p">((</span><span class="n">c</span><span class="p">.</span><span class="n">y</span><span class="o">+</span><span class="n">r</span><span class="p">)</span><span class="o">/</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getSpacing</span><span class="p">()))</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
<span class="linenos">639</span><span class="w">        		</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">lattice_size_t</span><span class="p">)</span><span class="n">floor</span><span class="p">((</span><span class="n">c</span><span class="p">.</span><span class="n">z</span><span class="o">-</span><span class="n">r</span><span class="p">)</span><span class="o">/</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getSpacing</span><span class="p">());</span>
<span class="linenos">640</span><span class="w">        		</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">z2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="n">lattice_size_t</span><span class="p">)</span><span class="n">floor</span><span class="p">((</span><span class="n">c</span><span class="p">.</span><span class="n">z</span><span class="o">+</span><span class="n">r</span><span class="p">)</span><span class="o">/</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getSpacing</span><span class="p">()))</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
<span class="linenos">641</span>
<span class="linenos">642</span><span class="w">        		</span><span class="c1">// Fill in the circle.</span>
<span class="linenos">643</span><span class="w">        		</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x1</span><span class="p">;</span><span class="w"> </span><span class="n">x</span><span class="o">&lt;=</span><span class="n">x2</span><span class="p">;</span><span class="w"> </span><span class="n">x</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">644</span><span class="w">        			</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">y1</span><span class="p">;</span><span class="w"> </span><span class="n">y</span><span class="o">&lt;=</span><span class="n">y2</span><span class="p">;</span><span class="w"> </span><span class="n">y</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">645</span><span class="w">            			</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">lattice_size_t</span><span class="w"> </span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">z1</span><span class="p">;</span><span class="w"> </span><span class="n">z</span><span class="o">&lt;=</span><span class="n">z2</span><span class="p">;</span><span class="w"> </span><span class="n">z</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">646</span><span class="w">						</span><span class="p">{</span>
<span class="linenos">647</span><span class="w">							</span><span class="n">point</span><span class="w"> </span><span class="nf">lc</span><span class="p">((((</span><span class="kt">double</span><span class="p">)</span><span class="n">x</span><span class="p">)</span><span class="o">+</span><span class="mf">0.5</span><span class="p">)</span><span class="o">*</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getSpacing</span><span class="p">()</span><span class="o">-</span><span class="n">c</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="p">(((</span><span class="kt">double</span><span class="p">)</span><span class="n">y</span><span class="p">)</span><span class="o">+</span><span class="mf">0.5</span><span class="p">)</span><span class="o">*</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getSpacing</span><span class="p">()</span><span class="o">-</span><span class="n">c</span><span class="p">.</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="p">(((</span><span class="kt">double</span><span class="p">)</span><span class="n">z</span><span class="p">)</span><span class="o">+</span><span class="mf">0.5</span><span class="p">)</span><span class="o">*</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getSpacing</span><span class="p">()</span><span class="o">-</span><span class="n">c</span><span class="p">.</span><span class="n">z</span><span class="p">);</span>
<span class="linenos">648</span><span class="w">							</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">lc</span><span class="p">.</span><span class="n">x</span><span class="o">*</span><span class="n">lc</span><span class="p">.</span><span class="n">x</span><span class="o">+</span><span class="n">lc</span><span class="p">.</span><span class="n">y</span><span class="o">*</span><span class="n">lc</span><span class="p">.</span><span class="n">y</span><span class="o">+</span><span class="n">lc</span><span class="p">.</span><span class="n">z</span><span class="o">*</span><span class="n">lc</span><span class="p">.</span><span class="n">z</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">r</span><span class="o">*</span><span class="n">r</span><span class="p">)</span>
<span class="linenos">649</span><span class="w">								</span><span class="n">occupiedVolume</span><span class="p">[</span><span class="n">x</span><span class="o">*</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getYSize</span><span class="p">()</span><span class="o">*</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getZSize</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">y</span><span class="o">*</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getZSize</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">z</span><span class="p">]</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">siteSubvolume</span><span class="p">;</span>
<span class="linenos">650</span><span class="w">						</span><span class="p">}</span>
<span class="linenos">651</span><span class="w">            </span><span class="p">}</span>
<span class="linenos">652</span>
<span class="linenos">653</span><span class="w">            </span><span class="c1">// Otherwise, the sphere is on the order of the subvolume size, try to distribute its volume to nearby subvolumes.</span>
<span class="linenos">654</span><span class="w">            </span><span class="k">else</span>
<span class="linenos">655</span><span class="w">            </span><span class="p">{</span>
<span class="linenos">656</span><span class="w">				</span><span class="c1">// Figure out which half lattice site the subvolume is nearest to.</span>
<span class="linenos">657</span><span class="w">				</span><span class="n">uint</span><span class="w"> </span><span class="n">hx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lround</span><span class="p">(</span><span class="n">sphere</span><span class="o">-&gt;</span><span class="n">getCenter</span><span class="p">().</span><span class="n">x</span><span class="o">/</span><span class="p">(</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getSpacing</span><span class="p">()</span><span class="o">/</span><span class="mi">2</span><span class="p">));</span>
<span class="linenos">658</span><span class="w">				</span><span class="n">uint</span><span class="w"> </span><span class="n">hy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lround</span><span class="p">(</span><span class="n">sphere</span><span class="o">-&gt;</span><span class="n">getCenter</span><span class="p">().</span><span class="n">y</span><span class="o">/</span><span class="p">(</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getSpacing</span><span class="p">()</span><span class="o">/</span><span class="mi">2</span><span class="p">));</span>
<span class="linenos">659</span><span class="w">				</span><span class="n">uint</span><span class="w"> </span><span class="n">hz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lround</span><span class="p">(</span><span class="n">sphere</span><span class="o">-&gt;</span><span class="n">getCenter</span><span class="p">().</span><span class="n">z</span><span class="o">/</span><span class="p">(</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getSpacing</span><span class="p">()</span><span class="o">/</span><span class="mi">2</span><span class="p">));</span>
<span class="linenos">660</span>
<span class="linenos">661</span><span class="w">				</span><span class="n">uint</span><span class="w"> </span><span class="n">xsv</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<span class="linenos">662</span><span class="w">				</span><span class="n">uint</span><span class="w"> </span><span class="n">ysv</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<span class="linenos">663</span><span class="w">				</span><span class="n">uint</span><span class="w"> </span><span class="n">zsv</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<span class="linenos">664</span>
<span class="linenos">665</span><span class="w">				</span><span class="c1">// Figure out which subvolumes to assign the density.</span>
<span class="linenos">666</span><span class="w">				</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">hx</span><span class="o">%</span><span class="mi">2</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="linenos">667</span><span class="w">				</span><span class="p">{</span>
<span class="linenos">668</span><span class="w">					</span><span class="c1">// x falls in the center of a subvolume.</span>
<span class="linenos">669</span><span class="w">					</span><span class="n">xsv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hx</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span>
<span class="linenos">670</span><span class="w">					</span><span class="n">xsv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">xsv</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="linenos">671</span><span class="w">				</span><span class="p">}</span>
<span class="linenos">672</span><span class="w">				</span><span class="k">else</span>
<span class="linenos">673</span><span class="w">				</span><span class="p">{</span>
<span class="linenos">674</span><span class="w">					</span><span class="c1">// x falls on the edge of two subvolumes.</span>
<span class="linenos">675</span><span class="w">					</span><span class="n">xsv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hx</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span>
<span class="linenos">676</span><span class="w">					</span><span class="n">xsv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">xsv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="mi">-1</span><span class="p">;</span>
<span class="linenos">677</span><span class="w">				</span><span class="p">}</span>
<span class="linenos">678</span><span class="w">				</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">hy</span><span class="o">%</span><span class="mi">2</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="linenos">679</span><span class="w">				</span><span class="p">{</span>
<span class="linenos">680</span><span class="w">					</span><span class="c1">// y falls in the center of a subvolume.</span>
<span class="linenos">681</span><span class="w">					</span><span class="n">ysv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hy</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span>
<span class="linenos">682</span><span class="w">					</span><span class="n">ysv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ysv</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="linenos">683</span><span class="w">				</span><span class="p">}</span>
<span class="linenos">684</span><span class="w">				</span><span class="k">else</span>
<span class="linenos">685</span><span class="w">				</span><span class="p">{</span>
<span class="linenos">686</span><span class="w">					</span><span class="c1">// y falls on the edge of two subvolumes.</span>
<span class="linenos">687</span><span class="w">					</span><span class="n">ysv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hy</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span>
<span class="linenos">688</span><span class="w">					</span><span class="n">ysv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ysv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="mi">-1</span><span class="p">;</span>
<span class="linenos">689</span><span class="w">				</span><span class="p">}</span>
<span class="linenos">690</span><span class="w">				</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">hz</span><span class="o">%</span><span class="mi">2</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="linenos">691</span><span class="w">				</span><span class="p">{</span>
<span class="linenos">692</span><span class="w">					</span><span class="c1">// z falls in the center of a subvolume.</span>
<span class="linenos">693</span><span class="w">					</span><span class="n">zsv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hz</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span>
<span class="linenos">694</span><span class="w">					</span><span class="n">zsv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zsv</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="linenos">695</span><span class="w">				</span><span class="p">}</span>
<span class="linenos">696</span><span class="w">				</span><span class="k">else</span>
<span class="linenos">697</span><span class="w">				</span><span class="p">{</span>
<span class="linenos">698</span><span class="w">					</span><span class="c1">// z falls on the edge of two subvolumes.</span>
<span class="linenos">699</span><span class="w">					</span><span class="n">zsv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hz</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span>
<span class="linenos">700</span><span class="w">					</span><span class="n">zsv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zsv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="mi">-1</span><span class="p">;</span>
<span class="linenos">701</span><span class="w">				</span><span class="p">}</span>
<span class="linenos">702</span>
<span class="linenos">703</span><span class="w">				</span><span class="c1">// Puts the density in the subvolumes.</span>
<span class="linenos">704</span><span class="w">				</span><span class="kt">double</span><span class="w"> </span><span class="n">eighthVolume</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sphere</span><span class="o">-&gt;</span><span class="n">getVolume</span><span class="p">()</span><span class="o">/</span><span class="mi">8</span><span class="p">;</span>
<span class="linenos">705</span><span class="w">				</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="mi">2</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">706</span><span class="w">					</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">&lt;</span><span class="mi">2</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">707</span><span class="w">						</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">k</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">k</span><span class="o">&lt;</span><span class="mi">2</span><span class="p">;</span><span class="w"> </span><span class="n">k</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">708</span><span class="w">						</span><span class="p">{</span>
<span class="linenos">709</span><span class="w">							</span><span class="n">occupiedVolume</span><span class="p">[</span><span class="n">xsv</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getYSize</span><span class="p">()</span><span class="o">*</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getZSize</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ysv</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getZSize</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">zsv</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">eighthVolume</span><span class="p">;</span>
<span class="linenos">710</span><span class="w">						</span><span class="p">}</span>
<span class="linenos">711</span><span class="w">            </span><span class="p">}</span>
<span class="linenos">712</span><span class="w">        </span><span class="p">}</span>
<span class="linenos">713</span><span class="w">        </span><span class="k">else</span>
<span class="linenos">714</span><span class="w">        </span><span class="p">{</span>
<span class="linenos">715</span><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="n">Exception</span><span class="p">(</span><span class="s">&quot;Unsupported shape type.&quot;</span><span class="p">);</span>
<span class="linenos">716</span><span class="w">        </span><span class="p">}</span>
<span class="linenos">717</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">718</span>
<span class="linenos">719</span><span class="w">    </span><span class="c1">// Create a sorted list of all of the occupancy values.</span>
<span class="linenos">720</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">list</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="w"> </span><span class="n">occupancyValues</span><span class="p">;</span>
<span class="linenos">721</span><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">index</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">x</span><span class="o">&lt;</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getXSize</span><span class="p">();</span><span class="w"> </span><span class="n">x</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">722</span><span class="w">    	</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">y</span><span class="o">&lt;</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getYSize</span><span class="p">();</span><span class="w"> </span><span class="n">y</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">723</span><span class="w">    		</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">z</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">z</span><span class="o">&lt;</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getZSize</span><span class="p">();</span><span class="w"> </span><span class="n">z</span><span class="o">++</span><span class="p">,</span><span class="w"> </span><span class="n">index</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">724</span><span class="w">    			</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">occupiedVolume</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0.0</span><span class="p">)</span>
<span class="linenos">725</span><span class="w">    				</span><span class="n">occupancyValues</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">occupiedVolume</span><span class="p">[</span><span class="n">index</span><span class="p">]);</span>
<span class="linenos">726</span><span class="w">    </span><span class="n">occupancyValues</span><span class="p">.</span><span class="n">sort</span><span class="p">();</span>
<span class="linenos">727</span><span class="w">    </span><span class="n">occupancyValues</span><span class="p">.</span><span class="n">reverse</span><span class="p">();</span>
<span class="linenos">728</span>
<span class="linenos">729</span><span class="w">    </span><span class="c1">// Get the occupancy cutoff.</span>
<span class="linenos">730</span><span class="w">    </span><span class="n">uint</span><span class="w"> </span><span class="n">maxOccupiedSites</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lround</span><span class="p">(</span><span class="n">fractionObstacleSitesOccupied</span><span class="o">*</span><span class="p">((</span><span class="kt">double</span><span class="p">)</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getNumberSites</span><span class="p">()));</span>
<span class="linenos">731</span><span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">cutoff</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>
<span class="linenos">732</span><span class="w">    </span><span class="n">uint</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">733</span><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">list</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;::</span><span class="n">iterator</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">occupancyValues</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">occupancyValues</span><span class="p">.</span><span class="n">end</span><span class="p">();</span><span class="w"> </span><span class="n">it</span><span class="o">++</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">734</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">735</span><span class="w">    	</span><span class="kt">double</span><span class="w"> </span><span class="n">occupancy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">it</span><span class="p">;</span>
<span class="linenos">736</span><span class="w">    	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">maxOccupiedSites</span><span class="p">)</span>
<span class="linenos">737</span><span class="w">    	</span><span class="p">{</span>
<span class="linenos">738</span><span class="w">    		</span><span class="n">cutoff</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">occupancy</span><span class="p">;</span>
<span class="linenos">739</span><span class="w">    		</span><span class="k">break</span><span class="p">;</span>
<span class="linenos">740</span><span class="w">    	</span><span class="p">}</span>
<span class="linenos">741</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">742</span>
<span class="linenos">743</span><span class="w">    </span><span class="c1">// Go through the subvolumes and mark any subvolumes that are over the threshold as occupied.</span>
<span class="linenos">744</span><span class="w">    </span><span class="n">uint</span><span class="w"> </span><span class="n">numberOccupiedSites</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">745</span><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">index</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">x</span><span class="o">&lt;</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getXSize</span><span class="p">();</span><span class="w"> </span><span class="n">x</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">746</span><span class="w">    	</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">y</span><span class="o">&lt;</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getYSize</span><span class="p">();</span><span class="w"> </span><span class="n">y</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">747</span><span class="w">    		</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">z</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">z</span><span class="o">&lt;</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getZSize</span><span class="p">();</span><span class="w"> </span><span class="n">z</span><span class="o">++</span><span class="p">,</span><span class="w"> </span><span class="n">index</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">748</span><span class="w">    		</span><span class="p">{</span>
<span class="linenos">749</span><span class="w">    			</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">occupiedVolume</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0.0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">occupiedVolume</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">cutoff</span><span class="p">)</span>
<span class="linenos">750</span><span class="w">    			</span><span class="p">{</span>
<span class="linenos">751</span><span class="w">    				</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">setSiteType</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">z</span><span class="p">,</span><span class="w"> </span><span class="n">obstacleSiteType</span><span class="p">);</span>
<span class="linenos">752</span><span class="w">    				</span><span class="n">numberOccupiedSites</span><span class="o">++</span><span class="p">;</span>
<span class="linenos">753</span><span class="w">    			</span><span class="p">}</span>
<span class="linenos">754</span><span class="w">    		</span><span class="p">}</span>
<span class="linenos">755</span>
<span class="linenos">756</span><span class="w">    </span><span class="c1">// Free the resources.</span>
<span class="linenos">757</span><span class="w">    </span><span class="k">delete</span><span class="w"> </span><span class="p">[]</span><span class="w"> </span><span class="n">occupiedVolume</span><span class="p">;</span>
<span class="linenos">758</span>
<span class="linenos">759</span><span class="w">    </span><span class="n">Print</span><span class="o">::</span><span class="n">printf</span><span class="p">(</span><span class="n">Print</span><span class="o">::</span><span class="n">DEBUG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Marked %d sites as occupied by obstacles&quot;</span><span class="p">,</span><span class="n">numberOccupiedSites</span><span class="p">);</span>
<span class="linenos">760</span><span class="p">}</span>
<span class="linenos">761</span>
<span class="linenos">762</span><span class="p">}</span>
<span class="linenos">763</span><span class="p">}</span>
</pre></div>
</div>
</section>
</section>
<section id="threading-classes">
<h2>Threading Classes<a class="headerlink" href="#threading-classes" title="Link to this heading">#</a></h2>
<section id="workermanager-h">
<h3>WorkerManager.h<a class="headerlink" href="#workermanager-h" title="Link to this heading">#</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cm">/*</span>
<span class="linenos"> 2</span><span class="cm"> * University of Illinois Open Source License</span>
<span class="linenos"> 3</span><span class="cm"> * Copyright 2011-2018 Luthey-Schulten Group,</span>
<span class="linenos"> 4</span><span class="cm"> * All rights reserved.</span>
<span class="linenos"> 5</span><span class="cm"> * </span>
<span class="linenos"> 6</span><span class="cm"> * Developed by: Luthey-Schulten Group</span>
<span class="linenos"> 7</span><span class="cm"> * 			     University of Illinois at Urbana-Champaign</span>
<span class="linenos"> 8</span><span class="cm"> * 			     http://www.scs.uiuc.edu/~schulten</span>
<span class="linenos"> 9</span><span class="cm"> * </span>
<span class="linenos">10</span><span class="cm"> * Permission is hereby granted, free of charge, to any person obtaining a copy of</span>
<span class="linenos">11</span><span class="cm"> * this software and associated documentation files (the Software), to deal with </span>
<span class="linenos">12</span><span class="cm"> * the Software without restriction, including without limitation the rights to </span>
<span class="linenos">13</span><span class="cm"> * use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies </span>
<span class="linenos">14</span><span class="cm"> * of the Software, and to permit persons to whom the Software is furnished to </span>
<span class="linenos">15</span><span class="cm"> * do so, subject to the following conditions:</span>
<span class="linenos">16</span><span class="cm"> * </span>
<span class="linenos">17</span><span class="cm"> * - Redistributions of source code must retain the above copyright notice, </span>
<span class="linenos">18</span><span class="cm"> * this list of conditions and the following disclaimers.</span>
<span class="linenos">19</span><span class="cm"> * </span>
<span class="linenos">20</span><span class="cm"> * - Redistributions in binary form must reproduce the above copyright notice, </span>
<span class="linenos">21</span><span class="cm"> * this list of conditions and the following disclaimers in the documentation </span>
<span class="linenos">22</span><span class="cm"> * and/or other materials provided with the distribution.</span>
<span class="linenos">23</span><span class="cm"> * </span>
<span class="linenos">24</span><span class="cm"> * - Neither the names of the Luthey-Schulten Group, University of Illinois at</span>
<span class="linenos">25</span><span class="cm"> * Urbana-Champaign, nor the names of its contributors may be used to endorse or</span>
<span class="linenos">26</span><span class="cm"> * promote products derived from this Software without specific prior written</span>
<span class="linenos">27</span><span class="cm"> * permission.</span>
<span class="linenos">28</span><span class="cm"> * </span>
<span class="linenos">29</span><span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR </span>
<span class="linenos">30</span><span class="cm"> * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, </span>
<span class="linenos">31</span><span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL </span>
<span class="linenos">32</span><span class="cm"> * THE CONTRIBUTORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR </span>
<span class="linenos">33</span><span class="cm"> * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, </span>
<span class="linenos">34</span><span class="cm"> * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR </span>
<span class="linenos">35</span><span class="cm"> * OTHER DEALINGS WITH THE SOFTWARE.</span>
<span class="linenos">36</span><span class="cm"> *</span>
<span class="linenos">37</span><span class="cm"> * Author(s): Elijah Roberts</span>
<span class="linenos">38</span><span class="cm"> */</span>
<span class="linenos">39</span>
<span class="linenos">40</span><span class="cp">#ifndef LM_THREAD_WORKER_MANAGER_H_</span>
<span class="linenos">41</span><span class="cp">#define LM_THREAD_WORKER_MANAGER_H_</span>
<span class="linenos">42</span>
<span class="linenos">43</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;list&gt;</span>
<span class="linenos">44</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;thread/Thread.h&quot;</span>
<span class="linenos">45</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;thread/Worker.h&quot;</span>
<span class="linenos">46</span>
<span class="linenos">47</span><span class="k">using</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">list</span><span class="p">;</span>
<span class="linenos">48</span>
<span class="linenos">49</span><span class="k">namespace</span><span class="w"> </span><span class="nn">lm</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">50</span><span class="k">namespace</span><span class="w"> </span><span class="nn">thread</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">51</span>
<span class="linenos">52</span><span class="c1">/// @class WorkerManager</span>
<span class="linenos">53</span><span class="c1">/// @brief A singleton manager that creates and manages workers that run on a processing node</span>
<span class="linenos">54</span><span class="k">class</span><span class="w"> </span><span class="nc">WorkerManager</span>
<span class="linenos">55</span><span class="p">{</span>
<span class="linenos">56</span><span class="k">public</span><span class="o">:</span>
<span class="linenos">57</span><span class="w">    </span><span class="c1">/// @brief Get the global worker manager</span>
<span class="linenos">58</span><span class="w">    </span><span class="c1">/// @return globalWorkerManager Global thread manager instance handle</span>
<span class="linenos">59</span><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="n">WorkerManager</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">getInstance</span><span class="p">();</span>
<span class="linenos">60</span>
<span class="linenos">61</span><span class="k">private</span><span class="o">:</span>
<span class="linenos">62</span><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="n">WorkerManager</span><span class="w"> </span><span class="n">instance</span><span class="p">;</span><span class="w">  </span><span class="c1">// Global thread manager</span>
<span class="linenos">63</span>
<span class="linenos">64</span><span class="k">public</span><span class="o">:</span>
<span class="linenos">65</span><span class="w">    </span><span class="c1">/// @brief Create the WorkerManager</span>
<span class="linenos">66</span><span class="w">    </span><span class="n">WorkerManager</span><span class="p">();</span>
<span class="linenos">67</span><span class="w">    </span><span class="c1">/// @brief Destroy the WorkerManager</span>
<span class="linenos">68</span><span class="w">    </span><span class="o">~</span><span class="n">WorkerManager</span><span class="p">();</span>
<span class="linenos">69</span>
<span class="linenos">70</span><span class="w">    </span><span class="c1">/// @brief Adds a worker to the manager</span>
<span class="linenos">71</span><span class="w">    </span><span class="c1">/// @param worker Worker to add</span>
<span class="linenos">72</span><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">addWorker</span><span class="p">(</span><span class="n">Worker</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">worker</span><span class="p">);</span>
<span class="linenos">73</span><span class="w">    </span><span class="c1">/// @brief Removes a worker from the manager</span>
<span class="linenos">74</span><span class="w">    </span><span class="c1">/// @param worker Worker handle for which to remove</span>
<span class="linenos">75</span><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">removeWorker</span><span class="p">(</span><span class="n">Worker</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">worker</span><span class="p">);</span>
<span class="linenos">76</span><span class="w">    </span><span class="c1">/// @brief Aborts all the worker threads</span>
<span class="linenos">77</span><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">abortWorkers</span><span class="p">();</span>
<span class="linenos">78</span><span class="w">    </span><span class="c1">/// @brief Causes all the worker threads to checkpoint (checkpointing is currently unimplemented)</span>
<span class="linenos">79</span><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">checkpointWorkers</span><span class="p">();</span>
<span class="linenos">80</span><span class="w">    </span><span class="c1">/// @brief Stops all the worker threads (e.g. merges them with the master)</span>
<span class="linenos">81</span><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">stopWorkers</span><span class="p">();</span>
<span class="linenos">82</span>
<span class="linenos">83</span><span class="k">private</span><span class="o">:</span>
<span class="linenos">84</span><span class="w">    </span><span class="n">pthread_mutex_t</span><span class="w"> </span><span class="n">mutex</span><span class="p">;</span><span class="w">      </span><span class="c1">// Main mutex for performing thread operations</span>
<span class="linenos">85</span><span class="w">    </span><span class="n">list</span><span class="o">&lt;</span><span class="n">Worker</span><span class="w"> </span><span class="o">*&gt;</span><span class="w"> </span><span class="n">workers</span><span class="p">;</span><span class="w">     </span><span class="c1">// List of all workers</span>
<span class="linenos">86</span><span class="p">};</span>
<span class="linenos">87</span>
<span class="linenos">88</span><span class="p">}</span>
<span class="linenos">89</span><span class="p">}</span>
<span class="linenos">90</span>
<span class="linenos">91</span>
<span class="linenos">92</span><span class="cp">#endif</span>
</pre></div>
</div>
</section>
<section id="workermanager-cpp">
<h3>WorkerManager.cpp<a class="headerlink" href="#workermanager-cpp" title="Link to this heading">#</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="linenos">  1</span><span class="cm">/*</span>
<span class="linenos">  2</span><span class="cm"> * University of Illinois Open Source License</span>
<span class="linenos">  3</span><span class="cm"> * Copyright 2011-2018 Luthey-Schulten Group,</span>
<span class="linenos">  4</span><span class="cm"> * All rights reserved.</span>
<span class="linenos">  5</span><span class="cm"> * </span>
<span class="linenos">  6</span><span class="cm"> * Developed by: Luthey-Schulten Group</span>
<span class="linenos">  7</span><span class="cm"> * 			     University of Illinois at Urbana-Champaign</span>
<span class="linenos">  8</span><span class="cm"> * 			     http://www.scs.uiuc.edu/~schulten</span>
<span class="linenos">  9</span><span class="cm"> * </span>
<span class="linenos"> 10</span><span class="cm"> * Permission is hereby granted, free of charge, to any person obtaining a copy of</span>
<span class="linenos"> 11</span><span class="cm"> * this software and associated documentation files (the Software), to deal with </span>
<span class="linenos"> 12</span><span class="cm"> * the Software without restriction, including without limitation the rights to </span>
<span class="linenos"> 13</span><span class="cm"> * use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies </span>
<span class="linenos"> 14</span><span class="cm"> * of the Software, and to permit persons to whom the Software is furnished to </span>
<span class="linenos"> 15</span><span class="cm"> * do so, subject to the following conditions:</span>
<span class="linenos"> 16</span><span class="cm"> * </span>
<span class="linenos"> 17</span><span class="cm"> * - Redistributions of source code must retain the above copyright notice, </span>
<span class="linenos"> 18</span><span class="cm"> * this list of conditions and the following disclaimers.</span>
<span class="linenos"> 19</span><span class="cm"> * </span>
<span class="linenos"> 20</span><span class="cm"> * - Redistributions in binary form must reproduce the above copyright notice, </span>
<span class="linenos"> 21</span><span class="cm"> * this list of conditions and the following disclaimers in the documentation </span>
<span class="linenos"> 22</span><span class="cm"> * and/or other materials provided with the distribution.</span>
<span class="linenos"> 23</span><span class="cm"> * </span>
<span class="linenos"> 24</span><span class="cm"> * - Neither the names of the Luthey-Schulten Group, University of Illinois at</span>
<span class="linenos"> 25</span><span class="cm"> * Urbana-Champaign, nor the names of its contributors may be used to endorse or</span>
<span class="linenos"> 26</span><span class="cm"> * promote products derived from this Software without specific prior written</span>
<span class="linenos"> 27</span><span class="cm"> * permission.</span>
<span class="linenos"> 28</span><span class="cm"> * </span>
<span class="linenos"> 29</span><span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR </span>
<span class="linenos"> 30</span><span class="cm"> * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, </span>
<span class="linenos"> 31</span><span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL </span>
<span class="linenos"> 32</span><span class="cm"> * THE CONTRIBUTORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR </span>
<span class="linenos"> 33</span><span class="cm"> * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, </span>
<span class="linenos"> 34</span><span class="cm"> * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR </span>
<span class="linenos"> 35</span><span class="cm"> * OTHER DEALINGS WITH THE SOFTWARE.</span>
<span class="linenos"> 36</span><span class="cm"> *</span>
<span class="linenos"> 37</span><span class="cm"> * Author(s): Elijah Roberts</span>
<span class="linenos"> 38</span><span class="cm"> */</span>
<span class="linenos"> 39</span>
<span class="linenos"> 40</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;list&gt;</span>
<span class="linenos"> 41</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;config.h&quot;</span>
<span class="linenos"> 42</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;core/Print.h&quot;</span>
<span class="linenos"> 43</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;thread/Thread.h&quot;</span>
<span class="linenos"> 44</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;thread/Worker.h&quot;</span>
<span class="linenos"> 45</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;thread/WorkerManager.h&quot;</span>
<span class="linenos"> 46</span>
<span class="linenos"> 47</span><span class="k">namespace</span><span class="w"> </span><span class="nn">lm</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 48</span><span class="k">namespace</span><span class="w"> </span><span class="nn">thread</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 49</span>
<span class="linenos"> 50</span><span class="n">WorkerManager</span><span class="w"> </span><span class="n">WorkerManager</span><span class="o">::</span><span class="n">instance</span><span class="p">;</span>
<span class="linenos"> 51</span>
<span class="linenos"> 52</span><span class="n">WorkerManager</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">WorkerManager::getInstance</span><span class="p">()</span>
<span class="linenos"> 53</span><span class="p">{</span>
<span class="linenos"> 54</span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="o">&amp;</span><span class="n">instance</span><span class="p">;</span>
<span class="linenos"> 55</span><span class="p">}</span>
<span class="linenos"> 56</span>
<span class="linenos"> 57</span><span class="n">WorkerManager</span><span class="o">::</span><span class="n">WorkerManager</span><span class="p">()</span>
<span class="linenos"> 58</span><span class="p">{</span>
<span class="linenos"> 59</span><span class="w">    </span><span class="c1">// Create the mutex.</span>
<span class="linenos"> 60</span><span class="w">    </span><span class="n">PTHREAD_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">pthread_mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">));</span>
<span class="linenos"> 61</span><span class="p">}</span>
<span class="linenos"> 62</span>
<span class="linenos"> 63</span><span class="n">WorkerManager</span><span class="o">::~</span><span class="n">WorkerManager</span><span class="p">()</span>
<span class="linenos"> 64</span><span class="p">{</span>
<span class="linenos"> 65</span><span class="w">    </span><span class="n">PTHREAD_EXCEPTION_CHECK_NOTHROW</span><span class="p">(</span><span class="n">pthread_mutex_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">));</span>
<span class="linenos"> 66</span><span class="p">}</span>
<span class="linenos"> 67</span>
<span class="linenos"> 68</span><span class="kt">void</span><span class="w"> </span><span class="n">WorkerManager</span><span class="o">::</span><span class="n">addWorker</span><span class="p">(</span><span class="n">Worker</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">worker</span><span class="p">)</span>
<span class="linenos"> 69</span><span class="p">{</span>
<span class="linenos"> 70</span><span class="w">    </span><span class="c1">//// BEGIN CRITICAL SECTION: mutex</span>
<span class="linenos"> 71</span><span class="w">    </span><span class="n">PTHREAD_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">pthread_mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">));</span>
<span class="linenos"> 72</span><span class="w">    </span><span class="n">workers</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">worker</span><span class="p">);</span>
<span class="linenos"> 73</span><span class="w">    </span><span class="n">PTHREAD_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">pthread_mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">));</span>
<span class="linenos"> 74</span><span class="w">    </span><span class="c1">//// END CRITICAL SECTION: mutex</span>
<span class="linenos"> 75</span><span class="p">}</span>
<span class="linenos"> 76</span>
<span class="linenos"> 77</span><span class="kt">void</span><span class="w"> </span><span class="n">WorkerManager</span><span class="o">::</span><span class="n">removeWorker</span><span class="p">(</span><span class="n">Worker</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">worker</span><span class="p">)</span>
<span class="linenos"> 78</span><span class="p">{</span>
<span class="linenos"> 79</span><span class="w">    </span><span class="c1">//// BEGIN CRITICAL SECTION: mutex</span>
<span class="linenos"> 80</span><span class="w">    </span><span class="n">PTHREAD_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">pthread_mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">));</span>
<span class="linenos"> 81</span><span class="w">    </span><span class="n">workers</span><span class="p">.</span><span class="n">remove</span><span class="p">(</span><span class="n">worker</span><span class="p">);</span>
<span class="linenos"> 82</span><span class="w">    </span><span class="n">PTHREAD_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">pthread_mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">));</span>
<span class="linenos"> 83</span><span class="w">    </span><span class="c1">//// END CRITICAL SECTION: mutex</span>
<span class="linenos"> 84</span><span class="p">}</span>
<span class="linenos"> 85</span>
<span class="linenos"> 86</span><span class="kt">void</span><span class="w"> </span><span class="n">WorkerManager</span><span class="o">::</span><span class="n">abortWorkers</span><span class="p">()</span>
<span class="linenos"> 87</span><span class="p">{</span>
<span class="linenos"> 88</span><span class="w">    </span><span class="c1">//// BEGIN CRITICAL SECTION: mutex</span>
<span class="linenos"> 89</span><span class="w">    </span><span class="n">PTHREAD_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">pthread_mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">));</span>
<span class="linenos"> 90</span>
<span class="linenos"> 91</span><span class="w">    </span><span class="c1">// Abort the worker threads.</span>
<span class="linenos"> 92</span><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">list</span><span class="o">&lt;</span><span class="n">Worker</span><span class="w"> </span><span class="o">*&gt;::</span><span class="n">iterator</span><span class="w"> </span><span class="n">it</span><span class="o">=</span><span class="n">workers</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">workers</span><span class="p">.</span><span class="n">end</span><span class="p">();</span><span class="w"> </span><span class="n">it</span><span class="o">++</span><span class="p">)</span>
<span class="linenos"> 93</span><span class="w">    </span><span class="p">{</span>
<span class="linenos"> 94</span><span class="w">        </span><span class="p">(</span><span class="o">*</span><span class="n">it</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">abort</span><span class="p">();</span>
<span class="linenos"> 95</span><span class="w">    </span><span class="p">}</span>
<span class="linenos"> 96</span>
<span class="linenos"> 97</span><span class="w">    </span><span class="c1">// Wait for the worker threads to stop.</span>
<span class="linenos"> 98</span><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">list</span><span class="o">&lt;</span><span class="n">Worker</span><span class="w"> </span><span class="o">*&gt;::</span><span class="n">iterator</span><span class="w"> </span><span class="n">it</span><span class="o">=</span><span class="n">workers</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">workers</span><span class="p">.</span><span class="n">end</span><span class="p">();</span><span class="w"> </span><span class="n">it</span><span class="o">++</span><span class="p">)</span>
<span class="linenos"> 99</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">100</span><span class="w">        </span><span class="p">(</span><span class="o">*</span><span class="n">it</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">stop</span><span class="p">();</span>
<span class="linenos">101</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">102</span>
<span class="linenos">103</span><span class="w">    </span><span class="n">PTHREAD_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">pthread_mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">));</span>
<span class="linenos">104</span><span class="w">    </span><span class="c1">//// END CRITICAL SECTION: mutex</span>
<span class="linenos">105</span><span class="p">}</span>
<span class="linenos">106</span>
<span class="linenos">107</span><span class="kt">void</span><span class="w"> </span><span class="n">WorkerManager</span><span class="o">::</span><span class="n">checkpointWorkers</span><span class="p">()</span>
<span class="linenos">108</span><span class="p">{</span>
<span class="linenos">109</span><span class="w">    </span><span class="c1">//// BEGIN CRITICAL SECTION: mutex</span>
<span class="linenos">110</span><span class="w">    </span><span class="n">PTHREAD_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">pthread_mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">));</span>
<span class="linenos">111</span>
<span class="linenos">112</span><span class="w">    </span><span class="c1">// Tell the worker threads to checkpoint.</span>
<span class="linenos">113</span><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">list</span><span class="o">&lt;</span><span class="n">Worker</span><span class="w"> </span><span class="o">*&gt;::</span><span class="n">iterator</span><span class="w"> </span><span class="n">it</span><span class="o">=</span><span class="n">workers</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">workers</span><span class="p">.</span><span class="n">end</span><span class="p">();</span><span class="w"> </span><span class="n">it</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">114</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">115</span><span class="w">        </span><span class="p">(</span><span class="o">*</span><span class="n">it</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">checkpoint</span><span class="p">();</span>
<span class="linenos">116</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">117</span>
<span class="linenos">118</span><span class="w">    </span><span class="n">PTHREAD_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">pthread_mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">));</span>
<span class="linenos">119</span><span class="w">    </span><span class="c1">//// END CRITICAL SECTION: mutex</span>
<span class="linenos">120</span><span class="p">}</span>
<span class="linenos">121</span>
<span class="linenos">122</span><span class="kt">void</span><span class="w"> </span><span class="n">WorkerManager</span><span class="o">::</span><span class="n">stopWorkers</span><span class="p">()</span>
<span class="linenos">123</span><span class="p">{</span>
<span class="linenos">124</span><span class="w">    </span><span class="c1">//// BEGIN CRITICAL SECTION: mutex</span>
<span class="linenos">125</span><span class="w">    </span><span class="n">PTHREAD_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">pthread_mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">));</span>
<span class="linenos">126</span>
<span class="linenos">127</span><span class="w">    </span><span class="c1">// Wait for the worker threads to stop.</span>
<span class="linenos">128</span><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">list</span><span class="o">&lt;</span><span class="n">Worker</span><span class="w"> </span><span class="o">*&gt;::</span><span class="n">iterator</span><span class="w"> </span><span class="n">it</span><span class="o">=</span><span class="n">workers</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">workers</span><span class="p">.</span><span class="n">end</span><span class="p">();</span><span class="w"> </span><span class="n">it</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">129</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">130</span><span class="w">        </span><span class="n">Print</span><span class="o">::</span><span class="n">printf</span><span class="p">(</span><span class="n">Print</span><span class="o">::</span><span class="n">DEBUG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Stopping worker thread: %u&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">it</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">getId</span><span class="p">());</span>
<span class="linenos">131</span><span class="w">        </span><span class="p">(</span><span class="o">*</span><span class="n">it</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">stop</span><span class="p">();</span>
<span class="linenos">132</span><span class="w">        </span><span class="n">Print</span><span class="o">::</span><span class="n">printf</span><span class="p">(</span><span class="n">Print</span><span class="o">::</span><span class="n">DEBUG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Stopped worker thread: %u&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">it</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">getId</span><span class="p">());</span>
<span class="linenos">133</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">134</span>
<span class="linenos">135</span><span class="w">    </span><span class="n">PTHREAD_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">pthread_mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">));</span>
<span class="linenos">136</span><span class="w">    </span><span class="c1">//// END CRITICAL SECTION: mutex</span>
<span class="linenos">137</span><span class="p">}</span>
<span class="linenos">138</span>
<span class="linenos">139</span><span class="p">}</span>
<span class="linenos">140</span><span class="p">}</span>
</pre></div>
</div>
</section>
<section id="worker-h">
<h3>Worker.h<a class="headerlink" href="#worker-h" title="Link to this heading">#</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cm">/*</span>
<span class="linenos"> 2</span><span class="cm"> * University of Illinois Open Source License</span>
<span class="linenos"> 3</span><span class="cm"> * Copyright 2008-2018 Luthey-Schulten Group,</span>
<span class="linenos"> 4</span><span class="cm"> * All rights reserved.</span>
<span class="linenos"> 5</span><span class="cm"> * </span>
<span class="linenos"> 6</span><span class="cm"> * Developed by: Luthey-Schulten Group</span>
<span class="linenos"> 7</span><span class="cm"> * 			     University of Illinois at Urbana-Champaign</span>
<span class="linenos"> 8</span><span class="cm"> * 			     http://www.scs.uiuc.edu/~schulten</span>
<span class="linenos"> 9</span><span class="cm"> * </span>
<span class="linenos">10</span><span class="cm"> * Permission is hereby granted, free of charge, to any person obtaining a copy of</span>
<span class="linenos">11</span><span class="cm"> * this software and associated documentation files (the Software), to deal with </span>
<span class="linenos">12</span><span class="cm"> * the Software without restriction, including without limitation the rights to </span>
<span class="linenos">13</span><span class="cm"> * use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies </span>
<span class="linenos">14</span><span class="cm"> * of the Software, and to permit persons to whom the Software is furnished to </span>
<span class="linenos">15</span><span class="cm"> * do so, subject to the following conditions:</span>
<span class="linenos">16</span><span class="cm"> * </span>
<span class="linenos">17</span><span class="cm"> * - Redistributions of source code must retain the above copyright notice, </span>
<span class="linenos">18</span><span class="cm"> * this list of conditions and the following disclaimers.</span>
<span class="linenos">19</span><span class="cm"> * </span>
<span class="linenos">20</span><span class="cm"> * - Redistributions in binary form must reproduce the above copyright notice, </span>
<span class="linenos">21</span><span class="cm"> * this list of conditions and the following disclaimers in the documentation </span>
<span class="linenos">22</span><span class="cm"> * and/or other materials provided with the distribution.</span>
<span class="linenos">23</span><span class="cm"> * </span>
<span class="linenos">24</span><span class="cm"> * - Neither the names of the Luthey-Schulten Group, University of Illinois at</span>
<span class="linenos">25</span><span class="cm"> * Urbana-Champaign, nor the names of its contributors may be used to endorse or</span>
<span class="linenos">26</span><span class="cm"> * promote products derived from this Software without specific prior written</span>
<span class="linenos">27</span><span class="cm"> * permission.</span>
<span class="linenos">28</span><span class="cm"> * </span>
<span class="linenos">29</span><span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR </span>
<span class="linenos">30</span><span class="cm"> * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, </span>
<span class="linenos">31</span><span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL </span>
<span class="linenos">32</span><span class="cm"> * THE CONTRIBUTORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR </span>
<span class="linenos">33</span><span class="cm"> * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, </span>
<span class="linenos">34</span><span class="cm"> * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR </span>
<span class="linenos">35</span><span class="cm"> * OTHER DEALINGS WITH THE SOFTWARE.</span>
<span class="linenos">36</span><span class="cm"> *</span>
<span class="linenos">37</span><span class="cm"> * Author(s): Elijah Roberts</span>
<span class="linenos">38</span><span class="cm"> */</span>
<span class="linenos">39</span>
<span class="linenos">40</span><span class="cp">#ifndef LM_THREAD_WORKER_H_</span>
<span class="linenos">41</span><span class="cp">#define LM_THREAD_WORKER_H_</span>
<span class="linenos">42</span>
<span class="linenos">43</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;thread/Thread.h&quot;</span>
<span class="linenos">44</span>
<span class="linenos">45</span><span class="k">namespace</span><span class="w"> </span><span class="nn">lm</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">46</span><span class="k">namespace</span><span class="w"> </span><span class="nn">thread</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">47</span>
<span class="linenos">48</span><span class="c1">/// @class Worker</span>
<span class="linenos">49</span><span class="c1">/// @brief An actual worker Thread that runs a simulation replicate</span>
<span class="linenos">50</span><span class="k">class</span><span class="w"> </span><span class="nc">Worker</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">Thread</span>
<span class="linenos">51</span><span class="p">{</span>
<span class="linenos">52</span><span class="k">public</span><span class="o">:</span>
<span class="linenos">53</span><span class="w">    </span><span class="c1">/// @brief Creates thread and attaches it to the manager</span>
<span class="linenos">54</span><span class="w">    </span><span class="n">Worker</span><span class="p">();</span>
<span class="linenos">55</span><span class="w">    </span><span class="c1">/// @brief Removes thread from manager and deletes thread</span>
<span class="linenos">56</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="o">~</span><span class="n">Worker</span><span class="p">();</span>
<span class="linenos">57</span><span class="w">    </span>
<span class="linenos">58</span><span class="w">    </span><span class="c1">/// @brief Set the aborted status for a thread and wakes thread</span>
<span class="linenos">59</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">abort</span><span class="p">();</span>
<span class="linenos">60</span><span class="w">    </span><span class="c1">/// @brief Checkpoint (currently unimplemented)</span>
<span class="linenos">61</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">checkpoint</span><span class="p">();</span>
<span class="linenos">62</span>
<span class="linenos">63</span><span class="k">protected</span><span class="o">:</span>
<span class="linenos">64</span><span class="w">    </span><span class="k">volatile</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">aborted</span><span class="p">;</span><span class="w">  </span><span class="c1">// Status to indicate the replicate was aborted</span>
<span class="linenos">65</span><span class="p">};</span>
<span class="linenos">66</span>
<span class="linenos">67</span><span class="p">}</span>
<span class="linenos">68</span><span class="p">}</span>
<span class="linenos">69</span>
<span class="linenos">70</span><span class="cp">#endif</span>
</pre></div>
</div>
</section>
<section id="worker-cpp">
<h3>Worker.cpp<a class="headerlink" href="#worker-cpp" title="Link to this heading">#</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cm">/*</span>
<span class="linenos"> 2</span><span class="cm"> * University of Illinois Open Source License</span>
<span class="linenos"> 3</span><span class="cm"> * Copyright 2008-2018 Luthey-Schulten Group,</span>
<span class="linenos"> 4</span><span class="cm"> * All rights reserved.</span>
<span class="linenos"> 5</span><span class="cm"> * </span>
<span class="linenos"> 6</span><span class="cm"> * Developed by: Luthey-Schulten Group</span>
<span class="linenos"> 7</span><span class="cm"> * 			     University of Illinois at Urbana-Champaign</span>
<span class="linenos"> 8</span><span class="cm"> * 			     http://www.scs.uiuc.edu/~schulten</span>
<span class="linenos"> 9</span><span class="cm"> * </span>
<span class="linenos">10</span><span class="cm"> * Permission is hereby granted, free of charge, to any person obtaining a copy of</span>
<span class="linenos">11</span><span class="cm"> * this software and associated documentation files (the Software), to deal with </span>
<span class="linenos">12</span><span class="cm"> * the Software without restriction, including without limitation the rights to </span>
<span class="linenos">13</span><span class="cm"> * use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies </span>
<span class="linenos">14</span><span class="cm"> * of the Software, and to permit persons to whom the Software is furnished to </span>
<span class="linenos">15</span><span class="cm"> * do so, subject to the following conditions:</span>
<span class="linenos">16</span><span class="cm"> * </span>
<span class="linenos">17</span><span class="cm"> * - Redistributions of source code must retain the above copyright notice, </span>
<span class="linenos">18</span><span class="cm"> * this list of conditions and the following disclaimers.</span>
<span class="linenos">19</span><span class="cm"> * </span>
<span class="linenos">20</span><span class="cm"> * - Redistributions in binary form must reproduce the above copyright notice, </span>
<span class="linenos">21</span><span class="cm"> * this list of conditions and the following disclaimers in the documentation </span>
<span class="linenos">22</span><span class="cm"> * and/or other materials provided with the distribution.</span>
<span class="linenos">23</span><span class="cm"> * </span>
<span class="linenos">24</span><span class="cm"> * - Neither the names of the Luthey-Schulten Group, University of Illinois at</span>
<span class="linenos">25</span><span class="cm"> * Urbana-Champaign, nor the names of its contributors may be used to endorse or</span>
<span class="linenos">26</span><span class="cm"> * promote products derived from this Software without specific prior written</span>
<span class="linenos">27</span><span class="cm"> * permission.</span>
<span class="linenos">28</span><span class="cm"> * </span>
<span class="linenos">29</span><span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR </span>
<span class="linenos">30</span><span class="cm"> * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, </span>
<span class="linenos">31</span><span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL </span>
<span class="linenos">32</span><span class="cm"> * THE CONTRIBUTORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR </span>
<span class="linenos">33</span><span class="cm"> * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, </span>
<span class="linenos">34</span><span class="cm"> * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR </span>
<span class="linenos">35</span><span class="cm"> * OTHER DEALINGS WITH THE SOFTWARE.</span>
<span class="linenos">36</span><span class="cm"> *</span>
<span class="linenos">37</span><span class="cm"> * Author(s): Elijah Roberts</span>
<span class="linenos">38</span><span class="cm"> */</span>
<span class="linenos">39</span>
<span class="linenos">40</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;config.h&quot;</span>
<span class="linenos">41</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;thread/Thread.h&quot;</span>
<span class="linenos">42</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;thread/Worker.h&quot;</span>
<span class="linenos">43</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;thread/WorkerManager.h&quot;</span>
<span class="linenos">44</span>
<span class="linenos">45</span><span class="k">namespace</span><span class="w"> </span><span class="nn">lm</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">46</span><span class="k">namespace</span><span class="w"> </span><span class="nn">thread</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">47</span>
<span class="linenos">48</span><span class="n">Worker</span><span class="o">::</span><span class="n">Worker</span><span class="p">()</span>
<span class="linenos">49</span><span class="o">:</span><span class="n">aborted</span><span class="p">(</span><span class="nb">false</span><span class="p">)</span>
<span class="linenos">50</span><span class="p">{</span>
<span class="linenos">51</span><span class="w">    </span><span class="n">WorkerManager</span><span class="o">::</span><span class="n">getInstance</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">addWorker</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
<span class="linenos">52</span><span class="p">}</span>
<span class="linenos">53</span>
<span class="linenos">54</span><span class="n">Worker</span><span class="o">::~</span><span class="n">Worker</span><span class="p">()</span>
<span class="linenos">55</span><span class="p">{</span>
<span class="linenos">56</span><span class="w">    </span><span class="n">WorkerManager</span><span class="o">::</span><span class="n">getInstance</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">removeWorker</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
<span class="linenos">57</span><span class="p">}</span>
<span class="linenos">58</span>
<span class="linenos">59</span><span class="kt">void</span><span class="w"> </span><span class="n">Worker</span><span class="o">::</span><span class="n">abort</span><span class="p">()</span>
<span class="linenos">60</span><span class="p">{</span>
<span class="linenos">61</span><span class="w">    </span><span class="c1">//// BEGIN CRITICAL SECTION: controlMutex</span>
<span class="linenos">62</span><span class="w">    </span><span class="n">PTHREAD_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">pthread_mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">controlMutex</span><span class="p">));</span>
<span class="linenos">63</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">running</span><span class="p">)</span>
<span class="linenos">64</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">65</span><span class="w">        </span><span class="c1">// Mark that the worker should abort.</span>
<span class="linenos">66</span><span class="w">        </span><span class="n">aborted</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="linenos">67</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">68</span><span class="w">    </span><span class="n">PTHREAD_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">pthread_mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">controlMutex</span><span class="p">));</span>
<span class="linenos">69</span><span class="w">    </span><span class="c1">//// END CRITICAL SECTION: controlMutex</span>
<span class="linenos">70</span>
<span class="linenos">71</span><span class="w">    </span><span class="c1">// Wake the thread.</span>
<span class="linenos">72</span><span class="w">    </span><span class="n">wake</span><span class="p">();</span>
<span class="linenos">73</span><span class="p">}</span>
<span class="linenos">74</span>
<span class="linenos">75</span><span class="kt">void</span><span class="w"> </span><span class="n">Worker</span><span class="o">::</span><span class="n">checkpoint</span><span class="p">(){}</span>
<span class="linenos">76</span>
<span class="linenos">77</span><span class="p">}</span>
<span class="linenos">78</span><span class="p">}</span>
</pre></div>
</div>
</section>
<section id="thread-h">
<h3>Thread.h<a class="headerlink" href="#thread-h" title="Link to this heading">#</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="linenos">  1</span><span class="cm">/*</span>
<span class="linenos">  2</span><span class="cm"> * University of Illinois Open Source License</span>
<span class="linenos">  3</span><span class="cm"> * Copyright 2008-2018 Luthey-Schulten Group,</span>
<span class="linenos">  4</span><span class="cm"> * All rights reserved.</span>
<span class="linenos">  5</span><span class="cm"> * </span>
<span class="linenos">  6</span><span class="cm"> * Developed by: Luthey-Schulten Group</span>
<span class="linenos">  7</span><span class="cm"> * 			     University of Illinois at Urbana-Champaign</span>
<span class="linenos">  8</span><span class="cm"> * 			     http://www.scs.uiuc.edu/~schulten</span>
<span class="linenos">  9</span><span class="cm"> * </span>
<span class="linenos"> 10</span><span class="cm"> * Permission is hereby granted, free of charge, to any person obtaining a copy of</span>
<span class="linenos"> 11</span><span class="cm"> * this software and associated documentation files (the Software), to deal with </span>
<span class="linenos"> 12</span><span class="cm"> * the Software without restriction, including without limitation the rights to </span>
<span class="linenos"> 13</span><span class="cm"> * use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies </span>
<span class="linenos"> 14</span><span class="cm"> * of the Software, and to permit persons to whom the Software is furnished to </span>
<span class="linenos"> 15</span><span class="cm"> * do so, subject to the following conditions:</span>
<span class="linenos"> 16</span><span class="cm"> * </span>
<span class="linenos"> 17</span><span class="cm"> * - Redistributions of source code must retain the above copyright notice, </span>
<span class="linenos"> 18</span><span class="cm"> * this list of conditions and the following disclaimers.</span>
<span class="linenos"> 19</span><span class="cm"> * </span>
<span class="linenos"> 20</span><span class="cm"> * - Redistributions in binary form must reproduce the above copyright notice, </span>
<span class="linenos"> 21</span><span class="cm"> * this list of conditions and the following disclaimers in the documentation </span>
<span class="linenos"> 22</span><span class="cm"> * and/or other materials provided with the distribution.</span>
<span class="linenos"> 23</span><span class="cm"> * </span>
<span class="linenos"> 24</span><span class="cm"> * - Neither the names of the Luthey-Schulten Group, University of Illinois at</span>
<span class="linenos"> 25</span><span class="cm"> * Urbana-Champaign, nor the names of its contributors may be used to endorse or</span>
<span class="linenos"> 26</span><span class="cm"> * promote products derived from this Software without specific prior written</span>
<span class="linenos"> 27</span><span class="cm"> * permission.</span>
<span class="linenos"> 28</span><span class="cm"> * </span>
<span class="linenos"> 29</span><span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR </span>
<span class="linenos"> 30</span><span class="cm"> * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, </span>
<span class="linenos"> 31</span><span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL </span>
<span class="linenos"> 32</span><span class="cm"> * THE CONTRIBUTORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR </span>
<span class="linenos"> 33</span><span class="cm"> * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, </span>
<span class="linenos"> 34</span><span class="cm"> * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR </span>
<span class="linenos"> 35</span><span class="cm"> * OTHER DEALINGS WITH THE SOFTWARE.</span>
<span class="linenos"> 36</span><span class="cm"> *</span>
<span class="linenos"> 37</span><span class="cm"> * Author(s): Elijah Roberts</span>
<span class="linenos"> 38</span><span class="cm"> */</span>
<span class="linenos"> 39</span>
<span class="linenos"> 40</span><span class="cp">#ifndef LM_THREAD_THREAD_H_</span>
<span class="linenos"> 41</span><span class="cp">#define LM_THREAD_THREAD_H_</span>
<span class="linenos"> 42</span>
<span class="linenos"> 43</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;cstdlib&gt;</span>
<span class="linenos"> 44</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;pthread.h&gt;</span>
<span class="linenos"> 45</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;core/Exceptions.h&quot;</span>
<span class="linenos"> 46</span>
<span class="linenos"> 47</span><span class="k">namespace</span><span class="w"> </span><span class="nn">lm</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 48</span><span class="k">namespace</span><span class="w"> </span><span class="nn">thread</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 49</span>
<span class="linenos"> 50</span><span class="c1">/// @class PthreadException</span>
<span class="linenos"> 51</span><span class="c1">/// @brief An Exception class for handling pthread exceptions.</span>
<span class="linenos"> 52</span><span class="k">class</span><span class="w"> </span><span class="nc">PthreadException</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">Exception</span>
<span class="linenos"> 53</span><span class="p">{</span>
<span class="linenos"> 54</span><span class="k">public</span><span class="o">:</span>
<span class="linenos"> 55</span><span class="w">    </span><span class="n">PthreadException</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">line</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">Exception</span><span class="p">(</span><span class="s">&quot;Error in pthread library&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="n">line</span><span class="p">)</span><span class="w"> </span><span class="p">{}</span>
<span class="linenos"> 56</span><span class="p">};</span>
<span class="linenos"> 57</span>
<span class="linenos"> 58</span><span class="c1">/// @class Thread</span>
<span class="linenos"> 59</span><span class="c1">/// @brief A base class wrapping pthreads.</span>
<span class="linenos"> 60</span><span class="k">class</span><span class="w"> </span><span class="nc">Thread</span>
<span class="linenos"> 61</span><span class="p">{</span>
<span class="linenos"> 62</span><span class="k">public</span><span class="o">:</span>
<span class="linenos"> 63</span><span class="w">    </span><span class="c1">/// @brief Creates a pthread locking mechanism and initializes &quot;Thread&quot;</span>
<span class="linenos"> 64</span><span class="w">    </span><span class="n">Thread</span><span class="p">();</span>
<span class="linenos"> 65</span><span class="w">    </span><span class="c1">/// @brief Destory the Thread</span>
<span class="linenos"> 66</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="o">~</span><span class="n">Thread</span><span class="p">();</span>
<span class="linenos"> 67</span><span class="w">    </span>
<span class="linenos"> 68</span><span class="w">    </span><span class="c1">/// @brief If no thread exists, creates a new thread and begins execution</span>
<span class="linenos"> 69</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">start</span><span class="p">();</span>
<span class="linenos"> 70</span><span class="w">    </span><span class="c1">/// @brief Joins the thread with the parent waiting if necessary</span>
<span class="linenos"> 71</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">stop</span><span class="p">();</span>
<span class="linenos"> 72</span><span class="w">    </span><span class="c1">/// @brief Wakes a sleeping thead</span>
<span class="linenos"> 73</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">wake</span><span class="p">()</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<span class="linenos"> 74</span><span class="w">    </span><span class="c1">/// @brief Returns the pthread based id for the Thread</span>
<span class="linenos"> 75</span><span class="w">    </span><span class="c1">/// @return pthread assigned id</span>
<span class="linenos"> 76</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="n">pthread_t</span><span class="w"> </span><span class="nf">getId</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="k">return</span><span class="w"> </span><span class="n">threadId</span><span class="p">;}</span>
<span class="linenos"> 77</span><span class="w">    </span><span class="c1">/// @brief Binds the thread to a CPU core</span>
<span class="linenos"> 78</span><span class="w">    </span><span class="c1">/// @param The cpu core for which to bind the thread</span>
<span class="linenos"> 79</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setAffinity</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">cpuNumber</span><span class="p">);</span>
<span class="linenos"> 80</span>
<span class="linenos"> 81</span><span class="k">protected</span><span class="o">:</span>
<span class="linenos"> 82</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">run</span><span class="p">()</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<span class="linenos"> 83</span>
<span class="linenos"> 84</span><span class="k">private</span><span class="o">:</span>
<span class="linenos"> 85</span><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">start_thread</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">obj</span><span class="p">);</span>
<span class="linenos"> 86</span>
<span class="linenos"> 87</span><span class="k">protected</span><span class="o">:</span>
<span class="linenos"> 88</span><span class="w">    </span><span class="n">pthread_mutex_t</span><span class="w"> </span><span class="n">controlMutex</span><span class="p">;</span><span class="w">   </span><span class="c1">// thread locking mechanism</span>
<span class="linenos"> 89</span><span class="w">    </span><span class="n">pthread_t</span><span class="w"> </span><span class="n">threadId</span><span class="p">;</span><span class="w">             </span><span class="c1">// thread ID</span>
<span class="linenos"> 90</span><span class="w">    </span><span class="k">volatile</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">running</span><span class="p">;</span><span class="w">          </span><span class="c1">// thread status</span>
<span class="linenos"> 91</span><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">cpuNumber</span><span class="p">;</span><span class="w">                  </span><span class="c1">// which cpu thread is running on</span>
<span class="linenos"> 92</span><span class="p">};</span>
<span class="linenos"> 93</span>
<span class="linenos"> 94</span><span class="p">}</span>
<span class="linenos"> 95</span><span class="p">}</span>
<span class="linenos"> 96</span>
<span class="linenos"> 97</span>
<span class="linenos"> 98</span><span class="c1">/// @def PTHREAD_EXCEPTION_CHECK</span>
<span class="linenos"> 99</span><span class="c1">/// @brief Exception wrapping for the pthread api.</span>
<span class="linenos">100</span><span class="cp">#define PTHREAD_EXCEPTION_CHECK(pthread_call) {int _pthread_ret_=pthread_call; if (_pthread_ret_ != 0) throw lm::thread::PthreadException(_pthread_ret_,__FILE__,__LINE__);}</span>
<span class="linenos">101</span><span class="cp">#define PTHREAD_EXCEPTION_CHECK_NOTHROW(pthread_call) {int _pthread_ret_=pthread_call; if (_pthread_ret_ != 0) {fprintf(stderr, &quot;%s:%d: Pthread error, returned %d\n&quot;, __FILE__, __LINE__, _pthread_ret_); abort();}}</span>
<span class="linenos">102</span>
<span class="linenos">103</span><span class="cp">#endif</span>
</pre></div>
</div>
</section>
<section id="thread-cpp">
<h3>Thread.cpp<a class="headerlink" href="#thread-cpp" title="Link to this heading">#</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="linenos">  1</span><span class="cm">/*</span>
<span class="linenos">  2</span><span class="cm"> * University of Illinois Open Source License</span>
<span class="linenos">  3</span><span class="cm"> * Copyright 2008-2018 Luthey-Schulten Group,</span>
<span class="linenos">  4</span><span class="cm"> * All rights reserved.</span>
<span class="linenos">  5</span><span class="cm"> * </span>
<span class="linenos">  6</span><span class="cm"> * Developed by: Luthey-Schulten Group</span>
<span class="linenos">  7</span><span class="cm"> * 			     University of Illinois at Urbana-Champaign</span>
<span class="linenos">  8</span><span class="cm"> * 			     http://www.scs.uiuc.edu/~schulten</span>
<span class="linenos">  9</span><span class="cm"> * </span>
<span class="linenos"> 10</span><span class="cm"> * Permission is hereby granted, free of charge, to any person obtaining a copy of</span>
<span class="linenos"> 11</span><span class="cm"> * this software and associated documentation files (the Software), to deal with </span>
<span class="linenos"> 12</span><span class="cm"> * the Software without restriction, including without limitation the rights to </span>
<span class="linenos"> 13</span><span class="cm"> * use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies </span>
<span class="linenos"> 14</span><span class="cm"> * of the Software, and to permit persons to whom the Software is furnished to </span>
<span class="linenos"> 15</span><span class="cm"> * do so, subject to the following conditions:</span>
<span class="linenos"> 16</span><span class="cm"> * </span>
<span class="linenos"> 17</span><span class="cm"> * - Redistributions of source code must retain the above copyright notice, </span>
<span class="linenos"> 18</span><span class="cm"> * this list of conditions and the following disclaimers.</span>
<span class="linenos"> 19</span><span class="cm"> * </span>
<span class="linenos"> 20</span><span class="cm"> * - Redistributions in binary form must reproduce the above copyright notice, </span>
<span class="linenos"> 21</span><span class="cm"> * this list of conditions and the following disclaimers in the documentation </span>
<span class="linenos"> 22</span><span class="cm"> * and/or other materials provided with the distribution.</span>
<span class="linenos"> 23</span><span class="cm"> * </span>
<span class="linenos"> 24</span><span class="cm"> * - Neither the names of the Luthey-Schulten Group, University of Illinois at</span>
<span class="linenos"> 25</span><span class="cm"> * Urbana-Champaign, nor the names of its contributors may be used to endorse or</span>
<span class="linenos"> 26</span><span class="cm"> * promote products derived from this Software without specific prior written</span>
<span class="linenos"> 27</span><span class="cm"> * permission.</span>
<span class="linenos"> 28</span><span class="cm"> * </span>
<span class="linenos"> 29</span><span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR </span>
<span class="linenos"> 30</span><span class="cm"> * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, </span>
<span class="linenos"> 31</span><span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL </span>
<span class="linenos"> 32</span><span class="cm"> * THE CONTRIBUTORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR </span>
<span class="linenos"> 33</span><span class="cm"> * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, </span>
<span class="linenos"> 34</span><span class="cm"> * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR </span>
<span class="linenos"> 35</span><span class="cm"> * OTHER DEALINGS WITH THE SOFTWARE.</span>
<span class="linenos"> 36</span><span class="cm"> *</span>
<span class="linenos"> 37</span><span class="cm"> * Author(s): Elijah Roberts</span>
<span class="linenos"> 38</span><span class="cm"> */</span>
<span class="linenos"> 39</span>
<span class="linenos"> 40</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;config.h&quot;</span>
<span class="linenos"> 41</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;pthread.h&gt;</span>
<span class="linenos"> 42</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;core/Print.h&quot;</span>
<span class="linenos"> 43</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;thread/Thread.h&quot;</span>
<span class="linenos"> 44</span>
<span class="linenos"> 45</span><span class="k">namespace</span><span class="w"> </span><span class="nn">lm</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 46</span><span class="k">namespace</span><span class="w"> </span><span class="nn">thread</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 47</span>
<span class="linenos"> 48</span><span class="n">Thread</span><span class="o">::</span><span class="n">Thread</span><span class="p">()</span>
<span class="linenos"> 49</span><span class="o">:</span><span class="n">threadId</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="n">running</span><span class="p">(</span><span class="nb">false</span><span class="p">),</span><span class="n">cpuNumber</span><span class="p">(</span><span class="mi">-1</span><span class="p">)</span>
<span class="linenos"> 50</span><span class="p">{</span>
<span class="linenos"> 51</span><span class="w">    </span><span class="c1">// Create the control mutex.</span>
<span class="linenos"> 52</span><span class="w">	</span><span class="n">pthread_mutexattr_t</span><span class="w"> </span><span class="n">attr</span><span class="p">;</span>
<span class="linenos"> 53</span><span class="w">	</span><span class="n">PTHREAD_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">pthread_mutexattr_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">attr</span><span class="p">));</span>
<span class="linenos"> 54</span><span class="w">	</span><span class="n">PTHREAD_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">pthread_mutexattr_settype</span><span class="p">(</span><span class="o">&amp;</span><span class="n">attr</span><span class="p">,</span><span class="w"> </span><span class="n">PTHREAD_MUTEX_NORMAL</span><span class="p">));</span>
<span class="linenos"> 55</span><span class="w">    </span><span class="n">PTHREAD_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">pthread_mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">controlMutex</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">attr</span><span class="p">));</span>
<span class="linenos"> 56</span><span class="w">    </span><span class="n">PTHREAD_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">pthread_mutexattr_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">attr</span><span class="p">));</span>
<span class="linenos"> 57</span><span class="p">}</span>
<span class="linenos"> 58</span>
<span class="linenos"> 59</span><span class="n">Thread</span><span class="o">::~</span><span class="n">Thread</span><span class="p">()</span>
<span class="linenos"> 60</span><span class="p">{</span>
<span class="linenos"> 61</span><span class="w">    </span><span class="n">PTHREAD_EXCEPTION_CHECK_NOTHROW</span><span class="p">(</span><span class="n">pthread_mutex_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">controlMutex</span><span class="p">));</span>
<span class="linenos"> 62</span><span class="p">}</span>
<span class="linenos"> 63</span>
<span class="linenos"> 64</span><span class="kt">void</span><span class="w"> </span><span class="n">Thread</span><span class="o">::</span><span class="n">setAffinity</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">cpuNumber</span><span class="p">)</span>
<span class="linenos"> 65</span><span class="p">{</span>
<span class="linenos"> 66</span><span class="w">    </span><span class="c1">//// BEGIN CRITICAL SECTION: controlMutex</span>
<span class="linenos"> 67</span><span class="w">    </span><span class="n">PTHREAD_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">pthread_mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">controlMutex</span><span class="p">));</span>
<span class="linenos"> 68</span>
<span class="linenos"> 69</span><span class="w">    </span><span class="c1">// Set the assigned cpu.</span>
<span class="linenos"> 70</span><span class="w">	</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">cpuNumber</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cpuNumber</span><span class="p">;</span>
<span class="linenos"> 71</span>
<span class="linenos"> 72</span><span class="w">	</span><span class="c1">// If we are already running, reset the processor affinity.</span>
<span class="linenos"> 73</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">running</span><span class="p">)</span>
<span class="linenos"> 74</span><span class="w">    </span><span class="p">{</span>
<span class="linenos"> 75</span><span class="w">		</span><span class="cp">#if defined(LINUX) &amp;&amp; !defined(ARM)</span>
<span class="linenos"> 76</span><span class="w">		</span><span class="kt">cpu_set_t</span><span class="w"> </span><span class="n">cpuset</span><span class="p">;</span>
<span class="linenos"> 77</span><span class="w">		</span><span class="n">CPU_ZERO</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cpuset</span><span class="p">);</span>
<span class="linenos"> 78</span><span class="w">		</span><span class="n">CPU_SET</span><span class="p">(</span><span class="n">cpuNumber</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">cpuset</span><span class="p">);</span>
<span class="linenos"> 79</span><span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pthread_setaffinity_np</span><span class="p">(</span><span class="n">threadId</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">cpu_set_t</span><span class="p">),</span><span class="w"> </span><span class="o">&amp;</span><span class="n">cpuset</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="linenos"> 80</span><span class="w">			</span><span class="n">Print</span><span class="o">::</span><span class="n">printf</span><span class="p">(</span><span class="n">Print</span><span class="o">::</span><span class="n">WARNING</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Could not bind thread %u to CPU core %d&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">threadId</span><span class="p">,</span><span class="w"> </span><span class="n">cpuNumber</span><span class="p">);</span>
<span class="linenos"> 81</span><span class="w">		</span><span class="cp">#endif</span>
<span class="linenos"> 82</span><span class="w">    </span><span class="p">}</span>
<span class="linenos"> 83</span><span class="w">    </span><span class="n">PTHREAD_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">pthread_mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">controlMutex</span><span class="p">));</span>
<span class="linenos"> 84</span><span class="w">    </span><span class="c1">//// END CRITICAL SECTION: controlMutex</span>
<span class="linenos"> 85</span><span class="p">}</span>
<span class="linenos"> 86</span>
<span class="linenos"> 87</span><span class="kt">void</span><span class="w"> </span><span class="n">Thread</span><span class="o">::</span><span class="n">start</span><span class="p">()</span>
<span class="linenos"> 88</span><span class="p">{</span>
<span class="linenos"> 89</span><span class="w">    </span><span class="c1">//// BEGIN CRITICAL SECTION: controlMutex</span>
<span class="linenos"> 90</span><span class="w">    </span><span class="n">PTHREAD_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">pthread_mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">controlMutex</span><span class="p">));</span>
<span class="linenos"> 91</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">running</span><span class="p">)</span>
<span class="linenos"> 92</span><span class="w">    </span><span class="p">{</span>
<span class="linenos"> 93</span><span class="w">        </span><span class="n">running</span><span class="o">=</span><span class="nb">true</span><span class="p">;</span>
<span class="linenos"> 94</span><span class="w">        </span><span class="n">pthread_attr_t</span><span class="w"> </span><span class="n">attr</span><span class="p">;</span>
<span class="linenos"> 95</span><span class="w">        </span><span class="n">PTHREAD_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">pthread_attr_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">attr</span><span class="p">));</span>
<span class="linenos"> 96</span><span class="w">        </span><span class="n">PTHREAD_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">pthread_attr_setdetachstate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">attr</span><span class="p">,</span><span class="w"> </span><span class="n">PTHREAD_CREATE_JOINABLE</span><span class="p">));</span>
<span class="linenos"> 97</span><span class="w">        </span><span class="n">PTHREAD_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">pthread_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">threadId</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">attr</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">Thread</span><span class="o">::</span><span class="n">start_thread</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">));</span>
<span class="linenos"> 98</span><span class="w">        </span><span class="n">PTHREAD_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">pthread_attr_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">attr</span><span class="p">));</span>
<span class="linenos"> 99</span>
<span class="linenos">100</span><span class="w">    	</span><span class="c1">// Set the processor affinity, if we have a cpu assigned.</span>
<span class="linenos">101</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cpuNumber</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">102</span><span class="w">        </span><span class="p">{</span>
<span class="linenos">103</span><span class="w">			</span><span class="cp">#if defined(LINUX) &amp;&amp; !defined(ARM)</span>
<span class="linenos">104</span><span class="w">			</span><span class="kt">cpu_set_t</span><span class="w"> </span><span class="n">cpuset</span><span class="p">;</span>
<span class="linenos">105</span><span class="w">			</span><span class="n">CPU_ZERO</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cpuset</span><span class="p">);</span>
<span class="linenos">106</span><span class="w">			</span><span class="n">CPU_SET</span><span class="p">(</span><span class="n">cpuNumber</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">cpuset</span><span class="p">);</span>
<span class="linenos">107</span><span class="w">			</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pthread_setaffinity_np</span><span class="p">(</span><span class="n">threadId</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">cpu_set_t</span><span class="p">),</span><span class="w"> </span><span class="o">&amp;</span><span class="n">cpuset</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">108</span><span class="w">				</span><span class="n">Print</span><span class="o">::</span><span class="n">printf</span><span class="p">(</span><span class="n">Print</span><span class="o">::</span><span class="n">WARNING</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Could not bind thread %u to CPU core %d&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">threadId</span><span class="p">,</span><span class="w"> </span><span class="n">cpuNumber</span><span class="p">);</span>
<span class="linenos">109</span><span class="w">			</span><span class="cp">#endif</span>
<span class="linenos">110</span><span class="w">        </span><span class="p">}</span>
<span class="linenos">111</span><span class="w">        </span><span class="n">Print</span><span class="o">::</span><span class="n">printf</span><span class="p">(</span><span class="n">Print</span><span class="o">::</span><span class="n">DEBUG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Started thread %u.&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">threadId</span><span class="p">);</span>
<span class="linenos">112</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">113</span><span class="w">    </span><span class="n">PTHREAD_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">pthread_mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">controlMutex</span><span class="p">));</span>
<span class="linenos">114</span><span class="w">    </span><span class="c1">//// END CRITICAL SECTION: controlMutex</span>
<span class="linenos">115</span><span class="p">}</span>
<span class="linenos">116</span>
<span class="linenos">117</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">Thread</span><span class="o">::</span><span class="n">start_thread</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">obj</span><span class="p">)</span>
<span class="linenos">118</span><span class="p">{</span>
<span class="linenos">119</span><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">Thread</span><span class="w"> </span><span class="o">*&gt;</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">run</span><span class="p">();</span>
<span class="linenos">120</span><span class="w">    </span><span class="n">pthread_exit</span><span class="p">((</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">ret</span><span class="p">);</span>
<span class="linenos">121</span><span class="p">}</span>
<span class="linenos">122</span>
<span class="linenos">123</span><span class="kt">void</span><span class="w"> </span><span class="n">Thread</span><span class="o">::</span><span class="n">stop</span><span class="p">()</span>
<span class="linenos">124</span><span class="p">{</span>
<span class="linenos">125</span><span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">waitForThread</span><span class="o">=</span><span class="nb">false</span><span class="p">;</span>
<span class="linenos">126</span>
<span class="linenos">127</span><span class="w">    </span><span class="c1">//// BEGIN CRITICAL SECTION: controlMutex</span>
<span class="linenos">128</span><span class="w">    </span><span class="n">PTHREAD_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">pthread_mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">controlMutex</span><span class="p">));</span>
<span class="linenos">129</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">running</span><span class="p">)</span>
<span class="linenos">130</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">131</span><span class="w">        </span><span class="n">Print</span><span class="o">::</span><span class="n">printf</span><span class="p">(</span><span class="n">Print</span><span class="o">::</span><span class="n">DEBUG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Stopping thread %u.&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">threadId</span><span class="p">);</span>
<span class="linenos">132</span><span class="w">        </span><span class="n">running</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="linenos">133</span><span class="w">        </span><span class="n">waitForThread</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="linenos">134</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">135</span><span class="w">    </span><span class="n">PTHREAD_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">pthread_mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">controlMutex</span><span class="p">));</span>
<span class="linenos">136</span><span class="w">    </span><span class="c1">//// END CRITICAL SECTION: controlMutex</span>
<span class="linenos">137</span>
<span class="linenos">138</span><span class="w">    </span><span class="c1">// Wait for the thread to stop, if we really stopped it.</span>
<span class="linenos">139</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">waitForThread</span><span class="p">)</span>
<span class="linenos">140</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">141</span><span class="w">        </span><span class="c1">// Try to wake up the thread in case it is sleeping.</span>
<span class="linenos">142</span><span class="w">        </span><span class="n">wake</span><span class="p">();</span>
<span class="linenos">143</span>
<span class="linenos">144</span><span class="w">        </span><span class="c1">// Join with the thread.</span>
<span class="linenos">145</span><span class="w">        </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>
<span class="linenos">146</span><span class="w">        </span><span class="n">PTHREAD_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">pthread_join</span><span class="p">(</span><span class="n">threadId</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">ret</span><span class="p">));</span>
<span class="linenos">147</span><span class="w">        </span><span class="n">Print</span><span class="o">::</span><span class="n">printf</span><span class="p">(</span><span class="n">Print</span><span class="o">::</span><span class="n">DEBUG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Thread %u stopped.&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">threadId</span><span class="p">);</span>
<span class="linenos">148</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">149</span><span class="p">}</span>
<span class="linenos">150</span>
<span class="linenos">151</span><span class="p">}</span>
<span class="linenos">152</span><span class="p">}</span>
</pre></div>
</div>
</section>
</section>
<section id="utility-classes">
<h2>Utility Classes<a class="headerlink" href="#utility-classes" title="Link to this heading">#</a></h2>
<section id="simulationfile-h">
<h3>SimulationFile.h<a class="headerlink" href="#simulationfile-h" title="Link to this heading">#</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="linenos">  1</span><span class="cm">/*</span>
<span class="linenos">  2</span><span class="cm"> * University of Illinois Open Source License</span>
<span class="linenos">  3</span><span class="cm"> * Copyright 2010-2018 Luthey-Schulten Group,</span>
<span class="linenos">  4</span><span class="cm"> * All rights reserved.</span>
<span class="linenos">  5</span><span class="cm"> * </span>
<span class="linenos">  6</span><span class="cm"> * Developed by: Luthey-Schulten Group</span>
<span class="linenos">  7</span><span class="cm"> * 			     University of Illinois at Urbana-Champaign</span>
<span class="linenos">  8</span><span class="cm"> * 			     http://www.scs.uiuc.edu/~schulten</span>
<span class="linenos">  9</span><span class="cm"> * </span>
<span class="linenos"> 10</span><span class="cm"> * Permission is hereby granted, free of charge, to any person obtaining a copy of</span>
<span class="linenos"> 11</span><span class="cm"> * this software and associated documentation files (the Software), to deal with </span>
<span class="linenos"> 12</span><span class="cm"> * the Software without restriction, including without limitation the rights to </span>
<span class="linenos"> 13</span><span class="cm"> * use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies </span>
<span class="linenos"> 14</span><span class="cm"> * of the Software, and to permit persons to whom the Software is furnished to </span>
<span class="linenos"> 15</span><span class="cm"> * do so, subject to the following conditions:</span>
<span class="linenos"> 16</span><span class="cm"> * </span>
<span class="linenos"> 17</span><span class="cm"> * - Redistributions of source code must retain the above copyright notice, </span>
<span class="linenos"> 18</span><span class="cm"> * this list of conditions and the following disclaimers.</span>
<span class="linenos"> 19</span><span class="cm"> * </span>
<span class="linenos"> 20</span><span class="cm"> * - Redistributions in binary form must reproduce the above copyright notice, </span>
<span class="linenos"> 21</span><span class="cm"> * this list of conditions and the following disclaimers in the documentation </span>
<span class="linenos"> 22</span><span class="cm"> * and/or other materials provided with the distribution.</span>
<span class="linenos"> 23</span><span class="cm"> * </span>
<span class="linenos"> 24</span><span class="cm"> * - Neither the names of the Luthey-Schulten Group, University of Illinois at</span>
<span class="linenos"> 25</span><span class="cm"> * Urbana-Champaign, nor the names of its contributors may be used to endorse or</span>
<span class="linenos"> 26</span><span class="cm"> * promote products derived from this Software without specific prior written</span>
<span class="linenos"> 27</span><span class="cm"> * permission.</span>
<span class="linenos"> 28</span><span class="cm"> * </span>
<span class="linenos"> 29</span><span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR </span>
<span class="linenos"> 30</span><span class="cm"> * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, </span>
<span class="linenos"> 31</span><span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL </span>
<span class="linenos"> 32</span><span class="cm"> * THE CONTRIBUTORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR </span>
<span class="linenos"> 33</span><span class="cm"> * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, </span>
<span class="linenos"> 34</span><span class="cm"> * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR </span>
<span class="linenos"> 35</span><span class="cm"> * OTHER DEALINGS WITH THE SOFTWARE.</span>
<span class="linenos"> 36</span><span class="cm"> *</span>
<span class="linenos"> 37</span><span class="cm"> * Author(s): Elijah Roberts</span>
<span class="linenos"> 38</span><span class="cm"> */</span>
<span class="linenos"> 39</span>
<span class="linenos"> 40</span><span class="cp">#ifndef LM_IO_HDF5_SIMULATIONFILE_H_</span>
<span class="linenos"> 41</span><span class="cp">#define LM_IO_HDF5_SIMULATIONFILE_H_</span>
<span class="linenos"> 42</span>
<span class="linenos"> 43</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;string&gt;</span>
<span class="linenos"> 44</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;map&gt;</span>
<span class="linenos"> 45</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;vector&gt;</span>
<span class="linenos"> 46</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;core/Exceptions.h&quot;</span>
<span class="linenos"> 47</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;core/Types.h&quot;</span>
<span class="linenos"> 48</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;io/lm_hdf5.h&quot;</span>
<span class="linenos"> 49</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;io/ArbitraryH5.h&quot;</span>
<span class="linenos"> 50</span>
<span class="linenos"> 51</span><span class="k">namespace</span><span class="w"> </span><span class="nn">lm</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 52</span>
<span class="linenos"> 53</span><span class="k">namespace</span><span class="w"> </span><span class="nn">rdme</span><span class="p">{</span>
<span class="linenos"> 54</span><span class="k">class</span><span class="w"> </span><span class="nc">Lattice</span><span class="p">;</span>
<span class="linenos"> 55</span><span class="k">class</span><span class="w"> </span><span class="nc">ByteLattice</span><span class="p">;</span>
<span class="linenos"> 56</span><span class="k">class</span><span class="w"> </span><span class="nc">IntLattice</span><span class="p">;</span>
<span class="linenos"> 57</span><span class="p">}</span>
<span class="linenos"> 58</span>
<span class="linenos"> 59</span><span class="k">namespace</span><span class="w"> </span><span class="nn">io</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 60</span>
<span class="linenos"> 61</span><span class="k">class</span><span class="w"> </span><span class="nc">DiffusionModel</span><span class="p">;</span>
<span class="linenos"> 62</span><span class="k">class</span><span class="w"> </span><span class="nc">ReactionModel</span><span class="p">;</span>
<span class="linenos"> 63</span><span class="k">class</span><span class="w"> </span><span class="nc">Lattice</span><span class="p">;</span>
<span class="linenos"> 64</span><span class="k">class</span><span class="w"> </span><span class="nc">ParameterValues</span><span class="p">;</span>
<span class="linenos"> 65</span><span class="k">class</span><span class="w"> </span><span class="nc">SpeciesCounts</span><span class="p">;</span>
<span class="linenos"> 66</span><span class="k">class</span><span class="w"> </span><span class="nc">SpatialModel</span><span class="p">;</span>
<span class="linenos"> 67</span><span class="k">class</span><span class="w"> </span><span class="nc">FirstPassageTimes</span><span class="p">;</span>
<span class="linenos"> 68</span>
<span class="linenos"> 69</span><span class="k">namespace</span><span class="w"> </span><span class="nn">hdf5</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 70</span>
<span class="linenos"> 71</span><span class="k">using</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">;</span>
<span class="linenos"> 72</span><span class="k">using</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="p">;</span>
<span class="linenos"> 73</span><span class="k">using</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="p">;</span>
<span class="linenos"> 74</span><span class="k">using</span><span class="w"> </span><span class="n">lm</span><span class="o">::</span><span class="n">IOException</span><span class="p">;</span>
<span class="linenos"> 75</span>
<span class="linenos"> 76</span><span class="c1">/// @class SimulationFile</span>
<span class="linenos"> 77</span><span class="c1">/// @brief A representation of the simulation that is used to input or output from an HDF5 file</span>
<span class="linenos"> 78</span><span class="k">class</span><span class="w"> </span><span class="nc">SimulationFile</span>
<span class="linenos"> 79</span><span class="p">{</span>
<span class="linenos"> 80</span><span class="c1">// Static variables and functions</span>
<span class="linenos"> 81</span><span class="k">public</span><span class="o">:</span>
<span class="linenos"> 82</span><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">uint</span><span class="w"> </span><span class="n">MIN_VERSION</span><span class="p">;</span>
<span class="linenos"> 83</span><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">uint</span><span class="w"> </span><span class="n">CURRENT_VERSION</span><span class="p">;</span>
<span class="linenos"> 84</span><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">uint</span><span class="w"> </span><span class="n">MAX_REACTION_RATE_CONSTANTS</span><span class="p">;</span>
<span class="linenos"> 85</span><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">uint</span><span class="w"> </span><span class="n">MAX_SHAPE_PARAMETERS</span><span class="p">;</span>
<span class="linenos"> 86</span>
<span class="linenos"> 87</span><span class="k">public</span><span class="o">:</span>
<span class="linenos"> 88</span><span class="w">    </span><span class="c1">/// @brief Check that the HDF5 file is valid</span>
<span class="linenos"> 89</span><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">isValidFile</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">string</span><span class="w"> </span><span class="n">filename</span><span class="p">);</span>
<span class="linenos"> 90</span><span class="w">    </span><span class="c1">/// @brief Check that the HDF5 file is valid</span>
<span class="linenos"> 91</span><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="nf">isValidFile</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">filename</span><span class="p">);</span>
<span class="linenos"> 92</span><span class="w">    </span><span class="c1">/// @brief Create an HDF5 file</span>
<span class="linenos"> 93</span><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">create</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">string</span><span class="w"> </span><span class="n">filename</span><span class="p">);</span>
<span class="linenos"> 94</span><span class="w">    </span><span class="c1">/// @brief Create an HDF5 file</span>
<span class="linenos"> 95</span><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">create</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="w">  </span><span class="n">filename</span><span class="p">);</span>
<span class="linenos"> 96</span><span class="w">    </span><span class="c1">/// @brief Create an HDF5 file with the specified number of species</span>
<span class="linenos"> 97</span><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">create</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">string</span><span class="w"> </span><span class="n">filename</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">numberSpecies</span><span class="p">);</span>
<span class="linenos"> 98</span><span class="w">    </span><span class="c1">/// @brief Create an HDF5 file with the specified number of species</span>
<span class="linenos"> 99</span><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">create</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="w">  </span><span class="n">filename</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">numberSpecies</span><span class="p">);</span>
<span class="linenos">100</span><span class="w">    </span><span class="c1">/// @brief Create an HDF5 file and initialize the model with an optional number of species</span>
<span class="linenos">101</span><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">create</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">filename</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">initializeModel</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">numberSpecies</span><span class="o">=</span><span class="mi">0</span><span class="p">);</span>
<span class="linenos">102</span>
<span class="linenos">103</span><span class="k">protected</span><span class="o">:</span>
<span class="linenos">104</span><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="n">herr_t</span><span class="w"> </span><span class="n">parseParameter</span><span class="p">(</span><span class="n">hid_t</span><span class="w"> </span><span class="n">location_id</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">attr_name</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">H5A_info_t</span><span class="w"> </span><span class="o">*</span><span class="n">ainfo</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">op_data</span><span class="p">);</span>
<span class="linenos">105</span><span class="w">	</span><span class="kt">void</span><span class="w"> </span><span class="nf">writeParticleLattice_U8LE</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">path</span><span class="p">,</span><span class="w">  </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">z</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">w</span><span class="p">);</span>
<span class="linenos">106</span><span class="w">	</span><span class="kt">void</span><span class="w"> </span><span class="nf">writeParticleLattice_U32LE</span><span class="p">(</span><span class="n">hid_t</span><span class="w"> </span><span class="n">handle</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">path</span><span class="p">,</span><span class="w">  </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">z</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">w</span><span class="p">);</span>
<span class="linenos">107</span><span class="w">	</span><span class="kt">void</span><span class="w"> </span><span class="nf">write3DLattice_U8LE</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">path</span><span class="p">,</span><span class="w">  </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">z</span><span class="p">);</span>
<span class="linenos">108</span><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">appendToDataset</span><span class="p">(</span><span class="n">H5MetaData</span><span class="w"> </span><span class="o">*</span><span class="n">header</span><span class="p">,</span><span class="w"> </span><span class="n">byte</span><span class="w"> </span><span class="o">*</span><span class="n">data</span><span class="p">);</span>
<span class="linenos">109</span><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">makeNewDataset</span><span class="p">(</span><span class="n">H5MetaData</span><span class="w"> </span><span class="o">*</span><span class="n">header</span><span class="p">,</span><span class="w"> </span><span class="n">byte</span><span class="w"> </span><span class="o">*</span><span class="n">data</span><span class="p">);</span>
<span class="linenos">110</span><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">appendDsToGroup</span><span class="p">(</span><span class="n">H5MetaData</span><span class="w"> </span><span class="o">*</span><span class="n">header</span><span class="p">,</span><span class="w"> </span><span class="n">byte</span><span class="w"> </span><span class="o">*</span><span class="n">data</span><span class="p">);</span>
<span class="linenos">111</span><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">readDataset</span><span class="p">(</span><span class="n">H5Lookup</span><span class="w"> </span><span class="o">*</span><span class="n">req</span><span class="p">,</span><span class="w"> </span><span class="n">byte</span><span class="w"> </span><span class="o">*&amp;</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="o">&amp;</span><span class="n">sz</span><span class="p">);</span>
<span class="linenos">112</span><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">readAttr</span><span class="p">(</span><span class="n">H5Lookup</span><span class="w"> </span><span class="o">*</span><span class="n">req</span><span class="p">,</span><span class="w"> </span><span class="n">byte</span><span class="w"> </span><span class="o">*&amp;</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="o">&amp;</span><span class="n">sz</span><span class="p">);</span>
<span class="linenos">113</span><span class="w">    </span>
<span class="linenos">114</span><span class="w">    </span>
<span class="linenos">115</span><span class="c1">// Non static functions and variables</span>
<span class="linenos">116</span><span class="k">public</span><span class="o">:</span>
<span class="linenos">117</span><span class="w">    </span><span class="c1">/// @brief Create a SimulationFile with the specified filename</span>
<span class="linenos">118</span><span class="w">    </span><span class="n">SimulationFile</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">string</span><span class="w"> </span><span class="n">filename</span><span class="p">);</span>
<span class="linenos">119</span><span class="w">    </span><span class="c1">/// @brief Create a SimulationFile with the specified filename</span>
<span class="linenos">120</span><span class="w">    </span><span class="n">SimulationFile</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">filename</span><span class="p">);</span>
<span class="linenos">121</span><span class="w">    </span><span class="c1">/// @brief Destroy the SimulationFile</span>
<span class="linenos">122</span><span class="w">	</span><span class="k">virtual</span><span class="w"> </span><span class="o">~</span><span class="n">SimulationFile</span><span class="p">();</span>
<span class="linenos">123</span><span class="w">    </span>
<span class="linenos">124</span><span class="w">    </span><span class="c1">/// @brief Close the file</span>
<span class="linenos">125</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">close</span><span class="p">();</span>
<span class="linenos">126</span><span class="w">    </span><span class="c1">/// @brief Flush the current buffered data to the file</span>
<span class="linenos">127</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">flush</span><span class="p">();</span>
<span class="linenos">128</span><span class="w">    </span><span class="c1">/// @brief Create the current checkpoint to the HDF5 file</span>
<span class="linenos">129</span><span class="w">    </span><span class="c1">/// @param checkpointFilename Name of the new checkpoint file</span>
<span class="linenos">130</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="n">string</span><span class="w"> </span><span class="nf">checkpoint</span><span class="p">();</span>
<span class="linenos">131</span>
<span class="linenos">132</span><span class="w">    </span><span class="c1">// Methods for working with parameters.</span>
<span class="linenos">133</span><span class="w">    </span><span class="c1">/// @brief Get all the parameters from the current replicate</span>
<span class="linenos">134</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="n">map</span><span class="o">&lt;</span><span class="n">string</span><span class="p">,</span><span class="n">string</span><span class="o">&gt;</span><span class="w"> </span><span class="n">getParameters</span><span class="p">();</span>
<span class="linenos">135</span><span class="w">    </span><span class="c1">/// @brief Get the specified parameter from the current replicate</span>
<span class="linenos">136</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="n">string</span><span class="w"> </span><span class="n">getParameter</span><span class="p">(</span><span class="n">string</span><span class="w"> </span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">string</span><span class="w"> </span><span class="n">defaultValue</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">);</span>
<span class="linenos">137</span><span class="w">    </span><span class="c1">/// @brief Set the specified parameter to the value</span>
<span class="linenos">138</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setParameter</span><span class="p">(</span><span class="n">string</span><span class="w"> </span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">string</span><span class="w"> </span><span class="n">value</span><span class="p">);</span>
<span class="linenos">139</span>
<span class="linenos">140</span><span class="w">    </span><span class="c1">// Methods for working with the model.</span>
<span class="linenos">141</span><span class="w">    </span><span class="c1">/// @brief Pops the reaction model from the HDF5 file</span>
<span class="linenos">142</span><span class="w">    </span><span class="c1">/// @param reactionModel Memory at which to place the reactionModel</span>
<span class="linenos">143</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">getReactionModel</span><span class="p">(</span><span class="n">lm</span><span class="o">::</span><span class="n">io</span><span class="o">::</span><span class="n">ReactionModel</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">reactionModel</span><span class="p">);</span>
<span class="linenos">144</span><span class="w">    </span><span class="c1">/// @brief Pushes the reaction model into the HDF5 file</span>
<span class="linenos">145</span><span class="w">    </span><span class="c1">/// @param reactionModel Memory from which to place the reactionModel</span>
<span class="linenos">146</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setReactionModel</span><span class="p">(</span><span class="n">lm</span><span class="o">::</span><span class="n">io</span><span class="o">::</span><span class="n">ReactionModel</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">reactionModel</span><span class="p">);</span>
<span class="linenos">147</span><span class="w">    </span><span class="c1">/// @brief Pops the diffusion model from the HDF5 file</span>
<span class="linenos">148</span><span class="w">    </span><span class="c1">/// @param diffusionModel Memory at which to place the diffusionModel</span>
<span class="linenos">149</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">getDiffusionModel</span><span class="p">(</span><span class="n">lm</span><span class="o">::</span><span class="n">io</span><span class="o">::</span><span class="n">DiffusionModel</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">diffusionModel</span><span class="p">);</span>
<span class="linenos">150</span><span class="w">    </span><span class="c1">/// @brief Pops the diffusion lattice from the HDF5 file</span>
<span class="linenos">151</span><span class="w">    </span><span class="c1">/// @param diffusionModel Memoryfrom which to get the lattice</span>
<span class="linenos">152</span><span class="w">    </span><span class="c1">/// @param lattice Memory in which to place lattice</span>
<span class="linenos">153</span><span class="w">    </span><span class="c1">/// @param latticeMaxSize Total size of the lattice (i.e. number of bytes)</span>
<span class="linenos">154</span><span class="w">    </span><span class="c1">/// @param latticeSites Actual lattice site data in byte format</span>
<span class="linenos">155</span><span class="w">    </span><span class="c1">/// @param latticeSitesMaxSize Max size of a lattice site (i.e. number of particles it can contain)</span>
<span class="linenos">156</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">getDiffusionModelLattice</span><span class="p">(</span><span class="n">lm</span><span class="o">::</span><span class="n">io</span><span class="o">::</span><span class="n">DiffusionModel</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">diffusionModel</span><span class="p">,</span><span class="w"> </span><span class="n">byte</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">lattice</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">latticeMaxSize</span><span class="p">,</span><span class="w"> </span><span class="n">byte</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">latticeSites</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">latticeSitesMaxSize</span><span class="p">);</span>
<span class="linenos">157</span><span class="w">    </span><span class="c1">/// @brief Pops the diffusion lattice from the HDF5 file</span>
<span class="linenos">158</span><span class="w">    </span><span class="c1">/// @param diffusionModel Memoryfrom which to get the lattice</span>
<span class="linenos">159</span><span class="w">    </span><span class="c1">/// @param lattice Memory at which to place the lattice</span>
<span class="linenos">160</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">getDiffusionModelLattice</span><span class="p">(</span><span class="n">lm</span><span class="o">::</span><span class="n">io</span><span class="o">::</span><span class="n">DiffusionModel</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">diffusionModel</span><span class="p">,</span><span class="w"> </span><span class="n">lm</span><span class="o">::</span><span class="n">rdme</span><span class="o">::</span><span class="n">Lattice</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">lattice</span><span class="p">);</span>
<span class="linenos">161</span><span class="w">    </span><span class="c1">/// @brief Pushes the diffusion model into the HDF5 file</span>
<span class="linenos">162</span><span class="w">    </span><span class="c1">/// @param diffusionModel Memory from which to place the diffusionModel</span>
<span class="linenos">163</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setDiffusionModel</span><span class="p">(</span><span class="n">lm</span><span class="o">::</span><span class="n">io</span><span class="o">::</span><span class="n">DiffusionModel</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">diffusionModel</span><span class="p">);</span>
<span class="linenos">164</span>
<span class="linenos">165</span><span class="w">    </span><span class="c1">/// @brief Pushes the diffusion lattice into the HDF5 file</span>
<span class="linenos">166</span><span class="w">    </span><span class="c1">/// @param diffusionModel Memoryfrom which to get the lattice</span>
<span class="linenos">167</span><span class="w">    </span><span class="c1">/// @param lattice Memory from which to place the lattice - uint8_t particle lattice</span>
<span class="linenos">168</span><span class="w">    </span><span class="c1">/// @param latticeSites Memory from which to place lattice contents</span>
<span class="linenos">169</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setDiffusionModelLattice</span><span class="p">(</span><span class="n">lm</span><span class="o">::</span><span class="n">io</span><span class="o">::</span><span class="n">DiffusionModel</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">lattice</span><span class="p">,</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">latticeSites</span><span class="p">);</span>
<span class="linenos">170</span>
<span class="linenos">171</span><span class="w">    </span><span class="c1">/// @brief Pushes the diffusion lattice into the HDF5 file</span>
<span class="linenos">172</span><span class="w">    </span><span class="c1">/// @param diffusionModel Memoryfrom which to get the lattice</span>
<span class="linenos">173</span><span class="w">    </span><span class="c1">/// @param lattice Memory from which to place the lattice - uint32_t particle lattice</span>
<span class="linenos">174</span><span class="w">    </span><span class="c1">/// @param latticeSites Memory from which to place lattice contents</span>
<span class="linenos">175</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setDiffusionModelLattice</span><span class="p">(</span><span class="n">lm</span><span class="o">::</span><span class="n">io</span><span class="o">::</span><span class="n">DiffusionModel</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">lattice</span><span class="p">,</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">latticeSites</span><span class="p">);</span>
<span class="linenos">176</span>
<span class="linenos">177</span><span class="w">    </span><span class="c1">/// @brief Pushes the diffusion lattice into the HDF5 file</span>
<span class="linenos">178</span><span class="w">    </span><span class="c1">/// @param diffusionModel Memory from which to get the lattice</span>
<span class="linenos">179</span><span class="w">    </span><span class="c1">/// @param lattice Memory from which to place the lattice</span>
<span class="linenos">180</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setDiffusionModelLattice</span><span class="p">(</span><span class="n">lm</span><span class="o">::</span><span class="n">io</span><span class="o">::</span><span class="n">DiffusionModel</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="n">lm</span><span class="o">::</span><span class="n">rdme</span><span class="o">::</span><span class="n">ByteLattice</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">lattice</span><span class="p">);</span>
<span class="linenos">181</span>
<span class="linenos">182</span><span class="w">    </span><span class="c1">/// @brief Pushes the diffusion lattice into the HDF5 file</span>
<span class="linenos">183</span><span class="w">    </span><span class="c1">/// @param diffusionModel Memory from which to get the lattice</span>
<span class="linenos">184</span><span class="w">    </span><span class="c1">/// @param lattice Memory from which to place the lattice</span>
<span class="linenos">185</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setDiffusionModelLattice</span><span class="p">(</span><span class="n">lm</span><span class="o">::</span><span class="n">io</span><span class="o">::</span><span class="n">DiffusionModel</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="n">lm</span><span class="o">::</span><span class="n">rdme</span><span class="o">::</span><span class="n">IntLattice</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">lattice</span><span class="p">);</span>
<span class="linenos">186</span>
<span class="linenos">187</span><span class="w">    </span><span class="c1">/// @brief Pushes the spacial model (i.e. obstacles) into the HDF5 file</span>
<span class="linenos">188</span><span class="w">    </span><span class="c1">/// @param model The model object</span>
<span class="linenos">189</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setSpatialModel</span><span class="p">(</span><span class="n">lm</span><span class="o">::</span><span class="n">io</span><span class="o">::</span><span class="n">SpatialModel</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">model</span><span class="p">);</span>
<span class="linenos">190</span><span class="w">    </span><span class="c1">/// @brief Pops the spacial model (i.e. obstacles) from the HDF5 file</span>
<span class="linenos">191</span><span class="w">    </span><span class="c1">/// @param model The model in which to store the object</span>
<span class="linenos">192</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">getSpatialModel</span><span class="p">(</span><span class="n">lm</span><span class="o">::</span><span class="n">io</span><span class="o">::</span><span class="n">SpatialModel</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">model</span><span class="p">);</span>
<span class="linenos">193</span>
<span class="linenos">194</span>
<span class="linenos">195</span><span class="w">    </span><span class="c1">// Methods for working with a replicate.</span>
<span class="linenos">196</span><span class="w">    </span><span class="c1">/// @brief Checks if the specified replicate exists</span>
<span class="linenos">197</span><span class="w">    </span><span class="c1">/// @param replicate Replicate number</span>
<span class="linenos">198</span><span class="w">    </span><span class="c1">/// @return true/false</span>
<span class="linenos">199</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="nf">replicateExists</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">replicate</span><span class="p">);</span>
<span class="linenos">200</span><span class="w">    </span><span class="c1">/// @brief Opens the specified replicate for reading</span>
<span class="linenos">201</span><span class="w">    </span><span class="c1">/// @param replicate Replicate number</span>
<span class="linenos">202</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">openReplicate</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">replicate</span><span class="p">);</span>
<span class="linenos">203</span><span class="w">    </span><span class="c1">/// @brief Appends the species counts in the various sites into the replicate</span>
<span class="linenos">204</span><span class="w">    </span><span class="c1">/// @param replicate Replicate number</span>
<span class="linenos">205</span><span class="w">    </span><span class="c1">/// @param speciesCounts Protocol buffers object with species counts in lattice</span>
<span class="linenos">206</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">appendSpeciesCounts</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">replicate</span><span class="p">,</span><span class="w"> </span><span class="n">lm</span><span class="o">::</span><span class="n">io</span><span class="o">::</span><span class="n">SpeciesCounts</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">speciesCounts</span><span class="p">);</span>
<span class="linenos">207</span><span class="w">    </span><span class="c1">/// @brief Appends the lattice to the current replicate</span>
<span class="linenos">208</span><span class="w">    </span><span class="c1">/// @param replicate Replicate number</span>
<span class="linenos">209</span><span class="w">    </span><span class="c1">/// @param lattice Lattice to add to replicate</span>
<span class="linenos">210</span><span class="w">    </span><span class="c1">/// @param latticeData The actual data of the lattice</span>
<span class="linenos">211</span><span class="w">    </span><span class="c1">/// @param latticeDataSize The size of the lattice</span>
<span class="linenos">212</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">appendLattice</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">replicate</span><span class="p">,</span><span class="w"> </span><span class="n">lm</span><span class="o">::</span><span class="n">io</span><span class="o">::</span><span class="n">Lattice</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">lattice</span><span class="p">,</span><span class="w"> </span><span class="n">byte</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">latticeData</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">latticeDataSize</span><span class="p">);</span>
<span class="linenos">213</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">appendLattice_U32LE</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">replicate</span><span class="p">,</span><span class="w"> </span><span class="n">lm</span><span class="o">::</span><span class="n">io</span><span class="o">::</span><span class="n">Lattice</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">lattice</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">latticeData</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">latticeDataSize</span><span class="p">);</span>
<span class="linenos">214</span>
<span class="linenos">215</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">arbitraryH5</span><span class="p">(</span><span class="n">byte</span><span class="w"> </span><span class="o">*</span><span class="n">ptr</span><span class="p">);</span>
<span class="linenos">216</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">arbitraryH5Lookup</span><span class="p">(</span><span class="n">byte</span><span class="w"> </span><span class="o">*</span><span class="n">in</span><span class="p">,</span><span class="w"> </span><span class="n">byte</span><span class="w"> </span><span class="o">*&amp;</span><span class="n">out</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="o">&amp;</span><span class="n">out_sz</span><span class="p">);</span>
<span class="linenos">217</span><span class="w">	</span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">appendSites</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">replicate</span><span class="p">,</span><span class="w"> </span><span class="n">lm</span><span class="o">::</span><span class="n">io</span><span class="o">::</span><span class="n">Lattice</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">lattice</span><span class="p">,</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">siteData</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">siteDataSize</span><span class="p">);</span>
<span class="linenos">218</span><span class="w">    </span><span class="c1">/// @brief Adds all the parameter values to the replicate</span>
<span class="linenos">219</span><span class="w">    </span><span class="c1">/// @param replicate Replicate number</span>
<span class="linenos">220</span><span class="w">    </span><span class="c1">/// @param parameterValues Actual values to store</span>
<span class="linenos">221</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">appendParameterValues</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">replicate</span><span class="p">,</span><span class="w"> </span><span class="n">lm</span><span class="o">::</span><span class="n">io</span><span class="o">::</span><span class="n">ParameterValues</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">parameterValues</span><span class="p">);</span>
<span class="linenos">222</span><span class="w">    </span><span class="c1">/// @brief Adds all the first passage times to the replicate</span>
<span class="linenos">223</span><span class="w">    </span><span class="c1">/// @param replicate Replicate number</span>
<span class="linenos">224</span><span class="w">    </span><span class="c1">/// @param speciesCounts Actual passage times to store</span>
<span class="linenos">225</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setFirstPassageTimes</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">replicate</span><span class="p">,</span><span class="w"> </span><span class="n">lm</span><span class="o">::</span><span class="n">io</span><span class="o">::</span><span class="n">FirstPassageTimes</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">speciesCounts</span><span class="p">);</span>
<span class="linenos">226</span><span class="w">    </span><span class="c1">/// @brief Get the timestep times for the replicate</span>
<span class="linenos">227</span><span class="w">    </span><span class="c1">/// @param replicate Replicate number</span>
<span class="linenos">228</span><span class="w">    </span><span class="c1">/// @return A set of timestep times</span>
<span class="linenos">229</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="w"> </span><span class="n">getLatticeTimes</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">replicate</span><span class="p">);</span>
<span class="linenos">230</span><span class="w">    </span><span class="c1">/// @brief Get the lattice for the replicate</span>
<span class="linenos">231</span><span class="w">    </span><span class="c1">/// @param replicate Replicate number</span>
<span class="linenos">232</span><span class="w">    </span><span class="c1">/// @param latticeIndex Seems to be unused...</span>
<span class="linenos">233</span><span class="w">    </span><span class="c1">/// @param lattice The lattice object in which to store the data</span>
<span class="linenos">234</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">getLattice</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">replicate</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeIndex</span><span class="p">,</span><span class="w"> </span><span class="n">lm</span><span class="o">::</span><span class="n">rdme</span><span class="o">::</span><span class="n">Lattice</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">lattice</span><span class="p">);</span>
<span class="linenos">235</span><span class="w">    </span><span class="c1">/// @brief Close the specified replicate</span>
<span class="linenos">236</span><span class="w">    </span><span class="c1">/// @param replicate Replicate number</span>
<span class="linenos">237</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">closeReplicate</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">replicate</span><span class="p">);</span>
<span class="linenos">238</span><span class="w">    </span><span class="c1">/// @brief Close all the replicates</span>
<span class="linenos">239</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">closeAllReplicates</span><span class="p">();</span>
<span class="linenos">240</span>
<span class="linenos">241</span><span class="w">    </span><span class="c1">//virtual void appendSpatialModelObjects(unsigned int replicate, lm::io::SpatialModel * model);</span>
<span class="linenos">242</span><span class="w">    </span><span class="c1">//virtual void getSpatialModelObjects(unsigned int replicate, lm::io::SpatialModel * model);</span>
<span class="linenos">243</span>
<span class="linenos">244</span><span class="w">	</span><span class="cm">/*</span>
<span class="linenos">245</span><span class="cm">    virtual lattice_coord_t getLatticeSize() const;</span>
<span class="linenos">246</span><span class="cm">	virtual nmdist_t getLatticeSpacing() const;</span>
<span class="linenos">247</span><span class="cm">	virtual uint getMaxParticlesPerSite() const;</span>
<span class="linenos">248</span><span class="cm">	virtual lattice_particle_t getMaxParticleType() const;</span>
<span class="linenos">249</span><span class="cm">	virtual lattice_site_t getMaxSiteType() const;</span>
<span class="linenos">250</span><span class="cm">	virtual const std::map&lt;uint64,uint64&gt; getMaxParticleCounts() const;</span>
<span class="linenos">251</span><span class="cm">	virtual const std::map&lt;uint64,uint64&gt; getMaxSiteCounts() const;</span>
<span class="linenos">252</span><span class="cm">	</span>
<span class="linenos">253</span><span class="cm">	virtual uint64 getNumberFrames() const;	</span>
<span class="linenos">254</span><span class="cm">	virtual const std::vector&lt;nstime_t&gt; getFrameTimes() const;</span>
<span class="linenos">255</span><span class="cm">	virtual void loadFrame(uint64 frameIndex, Lattice* lattice, nstime_t* time=NULL) const;</span>
<span class="linenos">256</span><span class="cm">	</span>
<span class="linenos">257</span><span class="cm">	virtual uint64 getNumberLatticeConfigurations() const;</span>
<span class="linenos">258</span><span class="cm">	virtual const std::vector&lt;nstime_t&gt; getLatticeConfigurationTimes() const;</span>
<span class="linenos">259</span><span class="cm">	virtual void loadLatticeConfiguration(uint64 latticeIndex, Lattice* lattice, nstime_t* time=NULL) const;</span>
<span class="linenos">260</span><span class="cm">    */</span>
<span class="linenos">261</span>
<span class="linenos">262</span><span class="w">	</span><span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="kt">uint32_t</span><span class="p">,</span><span class="w"> </span><span class="n">uint</span><span class="o">&gt;</span><span class="w"> </span><span class="n">getParticleCounts</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">replicate</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeIndex</span><span class="p">);</span>
<span class="linenos">263</span><span class="w">	</span><span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="kt">double</span><span class="p">,</span><span class="w"> </span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">getSpeciesCounts</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">replicate</span><span class="p">);</span>
<span class="linenos">264</span><span class="w">	</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="w"> </span><span class="n">getSpeciesCountTimes</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">replicate</span><span class="p">);</span>
<span class="linenos">265</span><span class="w">	</span><span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">uint</span><span class="p">,</span><span class="w"> </span><span class="n">string</span><span class="o">&gt;</span><span class="w"> </span><span class="n">getSpeciesNames</span><span class="p">();</span>
<span class="linenos">266</span><span class="w">	</span><span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">uint</span><span class="p">,</span><span class="w"> </span><span class="n">string</span><span class="o">&gt;</span><span class="w"> </span><span class="n">getSiteTypeNames</span><span class="p">();</span>
<span class="linenos">267</span>
<span class="linenos">268</span><span class="w">	</span>
<span class="linenos">269</span><span class="k">public</span><span class="o">:</span>
<span class="linenos">270</span>
<span class="linenos">271</span><span class="w">    </span><span class="c1">/// @struct ReplicateHandles</span>
<span class="linenos">272</span><span class="w">    </span><span class="c1">/// @brief A handle for the different replicates that may be stored in the HDF5 file</span>
<span class="linenos">273</span><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">ReplicateHandles</span>
<span class="linenos">274</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">275</span><span class="w">        </span><span class="n">hid_t</span><span class="w"> </span><span class="n">group</span><span class="p">;</span><span class="w">                    </span><span class="c1">// ID of the group of replicates</span>
<span class="linenos">276</span><span class="w">        </span><span class="n">hid_t</span><span class="w"> </span><span class="n">speciesCountsDataset</span><span class="p">;</span><span class="w">     </span><span class="c1">// ?</span>
<span class="linenos">277</span><span class="w">        </span><span class="n">hid_t</span><span class="w"> </span><span class="n">speciesCountTimesDataset</span><span class="p">;</span><span class="w"> </span><span class="c1">// ?</span>
<span class="linenos">278</span><span class="w">        </span>
<span class="linenos">279</span><span class="w">        </span><span class="c1">/// @brief Set up the ReplicateHandles</span>
<span class="linenos">280</span><span class="w">        </span><span class="n">ReplicateHandles</span><span class="p">()</span><span class="o">:</span><span class="n">group</span><span class="p">(</span><span class="n">H5I_INVALID_HID</span><span class="p">),</span><span class="n">speciesCountsDataset</span><span class="p">(</span><span class="n">H5I_INVALID_HID</span><span class="p">),</span><span class="n">speciesCountTimesDataset</span><span class="p">(</span><span class="n">H5I_INVALID_HID</span><span class="p">)</span><span class="w"> </span><span class="p">{}</span>
<span class="linenos">281</span><span class="w">    </span><span class="p">};</span>
<span class="linenos">282</span>
<span class="linenos">283</span><span class="w">	</span>
<span class="linenos">284</span><span class="k">protected</span><span class="o">:</span>
<span class="linenos">285</span><span class="w">    </span><span class="c1">// Protected functions</span>
<span class="linenos">286</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">open</span><span class="p">();</span>
<span class="linenos">287</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">openGroups</span><span class="p">();</span>
<span class="linenos">288</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">loadParameters</span><span class="p">();</span>
<span class="linenos">289</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">loadModel</span><span class="p">();</span>
<span class="linenos">290</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="n">ReplicateHandles</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">openReplicateHandles</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">replicate</span><span class="p">);</span>
<span class="linenos">291</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="n">ReplicateHandles</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">createReplicateHandles</span><span class="p">(</span><span class="n">string</span><span class="w"> </span><span class="n">replicateString</span><span class="p">);</span>
<span class="linenos">292</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">closeReplicateHandles</span><span class="p">(</span><span class="n">ReplicateHandles</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">handles</span><span class="p">);</span>
<span class="linenos">293</span><span class="w">	</span>
<span class="linenos">294</span><span class="k">protected</span><span class="o">:</span>
<span class="linenos">295</span><span class="w">    </span><span class="n">string</span><span class="w">          </span><span class="n">filename</span><span class="p">;</span><span class="w">       </span><span class="c1">// HDF5 file name</span>
<span class="linenos">296</span><span class="w">    </span><span class="n">hid_t</span><span class="w">           </span><span class="n">file</span><span class="p">;</span><span class="w">           </span><span class="c1">// file handle</span>
<span class="linenos">297</span><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w">    </span><span class="n">version</span><span class="p">;</span><span class="w">        </span><span class="c1">// HDF5 file version</span>
<span class="linenos">298</span>
<span class="linenos">299</span><span class="w">    </span><span class="c1">// Main group handles.</span>
<span class="linenos">300</span><span class="w">    </span><span class="n">hid_t</span><span class="w">           </span><span class="n">parametersGroup</span><span class="p">,</span><span class="w"> </span><span class="n">modelGroup</span><span class="p">,</span><span class="w"> </span><span class="n">simulationsGroup</span><span class="p">;</span>
<span class="linenos">301</span>
<span class="linenos">302</span><span class="w">    </span><span class="c1">// The parameters.</span>
<span class="linenos">303</span><span class="w">    </span><span class="n">map</span><span class="o">&lt;</span><span class="n">string</span><span class="p">,</span><span class="n">string</span><span class="o">&gt;</span><span class="w"> </span><span class="n">parameterMap</span><span class="p">;</span>
<span class="linenos">304</span>
<span class="linenos">305</span><span class="w">    </span><span class="c1">// The model.</span>
<span class="linenos">306</span><span class="w">    </span><span class="kt">bool</span><span class="w">            </span><span class="n">modelLoaded</span><span class="p">;</span>
<span class="linenos">307</span><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w">    </span><span class="n">numberSpecies</span><span class="p">;</span>
<span class="linenos">308</span>
<span class="linenos">309</span><span class="w">    </span><span class="c1">// Handles for each replicate that is open.</span>
<span class="linenos">310</span><span class="w">    </span><span class="n">map</span><span class="o">&lt;</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="p">,</span><span class="n">ReplicateHandles</span><span class="w"> </span><span class="o">*&gt;</span><span class="w"> </span><span class="n">openReplicates</span><span class="p">;</span>
<span class="linenos">311</span>
<span class="linenos">312</span><span class="p">};</span>
<span class="linenos">313</span>
<span class="linenos">314</span><span class="p">}</span>
<span class="linenos">315</span><span class="p">}</span>
<span class="linenos">316</span><span class="p">}</span>
<span class="linenos">317</span>
<span class="linenos">318</span><span class="cp">#endif</span>
</pre></div>
</div>
</section>
<section id="simulationfile-cpp">
<h3>SimulationFile.cpp<a class="headerlink" href="#simulationfile-cpp" title="Link to this heading">#</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="linenos">   1</span><span class="cm">/*</span>
<span class="linenos">   2</span><span class="cm"> * University of Illinois Open Source License</span>
<span class="linenos">   3</span><span class="cm"> * Copyright 2010-2018 Luthey-Schulten Group,</span>
<span class="linenos">   4</span><span class="cm"> * All rights reserved.</span>
<span class="linenos">   5</span><span class="cm"> * </span>
<span class="linenos">   6</span><span class="cm"> * Developed by: Luthey-Schulten Group</span>
<span class="linenos">   7</span><span class="cm"> * 			     University of Illinois at Urbana-Champaign</span>
<span class="linenos">   8</span><span class="cm"> * 			     http://www.scs.uiuc.edu/~schulten</span>
<span class="linenos">   9</span><span class="cm"> * </span>
<span class="linenos">  10</span><span class="cm"> * Permission is hereby granted, free of charge, to any person obtaining a copy of</span>
<span class="linenos">  11</span><span class="cm"> * this software and associated documentation files (the Software), to deal with </span>
<span class="linenos">  12</span><span class="cm"> * the Software without restriction, including without limitation the rights to </span>
<span class="linenos">  13</span><span class="cm"> * use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies </span>
<span class="linenos">  14</span><span class="cm"> * of the Software, and to permit persons to whom the Software is furnished to </span>
<span class="linenos">  15</span><span class="cm"> * do so, subject to the following conditions:</span>
<span class="linenos">  16</span><span class="cm"> * </span>
<span class="linenos">  17</span><span class="cm"> * - Redistributions of source code must retain the above copyright notice, </span>
<span class="linenos">  18</span><span class="cm"> * this list of conditions and the following disclaimers.</span>
<span class="linenos">  19</span><span class="cm"> * </span>
<span class="linenos">  20</span><span class="cm"> * - Redistributions in binary form must reproduce the above copyright notice, </span>
<span class="linenos">  21</span><span class="cm"> * this list of conditions and the following disclaimers in the documentation </span>
<span class="linenos">  22</span><span class="cm"> * and/or other materials provided with the distribution.</span>
<span class="linenos">  23</span><span class="cm"> * </span>
<span class="linenos">  24</span><span class="cm"> * - Neither the names of the Luthey-Schulten Group, University of Illinois at</span>
<span class="linenos">  25</span><span class="cm"> * Urbana-Champaign, nor the names of its contributors may be used to endorse or</span>
<span class="linenos">  26</span><span class="cm"> * promote products derived from this Software without specific prior written</span>
<span class="linenos">  27</span><span class="cm"> * permission.</span>
<span class="linenos">  28</span><span class="cm"> * </span>
<span class="linenos">  29</span><span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR </span>
<span class="linenos">  30</span><span class="cm"> * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, </span>
<span class="linenos">  31</span><span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL </span>
<span class="linenos">  32</span><span class="cm"> * THE CONTRIBUTORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR </span>
<span class="linenos">  33</span><span class="cm"> * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, </span>
<span class="linenos">  34</span><span class="cm"> * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR </span>
<span class="linenos">  35</span><span class="cm"> * OTHER DEALINGS WITH THE SOFTWARE.</span>
<span class="linenos">  36</span><span class="cm"> *</span>
<span class="linenos">  37</span><span class="cm"> * Author(s): Elijah Roberts</span>
<span class="linenos">  38</span><span class="cm"> */</span>
<span class="linenos">  39</span>
<span class="linenos">  40</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;cstdio&gt;</span>
<span class="linenos">  41</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;cstring&gt;</span>
<span class="linenos">  42</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;string&gt;</span>
<span class="linenos">  43</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;sstream&gt;</span>
<span class="linenos">  44</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;map&gt;</span>
<span class="linenos">  45</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;list&gt;</span>
<span class="linenos">  46</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;vector&gt;</span>
<span class="linenos">  47</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;sys/stat.h&gt;</span>
<span class="linenos">  48</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;config.h&quot;</span>
<span class="linenos">  49</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;core/Exceptions.h&quot;</span>
<span class="linenos">  50</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;core/Math.h&quot;</span>
<span class="linenos">  51</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;core/Print.h&quot;</span>
<span class="linenos">  52</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;io/ArbitraryH5.h&quot;</span>
<span class="linenos">  53</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;DiffusionModel.pb.h&quot;</span>
<span class="linenos">  54</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;FirstPassageTimes.pb.h&quot;</span>
<span class="linenos">  55</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;Lattice.pb.h&quot;</span>
<span class="linenos">  56</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;ParameterValues.pb.h&quot;</span>
<span class="linenos">  57</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;ReactionModel.pb.h&quot;</span>
<span class="linenos">  58</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;SpatialModel.pb.h&quot;</span>
<span class="linenos">  59</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;SpeciesCounts.pb.h&quot;</span>
<span class="linenos">  60</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;io/lm_hdf5.h&quot;</span>
<span class="linenos">  61</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;io/SimulationFile.h&quot;</span>
<span class="linenos">  62</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;rdme/Lattice.h&quot;</span>
<span class="linenos">  63</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;rdme/ByteLattice.h&quot;</span>
<span class="linenos">  64</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;rdme/IntLattice.h&quot;</span>
<span class="linenos">  65</span>
<span class="linenos">  66</span><span class="k">using</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">list</span><span class="p">;</span>
<span class="linenos">  67</span><span class="k">using</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="p">;</span>
<span class="linenos">  68</span><span class="k">using</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">;</span>
<span class="linenos">  69</span><span class="k">using</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="p">;</span>
<span class="linenos">  70</span><span class="k">using</span><span class="w"> </span><span class="n">lm</span><span class="o">::</span><span class="n">IOException</span><span class="p">;</span>
<span class="linenos">  71</span>
<span class="linenos">  72</span><span class="k">namespace</span><span class="w"> </span><span class="nn">lm</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">  73</span><span class="k">namespace</span><span class="w"> </span><span class="nn">io</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">  74</span><span class="k">namespace</span><span class="w"> </span><span class="nn">hdf5</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">  75</span>
<span class="linenos">  76</span><span class="k">const</span><span class="w"> </span><span class="n">uint</span><span class="w"> </span><span class="n">SimulationFile</span><span class="o">::</span><span class="n">MIN_VERSION</span><span class="w">                   </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<span class="linenos">  77</span><span class="k">const</span><span class="w"> </span><span class="n">uint</span><span class="w"> </span><span class="n">SimulationFile</span><span class="o">::</span><span class="n">CURRENT_VERSION</span><span class="w">               </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span>
<span class="linenos">  78</span><span class="k">const</span><span class="w"> </span><span class="n">uint</span><span class="w"> </span><span class="n">SimulationFile</span><span class="o">::</span><span class="n">MAX_REACTION_RATE_CONSTANTS</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span>
<span class="linenos">  79</span><span class="k">const</span><span class="w"> </span><span class="n">uint</span><span class="w"> </span><span class="n">SimulationFile</span><span class="o">::</span><span class="n">MAX_SHAPE_PARAMETERS</span><span class="w">		     </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span>
<span class="linenos">  80</span>
<span class="linenos">  81</span>
<span class="linenos">  82</span><span class="n">SimulationFile</span><span class="o">::</span><span class="n">SimulationFile</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">string</span><span class="w"> </span><span class="n">filename</span><span class="p">)</span>
<span class="linenos">  83</span><span class="o">:</span><span class="n">filename</span><span class="p">(</span><span class="n">filename</span><span class="p">),</span><span class="n">file</span><span class="p">(</span><span class="n">H5I_INVALID_HID</span><span class="p">),</span><span class="n">version</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="n">parametersGroup</span><span class="p">(</span><span class="n">H5I_INVALID_HID</span><span class="p">),</span><span class="n">modelGroup</span><span class="p">(</span><span class="n">H5I_INVALID_HID</span><span class="p">),</span><span class="n">simulationsGroup</span><span class="p">(</span><span class="n">H5I_INVALID_HID</span><span class="p">),</span><span class="n">modelLoaded</span><span class="p">(</span><span class="nb">false</span><span class="p">),</span><span class="n">numberSpecies</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">  84</span><span class="p">{</span>
<span class="linenos">  85</span><span class="w">	</span><span class="n">open</span><span class="p">();</span>
<span class="linenos">  86</span><span class="p">}</span>
<span class="linenos">  87</span>
<span class="linenos">  88</span><span class="n">SimulationFile</span><span class="o">::</span><span class="n">SimulationFile</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">filename</span><span class="p">)</span>
<span class="linenos">  89</span><span class="o">:</span><span class="n">filename</span><span class="p">(</span><span class="n">filename</span><span class="p">),</span><span class="n">file</span><span class="p">(</span><span class="n">H5I_INVALID_HID</span><span class="p">),</span><span class="n">version</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="n">parametersGroup</span><span class="p">(</span><span class="n">H5I_INVALID_HID</span><span class="p">),</span><span class="n">modelGroup</span><span class="p">(</span><span class="n">H5I_INVALID_HID</span><span class="p">),</span><span class="n">simulationsGroup</span><span class="p">(</span><span class="n">H5I_INVALID_HID</span><span class="p">),</span><span class="n">modelLoaded</span><span class="p">(</span><span class="nb">false</span><span class="p">),</span><span class="n">numberSpecies</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">  90</span><span class="p">{</span>
<span class="linenos">  91</span><span class="w">	</span><span class="n">open</span><span class="p">();</span>
<span class="linenos">  92</span><span class="p">}</span>
<span class="linenos">  93</span>
<span class="linenos">  94</span><span class="kt">void</span><span class="w"> </span><span class="n">SimulationFile</span><span class="o">::</span><span class="n">open</span><span class="p">()</span>
<span class="linenos">  95</span><span class="p">{</span>
<span class="linenos">  96</span><span class="w">    </span><span class="c1">// Make sure gzip is supported.</span>
<span class="linenos">  97</span><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">filter_info</span><span class="p">;</span>
<span class="linenos">  98</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">H5Zfilter_avail</span><span class="p">(</span><span class="n">H5Z_FILTER_DEFLATE</span><span class="p">))</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="n">lm</span><span class="o">::</span><span class="n">Exception</span><span class="p">(</span><span class="s">&quot;The HDF5 library does not support gzip compression.&quot;</span><span class="p">);</span>
<span class="linenos">  99</span><span class="w">    </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Zget_filter_info</span><span class="w"> </span><span class="p">(</span><span class="n">H5Z_FILTER_DEFLATE</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">filter_info</span><span class="p">));</span>
<span class="linenos"> 100</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">filter_info</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">H5Z_FILTER_CONFIG_ENCODE_ENABLED</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="p">(</span><span class="n">filter_info</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">H5Z_FILTER_CONFIG_DECODE_ENABLED</span><span class="p">))</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="n">lm</span><span class="o">::</span><span class="n">Exception</span><span class="p">(</span><span class="s">&quot;The HDF5 library does not support gzip filtering for both encoding and decoding.&quot;</span><span class="p">);</span>
<span class="linenos"> 101</span>
<span class="linenos"> 102</span><span class="w">    </span><span class="c1">// Turn of error printing.</span>
<span class="linenos"> 103</span><span class="w">    </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Eset_auto2</span><span class="p">(</span><span class="n">H5E_DEFAULT</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">));</span>
<span class="linenos"> 104</span>
<span class="linenos"> 105</span><span class="w">    </span><span class="c1">// Make sure the file exists.</span>
<span class="linenos"> 106</span><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">stat</span><span class="w"> </span><span class="n">fileStats</span><span class="p">;</span>
<span class="linenos"> 107</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">stat</span><span class="p">(</span><span class="n">filename</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span><span class="w"> </span><span class="o">&amp;</span><span class="n">fileStats</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="n">lm</span><span class="o">::</span><span class="n">IOException</span><span class="p">(</span><span class="s">&quot;the specified file did not exist&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">filename</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
<span class="linenos"> 108</span>
<span class="linenos"> 109</span><span class="w">    </span><span class="c1">// Make sure it is a regular file.</span>
<span class="linenos"> 110</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">S_ISREG</span><span class="p">(</span><span class="n">fileStats</span><span class="p">.</span><span class="n">st_mode</span><span class="p">))</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="n">lm</span><span class="o">::</span><span class="n">IOException</span><span class="p">(</span><span class="s">&quot;the specified file was not a regular file&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">filename</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
<span class="linenos"> 111</span>
<span class="linenos"> 112</span><span class="w">    </span><span class="c1">// Make sure the file has the correct magic and hdf headers.</span>
<span class="linenos"> 113</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">isValidFile</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="n">lm</span><span class="o">::</span><span class="n">IOException</span><span class="p">(</span><span class="s">&quot;the specified file was not of the correct format&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">filename</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
<span class="linenos"> 114</span>
<span class="linenos"> 115</span><span class="w">    </span><span class="c1">// Open the file.</span>
<span class="linenos"> 116</span><span class="w">    </span><span class="n">HDF5_EXCEPTION_CALL</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="n">H5Fopen</span><span class="p">(</span><span class="n">filename</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span><span class="w"> </span><span class="n">H5F_ACC_RDWR</span><span class="p">,</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">));</span>
<span class="linenos"> 117</span>
<span class="linenos"> 118</span><span class="w">    </span><span class="c1">// Get the size of the user block.</span>
<span class="linenos"> 119</span><span class="w">    </span><span class="n">hid_t</span><span class="w"> </span><span class="n">creationProperties</span><span class="p">;</span>
<span class="linenos"> 120</span><span class="w">    </span><span class="n">hsize_t</span><span class="w"> </span><span class="n">userblockSize</span><span class="p">;</span>
<span class="linenos"> 121</span><span class="w">    </span><span class="n">HDF5_EXCEPTION_CALL</span><span class="p">(</span><span class="n">creationProperties</span><span class="p">,</span><span class="n">H5Fget_create_plist</span><span class="p">(</span><span class="n">file</span><span class="p">));</span>
<span class="linenos"> 122</span><span class="w">    </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Pget_userblock</span><span class="p">(</span><span class="n">creationProperties</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">userblockSize</span><span class="p">));</span>
<span class="linenos"> 123</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">userblockSize</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="n">lm</span><span class="o">::</span><span class="n">IOException</span><span class="p">(</span><span class="s">&quot;the specified file did not have the correct user block size&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">userblockSize</span><span class="p">);</span>
<span class="linenos"> 124</span>
<span class="linenos"> 125</span><span class="w">    </span><span class="c1">// Make sure the version is supported.</span>
<span class="linenos"> 126</span><span class="w">    </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5LTget_attribute_uint</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;formatVersion&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">version</span><span class="p">));</span>
<span class="linenos"> 127</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">version</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">MIN_VERSION</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">version</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">CURRENT_VERSION</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="n">lm</span><span class="o">::</span><span class="n">IOException</span><span class="p">(</span><span class="s">&quot;the specified file format version is not supported&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">version</span><span class="p">);</span>
<span class="linenos"> 128</span>
<span class="linenos"> 129</span><span class="w">    </span><span class="c1">// Open the groups.</span>
<span class="linenos"> 130</span><span class="w">    </span><span class="n">openGroups</span><span class="p">();</span>
<span class="linenos"> 131</span>
<span class="linenos"> 132</span><span class="w">    </span><span class="c1">// Loaded the parameters.</span>
<span class="linenos"> 133</span><span class="w">    </span><span class="n">loadParameters</span><span class="p">();</span>
<span class="linenos"> 134</span><span class="p">}</span>
<span class="linenos"> 135</span>
<span class="linenos"> 136</span><span class="kt">void</span><span class="w"> </span><span class="n">SimulationFile</span><span class="o">::</span><span class="n">openGroups</span><span class="p">()</span>
<span class="linenos"> 137</span><span class="p">{</span>
<span class="linenos"> 138</span><span class="w">    </span><span class="n">HDF5_EXCEPTION_CALL</span><span class="p">(</span><span class="n">parametersGroup</span><span class="p">,</span><span class="n">H5Gopen2</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/Parameters&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">));</span>
<span class="linenos"> 139</span><span class="w">    </span><span class="n">HDF5_EXCEPTION_CALL</span><span class="p">(</span><span class="n">modelGroup</span><span class="p">,</span><span class="n">H5Gopen2</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/Model&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">));</span>
<span class="linenos"> 140</span><span class="w">    </span><span class="n">HDF5_EXCEPTION_CALL</span><span class="p">(</span><span class="n">simulationsGroup</span><span class="p">,</span><span class="n">H5Gopen2</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/Simulations&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">));</span>
<span class="linenos"> 141</span><span class="p">}</span>
<span class="linenos"> 142</span>
<span class="linenos"> 143</span><span class="n">SimulationFile</span><span class="o">::~</span><span class="n">SimulationFile</span><span class="p">()</span>
<span class="linenos"> 144</span><span class="p">{</span>
<span class="linenos"> 145</span><span class="w">	</span><span class="c1">//Close the file, if it is still open.</span>
<span class="linenos"> 146</span><span class="w">	</span><span class="n">close</span><span class="p">();</span>
<span class="linenos"> 147</span><span class="p">}</span>
<span class="linenos"> 148</span>
<span class="linenos"> 149</span><span class="kt">void</span><span class="w"> </span><span class="n">SimulationFile</span><span class="o">::</span><span class="n">flush</span><span class="p">()</span>
<span class="linenos"> 150</span><span class="p">{</span>
<span class="linenos"> 151</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">file</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">H5I_INVALID_HID</span><span class="p">)</span>
<span class="linenos"> 152</span><span class="w">    </span><span class="p">{</span>
<span class="linenos"> 153</span><span class="w">        </span><span class="n">lm</span><span class="o">::</span><span class="n">Print</span><span class="o">::</span><span class="n">printf</span><span class="p">(</span><span class="n">Print</span><span class="o">::</span><span class="n">DEBUG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Flushing file %s.&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">filename</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
<span class="linenos"> 154</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Fflush</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="n">H5F_SCOPE_GLOBAL</span><span class="p">));</span>
<span class="linenos"> 155</span><span class="w">    </span><span class="p">}</span>
<span class="linenos"> 156</span><span class="p">}</span>
<span class="linenos"> 157</span>
<span class="linenos"> 158</span><span class="n">string</span><span class="w"> </span><span class="n">SimulationFile</span><span class="o">::</span><span class="n">checkpoint</span><span class="p">()</span>
<span class="linenos"> 159</span><span class="p">{</span>
<span class="linenos"> 160</span><span class="w">    </span><span class="c1">// Close the file.</span>
<span class="linenos"> 161</span><span class="w">    </span><span class="n">close</span><span class="p">();</span>
<span class="linenos"> 162</span>
<span class="linenos"> 163</span><span class="w">    </span><span class="c1">// Copy the file to a checkpoint file.</span>
<span class="linenos"> 164</span><span class="w">    </span><span class="n">string</span><span class="w"> </span><span class="n">checkpointFilename</span><span class="p">(</span><span class="n">filename</span><span class="o">+</span><span class="s">&quot;.chk&quot;</span><span class="p">);</span>
<span class="linenos"> 165</span><span class="w">    </span><span class="kt">FILE</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">out</span><span class="o">=</span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">in</span><span class="o">=</span><span class="nb">NULL</span><span class="p">;</span>
<span class="linenos"> 166</span><span class="w">    </span><span class="n">in</span><span class="o">=</span><span class="n">fopen</span><span class="p">(</span><span class="n">filename</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot;rb&quot;</span><span class="p">);</span>
<span class="linenos"> 167</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">in</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="n">lm</span><span class="o">::</span><span class="n">IOException</span><span class="p">(</span><span class="s">&quot;the checkpoint input file could not be opened&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">filename</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
<span class="linenos"> 168</span><span class="w">    </span><span class="n">out</span><span class="o">=</span><span class="n">fopen</span><span class="p">(</span><span class="n">checkpointFilename</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot;wb&quot;</span><span class="p">);</span>
<span class="linenos"> 169</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">out</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="n">lm</span><span class="o">::</span><span class="n">IOException</span><span class="p">(</span><span class="s">&quot;the checkpoint output file could not be opened&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">checkpointFilename</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
<span class="linenos"> 170</span><span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">bufferSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1024</span><span class="o">*</span><span class="mi">1024</span><span class="p">;</span>
<span class="linenos"> 171</span><span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">buffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">char</span><span class="p">[</span><span class="n">bufferSize</span><span class="p">];</span>
<span class="linenos"> 172</span><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">feof</span><span class="p">(</span><span class="n">in</span><span class="p">))</span>
<span class="linenos"> 173</span><span class="w">    </span><span class="p">{</span>
<span class="linenos"> 174</span><span class="w">        </span><span class="kt">size_t</span><span class="w"> </span><span class="n">bytesRead</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fread</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">char</span><span class="p">),</span><span class="w"> </span><span class="n">bufferSize</span><span class="p">,</span><span class="w"> </span><span class="n">in</span><span class="p">);</span>
<span class="linenos"> 175</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">bytesRead</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">bufferSize</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">ferror</span><span class="p">(</span><span class="n">in</span><span class="p">))</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="n">lm</span><span class="o">::</span><span class="n">IOException</span><span class="p">(</span><span class="s">&quot;the checkpoint input file could not be read&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">filename</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
<span class="linenos"> 176</span><span class="w">        </span><span class="kt">size_t</span><span class="w"> </span><span class="n">bytesWritten</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fwrite</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">char</span><span class="p">),</span><span class="w"> </span><span class="n">bytesRead</span><span class="p">,</span><span class="w"> </span><span class="n">out</span><span class="p">);</span>
<span class="linenos"> 177</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">bytesWritten</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">bytesRead</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="n">lm</span><span class="o">::</span><span class="n">IOException</span><span class="p">(</span><span class="s">&quot;the checkpoint input file could not be read&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">checkpointFilename</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
<span class="linenos"> 178</span><span class="w">    </span><span class="p">}</span>
<span class="linenos"> 179</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">fclose</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w">  </span><span class="k">throw</span><span class="w"> </span><span class="n">lm</span><span class="o">::</span><span class="n">IOException</span><span class="p">(</span><span class="s">&quot;the checkpoint input file could not be closed&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">filename</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
<span class="linenos"> 180</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">fclose</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w">  </span><span class="k">throw</span><span class="w"> </span><span class="n">lm</span><span class="o">::</span><span class="n">IOException</span><span class="p">(</span><span class="s">&quot;the checkpoint output file could not be closed&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">checkpointFilename</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
<span class="linenos"> 181</span><span class="w">    </span><span class="k">delete</span><span class="p">[]</span><span class="w"> </span><span class="n">buffer</span><span class="p">;</span>
<span class="linenos"> 182</span>
<span class="linenos"> 183</span><span class="w">    </span><span class="c1">// Open the file again.</span>
<span class="linenos"> 184</span><span class="w">    </span><span class="n">open</span><span class="p">();</span>
<span class="linenos"> 185</span>
<span class="linenos"> 186</span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">checkpointFilename</span><span class="p">;</span>
<span class="linenos"> 187</span><span class="p">}</span>
<span class="linenos"> 188</span>
<span class="linenos"> 189</span><span class="kt">void</span><span class="w"> </span><span class="n">SimulationFile</span><span class="o">::</span><span class="n">close</span><span class="p">()</span>
<span class="linenos"> 190</span><span class="p">{</span>
<span class="linenos"> 191</span><span class="w">    </span><span class="c1">// Close any open replicate groups.</span>
<span class="linenos"> 192</span><span class="w">    </span><span class="n">closeAllReplicates</span><span class="p">();</span>
<span class="linenos"> 193</span>
<span class="linenos"> 194</span><span class="w">    </span><span class="c1">// Close any open groups.</span>
<span class="linenos"> 195</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">parametersGroup</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">H5I_INVALID_HID</span><span class="p">)</span>
<span class="linenos"> 196</span><span class="w">    </span><span class="p">{</span>
<span class="linenos"> 197</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Gclose</span><span class="p">(</span><span class="n">parametersGroup</span><span class="p">));</span>
<span class="linenos"> 198</span><span class="w">        </span><span class="n">parametersGroup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">H5I_INVALID_HID</span><span class="p">;</span>
<span class="linenos"> 199</span><span class="w">    </span><span class="p">}</span>
<span class="linenos"> 200</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">modelGroup</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">H5I_INVALID_HID</span><span class="p">)</span>
<span class="linenos"> 201</span><span class="w">    </span><span class="p">{</span>
<span class="linenos"> 202</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Gclose</span><span class="p">(</span><span class="n">modelGroup</span><span class="p">));</span>
<span class="linenos"> 203</span><span class="w">        </span><span class="n">modelGroup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">H5I_INVALID_HID</span><span class="p">;</span>
<span class="linenos"> 204</span><span class="w">    </span><span class="p">}</span>
<span class="linenos"> 205</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">simulationsGroup</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">H5I_INVALID_HID</span><span class="p">)</span>
<span class="linenos"> 206</span><span class="w">    </span><span class="p">{</span>
<span class="linenos"> 207</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Gclose</span><span class="p">(</span><span class="n">simulationsGroup</span><span class="p">));</span>
<span class="linenos"> 208</span><span class="w">        </span><span class="n">simulationsGroup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">H5I_INVALID_HID</span><span class="p">;</span>
<span class="linenos"> 209</span><span class="w">    </span><span class="p">}</span>
<span class="linenos"> 210</span>
<span class="linenos"> 211</span><span class="w">    </span><span class="c1">// Close the file.</span>
<span class="linenos"> 212</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">file</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">H5I_INVALID_HID</span><span class="p">)</span>
<span class="linenos"> 213</span><span class="w">    </span><span class="p">{</span>
<span class="linenos"> 214</span><span class="w">        </span><span class="n">lm</span><span class="o">::</span><span class="n">Print</span><span class="o">::</span><span class="n">printf</span><span class="p">(</span><span class="n">Print</span><span class="o">::</span><span class="n">DEBUG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Closing file %s, %d open objects remaining.&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">filename</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span><span class="w"> </span><span class="n">H5Fget_obj_count</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="n">H5F_OBJ_ALL</span><span class="p">)</span><span class="mi">-1</span><span class="p">);</span>
<span class="linenos"> 215</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Fclose</span><span class="p">(</span><span class="n">file</span><span class="p">));</span>
<span class="linenos"> 216</span><span class="w">        </span><span class="n">file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">H5I_INVALID_HID</span><span class="p">;</span>
<span class="linenos"> 217</span><span class="w">    </span><span class="p">}</span>
<span class="linenos"> 218</span><span class="p">}</span>
<span class="linenos"> 219</span>
<span class="linenos"> 220</span><span class="kt">bool</span><span class="w"> </span><span class="n">SimulationFile</span><span class="o">::</span><span class="n">isValidFile</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">filename</span><span class="p">)</span>
<span class="linenos"> 221</span><span class="p">{</span>
<span class="linenos"> 222</span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">isValidFile</span><span class="p">(</span><span class="n">string</span><span class="p">(</span><span class="n">filename</span><span class="p">));</span>
<span class="linenos"> 223</span><span class="p">}</span>
<span class="linenos"> 224</span>
<span class="linenos"> 225</span><span class="kt">bool</span><span class="w"> </span><span class="n">SimulationFile</span><span class="o">::</span><span class="n">isValidFile</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">string</span><span class="w"> </span><span class="n">filename</span><span class="p">)</span>
<span class="linenos"> 226</span><span class="p">{</span>
<span class="linenos"> 227</span><span class="w">    </span><span class="c1">// Make sure the file has the right magic.</span>
<span class="linenos"> 228</span><span class="w">    </span><span class="kt">FILE</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">fp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="linenos"> 229</span><span class="w">    </span><span class="n">fp</span><span class="o">=</span><span class="n">fopen</span><span class="p">(</span><span class="n">filename</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot;r&quot;</span><span class="p">);</span>
<span class="linenos"> 230</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">fp</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="n">lm</span><span class="o">::</span><span class="n">IOException</span><span class="p">(</span><span class="s">&quot;the specified file could not be opened&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">filename</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
<span class="linenos"> 231</span><span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">magic</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
<span class="linenos"> 232</span><span class="w">    </span><span class="n">magic</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sc">&#39;\0&#39;</span><span class="p">;</span>
<span class="linenos"> 233</span><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="mi">4</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="linenos"> 234</span><span class="w">    </span><span class="p">{</span>
<span class="linenos"> 235</span><span class="w">        </span><span class="n">magic</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fgetc</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
<span class="linenos"> 236</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">magic</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">EOF</span><span class="p">)</span>
<span class="linenos"> 237</span><span class="w">        </span><span class="p">{</span>
<span class="linenos"> 238</span><span class="w">            </span><span class="n">magic</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sc">&#39;\0&#39;</span><span class="p">;</span>
<span class="linenos"> 239</span><span class="w">            </span><span class="k">break</span><span class="p">;</span>
<span class="linenos"> 240</span><span class="w">        </span><span class="p">}</span>
<span class="linenos"> 241</span><span class="w">    </span><span class="p">}</span>
<span class="linenos"> 242</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w">  </span><span class="k">throw</span><span class="w"> </span><span class="n">lm</span><span class="o">::</span><span class="n">IOException</span><span class="p">(</span><span class="s">&quot;the specified file could not be closed&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">filename</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
<span class="linenos"> 243</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">magic</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;LMH5&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="linenos"> 244</span>
<span class="linenos"> 245</span><span class="w">    </span><span class="c1">// Make sure it is an hdf5 file.</span>
<span class="linenos"> 246</span><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">isHdf5</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="linenos"> 247</span><span class="w">    </span><span class="n">HDF5_EXCEPTION_CALL</span><span class="p">(</span><span class="n">isHdf5</span><span class="p">,</span><span class="n">H5Fis_hdf5</span><span class="p">(</span><span class="n">filename</span><span class="p">.</span><span class="n">c_str</span><span class="p">()));</span>
<span class="linenos"> 248</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">isHdf5</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="linenos"> 249</span>
<span class="linenos"> 250</span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="linenos"> 251</span>
<span class="linenos"> 252</span><span class="p">}</span>
<span class="linenos"> 253</span>
<span class="linenos"> 254</span><span class="kt">void</span><span class="w"> </span><span class="n">SimulationFile</span><span class="o">::</span><span class="n">loadParameters</span><span class="p">()</span>
<span class="linenos"> 255</span><span class="p">{</span>
<span class="linenos"> 256</span><span class="w">    </span><span class="n">hsize_t</span><span class="w"> </span><span class="n">n</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<span class="linenos"> 257</span><span class="w">    </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Aiterate2</span><span class="p">(</span><span class="n">parametersGroup</span><span class="p">,</span><span class="w"> </span><span class="n">H5_INDEX_CRT_ORDER</span><span class="p">,</span><span class="w"> </span><span class="n">H5_ITER_NATIVE</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">SimulationFile</span><span class="o">::</span><span class="n">parseParameter</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">));</span>
<span class="linenos"> 258</span><span class="p">}</span>
<span class="linenos"> 259</span>
<span class="linenos"> 260</span><span class="n">herr_t</span><span class="w"> </span><span class="n">SimulationFile</span><span class="o">::</span><span class="n">parseParameter</span><span class="p">(</span><span class="n">hid_t</span><span class="w"> </span><span class="n">location_id</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">attr_name</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">H5A_info_t</span><span class="w"> </span><span class="o">*</span><span class="n">ainfo</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">op_data</span><span class="p">)</span>
<span class="linenos"> 261</span><span class="p">{</span>
<span class="linenos"> 262</span><span class="w">    </span><span class="n">SimulationFile</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">SimulationFile</span><span class="w"> </span><span class="o">*&gt;</span><span class="p">(</span><span class="n">op_data</span><span class="p">);</span>
<span class="linenos"> 263</span>
<span class="linenos"> 264</span><span class="w">    </span><span class="c1">// Open the attribute.</span>
<span class="linenos"> 265</span><span class="w">    </span><span class="n">hid_t</span><span class="w"> </span><span class="n">attr</span><span class="p">,</span><span class="w"> </span><span class="n">type</span><span class="p">;</span>
<span class="linenos"> 266</span><span class="w">    </span><span class="n">H5T_class_t</span><span class="w"> </span><span class="n">typeClass</span><span class="p">;</span>
<span class="linenos"> 267</span><span class="w">    </span><span class="n">hsize_t</span><span class="w"> </span><span class="n">size</span><span class="p">;</span>
<span class="linenos"> 268</span><span class="w">    </span><span class="n">HDF5_EXCEPTION_CALL</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span><span class="n">H5Aopen</span><span class="p">(</span><span class="n">location_id</span><span class="p">,</span><span class="w"> </span><span class="n">attr_name</span><span class="p">,</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">));</span>
<span class="linenos"> 269</span><span class="w">    </span><span class="n">HDF5_EXCEPTION_CALL</span><span class="p">(</span><span class="n">type</span><span class="p">,</span><span class="n">H5Aget_type</span><span class="p">(</span><span class="n">attr</span><span class="p">));</span>
<span class="linenos"> 270</span><span class="w">    </span><span class="n">typeClass</span><span class="o">=</span><span class="n">H5Tget_class</span><span class="p">(</span><span class="n">type</span><span class="p">);</span>
<span class="linenos"> 271</span><span class="w">    </span><span class="n">HDF5_EXCEPTION_CALL</span><span class="p">(</span><span class="n">size</span><span class="p">,</span><span class="n">H5Aget_storage_size</span><span class="p">(</span><span class="n">attr</span><span class="p">));</span>
<span class="linenos"> 272</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">version</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">typeClass</span><span class="o">==</span><span class="n">H5T_FLOAT</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">double</span><span class="p">))</span>
<span class="linenos"> 273</span><span class="w">    </span><span class="p">{</span>
<span class="linenos"> 274</span><span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">value</span><span class="p">;</span>
<span class="linenos"> 275</span><span class="w">        </span><span class="kt">char</span><span class="w"> </span><span class="n">buffer</span><span class="p">[</span><span class="mi">33</span><span class="p">];</span>
<span class="linenos"> 276</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Aread</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span><span class="w"> </span><span class="n">H5T_NATIVE_DOUBLE</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">value</span><span class="p">));</span>
<span class="linenos"> 277</span><span class="w">        </span><span class="n">snprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">buffer</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;%g&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">);</span>
<span class="linenos"> 278</span><span class="w">        </span><span class="n">file</span><span class="o">-&gt;</span><span class="n">parameterMap</span><span class="p">[</span><span class="n">attr_name</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">buffer</span><span class="p">;</span>
<span class="linenos"> 279</span><span class="w">    </span><span class="p">}</span>
<span class="linenos"> 280</span><span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">version</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">typeClass</span><span class="o">==</span><span class="n">H5T_STRING</span><span class="p">)</span>
<span class="linenos"> 281</span><span class="w">    </span><span class="p">{</span>
<span class="linenos"> 282</span><span class="w">        </span><span class="c1">// Get the dataspace.</span>
<span class="linenos"> 283</span><span class="w">        </span><span class="n">hid_t</span><span class="w"> </span><span class="n">space</span><span class="p">;</span>
<span class="linenos"> 284</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CALL</span><span class="p">(</span><span class="n">space</span><span class="p">,</span><span class="n">H5Aget_space</span><span class="p">(</span><span class="n">attr</span><span class="p">));</span>
<span class="linenos"> 285</span>
<span class="linenos"> 286</span><span class="w">        </span><span class="c1">// Create the memory datatype.</span>
<span class="linenos"> 287</span><span class="w">        </span><span class="n">hid_t</span><span class="w"> </span><span class="n">memtype</span><span class="p">;</span>
<span class="linenos"> 288</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CALL</span><span class="p">(</span><span class="n">memtype</span><span class="p">,</span><span class="n">H5Tcopy</span><span class="p">(</span><span class="n">H5T_C_S1</span><span class="p">));</span>
<span class="linenos"> 289</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Tset_size</span><span class="p">(</span><span class="n">memtype</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">));</span>
<span class="linenos"> 290</span>
<span class="linenos"> 291</span><span class="w">        </span><span class="c1">// Read the data.</span>
<span class="linenos"> 292</span><span class="w">        </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">char</span><span class="p">[</span><span class="n">size</span><span class="p">];</span>
<span class="linenos"> 293</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Aread</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span><span class="w"> </span><span class="n">memtype</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">));</span>
<span class="linenos"> 294</span>
<span class="linenos"> 295</span><span class="w">        </span><span class="c1">// Add the parameter to the map.</span>
<span class="linenos"> 296</span><span class="w">        </span><span class="n">file</span><span class="o">-&gt;</span><span class="n">parameterMap</span><span class="p">[</span><span class="n">attr_name</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">value</span><span class="p">;</span>
<span class="linenos"> 297</span>
<span class="linenos"> 298</span><span class="w">        </span><span class="c1">// Reclaim the memory.</span>
<span class="linenos"> 299</span><span class="w">        </span><span class="k">delete</span><span class="w"> </span><span class="p">[]</span><span class="w"> </span><span class="n">value</span><span class="p">;</span>
<span class="linenos"> 300</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Sclose</span><span class="p">(</span><span class="n">space</span><span class="p">));</span>
<span class="linenos"> 301</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Tclose</span><span class="p">(</span><span class="n">memtype</span><span class="p">));</span>
<span class="linenos"> 302</span><span class="w">    </span><span class="p">}</span>
<span class="linenos"> 303</span><span class="w">    </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Tclose</span><span class="p">(</span><span class="n">type</span><span class="p">));</span>
<span class="linenos"> 304</span><span class="w">    </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Aclose</span><span class="p">(</span><span class="n">attr</span><span class="p">));</span>
<span class="linenos"> 305</span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos"> 306</span><span class="p">}</span>
<span class="linenos"> 307</span>
<span class="linenos"> 308</span><span class="n">map</span><span class="o">&lt;</span><span class="n">string</span><span class="p">,</span><span class="n">string</span><span class="o">&gt;</span><span class="w"> </span><span class="n">SimulationFile</span><span class="o">::</span><span class="n">getParameters</span><span class="p">()</span>
<span class="linenos"> 309</span><span class="p">{</span>
<span class="linenos"> 310</span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">parameterMap</span><span class="p">;</span>
<span class="linenos"> 311</span><span class="p">}</span>
<span class="linenos"> 312</span>
<span class="linenos"> 313</span><span class="n">string</span><span class="w"> </span><span class="n">SimulationFile</span><span class="o">::</span><span class="n">getParameter</span><span class="p">(</span><span class="n">string</span><span class="w"> </span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">string</span><span class="w"> </span><span class="n">defaultValue</span><span class="p">)</span>
<span class="linenos"> 314</span><span class="p">{</span>
<span class="linenos"> 315</span><span class="w">    </span><span class="c1">// If we didn&#39;t find the key, return the default value.</span>
<span class="linenos"> 316</span><span class="w">    </span><span class="n">map</span><span class="o">&lt;</span><span class="n">string</span><span class="p">,</span><span class="n">string</span><span class="o">&gt;::</span><span class="n">iterator</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parameterMap</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">key</span><span class="p">);</span>
<span class="linenos"> 317</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">it</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">parameterMap</span><span class="p">.</span><span class="n">end</span><span class="p">())</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">defaultValue</span><span class="p">;</span>
<span class="linenos"> 318</span>
<span class="linenos"> 319</span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">it</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">;</span>
<span class="linenos"> 320</span><span class="p">}</span>
<span class="linenos"> 321</span>
<span class="linenos"> 322</span><span class="kt">void</span><span class="w"> </span><span class="n">SimulationFile</span><span class="o">::</span><span class="n">setParameter</span><span class="p">(</span><span class="n">string</span><span class="w"> </span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">string</span><span class="w"> </span><span class="n">value</span><span class="p">)</span>
<span class="linenos"> 323</span><span class="p">{</span>
<span class="linenos"> 324</span><span class="w">    </span><span class="c1">// Set the parameter in the map.</span>
<span class="linenos"> 325</span><span class="w">    </span><span class="n">parameterMap</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">value</span><span class="p">;</span>
<span class="linenos"> 326</span>
<span class="linenos"> 327</span><span class="w">    </span><span class="c1">// Save the parameter in the file.</span>
<span class="linenos"> 328</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">version</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span>
<span class="linenos"> 329</span><span class="w">    </span><span class="p">{</span>
<span class="linenos"> 330</span><span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">dvalue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">atof</span><span class="p">(</span><span class="n">value</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
<span class="linenos"> 331</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5LTset_attribute_double</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/Parameters&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">key</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span><span class="w"> </span><span class="o">&amp;</span><span class="n">dvalue</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">));</span>
<span class="linenos"> 332</span><span class="w">    </span><span class="p">}</span>
<span class="linenos"> 333</span><span class="w">    </span><span class="k">else</span>
<span class="linenos"> 334</span><span class="w">    </span><span class="p">{</span>
<span class="linenos"> 335</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5LTset_attribute_string</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/Parameters&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">key</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span><span class="w"> </span><span class="n">value</span><span class="p">.</span><span class="n">c_str</span><span class="p">()));</span>
<span class="linenos"> 336</span><span class="w">    </span><span class="p">}</span>
<span class="linenos"> 337</span><span class="p">}</span>
<span class="linenos"> 338</span>
<span class="linenos"> 339</span><span class="kt">void</span><span class="w"> </span><span class="n">SimulationFile</span><span class="o">::</span><span class="n">loadModel</span><span class="p">()</span>
<span class="linenos"> 340</span><span class="p">{</span>
<span class="linenos"> 341</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">modelLoaded</span><span class="p">)</span>
<span class="linenos"> 342</span><span class="w">    </span><span class="p">{</span>
<span class="linenos"> 343</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">version</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span>
<span class="linenos"> 344</span><span class="w">        </span><span class="p">{</span>
<span class="linenos"> 345</span><span class="w">            </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5LTget_attribute_uint</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/Model&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;numberSpecies&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">numberSpecies</span><span class="p">));</span>
<span class="linenos"> 346</span><span class="w">            </span><span class="n">modelLoaded</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="linenos"> 347</span><span class="w">        </span><span class="p">}</span>
<span class="linenos"> 348</span><span class="w">        </span><span class="k">else</span>
<span class="linenos"> 349</span><span class="w">        </span><span class="p">{</span>
<span class="linenos"> 350</span><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">H5Lexists</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/Model/Reaction&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="linenos"> 351</span><span class="w">            </span><span class="p">{</span>
<span class="linenos"> 352</span><span class="w">                </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5LTget_attribute_uint</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/Model/Reaction&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;numberSpecies&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">numberSpecies</span><span class="p">));</span>
<span class="linenos"> 353</span><span class="w">                </span><span class="n">modelLoaded</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="linenos"> 354</span><span class="w">            </span><span class="p">}</span>
<span class="linenos"> 355</span><span class="w">            </span><span class="k">else</span>
<span class="linenos"> 356</span><span class="w">            </span><span class="p">{</span>
<span class="linenos"> 357</span><span class="w">                </span><span class="k">throw</span><span class="w"> </span><span class="n">Exception</span><span class="p">(</span><span class="s">&quot;No model has been defined.&quot;</span><span class="p">);</span>
<span class="linenos"> 358</span><span class="w">            </span><span class="p">}</span>
<span class="linenos"> 359</span><span class="w">        </span><span class="p">}</span>
<span class="linenos"> 360</span><span class="w">    </span><span class="p">}</span>
<span class="linenos"> 361</span><span class="p">}</span>
<span class="linenos"> 362</span>
<span class="linenos"> 363</span><span class="kt">void</span><span class="w"> </span><span class="n">SimulationFile</span><span class="o">::</span><span class="n">getReactionModel</span><span class="p">(</span><span class="n">lm</span><span class="o">::</span><span class="n">io</span><span class="o">::</span><span class="n">ReactionModel</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">reactionModel</span><span class="p">)</span>
<span class="linenos"> 364</span><span class="p">{</span>
<span class="linenos"> 365</span><span class="w">    </span><span class="c1">// Make sure the model is not null and then clear it.</span>
<span class="linenos"> 366</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">reactionModel</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="n">InvalidArgException</span><span class="p">(</span><span class="s">&quot;reactionModel&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;cannot be null&quot;</span><span class="p">);</span>
<span class="linenos"> 367</span><span class="w">    </span><span class="n">reactionModel</span><span class="o">-&gt;</span><span class="n">Clear</span><span class="p">();</span>
<span class="linenos"> 368</span>
<span class="linenos"> 369</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">H5Lexists</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/Model/Reaction&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">))</span>
<span class="linenos"> 370</span><span class="w">    </span><span class="p">{</span>
<span class="linenos"> 371</span><span class="w">        </span><span class="c1">// Read at least the numbers of species.</span>
<span class="linenos"> 372</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5LTget_attribute_uint</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/Model/Reaction&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;numberSpecies&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">numberSpecies</span><span class="p">));</span>
<span class="linenos"> 373</span><span class="w">        </span><span class="n">reactionModel</span><span class="o">-&gt;</span><span class="n">set_number_species</span><span class="p">(</span><span class="n">numberSpecies</span><span class="p">);</span>
<span class="linenos"> 374</span><span class="w">        </span><span class="n">reactionModel</span><span class="o">-&gt;</span><span class="n">set_number_reactions</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="linenos"> 375</span>
<span class="linenos"> 376</span><span class="w">        </span><span class="c1">// If we have the number of reactions, we must have a full model so read it.</span>
<span class="linenos"> 377</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">H5Aexists_by_name</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/Model/Reaction&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;numberReactions&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="linenos"> 378</span><span class="w">        </span><span class="p">{</span>
<span class="linenos"> 379</span><span class="w">            </span><span class="n">hsize_t</span><span class="w"> </span><span class="n">dims</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<span class="linenos"> 380</span><span class="w">            </span><span class="n">H5T_class_t</span><span class="w"> </span><span class="n">type</span><span class="p">;</span>
<span class="linenos"> 381</span><span class="w">            </span><span class="kt">size_t</span><span class="w"> </span><span class="n">size</span><span class="p">;</span>
<span class="linenos"> 382</span>
<span class="linenos"> 383</span><span class="w">            </span><span class="c1">// Read the initial species counts.</span>
<span class="linenos"> 384</span><span class="w">            </span><span class="n">H5LTget_dataset_info</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/Model/Reaction/InitialSpeciesCounts&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">dims</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">size</span><span class="p">);</span>
<span class="linenos"> 385</span><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">numberSpecies</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">uint</span><span class="p">))</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="n">Exception</span><span class="p">(</span><span class="s">&quot;Invalid dataset dimensions&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">filename</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot;/Model/Reaction/InitialSpeciesCounts&quot;</span><span class="p">);</span>
<span class="linenos"> 386</span>
<span class="linenos"> 387</span><span class="w">	    </span><span class="c1">// Read the initial species counts.</span>
<span class="linenos"> 388</span><span class="w">	    </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">sbuf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">int</span><span class="p">[</span><span class="n">numberSpecies</span><span class="p">];</span>
<span class="linenos"> 389</span><span class="w">	    </span><span class="n">H5LTread_dataset_int</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/Model/Reaction/InitialSpeciesCounts&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">sbuf</span><span class="p">);</span>
<span class="linenos"> 390</span><span class="w">	    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">numberSpecies</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="n">reactionModel</span><span class="o">-&gt;</span><span class="n">add_initial_species_count</span><span class="p">((</span><span class="n">uint</span><span class="p">)</span><span class="n">sbuf</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="linenos"> 391</span><span class="w">	    </span><span class="k">delete</span><span class="w"> </span><span class="p">[]</span><span class="w"> </span><span class="n">sbuf</span><span class="p">;</span>
<span class="linenos"> 392</span>
<span class="linenos"> 393</span><span class="w">            </span><span class="c1">// Read the number of reactions.</span>
<span class="linenos"> 394</span><span class="w">            </span><span class="n">uint</span><span class="w"> </span><span class="n">numberReactions</span><span class="p">;</span>
<span class="linenos"> 395</span><span class="w">            </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5LTget_attribute_uint</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/Model/Reaction&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;numberReactions&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">numberReactions</span><span class="p">));</span>
<span class="linenos"> 396</span><span class="w">            </span><span class="n">reactionModel</span><span class="o">-&gt;</span><span class="n">set_number_reactions</span><span class="p">(</span><span class="n">numberReactions</span><span class="p">);</span>
<span class="linenos"> 397</span>
<span class="linenos"> 398</span><span class="w">            </span><span class="c1">// Read the reaction tables.</span>
<span class="linenos"> 399</span><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">numberReactions</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="linenos"> 400</span><span class="w">            </span><span class="p">{</span>
<span class="linenos"> 401</span><span class="w">                </span><span class="c1">// Make sure all of the data sets are the correct size.</span>
<span class="linenos"> 402</span><span class="w">                </span><span class="n">H5LTget_dataset_info</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/Model/Reaction/ReactionTypes&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">dims</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">size</span><span class="p">);</span>
<span class="linenos"> 403</span><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">numberReactions</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">uint</span><span class="p">))</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="n">Exception</span><span class="p">(</span><span class="s">&quot;Invalid dataset dimensions&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">filename</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot;/Model/Reaction/ReactionTypes&quot;</span><span class="p">);</span>
<span class="linenos"> 404</span><span class="w">                </span><span class="n">H5LTget_dataset_info</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/Model/Reaction/ReactionRateConstants&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">dims</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">size</span><span class="p">);</span>
<span class="linenos"> 405</span><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">numberReactions</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">MAX_REACTION_RATE_CONSTANTS</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">double</span><span class="p">))</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="n">Exception</span><span class="p">(</span><span class="s">&quot;Invalid dataset dimensions&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">filename</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot;/Model/Reaction/ReactionRateConstants&quot;</span><span class="p">);</span>
<span class="linenos"> 406</span><span class="w">                </span><span class="n">H5LTget_dataset_info</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/Model/Reaction/StoichiometricMatrix&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">dims</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">size</span><span class="p">);</span>
<span class="linenos"> 407</span><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">numberSpecies</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">numberReactions</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">))</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="n">Exception</span><span class="p">(</span><span class="s">&quot;Invalid dataset dimensions&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">filename</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot;/Model/Reaction/StoichiometricMatrix&quot;</span><span class="p">);</span>
<span class="linenos"> 408</span><span class="w">                </span><span class="n">H5LTget_dataset_info</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/Model/Reaction/DependencyMatrix&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">dims</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">size</span><span class="p">);</span>
<span class="linenos"> 409</span><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">numberSpecies</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">numberReactions</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">uint</span><span class="p">))</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="n">Exception</span><span class="p">(</span><span class="s">&quot;Invalid dataset dimensions&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">filename</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot;/Model/Reaction/DependencyMatrix&quot;</span><span class="p">);</span>
<span class="linenos"> 410</span>
<span class="linenos"> 411</span><span class="w">                </span><span class="c1">// If we have rate noise terms, make sure they are the correct size.</span>
<span class="linenos"> 412</span><span class="w">                </span><span class="k">const</span><span class="w"> </span><span class="n">uint</span><span class="w"> </span><span class="n">NUMBER_NOISE_COLS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<span class="linenos"> 413</span><span class="w">                </span><span class="kt">bool</span><span class="w"> </span><span class="n">hasNoiseTable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="linenos"> 414</span><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">H5Lexists</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/Model/Reaction/ReactionRateNoise&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">))</span>
<span class="linenos"> 415</span><span class="w">                </span><span class="p">{</span>
<span class="linenos"> 416</span><span class="w">                    </span><span class="n">hasNoiseTable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="linenos"> 417</span><span class="w">                    </span><span class="n">H5LTget_dataset_info</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/Model/Reaction/ReactionRateNoise&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">dims</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">size</span><span class="p">);</span>
<span class="linenos"> 418</span><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">numberReactions</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">NUMBER_NOISE_COLS</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">double</span><span class="p">))</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="n">Exception</span><span class="p">(</span><span class="s">&quot;Invalid dataset dimensions&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">filename</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot;/Model/Reaction/ReactionRateNoise&quot;</span><span class="p">);</span>
<span class="linenos"> 419</span><span class="w">                </span><span class="p">}</span>
<span class="linenos"> 420</span>
<span class="linenos"> 421</span><span class="w">                </span><span class="c1">// Allocate some buffers for reading the data.</span>
<span class="linenos"> 422</span><span class="w">                </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">intBuffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">int</span><span class="p">[</span><span class="n">numberSpecies</span><span class="o">*</span><span class="n">numberReactions</span><span class="p">];</span>
<span class="linenos"> 423</span><span class="w">                </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">doubleBuffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">double</span><span class="p">[</span><span class="n">numberReactions</span><span class="o">*</span><span class="n">MAX_REACTION_RATE_CONSTANTS</span><span class="p">];</span>
<span class="linenos"> 424</span><span class="w">                </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">noiseBuffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">double</span><span class="p">[</span><span class="n">numberReactions</span><span class="o">*</span><span class="n">NUMBER_NOISE_COLS</span><span class="p">];</span>
<span class="linenos"> 425</span>
<span class="linenos"> 426</span><span class="w">                </span><span class="c1">// Read the reaction info.</span>
<span class="linenos"> 427</span><span class="w">                </span><span class="n">H5LTread_dataset_int</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/Model/Reaction/ReactionTypes&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">intBuffer</span><span class="p">);</span>
<span class="linenos"> 428</span><span class="w">                </span><span class="n">H5LTread_dataset_double</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/Model/Reaction/ReactionRateConstants&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">doubleBuffer</span><span class="p">);</span>
<span class="linenos"> 429</span><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">hasNoiseTable</span><span class="p">)</span><span class="w"> </span><span class="n">H5LTread_dataset_double</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/Model/Reaction/ReactionRateNoise&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">noiseBuffer</span><span class="p">);</span>
<span class="linenos"> 430</span><span class="w">                </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">numberReactions</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="linenos"> 431</span><span class="w">                </span><span class="p">{</span>
<span class="linenos"> 432</span><span class="w">                    </span><span class="n">reactionModel</span><span class="o">-&gt;</span><span class="n">add_reaction</span><span class="p">();</span>
<span class="linenos"> 433</span><span class="w">                    </span><span class="n">reactionModel</span><span class="o">-&gt;</span><span class="n">mutable_reaction</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">set_type</span><span class="p">((</span><span class="n">uint</span><span class="p">)</span><span class="n">intBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="linenos"> 434</span><span class="w">                    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">&lt;</span><span class="n">MAX_REACTION_RATE_CONSTANTS</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">++</span><span class="p">)</span>
<span class="linenos"> 435</span><span class="w">                    </span><span class="p">{</span>
<span class="linenos"> 436</span><span class="w">                        </span><span class="kt">double</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">doubleBuffer</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="n">MAX_REACTION_RATE_CONSTANTS</span><span class="o">+</span><span class="n">j</span><span class="p">];</span>
<span class="linenos"> 437</span><span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">std</span><span class="o">::</span><span class="n">isnan</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
<span class="linenos"> 438</span><span class="w">                            </span><span class="n">reactionModel</span><span class="o">-&gt;</span><span class="n">mutable_reaction</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">add_rate_constant</span><span class="p">(</span><span class="n">k</span><span class="p">);</span>
<span class="linenos"> 439</span><span class="w">                        </span><span class="k">else</span>
<span class="linenos"> 440</span><span class="w">                            </span><span class="k">break</span><span class="p">;</span>
<span class="linenos"> 441</span><span class="w">                    </span><span class="p">}</span>
<span class="linenos"> 442</span>
<span class="linenos"> 443</span><span class="w">                    </span><span class="c1">// If we have noise terms, set them.</span>
<span class="linenos"> 444</span><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">hasNoiseTable</span><span class="p">)</span>
<span class="linenos"> 445</span><span class="w">                    </span><span class="p">{</span>
<span class="linenos"> 446</span><span class="w">                        </span><span class="kt">double</span><span class="w"> </span><span class="n">nvar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">noiseBuffer</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="n">NUMBER_NOISE_COLS</span><span class="p">];</span>
<span class="linenos"> 447</span><span class="w">                        </span><span class="kt">double</span><span class="w"> </span><span class="n">ntau</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">noiseBuffer</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="n">NUMBER_NOISE_COLS</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
<span class="linenos"> 448</span><span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">nvar</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0.0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">ntau</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0.0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">std</span><span class="o">::</span><span class="n">isnan</span><span class="p">(</span><span class="n">nvar</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">std</span><span class="o">::</span><span class="n">isnan</span><span class="p">(</span><span class="n">ntau</span><span class="p">))</span>
<span class="linenos"> 449</span><span class="w">                        </span><span class="p">{</span>
<span class="linenos"> 450</span><span class="w">                            </span><span class="n">reactionModel</span><span class="o">-&gt;</span><span class="n">mutable_reaction</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">set_rate_has_noise</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
<span class="linenos"> 451</span><span class="w">                            </span><span class="n">reactionModel</span><span class="o">-&gt;</span><span class="n">mutable_reaction</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">set_rate_noise_variance</span><span class="p">(</span><span class="n">nvar</span><span class="p">);</span>
<span class="linenos"> 452</span><span class="w">                            </span><span class="n">reactionModel</span><span class="o">-&gt;</span><span class="n">mutable_reaction</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">set_rate_noise_tau</span><span class="p">(</span><span class="n">ntau</span><span class="p">);</span>
<span class="linenos"> 453</span><span class="w">                        </span><span class="p">}</span>
<span class="linenos"> 454</span><span class="w">                    </span><span class="p">}</span>
<span class="linenos"> 455</span><span class="w">                </span><span class="p">}</span>
<span class="linenos"> 456</span>
<span class="linenos"> 457</span><span class="w">                </span><span class="c1">// Read the matrices.</span>
<span class="linenos"> 458</span><span class="w">                </span><span class="n">H5LTread_dataset_int</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/Model/Reaction/StoichiometricMatrix&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">intBuffer</span><span class="p">);</span>
<span class="linenos"> 459</span><span class="w">                </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">numberSpecies</span><span class="o">*</span><span class="n">numberReactions</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="n">reactionModel</span><span class="o">-&gt;</span><span class="n">add_stoichiometric_matrix</span><span class="p">(</span><span class="n">intBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="linenos"> 460</span><span class="w">                </span><span class="n">H5LTread_dataset_int</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/Model/Reaction/DependencyMatrix&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">intBuffer</span><span class="p">);</span>
<span class="linenos"> 461</span><span class="w">                </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">numberSpecies</span><span class="o">*</span><span class="n">numberReactions</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="n">reactionModel</span><span class="o">-&gt;</span><span class="n">add_dependency_matrix</span><span class="p">((</span><span class="n">uint</span><span class="p">)</span><span class="n">intBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="linenos"> 462</span>
<span class="linenos"> 463</span><span class="w">                </span><span class="c1">// Free the buffers.</span>
<span class="linenos"> 464</span><span class="w">                </span><span class="k">delete</span><span class="w"> </span><span class="p">[]</span><span class="w"> </span><span class="n">noiseBuffer</span><span class="p">;</span>
<span class="linenos"> 465</span><span class="w">                </span><span class="k">delete</span><span class="w"> </span><span class="p">[]</span><span class="w"> </span><span class="n">doubleBuffer</span><span class="p">;</span>
<span class="linenos"> 466</span><span class="w">                </span><span class="k">delete</span><span class="w"> </span><span class="p">[]</span><span class="w"> </span><span class="n">intBuffer</span><span class="p">;</span>
<span class="linenos"> 467</span><span class="w">            </span><span class="p">}</span>
<span class="linenos"> 468</span><span class="w">        </span><span class="p">}</span>
<span class="linenos"> 469</span><span class="w">    </span><span class="p">}</span>
<span class="linenos"> 470</span><span class="p">}</span>
<span class="linenos"> 471</span>
<span class="linenos"> 472</span><span class="kt">void</span><span class="w"> </span><span class="n">SimulationFile</span><span class="o">::</span><span class="n">setReactionModel</span><span class="p">(</span><span class="n">lm</span><span class="o">::</span><span class="n">io</span><span class="o">::</span><span class="n">ReactionModel</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">reactionModel</span><span class="p">)</span>
<span class="linenos"> 473</span><span class="p">{</span>
<span class="linenos"> 474</span><span class="w">    </span><span class="c1">// Validate that the model is consistent.</span>
<span class="linenos"> 475</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">reactionModel</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="n">InvalidArgException</span><span class="p">(</span><span class="s">&quot;reactionModel&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;cannot be NULL&quot;</span><span class="p">);</span>
<span class="linenos"> 476</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">reactionModel</span><span class="o">-&gt;</span><span class="n">number_species</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="n">InvalidArgException</span><span class="p">(</span><span class="s">&quot;reactionModel.number_species&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;cannot be zero&quot;</span><span class="p">);</span>
<span class="linenos"> 477</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">reactionModel</span><span class="o">-&gt;</span><span class="n">initial_species_count_size</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">reactionModel</span><span class="o">-&gt;</span><span class="n">number_species</span><span class="p">())</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="n">InvalidArgException</span><span class="p">(</span><span class="s">&quot;reactionModel.initial_species_count&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;inconsistent size&quot;</span><span class="p">);</span>
<span class="linenos"> 478</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">reactionModel</span><span class="o">-&gt;</span><span class="n">reaction_size</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">reactionModel</span><span class="o">-&gt;</span><span class="n">number_reactions</span><span class="p">())</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="n">InvalidArgException</span><span class="p">(</span><span class="s">&quot;reactionModel.reaction&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;inconsistent size&quot;</span><span class="p">);</span>
<span class="linenos"> 479</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">reactionModel</span><span class="o">-&gt;</span><span class="n">stoichiometric_matrix_size</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">reactionModel</span><span class="o">-&gt;</span><span class="n">number_species</span><span class="p">()</span><span class="o">*</span><span class="n">reactionModel</span><span class="o">-&gt;</span><span class="n">number_reactions</span><span class="p">()))</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="n">InvalidArgException</span><span class="p">(</span><span class="s">&quot;reactionModel.stoichiometric_matrix&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;inconsistent size&quot;</span><span class="p">);</span>
<span class="linenos"> 480</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">reactionModel</span><span class="o">-&gt;</span><span class="n">dependency_matrix_size</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">reactionModel</span><span class="o">-&gt;</span><span class="n">number_species</span><span class="p">()</span><span class="o">*</span><span class="n">reactionModel</span><span class="o">-&gt;</span><span class="n">number_reactions</span><span class="p">()))</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="n">InvalidArgException</span><span class="p">(</span><span class="s">&quot;reactionModel.dependency_matrix&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;inconsistent size&quot;</span><span class="p">);</span>
<span class="linenos"> 481</span>
<span class="linenos"> 482</span><span class="w">    </span><span class="c1">// If a reaction model already exists, delete it.</span>
<span class="linenos"> 483</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">H5Lexists</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/Model/Reaction&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">))</span>
<span class="linenos"> 484</span><span class="w">    </span><span class="p">{</span>
<span class="linenos"> 485</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Ldelete</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/Model/Reaction&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">));</span>
<span class="linenos"> 486</span><span class="w">    </span><span class="p">}</span>
<span class="linenos"> 487</span>
<span class="linenos"> 488</span><span class="w">    </span><span class="c1">// Create the group for the reaction model.</span>
<span class="linenos"> 489</span><span class="w">    </span><span class="n">hid_t</span><span class="w"> </span><span class="n">group</span><span class="p">;</span>
<span class="linenos"> 490</span><span class="w">    </span><span class="n">HDF5_EXCEPTION_CALL</span><span class="p">(</span><span class="n">group</span><span class="p">,</span><span class="n">H5Gcreate2</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/Model/Reaction&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">,</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">,</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">));</span>
<span class="linenos"> 491</span><span class="w">    </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Gclose</span><span class="p">(</span><span class="n">group</span><span class="p">));</span>
<span class="linenos"> 492</span>
<span class="linenos"> 493</span><span class="w">    </span><span class="c1">// Write the numbers of species and reactions.</span>
<span class="linenos"> 494</span><span class="w">    </span><span class="n">numberSpecies</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">reactionModel</span><span class="o">-&gt;</span><span class="n">number_species</span><span class="p">();</span>
<span class="linenos"> 495</span><span class="w">    </span><span class="n">uint</span><span class="w"> </span><span class="n">numberReactions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">reactionModel</span><span class="o">-&gt;</span><span class="n">number_reactions</span><span class="p">();</span>
<span class="linenos"> 496</span><span class="w">    </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5LTset_attribute_uint</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/Model/Reaction&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;numberSpecies&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">numberSpecies</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">));</span>
<span class="linenos"> 497</span><span class="w">    </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5LTset_attribute_uint</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/Model/Reaction&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;numberReactions&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">numberReactions</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">));</span>
<span class="linenos"> 498</span>
<span class="linenos"> 499</span><span class="w">    </span><span class="n">hsize_t</span><span class="w"> </span><span class="n">dims</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<span class="linenos"> 500</span>
<span class="linenos"> 501</span><span class="w">    </span><span class="c1">// Write the initial species counts.</span>
<span class="linenos"> 502</span><span class="w">    </span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">numberSpecies</span><span class="p">;</span>
<span class="linenos"> 503</span><span class="w">    </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5LTmake_dataset</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/Model/Reaction/InitialSpeciesCounts&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">dims</span><span class="p">,</span><span class="w"> </span><span class="n">H5T_STD_U32LE</span><span class="p">,</span><span class="w"> </span><span class="n">reactionModel</span><span class="o">-&gt;</span><span class="n">initial_species_count</span><span class="p">().</span><span class="n">data</span><span class="p">()));</span>
<span class="linenos"> 504</span>
<span class="linenos"> 505</span><span class="w">    </span><span class="c1">// If we have any reactions, write out the reaction tables.</span>
<span class="linenos"> 506</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">reactionModel</span><span class="o">-&gt;</span><span class="n">number_reactions</span><span class="p">())</span>
<span class="linenos"> 507</span><span class="w">    </span><span class="p">{</span>
<span class="linenos"> 508</span><span class="w">        </span><span class="c1">// Write the reaction tables.</span>
<span class="linenos"> 509</span><span class="w">        </span><span class="n">uint</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">types</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">uint</span><span class="p">[</span><span class="n">numberReactions</span><span class="p">];</span>
<span class="linenos"> 510</span><span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">constants</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">double</span><span class="p">[</span><span class="n">numberReactions</span><span class="o">*</span><span class="n">MAX_REACTION_RATE_CONSTANTS</span><span class="p">];</span>
<span class="linenos"> 511</span><span class="w">        </span><span class="kt">bool</span><span class="w"> </span><span class="n">hasNoiseTable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="linenos"> 512</span><span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="n">uint</span><span class="w"> </span><span class="n">NUMBER_NOISE_COLS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<span class="linenos"> 513</span><span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">noiseTerms</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">double</span><span class="p">[</span><span class="n">numberReactions</span><span class="o">*</span><span class="n">NUMBER_NOISE_COLS</span><span class="p">];</span>
<span class="linenos"> 514</span><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">numberReactions</span><span class="o">*</span><span class="n">NUMBER_NOISE_COLS</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="n">noiseTerms</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>
<span class="linenos"> 515</span><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">numberReactions</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="linenos"> 516</span><span class="w">        </span><span class="p">{</span>
<span class="linenos"> 517</span><span class="w">            </span><span class="n">types</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">reactionModel</span><span class="o">-&gt;</span><span class="n">reaction</span><span class="p">(</span><span class="n">i</span><span class="p">).</span><span class="n">type</span><span class="p">();</span>
<span class="linenos"> 518</span><span class="w">            </span><span class="n">uint</span><span class="w"> </span><span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<span class="linenos"> 519</span><span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(;</span><span class="w"> </span><span class="n">j</span><span class="o">&lt;</span><span class="p">(</span><span class="n">uint</span><span class="p">)(</span><span class="n">reactionModel</span><span class="o">-&gt;</span><span class="n">reaction</span><span class="p">(</span><span class="n">i</span><span class="p">).</span><span class="n">rate_constant_size</span><span class="p">())</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">j</span><span class="o">&lt;</span><span class="n">MAX_REACTION_RATE_CONSTANTS</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">++</span><span class="p">)</span>
<span class="linenos"> 520</span><span class="w">                </span><span class="n">constants</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="n">MAX_REACTION_RATE_CONSTANTS</span><span class="o">+</span><span class="n">j</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">reactionModel</span><span class="o">-&gt;</span><span class="n">reaction</span><span class="p">(</span><span class="n">i</span><span class="p">).</span><span class="n">rate_constant</span><span class="p">(</span><span class="n">j</span><span class="p">);</span>
<span class="linenos"> 521</span><span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(;</span><span class="w"> </span><span class="n">j</span><span class="o">&lt;</span><span class="n">MAX_REACTION_RATE_CONSTANTS</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">++</span><span class="p">)</span>
<span class="linenos"> 522</span><span class="w">                </span><span class="n">constants</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="n">MAX_REACTION_RATE_CONSTANTS</span><span class="o">+</span><span class="n">j</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NAN</span><span class="p">;</span>
<span class="linenos"> 523</span>
<span class="linenos"> 524</span><span class="w">            </span><span class="c1">// If we have noise terms, fill them in and mark that we need to create the noise table.</span>
<span class="linenos"> 525</span><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">reactionModel</span><span class="o">-&gt;</span><span class="n">reaction</span><span class="p">(</span><span class="n">i</span><span class="p">).</span><span class="n">rate_has_noise</span><span class="p">())</span>
<span class="linenos"> 526</span><span class="w">            </span><span class="p">{</span>
<span class="linenos"> 527</span><span class="w">                </span><span class="n">hasNoiseTable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="linenos"> 528</span><span class="w">                </span><span class="n">noiseTerms</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="n">NUMBER_NOISE_COLS</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">reactionModel</span><span class="o">-&gt;</span><span class="n">reaction</span><span class="p">(</span><span class="n">i</span><span class="p">).</span><span class="n">rate_noise_variance</span><span class="p">();</span>
<span class="linenos"> 529</span><span class="w">                </span><span class="n">noiseTerms</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="n">NUMBER_NOISE_COLS</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">reactionModel</span><span class="o">-&gt;</span><span class="n">reaction</span><span class="p">(</span><span class="n">i</span><span class="p">).</span><span class="n">rate_noise_tau</span><span class="p">();</span>
<span class="linenos"> 530</span><span class="w">            </span><span class="p">}</span>
<span class="linenos"> 531</span><span class="w">        </span><span class="p">}</span>
<span class="linenos"> 532</span><span class="w">        </span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">numberReactions</span><span class="p">;</span>
<span class="linenos"> 533</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5LTmake_dataset</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/Model/Reaction/ReactionTypes&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">dims</span><span class="p">,</span><span class="w"> </span><span class="n">H5T_STD_U32LE</span><span class="p">,</span><span class="w"> </span><span class="n">types</span><span class="p">));</span>
<span class="linenos"> 534</span><span class="w">        </span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">numberReactions</span><span class="p">;</span>
<span class="linenos"> 535</span><span class="w">        </span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MAX_REACTION_RATE_CONSTANTS</span><span class="p">;</span>
<span class="linenos"> 536</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5LTmake_dataset</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/Model/Reaction/ReactionRateConstants&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">dims</span><span class="p">,</span><span class="w"> </span><span class="n">H5T_IEEE_F64LE</span><span class="p">,</span><span class="w"> </span><span class="n">constants</span><span class="p">));</span>
<span class="linenos"> 537</span>
<span class="linenos"> 538</span><span class="w">        </span><span class="c1">// If necessary, create the noise table.</span>
<span class="linenos"> 539</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">hasNoiseTable</span><span class="p">)</span>
<span class="linenos"> 540</span><span class="w">        </span><span class="p">{</span>
<span class="linenos"> 541</span><span class="w">            </span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">numberReactions</span><span class="p">;</span>
<span class="linenos"> 542</span><span class="w">            </span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NUMBER_NOISE_COLS</span><span class="p">;</span>
<span class="linenos"> 543</span><span class="w">            </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5LTmake_dataset</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/Model/Reaction/ReactionRateNoise&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">dims</span><span class="p">,</span><span class="w"> </span><span class="n">H5T_IEEE_F64LE</span><span class="p">,</span><span class="w"> </span><span class="n">noiseTerms</span><span class="p">));</span>
<span class="linenos"> 544</span><span class="w">        </span><span class="p">}</span>
<span class="linenos"> 545</span><span class="w">        </span><span class="k">delete</span><span class="w"> </span><span class="p">[]</span><span class="w"> </span><span class="n">noiseTerms</span><span class="p">;</span>
<span class="linenos"> 546</span><span class="w">        </span><span class="k">delete</span><span class="w"> </span><span class="p">[]</span><span class="w"> </span><span class="n">constants</span><span class="p">;</span>
<span class="linenos"> 547</span><span class="w">        </span><span class="k">delete</span><span class="w"> </span><span class="p">[]</span><span class="w"> </span><span class="n">types</span><span class="p">;</span>
<span class="linenos"> 548</span>
<span class="linenos"> 549</span><span class="w">        </span><span class="c1">// Write the matrices.</span>
<span class="linenos"> 550</span><span class="w">        </span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">numberSpecies</span><span class="p">;</span>
<span class="linenos"> 551</span><span class="w">        </span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">numberReactions</span><span class="p">;</span>
<span class="linenos"> 552</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5LTmake_dataset</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/Model/Reaction/StoichiometricMatrix&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">dims</span><span class="p">,</span><span class="w"> </span><span class="n">H5T_STD_I32LE</span><span class="p">,</span><span class="w"> </span><span class="n">reactionModel</span><span class="o">-&gt;</span><span class="n">stoichiometric_matrix</span><span class="p">().</span><span class="n">data</span><span class="p">()));</span>
<span class="linenos"> 553</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5LTmake_dataset</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/Model/Reaction/DependencyMatrix&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">dims</span><span class="p">,</span><span class="w"> </span><span class="n">H5T_STD_U32LE</span><span class="p">,</span><span class="w"> </span><span class="n">reactionModel</span><span class="o">-&gt;</span><span class="n">dependency_matrix</span><span class="p">().</span><span class="n">data</span><span class="p">()));</span>
<span class="linenos"> 554</span><span class="w">    </span><span class="p">}</span>
<span class="linenos"> 555</span><span class="p">}</span>
<span class="linenos"> 556</span>
<span class="linenos"> 557</span><span class="kt">void</span><span class="w"> </span><span class="n">SimulationFile</span><span class="o">::</span><span class="n">getDiffusionModel</span><span class="p">(</span><span class="n">lm</span><span class="o">::</span><span class="n">io</span><span class="o">::</span><span class="n">DiffusionModel</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">diffusionModel</span><span class="p">)</span>
<span class="linenos"> 558</span><span class="p">{</span>
<span class="linenos"> 559</span><span class="w">    </span><span class="c1">// Make sure the model is not null and then clear it.</span>
<span class="linenos"> 560</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">diffusionModel</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="n">InvalidArgException</span><span class="p">(</span><span class="s">&quot;diffusionModel&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;cannot be null&quot;</span><span class="p">);</span>
<span class="linenos"> 561</span><span class="w">    </span><span class="n">diffusionModel</span><span class="o">-&gt;</span><span class="n">Clear</span><span class="p">();</span>
<span class="linenos"> 562</span>
<span class="linenos"> 563</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">H5Lexists</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/Model/Diffusion&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">))</span>
<span class="linenos"> 564</span><span class="w">    </span><span class="p">{</span>
<span class="linenos"> 565</span><span class="w">        </span><span class="c1">// Read the diffusion model attributes.</span>
<span class="linenos"> 566</span><span class="w">        </span><span class="n">uint</span><span class="w"> </span><span class="n">numberSpecies</span><span class="p">,</span><span class="w"> </span><span class="n">numberReactions</span><span class="p">,</span><span class="w"> </span><span class="n">numberSiteTypes</span><span class="p">,</span><span class="w"> </span><span class="n">latticeXSize</span><span class="p">,</span><span class="w"> </span><span class="n">latticeYSize</span><span class="p">,</span><span class="w"> </span><span class="n">latticeZSize</span><span class="p">,</span><span class="w"> </span><span class="n">particlesPerSite</span><span class="p">;</span>
<span class="linenos"> 567</span><span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">latticeSpacing</span><span class="p">;</span>
<span class="linenos"> 568</span><span class="w">		</span><span class="n">uint</span><span class="w"> </span><span class="n">bytes_per_particle</span><span class="p">;</span>
<span class="linenos"> 569</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5LTget_attribute_uint</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/Model/Diffusion&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;numberSpecies&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">numberSpecies</span><span class="p">));</span>
<span class="linenos"> 570</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5LTget_attribute_uint</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/Model/Diffusion&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;numberReactions&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">numberReactions</span><span class="p">));</span>
<span class="linenos"> 571</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5LTget_attribute_uint</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/Model/Diffusion&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;numberSiteTypes&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">numberSiteTypes</span><span class="p">));</span>
<span class="linenos"> 572</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5LTget_attribute_double</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/Model/Diffusion&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;latticeSpacing&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">latticeSpacing</span><span class="p">));</span>
<span class="linenos"> 573</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5LTget_attribute_uint</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/Model/Diffusion&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;latticeXSize&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">latticeXSize</span><span class="p">));</span>
<span class="linenos"> 574</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5LTget_attribute_uint</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/Model/Diffusion&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;latticeYSize&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">latticeYSize</span><span class="p">));</span>
<span class="linenos"> 575</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5LTget_attribute_uint</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/Model/Diffusion&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;latticeZSize&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">latticeZSize</span><span class="p">));</span>
<span class="linenos"> 576</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5LTget_attribute_uint</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/Model/Diffusion&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;particlesPerSite&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">particlesPerSite</span><span class="p">));</span>
<span class="linenos"> 577</span><span class="w">		</span><span class="k">if</span><span class="p">(</span><span class="n">H5LTget_attribute_uint</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/Model/Diffusion&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;bytes_per_particle&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">bytes_per_particle</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="linenos"> 578</span><span class="w">		</span><span class="p">{</span>
<span class="linenos"> 579</span><span class="w">			</span><span class="c1">// Must not have existed, assume byte lattice</span>
<span class="linenos"> 580</span><span class="w">			</span><span class="n">bytes_per_particle</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
<span class="linenos"> 581</span><span class="w">		</span><span class="p">}</span>
<span class="linenos"> 582</span>
<span class="linenos"> 583</span><span class="w">        </span><span class="c1">// Fill in the model.</span>
<span class="linenos"> 584</span><span class="w">        </span><span class="n">diffusionModel</span><span class="o">-&gt;</span><span class="n">set_number_species</span><span class="p">(</span><span class="n">numberSpecies</span><span class="p">);</span>
<span class="linenos"> 585</span><span class="w">        </span><span class="n">diffusionModel</span><span class="o">-&gt;</span><span class="n">set_number_reactions</span><span class="p">(</span><span class="n">numberReactions</span><span class="p">);</span>
<span class="linenos"> 586</span><span class="w">        </span><span class="n">diffusionModel</span><span class="o">-&gt;</span><span class="n">set_number_site_types</span><span class="p">(</span><span class="n">numberSiteTypes</span><span class="p">);</span>
<span class="linenos"> 587</span><span class="w">        </span><span class="n">diffusionModel</span><span class="o">-&gt;</span><span class="n">set_lattice_spacing</span><span class="p">(</span><span class="n">latticeSpacing</span><span class="p">);</span>
<span class="linenos"> 588</span><span class="w">        </span><span class="n">diffusionModel</span><span class="o">-&gt;</span><span class="n">set_lattice_x_size</span><span class="p">(</span><span class="n">latticeXSize</span><span class="p">);</span>
<span class="linenos"> 589</span><span class="w">        </span><span class="n">diffusionModel</span><span class="o">-&gt;</span><span class="n">set_lattice_y_size</span><span class="p">(</span><span class="n">latticeYSize</span><span class="p">);</span>
<span class="linenos"> 590</span><span class="w">        </span><span class="n">diffusionModel</span><span class="o">-&gt;</span><span class="n">set_lattice_z_size</span><span class="p">(</span><span class="n">latticeZSize</span><span class="p">);</span>
<span class="linenos"> 591</span><span class="w">        </span><span class="n">diffusionModel</span><span class="o">-&gt;</span><span class="n">set_particles_per_site</span><span class="p">(</span><span class="n">particlesPerSite</span><span class="p">);</span>
<span class="linenos"> 592</span><span class="w">        </span><span class="n">diffusionModel</span><span class="o">-&gt;</span><span class="n">set_bytes_per_particle</span><span class="p">(</span><span class="n">bytes_per_particle</span><span class="p">);</span>
<span class="linenos"> 593</span>
<span class="linenos"> 594</span><span class="w">        </span><span class="n">hsize_t</span><span class="w"> </span><span class="n">dims</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
<span class="linenos"> 595</span><span class="w">        </span><span class="n">H5T_class_t</span><span class="w"> </span><span class="n">type</span><span class="p">;</span>
<span class="linenos"> 596</span><span class="w">        </span><span class="kt">size_t</span><span class="w"> </span><span class="n">size</span><span class="p">;</span>
<span class="linenos"> 597</span>
<span class="linenos"> 598</span><span class="w">        </span><span class="c1">// Read the diffusion matrix.</span>
<span class="linenos"> 599</span><span class="w">        </span><span class="n">H5LTget_dataset_info</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/Model/Diffusion/DiffusionMatrix&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">dims</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">size</span><span class="p">);</span>
<span class="linenos"> 600</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">numberSiteTypes</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">numberSiteTypes</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">dims</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">numberSpecies</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">double</span><span class="p">))</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="n">Exception</span><span class="p">(</span><span class="s">&quot;Invalid dataset dimensions&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">filename</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot;/Model/Diffusion/DiffusionMatrix&quot;</span><span class="p">);</span>
<span class="linenos"> 601</span><span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">D</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">double</span><span class="p">[</span><span class="n">numberSiteTypes</span><span class="o">*</span><span class="n">numberSiteTypes</span><span class="o">*</span><span class="n">numberSpecies</span><span class="p">];</span>
<span class="linenos"> 602</span><span class="w">        </span><span class="n">H5LTread_dataset_double</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/Model/Diffusion/DiffusionMatrix&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="p">);</span>
<span class="linenos"> 603</span><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">numberSiteTypes</span><span class="o">*</span><span class="n">numberSiteTypes</span><span class="o">*</span><span class="n">numberSpecies</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="n">diffusionModel</span><span class="o">-&gt;</span><span class="n">add_diffusion_matrix</span><span class="p">(</span><span class="n">D</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="linenos"> 604</span><span class="w">        </span><span class="k">delete</span><span class="w"> </span><span class="p">[]</span><span class="w"> </span><span class="n">D</span><span class="p">;</span>
<span class="linenos"> 605</span>
<span class="linenos"> 606</span><span class="w">        </span><span class="c1">// If we have reactions, read the reaction location matrix.</span>
<span class="linenos"> 607</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">numberReactions</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="linenos"> 608</span><span class="w">        </span><span class="p">{</span>
<span class="linenos"> 609</span><span class="w">            </span><span class="n">H5LTget_dataset_info</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/Model/Diffusion/ReactionLocationMatrix&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">dims</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">size</span><span class="p">);</span>
<span class="linenos"> 610</span><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">numberReactions</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">numberSiteTypes</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">uint</span><span class="p">))</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="n">Exception</span><span class="p">(</span><span class="s">&quot;Invalid dataset dimensions&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">filename</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot;/Model/Diffusion/ReactionLocationMatrix&quot;</span><span class="p">);</span>
<span class="linenos"> 611</span><span class="w">            </span><span class="n">uint</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">RL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">uint</span><span class="p">[</span><span class="n">numberReactions</span><span class="o">*</span><span class="n">numberSiteTypes</span><span class="p">];</span>
<span class="linenos"> 612</span><span class="w">			</span><span class="n">H5LTread_dataset</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/Model/Diffusion/ReactionLocationMatrix&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">H5T_STD_U32LE</span><span class="p">,</span><span class="w"> </span><span class="n">RL</span><span class="p">);</span>
<span class="linenos"> 613</span><span class="w">			</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">numberReactions</span><span class="o">*</span><span class="n">numberSiteTypes</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="n">diffusionModel</span><span class="o">-&gt;</span><span class="n">add_reaction_location_matrix</span><span class="p">(</span><span class="n">RL</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="linenos"> 614</span><span class="w">	        </span><span class="k">delete</span><span class="w"> </span><span class="p">[]</span><span class="w"> </span><span class="n">RL</span><span class="p">;</span>
<span class="linenos"> 615</span><span class="w">        </span><span class="p">}</span>
<span class="linenos"> 616</span><span class="w">    </span><span class="p">}</span>
<span class="linenos"> 617</span><span class="p">}</span>
<span class="linenos"> 618</span>
<span class="linenos"> 619</span><span class="kt">void</span><span class="w"> </span><span class="n">SimulationFile</span><span class="o">::</span><span class="n">getDiffusionModelLattice</span><span class="p">(</span><span class="n">lm</span><span class="o">::</span><span class="n">io</span><span class="o">::</span><span class="n">DiffusionModel</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">lattice</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">latticeSize</span><span class="p">,</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">latticeSites</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">latticeSitesSize</span><span class="p">)</span>
<span class="linenos"> 620</span><span class="p">{</span>
<span class="linenos"> 621</span><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">ndims</span><span class="p">;</span>
<span class="linenos"> 622</span><span class="w">    </span><span class="n">hsize_t</span><span class="w"> </span><span class="n">dims</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
<span class="linenos"> 623</span><span class="w">    </span><span class="n">H5T_class_t</span><span class="w"> </span><span class="n">type</span><span class="p">;</span>
<span class="linenos"> 624</span><span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">size</span><span class="p">;</span>
<span class="linenos"> 625</span>
<span class="linenos"> 626</span><span class="w">    </span><span class="c1">// Read the lattice.</span>
<span class="linenos"> 627</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">lattice</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span>
<span class="linenos"> 628</span><span class="w">    </span><span class="p">{</span>
<span class="linenos"> 629</span><span class="w">		</span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5LTget_dataset_ndims</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/Model/Diffusion/Lattice&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">ndims</span><span class="p">));</span>
<span class="linenos"> 630</span><span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ndims</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="n">Exception</span><span class="p">(</span><span class="s">&quot;Invalid dataset dimensions&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">filename</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot;/Model/Diffusion/Lattice&quot;</span><span class="p">);</span>
<span class="linenos"> 631</span><span class="w">		</span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5LTget_dataset_info</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/Model/Diffusion/Lattice&quot;</span><span class="p">,</span><span class="n">dims</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">size</span><span class="p">));</span>
<span class="linenos"> 632</span><span class="w">		</span><span class="k">switch</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">bytes_per_particle</span><span class="p">())</span>
<span class="linenos"> 633</span><span class="w">		</span><span class="p">{</span>
<span class="linenos"> 634</span><span class="w">			</span><span class="k">case</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span>
<span class="linenos"> 635</span><span class="w">				</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">lattice_x_size</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">m</span><span class="o">-&gt;</span><span class="n">lattice_y_size</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">m</span><span class="o">-&gt;</span><span class="n">lattice_z_size</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">dims</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">m</span><span class="o">-&gt;</span><span class="n">particles_per_site</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">dims</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">uint8_t</span><span class="p">))</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="n">Exception</span><span class="p">(</span><span class="s">&quot;Invalid dataset dimensions&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">filename</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot;/Model/Diffusion/Lattice&quot;</span><span class="p">);</span>
<span class="linenos"> 636</span><span class="w">				</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">dims</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">dims</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">latticeSize</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="n">InvalidArgException</span><span class="p">(</span><span class="s">&quot;lattice&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;incorrect lattice size&quot;</span><span class="p">);</span>
<span class="linenos"> 637</span><span class="w">				</span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5LTread_dataset</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/Model/Diffusion/Lattice&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">H5T_NATIVE_UINT8</span><span class="p">,</span><span class="w"> </span><span class="n">lattice</span><span class="p">));</span>
<span class="linenos"> 638</span><span class="w">				</span><span class="k">break</span><span class="p">;</span>
<span class="linenos"> 639</span><span class="w">			</span><span class="k">case</span><span class="w"> </span><span class="mi">4</span><span class="p">:</span>
<span class="linenos"> 640</span><span class="w">				</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">lattice_x_size</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">m</span><span class="o">-&gt;</span><span class="n">lattice_y_size</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">m</span><span class="o">-&gt;</span><span class="n">lattice_z_size</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">dims</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">m</span><span class="o">-&gt;</span><span class="n">particles_per_site</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">dims</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">))</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="n">Exception</span><span class="p">(</span><span class="s">&quot;Invalid dataset dimensions&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">filename</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot;/Model/Diffusion/Lattice&quot;</span><span class="p">);</span>
<span class="linenos"> 641</span><span class="w">				</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">dims</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">dims</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="n">size</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">latticeSize</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="n">InvalidArgException</span><span class="p">(</span><span class="s">&quot;lattice&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;incorrect lattice size&quot;</span><span class="p">);</span>
<span class="linenos"> 642</span><span class="w">				</span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5LTread_dataset</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/Model/Diffusion/Lattice&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">H5T_NATIVE_UINT32</span><span class="p">,</span><span class="w"> </span><span class="n">lattice</span><span class="p">));</span>
<span class="linenos"> 643</span><span class="w">				</span><span class="k">break</span><span class="p">;</span>
<span class="linenos"> 644</span><span class="w">			</span><span class="k">default</span><span class="o">:</span>
<span class="linenos"> 645</span><span class="w">				</span><span class="k">throw</span><span class="w"> </span><span class="n">Exception</span><span class="p">(</span><span class="s">&quot;Unknown bytes per particle&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">m</span><span class="o">-&gt;</span><span class="n">bytes_per_particle</span><span class="p">());</span>
<span class="linenos"> 646</span><span class="w">		</span><span class="p">}</span>
<span class="linenos"> 647</span><span class="w">    </span><span class="p">}</span>
<span class="linenos"> 648</span>
<span class="linenos"> 649</span><span class="w">    </span><span class="c1">// Read the lattice sites.</span>
<span class="linenos"> 650</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">latticeSites</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span>
<span class="linenos"> 651</span><span class="w">    </span><span class="p">{</span>
<span class="linenos"> 652</span><span class="w">		</span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5LTget_dataset_ndims</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/Model/Diffusion/LatticeSites&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">ndims</span><span class="p">));</span>
<span class="linenos"> 653</span><span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ndims</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="n">Exception</span><span class="p">(</span><span class="s">&quot;Invalid dataset dimensions&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">filename</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot;/Model/Diffusion/LatticeSites&quot;</span><span class="p">);</span>
<span class="linenos"> 654</span><span class="w">		</span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5LTget_dataset_info</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/Model/Diffusion/LatticeSites&quot;</span><span class="p">,</span><span class="n">dims</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">size</span><span class="p">));</span>
<span class="linenos"> 655</span><span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">lattice_x_size</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">m</span><span class="o">-&gt;</span><span class="n">lattice_y_size</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">m</span><span class="o">-&gt;</span><span class="n">lattice_z_size</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">dims</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">uint8_t</span><span class="p">))</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="n">Exception</span><span class="p">(</span><span class="s">&quot;Invalid dataset dimensions&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">filename</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot;/Model/Diffusion/LatticeSites&quot;</span><span class="p">);</span>
<span class="linenos"> 656</span><span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">dims</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">latticeSitesSize</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="n">InvalidArgException</span><span class="p">(</span><span class="s">&quot;latticeSites&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;insufficient size&quot;</span><span class="p">);</span>
<span class="linenos"> 657</span><span class="w">		</span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5LTread_dataset</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/Model/Diffusion/LatticeSites&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">H5T_NATIVE_UINT8</span><span class="p">,</span><span class="w"> </span><span class="n">latticeSites</span><span class="p">));</span>
<span class="linenos"> 658</span><span class="w">    </span><span class="p">}</span>
<span class="linenos"> 659</span><span class="p">}</span>
<span class="linenos"> 660</span>
<span class="linenos"> 661</span><span class="kt">void</span><span class="w"> </span><span class="n">SimulationFile</span><span class="o">::</span><span class="n">getDiffusionModelLattice</span><span class="p">(</span><span class="n">lm</span><span class="o">::</span><span class="n">io</span><span class="o">::</span><span class="n">DiffusionModel</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="n">lm</span><span class="o">::</span><span class="n">rdme</span><span class="o">::</span><span class="n">Lattice</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">lattice</span><span class="p">)</span>
<span class="linenos"> 662</span><span class="p">{</span>
<span class="linenos"> 663</span><span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getXSize</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">m</span><span class="o">-&gt;</span><span class="n">lattice_x_size</span><span class="p">()</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getYSize</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">m</span><span class="o">-&gt;</span><span class="n">lattice_y_size</span><span class="p">()</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getZSize</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">m</span><span class="o">-&gt;</span><span class="n">lattice_z_size</span><span class="p">()</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getMaxOccupancy</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">m</span><span class="o">-&gt;</span><span class="n">particles_per_site</span><span class="p">())</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="n">InvalidArgException</span><span class="p">(</span><span class="s">&quot;lattice&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;lattice size not consistent with the diffusion model&quot;</span><span class="p">);</span>
<span class="linenos"> 664</span>
<span class="linenos"> 665</span><span class="w">	</span><span class="kt">int</span><span class="w"> </span><span class="n">ndims</span><span class="p">;</span>
<span class="linenos"> 666</span><span class="w">    </span><span class="n">hsize_t</span><span class="w"> </span><span class="n">dims</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
<span class="linenos"> 667</span><span class="w">    </span><span class="n">H5T_class_t</span><span class="w"> </span><span class="n">type</span><span class="p">;</span>
<span class="linenos"> 668</span><span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">size</span><span class="p">;</span>
<span class="linenos"> 669</span>
<span class="linenos"> 670</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">lattice</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span>
<span class="linenos"> 671</span><span class="w">    </span><span class="p">{</span>
<span class="linenos"> 672</span><span class="w">        </span><span class="c1">// Read the lattice.</span>
<span class="linenos"> 673</span><span class="w">		</span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5LTget_dataset_ndims</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/Model/Diffusion/Lattice&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">ndims</span><span class="p">));</span>
<span class="linenos"> 674</span><span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ndims</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="n">Exception</span><span class="p">(</span><span class="s">&quot;Invalid dataset dimensions&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">filename</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot;/Model/Diffusion/Lattice&quot;</span><span class="p">);</span>
<span class="linenos"> 675</span><span class="w">		</span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5LTget_dataset_info</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/Model/Diffusion/Lattice&quot;</span><span class="p">,</span><span class="n">dims</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">size</span><span class="p">));</span>
<span class="linenos"> 676</span><span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">lattice_x_size</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">m</span><span class="o">-&gt;</span><span class="n">lattice_y_size</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">m</span><span class="o">-&gt;</span><span class="n">lattice_z_size</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">dims</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">m</span><span class="o">-&gt;</span><span class="n">particles_per_site</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">dims</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">uint8_t</span><span class="p">))</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="n">Exception</span><span class="p">(</span><span class="s">&quot;Invalid dataset dimensions&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">filename</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot;/Model/Diffusion/Lattice&quot;</span><span class="p">);</span>
<span class="linenos"> 677</span><span class="w">	    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">latticeDataSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">dims</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">dims</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
<span class="linenos"> 678</span><span class="w">	    </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">latticeData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">uint8_t</span><span class="p">[</span><span class="n">latticeDataSize</span><span class="p">];</span>
<span class="linenos"> 679</span><span class="w">		</span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5LTread_dataset</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/Model/Diffusion/Lattice&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">H5T_NATIVE_UINT8</span><span class="p">,</span><span class="w"> </span><span class="n">latticeData</span><span class="p">));</span>
<span class="linenos"> 680</span><span class="w">		</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">setFromRowMajorByteData</span><span class="p">(</span><span class="n">latticeData</span><span class="p">,</span><span class="w"> </span><span class="n">latticeDataSize</span><span class="p">);</span>
<span class="linenos"> 681</span><span class="w">		</span><span class="k">delete</span><span class="w"> </span><span class="p">[]</span><span class="w"> </span><span class="n">latticeData</span><span class="p">;</span>
<span class="linenos"> 682</span>
<span class="linenos"> 683</span><span class="w">		</span><span class="c1">// Read the lattice sites.</span>
<span class="linenos"> 684</span><span class="w">		</span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5LTget_dataset_ndims</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/Model/Diffusion/LatticeSites&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">ndims</span><span class="p">));</span>
<span class="linenos"> 685</span><span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ndims</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="n">Exception</span><span class="p">(</span><span class="s">&quot;Invalid dataset dimensions&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">filename</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot;/Model/Diffusion/LatticeSites&quot;</span><span class="p">);</span>
<span class="linenos"> 686</span><span class="w">		</span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5LTget_dataset_info</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/Model/Diffusion/LatticeSites&quot;</span><span class="p">,</span><span class="n">dims</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">size</span><span class="p">));</span>
<span class="linenos"> 687</span><span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">lattice_x_size</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">m</span><span class="o">-&gt;</span><span class="n">lattice_y_size</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">m</span><span class="o">-&gt;</span><span class="n">lattice_z_size</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">dims</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">uint8_t</span><span class="p">))</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="n">Exception</span><span class="p">(</span><span class="s">&quot;Invalid dataset dimensions&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">filename</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot;/Model/Diffusion/LatticeSites&quot;</span><span class="p">);</span>
<span class="linenos"> 688</span><span class="w">	    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">latticeSitesSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">dims</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<span class="linenos"> 689</span><span class="w">	    </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">latticeSites</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">uint8_t</span><span class="p">[</span><span class="n">latticeSitesSize</span><span class="p">];</span>
<span class="linenos"> 690</span><span class="w">		</span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5LTread_dataset</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/Model/Diffusion/LatticeSites&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">H5T_NATIVE_UINT8</span><span class="p">,</span><span class="w"> </span><span class="n">latticeSites</span><span class="p">));</span>
<span class="linenos"> 691</span><span class="w">		</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">setSitesFromRowMajorByteData</span><span class="p">(</span><span class="n">latticeSites</span><span class="p">,</span><span class="w"> </span><span class="n">latticeSitesSize</span><span class="p">);</span>
<span class="linenos"> 692</span><span class="w">		</span><span class="k">delete</span><span class="w"> </span><span class="p">[]</span><span class="w"> </span><span class="n">latticeSites</span><span class="p">;</span>
<span class="linenos"> 693</span><span class="w">    </span><span class="p">}</span>
<span class="linenos"> 694</span><span class="p">}</span>
<span class="linenos"> 695</span>
<span class="linenos"> 696</span><span class="kt">void</span><span class="w"> </span><span class="n">SimulationFile</span><span class="o">::</span><span class="n">setDiffusionModel</span><span class="p">(</span><span class="n">lm</span><span class="o">::</span><span class="n">io</span><span class="o">::</span><span class="n">DiffusionModel</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">diffusionModel</span><span class="p">)</span>
<span class="linenos"> 697</span><span class="p">{</span>
<span class="linenos"> 698</span><span class="w">    </span><span class="c1">// Validate that the model is consistent.</span>
<span class="linenos"> 699</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">diffusionModel</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="n">InvalidArgException</span><span class="p">(</span><span class="s">&quot;diffusionModel&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;cannot be NULL&quot;</span><span class="p">);</span>
<span class="linenos"> 700</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">diffusionModel</span><span class="o">-&gt;</span><span class="n">number_species</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="n">InvalidArgException</span><span class="p">(</span><span class="s">&quot;diffusionModel.number_species&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;cannot be zero&quot;</span><span class="p">);</span>
<span class="linenos"> 701</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">diffusionModel</span><span class="o">-&gt;</span><span class="n">number_site_types</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="n">InvalidArgException</span><span class="p">(</span><span class="s">&quot;diffusionModel.number_site_types&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;cannot be zero&quot;</span><span class="p">);</span>
<span class="linenos"> 702</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">diffusionModel</span><span class="o">-&gt;</span><span class="n">diffusion_matrix_size</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">diffusionModel</span><span class="o">-&gt;</span><span class="n">number_site_types</span><span class="p">()</span><span class="o">*</span><span class="n">diffusionModel</span><span class="o">-&gt;</span><span class="n">number_site_types</span><span class="p">()</span><span class="o">*</span><span class="n">diffusionModel</span><span class="o">-&gt;</span><span class="n">number_species</span><span class="p">()))</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="n">InvalidArgException</span><span class="p">(</span><span class="s">&quot;diffusion.diffusion_matrix&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;inconsistent size&quot;</span><span class="p">);</span>
<span class="linenos"> 703</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">diffusionModel</span><span class="o">-&gt;</span><span class="n">reaction_location_matrix_size</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">diffusionModel</span><span class="o">-&gt;</span><span class="n">number_reactions</span><span class="p">()</span><span class="o">*</span><span class="n">diffusionModel</span><span class="o">-&gt;</span><span class="n">number_site_types</span><span class="p">()))</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="n">InvalidArgException</span><span class="p">(</span><span class="s">&quot;diffusion.reaction_location_matrix&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;inconsistent size&quot;</span><span class="p">);</span>
<span class="linenos"> 704</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">diffusionModel</span><span class="o">-&gt;</span><span class="n">lattice_spacing</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="n">InvalidArgException</span><span class="p">(</span><span class="s">&quot;diffusionModel.lattice_spacing&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;must be greater than zero&quot;</span><span class="p">);</span>
<span class="linenos"> 705</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">diffusionModel</span><span class="o">-&gt;</span><span class="n">lattice_x_size</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="n">InvalidArgException</span><span class="p">(</span><span class="s">&quot;diffusionModel.lattice_x_size&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;cannot be zero&quot;</span><span class="p">);</span>
<span class="linenos"> 706</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">diffusionModel</span><span class="o">-&gt;</span><span class="n">lattice_y_size</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="n">InvalidArgException</span><span class="p">(</span><span class="s">&quot;diffusionModel.lattice_y_size&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;cannot be zero&quot;</span><span class="p">);</span>
<span class="linenos"> 707</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">diffusionModel</span><span class="o">-&gt;</span><span class="n">lattice_z_size</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="n">InvalidArgException</span><span class="p">(</span><span class="s">&quot;diffusionModel.lattice_z_size&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;cannot be zero&quot;</span><span class="p">);</span>
<span class="linenos"> 708</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">diffusionModel</span><span class="o">-&gt;</span><span class="n">particles_per_site</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="n">InvalidArgException</span><span class="p">(</span><span class="s">&quot;diffusionModel.particles_per_site&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;cannot be zero&quot;</span><span class="p">);</span>
<span class="linenos"> 709</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">diffusionModel</span><span class="o">-&gt;</span><span class="n">bytes_per_particle</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="n">InvalidArgException</span><span class="p">(</span><span class="s">&quot;diffusionModel.bytes_per_particle&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;cannot be zero&quot;</span><span class="p">);</span>
<span class="linenos"> 710</span>
<span class="linenos"> 711</span><span class="w">    </span><span class="c1">// If a diffusion model already exists, delete it.</span>
<span class="linenos"> 712</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">H5Lexists</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/Model/Diffusion&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">))</span>
<span class="linenos"> 713</span><span class="w">    </span><span class="p">{</span>
<span class="linenos"> 714</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Ldelete</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/Model/Diffusion&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">));</span>
<span class="linenos"> 715</span><span class="w">    </span><span class="p">}</span>
<span class="linenos"> 716</span>
<span class="linenos"> 717</span><span class="w">    </span><span class="c1">// Create the group for the reaction model.</span>
<span class="linenos"> 718</span><span class="w">    </span><span class="n">hid_t</span><span class="w"> </span><span class="n">group</span><span class="p">;</span>
<span class="linenos"> 719</span><span class="w">    </span><span class="n">HDF5_EXCEPTION_CALL</span><span class="p">(</span><span class="n">group</span><span class="p">,</span><span class="n">H5Gcreate2</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/Model/Diffusion&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">,</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">,</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">));</span>
<span class="linenos"> 720</span><span class="w">    </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Gclose</span><span class="p">(</span><span class="n">group</span><span class="p">));</span>
<span class="linenos"> 721</span>
<span class="linenos"> 722</span><span class="w">    </span><span class="c1">// Write the attributes.</span>
<span class="linenos"> 723</span><span class="w">    </span><span class="n">numberSpecies</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">diffusionModel</span><span class="o">-&gt;</span><span class="n">number_species</span><span class="p">();</span>
<span class="linenos"> 724</span><span class="w">    </span><span class="n">uint</span><span class="w"> </span><span class="n">numberReactions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">diffusionModel</span><span class="o">-&gt;</span><span class="n">number_reactions</span><span class="p">();</span>
<span class="linenos"> 725</span><span class="w">    </span><span class="n">uint</span><span class="w"> </span><span class="n">numberSiteTypes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">diffusionModel</span><span class="o">-&gt;</span><span class="n">number_site_types</span><span class="p">();</span>
<span class="linenos"> 726</span><span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">latticeSpacing</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">diffusionModel</span><span class="o">-&gt;</span><span class="n">lattice_spacing</span><span class="p">();</span>
<span class="linenos"> 727</span><span class="w">    </span><span class="n">uint</span><span class="w"> </span><span class="n">latticeXSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">diffusionModel</span><span class="o">-&gt;</span><span class="n">lattice_x_size</span><span class="p">();</span>
<span class="linenos"> 728</span><span class="w">    </span><span class="n">uint</span><span class="w"> </span><span class="n">latticeYSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">diffusionModel</span><span class="o">-&gt;</span><span class="n">lattice_y_size</span><span class="p">();</span>
<span class="linenos"> 729</span><span class="w">    </span><span class="n">uint</span><span class="w"> </span><span class="n">latticeZSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">diffusionModel</span><span class="o">-&gt;</span><span class="n">lattice_z_size</span><span class="p">();</span>
<span class="linenos"> 730</span><span class="w">    </span><span class="n">uint</span><span class="w"> </span><span class="n">particlesPerSite</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">diffusionModel</span><span class="o">-&gt;</span><span class="n">particles_per_site</span><span class="p">();</span>
<span class="linenos"> 731</span><span class="w">    </span><span class="n">uint</span><span class="w"> </span><span class="n">bytes_per_particle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">diffusionModel</span><span class="o">-&gt;</span><span class="n">bytes_per_particle</span><span class="p">();</span>
<span class="linenos"> 732</span><span class="w">    </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5LTset_attribute_uint</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/Model/Diffusion&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;numberSpecies&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">numberSpecies</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">));</span>
<span class="linenos"> 733</span><span class="w">    </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5LTset_attribute_uint</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/Model/Diffusion&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;numberReactions&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">numberReactions</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">));</span>
<span class="linenos"> 734</span><span class="w">    </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5LTset_attribute_uint</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/Model/Diffusion&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;numberSiteTypes&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">numberSiteTypes</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">));</span>
<span class="linenos"> 735</span><span class="w">    </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5LTset_attribute_double</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/Model/Diffusion&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;latticeSpacing&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">latticeSpacing</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">));</span>
<span class="linenos"> 736</span><span class="w">    </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5LTset_attribute_uint</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/Model/Diffusion&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;latticeXSize&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">latticeXSize</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">));</span>
<span class="linenos"> 737</span><span class="w">    </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5LTset_attribute_uint</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/Model/Diffusion&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;latticeYSize&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">latticeYSize</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">));</span>
<span class="linenos"> 738</span><span class="w">    </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5LTset_attribute_uint</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/Model/Diffusion&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;latticeZSize&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">latticeZSize</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">));</span>
<span class="linenos"> 739</span><span class="w">    </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5LTset_attribute_uint</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/Model/Diffusion&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;particlesPerSite&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">particlesPerSite</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">));</span>
<span class="linenos"> 740</span><span class="w">    </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5LTset_attribute_uint</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/Model/Diffusion&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;bytes_per_particle&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">bytes_per_particle</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">));</span>
<span class="linenos"> 741</span>
<span class="linenos"> 742</span><span class="w">    </span><span class="c1">// Write the diffusion matrix.</span>
<span class="linenos"> 743</span><span class="w">    </span><span class="p">{</span>
<span class="linenos"> 744</span><span class="w">		</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">RANK</span><span class="o">=</span><span class="mi">3</span><span class="p">;</span>
<span class="linenos"> 745</span><span class="w">		</span><span class="n">hsize_t</span><span class="w"> </span><span class="n">dims</span><span class="p">[</span><span class="n">RANK</span><span class="p">];</span>
<span class="linenos"> 746</span><span class="w">		</span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">numberSiteTypes</span><span class="p">;</span>
<span class="linenos"> 747</span><span class="w">		</span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">numberSiteTypes</span><span class="p">;</span>
<span class="linenos"> 748</span><span class="w">		</span><span class="n">dims</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">numberSpecies</span><span class="p">;</span>
<span class="linenos"> 749</span><span class="w">		</span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5LTmake_dataset</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/Model/Diffusion/DiffusionMatrix&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">RANK</span><span class="p">,</span><span class="w"> </span><span class="n">dims</span><span class="p">,</span><span class="w"> </span><span class="n">H5T_IEEE_F64LE</span><span class="p">,</span><span class="w"> </span><span class="n">diffusionModel</span><span class="o">-&gt;</span><span class="n">diffusion_matrix</span><span class="p">().</span><span class="n">data</span><span class="p">()));</span>
<span class="linenos"> 750</span><span class="w">	</span><span class="p">}</span>
<span class="linenos"> 751</span>
<span class="linenos"> 752</span><span class="w">    </span><span class="c1">// Write the reaction location matrix.</span>
<span class="linenos"> 753</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">numberReactions</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="linenos"> 754</span><span class="w">    </span><span class="p">{</span>
<span class="linenos"> 755</span><span class="w">		</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">RANK</span><span class="o">=</span><span class="mi">2</span><span class="p">;</span>
<span class="linenos"> 756</span><span class="w">		</span><span class="n">hsize_t</span><span class="w"> </span><span class="n">dims</span><span class="p">[</span><span class="n">RANK</span><span class="p">];</span>
<span class="linenos"> 757</span><span class="w">		</span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">numberReactions</span><span class="p">;</span>
<span class="linenos"> 758</span><span class="w">		</span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">numberSiteTypes</span><span class="p">;</span>
<span class="linenos"> 759</span><span class="w">		</span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5LTmake_dataset</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/Model/Diffusion/ReactionLocationMatrix&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">RANK</span><span class="p">,</span><span class="w"> </span><span class="n">dims</span><span class="p">,</span><span class="w"> </span><span class="n">H5T_STD_U32LE</span><span class="p">,</span><span class="w"> </span><span class="n">diffusionModel</span><span class="o">-&gt;</span><span class="n">reaction_location_matrix</span><span class="p">().</span><span class="n">data</span><span class="p">()));</span>
<span class="linenos"> 760</span><span class="w">    </span><span class="p">}</span>
<span class="linenos"> 761</span><span class="p">}</span>
<span class="linenos"> 762</span>
<span class="linenos"> 763</span><span class="kt">void</span><span class="w"> </span><span class="n">SimulationFile</span><span class="o">::</span><span class="n">writeParticleLattice_U8LE</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">path</span><span class="p">,</span><span class="w">  </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">z</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">w</span><span class="p">)</span>
<span class="linenos"> 764</span><span class="p">{</span>
<span class="linenos"> 765</span><span class="w">	</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">RANK</span><span class="o">=</span><span class="mi">4</span><span class="p">;</span>
<span class="linenos"> 766</span><span class="w">	</span><span class="n">hsize_t</span><span class="w"> </span><span class="n">dims</span><span class="p">[</span><span class="n">RANK</span><span class="p">],</span><span class="w"> </span><span class="n">chunk</span><span class="p">[</span><span class="n">RANK</span><span class="p">];</span>
<span class="linenos"> 767</span><span class="w">	</span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="p">;</span>
<span class="linenos"> 768</span><span class="w">	</span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">y</span><span class="p">;</span>
<span class="linenos"> 769</span><span class="w">	</span><span class="n">dims</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">z</span><span class="p">;</span>
<span class="linenos"> 770</span><span class="w">	</span><span class="n">dims</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">w</span><span class="p">;</span>
<span class="linenos"> 771</span><span class="w">	</span><span class="n">chunk</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">min</span><span class="p">((</span><span class="n">uint</span><span class="p">)</span><span class="n">TUNE_LATTICE_GZIP_CHUNK_SIZE</span><span class="p">,</span><span class="n">x</span><span class="p">);</span>
<span class="linenos"> 772</span><span class="w">	</span><span class="n">chunk</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">min</span><span class="p">((</span><span class="n">uint</span><span class="p">)</span><span class="n">TUNE_LATTICE_GZIP_CHUNK_SIZE</span><span class="p">,</span><span class="n">y</span><span class="p">);</span>
<span class="linenos"> 773</span><span class="w">	</span><span class="n">chunk</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">min</span><span class="p">((</span><span class="n">uint</span><span class="p">)</span><span class="n">TUNE_LATTICE_GZIP_CHUNK_SIZE</span><span class="p">,</span><span class="n">z</span><span class="p">);</span>
<span class="linenos"> 774</span><span class="w">	</span><span class="n">chunk</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">w</span><span class="p">;</span>
<span class="linenos"> 775</span><span class="w">	</span><span class="n">hid_t</span><span class="w"> </span><span class="n">dataspaceHandle</span><span class="p">,</span><span class="w"> </span><span class="n">dcplHandle</span><span class="p">,</span><span class="w"> </span><span class="n">datasetHandle</span><span class="p">;</span>
<span class="linenos"> 776</span><span class="w">	</span><span class="n">HDF5_EXCEPTION_CALL</span><span class="p">(</span><span class="n">dataspaceHandle</span><span class="p">,</span><span class="n">H5Screate_simple</span><span class="p">(</span><span class="n">RANK</span><span class="p">,</span><span class="w"> </span><span class="n">dims</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">));</span>
<span class="linenos"> 777</span><span class="w">	</span><span class="n">HDF5_EXCEPTION_CALL</span><span class="p">(</span><span class="n">dcplHandle</span><span class="p">,</span><span class="n">H5Pcreate</span><span class="p">(</span><span class="n">H5P_DATASET_CREATE</span><span class="p">));</span>
<span class="linenos"> 778</span><span class="w">	</span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Pset_deflate</span><span class="w"> </span><span class="p">(</span><span class="n">dcplHandle</span><span class="p">,</span><span class="w"> </span><span class="n">TUNE_LATTICE_GZIP_COMPRESSION_LEVEL</span><span class="p">));</span>
<span class="linenos"> 779</span><span class="w">	</span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Pset_chunk</span><span class="p">(</span><span class="n">dcplHandle</span><span class="p">,</span><span class="w"> </span><span class="n">RANK</span><span class="p">,</span><span class="w"> </span><span class="n">chunk</span><span class="p">));</span>
<span class="linenos"> 780</span><span class="w">	</span><span class="n">HDF5_EXCEPTION_CALL</span><span class="p">(</span><span class="n">datasetHandle</span><span class="p">,</span><span class="n">H5Dcreate2</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="n">path</span><span class="p">,</span><span class="w"> </span><span class="n">H5T_STD_U8LE</span><span class="p">,</span><span class="w"> </span><span class="n">dataspaceHandle</span><span class="p">,</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">,</span><span class="w"> </span><span class="n">dcplHandle</span><span class="p">,</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">));</span>
<span class="linenos"> 781</span><span class="w">	</span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Dwrite</span><span class="p">(</span><span class="n">datasetHandle</span><span class="p">,</span><span class="w"> </span><span class="n">H5T_NATIVE_UINT8</span><span class="p">,</span><span class="w"> </span><span class="n">H5S_ALL</span><span class="p">,</span><span class="w"> </span><span class="n">H5S_ALL</span><span class="p">,</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">));</span>
<span class="linenos"> 782</span><span class="w">	</span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Dclose</span><span class="p">(</span><span class="n">datasetHandle</span><span class="p">));</span>
<span class="linenos"> 783</span><span class="w">	</span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Pclose</span><span class="p">(</span><span class="n">dcplHandle</span><span class="p">));</span>
<span class="linenos"> 784</span><span class="w">	</span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Sclose</span><span class="p">(</span><span class="n">dataspaceHandle</span><span class="p">));</span>
<span class="linenos"> 785</span><span class="p">}</span>
<span class="linenos"> 786</span>
<span class="linenos"> 787</span><span class="kt">void</span><span class="w"> </span><span class="n">SimulationFile</span><span class="o">::</span><span class="n">writeParticleLattice_U32LE</span><span class="p">(</span><span class="n">hid_t</span><span class="w"> </span><span class="n">handle</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">path</span><span class="p">,</span><span class="w">  </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">z</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">w</span><span class="p">)</span>
<span class="linenos"> 788</span><span class="p">{</span>
<span class="linenos"> 789</span><span class="w">	</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">RANK</span><span class="o">=</span><span class="mi">4</span><span class="p">;</span>
<span class="linenos"> 790</span><span class="w">	</span><span class="n">hsize_t</span><span class="w"> </span><span class="n">dims</span><span class="p">[</span><span class="n">RANK</span><span class="p">],</span><span class="w"> </span><span class="n">chunk</span><span class="p">[</span><span class="n">RANK</span><span class="p">];</span>
<span class="linenos"> 791</span><span class="w">	</span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="p">;</span>
<span class="linenos"> 792</span><span class="w">	</span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">y</span><span class="p">;</span>
<span class="linenos"> 793</span><span class="w">	</span><span class="n">dims</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">z</span><span class="p">;</span>
<span class="linenos"> 794</span><span class="w">	</span><span class="n">dims</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">w</span><span class="p">;</span>
<span class="linenos"> 795</span><span class="w">	</span><span class="n">chunk</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">min</span><span class="p">((</span><span class="n">uint</span><span class="p">)</span><span class="n">TUNE_LATTICE_GZIP_CHUNK_SIZE</span><span class="p">,</span><span class="n">x</span><span class="p">);</span>
<span class="linenos"> 796</span><span class="w">	</span><span class="n">chunk</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">min</span><span class="p">((</span><span class="n">uint</span><span class="p">)</span><span class="n">TUNE_LATTICE_GZIP_CHUNK_SIZE</span><span class="p">,</span><span class="n">y</span><span class="p">);</span>
<span class="linenos"> 797</span><span class="w">	</span><span class="n">chunk</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">min</span><span class="p">((</span><span class="n">uint</span><span class="p">)</span><span class="n">TUNE_LATTICE_GZIP_CHUNK_SIZE</span><span class="p">,</span><span class="n">z</span><span class="p">);</span>
<span class="linenos"> 798</span><span class="w">	</span><span class="n">chunk</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">w</span><span class="p">;</span>
<span class="linenos"> 799</span><span class="w">	</span><span class="n">hid_t</span><span class="w"> </span><span class="n">dataspaceHandle</span><span class="p">,</span><span class="w"> </span><span class="n">dcplHandle</span><span class="p">,</span><span class="w"> </span><span class="n">datasetHandle</span><span class="p">;</span>
<span class="linenos"> 800</span><span class="w">	</span><span class="n">HDF5_EXCEPTION_CALL</span><span class="p">(</span><span class="n">dataspaceHandle</span><span class="p">,</span><span class="n">H5Screate_simple</span><span class="p">(</span><span class="n">RANK</span><span class="p">,</span><span class="w"> </span><span class="n">dims</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">));</span>
<span class="linenos"> 801</span><span class="w">	</span><span class="n">HDF5_EXCEPTION_CALL</span><span class="p">(</span><span class="n">dcplHandle</span><span class="p">,</span><span class="n">H5Pcreate</span><span class="p">(</span><span class="n">H5P_DATASET_CREATE</span><span class="p">));</span>
<span class="linenos"> 802</span><span class="w">	</span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Pset_deflate</span><span class="w"> </span><span class="p">(</span><span class="n">dcplHandle</span><span class="p">,</span><span class="w"> </span><span class="n">TUNE_LATTICE_GZIP_COMPRESSION_LEVEL</span><span class="p">));</span>
<span class="linenos"> 803</span><span class="w">	</span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Pset_chunk</span><span class="p">(</span><span class="n">dcplHandle</span><span class="p">,</span><span class="w"> </span><span class="n">RANK</span><span class="p">,</span><span class="w"> </span><span class="n">chunk</span><span class="p">));</span>
<span class="linenos"> 804</span><span class="w">	</span><span class="n">HDF5_EXCEPTION_CALL</span><span class="p">(</span><span class="n">datasetHandle</span><span class="p">,</span><span class="n">H5Dcreate2</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span><span class="w"> </span><span class="n">path</span><span class="p">,</span><span class="w"> </span><span class="n">H5T_STD_U32LE</span><span class="p">,</span><span class="w"> </span><span class="n">dataspaceHandle</span><span class="p">,</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">,</span><span class="w"> </span><span class="n">dcplHandle</span><span class="p">,</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">));</span>
<span class="linenos"> 805</span><span class="w">	</span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Dwrite</span><span class="p">(</span><span class="n">datasetHandle</span><span class="p">,</span><span class="w"> </span><span class="n">H5T_NATIVE_UINT32</span><span class="p">,</span><span class="w"> </span><span class="n">H5S_ALL</span><span class="p">,</span><span class="w"> </span><span class="n">H5S_ALL</span><span class="p">,</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">));</span>
<span class="linenos"> 806</span><span class="w">	</span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Dclose</span><span class="p">(</span><span class="n">datasetHandle</span><span class="p">));</span>
<span class="linenos"> 807</span><span class="w">	</span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Pclose</span><span class="p">(</span><span class="n">dcplHandle</span><span class="p">));</span>
<span class="linenos"> 808</span><span class="w">	</span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Sclose</span><span class="p">(</span><span class="n">dataspaceHandle</span><span class="p">));</span>
<span class="linenos"> 809</span><span class="p">}</span>
<span class="linenos"> 810</span>
<span class="linenos"> 811</span><span class="kt">void</span><span class="w"> </span><span class="n">SimulationFile</span><span class="o">::</span><span class="n">write3DLattice_U8LE</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">path</span><span class="p">,</span><span class="w">  </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="linenos"> 812</span><span class="p">{</span>
<span class="linenos"> 813</span><span class="w">	</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">RANK</span><span class="o">=</span><span class="mi">3</span><span class="p">;</span>
<span class="linenos"> 814</span><span class="w">	</span><span class="n">hsize_t</span><span class="w"> </span><span class="n">dims</span><span class="p">[</span><span class="n">RANK</span><span class="p">],</span><span class="w"> </span><span class="n">chunk</span><span class="p">[</span><span class="n">RANK</span><span class="p">];</span>
<span class="linenos"> 815</span><span class="w">	</span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="p">;</span>
<span class="linenos"> 816</span><span class="w">	</span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">y</span><span class="p">;</span>
<span class="linenos"> 817</span><span class="w">	</span><span class="n">dims</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">z</span><span class="p">;</span>
<span class="linenos"> 818</span><span class="w">	</span><span class="n">chunk</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">min</span><span class="p">((</span><span class="n">uint</span><span class="p">)</span><span class="n">TUNE_LATTICE_GZIP_CHUNK_SIZE</span><span class="p">,</span><span class="n">x</span><span class="p">);</span>
<span class="linenos"> 819</span><span class="w">	</span><span class="n">chunk</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">min</span><span class="p">((</span><span class="n">uint</span><span class="p">)</span><span class="n">TUNE_LATTICE_GZIP_CHUNK_SIZE</span><span class="p">,</span><span class="n">y</span><span class="p">);</span>
<span class="linenos"> 820</span><span class="w">	</span><span class="n">chunk</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">min</span><span class="p">((</span><span class="n">uint</span><span class="p">)</span><span class="n">TUNE_LATTICE_GZIP_CHUNK_SIZE</span><span class="p">,</span><span class="n">z</span><span class="p">);</span>
<span class="linenos"> 821</span><span class="w">	</span><span class="n">hid_t</span><span class="w"> </span><span class="n">dataspaceHandle</span><span class="p">,</span><span class="w"> </span><span class="n">dcplHandle</span><span class="p">,</span><span class="w"> </span><span class="n">datasetHandle</span><span class="p">;</span>
<span class="linenos"> 822</span><span class="w">	</span><span class="n">HDF5_EXCEPTION_CALL</span><span class="p">(</span><span class="n">dataspaceHandle</span><span class="p">,</span><span class="n">H5Screate_simple</span><span class="p">(</span><span class="n">RANK</span><span class="p">,</span><span class="w"> </span><span class="n">dims</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">));</span>
<span class="linenos"> 823</span><span class="w">	</span><span class="n">HDF5_EXCEPTION_CALL</span><span class="p">(</span><span class="n">dcplHandle</span><span class="p">,</span><span class="n">H5Pcreate</span><span class="p">(</span><span class="n">H5P_DATASET_CREATE</span><span class="p">));</span>
<span class="linenos"> 824</span><span class="w">	</span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Pset_deflate</span><span class="w"> </span><span class="p">(</span><span class="n">dcplHandle</span><span class="p">,</span><span class="w"> </span><span class="n">TUNE_LATTICE_GZIP_COMPRESSION_LEVEL</span><span class="p">));</span>
<span class="linenos"> 825</span><span class="w">	</span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Pset_chunk</span><span class="p">(</span><span class="n">dcplHandle</span><span class="p">,</span><span class="w"> </span><span class="n">RANK</span><span class="p">,</span><span class="w"> </span><span class="n">chunk</span><span class="p">));</span>
<span class="linenos"> 826</span><span class="w">	</span><span class="n">HDF5_EXCEPTION_CALL</span><span class="p">(</span><span class="n">datasetHandle</span><span class="p">,</span><span class="n">H5Dcreate2</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="n">path</span><span class="p">,</span><span class="w"> </span><span class="n">H5T_STD_U8LE</span><span class="p">,</span><span class="w"> </span><span class="n">dataspaceHandle</span><span class="p">,</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">,</span><span class="w"> </span><span class="n">dcplHandle</span><span class="p">,</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">));</span>
<span class="linenos"> 827</span><span class="w">	</span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Dwrite</span><span class="p">(</span><span class="n">datasetHandle</span><span class="p">,</span><span class="w"> </span><span class="n">H5T_NATIVE_UINT8</span><span class="p">,</span><span class="w"> </span><span class="n">H5S_ALL</span><span class="p">,</span><span class="w"> </span><span class="n">H5S_ALL</span><span class="p">,</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">));</span>
<span class="linenos"> 828</span><span class="w">	</span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Dclose</span><span class="p">(</span><span class="n">datasetHandle</span><span class="p">));</span>
<span class="linenos"> 829</span><span class="w">	</span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Pclose</span><span class="p">(</span><span class="n">dcplHandle</span><span class="p">));</span>
<span class="linenos"> 830</span><span class="w">	</span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Sclose</span><span class="p">(</span><span class="n">dataspaceHandle</span><span class="p">));</span>
<span class="linenos"> 831</span><span class="p">}</span>
<span class="linenos"> 832</span>
<span class="linenos"> 833</span><span class="kt">void</span><span class="w"> </span><span class="n">SimulationFile</span><span class="o">::</span><span class="n">setDiffusionModelLattice</span><span class="p">(</span><span class="n">lm</span><span class="o">::</span><span class="n">io</span><span class="o">::</span><span class="n">DiffusionModel</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">lattice</span><span class="p">,</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">latticeSites</span><span class="p">)</span>
<span class="linenos"> 834</span><span class="p">{</span>
<span class="linenos"> 835</span><span class="w">	</span><span class="n">writeParticleLattice_U8LE</span><span class="p">(</span><span class="s">&quot;/Model/Diffusion/Lattice&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">lattice</span><span class="p">,</span><span class="w"> </span><span class="n">m</span><span class="o">-&gt;</span><span class="n">lattice_x_size</span><span class="p">(),</span><span class="w"> </span><span class="n">m</span><span class="o">-&gt;</span><span class="n">lattice_y_size</span><span class="p">(),</span><span class="w"> </span><span class="n">m</span><span class="o">-&gt;</span><span class="n">lattice_z_size</span><span class="p">(),</span><span class="w"> </span><span class="n">m</span><span class="o">-&gt;</span><span class="n">particles_per_site</span><span class="p">());</span>
<span class="linenos"> 836</span><span class="w">	</span><span class="n">write3DLattice_U8LE</span><span class="p">(</span><span class="s">&quot;/Model/Diffusion/LatticeSites&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">latticeSites</span><span class="p">,</span><span class="w"> </span><span class="n">m</span><span class="o">-&gt;</span><span class="n">lattice_x_size</span><span class="p">(),</span><span class="w"> </span><span class="n">m</span><span class="o">-&gt;</span><span class="n">lattice_y_size</span><span class="p">(),</span><span class="w"> </span><span class="n">m</span><span class="o">-&gt;</span><span class="n">lattice_z_size</span><span class="p">());</span>
<span class="linenos"> 837</span><span class="p">}</span>
<span class="linenos"> 838</span>
<span class="linenos"> 839</span><span class="kt">void</span><span class="w"> </span><span class="n">SimulationFile</span><span class="o">::</span><span class="n">setDiffusionModelLattice</span><span class="p">(</span><span class="n">lm</span><span class="o">::</span><span class="n">io</span><span class="o">::</span><span class="n">DiffusionModel</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">lattice</span><span class="p">,</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">latticeSites</span><span class="p">)</span>
<span class="linenos"> 840</span><span class="p">{</span>
<span class="linenos"> 841</span><span class="w">	</span><span class="n">writeParticleLattice_U32LE</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/Model/Diffusion/Lattice&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">lattice</span><span class="p">,</span><span class="w"> </span><span class="n">m</span><span class="o">-&gt;</span><span class="n">lattice_x_size</span><span class="p">(),</span><span class="w"> </span><span class="n">m</span><span class="o">-&gt;</span><span class="n">lattice_y_size</span><span class="p">(),</span><span class="w"> </span><span class="n">m</span><span class="o">-&gt;</span><span class="n">lattice_z_size</span><span class="p">(),</span><span class="w"> </span><span class="n">m</span><span class="o">-&gt;</span><span class="n">particles_per_site</span><span class="p">());</span>
<span class="linenos"> 842</span><span class="w">	</span><span class="n">write3DLattice_U8LE</span><span class="p">(</span><span class="s">&quot;/Model/Diffusion/LatticeSites&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">latticeSites</span><span class="p">,</span><span class="w"> </span><span class="n">m</span><span class="o">-&gt;</span><span class="n">lattice_x_size</span><span class="p">(),</span><span class="w"> </span><span class="n">m</span><span class="o">-&gt;</span><span class="n">lattice_y_size</span><span class="p">(),</span><span class="w"> </span><span class="n">m</span><span class="o">-&gt;</span><span class="n">lattice_z_size</span><span class="p">());</span>
<span class="linenos"> 843</span><span class="p">}</span>
<span class="linenos"> 844</span>
<span class="linenos"> 845</span><span class="kt">void</span><span class="w"> </span><span class="n">SimulationFile</span><span class="o">::</span><span class="n">setDiffusionModelLattice</span><span class="p">(</span><span class="n">lm</span><span class="o">::</span><span class="n">io</span><span class="o">::</span><span class="n">DiffusionModel</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="n">lm</span><span class="o">::</span><span class="n">rdme</span><span class="o">::</span><span class="n">ByteLattice</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">lattice</span><span class="p">)</span>
<span class="linenos"> 846</span><span class="p">{</span>
<span class="linenos"> 847</span><span class="w">	</span><span class="kt">size_t</span><span class="w"> </span><span class="n">latticeDataSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">m</span><span class="o">-&gt;</span><span class="n">lattice_x_size</span><span class="p">()</span><span class="o">*</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">lattice_y_size</span><span class="p">()</span><span class="o">*</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">lattice_z_size</span><span class="p">()</span><span class="o">*</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">particles_per_site</span><span class="p">();</span>
<span class="linenos"> 848</span><span class="w">	</span><span class="n">byte</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">latticeData</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="k">new</span><span class="w"> </span><span class="n">byte</span><span class="p">[</span><span class="n">latticeDataSize</span><span class="p">];</span>
<span class="linenos"> 849</span><span class="w">	</span><span class="n">lm</span><span class="o">::</span><span class="n">rdme</span><span class="o">::</span><span class="n">Lattice</span><span class="o">::</span><span class="n">rowMajorByteSerialize</span><span class="p">(</span><span class="n">latticeData</span><span class="p">,</span><span class="w"> </span><span class="n">lattice</span><span class="p">,</span><span class="w"> </span><span class="n">latticeDataSize</span><span class="p">);</span>
<span class="linenos"> 850</span><span class="w">	</span><span class="n">writeParticleLattice_U8LE</span><span class="p">(</span><span class="s">&quot;/Model/Diffusion/Lattice&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">latticeData</span><span class="p">,</span><span class="w"> </span><span class="n">m</span><span class="o">-&gt;</span><span class="n">lattice_x_size</span><span class="p">(),</span><span class="w"> </span><span class="n">m</span><span class="o">-&gt;</span><span class="n">lattice_y_size</span><span class="p">(),</span><span class="w"> </span><span class="n">m</span><span class="o">-&gt;</span><span class="n">lattice_z_size</span><span class="p">(),</span><span class="w"> </span><span class="n">m</span><span class="o">-&gt;</span><span class="n">particles_per_site</span><span class="p">());</span>
<span class="linenos"> 851</span><span class="w">	</span><span class="k">delete</span><span class="w"> </span><span class="p">[]</span><span class="w"> </span><span class="n">latticeData</span><span class="p">;</span>
<span class="linenos"> 852</span>
<span class="linenos"> 853</span><span class="w">	</span><span class="kt">size_t</span><span class="w"> </span><span class="n">latticeSitesDataSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">m</span><span class="o">-&gt;</span><span class="n">lattice_x_size</span><span class="p">()</span><span class="o">*</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">lattice_y_size</span><span class="p">()</span><span class="o">*</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">lattice_z_size</span><span class="p">();</span>
<span class="linenos"> 854</span><span class="w">	</span><span class="n">byte</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">latticeSitesData</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="k">new</span><span class="w"> </span><span class="n">byte</span><span class="p">[</span><span class="n">latticeSitesDataSize</span><span class="p">];</span>
<span class="linenos"> 855</span><span class="w">	</span><span class="n">lm</span><span class="o">::</span><span class="n">rdme</span><span class="o">::</span><span class="n">Lattice</span><span class="o">::</span><span class="n">rowMajorByteSerializeSites</span><span class="p">(</span><span class="n">latticeSitesData</span><span class="p">,</span><span class="w"> </span><span class="n">lattice</span><span class="p">,</span><span class="w"> </span><span class="n">latticeSitesDataSize</span><span class="p">);</span>
<span class="linenos"> 856</span><span class="w">	</span><span class="n">write3DLattice_U8LE</span><span class="p">(</span><span class="s">&quot;/Model/Diffusion/LatticeSites&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">latticeSitesData</span><span class="p">,</span><span class="w"> </span><span class="n">m</span><span class="o">-&gt;</span><span class="n">lattice_x_size</span><span class="p">(),</span><span class="w"> </span><span class="n">m</span><span class="o">-&gt;</span><span class="n">lattice_y_size</span><span class="p">(),</span><span class="w"> </span><span class="n">m</span><span class="o">-&gt;</span><span class="n">lattice_z_size</span><span class="p">());</span>
<span class="linenos"> 857</span><span class="w">	</span><span class="k">delete</span><span class="w"> </span><span class="p">[]</span><span class="w"> </span><span class="n">latticeSitesData</span><span class="p">;</span>
<span class="linenos"> 858</span><span class="p">}</span>
<span class="linenos"> 859</span>
<span class="linenos"> 860</span><span class="kt">void</span><span class="w"> </span><span class="n">SimulationFile</span><span class="o">::</span><span class="n">setDiffusionModelLattice</span><span class="p">(</span><span class="n">lm</span><span class="o">::</span><span class="n">io</span><span class="o">::</span><span class="n">DiffusionModel</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="n">lm</span><span class="o">::</span><span class="n">rdme</span><span class="o">::</span><span class="n">IntLattice</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">lattice</span><span class="p">)</span>
<span class="linenos"> 861</span><span class="p">{</span>
<span class="linenos"> 862</span><span class="w">	</span><span class="kt">size_t</span><span class="w"> </span><span class="n">latticeDataSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">m</span><span class="o">-&gt;</span><span class="n">lattice_x_size</span><span class="p">()</span><span class="o">*</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">lattice_y_size</span><span class="p">()</span><span class="o">*</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">lattice_z_size</span><span class="p">()</span><span class="o">*</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">particles_per_site</span><span class="p">();</span>
<span class="linenos"> 863</span><span class="w">	</span><span class="kt">uint32_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">latticeData</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="k">new</span><span class="w"> </span><span class="kt">uint32_t</span><span class="p">[</span><span class="n">latticeDataSize</span><span class="p">];</span>
<span class="linenos"> 864</span><span class="w">	</span><span class="n">lm</span><span class="o">::</span><span class="n">rdme</span><span class="o">::</span><span class="n">Lattice</span><span class="o">::</span><span class="n">rowMajorIntSerialize</span><span class="p">(</span><span class="n">latticeData</span><span class="p">,</span><span class="w"> </span><span class="n">lattice</span><span class="p">,</span><span class="w"> </span><span class="n">latticeDataSize</span><span class="p">);</span>
<span class="linenos"> 865</span><span class="w">	</span><span class="n">writeParticleLattice_U32LE</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/Model/Diffusion/Lattice&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">latticeData</span><span class="p">,</span><span class="w"> </span><span class="n">m</span><span class="o">-&gt;</span><span class="n">lattice_x_size</span><span class="p">(),</span><span class="w"> </span><span class="n">m</span><span class="o">-&gt;</span><span class="n">lattice_y_size</span><span class="p">(),</span><span class="w"> </span><span class="n">m</span><span class="o">-&gt;</span><span class="n">lattice_z_size</span><span class="p">(),</span><span class="w"> </span><span class="n">m</span><span class="o">-&gt;</span><span class="n">particles_per_site</span><span class="p">());</span>
<span class="linenos"> 866</span><span class="w">	</span><span class="k">delete</span><span class="w"> </span><span class="p">[]</span><span class="w"> </span><span class="n">latticeData</span><span class="p">;</span>
<span class="linenos"> 867</span><span class="w">			</span>
<span class="linenos"> 868</span><span class="w">	</span><span class="kt">size_t</span><span class="w"> </span><span class="n">latticeSitesDataSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">m</span><span class="o">-&gt;</span><span class="n">lattice_x_size</span><span class="p">()</span><span class="o">*</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">lattice_y_size</span><span class="p">()</span><span class="o">*</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">lattice_z_size</span><span class="p">();</span>
<span class="linenos"> 869</span><span class="w">	</span><span class="n">byte</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">latticeSitesData</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="k">new</span><span class="w"> </span><span class="n">byte</span><span class="p">[</span><span class="n">latticeSitesDataSize</span><span class="p">];</span>
<span class="linenos"> 870</span><span class="w">	</span><span class="n">lm</span><span class="o">::</span><span class="n">rdme</span><span class="o">::</span><span class="n">Lattice</span><span class="o">::</span><span class="n">rowMajorByteSerializeSites</span><span class="p">(</span><span class="n">latticeSitesData</span><span class="p">,</span><span class="w"> </span><span class="n">lattice</span><span class="p">,</span><span class="w"> </span><span class="n">latticeSitesDataSize</span><span class="p">);</span>
<span class="linenos"> 871</span><span class="w">	</span><span class="n">write3DLattice_U8LE</span><span class="p">(</span><span class="s">&quot;/Model/Diffusion/LatticeSites&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">latticeSitesData</span><span class="p">,</span><span class="w"> </span><span class="n">m</span><span class="o">-&gt;</span><span class="n">lattice_x_size</span><span class="p">(),</span><span class="w"> </span><span class="n">m</span><span class="o">-&gt;</span><span class="n">lattice_y_size</span><span class="p">(),</span><span class="w"> </span><span class="n">m</span><span class="o">-&gt;</span><span class="n">lattice_z_size</span><span class="p">());</span>
<span class="linenos"> 872</span><span class="w">	</span><span class="k">delete</span><span class="w"> </span><span class="p">[]</span><span class="w"> </span><span class="n">latticeSitesData</span><span class="p">;</span>
<span class="linenos"> 873</span><span class="p">}</span>
<span class="linenos"> 874</span>
<span class="linenos"> 875</span><span class="kt">void</span><span class="w"> </span><span class="n">SimulationFile</span><span class="o">::</span><span class="n">getSpatialModel</span><span class="p">(</span><span class="n">lm</span><span class="o">::</span><span class="n">io</span><span class="o">::</span><span class="n">SpatialModel</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">spatialModel</span><span class="p">)</span>
<span class="linenos"> 876</span><span class="p">{</span>
<span class="linenos"> 877</span><span class="w">    </span><span class="c1">// Make sure the model is not null and then clear it.</span>
<span class="linenos"> 878</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">spatialModel</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="n">InvalidArgException</span><span class="p">(</span><span class="s">&quot;spatialModel&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;cannot be null&quot;</span><span class="p">);</span>
<span class="linenos"> 879</span><span class="w">    </span><span class="n">spatialModel</span><span class="o">-&gt;</span><span class="n">Clear</span><span class="p">();</span>
<span class="linenos"> 880</span>
<span class="linenos"> 881</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">H5Lexists</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/Model/Spatial&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">))</span>
<span class="linenos"> 882</span><span class="w">    </span><span class="p">{</span>
<span class="linenos"> 883</span><span class="w">        </span><span class="c1">// Read the diffusion model attributes.</span>
<span class="linenos"> 884</span><span class="w">        </span><span class="n">uint</span><span class="w"> </span><span class="n">numberRegions</span><span class="p">,</span><span class="w"> </span><span class="n">numberObstacles</span><span class="p">;</span>
<span class="linenos"> 885</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5LTget_attribute_uint</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/Model/Spatial/Regions&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;numberRegions&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">numberRegions</span><span class="p">));</span>
<span class="linenos"> 886</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5LTget_attribute_uint</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/Model/Spatial/Obstacles&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;numberObstacles&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">numberObstacles</span><span class="p">));</span>
<span class="linenos"> 887</span>
<span class="linenos"> 888</span><span class="w">        </span><span class="n">hsize_t</span><span class="w"> </span><span class="n">dims</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<span class="linenos"> 889</span><span class="w">        </span><span class="n">H5T_class_t</span><span class="w"> </span><span class="n">type</span><span class="p">;</span>
<span class="linenos"> 890</span><span class="w">        </span><span class="kt">size_t</span><span class="w"> </span><span class="n">size</span><span class="p">;</span>
<span class="linenos"> 891</span>
<span class="linenos"> 892</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">numberRegions</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="linenos"> 893</span><span class="w">        </span><span class="p">{</span>
<span class="linenos"> 894</span><span class="w">            </span><span class="c1">// Read the region types table.</span>
<span class="linenos"> 895</span><span class="w">            </span><span class="p">{</span>
<span class="linenos"> 896</span><span class="w">                </span><span class="n">H5LTget_dataset_info</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/Model/Spatial/Regions/Types&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">dims</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">size</span><span class="p">);</span>
<span class="linenos"> 897</span><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">numberRegions</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">uint</span><span class="p">))</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="n">Exception</span><span class="p">(</span><span class="s">&quot;Invalid dataset dimensions&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">filename</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot;/Model/Spatial/Regions/Types&quot;</span><span class="p">);</span>
<span class="linenos"> 898</span><span class="w">                </span><span class="n">uint</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">types</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">uint</span><span class="p">[</span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]];</span>
<span class="linenos"> 899</span><span class="w">                </span><span class="n">H5LTread_dataset</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/Model/Spatial/Regions/Types&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">H5T_STD_U32LE</span><span class="p">,</span><span class="w"> </span><span class="n">types</span><span class="p">);</span>
<span class="linenos"> 900</span><span class="w">                </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="linenos"> 901</span><span class="w">                </span><span class="p">{</span>
<span class="linenos"> 902</span><span class="w">                    </span><span class="n">spatialModel</span><span class="o">-&gt;</span><span class="n">add_region</span><span class="p">();</span>
<span class="linenos"> 903</span><span class="w">                    </span><span class="n">spatialModel</span><span class="o">-&gt;</span><span class="n">mutable_region</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">set_shape</span><span class="p">(</span><span class="n">types</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]]);</span>
<span class="linenos"> 904</span><span class="w">                    </span><span class="n">spatialModel</span><span class="o">-&gt;</span><span class="n">mutable_region</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">set_site_type</span><span class="p">(</span><span class="n">types</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">]);</span>
<span class="linenos"> 905</span><span class="w">                </span><span class="p">}</span>
<span class="linenos"> 906</span><span class="w">                </span><span class="k">delete</span><span class="w"> </span><span class="p">[]</span><span class="w"> </span><span class="n">types</span><span class="p">;</span>
<span class="linenos"> 907</span><span class="w">            </span><span class="p">}</span>
<span class="linenos"> 908</span>
<span class="linenos"> 909</span><span class="w">            </span><span class="c1">// Read the shape parameters table.</span>
<span class="linenos"> 910</span><span class="w">            </span><span class="p">{</span>
<span class="linenos"> 911</span><span class="w">                </span><span class="n">H5LTget_dataset_info</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/Model/Spatial/Regions/ShapeParameters&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">dims</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">size</span><span class="p">);</span>
<span class="linenos"> 912</span><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">numberRegions</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">MAX_SHAPE_PARAMETERS</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">double</span><span class="p">))</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="n">Exception</span><span class="p">(</span><span class="s">&quot;Invalid dataset dimensions&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">filename</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot;/Model/Spatial/Regions/ShapeParameters&quot;</span><span class="p">);</span>
<span class="linenos"> 913</span><span class="w">                </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">shapeParams</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">double</span><span class="p">[</span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]];</span>
<span class="linenos"> 914</span><span class="w">                </span><span class="n">H5LTread_dataset_double</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/Model/Spatial/Regions/ShapeParameters&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">shapeParams</span><span class="p">);</span>
<span class="linenos"> 915</span><span class="w">                </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="linenos"> 916</span><span class="w">                </span><span class="p">{</span>
<span class="linenos"> 917</span><span class="w">                    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">&lt;</span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span><span class="w"> </span><span class="n">j</span><span class="o">++</span><span class="p">)</span>
<span class="linenos"> 918</span><span class="w">                    </span><span class="p">{</span>
<span class="linenos"> 919</span><span class="w">                        </span><span class="kt">double</span><span class="w"> </span><span class="n">shapeParam</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">shapeParams</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">j</span><span class="p">];</span>
<span class="linenos"> 920</span><span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">std</span><span class="o">::</span><span class="n">isnan</span><span class="p">(</span><span class="n">shapeParam</span><span class="p">))</span>
<span class="linenos"> 921</span><span class="w">                            </span><span class="n">spatialModel</span><span class="o">-&gt;</span><span class="n">mutable_region</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">add_shape_parameter</span><span class="p">(</span><span class="n">shapeParam</span><span class="p">);</span>
<span class="linenos"> 922</span><span class="w">                        </span><span class="k">else</span>
<span class="linenos"> 923</span><span class="w">                            </span><span class="k">break</span><span class="p">;</span>
<span class="linenos"> 924</span><span class="w">                    </span><span class="p">}</span>
<span class="linenos"> 925</span><span class="w">                </span><span class="p">}</span>
<span class="linenos"> 926</span><span class="w">                </span><span class="k">delete</span><span class="w"> </span><span class="p">[]</span><span class="w"> </span><span class="n">shapeParams</span><span class="p">;</span>
<span class="linenos"> 927</span><span class="w">            </span><span class="p">}</span>
<span class="linenos"> 928</span><span class="w">        </span><span class="p">}</span>
<span class="linenos"> 929</span>
<span class="linenos"> 930</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">numberObstacles</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="linenos"> 931</span><span class="w">        </span><span class="p">{</span>
<span class="linenos"> 932</span><span class="w">            </span><span class="c1">// Read the obstacle types table.</span>
<span class="linenos"> 933</span><span class="w">            </span><span class="p">{</span>
<span class="linenos"> 934</span><span class="w">                </span><span class="n">H5LTget_dataset_info</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/Model/Spatial/Obstacles/Types&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">dims</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">size</span><span class="p">);</span>
<span class="linenos"> 935</span><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">numberObstacles</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">uint</span><span class="p">))</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="n">Exception</span><span class="p">(</span><span class="s">&quot;Invalid dataset dimensions&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">filename</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot;/Model/Spatial/Obstacles/Types&quot;</span><span class="p">);</span>
<span class="linenos"> 936</span><span class="w">                </span><span class="n">uint</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">types</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">uint</span><span class="p">[</span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]];</span>
<span class="linenos"> 937</span><span class="w">                </span><span class="n">H5LTread_dataset</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/Model/Spatial/Obstacles/Types&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">H5T_STD_U32LE</span><span class="p">,</span><span class="w"> </span><span class="n">types</span><span class="p">);</span>
<span class="linenos"> 938</span><span class="w">                </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="linenos"> 939</span><span class="w">                </span><span class="p">{</span>
<span class="linenos"> 940</span><span class="w">                    </span><span class="n">spatialModel</span><span class="o">-&gt;</span><span class="n">add_obstacle</span><span class="p">();</span>
<span class="linenos"> 941</span><span class="w">                    </span><span class="n">spatialModel</span><span class="o">-&gt;</span><span class="n">mutable_obstacle</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">set_shape</span><span class="p">(</span><span class="n">types</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]]);</span>
<span class="linenos"> 942</span><span class="w">                    </span><span class="n">spatialModel</span><span class="o">-&gt;</span><span class="n">mutable_obstacle</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">set_site_type</span><span class="p">(</span><span class="n">types</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">]);</span>
<span class="linenos"> 943</span><span class="w">                </span><span class="p">}</span>
<span class="linenos"> 944</span><span class="w">                </span><span class="k">delete</span><span class="w"> </span><span class="p">[]</span><span class="w"> </span><span class="n">types</span><span class="p">;</span>
<span class="linenos"> 945</span><span class="w">            </span><span class="p">}</span>
<span class="linenos"> 946</span>
<span class="linenos"> 947</span><span class="w">            </span><span class="c1">// Read the obstacle parameters table.</span>
<span class="linenos"> 948</span><span class="w">            </span><span class="p">{</span>
<span class="linenos"> 949</span><span class="w">                </span><span class="n">H5LTget_dataset_info</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/Model/Spatial/Obstacles/ShapeParameters&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">dims</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">size</span><span class="p">);</span>
<span class="linenos"> 950</span><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">numberObstacles</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">MAX_SHAPE_PARAMETERS</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">double</span><span class="p">))</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="n">Exception</span><span class="p">(</span><span class="s">&quot;Invalid dataset dimensions&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">filename</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot;/Model/Spatial/Obstacles/ShapeParameters&quot;</span><span class="p">);</span>
<span class="linenos"> 951</span><span class="w">                </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">shapeParams</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">double</span><span class="p">[</span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]];</span>
<span class="linenos"> 952</span><span class="w">                </span><span class="n">H5LTread_dataset_double</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/Model/Spatial/Obstacles/ShapeParameters&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">shapeParams</span><span class="p">);</span>
<span class="linenos"> 953</span><span class="w">                </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="linenos"> 954</span><span class="w">                </span><span class="p">{</span>
<span class="linenos"> 955</span><span class="w">                    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">&lt;</span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span><span class="w"> </span><span class="n">j</span><span class="o">++</span><span class="p">)</span>
<span class="linenos"> 956</span><span class="w">                    </span><span class="p">{</span>
<span class="linenos"> 957</span><span class="w">                        </span><span class="kt">double</span><span class="w"> </span><span class="n">shapeParam</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">shapeParams</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">j</span><span class="p">];</span>
<span class="linenos"> 958</span><span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">std</span><span class="o">::</span><span class="n">isnan</span><span class="p">(</span><span class="n">shapeParam</span><span class="p">))</span>
<span class="linenos"> 959</span><span class="w">                            </span><span class="n">spatialModel</span><span class="o">-&gt;</span><span class="n">mutable_obstacle</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">add_shape_parameter</span><span class="p">(</span><span class="n">shapeParam</span><span class="p">);</span>
<span class="linenos"> 960</span><span class="w">                        </span><span class="k">else</span>
<span class="linenos"> 961</span><span class="w">                            </span><span class="k">break</span><span class="p">;</span>
<span class="linenos"> 962</span><span class="w">                    </span><span class="p">}</span>
<span class="linenos"> 963</span><span class="w">                </span><span class="p">}</span>
<span class="linenos"> 964</span><span class="w">                </span><span class="k">delete</span><span class="w"> </span><span class="p">[]</span><span class="w"> </span><span class="n">shapeParams</span><span class="p">;</span>
<span class="linenos"> 965</span><span class="w">            </span><span class="p">}</span>
<span class="linenos"> 966</span><span class="w">        </span><span class="p">}</span>
<span class="linenos"> 967</span><span class="w">    </span><span class="p">}</span>
<span class="linenos"> 968</span><span class="p">}</span>
<span class="linenos"> 969</span>
<span class="linenos"> 970</span><span class="kt">void</span><span class="w"> </span><span class="n">SimulationFile</span><span class="o">::</span><span class="n">setSpatialModel</span><span class="p">(</span><span class="n">lm</span><span class="o">::</span><span class="n">io</span><span class="o">::</span><span class="n">SpatialModel</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">spatialModel</span><span class="p">)</span>
<span class="linenos"> 971</span><span class="p">{</span>
<span class="linenos"> 972</span><span class="w">    </span><span class="c1">// Validate that the model is consistent.</span>
<span class="linenos"> 973</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">spatialModel</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="n">InvalidArgException</span><span class="p">(</span><span class="s">&quot;spatialModel&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;cannot be NULL&quot;</span><span class="p">);</span>
<span class="linenos"> 974</span>
<span class="linenos"> 975</span><span class="w">    </span><span class="c1">// If a diffusion model already exists, delete it.</span>
<span class="linenos"> 976</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">H5Lexists</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/Model/Spatial&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">))</span>
<span class="linenos"> 977</span><span class="w">    </span><span class="p">{</span>
<span class="linenos"> 978</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Ldelete</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/Model/Spatial&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">));</span>
<span class="linenos"> 979</span><span class="w">    </span><span class="p">}</span>
<span class="linenos"> 980</span>
<span class="linenos"> 981</span><span class="w">    </span><span class="c1">// Create the group for the spatial model.</span>
<span class="linenos"> 982</span><span class="w">    </span><span class="n">hid_t</span><span class="w"> </span><span class="n">group</span><span class="p">;</span>
<span class="linenos"> 983</span><span class="w">    </span><span class="n">HDF5_EXCEPTION_CALL</span><span class="p">(</span><span class="n">group</span><span class="p">,</span><span class="n">H5Gcreate2</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/Model/Spatial&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">,</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">,</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">));</span>
<span class="linenos"> 984</span><span class="w">    </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Gclose</span><span class="p">(</span><span class="n">group</span><span class="p">));</span>
<span class="linenos"> 985</span><span class="w">    </span><span class="n">HDF5_EXCEPTION_CALL</span><span class="p">(</span><span class="n">group</span><span class="p">,</span><span class="n">H5Gcreate2</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/Model/Spatial/Regions&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">,</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">,</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">));</span>
<span class="linenos"> 986</span><span class="w">    </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Gclose</span><span class="p">(</span><span class="n">group</span><span class="p">));</span>
<span class="linenos"> 987</span><span class="w">    </span><span class="n">HDF5_EXCEPTION_CALL</span><span class="p">(</span><span class="n">group</span><span class="p">,</span><span class="n">H5Gcreate2</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/Model/Spatial/Obstacles&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">,</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">,</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">));</span>
<span class="linenos"> 988</span><span class="w">    </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Gclose</span><span class="p">(</span><span class="n">group</span><span class="p">));</span>
<span class="linenos"> 989</span>
<span class="linenos"> 990</span><span class="w">    </span><span class="c1">// Write the attributes.</span>
<span class="linenos"> 991</span><span class="w">    </span><span class="n">uint</span><span class="w"> </span><span class="n">numberRegions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">spatialModel</span><span class="o">-&gt;</span><span class="n">region_size</span><span class="p">();</span>
<span class="linenos"> 992</span><span class="w">    </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5LTset_attribute_uint</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/Model/Spatial/Regions&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;numberRegions&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">numberRegions</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">));</span>
<span class="linenos"> 993</span><span class="w">    </span><span class="n">uint</span><span class="w"> </span><span class="n">numberObstacles</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">spatialModel</span><span class="o">-&gt;</span><span class="n">obstacle_size</span><span class="p">();</span>
<span class="linenos"> 994</span><span class="w">    </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5LTset_attribute_uint</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/Model/Spatial/Obstacles&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;numberObstacles&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">numberObstacles</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">));</span>
<span class="linenos"> 995</span>
<span class="linenos"> 996</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">numberRegions</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="linenos"> 997</span><span class="w">    </span><span class="p">{</span>
<span class="linenos"> 998</span><span class="w">        </span><span class="c1">// Write the region types table.</span>
<span class="linenos"> 999</span><span class="w">        </span><span class="p">{</span>
<span class="linenos">1000</span><span class="w">            </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">RANK</span><span class="o">=</span><span class="mi">2</span><span class="p">;</span>
<span class="linenos">1001</span><span class="w">            </span><span class="n">hsize_t</span><span class="w"> </span><span class="n">dims</span><span class="p">[</span><span class="n">RANK</span><span class="p">];</span>
<span class="linenos">1002</span><span class="w">            </span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">numberRegions</span><span class="p">;</span>
<span class="linenos">1003</span><span class="w">            </span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<span class="linenos">1004</span><span class="w">            </span><span class="n">uint</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">types</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">uint</span><span class="p">[</span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]];</span>
<span class="linenos">1005</span><span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">1006</span><span class="w">            </span><span class="p">{</span>
<span class="linenos">1007</span><span class="w">                </span><span class="n">types</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">spatialModel</span><span class="o">-&gt;</span><span class="n">region</span><span class="p">(</span><span class="n">i</span><span class="p">).</span><span class="n">shape</span><span class="p">();</span>
<span class="linenos">1008</span><span class="w">                </span><span class="n">types</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">spatialModel</span><span class="o">-&gt;</span><span class="n">region</span><span class="p">(</span><span class="n">i</span><span class="p">).</span><span class="n">site_type</span><span class="p">();</span>
<span class="linenos">1009</span><span class="w">            </span><span class="p">}</span>
<span class="linenos">1010</span><span class="w">            </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5LTmake_dataset</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/Model/Spatial/Regions/Types&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">RANK</span><span class="p">,</span><span class="w"> </span><span class="n">dims</span><span class="p">,</span><span class="w"> </span><span class="n">H5T_STD_U32LE</span><span class="p">,</span><span class="w"> </span><span class="n">types</span><span class="p">));</span>
<span class="linenos">1011</span><span class="w">            </span><span class="k">delete</span><span class="w"> </span><span class="p">[]</span><span class="w"> </span><span class="n">types</span><span class="p">;</span>
<span class="linenos">1012</span><span class="w">        </span><span class="p">}</span>
<span class="linenos">1013</span>
<span class="linenos">1014</span><span class="w">        </span><span class="c1">// Write the shape parameters table.</span>
<span class="linenos">1015</span><span class="w">        </span><span class="p">{</span>
<span class="linenos">1016</span><span class="w">            </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">RANK</span><span class="o">=</span><span class="mi">2</span><span class="p">;</span>
<span class="linenos">1017</span><span class="w">            </span><span class="n">hsize_t</span><span class="w"> </span><span class="n">dims</span><span class="p">[</span><span class="n">RANK</span><span class="p">];</span>
<span class="linenos">1018</span><span class="w">            </span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">numberRegions</span><span class="p">;</span>
<span class="linenos">1019</span><span class="w">            </span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MAX_SHAPE_PARAMETERS</span><span class="p">;</span>
<span class="linenos">1020</span><span class="w">            </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">shapeParams</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">double</span><span class="p">[</span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]];</span>
<span class="linenos">1021</span><span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">1022</span><span class="w">            </span><span class="p">{</span>
<span class="linenos">1023</span><span class="w">                </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">&lt;</span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span><span class="w"> </span><span class="n">j</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">1024</span><span class="w">                </span><span class="p">{</span>
<span class="linenos">1025</span><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">j</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="p">)</span><span class="n">spatialModel</span><span class="o">-&gt;</span><span class="n">region</span><span class="p">(</span><span class="n">i</span><span class="p">).</span><span class="n">shape_parameter_size</span><span class="p">())</span>
<span class="linenos">1026</span><span class="w">                        </span><span class="n">shapeParams</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">j</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">spatialModel</span><span class="o">-&gt;</span><span class="n">region</span><span class="p">(</span><span class="n">i</span><span class="p">).</span><span class="n">shape_parameter</span><span class="p">(</span><span class="n">j</span><span class="p">);</span>
<span class="linenos">1027</span><span class="w">                    </span><span class="k">else</span>
<span class="linenos">1028</span><span class="w">                        </span><span class="n">shapeParams</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">j</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NAN</span><span class="p">;</span>
<span class="linenos">1029</span><span class="w">                </span><span class="p">}</span>
<span class="linenos">1030</span><span class="w">            </span><span class="p">}</span>
<span class="linenos">1031</span><span class="w">            </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5LTmake_dataset</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/Model/Spatial/Regions/ShapeParameters&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">RANK</span><span class="p">,</span><span class="w"> </span><span class="n">dims</span><span class="p">,</span><span class="w"> </span><span class="n">H5T_IEEE_F64LE</span><span class="p">,</span><span class="w"> </span><span class="n">shapeParams</span><span class="p">));</span>
<span class="linenos">1032</span><span class="w">            </span><span class="k">delete</span><span class="w"> </span><span class="p">[]</span><span class="w"> </span><span class="n">shapeParams</span><span class="p">;</span>
<span class="linenos">1033</span><span class="w">        </span><span class="p">}</span>
<span class="linenos">1034</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">1035</span>
<span class="linenos">1036</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">numberObstacles</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">1037</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">1038</span><span class="w">        </span><span class="c1">// Write the obstacle types table.</span>
<span class="linenos">1039</span><span class="w">        </span><span class="p">{</span>
<span class="linenos">1040</span><span class="w">            </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">RANK</span><span class="o">=</span><span class="mi">2</span><span class="p">;</span>
<span class="linenos">1041</span><span class="w">            </span><span class="n">hsize_t</span><span class="w"> </span><span class="n">dims</span><span class="p">[</span><span class="n">RANK</span><span class="p">];</span>
<span class="linenos">1042</span><span class="w">            </span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">numberObstacles</span><span class="p">;</span>
<span class="linenos">1043</span><span class="w">            </span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<span class="linenos">1044</span><span class="w">            </span><span class="n">uint</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">types</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">uint</span><span class="p">[</span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]];</span>
<span class="linenos">1045</span><span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">1046</span><span class="w">            </span><span class="p">{</span>
<span class="linenos">1047</span><span class="w">                </span><span class="n">types</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">spatialModel</span><span class="o">-&gt;</span><span class="n">obstacle</span><span class="p">(</span><span class="n">i</span><span class="p">).</span><span class="n">shape</span><span class="p">();</span>
<span class="linenos">1048</span><span class="w">                </span><span class="n">types</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">spatialModel</span><span class="o">-&gt;</span><span class="n">obstacle</span><span class="p">(</span><span class="n">i</span><span class="p">).</span><span class="n">site_type</span><span class="p">();</span>
<span class="linenos">1049</span><span class="w">            </span><span class="p">}</span>
<span class="linenos">1050</span><span class="w">            </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5LTmake_dataset</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/Model/Spatial/Obstacles/Types&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">RANK</span><span class="p">,</span><span class="w"> </span><span class="n">dims</span><span class="p">,</span><span class="w"> </span><span class="n">H5T_STD_U32LE</span><span class="p">,</span><span class="w"> </span><span class="n">types</span><span class="p">));</span>
<span class="linenos">1051</span><span class="w">            </span><span class="k">delete</span><span class="w"> </span><span class="p">[]</span><span class="w"> </span><span class="n">types</span><span class="p">;</span>
<span class="linenos">1052</span><span class="w">        </span><span class="p">}</span>
<span class="linenos">1053</span>
<span class="linenos">1054</span><span class="w">        </span><span class="c1">// Write the shape parameters table.</span>
<span class="linenos">1055</span><span class="w">        </span><span class="p">{</span>
<span class="linenos">1056</span><span class="w">            </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">RANK</span><span class="o">=</span><span class="mi">2</span><span class="p">;</span>
<span class="linenos">1057</span><span class="w">            </span><span class="n">hsize_t</span><span class="w"> </span><span class="n">dims</span><span class="p">[</span><span class="n">RANK</span><span class="p">];</span>
<span class="linenos">1058</span><span class="w">            </span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">numberObstacles</span><span class="p">;</span>
<span class="linenos">1059</span><span class="w">            </span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MAX_SHAPE_PARAMETERS</span><span class="p">;</span>
<span class="linenos">1060</span><span class="w">            </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">shapeParams</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">double</span><span class="p">[</span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]];</span>
<span class="linenos">1061</span><span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">1062</span><span class="w">            </span><span class="p">{</span>
<span class="linenos">1063</span><span class="w">                </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">&lt;</span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span><span class="w"> </span><span class="n">j</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">1064</span><span class="w">                </span><span class="p">{</span>
<span class="linenos">1065</span><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">j</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="p">)</span><span class="n">spatialModel</span><span class="o">-&gt;</span><span class="n">obstacle</span><span class="p">(</span><span class="n">i</span><span class="p">).</span><span class="n">shape_parameter_size</span><span class="p">())</span>
<span class="linenos">1066</span><span class="w">                        </span><span class="n">shapeParams</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">j</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">spatialModel</span><span class="o">-&gt;</span><span class="n">obstacle</span><span class="p">(</span><span class="n">i</span><span class="p">).</span><span class="n">shape_parameter</span><span class="p">(</span><span class="n">j</span><span class="p">);</span>
<span class="linenos">1067</span><span class="w">                    </span><span class="k">else</span>
<span class="linenos">1068</span><span class="w">                        </span><span class="n">shapeParams</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">j</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NAN</span><span class="p">;</span>
<span class="linenos">1069</span><span class="w">                </span><span class="p">}</span>
<span class="linenos">1070</span><span class="w">            </span><span class="p">}</span>
<span class="linenos">1071</span><span class="w">            </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5LTmake_dataset</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/Model/Spatial/Obstacles/ShapeParameters&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">RANK</span><span class="p">,</span><span class="w"> </span><span class="n">dims</span><span class="p">,</span><span class="w"> </span><span class="n">H5T_IEEE_F64LE</span><span class="p">,</span><span class="w"> </span><span class="n">shapeParams</span><span class="p">));</span>
<span class="linenos">1072</span><span class="w">            </span><span class="k">delete</span><span class="w"> </span><span class="p">[]</span><span class="w"> </span><span class="n">shapeParams</span><span class="p">;</span>
<span class="linenos">1073</span><span class="w">        </span><span class="p">}</span>
<span class="linenos">1074</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">1075</span><span class="p">}</span>
<span class="linenos">1076</span>
<span class="linenos">1077</span><span class="kt">bool</span><span class="w"> </span><span class="n">SimulationFile</span><span class="o">::</span><span class="n">replicateExists</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">replicate</span><span class="p">)</span>
<span class="linenos">1078</span><span class="p">{</span>
<span class="linenos">1079</span><span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">replicateName</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
<span class="linenos">1080</span><span class="w">    </span><span class="n">snprintf</span><span class="p">(</span><span class="n">replicateName</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">replicateName</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;%07d&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">replicate</span><span class="p">);</span>
<span class="linenos">1081</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">H5Lexists</span><span class="p">(</span><span class="n">simulationsGroup</span><span class="p">,</span><span class="w"> </span><span class="n">replicateName</span><span class="p">,</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="linenos">1082</span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="linenos">1083</span><span class="p">}</span>
<span class="linenos">1084</span>
<span class="linenos">1085</span><span class="kt">void</span><span class="w"> </span><span class="n">SimulationFile</span><span class="o">::</span><span class="n">openReplicate</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">replicate</span><span class="p">)</span>
<span class="linenos">1086</span><span class="p">{</span>
<span class="linenos">1087</span><span class="w">    </span><span class="n">openReplicateHandles</span><span class="p">(</span><span class="n">replicate</span><span class="p">);</span>
<span class="linenos">1088</span><span class="p">}</span>
<span class="linenos">1089</span>
<span class="linenos">1090</span><span class="kt">void</span><span class="w"> </span><span class="n">SimulationFile</span><span class="o">::</span><span class="n">appendSpeciesCounts</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">replicate</span><span class="p">,</span><span class="w"> </span><span class="n">lm</span><span class="o">::</span><span class="n">io</span><span class="o">::</span><span class="n">SpeciesCounts</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">speciesCounts</span><span class="p">)</span>
<span class="linenos">1091</span><span class="p">{</span>
<span class="linenos">1092</span><span class="w">    </span><span class="n">ReplicateHandles</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">handles</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">openReplicateHandles</span><span class="p">(</span><span class="n">replicate</span><span class="p">);</span>
<span class="linenos">1093</span>
<span class="linenos">1094</span><span class="w">    </span><span class="c1">// Update the species counts dataset.</span>
<span class="linenos">1095</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">1096</span><span class="w">        </span><span class="c1">// Get the current size of the dataset.</span>
<span class="linenos">1097</span><span class="w">        </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">RANK</span><span class="o">=</span><span class="mi">2</span><span class="p">;</span>
<span class="linenos">1098</span><span class="w">        </span><span class="n">hsize_t</span><span class="w"> </span><span class="n">dims</span><span class="p">[</span><span class="n">RANK</span><span class="p">];</span>
<span class="linenos">1099</span><span class="w">        </span><span class="n">hid_t</span><span class="w"> </span><span class="n">dataspace_id</span><span class="p">;</span>
<span class="linenos">1100</span><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>
<span class="linenos">1101</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CALL</span><span class="p">(</span><span class="n">dataspace_id</span><span class="p">,</span><span class="n">H5Dget_space</span><span class="p">(</span><span class="n">handles</span><span class="o">-&gt;</span><span class="n">speciesCountsDataset</span><span class="p">));</span>
<span class="linenos">1102</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CALL</span><span class="p">(</span><span class="n">result</span><span class="p">,</span><span class="n">H5Sget_simple_extent_dims</span><span class="p">(</span><span class="n">dataspace_id</span><span class="p">,</span><span class="w"> </span><span class="n">dims</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">));</span>
<span class="linenos">1103</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Sclose</span><span class="p">(</span><span class="n">dataspace_id</span><span class="p">));</span>
<span class="linenos">1104</span>
<span class="linenos">1105</span><span class="w">        </span><span class="c1">// Extend the dataset by the number of rows in the data set.</span>
<span class="linenos">1106</span><span class="w">        </span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">speciesCounts</span><span class="o">-&gt;</span><span class="n">number_entries</span><span class="p">();</span>
<span class="linenos">1107</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Dset_extent</span><span class="p">(</span><span class="n">handles</span><span class="o">-&gt;</span><span class="n">speciesCountsDataset</span><span class="p">,</span><span class="w"> </span><span class="n">dims</span><span class="p">));</span>
<span class="linenos">1108</span>
<span class="linenos">1109</span><span class="w">        </span><span class="c1">// Create the memory dataset.</span>
<span class="linenos">1110</span><span class="w">        </span><span class="n">hid_t</span><span class="w"> </span><span class="n">memspace_id</span><span class="p">;</span>
<span class="linenos">1111</span><span class="w">        </span><span class="n">hsize_t</span><span class="w"> </span><span class="n">memDims</span><span class="p">[</span><span class="n">RANK</span><span class="p">];</span>
<span class="linenos">1112</span><span class="w">        </span><span class="n">memDims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">speciesCounts</span><span class="o">-&gt;</span><span class="n">number_entries</span><span class="p">();</span>
<span class="linenos">1113</span><span class="w">        </span><span class="n">memDims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">speciesCounts</span><span class="o">-&gt;</span><span class="n">number_species</span><span class="p">();</span>
<span class="linenos">1114</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CALL</span><span class="p">(</span><span class="n">memspace_id</span><span class="p">,</span><span class="n">H5Screate_simple</span><span class="p">(</span><span class="n">RANK</span><span class="p">,</span><span class="w"> </span><span class="n">memDims</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">));</span>
<span class="linenos">1115</span>
<span class="linenos">1116</span><span class="w">        </span><span class="c1">// Write the new data.</span>
<span class="linenos">1117</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CALL</span><span class="p">(</span><span class="n">dataspace_id</span><span class="p">,</span><span class="n">H5Dget_space</span><span class="p">(</span><span class="n">handles</span><span class="o">-&gt;</span><span class="n">speciesCountsDataset</span><span class="p">));</span>
<span class="linenos">1118</span><span class="w">        </span><span class="n">hsize_t</span><span class="w"> </span><span class="n">start</span><span class="p">[</span><span class="n">RANK</span><span class="p">],</span><span class="w"> </span><span class="n">count</span><span class="p">[</span><span class="n">RANK</span><span class="p">];</span>
<span class="linenos">1119</span><span class="w">        </span><span class="n">start</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">speciesCounts</span><span class="o">-&gt;</span><span class="n">number_entries</span><span class="p">();</span>
<span class="linenos">1120</span><span class="w">        </span><span class="n">start</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">1121</span><span class="w">        </span><span class="n">count</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">memDims</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="linenos">1122</span><span class="w">        </span><span class="n">count</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">memDims</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<span class="linenos">1123</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Sselect_hyperslab</span><span class="p">(</span><span class="n">dataspace_id</span><span class="p">,</span><span class="w"> </span><span class="n">H5S_SELECT_SET</span><span class="p">,</span><span class="w"> </span><span class="n">start</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">count</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">));</span>
<span class="linenos">1124</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Dwrite</span><span class="p">(</span><span class="n">handles</span><span class="o">-&gt;</span><span class="n">speciesCountsDataset</span><span class="p">,</span><span class="w"> </span><span class="n">H5T_NATIVE_INT32</span><span class="p">,</span><span class="w"> </span><span class="n">memspace_id</span><span class="p">,</span><span class="w"> </span><span class="n">dataspace_id</span><span class="p">,</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">,</span><span class="w"> </span><span class="n">speciesCounts</span><span class="o">-&gt;</span><span class="n">species_count</span><span class="p">().</span><span class="n">data</span><span class="p">()));</span>
<span class="linenos">1125</span>
<span class="linenos">1126</span><span class="w">        </span><span class="c1">// Cleanup some resources.</span>
<span class="linenos">1127</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Sclose</span><span class="p">(</span><span class="n">dataspace_id</span><span class="p">));</span>
<span class="linenos">1128</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Sclose</span><span class="p">(</span><span class="n">memspace_id</span><span class="p">));</span>
<span class="linenos">1129</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">1130</span>
<span class="linenos">1131</span><span class="w">    </span><span class="c1">// Update the species count times dataset.</span>
<span class="linenos">1132</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">1133</span><span class="w">        </span><span class="c1">// Get the current size of the dataset.</span>
<span class="linenos">1134</span><span class="w">        </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">RANK</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
<span class="linenos">1135</span><span class="w">        </span><span class="n">hsize_t</span><span class="w"> </span><span class="n">dims</span><span class="p">[</span><span class="n">RANK</span><span class="p">];</span>
<span class="linenos">1136</span><span class="w">        </span><span class="n">hid_t</span><span class="w"> </span><span class="n">dataspace_id</span><span class="p">;</span>
<span class="linenos">1137</span><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>
<span class="linenos">1138</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CALL</span><span class="p">(</span><span class="n">dataspace_id</span><span class="p">,</span><span class="n">H5Dget_space</span><span class="p">(</span><span class="n">handles</span><span class="o">-&gt;</span><span class="n">speciesCountTimesDataset</span><span class="p">));</span>
<span class="linenos">1139</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CALL</span><span class="p">(</span><span class="n">result</span><span class="p">,</span><span class="n">H5Sget_simple_extent_dims</span><span class="p">(</span><span class="n">dataspace_id</span><span class="p">,</span><span class="w"> </span><span class="n">dims</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">));</span>
<span class="linenos">1140</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Sclose</span><span class="p">(</span><span class="n">dataspace_id</span><span class="p">));</span>
<span class="linenos">1141</span>
<span class="linenos">1142</span><span class="w">        </span><span class="c1">// Extend the dataset by the number of rows in the data set.</span>
<span class="linenos">1143</span><span class="w">        </span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">speciesCounts</span><span class="o">-&gt;</span><span class="n">number_entries</span><span class="p">();</span>
<span class="linenos">1144</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Dset_extent</span><span class="p">(</span><span class="n">handles</span><span class="o">-&gt;</span><span class="n">speciesCountTimesDataset</span><span class="p">,</span><span class="w"> </span><span class="n">dims</span><span class="p">));</span>
<span class="linenos">1145</span>
<span class="linenos">1146</span><span class="w">        </span><span class="c1">// Create the memory dataset.</span>
<span class="linenos">1147</span><span class="w">        </span><span class="n">hid_t</span><span class="w"> </span><span class="n">memspace_id</span><span class="p">;</span>
<span class="linenos">1148</span><span class="w">        </span><span class="n">hsize_t</span><span class="w"> </span><span class="n">memDims</span><span class="p">[</span><span class="n">RANK</span><span class="p">];</span>
<span class="linenos">1149</span><span class="w">        </span><span class="n">memDims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">speciesCounts</span><span class="o">-&gt;</span><span class="n">number_entries</span><span class="p">();</span>
<span class="linenos">1150</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CALL</span><span class="p">(</span><span class="n">memspace_id</span><span class="p">,</span><span class="n">H5Screate_simple</span><span class="p">(</span><span class="n">RANK</span><span class="p">,</span><span class="w"> </span><span class="n">memDims</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">));</span>
<span class="linenos">1151</span>
<span class="linenos">1152</span><span class="w">        </span><span class="c1">// Write the new data.</span>
<span class="linenos">1153</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CALL</span><span class="p">(</span><span class="n">dataspace_id</span><span class="p">,</span><span class="n">H5Dget_space</span><span class="p">(</span><span class="n">handles</span><span class="o">-&gt;</span><span class="n">speciesCountTimesDataset</span><span class="p">));</span>
<span class="linenos">1154</span><span class="w">        </span><span class="n">hsize_t</span><span class="w"> </span><span class="n">start</span><span class="p">[</span><span class="n">RANK</span><span class="p">],</span><span class="w"> </span><span class="n">count</span><span class="p">[</span><span class="n">RANK</span><span class="p">];</span>
<span class="linenos">1155</span><span class="w">        </span><span class="n">start</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">speciesCounts</span><span class="o">-&gt;</span><span class="n">number_entries</span><span class="p">();</span>
<span class="linenos">1156</span><span class="w">        </span><span class="n">count</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">memDims</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="linenos">1157</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Sselect_hyperslab</span><span class="p">(</span><span class="n">dataspace_id</span><span class="p">,</span><span class="w"> </span><span class="n">H5S_SELECT_SET</span><span class="p">,</span><span class="w"> </span><span class="n">start</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">count</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">));</span>
<span class="linenos">1158</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Dwrite</span><span class="p">(</span><span class="n">handles</span><span class="o">-&gt;</span><span class="n">speciesCountTimesDataset</span><span class="p">,</span><span class="w"> </span><span class="n">H5T_NATIVE_DOUBLE</span><span class="p">,</span><span class="w"> </span><span class="n">memspace_id</span><span class="p">,</span><span class="w"> </span><span class="n">dataspace_id</span><span class="p">,</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">,</span><span class="w"> </span><span class="n">speciesCounts</span><span class="o">-&gt;</span><span class="n">time</span><span class="p">().</span><span class="n">data</span><span class="p">()));</span>
<span class="linenos">1159</span>
<span class="linenos">1160</span><span class="w">        </span><span class="c1">// Cleanup some resources.</span>
<span class="linenos">1161</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Sclose</span><span class="p">(</span><span class="n">dataspace_id</span><span class="p">));</span>
<span class="linenos">1162</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Sclose</span><span class="p">(</span><span class="n">memspace_id</span><span class="p">));</span>
<span class="linenos">1163</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">1164</span><span class="p">}</span>
<span class="linenos">1165</span>
<span class="linenos">1166</span><span class="kt">void</span><span class="w"> </span><span class="n">SimulationFile</span><span class="o">::</span><span class="n">appendLattice</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">replicate</span><span class="p">,</span><span class="w"> </span><span class="n">lm</span><span class="o">::</span><span class="n">io</span><span class="o">::</span><span class="n">Lattice</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">lattice</span><span class="p">,</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">latticeData</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">latticeDataSize</span><span class="p">)</span>
<span class="linenos">1167</span><span class="p">{</span>
<span class="linenos">1168</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="p">(</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">lattice_x_size</span><span class="p">())</span><span class="o">*</span><span class="kt">size_t</span><span class="p">(</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">lattice_y_size</span><span class="p">())</span><span class="o">*</span><span class="kt">size_t</span><span class="p">(</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">lattice_z_size</span><span class="p">())</span><span class="o">*</span><span class="kt">size_t</span><span class="p">(</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">particles_per_site</span><span class="p">())</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">latticeDataSize</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="n">InvalidArgException</span><span class="p">(</span><span class="s">&quot;lattice&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;incorrect lattice size&quot;</span><span class="p">);</span>
<span class="linenos">1169</span>
<span class="linenos">1170</span><span class="w">    </span><span class="n">ReplicateHandles</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">replicateHandles</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">openReplicateHandles</span><span class="p">(</span><span class="n">replicate</span><span class="p">);</span>
<span class="linenos">1171</span>
<span class="linenos">1172</span><span class="w">    </span><span class="c1">// Open or create the lattice group.</span>
<span class="linenos">1173</span><span class="w">    </span><span class="n">hid_t</span><span class="w"> </span><span class="n">latticeGroupHandle</span><span class="p">,</span><span class="w"> </span><span class="n">latticeTimesDatasetHandle</span><span class="p">;</span>
<span class="linenos">1174</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">H5Lexists</span><span class="p">(</span><span class="n">replicateHandles</span><span class="o">-&gt;</span><span class="n">group</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Lattice&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">1175</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">1176</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CALL</span><span class="p">(</span><span class="n">latticeGroupHandle</span><span class="p">,</span><span class="n">H5Gopen2</span><span class="p">(</span><span class="n">replicateHandles</span><span class="o">-&gt;</span><span class="n">group</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Lattice&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">));</span>
<span class="linenos">1177</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CALL</span><span class="p">(</span><span class="n">latticeTimesDatasetHandle</span><span class="p">,</span><span class="n">H5Dopen2</span><span class="p">(</span><span class="n">replicateHandles</span><span class="o">-&gt;</span><span class="n">group</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;LatticeTimes&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">));</span>
<span class="linenos">1178</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">1179</span><span class="w">    </span><span class="k">else</span>
<span class="linenos">1180</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">1181</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CALL</span><span class="p">(</span><span class="n">latticeGroupHandle</span><span class="p">,</span><span class="n">H5Gcreate2</span><span class="p">(</span><span class="n">replicateHandles</span><span class="o">-&gt;</span><span class="n">group</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Lattice&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">,</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">,</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">));</span>
<span class="linenos">1182</span>
<span class="linenos">1183</span><span class="w">        </span><span class="c1">// Create the lattice times dataset.</span>
<span class="linenos">1184</span><span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">RANK</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
<span class="linenos">1185</span><span class="w">        </span><span class="n">hsize_t</span><span class="w"> </span><span class="n">dims</span><span class="p">[</span><span class="n">RANK</span><span class="p">],</span><span class="w"> </span><span class="n">maxDims</span><span class="p">[</span><span class="n">RANK</span><span class="p">],</span><span class="w"> </span><span class="n">chunkDims</span><span class="p">[</span><span class="n">RANK</span><span class="p">];</span>
<span class="linenos">1186</span><span class="w">        </span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">1187</span><span class="w">        </span><span class="n">maxDims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">H5S_UNLIMITED</span><span class="p">;</span>
<span class="linenos">1188</span><span class="w">        </span><span class="n">chunkDims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">100</span><span class="p">;</span>
<span class="linenos">1189</span><span class="w">        </span><span class="n">hid_t</span><span class="w"> </span><span class="n">dataspaceHandle</span><span class="p">,</span><span class="w"> </span><span class="n">propsHandle</span><span class="p">;</span>
<span class="linenos">1190</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CALL</span><span class="p">(</span><span class="n">dataspaceHandle</span><span class="p">,</span><span class="n">H5Screate_simple</span><span class="p">(</span><span class="n">RANK</span><span class="p">,</span><span class="w"> </span><span class="n">dims</span><span class="p">,</span><span class="w"> </span><span class="n">maxDims</span><span class="p">));</span>
<span class="linenos">1191</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CALL</span><span class="p">(</span><span class="n">propsHandle</span><span class="p">,</span><span class="n">H5Pcreate</span><span class="p">(</span><span class="n">H5P_DATASET_CREATE</span><span class="p">));</span>
<span class="linenos">1192</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Pset_chunk</span><span class="p">(</span><span class="n">propsHandle</span><span class="p">,</span><span class="w"> </span><span class="n">RANK</span><span class="p">,</span><span class="w"> </span><span class="n">chunkDims</span><span class="p">));</span>
<span class="linenos">1193</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CALL</span><span class="p">(</span><span class="n">latticeTimesDatasetHandle</span><span class="p">,</span><span class="n">H5Dcreate2</span><span class="p">(</span><span class="n">replicateHandles</span><span class="o">-&gt;</span><span class="n">group</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;LatticeTimes&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">H5T_IEEE_F64LE</span><span class="p">,</span><span class="w"> </span><span class="n">dataspaceHandle</span><span class="p">,</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">,</span><span class="w"> </span><span class="n">propsHandle</span><span class="p">,</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">));</span>
<span class="linenos">1194</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Pclose</span><span class="p">(</span><span class="n">propsHandle</span><span class="p">));</span>
<span class="linenos">1195</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Sclose</span><span class="p">(</span><span class="n">dataspaceHandle</span><span class="p">));</span>
<span class="linenos">1196</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">1197</span>
<span class="linenos">1198</span><span class="w">    </span><span class="c1">// Append the time to the times data set.</span>
<span class="linenos">1199</span><span class="w">    </span><span class="n">uint</span><span class="w"> </span><span class="n">latticeIndex</span><span class="p">;</span>
<span class="linenos">1200</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">1201</span><span class="w">        </span><span class="c1">// Get the current size of the dataset.</span>
<span class="linenos">1202</span><span class="w">        </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">RANK</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
<span class="linenos">1203</span><span class="w">        </span><span class="n">hsize_t</span><span class="w"> </span><span class="n">dims</span><span class="p">[</span><span class="n">RANK</span><span class="p">];</span>
<span class="linenos">1204</span><span class="w">        </span><span class="n">hid_t</span><span class="w"> </span><span class="n">dataspaceHandle</span><span class="p">;</span>
<span class="linenos">1205</span><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>
<span class="linenos">1206</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CALL</span><span class="p">(</span><span class="n">dataspaceHandle</span><span class="p">,</span><span class="n">H5Dget_space</span><span class="p">(</span><span class="n">latticeTimesDatasetHandle</span><span class="p">));</span>
<span class="linenos">1207</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CALL</span><span class="p">(</span><span class="n">result</span><span class="p">,</span><span class="n">H5Sget_simple_extent_dims</span><span class="p">(</span><span class="n">dataspaceHandle</span><span class="p">,</span><span class="w"> </span><span class="n">dims</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">));</span>
<span class="linenos">1208</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Sclose</span><span class="p">(</span><span class="n">dataspaceHandle</span><span class="p">));</span>
<span class="linenos">1209</span>
<span class="linenos">1210</span><span class="w">        </span><span class="c1">// Extend the dataset by the number of rows in the data set.</span>
<span class="linenos">1211</span><span class="w">        </span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="linenos">1212</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Dset_extent</span><span class="p">(</span><span class="n">latticeTimesDatasetHandle</span><span class="p">,</span><span class="w"> </span><span class="n">dims</span><span class="p">));</span>
<span class="linenos">1213</span>
<span class="linenos">1214</span><span class="w">        </span><span class="c1">// Create the memory dataset.</span>
<span class="linenos">1215</span><span class="w">        </span><span class="n">hid_t</span><span class="w"> </span><span class="n">memspaceHandle</span><span class="p">;</span>
<span class="linenos">1216</span><span class="w">        </span><span class="n">hsize_t</span><span class="w"> </span><span class="n">memDims</span><span class="p">[</span><span class="n">RANK</span><span class="p">];</span>
<span class="linenos">1217</span><span class="w">        </span><span class="n">memDims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="linenos">1218</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CALL</span><span class="p">(</span><span class="n">memspaceHandle</span><span class="p">,</span><span class="n">H5Screate_simple</span><span class="p">(</span><span class="n">RANK</span><span class="p">,</span><span class="w"> </span><span class="n">memDims</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">));</span>
<span class="linenos">1219</span>
<span class="linenos">1220</span><span class="w">        </span><span class="c1">// Write the new data.</span>
<span class="linenos">1221</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CALL</span><span class="p">(</span><span class="n">dataspaceHandle</span><span class="p">,</span><span class="n">H5Dget_space</span><span class="p">(</span><span class="n">latticeTimesDatasetHandle</span><span class="p">));</span>
<span class="linenos">1222</span><span class="w">        </span><span class="n">hsize_t</span><span class="w"> </span><span class="n">start</span><span class="p">[</span><span class="n">RANK</span><span class="p">],</span><span class="w"> </span><span class="n">count</span><span class="p">[</span><span class="n">RANK</span><span class="p">];</span>
<span class="linenos">1223</span><span class="w">        </span><span class="n">start</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="mi">-1</span><span class="p">;</span>
<span class="linenos">1224</span><span class="w">        </span><span class="n">latticeIndex</span><span class="o">=</span><span class="n">start</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="linenos">1225</span><span class="w">        </span><span class="n">count</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">memDims</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="linenos">1226</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Sselect_hyperslab</span><span class="p">(</span><span class="n">dataspaceHandle</span><span class="p">,</span><span class="w"> </span><span class="n">H5S_SELECT_SET</span><span class="p">,</span><span class="w"> </span><span class="n">start</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">count</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">));</span>
<span class="linenos">1227</span><span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">time</span><span class="p">();</span>
<span class="linenos">1228</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Dwrite</span><span class="p">(</span><span class="n">latticeTimesDatasetHandle</span><span class="p">,</span><span class="w"> </span><span class="n">H5T_NATIVE_DOUBLE</span><span class="p">,</span><span class="w"> </span><span class="n">memspaceHandle</span><span class="p">,</span><span class="w"> </span><span class="n">dataspaceHandle</span><span class="p">,</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">time</span><span class="p">));</span>
<span class="linenos">1229</span>
<span class="linenos">1230</span><span class="w">        </span><span class="c1">// Cleanup some resources.</span>
<span class="linenos">1231</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Sclose</span><span class="p">(</span><span class="n">dataspaceHandle</span><span class="p">));</span>
<span class="linenos">1232</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Sclose</span><span class="p">(</span><span class="n">memspaceHandle</span><span class="p">));</span>
<span class="linenos">1233</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">1234</span>
<span class="linenos">1235</span><span class="w">    </span><span class="c1">// Create the lattice data set.</span>
<span class="linenos">1236</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">1237</span><span class="w">        </span><span class="kt">char</span><span class="w"> </span><span class="n">latticeDatasetName</span><span class="p">[</span><span class="mi">11</span><span class="p">];</span>
<span class="linenos">1238</span><span class="w">        </span><span class="n">snprintf</span><span class="p">(</span><span class="n">latticeDatasetName</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">latticeDatasetName</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;%010d&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">latticeIndex</span><span class="p">);</span>
<span class="linenos">1239</span><span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">RANK</span><span class="o">=</span><span class="mi">4</span><span class="p">;</span>
<span class="linenos">1240</span><span class="w">        </span><span class="n">hsize_t</span><span class="w"> </span><span class="n">dims</span><span class="p">[</span><span class="n">RANK</span><span class="p">],</span><span class="w"> </span><span class="n">chunk</span><span class="p">[</span><span class="n">RANK</span><span class="p">];</span>
<span class="linenos">1241</span><span class="w">        </span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">lattice_x_size</span><span class="p">();</span>
<span class="linenos">1242</span><span class="w">        </span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">lattice_y_size</span><span class="p">();</span>
<span class="linenos">1243</span><span class="w">        </span><span class="n">dims</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">lattice_z_size</span><span class="p">();</span>
<span class="linenos">1244</span><span class="w">        </span><span class="n">dims</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">particles_per_site</span><span class="p">();</span>
<span class="linenos">1245</span><span class="w">        </span><span class="n">chunk</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">min</span><span class="p">((</span><span class="n">uint</span><span class="p">)</span><span class="n">TUNE_LATTICE_GZIP_CHUNK_SIZE</span><span class="p">,</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">lattice_x_size</span><span class="p">());</span>
<span class="linenos">1246</span><span class="w">        </span><span class="n">chunk</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">min</span><span class="p">((</span><span class="n">uint</span><span class="p">)</span><span class="n">TUNE_LATTICE_GZIP_CHUNK_SIZE</span><span class="p">,</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">lattice_y_size</span><span class="p">());</span>
<span class="linenos">1247</span><span class="w">        </span><span class="n">chunk</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">min</span><span class="p">((</span><span class="n">uint</span><span class="p">)</span><span class="n">TUNE_LATTICE_GZIP_CHUNK_SIZE</span><span class="p">,</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">lattice_z_size</span><span class="p">());</span>
<span class="linenos">1248</span><span class="w">        </span><span class="n">chunk</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">particles_per_site</span><span class="p">();</span>
<span class="linenos">1249</span><span class="w">        </span><span class="n">hid_t</span><span class="w"> </span><span class="n">dataspaceHandle</span><span class="p">,</span><span class="w"> </span><span class="n">dcplHandle</span><span class="p">,</span><span class="w"> </span><span class="n">datasetHandle</span><span class="p">;</span>
<span class="linenos">1250</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CALL</span><span class="p">(</span><span class="n">dataspaceHandle</span><span class="p">,</span><span class="n">H5Screate_simple</span><span class="p">(</span><span class="n">RANK</span><span class="p">,</span><span class="w"> </span><span class="n">dims</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">));</span>
<span class="linenos">1251</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CALL</span><span class="p">(</span><span class="n">dcplHandle</span><span class="p">,</span><span class="n">H5Pcreate</span><span class="p">(</span><span class="n">H5P_DATASET_CREATE</span><span class="p">));</span>
<span class="linenos">1252</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Pset_deflate</span><span class="w"> </span><span class="p">(</span><span class="n">dcplHandle</span><span class="p">,</span><span class="w"> </span><span class="n">TUNE_LATTICE_GZIP_COMPRESSION_LEVEL</span><span class="p">));</span>
<span class="linenos">1253</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Pset_chunk</span><span class="p">(</span><span class="n">dcplHandle</span><span class="p">,</span><span class="w"> </span><span class="n">RANK</span><span class="p">,</span><span class="w"> </span><span class="n">chunk</span><span class="p">));</span>
<span class="linenos">1254</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CALL</span><span class="p">(</span><span class="n">datasetHandle</span><span class="p">,</span><span class="n">H5Dcreate2</span><span class="p">(</span><span class="n">latticeGroupHandle</span><span class="p">,</span><span class="w"> </span><span class="n">latticeDatasetName</span><span class="p">,</span><span class="w"> </span><span class="n">H5T_STD_U8LE</span><span class="p">,</span><span class="w"> </span><span class="n">dataspaceHandle</span><span class="p">,</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">,</span><span class="w"> </span><span class="n">dcplHandle</span><span class="p">,</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">));</span>
<span class="linenos">1255</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Dwrite</span><span class="p">(</span><span class="n">datasetHandle</span><span class="p">,</span><span class="w"> </span><span class="n">H5T_NATIVE_UINT8</span><span class="p">,</span><span class="w"> </span><span class="n">H5S_ALL</span><span class="p">,</span><span class="w"> </span><span class="n">H5S_ALL</span><span class="p">,</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">,</span><span class="w"> </span><span class="n">latticeData</span><span class="p">));</span>
<span class="linenos">1256</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Dclose</span><span class="p">(</span><span class="n">datasetHandle</span><span class="p">));</span>
<span class="linenos">1257</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Pclose</span><span class="p">(</span><span class="n">dcplHandle</span><span class="p">));</span>
<span class="linenos">1258</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Sclose</span><span class="p">(</span><span class="n">dataspaceHandle</span><span class="p">));</span>
<span class="linenos">1259</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">1260</span>
<span class="linenos">1261</span><span class="w">    </span><span class="c1">// Cleanup some resources.</span>
<span class="linenos">1262</span><span class="w">    </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Dclose</span><span class="p">(</span><span class="n">latticeTimesDatasetHandle</span><span class="p">));</span>
<span class="linenos">1263</span><span class="w">    </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Gclose</span><span class="p">(</span><span class="n">latticeGroupHandle</span><span class="p">));</span>
<span class="linenos">1264</span>
<span class="linenos">1265</span><span class="p">}</span>
<span class="linenos">1266</span>
<span class="linenos">1267</span><span class="kt">void</span><span class="w"> </span><span class="n">SimulationFile</span><span class="o">::</span><span class="n">appendLattice_U32LE</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">replicate</span><span class="p">,</span><span class="w"> </span><span class="n">lm</span><span class="o">::</span><span class="n">io</span><span class="o">::</span><span class="n">Lattice</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">lattice</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">latticeData</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">latticeDataSize</span><span class="p">)</span>
<span class="linenos">1268</span><span class="p">{</span>
<span class="linenos">1269</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">lattice_x_size</span><span class="p">()</span><span class="o">*</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">lattice_y_size</span><span class="p">()</span><span class="o">*</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">lattice_z_size</span><span class="p">()</span><span class="o">*</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">particles_per_site</span><span class="p">()</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">latticeDataSize</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="n">InvalidArgException</span><span class="p">(</span><span class="s">&quot;lattice&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;incorrect lattice size&quot;</span><span class="p">);</span>
<span class="linenos">1270</span>
<span class="linenos">1271</span><span class="w">    </span><span class="n">ReplicateHandles</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">replicateHandles</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">openReplicateHandles</span><span class="p">(</span><span class="n">replicate</span><span class="p">);</span>
<span class="linenos">1272</span>
<span class="linenos">1273</span><span class="w">    </span><span class="c1">// Open or create the lattice group.</span>
<span class="linenos">1274</span><span class="w">    </span><span class="n">hid_t</span><span class="w"> </span><span class="n">latticeGroupHandle</span><span class="p">,</span><span class="w"> </span><span class="n">latticeTimesDatasetHandle</span><span class="p">;</span>
<span class="linenos">1275</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">H5Lexists</span><span class="p">(</span><span class="n">replicateHandles</span><span class="o">-&gt;</span><span class="n">group</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Lattice&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">1276</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">1277</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CALL</span><span class="p">(</span><span class="n">latticeGroupHandle</span><span class="p">,</span><span class="n">H5Gopen2</span><span class="p">(</span><span class="n">replicateHandles</span><span class="o">-&gt;</span><span class="n">group</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Lattice&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">));</span>
<span class="linenos">1278</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CALL</span><span class="p">(</span><span class="n">latticeTimesDatasetHandle</span><span class="p">,</span><span class="n">H5Dopen2</span><span class="p">(</span><span class="n">replicateHandles</span><span class="o">-&gt;</span><span class="n">group</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;LatticeTimes&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">));</span>
<span class="linenos">1279</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">1280</span><span class="w">    </span><span class="k">else</span>
<span class="linenos">1281</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">1282</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CALL</span><span class="p">(</span><span class="n">latticeGroupHandle</span><span class="p">,</span><span class="n">H5Gcreate2</span><span class="p">(</span><span class="n">replicateHandles</span><span class="o">-&gt;</span><span class="n">group</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Lattice&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">,</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">,</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">));</span>
<span class="linenos">1283</span>
<span class="linenos">1284</span><span class="w">        </span><span class="c1">// Create the lattice times dataset.</span>
<span class="linenos">1285</span><span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">RANK</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
<span class="linenos">1286</span><span class="w">        </span><span class="n">hsize_t</span><span class="w"> </span><span class="n">dims</span><span class="p">[</span><span class="n">RANK</span><span class="p">],</span><span class="w"> </span><span class="n">maxDims</span><span class="p">[</span><span class="n">RANK</span><span class="p">],</span><span class="w"> </span><span class="n">chunkDims</span><span class="p">[</span><span class="n">RANK</span><span class="p">];</span>
<span class="linenos">1287</span><span class="w">        </span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">1288</span><span class="w">        </span><span class="n">maxDims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">H5S_UNLIMITED</span><span class="p">;</span>
<span class="linenos">1289</span><span class="w">        </span><span class="n">chunkDims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">100</span><span class="p">;</span>
<span class="linenos">1290</span><span class="w">        </span><span class="n">hid_t</span><span class="w"> </span><span class="n">dataspaceHandle</span><span class="p">,</span><span class="w"> </span><span class="n">propsHandle</span><span class="p">;</span>
<span class="linenos">1291</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CALL</span><span class="p">(</span><span class="n">dataspaceHandle</span><span class="p">,</span><span class="n">H5Screate_simple</span><span class="p">(</span><span class="n">RANK</span><span class="p">,</span><span class="w"> </span><span class="n">dims</span><span class="p">,</span><span class="w"> </span><span class="n">maxDims</span><span class="p">));</span>
<span class="linenos">1292</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CALL</span><span class="p">(</span><span class="n">propsHandle</span><span class="p">,</span><span class="n">H5Pcreate</span><span class="p">(</span><span class="n">H5P_DATASET_CREATE</span><span class="p">));</span>
<span class="linenos">1293</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Pset_chunk</span><span class="p">(</span><span class="n">propsHandle</span><span class="p">,</span><span class="w"> </span><span class="n">RANK</span><span class="p">,</span><span class="w"> </span><span class="n">chunkDims</span><span class="p">));</span>
<span class="linenos">1294</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CALL</span><span class="p">(</span><span class="n">latticeTimesDatasetHandle</span><span class="p">,</span><span class="n">H5Dcreate2</span><span class="p">(</span><span class="n">replicateHandles</span><span class="o">-&gt;</span><span class="n">group</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;LatticeTimes&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">H5T_IEEE_F64LE</span><span class="p">,</span><span class="w"> </span><span class="n">dataspaceHandle</span><span class="p">,</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">,</span><span class="w"> </span><span class="n">propsHandle</span><span class="p">,</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">));</span>
<span class="linenos">1295</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Pclose</span><span class="p">(</span><span class="n">propsHandle</span><span class="p">));</span>
<span class="linenos">1296</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Sclose</span><span class="p">(</span><span class="n">dataspaceHandle</span><span class="p">));</span>
<span class="linenos">1297</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">1298</span>
<span class="linenos">1299</span><span class="w">    </span><span class="c1">// Append the time to the times data set.</span>
<span class="linenos">1300</span><span class="w">    </span><span class="n">uint</span><span class="w"> </span><span class="n">latticeIndex</span><span class="p">;</span>
<span class="linenos">1301</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">1302</span><span class="w">        </span><span class="c1">// Get the current size of the dataset.</span>
<span class="linenos">1303</span><span class="w">        </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">RANK</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
<span class="linenos">1304</span><span class="w">        </span><span class="n">hsize_t</span><span class="w"> </span><span class="n">dims</span><span class="p">[</span><span class="n">RANK</span><span class="p">];</span>
<span class="linenos">1305</span><span class="w">        </span><span class="n">hid_t</span><span class="w"> </span><span class="n">dataspaceHandle</span><span class="p">;</span>
<span class="linenos">1306</span><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>
<span class="linenos">1307</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CALL</span><span class="p">(</span><span class="n">dataspaceHandle</span><span class="p">,</span><span class="n">H5Dget_space</span><span class="p">(</span><span class="n">latticeTimesDatasetHandle</span><span class="p">));</span>
<span class="linenos">1308</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CALL</span><span class="p">(</span><span class="n">result</span><span class="p">,</span><span class="n">H5Sget_simple_extent_dims</span><span class="p">(</span><span class="n">dataspaceHandle</span><span class="p">,</span><span class="w"> </span><span class="n">dims</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">));</span>
<span class="linenos">1309</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Sclose</span><span class="p">(</span><span class="n">dataspaceHandle</span><span class="p">));</span>
<span class="linenos">1310</span>
<span class="linenos">1311</span><span class="w">        </span><span class="c1">// Extend the dataset by the number of rows in the data set.</span>
<span class="linenos">1312</span><span class="w">        </span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="linenos">1313</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Dset_extent</span><span class="p">(</span><span class="n">latticeTimesDatasetHandle</span><span class="p">,</span><span class="w"> </span><span class="n">dims</span><span class="p">));</span>
<span class="linenos">1314</span>
<span class="linenos">1315</span><span class="w">        </span><span class="c1">// Create the memory dataset.</span>
<span class="linenos">1316</span><span class="w">        </span><span class="n">hid_t</span><span class="w"> </span><span class="n">memspaceHandle</span><span class="p">;</span>
<span class="linenos">1317</span><span class="w">        </span><span class="n">hsize_t</span><span class="w"> </span><span class="n">memDims</span><span class="p">[</span><span class="n">RANK</span><span class="p">];</span>
<span class="linenos">1318</span><span class="w">        </span><span class="n">memDims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="linenos">1319</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CALL</span><span class="p">(</span><span class="n">memspaceHandle</span><span class="p">,</span><span class="n">H5Screate_simple</span><span class="p">(</span><span class="n">RANK</span><span class="p">,</span><span class="w"> </span><span class="n">memDims</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">));</span>
<span class="linenos">1320</span>
<span class="linenos">1321</span><span class="w">        </span><span class="c1">// Write the new data.</span>
<span class="linenos">1322</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CALL</span><span class="p">(</span><span class="n">dataspaceHandle</span><span class="p">,</span><span class="n">H5Dget_space</span><span class="p">(</span><span class="n">latticeTimesDatasetHandle</span><span class="p">));</span>
<span class="linenos">1323</span><span class="w">        </span><span class="n">hsize_t</span><span class="w"> </span><span class="n">start</span><span class="p">[</span><span class="n">RANK</span><span class="p">],</span><span class="w"> </span><span class="n">count</span><span class="p">[</span><span class="n">RANK</span><span class="p">];</span>
<span class="linenos">1324</span><span class="w">        </span><span class="n">start</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="mi">-1</span><span class="p">;</span>
<span class="linenos">1325</span><span class="w">        </span><span class="n">latticeIndex</span><span class="o">=</span><span class="n">start</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="linenos">1326</span><span class="w">        </span><span class="n">count</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">memDims</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="linenos">1327</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Sselect_hyperslab</span><span class="p">(</span><span class="n">dataspaceHandle</span><span class="p">,</span><span class="w"> </span><span class="n">H5S_SELECT_SET</span><span class="p">,</span><span class="w"> </span><span class="n">start</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">count</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">));</span>
<span class="linenos">1328</span><span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">time</span><span class="p">();</span>
<span class="linenos">1329</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Dwrite</span><span class="p">(</span><span class="n">latticeTimesDatasetHandle</span><span class="p">,</span><span class="w"> </span><span class="n">H5T_NATIVE_DOUBLE</span><span class="p">,</span><span class="w"> </span><span class="n">memspaceHandle</span><span class="p">,</span><span class="w"> </span><span class="n">dataspaceHandle</span><span class="p">,</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">time</span><span class="p">));</span>
<span class="linenos">1330</span>
<span class="linenos">1331</span><span class="w">        </span><span class="c1">// Cleanup some resources.</span>
<span class="linenos">1332</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Sclose</span><span class="p">(</span><span class="n">dataspaceHandle</span><span class="p">));</span>
<span class="linenos">1333</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Sclose</span><span class="p">(</span><span class="n">memspaceHandle</span><span class="p">));</span>
<span class="linenos">1334</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">1335</span>
<span class="linenos">1336</span><span class="w">	</span><span class="kt">char</span><span class="w"> </span><span class="n">latticeDatasetName</span><span class="p">[</span><span class="mi">11</span><span class="p">];</span>
<span class="linenos">1337</span><span class="w">	</span><span class="n">snprintf</span><span class="p">(</span><span class="n">latticeDatasetName</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">latticeDatasetName</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;%010d&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">latticeIndex</span><span class="p">);</span>
<span class="linenos">1338</span><span class="w">	</span><span class="n">writeParticleLattice_U32LE</span><span class="p">(</span><span class="n">latticeGroupHandle</span><span class="p">,</span><span class="w"> </span><span class="n">latticeDatasetName</span><span class="p">,</span><span class="w"> </span><span class="n">latticeData</span><span class="p">,</span><span class="w"> </span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">lattice_x_size</span><span class="p">(),</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">lattice_y_size</span><span class="p">(),</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">lattice_z_size</span><span class="p">(),</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">particles_per_site</span><span class="p">());</span>
<span class="linenos">1339</span><span class="w">	</span>
<span class="linenos">1340</span>
<span class="linenos">1341</span><span class="w">    </span><span class="c1">// Cleanup some resources.</span>
<span class="linenos">1342</span><span class="w">    </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Dclose</span><span class="p">(</span><span class="n">latticeTimesDatasetHandle</span><span class="p">));</span>
<span class="linenos">1343</span><span class="w">    </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Gclose</span><span class="p">(</span><span class="n">latticeGroupHandle</span><span class="p">));</span>
<span class="linenos">1344</span>
<span class="linenos">1345</span><span class="p">}</span>
<span class="linenos">1346</span>
<span class="linenos">1347</span><span class="kt">void</span><span class="w"> </span><span class="n">SimulationFile</span><span class="o">::</span><span class="n">appendSites</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">replicate</span><span class="p">,</span><span class="w"> </span><span class="n">lm</span><span class="o">::</span><span class="n">io</span><span class="o">::</span><span class="n">Lattice</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">lattice</span><span class="p">,</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">siteData</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">siteDataSize</span><span class="p">)</span>
<span class="linenos">1348</span><span class="p">{</span>
<span class="linenos">1349</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">lattice_x_size</span><span class="p">()</span><span class="o">*</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">lattice_y_size</span><span class="p">()</span><span class="o">*</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">lattice_z_size</span><span class="p">()</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">siteDataSize</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="n">InvalidArgException</span><span class="p">(</span><span class="s">&quot;siteData&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;incorrect lattice size&quot;</span><span class="p">);</span>
<span class="linenos">1350</span>
<span class="linenos">1351</span><span class="w">    </span><span class="n">ReplicateHandles</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">replicateHandles</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">openReplicateHandles</span><span class="p">(</span><span class="n">replicate</span><span class="p">);</span>
<span class="linenos">1352</span>
<span class="linenos">1353</span><span class="w">    </span><span class="c1">// Open or create the sites group</span>
<span class="linenos">1354</span><span class="w">    </span><span class="n">hid_t</span><span class="w"> </span><span class="n">siteGroupHandle</span><span class="p">,</span><span class="w"> </span><span class="n">latticeTimesDatasetHandle</span><span class="p">;</span>
<span class="linenos">1355</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">H5Lexists</span><span class="p">(</span><span class="n">replicateHandles</span><span class="o">-&gt;</span><span class="n">group</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Sites&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">1356</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">1357</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CALL</span><span class="p">(</span><span class="n">siteGroupHandle</span><span class="p">,</span><span class="n">H5Gopen2</span><span class="p">(</span><span class="n">replicateHandles</span><span class="o">-&gt;</span><span class="n">group</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Sites&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">));</span>
<span class="linenos">1358</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CALL</span><span class="p">(</span><span class="n">latticeTimesDatasetHandle</span><span class="p">,</span><span class="n">H5Dopen2</span><span class="p">(</span><span class="n">replicateHandles</span><span class="o">-&gt;</span><span class="n">group</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;SiteTimes&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">));</span>
<span class="linenos">1359</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">1360</span><span class="w">    </span><span class="k">else</span>
<span class="linenos">1361</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">1362</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CALL</span><span class="p">(</span><span class="n">siteGroupHandle</span><span class="p">,</span><span class="n">H5Gcreate2</span><span class="p">(</span><span class="n">replicateHandles</span><span class="o">-&gt;</span><span class="n">group</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Sites&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">,</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">,</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">));</span>
<span class="linenos">1363</span>
<span class="linenos">1364</span><span class="w">        </span><span class="c1">// Create the SiteTimes dataset.</span>
<span class="linenos">1365</span><span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">RANK</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
<span class="linenos">1366</span><span class="w">        </span><span class="n">hsize_t</span><span class="w"> </span><span class="n">dims</span><span class="p">[</span><span class="n">RANK</span><span class="p">],</span><span class="w"> </span><span class="n">maxDims</span><span class="p">[</span><span class="n">RANK</span><span class="p">],</span><span class="w"> </span><span class="n">chunkDims</span><span class="p">[</span><span class="n">RANK</span><span class="p">];</span>
<span class="linenos">1367</span><span class="w">        </span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">1368</span><span class="w">        </span><span class="n">maxDims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">H5S_UNLIMITED</span><span class="p">;</span>
<span class="linenos">1369</span><span class="w">        </span><span class="n">chunkDims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">100</span><span class="p">;</span>
<span class="linenos">1370</span><span class="w">        </span><span class="n">hid_t</span><span class="w"> </span><span class="n">dataspaceHandle</span><span class="p">,</span><span class="w"> </span><span class="n">propsHandle</span><span class="p">;</span>
<span class="linenos">1371</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CALL</span><span class="p">(</span><span class="n">dataspaceHandle</span><span class="p">,</span><span class="n">H5Screate_simple</span><span class="p">(</span><span class="n">RANK</span><span class="p">,</span><span class="w"> </span><span class="n">dims</span><span class="p">,</span><span class="w"> </span><span class="n">maxDims</span><span class="p">));</span>
<span class="linenos">1372</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CALL</span><span class="p">(</span><span class="n">propsHandle</span><span class="p">,</span><span class="n">H5Pcreate</span><span class="p">(</span><span class="n">H5P_DATASET_CREATE</span><span class="p">));</span>
<span class="linenos">1373</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Pset_chunk</span><span class="p">(</span><span class="n">propsHandle</span><span class="p">,</span><span class="w"> </span><span class="n">RANK</span><span class="p">,</span><span class="w"> </span><span class="n">chunkDims</span><span class="p">));</span>
<span class="linenos">1374</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CALL</span><span class="p">(</span><span class="n">latticeTimesDatasetHandle</span><span class="p">,</span><span class="n">H5Dcreate2</span><span class="p">(</span><span class="n">replicateHandles</span><span class="o">-&gt;</span><span class="n">group</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;SiteTimes&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">H5T_IEEE_F64LE</span><span class="p">,</span><span class="w"> </span><span class="n">dataspaceHandle</span><span class="p">,</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">,</span><span class="w"> </span><span class="n">propsHandle</span><span class="p">,</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">));</span>
<span class="linenos">1375</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Pclose</span><span class="p">(</span><span class="n">propsHandle</span><span class="p">));</span>
<span class="linenos">1376</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Sclose</span><span class="p">(</span><span class="n">dataspaceHandle</span><span class="p">));</span>
<span class="linenos">1377</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">1378</span>
<span class="linenos">1379</span><span class="w">    </span><span class="c1">// Append the time to the times data set.</span>
<span class="linenos">1380</span><span class="w">    </span><span class="n">uint</span><span class="w"> </span><span class="n">latticeIndex</span><span class="p">;</span>
<span class="linenos">1381</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">1382</span><span class="w">        </span><span class="c1">// Get the current size of the dataset.</span>
<span class="linenos">1383</span><span class="w">        </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">RANK</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
<span class="linenos">1384</span><span class="w">        </span><span class="n">hsize_t</span><span class="w"> </span><span class="n">dims</span><span class="p">[</span><span class="n">RANK</span><span class="p">];</span>
<span class="linenos">1385</span><span class="w">        </span><span class="n">hid_t</span><span class="w"> </span><span class="n">dataspaceHandle</span><span class="p">;</span>
<span class="linenos">1386</span><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>
<span class="linenos">1387</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CALL</span><span class="p">(</span><span class="n">dataspaceHandle</span><span class="p">,</span><span class="n">H5Dget_space</span><span class="p">(</span><span class="n">latticeTimesDatasetHandle</span><span class="p">));</span>
<span class="linenos">1388</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CALL</span><span class="p">(</span><span class="n">result</span><span class="p">,</span><span class="n">H5Sget_simple_extent_dims</span><span class="p">(</span><span class="n">dataspaceHandle</span><span class="p">,</span><span class="w"> </span><span class="n">dims</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">));</span>
<span class="linenos">1389</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Sclose</span><span class="p">(</span><span class="n">dataspaceHandle</span><span class="p">));</span>
<span class="linenos">1390</span>
<span class="linenos">1391</span><span class="w">        </span><span class="c1">// Extend the dataset by the number of rows in the data set.</span>
<span class="linenos">1392</span><span class="w">        </span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="linenos">1393</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Dset_extent</span><span class="p">(</span><span class="n">latticeTimesDatasetHandle</span><span class="p">,</span><span class="w"> </span><span class="n">dims</span><span class="p">));</span>
<span class="linenos">1394</span>
<span class="linenos">1395</span><span class="w">        </span><span class="c1">// Create the memory dataset.</span>
<span class="linenos">1396</span><span class="w">        </span><span class="n">hid_t</span><span class="w"> </span><span class="n">memspaceHandle</span><span class="p">;</span>
<span class="linenos">1397</span><span class="w">        </span><span class="n">hsize_t</span><span class="w"> </span><span class="n">memDims</span><span class="p">[</span><span class="n">RANK</span><span class="p">];</span>
<span class="linenos">1398</span><span class="w">        </span><span class="n">memDims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="linenos">1399</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CALL</span><span class="p">(</span><span class="n">memspaceHandle</span><span class="p">,</span><span class="n">H5Screate_simple</span><span class="p">(</span><span class="n">RANK</span><span class="p">,</span><span class="w"> </span><span class="n">memDims</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">));</span>
<span class="linenos">1400</span>
<span class="linenos">1401</span><span class="w">        </span><span class="c1">// Write the new data.</span>
<span class="linenos">1402</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CALL</span><span class="p">(</span><span class="n">dataspaceHandle</span><span class="p">,</span><span class="n">H5Dget_space</span><span class="p">(</span><span class="n">latticeTimesDatasetHandle</span><span class="p">));</span>
<span class="linenos">1403</span><span class="w">        </span><span class="n">hsize_t</span><span class="w"> </span><span class="n">start</span><span class="p">[</span><span class="n">RANK</span><span class="p">],</span><span class="w"> </span><span class="n">count</span><span class="p">[</span><span class="n">RANK</span><span class="p">];</span>
<span class="linenos">1404</span><span class="w">        </span><span class="n">start</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="mi">-1</span><span class="p">;</span>
<span class="linenos">1405</span><span class="w">        </span><span class="n">latticeIndex</span><span class="o">=</span><span class="n">start</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="linenos">1406</span><span class="w">        </span><span class="n">count</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">memDims</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="linenos">1407</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Sselect_hyperslab</span><span class="p">(</span><span class="n">dataspaceHandle</span><span class="p">,</span><span class="w"> </span><span class="n">H5S_SELECT_SET</span><span class="p">,</span><span class="w"> </span><span class="n">start</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">count</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">));</span>
<span class="linenos">1408</span><span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">time</span><span class="p">();</span>
<span class="linenos">1409</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Dwrite</span><span class="p">(</span><span class="n">latticeTimesDatasetHandle</span><span class="p">,</span><span class="w"> </span><span class="n">H5T_NATIVE_DOUBLE</span><span class="p">,</span><span class="w"> </span><span class="n">memspaceHandle</span><span class="p">,</span><span class="w"> </span><span class="n">dataspaceHandle</span><span class="p">,</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">time</span><span class="p">));</span>
<span class="linenos">1410</span>
<span class="linenos">1411</span><span class="w">        </span><span class="c1">// Cleanup some resources.</span>
<span class="linenos">1412</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Sclose</span><span class="p">(</span><span class="n">dataspaceHandle</span><span class="p">));</span>
<span class="linenos">1413</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Sclose</span><span class="p">(</span><span class="n">memspaceHandle</span><span class="p">));</span>
<span class="linenos">1414</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">1415</span>
<span class="linenos">1416</span><span class="w">    </span><span class="c1">// Create the lattice data set.</span>
<span class="linenos">1417</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">1418</span><span class="w">        </span><span class="kt">char</span><span class="w"> </span><span class="n">latticeDatasetName</span><span class="p">[</span><span class="mi">11</span><span class="p">];</span>
<span class="linenos">1419</span><span class="w">        </span><span class="n">snprintf</span><span class="p">(</span><span class="n">latticeDatasetName</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">latticeDatasetName</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;%010d&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">latticeIndex</span><span class="p">);</span>
<span class="linenos">1420</span><span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">RANK</span><span class="o">=</span><span class="mi">3</span><span class="p">;</span>
<span class="linenos">1421</span><span class="w">        </span><span class="n">hsize_t</span><span class="w"> </span><span class="n">dims</span><span class="p">[</span><span class="n">RANK</span><span class="p">],</span><span class="w"> </span><span class="n">chunk</span><span class="p">[</span><span class="n">RANK</span><span class="p">];</span>
<span class="linenos">1422</span><span class="w">        </span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">lattice_x_size</span><span class="p">();</span>
<span class="linenos">1423</span><span class="w">        </span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">lattice_y_size</span><span class="p">();</span>
<span class="linenos">1424</span><span class="w">        </span><span class="n">dims</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">lattice_z_size</span><span class="p">();</span>
<span class="linenos">1425</span><span class="w">        </span><span class="n">chunk</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">min</span><span class="p">((</span><span class="n">uint</span><span class="p">)</span><span class="n">TUNE_LATTICE_GZIP_CHUNK_SIZE</span><span class="p">,</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">lattice_x_size</span><span class="p">());</span>
<span class="linenos">1426</span><span class="w">        </span><span class="n">chunk</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">min</span><span class="p">((</span><span class="n">uint</span><span class="p">)</span><span class="n">TUNE_LATTICE_GZIP_CHUNK_SIZE</span><span class="p">,</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">lattice_y_size</span><span class="p">());</span>
<span class="linenos">1427</span><span class="w">        </span><span class="n">chunk</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">min</span><span class="p">((</span><span class="n">uint</span><span class="p">)</span><span class="n">TUNE_LATTICE_GZIP_CHUNK_SIZE</span><span class="p">,</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">lattice_z_size</span><span class="p">());</span>
<span class="linenos">1428</span><span class="w">        </span><span class="n">hid_t</span><span class="w"> </span><span class="n">dataspaceHandle</span><span class="p">,</span><span class="w"> </span><span class="n">dcplHandle</span><span class="p">,</span><span class="w"> </span><span class="n">datasetHandle</span><span class="p">;</span>
<span class="linenos">1429</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CALL</span><span class="p">(</span><span class="n">dataspaceHandle</span><span class="p">,</span><span class="n">H5Screate_simple</span><span class="p">(</span><span class="n">RANK</span><span class="p">,</span><span class="w"> </span><span class="n">dims</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">));</span>
<span class="linenos">1430</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CALL</span><span class="p">(</span><span class="n">dcplHandle</span><span class="p">,</span><span class="n">H5Pcreate</span><span class="p">(</span><span class="n">H5P_DATASET_CREATE</span><span class="p">));</span>
<span class="linenos">1431</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Pset_deflate</span><span class="w"> </span><span class="p">(</span><span class="n">dcplHandle</span><span class="p">,</span><span class="w"> </span><span class="n">TUNE_LATTICE_GZIP_COMPRESSION_LEVEL</span><span class="p">));</span>
<span class="linenos">1432</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Pset_chunk</span><span class="p">(</span><span class="n">dcplHandle</span><span class="p">,</span><span class="w"> </span><span class="n">RANK</span><span class="p">,</span><span class="w"> </span><span class="n">chunk</span><span class="p">));</span>
<span class="linenos">1433</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CALL</span><span class="p">(</span><span class="n">datasetHandle</span><span class="p">,</span><span class="n">H5Dcreate2</span><span class="p">(</span><span class="n">siteGroupHandle</span><span class="p">,</span><span class="w"> </span><span class="n">latticeDatasetName</span><span class="p">,</span><span class="w"> </span><span class="n">H5T_STD_U8LE</span><span class="p">,</span><span class="w"> </span><span class="n">dataspaceHandle</span><span class="p">,</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">,</span><span class="w"> </span><span class="n">dcplHandle</span><span class="p">,</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">));</span>
<span class="linenos">1434</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Dwrite</span><span class="p">(</span><span class="n">datasetHandle</span><span class="p">,</span><span class="w"> </span><span class="n">H5T_NATIVE_UINT8</span><span class="p">,</span><span class="w"> </span><span class="n">H5S_ALL</span><span class="p">,</span><span class="w"> </span><span class="n">H5S_ALL</span><span class="p">,</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">,</span><span class="w"> </span><span class="n">siteData</span><span class="p">));</span>
<span class="linenos">1435</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Dclose</span><span class="p">(</span><span class="n">datasetHandle</span><span class="p">));</span>
<span class="linenos">1436</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Pclose</span><span class="p">(</span><span class="n">dcplHandle</span><span class="p">));</span>
<span class="linenos">1437</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Sclose</span><span class="p">(</span><span class="n">dataspaceHandle</span><span class="p">));</span>
<span class="linenos">1438</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">1439</span>
<span class="linenos">1440</span><span class="w">    </span><span class="c1">// Cleanup some resources.</span>
<span class="linenos">1441</span><span class="w">    </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Dclose</span><span class="p">(</span><span class="n">latticeTimesDatasetHandle</span><span class="p">));</span>
<span class="linenos">1442</span><span class="w">    </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Gclose</span><span class="p">(</span><span class="n">siteGroupHandle</span><span class="p">));</span>
<span class="linenos">1443</span>
<span class="linenos">1444</span><span class="p">}</span>
<span class="linenos">1445</span>
<span class="linenos">1446</span><span class="kt">void</span><span class="w"> </span><span class="n">SimulationFile</span><span class="o">::</span><span class="n">appendParameterValues</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">replicate</span><span class="p">,</span><span class="w"> </span><span class="n">lm</span><span class="o">::</span><span class="n">io</span><span class="o">::</span><span class="n">ParameterValues</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">parameterValues</span><span class="p">)</span>
<span class="linenos">1447</span><span class="p">{</span>
<span class="linenos">1448</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">parameterValues</span><span class="o">-&gt;</span><span class="n">value_size</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">parameterValues</span><span class="o">-&gt;</span><span class="n">time_size</span><span class="p">())</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="n">InvalidArgException</span><span class="p">(</span><span class="s">&quot;parameterValues&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;inconsistent number of entries&quot;</span><span class="p">);</span>
<span class="linenos">1449</span>
<span class="linenos">1450</span><span class="w">    </span><span class="n">ReplicateHandles</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">replicateHandles</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">openReplicateHandles</span><span class="p">(</span><span class="n">replicate</span><span class="p">);</span>
<span class="linenos">1451</span>
<span class="linenos">1452</span><span class="w">    </span><span class="c1">// Open or create the parameter values group.</span>
<span class="linenos">1453</span><span class="w">    </span><span class="n">hid_t</span><span class="w"> </span><span class="n">pvGroupHandle</span><span class="p">;</span>
<span class="linenos">1454</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">pvGroupHandle</span><span class="o">=</span><span class="n">H5Gopen2</span><span class="p">(</span><span class="n">replicateHandles</span><span class="o">-&gt;</span><span class="n">group</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;ParameterValues&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">))</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">1455</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">1456</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CALL</span><span class="p">(</span><span class="n">pvGroupHandle</span><span class="p">,</span><span class="n">H5Gcreate2</span><span class="p">(</span><span class="n">replicateHandles</span><span class="o">-&gt;</span><span class="n">group</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;ParameterValues&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">,</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">,</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">));</span>
<span class="linenos">1457</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">1458</span>
<span class="linenos">1459</span><span class="w">    </span><span class="c1">// Open or create the parameter values dataset.</span>
<span class="linenos">1460</span><span class="w">    </span><span class="n">hid_t</span><span class="w"> </span><span class="n">pvDatasetHandle</span><span class="p">;</span>
<span class="linenos">1461</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">pvDatasetHandle</span><span class="o">=</span><span class="n">H5Dopen2</span><span class="p">(</span><span class="n">pvGroupHandle</span><span class="p">,</span><span class="w"> </span><span class="n">parameterValues</span><span class="o">-&gt;</span><span class="n">parameter</span><span class="p">().</span><span class="n">c_str</span><span class="p">(),</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">))</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">1462</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">1463</span><span class="w">        </span><span class="c1">// Create the datasets.</span>
<span class="linenos">1464</span><span class="w">        </span><span class="n">uint</span><span class="w"> </span><span class="n">RANK</span><span class="o">=</span><span class="mi">2</span><span class="p">;</span>
<span class="linenos">1465</span><span class="w">        </span><span class="n">hsize_t</span><span class="w"> </span><span class="n">dims</span><span class="p">[</span><span class="n">RANK</span><span class="p">],</span><span class="w"> </span><span class="n">maxDims</span><span class="p">[</span><span class="n">RANK</span><span class="p">],</span><span class="w"> </span><span class="n">chunkDims</span><span class="p">[</span><span class="n">RANK</span><span class="p">];</span>
<span class="linenos">1466</span><span class="w">        </span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">1467</span><span class="w">        </span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<span class="linenos">1468</span><span class="w">        </span><span class="n">maxDims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">H5S_UNLIMITED</span><span class="p">;</span>
<span class="linenos">1469</span><span class="w">        </span><span class="n">maxDims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<span class="linenos">1470</span><span class="w">        </span><span class="n">chunkDims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">100</span><span class="p">;</span>
<span class="linenos">1471</span><span class="w">        </span><span class="n">chunkDims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<span class="linenos">1472</span><span class="w">        </span><span class="n">hid_t</span><span class="w"> </span><span class="n">dataspace_id</span><span class="p">,</span><span class="w"> </span><span class="n">dcpl_id</span><span class="p">;</span>
<span class="linenos">1473</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CALL</span><span class="p">(</span><span class="n">dataspace_id</span><span class="p">,</span><span class="n">H5Screate_simple</span><span class="p">(</span><span class="n">RANK</span><span class="p">,</span><span class="w"> </span><span class="n">dims</span><span class="p">,</span><span class="w"> </span><span class="n">maxDims</span><span class="p">));</span>
<span class="linenos">1474</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CALL</span><span class="p">(</span><span class="n">dcpl_id</span><span class="p">,</span><span class="n">H5Pcreate</span><span class="p">(</span><span class="n">H5P_DATASET_CREATE</span><span class="p">));</span>
<span class="linenos">1475</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Pset_chunk</span><span class="p">(</span><span class="n">dcpl_id</span><span class="p">,</span><span class="w"> </span><span class="n">RANK</span><span class="p">,</span><span class="w"> </span><span class="n">chunkDims</span><span class="p">));</span>
<span class="linenos">1476</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CALL</span><span class="p">(</span><span class="n">pvDatasetHandle</span><span class="p">,</span><span class="n">H5Dcreate2</span><span class="p">(</span><span class="n">pvGroupHandle</span><span class="p">,</span><span class="w"> </span><span class="n">parameterValues</span><span class="o">-&gt;</span><span class="n">parameter</span><span class="p">().</span><span class="n">c_str</span><span class="p">(),</span><span class="w"> </span><span class="n">H5T_IEEE_F64LE</span><span class="p">,</span><span class="w"> </span><span class="n">dataspace_id</span><span class="p">,</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">,</span><span class="w"> </span><span class="n">dcpl_id</span><span class="p">,</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">));</span>
<span class="linenos">1477</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Pclose</span><span class="p">(</span><span class="n">dcpl_id</span><span class="p">));</span>
<span class="linenos">1478</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Sclose</span><span class="p">(</span><span class="n">dataspace_id</span><span class="p">));</span>
<span class="linenos">1479</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">1480</span>
<span class="linenos">1481</span><span class="w">    </span><span class="c1">// Get the current size of the dataset.</span>
<span class="linenos">1482</span><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">RANK</span><span class="o">=</span><span class="mi">2</span><span class="p">;</span>
<span class="linenos">1483</span><span class="w">    </span><span class="n">hsize_t</span><span class="w"> </span><span class="n">dims</span><span class="p">[</span><span class="n">RANK</span><span class="p">];</span>
<span class="linenos">1484</span><span class="w">    </span><span class="n">hid_t</span><span class="w"> </span><span class="n">dataspace_id</span><span class="p">;</span>
<span class="linenos">1485</span><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>
<span class="linenos">1486</span><span class="w">    </span><span class="n">HDF5_EXCEPTION_CALL</span><span class="p">(</span><span class="n">dataspace_id</span><span class="p">,</span><span class="n">H5Dget_space</span><span class="p">(</span><span class="n">pvDatasetHandle</span><span class="p">));</span>
<span class="linenos">1487</span><span class="w">    </span><span class="n">HDF5_EXCEPTION_CALL</span><span class="p">(</span><span class="n">result</span><span class="p">,</span><span class="n">H5Sget_simple_extent_dims</span><span class="p">(</span><span class="n">dataspace_id</span><span class="p">,</span><span class="w"> </span><span class="n">dims</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">));</span>
<span class="linenos">1488</span><span class="w">    </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Sclose</span><span class="p">(</span><span class="n">dataspace_id</span><span class="p">));</span>
<span class="linenos">1489</span>
<span class="linenos">1490</span><span class="w">    </span><span class="c1">// Extend the dataset by the number of rows in the data set.</span>
<span class="linenos">1491</span><span class="w">    </span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">parameterValues</span><span class="o">-&gt;</span><span class="n">value_size</span><span class="p">();</span>
<span class="linenos">1492</span><span class="w">    </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Dset_extent</span><span class="p">(</span><span class="n">pvDatasetHandle</span><span class="p">,</span><span class="w"> </span><span class="n">dims</span><span class="p">));</span>
<span class="linenos">1493</span>
<span class="linenos">1494</span><span class="w">    </span><span class="c1">// Create the memory dataset.</span>
<span class="linenos">1495</span><span class="w">    </span><span class="n">hid_t</span><span class="w"> </span><span class="n">memspace_id</span><span class="p">;</span>
<span class="linenos">1496</span><span class="w">    </span><span class="n">hsize_t</span><span class="w"> </span><span class="n">memDims</span><span class="p">[</span><span class="n">RANK</span><span class="p">];</span>
<span class="linenos">1497</span><span class="w">    </span><span class="n">memDims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parameterValues</span><span class="o">-&gt;</span><span class="n">value_size</span><span class="p">();</span>
<span class="linenos">1498</span><span class="w">    </span><span class="n">memDims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="linenos">1499</span><span class="w">    </span><span class="n">HDF5_EXCEPTION_CALL</span><span class="p">(</span><span class="n">memspace_id</span><span class="p">,</span><span class="n">H5Screate_simple</span><span class="p">(</span><span class="n">RANK</span><span class="p">,</span><span class="w"> </span><span class="n">memDims</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">));</span>
<span class="linenos">1500</span>
<span class="linenos">1501</span><span class="w">    </span><span class="c1">// Write the new times.</span>
<span class="linenos">1502</span><span class="w">    </span><span class="n">HDF5_EXCEPTION_CALL</span><span class="p">(</span><span class="n">dataspace_id</span><span class="p">,</span><span class="n">H5Dget_space</span><span class="p">(</span><span class="n">pvDatasetHandle</span><span class="p">));</span>
<span class="linenos">1503</span><span class="w">    </span><span class="n">hsize_t</span><span class="w"> </span><span class="n">start</span><span class="p">[</span><span class="n">RANK</span><span class="p">],</span><span class="w"> </span><span class="n">count</span><span class="p">[</span><span class="n">RANK</span><span class="p">];</span>
<span class="linenos">1504</span><span class="w">    </span><span class="n">start</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">parameterValues</span><span class="o">-&gt;</span><span class="n">value_size</span><span class="p">();</span>
<span class="linenos">1505</span><span class="w">    </span><span class="n">count</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parameterValues</span><span class="o">-&gt;</span><span class="n">value_size</span><span class="p">();</span>
<span class="linenos">1506</span><span class="w">    </span><span class="n">start</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">1507</span><span class="w">    </span><span class="n">count</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="linenos">1508</span><span class="w">    </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Sselect_hyperslab</span><span class="p">(</span><span class="n">dataspace_id</span><span class="p">,</span><span class="w"> </span><span class="n">H5S_SELECT_SET</span><span class="p">,</span><span class="w"> </span><span class="n">start</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">count</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">));</span>
<span class="linenos">1509</span><span class="w">    </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Dwrite</span><span class="p">(</span><span class="n">pvDatasetHandle</span><span class="p">,</span><span class="w"> </span><span class="n">H5T_NATIVE_DOUBLE</span><span class="p">,</span><span class="w"> </span><span class="n">memspace_id</span><span class="p">,</span><span class="w"> </span><span class="n">dataspace_id</span><span class="p">,</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">,</span><span class="w"> </span><span class="n">parameterValues</span><span class="o">-&gt;</span><span class="n">time</span><span class="p">().</span><span class="n">data</span><span class="p">()));</span>
<span class="linenos">1510</span><span class="w">    </span><span class="n">start</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="linenos">1511</span><span class="w">    </span><span class="n">count</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="linenos">1512</span><span class="w">    </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Sselect_hyperslab</span><span class="p">(</span><span class="n">dataspace_id</span><span class="p">,</span><span class="w"> </span><span class="n">H5S_SELECT_SET</span><span class="p">,</span><span class="w"> </span><span class="n">start</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">count</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">));</span>
<span class="linenos">1513</span><span class="w">    </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Dwrite</span><span class="p">(</span><span class="n">pvDatasetHandle</span><span class="p">,</span><span class="w"> </span><span class="n">H5T_NATIVE_DOUBLE</span><span class="p">,</span><span class="w"> </span><span class="n">memspace_id</span><span class="p">,</span><span class="w"> </span><span class="n">dataspace_id</span><span class="p">,</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">,</span><span class="w"> </span><span class="n">parameterValues</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">().</span><span class="n">data</span><span class="p">()));</span>
<span class="linenos">1514</span>
<span class="linenos">1515</span><span class="w">    </span><span class="c1">// Cleanup some resources.</span>
<span class="linenos">1516</span><span class="w">    </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Sclose</span><span class="p">(</span><span class="n">dataspace_id</span><span class="p">));</span>
<span class="linenos">1517</span><span class="w">    </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Sclose</span><span class="p">(</span><span class="n">memspace_id</span><span class="p">));</span>
<span class="linenos">1518</span><span class="w">    </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Dclose</span><span class="p">(</span><span class="n">pvDatasetHandle</span><span class="p">));</span>
<span class="linenos">1519</span><span class="w">    </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Gclose</span><span class="p">(</span><span class="n">pvGroupHandle</span><span class="p">));</span>
<span class="linenos">1520</span><span class="p">}</span>
<span class="linenos">1521</span>
<span class="linenos">1522</span>
<span class="linenos">1523</span><span class="kt">void</span><span class="w"> </span><span class="n">SimulationFile</span><span class="o">::</span><span class="n">setFirstPassageTimes</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">replicate</span><span class="p">,</span><span class="w"> </span><span class="n">lm</span><span class="o">::</span><span class="n">io</span><span class="o">::</span><span class="n">FirstPassageTimes</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">firstPassageTimes</span><span class="p">)</span>
<span class="linenos">1524</span><span class="p">{</span>
<span class="linenos">1525</span><span class="w">    </span><span class="c1">// Make sure the data is consistent.</span>
<span class="linenos">1526</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">firstPassageTimes</span><span class="o">-&gt;</span><span class="n">species_count_size</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="n">InvalidArgException</span><span class="p">(</span><span class="s">&quot;firstPassageTimes&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;no entries to save&quot;</span><span class="p">);</span>
<span class="linenos">1527</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">firstPassageTimes</span><span class="o">-&gt;</span><span class="n">species_count_size</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">firstPassageTimes</span><span class="o">-&gt;</span><span class="n">first_passage_time_size</span><span class="p">())</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="n">InvalidArgException</span><span class="p">(</span><span class="s">&quot;firstPassageTimes&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;inconsistent number of first passage time entries&quot;</span><span class="p">);</span>
<span class="linenos">1528</span>
<span class="linenos">1529</span><span class="w">    </span><span class="n">ReplicateHandles</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">replicateHandles</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">openReplicateHandles</span><span class="p">(</span><span class="n">replicate</span><span class="p">);</span>
<span class="linenos">1530</span>
<span class="linenos">1531</span><span class="w">    </span><span class="c1">// Open the first passage time group.</span>
<span class="linenos">1532</span><span class="w">    </span><span class="n">hid_t</span><span class="w"> </span><span class="n">fptGroupHandle</span><span class="p">;</span>
<span class="linenos">1533</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">fptGroupHandle</span><span class="o">=</span><span class="n">H5Gopen2</span><span class="p">(</span><span class="n">replicateHandles</span><span class="o">-&gt;</span><span class="n">group</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;FirstPassageTimes&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">))</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">1534</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">1535</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CALL</span><span class="p">(</span><span class="n">fptGroupHandle</span><span class="p">,</span><span class="n">H5Gcreate2</span><span class="p">(</span><span class="n">replicateHandles</span><span class="o">-&gt;</span><span class="n">group</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;FirstPassageTimes&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">,</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">,</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">));</span>
<span class="linenos">1536</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">1537</span>
<span class="linenos">1538</span><span class="w">    </span><span class="c1">// Construct a string representation of the species name.</span>
<span class="linenos">1539</span><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">stringstream</span><span class="w"> </span><span class="n">ss</span><span class="p">;</span>
<span class="linenos">1540</span><span class="w">    </span><span class="n">ss</span><span class="p">.</span><span class="n">fill</span><span class="p">(</span><span class="sc">&#39;0&#39;</span><span class="p">);</span>
<span class="linenos">1541</span><span class="w">    </span><span class="n">ss</span><span class="p">.</span><span class="n">width</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
<span class="linenos">1542</span><span class="w">    </span><span class="n">ss</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">firstPassageTimes</span><span class="o">-&gt;</span><span class="n">species</span><span class="p">();</span>
<span class="linenos">1543</span><span class="w">    </span><span class="n">string</span><span class="w"> </span><span class="n">speciesString</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ss</span><span class="p">.</span><span class="n">str</span><span class="p">();</span>
<span class="linenos">1544</span>
<span class="linenos">1545</span><span class="w">    </span><span class="c1">// Open the species group.</span>
<span class="linenos">1546</span><span class="w">    </span><span class="n">hid_t</span><span class="w"> </span><span class="n">speciesGroupHandle</span><span class="p">,</span><span class="w"> </span><span class="n">countsDatasetHandle</span><span class="p">,</span><span class="w"> </span><span class="n">timesDatasetHandle</span><span class="p">;</span>
<span class="linenos">1547</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">speciesGroupHandle</span><span class="o">=</span><span class="n">H5Gopen2</span><span class="p">(</span><span class="n">fptGroupHandle</span><span class="p">,</span><span class="w"> </span><span class="n">speciesString</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">))</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">1548</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">1549</span><span class="w">        </span><span class="c1">// Open the data sets.</span>
<span class="linenos">1550</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CALL</span><span class="p">(</span><span class="n">countsDatasetHandle</span><span class="p">,</span><span class="n">H5Dopen2</span><span class="p">(</span><span class="n">speciesGroupHandle</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Counts&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">));</span>
<span class="linenos">1551</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CALL</span><span class="p">(</span><span class="n">timesDatasetHandle</span><span class="p">,</span><span class="n">H5Dopen2</span><span class="p">(</span><span class="n">speciesGroupHandle</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Times&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">));</span>
<span class="linenos">1552</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">1553</span><span class="w">    </span><span class="k">else</span>
<span class="linenos">1554</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">1555</span><span class="w">        </span><span class="c1">// Create the group.</span>
<span class="linenos">1556</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CALL</span><span class="p">(</span><span class="n">speciesGroupHandle</span><span class="p">,</span><span class="n">H5Gcreate2</span><span class="p">(</span><span class="n">fptGroupHandle</span><span class="p">,</span><span class="w"> </span><span class="n">speciesString</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">,</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">,</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">));</span>
<span class="linenos">1557</span>
<span class="linenos">1558</span><span class="w">        </span><span class="c1">// Create the datasets.</span>
<span class="linenos">1559</span><span class="w">        </span><span class="n">uint</span><span class="w"> </span><span class="n">RANK</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
<span class="linenos">1560</span><span class="w">        </span><span class="n">hsize_t</span><span class="w"> </span><span class="n">dims</span><span class="p">[</span><span class="n">RANK</span><span class="p">],</span><span class="w"> </span><span class="n">maxDims</span><span class="p">[</span><span class="n">RANK</span><span class="p">],</span><span class="w"> </span><span class="n">chunkDims</span><span class="p">[</span><span class="n">RANK</span><span class="p">];</span>
<span class="linenos">1561</span><span class="w">        </span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">1562</span><span class="w">        </span><span class="n">maxDims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">H5S_UNLIMITED</span><span class="p">;</span>
<span class="linenos">1563</span><span class="w">        </span><span class="n">chunkDims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">100</span><span class="p">;</span>
<span class="linenos">1564</span><span class="w">        </span><span class="n">hid_t</span><span class="w"> </span><span class="n">dataspace_id</span><span class="p">,</span><span class="w"> </span><span class="n">dcpl_id</span><span class="p">;</span>
<span class="linenos">1565</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CALL</span><span class="p">(</span><span class="n">dataspace_id</span><span class="p">,</span><span class="n">H5Screate_simple</span><span class="p">(</span><span class="n">RANK</span><span class="p">,</span><span class="w"> </span><span class="n">dims</span><span class="p">,</span><span class="w"> </span><span class="n">maxDims</span><span class="p">));</span>
<span class="linenos">1566</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CALL</span><span class="p">(</span><span class="n">dcpl_id</span><span class="p">,</span><span class="n">H5Pcreate</span><span class="p">(</span><span class="n">H5P_DATASET_CREATE</span><span class="p">));</span>
<span class="linenos">1567</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Pset_chunk</span><span class="p">(</span><span class="n">dcpl_id</span><span class="p">,</span><span class="w"> </span><span class="n">RANK</span><span class="p">,</span><span class="w"> </span><span class="n">chunkDims</span><span class="p">));</span>
<span class="linenos">1568</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CALL</span><span class="p">(</span><span class="n">countsDatasetHandle</span><span class="p">,</span><span class="n">H5Dcreate2</span><span class="p">(</span><span class="n">speciesGroupHandle</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Counts&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">H5T_STD_U32LE</span><span class="p">,</span><span class="w"> </span><span class="n">dataspace_id</span><span class="p">,</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">,</span><span class="w"> </span><span class="n">dcpl_id</span><span class="p">,</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">));</span>
<span class="linenos">1569</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CALL</span><span class="p">(</span><span class="n">timesDatasetHandle</span><span class="p">,</span><span class="n">H5Dcreate2</span><span class="p">(</span><span class="n">speciesGroupHandle</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Times&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">H5T_IEEE_F64LE</span><span class="p">,</span><span class="w"> </span><span class="n">dataspace_id</span><span class="p">,</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">,</span><span class="w"> </span><span class="n">dcpl_id</span><span class="p">,</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">));</span>
<span class="linenos">1570</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Pclose</span><span class="p">(</span><span class="n">dcpl_id</span><span class="p">));</span>
<span class="linenos">1571</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Sclose</span><span class="p">(</span><span class="n">dataspace_id</span><span class="p">));</span>
<span class="linenos">1572</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">1573</span>
<span class="linenos">1574</span><span class="w">    </span><span class="c1">// Read the lowest and highest first passage times in the file.</span>
<span class="linenos">1575</span><span class="w">    </span><span class="n">uint</span><span class="w"> </span><span class="n">RANK</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
<span class="linenos">1576</span><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>
<span class="linenos">1577</span><span class="w">    </span><span class="n">hid_t</span><span class="w"> </span><span class="n">countsDataspace</span><span class="p">;</span>
<span class="linenos">1578</span><span class="w">    </span><span class="n">hsize_t</span><span class="w"> </span><span class="n">countsDims</span><span class="p">[</span><span class="n">RANK</span><span class="p">];</span>
<span class="linenos">1579</span><span class="w">    </span><span class="n">HDF5_EXCEPTION_CALL</span><span class="p">(</span><span class="n">countsDataspace</span><span class="p">,</span><span class="n">H5Dget_space</span><span class="p">(</span><span class="n">countsDatasetHandle</span><span class="p">));</span>
<span class="linenos">1580</span><span class="w">    </span><span class="n">HDF5_EXCEPTION_CALL</span><span class="p">(</span><span class="n">result</span><span class="p">,</span><span class="n">H5Sget_simple_extent_dims</span><span class="p">(</span><span class="n">countsDataspace</span><span class="p">,</span><span class="w"> </span><span class="n">countsDims</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">));</span>
<span class="linenos">1581</span><span class="w">    </span><span class="n">uint</span><span class="w"> </span><span class="n">minCount</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">maxCount</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">1582</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">countsDims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="linenos">1583</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">1584</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Dread</span><span class="p">(</span><span class="n">countsDatasetHandle</span><span class="p">,</span><span class="w"> </span><span class="n">H5T_NATIVE_INT32</span><span class="p">,</span><span class="w"> </span><span class="n">H5S_ALL</span><span class="p">,</span><span class="w"> </span><span class="n">H5S_ALL</span><span class="p">,</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">minCount</span><span class="p">));</span>
<span class="linenos">1585</span><span class="w">        </span><span class="n">maxCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">minCount</span><span class="p">;</span>
<span class="linenos">1586</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">1587</span><span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">countsDims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="linenos">1588</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">1589</span><span class="w">        </span><span class="c1">// Create the memory dataspace.</span>
<span class="linenos">1590</span><span class="w">        </span><span class="n">hid_t</span><span class="w"> </span><span class="n">memDataspaceHandle</span><span class="p">;</span>
<span class="linenos">1591</span><span class="w">        </span><span class="n">hsize_t</span><span class="w"> </span><span class="n">memDims</span><span class="p">[</span><span class="n">RANK</span><span class="p">];</span>
<span class="linenos">1592</span><span class="w">        </span><span class="n">memDims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="linenos">1593</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CALL</span><span class="p">(</span><span class="n">memDataspaceHandle</span><span class="p">,</span><span class="n">H5Screate_simple</span><span class="p">(</span><span class="n">RANK</span><span class="p">,</span><span class="w"> </span><span class="n">memDims</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">));</span>
<span class="linenos">1594</span>
<span class="linenos">1595</span><span class="w">        </span><span class="n">hsize_t</span><span class="w"> </span><span class="n">start</span><span class="p">[</span><span class="n">RANK</span><span class="p">],</span><span class="w"> </span><span class="n">count</span><span class="p">[</span><span class="n">RANK</span><span class="p">];</span>
<span class="linenos">1596</span><span class="w">        </span><span class="n">count</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="linenos">1597</span><span class="w">        </span><span class="n">start</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">1598</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Sselect_hyperslab</span><span class="p">(</span><span class="n">countsDataspace</span><span class="p">,</span><span class="w"> </span><span class="n">H5S_SELECT_SET</span><span class="p">,</span><span class="w"> </span><span class="n">start</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">count</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">));</span>
<span class="linenos">1599</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Dread</span><span class="p">(</span><span class="n">countsDatasetHandle</span><span class="p">,</span><span class="w"> </span><span class="n">H5T_NATIVE_UINT32</span><span class="p">,</span><span class="w"> </span><span class="n">memDataspaceHandle</span><span class="p">,</span><span class="w"> </span><span class="n">countsDataspace</span><span class="p">,</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">minCount</span><span class="p">));</span>
<span class="linenos">1600</span><span class="w">        </span><span class="n">start</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">countsDims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="mi">-1</span><span class="p">;</span>
<span class="linenos">1601</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Sselect_hyperslab</span><span class="p">(</span><span class="n">countsDataspace</span><span class="p">,</span><span class="w"> </span><span class="n">H5S_SELECT_SET</span><span class="p">,</span><span class="w"> </span><span class="n">start</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">count</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">));</span>
<span class="linenos">1602</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Dread</span><span class="p">(</span><span class="n">countsDatasetHandle</span><span class="p">,</span><span class="w"> </span><span class="n">H5T_NATIVE_UINT32</span><span class="p">,</span><span class="w"> </span><span class="n">memDataspaceHandle</span><span class="p">,</span><span class="w"> </span><span class="n">countsDataspace</span><span class="p">,</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">maxCount</span><span class="p">));</span>
<span class="linenos">1603</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Sclose</span><span class="p">(</span><span class="n">memDataspaceHandle</span><span class="p">));</span>
<span class="linenos">1604</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">1605</span><span class="w">    </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Sclose</span><span class="p">(</span><span class="n">countsDataspace</span><span class="p">));</span>
<span class="linenos">1606</span>
<span class="linenos">1607</span><span class="w">    </span><span class="c1">// Figure out the min and the max from the new counts.</span>
<span class="linenos">1608</span><span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">minNewCount</span><span class="o">=</span><span class="n">firstPassageTimes</span><span class="o">-&gt;</span><span class="n">species_count</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="n">maxNewCount</span><span class="o">=</span><span class="n">firstPassageTimes</span><span class="o">-&gt;</span><span class="n">species_count</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="linenos">1609</span><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">firstPassageTimes</span><span class="o">-&gt;</span><span class="n">species_count_size</span><span class="p">();</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">1610</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">1611</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">firstPassageTimes</span><span class="o">-&gt;</span><span class="n">species_count</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">minNewCount</span><span class="p">)</span>
<span class="linenos">1612</span><span class="w">            </span><span class="n">minNewCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">firstPassageTimes</span><span class="o">-&gt;</span><span class="n">species_count</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
<span class="linenos">1613</span><span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">firstPassageTimes</span><span class="o">-&gt;</span><span class="n">species_count</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">maxNewCount</span><span class="p">)</span>
<span class="linenos">1614</span><span class="w">            </span><span class="n">maxNewCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">firstPassageTimes</span><span class="o">-&gt;</span><span class="n">species_count</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
<span class="linenos">1615</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">1616</span>
<span class="linenos">1617</span><span class="w">    </span><span class="c1">// If there are no existing records, just insert one large block.</span>
<span class="linenos">1618</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">countsDims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">1619</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">1620</span><span class="w">        </span><span class="c1">// Allocate the block.</span>
<span class="linenos">1621</span><span class="w">        </span><span class="n">countsDims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">maxNewCount</span><span class="o">-</span><span class="n">minNewCount</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
<span class="linenos">1622</span><span class="w">        </span><span class="kt">uint32_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">counts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">uint32_t</span><span class="p">[</span><span class="n">countsDims</span><span class="p">[</span><span class="mi">0</span><span class="p">]];</span>
<span class="linenos">1623</span><span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">times</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">double</span><span class="p">[</span><span class="n">countsDims</span><span class="p">[</span><span class="mi">0</span><span class="p">]];</span>
<span class="linenos">1624</span><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">countsDims</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">1625</span><span class="w">        </span><span class="p">{</span>
<span class="linenos">1626</span><span class="w">            </span><span class="n">counts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">1627</span><span class="w">            </span><span class="n">times</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-1.0</span><span class="p">;</span>
<span class="linenos">1628</span><span class="w">        </span><span class="p">}</span>
<span class="linenos">1629</span>
<span class="linenos">1630</span><span class="w">        </span><span class="c1">// Fill in the block.</span>
<span class="linenos">1631</span><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">firstPassageTimes</span><span class="o">-&gt;</span><span class="n">species_count_size</span><span class="p">();</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">1632</span><span class="w">        </span><span class="p">{</span>
<span class="linenos">1633</span><span class="w">            </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">firstPassageTimes</span><span class="o">-&gt;</span><span class="n">species_count</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
<span class="linenos">1634</span><span class="w">            </span><span class="n">counts</span><span class="p">[</span><span class="n">count</span><span class="o">-</span><span class="n">minNewCount</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">count</span><span class="p">;</span>
<span class="linenos">1635</span><span class="w">            </span><span class="n">times</span><span class="p">[</span><span class="n">count</span><span class="o">-</span><span class="n">minNewCount</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">firstPassageTimes</span><span class="o">-&gt;</span><span class="n">first_passage_time</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
<span class="linenos">1636</span><span class="w">        </span><span class="p">}</span>
<span class="linenos">1637</span>
<span class="linenos">1638</span><span class="w">        </span><span class="c1">// Extend the datasets and write the block.</span>
<span class="linenos">1639</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Dset_extent</span><span class="p">(</span><span class="n">countsDatasetHandle</span><span class="p">,</span><span class="w"> </span><span class="n">countsDims</span><span class="p">));</span>
<span class="linenos">1640</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Dwrite</span><span class="p">(</span><span class="n">countsDatasetHandle</span><span class="p">,</span><span class="w"> </span><span class="n">H5T_NATIVE_UINT32</span><span class="p">,</span><span class="w"> </span><span class="n">H5S_ALL</span><span class="p">,</span><span class="w"> </span><span class="n">H5S_ALL</span><span class="p">,</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">,</span><span class="w"> </span><span class="n">counts</span><span class="p">));</span>
<span class="linenos">1641</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Dset_extent</span><span class="p">(</span><span class="n">timesDatasetHandle</span><span class="p">,</span><span class="w"> </span><span class="n">countsDims</span><span class="p">));</span>
<span class="linenos">1642</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Dwrite</span><span class="p">(</span><span class="n">timesDatasetHandle</span><span class="p">,</span><span class="w"> </span><span class="n">H5T_NATIVE_DOUBLE</span><span class="p">,</span><span class="w"> </span><span class="n">H5S_ALL</span><span class="p">,</span><span class="w"> </span><span class="n">H5S_ALL</span><span class="p">,</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">,</span><span class="w"> </span><span class="n">times</span><span class="p">));</span>
<span class="linenos">1643</span>
<span class="linenos">1644</span><span class="w">        </span><span class="c1">// Free the buffers.</span>
<span class="linenos">1645</span><span class="w">        </span><span class="k">delete</span><span class="w"> </span><span class="p">[]</span><span class="w"> </span><span class="n">counts</span><span class="p">;</span>
<span class="linenos">1646</span><span class="w">        </span><span class="k">delete</span><span class="w"> </span><span class="p">[]</span><span class="w"> </span><span class="n">times</span><span class="p">;</span>
<span class="linenos">1647</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">1648</span>
<span class="linenos">1649</span><span class="w">    </span><span class="c1">// Otherwise if there are only new records to append to the end, just add them</span>
<span class="linenos">1650</span><span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">maxNewCount</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">maxCount</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">minNewCount</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">maxCount</span><span class="p">)</span>
<span class="linenos">1651</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">1652</span><span class="w">        </span><span class="c1">// Allocate the new buffer.</span>
<span class="linenos">1653</span><span class="w">        </span><span class="n">hsize_t</span><span class="w"> </span><span class="n">endingStart</span><span class="p">[</span><span class="n">RANK</span><span class="p">],</span><span class="w"> </span><span class="n">endingCount</span><span class="p">[</span><span class="n">RANK</span><span class="p">];</span>
<span class="linenos">1654</span><span class="w">        </span><span class="n">endingCount</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">maxNewCount</span><span class="o">-</span><span class="n">maxCount</span><span class="p">;</span>
<span class="linenos">1655</span><span class="w">        </span><span class="kt">uint32_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">newEndingCounts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">uint32_t</span><span class="p">[</span><span class="n">endingCount</span><span class="p">[</span><span class="mi">0</span><span class="p">]];</span>
<span class="linenos">1656</span><span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">newEndingTimes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">double</span><span class="p">[</span><span class="n">endingCount</span><span class="p">[</span><span class="mi">0</span><span class="p">]];</span>
<span class="linenos">1657</span><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">endingCount</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">1658</span><span class="w">        </span><span class="p">{</span>
<span class="linenos">1659</span><span class="w">            </span><span class="n">newEndingCounts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">1660</span><span class="w">            </span><span class="n">newEndingTimes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-1.0</span><span class="p">;</span>
<span class="linenos">1661</span><span class="w">        </span><span class="p">}</span>
<span class="linenos">1662</span>
<span class="linenos">1663</span><span class="w">        </span><span class="c1">// Fill in the buffer.</span>
<span class="linenos">1664</span><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">firstPassageTimes</span><span class="o">-&gt;</span><span class="n">species_count_size</span><span class="p">();</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">1665</span><span class="w">        </span><span class="p">{</span>
<span class="linenos">1666</span><span class="w">            </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">firstPassageTimes</span><span class="o">-&gt;</span><span class="n">species_count</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
<span class="linenos">1667</span><span class="w">            </span><span class="n">newEndingCounts</span><span class="p">[</span><span class="n">count</span><span class="o">-</span><span class="n">maxCount</span><span class="mi">-1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">count</span><span class="p">;</span>
<span class="linenos">1668</span><span class="w">            </span><span class="n">newEndingTimes</span><span class="p">[</span><span class="n">count</span><span class="o">-</span><span class="n">maxCount</span><span class="mi">-1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">firstPassageTimes</span><span class="o">-&gt;</span><span class="n">first_passage_time</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
<span class="linenos">1669</span><span class="w">        </span><span class="p">}</span>
<span class="linenos">1670</span>
<span class="linenos">1671</span><span class="w">        </span><span class="c1">// Create the memory dataspace.</span>
<span class="linenos">1672</span><span class="w">        </span><span class="n">hid_t</span><span class="w"> </span><span class="n">memDataspaceHandle</span><span class="p">;</span>
<span class="linenos">1673</span><span class="w">        </span><span class="n">hsize_t</span><span class="w"> </span><span class="n">memDims</span><span class="p">[</span><span class="n">RANK</span><span class="p">];</span>
<span class="linenos">1674</span><span class="w">        </span><span class="n">memDims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">endingCount</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="linenos">1675</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CALL</span><span class="p">(</span><span class="n">memDataspaceHandle</span><span class="p">,</span><span class="n">H5Screate_simple</span><span class="p">(</span><span class="n">RANK</span><span class="p">,</span><span class="w"> </span><span class="n">memDims</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">));</span>
<span class="linenos">1676</span>
<span class="linenos">1677</span><span class="w">        </span><span class="c1">// Append the records.</span>
<span class="linenos">1678</span><span class="w">        </span><span class="n">hid_t</span><span class="w"> </span><span class="n">countsDataspaceHandle</span><span class="p">,</span><span class="w"> </span><span class="n">timesDataspaceHandle</span><span class="p">;</span>
<span class="linenos">1679</span><span class="w">        </span><span class="n">endingStart</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">countsDims</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="linenos">1680</span><span class="w">        </span><span class="n">countsDims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">endingCount</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="linenos">1681</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Dset_extent</span><span class="p">(</span><span class="n">countsDatasetHandle</span><span class="p">,</span><span class="w"> </span><span class="n">countsDims</span><span class="p">));</span>
<span class="linenos">1682</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CALL</span><span class="p">(</span><span class="n">countsDataspaceHandle</span><span class="p">,</span><span class="n">H5Dget_space</span><span class="p">(</span><span class="n">countsDatasetHandle</span><span class="p">));</span>
<span class="linenos">1683</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Sselect_hyperslab</span><span class="p">(</span><span class="n">countsDataspaceHandle</span><span class="p">,</span><span class="w"> </span><span class="n">H5S_SELECT_SET</span><span class="p">,</span><span class="w"> </span><span class="n">endingStart</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">endingCount</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">));</span>
<span class="linenos">1684</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Dwrite</span><span class="p">(</span><span class="n">countsDatasetHandle</span><span class="p">,</span><span class="w"> </span><span class="n">H5T_NATIVE_UINT32</span><span class="p">,</span><span class="w"> </span><span class="n">memDataspaceHandle</span><span class="p">,</span><span class="w"> </span><span class="n">countsDataspaceHandle</span><span class="p">,</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">,</span><span class="w"> </span><span class="n">newEndingCounts</span><span class="p">));</span>
<span class="linenos">1685</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Sclose</span><span class="p">(</span><span class="n">countsDataspaceHandle</span><span class="p">));</span>
<span class="linenos">1686</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Dset_extent</span><span class="p">(</span><span class="n">timesDatasetHandle</span><span class="p">,</span><span class="w"> </span><span class="n">countsDims</span><span class="p">));</span>
<span class="linenos">1687</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CALL</span><span class="p">(</span><span class="n">timesDataspaceHandle</span><span class="p">,</span><span class="n">H5Dget_space</span><span class="p">(</span><span class="n">timesDatasetHandle</span><span class="p">));</span>
<span class="linenos">1688</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Sselect_hyperslab</span><span class="p">(</span><span class="n">timesDataspaceHandle</span><span class="p">,</span><span class="w"> </span><span class="n">H5S_SELECT_SET</span><span class="p">,</span><span class="w"> </span><span class="n">endingStart</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">endingCount</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">));</span>
<span class="linenos">1689</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Dwrite</span><span class="p">(</span><span class="n">timesDatasetHandle</span><span class="p">,</span><span class="w"> </span><span class="n">H5T_NATIVE_DOUBLE</span><span class="p">,</span><span class="w"> </span><span class="n">memDataspaceHandle</span><span class="p">,</span><span class="w"> </span><span class="n">timesDataspaceHandle</span><span class="p">,</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">,</span><span class="w"> </span><span class="n">newEndingTimes</span><span class="p">));</span>
<span class="linenos">1690</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Sclose</span><span class="p">(</span><span class="n">timesDataspaceHandle</span><span class="p">));</span>
<span class="linenos">1691</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Sclose</span><span class="p">(</span><span class="n">memDataspaceHandle</span><span class="p">));</span>
<span class="linenos">1692</span>
<span class="linenos">1693</span><span class="w">        </span><span class="c1">// Free the buffers.</span>
<span class="linenos">1694</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">newEndingCounts</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="k">delete</span><span class="w"> </span><span class="p">[]</span><span class="w"> </span><span class="n">newEndingCounts</span><span class="p">;</span>
<span class="linenos">1695</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">newEndingTimes</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="k">delete</span><span class="w"> </span><span class="p">[]</span><span class="w"> </span><span class="n">newEndingTimes</span><span class="p">;</span>
<span class="linenos">1696</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">1697</span>
<span class="linenos">1698</span><span class="w">    </span><span class="c1">// Otherwise, we need to insert some records before and/or after the existing block so we have to copy the old data and rebuild.</span>
<span class="linenos">1699</span><span class="w">    </span><span class="k">else</span>
<span class="linenos">1700</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">1701</span><span class="w">        </span><span class="c1">// Declare the new buffer.</span>
<span class="linenos">1702</span><span class="w">        </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">combinedMinCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">min</span><span class="p">(</span><span class="n">minCount</span><span class="p">,</span><span class="n">minNewCount</span><span class="p">);</span>
<span class="linenos">1703</span><span class="w">        </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">combinedMaxCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">max</span><span class="p">(</span><span class="n">maxCount</span><span class="p">,</span><span class="n">maxNewCount</span><span class="p">);</span>
<span class="linenos">1704</span><span class="w">        </span><span class="kt">size_t</span><span class="w"> </span><span class="n">newSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">combinedMaxCount</span><span class="o">-</span><span class="n">combinedMinCount</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
<span class="linenos">1705</span><span class="w">        </span><span class="kt">uint32_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">newCounts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">uint32_t</span><span class="p">[</span><span class="n">newSize</span><span class="p">];</span>
<span class="linenos">1706</span><span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">newTimes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">double</span><span class="p">[</span><span class="n">newSize</span><span class="p">];</span>
<span class="linenos">1707</span><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">newSize</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">1708</span><span class="w">        </span><span class="p">{</span>
<span class="linenos">1709</span><span class="w">            </span><span class="n">newCounts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">1710</span><span class="w">            </span><span class="n">newTimes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-1.0</span><span class="p">;</span>
<span class="linenos">1711</span><span class="w">        </span><span class="p">}</span>
<span class="linenos">1712</span>
<span class="linenos">1713</span><span class="w">        </span><span class="c1">// Copy the old data into the buffer.</span>
<span class="linenos">1714</span><span class="w">        </span><span class="n">hid_t</span><span class="w"> </span><span class="n">memDataspaceHandle</span><span class="p">;</span>
<span class="linenos">1715</span><span class="w">        </span><span class="n">hsize_t</span><span class="w"> </span><span class="n">memDims</span><span class="p">[</span><span class="n">RANK</span><span class="p">];</span>
<span class="linenos">1716</span><span class="w">        </span><span class="n">memDims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">maxCount</span><span class="o">-</span><span class="n">minCount</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
<span class="linenos">1717</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CALL</span><span class="p">(</span><span class="n">memDataspaceHandle</span><span class="p">,</span><span class="n">H5Screate_simple</span><span class="p">(</span><span class="n">RANK</span><span class="p">,</span><span class="w"> </span><span class="n">memDims</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">));</span>
<span class="linenos">1718</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Dread</span><span class="p">(</span><span class="n">countsDatasetHandle</span><span class="p">,</span><span class="w"> </span><span class="n">H5T_NATIVE_UINT32</span><span class="p">,</span><span class="w"> </span><span class="n">memDataspaceHandle</span><span class="p">,</span><span class="w"> </span><span class="n">H5S_ALL</span><span class="p">,</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">newCounts</span><span class="p">[</span><span class="n">minCount</span><span class="o">-</span><span class="n">combinedMinCount</span><span class="p">]));</span>
<span class="linenos">1719</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Dread</span><span class="p">(</span><span class="n">timesDatasetHandle</span><span class="p">,</span><span class="w"> </span><span class="n">H5T_NATIVE_DOUBLE</span><span class="p">,</span><span class="w"> </span><span class="n">memDataspaceHandle</span><span class="p">,</span><span class="w"> </span><span class="n">H5S_ALL</span><span class="p">,</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">newTimes</span><span class="p">[</span><span class="n">minCount</span><span class="o">-</span><span class="n">combinedMinCount</span><span class="p">]));</span>
<span class="linenos">1720</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Sclose</span><span class="p">(</span><span class="n">memDataspaceHandle</span><span class="p">));</span>
<span class="linenos">1721</span>
<span class="linenos">1722</span><span class="w">        </span><span class="c1">// Fill in the buffer with the new data.</span>
<span class="linenos">1723</span><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">firstPassageTimes</span><span class="o">-&gt;</span><span class="n">species_count_size</span><span class="p">();</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">1724</span><span class="w">        </span><span class="p">{</span>
<span class="linenos">1725</span><span class="w">            </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">firstPassageTimes</span><span class="o">-&gt;</span><span class="n">species_count</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
<span class="linenos">1726</span><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">count</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">minCount</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">count</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">maxCount</span><span class="p">)</span>
<span class="linenos">1727</span><span class="w">            </span><span class="p">{</span>
<span class="linenos">1728</span><span class="w">                </span><span class="n">newCounts</span><span class="p">[</span><span class="n">count</span><span class="o">-</span><span class="n">combinedMinCount</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">count</span><span class="p">;</span>
<span class="linenos">1729</span><span class="w">                </span><span class="n">newTimes</span><span class="p">[</span><span class="n">count</span><span class="o">-</span><span class="n">combinedMinCount</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">firstPassageTimes</span><span class="o">-&gt;</span><span class="n">first_passage_time</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
<span class="linenos">1730</span><span class="w">            </span><span class="p">}</span>
<span class="linenos">1731</span><span class="w">            </span><span class="k">else</span>
<span class="linenos">1732</span><span class="w">            </span><span class="p">{</span>
<span class="linenos">1733</span><span class="w">                </span><span class="k">throw</span><span class="w"> </span><span class="n">InvalidArgException</span><span class="p">(</span><span class="s">&quot;firstPassageTimes&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;contained duplicates of existing counts&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">count</span><span class="p">);</span>
<span class="linenos">1734</span><span class="w">            </span><span class="p">}</span>
<span class="linenos">1735</span><span class="w">        </span><span class="p">}</span>
<span class="linenos">1736</span>
<span class="linenos">1737</span><span class="w">        </span><span class="c1">// Update the dataset with the combined data.</span>
<span class="linenos">1738</span><span class="w">        </span><span class="n">memDims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newSize</span><span class="p">;</span>
<span class="linenos">1739</span><span class="w">        </span><span class="n">countsDims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newSize</span><span class="p">;</span>
<span class="linenos">1740</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CALL</span><span class="p">(</span><span class="n">memDataspaceHandle</span><span class="p">,</span><span class="n">H5Screate_simple</span><span class="p">(</span><span class="n">RANK</span><span class="p">,</span><span class="w"> </span><span class="n">memDims</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">));</span>
<span class="linenos">1741</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Dset_extent</span><span class="p">(</span><span class="n">countsDatasetHandle</span><span class="p">,</span><span class="w"> </span><span class="n">countsDims</span><span class="p">));</span>
<span class="linenos">1742</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Dwrite</span><span class="p">(</span><span class="n">countsDatasetHandle</span><span class="p">,</span><span class="w"> </span><span class="n">H5T_NATIVE_UINT32</span><span class="p">,</span><span class="w"> </span><span class="n">memDataspaceHandle</span><span class="p">,</span><span class="w"> </span><span class="n">H5S_ALL</span><span class="p">,</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">,</span><span class="w"> </span><span class="n">newCounts</span><span class="p">));</span>
<span class="linenos">1743</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Dset_extent</span><span class="p">(</span><span class="n">timesDatasetHandle</span><span class="p">,</span><span class="w"> </span><span class="n">countsDims</span><span class="p">));</span>
<span class="linenos">1744</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Dwrite</span><span class="p">(</span><span class="n">timesDatasetHandle</span><span class="p">,</span><span class="w"> </span><span class="n">H5T_NATIVE_DOUBLE</span><span class="p">,</span><span class="w"> </span><span class="n">memDataspaceHandle</span><span class="p">,</span><span class="w"> </span><span class="n">H5S_ALL</span><span class="p">,</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">,</span><span class="w"> </span><span class="n">newTimes</span><span class="p">));</span>
<span class="linenos">1745</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Sclose</span><span class="p">(</span><span class="n">memDataspaceHandle</span><span class="p">));</span>
<span class="linenos">1746</span>
<span class="linenos">1747</span><span class="w">        </span><span class="c1">// Free the buffers.</span>
<span class="linenos">1748</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">newCounts</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="k">delete</span><span class="w"> </span><span class="p">[]</span><span class="w"> </span><span class="n">newCounts</span><span class="p">;</span>
<span class="linenos">1749</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">newTimes</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="k">delete</span><span class="w"> </span><span class="p">[]</span><span class="w"> </span><span class="n">newTimes</span><span class="p">;</span>
<span class="linenos">1750</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">1751</span>
<span class="linenos">1752</span><span class="w">    </span><span class="c1">// Close any resources.</span>
<span class="linenos">1753</span><span class="w">    </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Dclose</span><span class="p">(</span><span class="n">countsDatasetHandle</span><span class="p">));</span>
<span class="linenos">1754</span><span class="w">    </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Dclose</span><span class="p">(</span><span class="n">timesDatasetHandle</span><span class="p">));</span>
<span class="linenos">1755</span><span class="w">    </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Gclose</span><span class="p">(</span><span class="n">speciesGroupHandle</span><span class="p">));</span>
<span class="linenos">1756</span><span class="w">    </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Gclose</span><span class="p">(</span><span class="n">fptGroupHandle</span><span class="p">));</span>
<span class="linenos">1757</span><span class="p">}</span>
<span class="linenos">1758</span>
<span class="linenos">1759</span><span class="cm">/*void SimulationFile::appendSpatialModelObjects(unsigned int replicate, lm::io::SpatialModel * model)</span>
<span class="linenos">1760</span><span class="cm">{</span>
<span class="linenos">1761</span><span class="cm">    if (model-&gt;sphere_xc_size() != model-&gt;sphere_type_size()) throw InvalidArgException(&quot;model&quot;, &quot;inconsistent number of sphere entries&quot;);</span>
<span class="linenos">1762</span><span class="cm">    if (model-&gt;sphere_yc_size() != model-&gt;sphere_type_size()) throw InvalidArgException(&quot;model&quot;, &quot;inconsistent number of sphere entries&quot;);</span>
<span class="linenos">1763</span><span class="cm">    if (model-&gt;sphere_zc_size() != model-&gt;sphere_type_size()) throw InvalidArgException(&quot;model&quot;, &quot;inconsistent number of sphere entries&quot;);</span>
<span class="linenos">1764</span><span class="cm">    if (model-&gt;sphere_radius_size() != model-&gt;sphere_type_size()) throw InvalidArgException(&quot;model&quot;, &quot;inconsistent number of sphere entries&quot;);</span>
<span class="linenos">1765</span>
<span class="linenos">1766</span><span class="cm">    ReplicateHandles * replicateHandles = openReplicateHandles(replicate);</span>
<span class="linenos">1767</span>
<span class="linenos">1768</span><span class="cm">    // Open or create the group.</span>
<span class="linenos">1769</span><span class="cm">    hid_t modelHandle, spatialHandle;</span>
<span class="linenos">1770</span><span class="cm">    if ((modelHandle=H5Gopen2(replicateHandles-&gt;group, &quot;Model&quot;, H5P_DEFAULT)) &lt; 0)</span>
<span class="linenos">1771</span><span class="cm">    {</span>
<span class="linenos">1772</span><span class="cm">        HDF5_EXCEPTION_CALL(modelHandle,H5Gcreate2(replicateHandles-&gt;group, &quot;Model&quot;, H5P_DEFAULT, H5P_DEFAULT, H5P_DEFAULT));</span>
<span class="linenos">1773</span><span class="cm">    }</span>
<span class="linenos">1774</span><span class="cm">    if ((spatialHandle=H5Gopen2(modelHandle, &quot;Spatial&quot;, H5P_DEFAULT)) &lt; 0)</span>
<span class="linenos">1775</span><span class="cm">    {</span>
<span class="linenos">1776</span><span class="cm">        HDF5_EXCEPTION_CALL(spatialHandle,H5Gcreate2(modelHandle, &quot;Spatial&quot;, H5P_DEFAULT, H5P_DEFAULT, H5P_DEFAULT));</span>
<span class="linenos">1777</span><span class="cm">    }</span>
<span class="linenos">1778</span>
<span class="linenos">1779</span><span class="cm">    // Open or create the datasets.</span>
<span class="linenos">1780</span><span class="cm">    hid_t spheresDatasetHandle;</span>
<span class="linenos">1781</span><span class="cm">    if ((spheresDatasetHandle=H5Dopen2(spatialHandle, &quot;Spheres&quot;, H5P_DEFAULT)) &lt; 0)</span>
<span class="linenos">1782</span><span class="cm">    {</span>
<span class="linenos">1783</span><span class="cm">        // Create the datasets.</span>
<span class="linenos">1784</span><span class="cm">        uint RANK=2;</span>
<span class="linenos">1785</span><span class="cm">        hsize_t dims[RANK], maxDims[RANK], chunkDims[RANK];</span>
<span class="linenos">1786</span><span class="cm">        dims[0] = 0;</span>
<span class="linenos">1787</span><span class="cm">        dims[1] = 5;</span>
<span class="linenos">1788</span><span class="cm">        maxDims[0] = H5S_UNLIMITED;</span>
<span class="linenos">1789</span><span class="cm">        maxDims[1] = 5;</span>
<span class="linenos">1790</span><span class="cm">        chunkDims[0] = 100;</span>
<span class="linenos">1791</span><span class="cm">        chunkDims[1] = 5;</span>
<span class="linenos">1792</span><span class="cm">        hid_t dataspace_id, dcpl_id;</span>
<span class="linenos">1793</span><span class="cm">        HDF5_EXCEPTION_CALL(dataspace_id,H5Screate_simple(RANK, dims, maxDims));</span>
<span class="linenos">1794</span><span class="cm">        HDF5_EXCEPTION_CALL(dcpl_id,H5Pcreate(H5P_DATASET_CREATE));</span>
<span class="linenos">1795</span><span class="cm">        HDF5_EXCEPTION_CHECK(H5Pset_chunk(dcpl_id, RANK, chunkDims));</span>
<span class="linenos">1796</span><span class="cm">        HDF5_EXCEPTION_CALL(spheresDatasetHandle,H5Dcreate2(spatialHandle, &quot;Spheres&quot;, H5T_IEEE_F64LE, dataspace_id, H5P_DEFAULT, dcpl_id, H5P_DEFAULT));</span>
<span class="linenos">1797</span><span class="cm">        HDF5_EXCEPTION_CHECK(H5Pclose(dcpl_id));</span>
<span class="linenos">1798</span><span class="cm">        HDF5_EXCEPTION_CHECK(H5Sclose(dataspace_id));</span>
<span class="linenos">1799</span><span class="cm">    }</span>
<span class="linenos">1800</span>
<span class="linenos">1801</span><span class="cm">    // Get the current size of the dataset.</span>
<span class="linenos">1802</span><span class="cm">    unsigned int RANK=2;</span>
<span class="linenos">1803</span><span class="cm">    hsize_t dims[RANK];</span>
<span class="linenos">1804</span><span class="cm">    hid_t dataspace_id;</span>
<span class="linenos">1805</span><span class="cm">    int result;</span>
<span class="linenos">1806</span><span class="cm">    HDF5_EXCEPTION_CALL(dataspace_id,H5Dget_space(spheresDatasetHandle));</span>
<span class="linenos">1807</span><span class="cm">    HDF5_EXCEPTION_CALL(result,H5Sget_simple_extent_dims(dataspace_id, dims, NULL));</span>
<span class="linenos">1808</span><span class="cm">    HDF5_EXCEPTION_CHECK(H5Sclose(dataspace_id));</span>
<span class="linenos">1809</span>
<span class="linenos">1810</span><span class="cm">    // Extend the dataset by the number of rows in the data set.</span>
<span class="linenos">1811</span><span class="cm">    dims[0] += model-&gt;sphere_type_size();</span>
<span class="linenos">1812</span><span class="cm">    HDF5_EXCEPTION_CHECK(H5Dset_extent(spheresDatasetHandle, dims));</span>
<span class="linenos">1813</span>
<span class="linenos">1814</span><span class="cm">    // Create the memory dataset.</span>
<span class="linenos">1815</span><span class="cm">    hid_t memspace_id;</span>
<span class="linenos">1816</span><span class="cm">    hsize_t memDims[RANK];</span>
<span class="linenos">1817</span><span class="cm">    memDims[0] = model-&gt;sphere_type_size();</span>
<span class="linenos">1818</span><span class="cm">    memDims[1] = 1;</span>
<span class="linenos">1819</span><span class="cm">    HDF5_EXCEPTION_CALL(memspace_id,H5Screate_simple(RANK, memDims, NULL));</span>
<span class="linenos">1820</span>
<span class="linenos">1821</span><span class="cm">    // Write the values.</span>
<span class="linenos">1822</span><span class="cm">    HDF5_EXCEPTION_CALL(dataspace_id,H5Dget_space(spheresDatasetHandle));</span>
<span class="linenos">1823</span><span class="cm">    hsize_t start[RANK], count[RANK];</span>
<span class="linenos">1824</span><span class="cm">    start[0] = dims[0]-model-&gt;sphere_type_size();</span>
<span class="linenos">1825</span><span class="cm">    count[0] = model-&gt;sphere_type_size();</span>
<span class="linenos">1826</span><span class="cm">    start[1] = 0;</span>
<span class="linenos">1827</span><span class="cm">    count[1] = 1;</span>
<span class="linenos">1828</span><span class="cm">    HDF5_EXCEPTION_CHECK(H5Sselect_hyperslab(dataspace_id, H5S_SELECT_SET, start, NULL, count, NULL));</span>
<span class="linenos">1829</span><span class="cm">    HDF5_EXCEPTION_CHECK(H5Dwrite(spheresDatasetHandle, H5T_NATIVE_DOUBLE, memspace_id, dataspace_id, H5P_DEFAULT, model-&gt;sphere_xc().data()));</span>
<span class="linenos">1830</span><span class="cm">    start[1] = 1;</span>
<span class="linenos">1831</span><span class="cm">    HDF5_EXCEPTION_CHECK(H5Sselect_hyperslab(dataspace_id, H5S_SELECT_SET, start, NULL, count, NULL));</span>
<span class="linenos">1832</span><span class="cm">    HDF5_EXCEPTION_CHECK(H5Dwrite(spheresDatasetHandle, H5T_NATIVE_DOUBLE, memspace_id, dataspace_id, H5P_DEFAULT, model-&gt;sphere_yc().data()));</span>
<span class="linenos">1833</span><span class="cm">    start[1] = 2;</span>
<span class="linenos">1834</span><span class="cm">    HDF5_EXCEPTION_CHECK(H5Sselect_hyperslab(dataspace_id, H5S_SELECT_SET, start, NULL, count, NULL));</span>
<span class="linenos">1835</span><span class="cm">    HDF5_EXCEPTION_CHECK(H5Dwrite(spheresDatasetHandle, H5T_NATIVE_DOUBLE, memspace_id, dataspace_id, H5P_DEFAULT, model-&gt;sphere_zc().data()));</span>
<span class="linenos">1836</span><span class="cm">    start[1] = 3;</span>
<span class="linenos">1837</span><span class="cm">    HDF5_EXCEPTION_CHECK(H5Sselect_hyperslab(dataspace_id, H5S_SELECT_SET, start, NULL, count, NULL));</span>
<span class="linenos">1838</span><span class="cm">    HDF5_EXCEPTION_CHECK(H5Dwrite(spheresDatasetHandle, H5T_NATIVE_DOUBLE, memspace_id, dataspace_id, H5P_DEFAULT, model-&gt;sphere_radius().data()));</span>
<span class="linenos">1839</span><span class="cm">    start[1] = 4;</span>
<span class="linenos">1840</span><span class="cm">    HDF5_EXCEPTION_CHECK(H5Sselect_hyperslab(dataspace_id, H5S_SELECT_SET, start, NULL, count, NULL));</span>
<span class="linenos">1841</span><span class="cm">    HDF5_EXCEPTION_CHECK(H5Dwrite(spheresDatasetHandle, H5T_NATIVE_DOUBLE, memspace_id, dataspace_id, H5P_DEFAULT, model-&gt;sphere_type().data()));</span>
<span class="linenos">1842</span>
<span class="linenos">1843</span><span class="cm">    // Cleanup some resources.</span>
<span class="linenos">1844</span><span class="cm">    HDF5_EXCEPTION_CHECK(H5Sclose(dataspace_id));</span>
<span class="linenos">1845</span><span class="cm">    HDF5_EXCEPTION_CHECK(H5Sclose(memspace_id));</span>
<span class="linenos">1846</span><span class="cm">    HDF5_EXCEPTION_CHECK(H5Dclose(spheresDatasetHandle));</span>
<span class="linenos">1847</span><span class="cm">    HDF5_EXCEPTION_CHECK(H5Gclose(modelHandle));</span>
<span class="linenos">1848</span><span class="cm">    HDF5_EXCEPTION_CHECK(H5Gclose(spatialHandle));</span>
<span class="linenos">1849</span><span class="cm">}</span>
<span class="linenos">1850</span>
<span class="linenos">1851</span><span class="cm">void SimulationFile::getSpatialModelObjects(unsigned int replicate, lm::io::SpatialModel * model)</span>
<span class="linenos">1852</span><span class="cm">{</span>
<span class="linenos">1853</span><span class="cm">    ReplicateHandles * replicateHandles = openReplicateHandles(replicate);</span>
<span class="linenos">1854</span>
<span class="linenos">1855</span><span class="cm">    // Open the group.</span>
<span class="linenos">1856</span><span class="cm">    hid_t modelHandle, spatialHandle;</span>
<span class="linenos">1857</span><span class="cm">    HDF5_EXCEPTION_CALL(modelHandle,H5Gopen2(replicateHandles-&gt;group, &quot;Model&quot;, H5P_DEFAULT));</span>
<span class="linenos">1858</span><span class="cm">    HDF5_EXCEPTION_CALL(spatialHandle,H5Gopen2(modelHandle, &quot;Spatial&quot;, H5P_DEFAULT));</span>
<span class="linenos">1859</span>
<span class="linenos">1860</span><span class="cm">    // Open the datasets.</span>
<span class="linenos">1861</span><span class="cm">    hid_t spheresDatasetHandle;</span>
<span class="linenos">1862</span><span class="cm">    HDF5_EXCEPTION_CALL(spheresDatasetHandle,H5Dopen2(spatialHandle, &quot;Spheres&quot;, H5P_DEFAULT));</span>
<span class="linenos">1863</span>
<span class="linenos">1864</span><span class="cm">    // Get the current size of the dataset.</span>
<span class="linenos">1865</span><span class="cm">    const uint RANK=2;</span>
<span class="linenos">1866</span><span class="cm">    const uint NUM_COLS=5;</span>
<span class="linenos">1867</span><span class="cm">    hsize_t dims[RANK];</span>
<span class="linenos">1868</span><span class="cm">    hid_t dataspace_id;</span>
<span class="linenos">1869</span><span class="cm">    int result;</span>
<span class="linenos">1870</span><span class="cm">    HDF5_EXCEPTION_CALL(dataspace_id,H5Dget_space(spheresDatasetHandle));</span>
<span class="linenos">1871</span><span class="cm">    HDF5_EXCEPTION_CALL(result,H5Sget_simple_extent_dims(dataspace_id, dims, NULL));</span>
<span class="linenos">1872</span>
<span class="linenos">1873</span><span class="cm">    // Create the memory dataset.</span>
<span class="linenos">1874</span><span class="cm">    hid_t memspace_id;</span>
<span class="linenos">1875</span><span class="cm">    hsize_t memDims[RANK];</span>
<span class="linenos">1876</span><span class="cm">    memDims[0] = TUNE_SPATIAL_MODEL_OBJECT_READ_BUFFER_SIZE;</span>
<span class="linenos">1877</span><span class="cm">    memDims[1] = NUM_COLS;</span>
<span class="linenos">1878</span><span class="cm">    HDF5_EXCEPTION_CALL(memspace_id,H5Screate_simple(RANK, memDims, NULL));</span>
<span class="linenos">1879</span><span class="cm">    double * memData = new double[TUNE_SPATIAL_MODEL_OBJECT_READ_BUFFER_SIZE*NUM_COLS];</span>
<span class="linenos">1880</span>
<span class="linenos">1881</span><span class="cm">    // Loop over the data and read it in one section at a time.</span>
<span class="linenos">1882</span><span class="cm">    hsize_t start[RANK], count[RANK];</span>
<span class="linenos">1883</span><span class="cm">    start[0] = 0;</span>
<span class="linenos">1884</span><span class="cm">    start[1] = 0;</span>
<span class="linenos">1885</span><span class="cm">    count[0] = TUNE_SPATIAL_MODEL_OBJECT_READ_BUFFER_SIZE;</span>
<span class="linenos">1886</span><span class="cm">    count[1] = NUM_COLS;</span>
<span class="linenos">1887</span><span class="cm">    while (start[0] &lt; dims[0])</span>
<span class="linenos">1888</span><span class="cm">    {</span>
<span class="linenos">1889</span><span class="cm">        // Figure out how many rows to read.</span>
<span class="linenos">1890</span><span class="cm">        if (start[0]+count[0] &gt; dims[0])</span>
<span class="linenos">1891</span><span class="cm">        {</span>
<span class="linenos">1892</span><span class="cm">            // This is the last read, so modify its size.</span>
<span class="linenos">1893</span><span class="cm">            count[0] = dims[0]-start[0];</span>
<span class="linenos">1894</span>
<span class="linenos">1895</span><span class="cm">            // Modify the memory dataspace as well.</span>
<span class="linenos">1896</span><span class="cm">            HDF5_EXCEPTION_CHECK(H5Sclose(memspace_id));</span>
<span class="linenos">1897</span><span class="cm">            memDims[0] = count[0];</span>
<span class="linenos">1898</span><span class="cm">            HDF5_EXCEPTION_CALL(memspace_id,H5Screate_simple(RANK, memDims, NULL));</span>
<span class="linenos">1899</span><span class="cm">        }</span>
<span class="linenos">1900</span>
<span class="linenos">1901</span><span class="cm">        // Read the rows.</span>
<span class="linenos">1902</span><span class="cm">        HDF5_EXCEPTION_CHECK(H5Sselect_hyperslab(dataspace_id, H5S_SELECT_SET, start, NULL, count, NULL));</span>
<span class="linenos">1903</span><span class="cm">        HDF5_EXCEPTION_CHECK(H5Dread(spheresDatasetHandle, H5T_NATIVE_DOUBLE, memspace_id, dataspace_id, H5P_DEFAULT, (void *)memData));</span>
<span class="linenos">1904</span>
<span class="linenos">1905</span><span class="cm">        // Add them to the model.</span>
<span class="linenos">1906</span><span class="cm">        for (uint index=0; index&lt;count[0]*NUM_COLS; )</span>
<span class="linenos">1907</span><span class="cm">        {</span>
<span class="linenos">1908</span><span class="cm">            model-&gt;add_sphere_xc(memData[index++]);</span>
<span class="linenos">1909</span><span class="cm">            model-&gt;add_sphere_yc(memData[index++]);</span>
<span class="linenos">1910</span><span class="cm">            model-&gt;add_sphere_zc(memData[index++]);</span>
<span class="linenos">1911</span><span class="cm">            model-&gt;add_sphere_radius(memData[index++]);</span>
<span class="linenos">1912</span><span class="cm">            model-&gt;add_sphere_type(memData[index++]);</span>
<span class="linenos">1913</span><span class="cm">        }</span>
<span class="linenos">1914</span>
<span class="linenos">1915</span><span class="cm">        // Move to the next section.</span>
<span class="linenos">1916</span><span class="cm">        start[0] += count[0];</span>
<span class="linenos">1917</span><span class="cm">    }</span>
<span class="linenos">1918</span>
<span class="linenos">1919</span><span class="cm">    // Cleanup some resources.</span>
<span class="linenos">1920</span><span class="cm">    if (memData != NULL) delete []  memData; memData = NULL;</span>
<span class="linenos">1921</span><span class="cm">    HDF5_EXCEPTION_CHECK(H5Sclose(dataspace_id));</span>
<span class="linenos">1922</span><span class="cm">    HDF5_EXCEPTION_CHECK(H5Sclose(memspace_id));</span>
<span class="linenos">1923</span><span class="cm">    HDF5_EXCEPTION_CHECK(H5Dclose(spheresDatasetHandle));</span>
<span class="linenos">1924</span><span class="cm">    HDF5_EXCEPTION_CHECK(H5Gclose(modelHandle));</span>
<span class="linenos">1925</span><span class="cm">    HDF5_EXCEPTION_CHECK(H5Gclose(spatialHandle));</span>
<span class="linenos">1926</span><span class="cm">}*/</span>
<span class="linenos">1927</span>
<span class="linenos">1928</span>
<span class="linenos">1929</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="w"> </span><span class="n">SimulationFile</span><span class="o">::</span><span class="n">getLatticeTimes</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">replicate</span><span class="p">)</span>
<span class="linenos">1930</span><span class="p">{</span>
<span class="linenos">1931</span><span class="w">    </span><span class="n">ReplicateHandles</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">replicateHandles</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">openReplicateHandles</span><span class="p">(</span><span class="n">replicate</span><span class="p">);</span>
<span class="linenos">1932</span>
<span class="linenos">1933</span><span class="w">    </span><span class="c1">// Read the initial species counts.</span>
<span class="linenos">1934</span><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">RANK</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">rank</span><span class="p">;</span>
<span class="linenos">1935</span><span class="w">    </span><span class="n">hsize_t</span><span class="w"> </span><span class="n">dims</span><span class="p">[</span><span class="n">RANK</span><span class="p">];</span>
<span class="linenos">1936</span><span class="w">    </span><span class="n">H5T_class_t</span><span class="w"> </span><span class="n">type</span><span class="p">;</span>
<span class="linenos">1937</span><span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">size</span><span class="p">;</span>
<span class="linenos">1938</span><span class="w">    </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5LTget_dataset_ndims</span><span class="p">(</span><span class="n">replicateHandles</span><span class="o">-&gt;</span><span class="n">group</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;LatticeTimes&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">rank</span><span class="p">));</span>
<span class="linenos">1939</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rank</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">RANK</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="n">Exception</span><span class="p">(</span><span class="s">&quot;Invalid dataset rank&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">filename</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot;LatticeTimes&quot;</span><span class="p">);</span>
<span class="linenos">1940</span><span class="w">    </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5LTget_dataset_info</span><span class="p">(</span><span class="n">replicateHandles</span><span class="o">-&gt;</span><span class="n">group</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;LatticeTimes&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">dims</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">size</span><span class="p">));</span>
<span class="linenos">1941</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">double</span><span class="p">))</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="n">Exception</span><span class="p">(</span><span class="s">&quot;Invalid dataset type&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">filename</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot;LatticeTimes&quot;</span><span class="p">);</span>
<span class="linenos">1942</span><span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">timesBuffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">double</span><span class="p">[</span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]];</span>
<span class="linenos">1943</span><span class="w">    </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5LTread_dataset_double</span><span class="p">(</span><span class="n">replicateHandles</span><span class="o">-&gt;</span><span class="n">group</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;LatticeTimes&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">timesBuffer</span><span class="p">));</span>
<span class="linenos">1944</span><span class="w">    </span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="w"> </span><span class="n">times</span><span class="p">;</span>
<span class="linenos">1945</span><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">1946</span><span class="w">        </span><span class="n">times</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">timesBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="linenos">1947</span><span class="w">    </span><span class="k">delete</span><span class="w"> </span><span class="p">[]</span><span class="w"> </span><span class="n">timesBuffer</span><span class="p">;</span>
<span class="linenos">1948</span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">times</span><span class="p">;</span>
<span class="linenos">1949</span><span class="p">}</span>
<span class="linenos">1950</span>
<span class="linenos">1951</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="w"> </span><span class="n">SimulationFile</span><span class="o">::</span><span class="n">getSpeciesCountTimes</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">replicate</span><span class="p">)</span>
<span class="linenos">1952</span><span class="p">{</span>
<span class="linenos">1953</span><span class="w">    </span><span class="n">ReplicateHandles</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">replicateHandles</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">openReplicateHandles</span><span class="p">(</span><span class="n">replicate</span><span class="p">);</span>
<span class="linenos">1954</span>
<span class="linenos">1955</span><span class="w">    </span><span class="c1">// Read the initial species counts.</span>
<span class="linenos">1956</span><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">RANK</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">rank</span><span class="p">;</span>
<span class="linenos">1957</span><span class="w">    </span><span class="n">hsize_t</span><span class="w"> </span><span class="n">dims</span><span class="p">[</span><span class="n">RANK</span><span class="p">];</span>
<span class="linenos">1958</span><span class="w">    </span><span class="n">H5T_class_t</span><span class="w"> </span><span class="n">type</span><span class="p">;</span>
<span class="linenos">1959</span><span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">size</span><span class="p">;</span>
<span class="linenos">1960</span><span class="w">    </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5LTget_dataset_ndims</span><span class="p">(</span><span class="n">replicateHandles</span><span class="o">-&gt;</span><span class="n">group</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;SpeciesCountTimes&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">rank</span><span class="p">));</span>
<span class="linenos">1961</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rank</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">RANK</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="n">Exception</span><span class="p">(</span><span class="s">&quot;Invalid dataset rank&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">filename</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot;SpeciesCountTimes&quot;</span><span class="p">);</span>
<span class="linenos">1962</span><span class="w">    </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5LTget_dataset_info</span><span class="p">(</span><span class="n">replicateHandles</span><span class="o">-&gt;</span><span class="n">group</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;SpeciesCountTimes&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">dims</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">size</span><span class="p">));</span>
<span class="linenos">1963</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">double</span><span class="p">))</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="n">Exception</span><span class="p">(</span><span class="s">&quot;Invalid dataset type&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">filename</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot;SpeciesCountTimes&quot;</span><span class="p">);</span>
<span class="linenos">1964</span><span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">timesBuffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">double</span><span class="p">[</span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]];</span>
<span class="linenos">1965</span><span class="w">    </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5LTread_dataset_double</span><span class="p">(</span><span class="n">replicateHandles</span><span class="o">-&gt;</span><span class="n">group</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;SpeciesCountTimes&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">timesBuffer</span><span class="p">));</span>
<span class="linenos">1966</span><span class="w">    </span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="w"> </span><span class="n">times</span><span class="p">;</span>
<span class="linenos">1967</span><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">1968</span><span class="w">        </span><span class="n">times</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">timesBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="linenos">1969</span><span class="w">    </span><span class="k">delete</span><span class="w"> </span><span class="p">[]</span><span class="w"> </span><span class="n">timesBuffer</span><span class="p">;</span>
<span class="linenos">1970</span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">times</span><span class="p">;</span>
<span class="linenos">1971</span><span class="p">}</span>
<span class="linenos">1972</span>
<span class="linenos">1973</span><span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="kt">double</span><span class="p">,</span><span class="w"> </span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">SimulationFile</span><span class="o">::</span><span class="n">getSpeciesCounts</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">replicate</span><span class="p">)</span>
<span class="linenos">1974</span><span class="p">{</span>
<span class="linenos">1975</span><span class="w">    </span><span class="n">ReplicateHandles</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">replicateHandles</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">openReplicateHandles</span><span class="p">(</span><span class="n">replicate</span><span class="p">);</span>
<span class="linenos">1976</span><span class="w">	</span><span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="kt">double</span><span class="p">,</span><span class="w"> </span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">particles</span><span class="p">;</span>
<span class="linenos">1977</span>
<span class="linenos">1978</span><span class="w">    </span><span class="c1">// Read the initial species counts.</span>
<span class="linenos">1979</span><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">RANK</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">rank</span><span class="p">;</span>
<span class="linenos">1980</span><span class="w">    </span><span class="n">hsize_t</span><span class="w"> </span><span class="n">dims</span><span class="p">[</span><span class="n">RANK</span><span class="p">];</span>
<span class="linenos">1981</span><span class="w">    </span><span class="n">H5T_class_t</span><span class="w"> </span><span class="n">type</span><span class="p">;</span>
<span class="linenos">1982</span><span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">size</span><span class="p">;</span>
<span class="linenos">1983</span><span class="w">    </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5LTget_dataset_ndims</span><span class="p">(</span><span class="n">replicateHandles</span><span class="o">-&gt;</span><span class="n">group</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;SpeciesCounts&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">rank</span><span class="p">));</span>
<span class="linenos">1984</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rank</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">RANK</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="n">Exception</span><span class="p">(</span><span class="s">&quot;Invalid dataset rank&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">filename</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot;SpeciesCounts&quot;</span><span class="p">);</span>
<span class="linenos">1985</span><span class="w">    </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5LTget_dataset_info</span><span class="p">(</span><span class="n">replicateHandles</span><span class="o">-&gt;</span><span class="n">group</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;SpeciesCounts&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">dims</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">size</span><span class="p">));</span>
<span class="linenos">1986</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">))</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="n">Exception</span><span class="p">(</span><span class="s">&quot;Invalid dataset type&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">filename</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot;SpeciesCounts&quot;</span><span class="p">);</span>
<span class="linenos">1987</span><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">counts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">int</span><span class="p">[</span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]];</span>
<span class="linenos">1988</span><span class="w">    </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5LTread_dataset_int</span><span class="p">(</span><span class="n">replicateHandles</span><span class="o">-&gt;</span><span class="n">group</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;SpeciesCounts&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">counts</span><span class="p">));</span>
<span class="linenos">1989</span>
<span class="linenos">1990</span><span class="w">    </span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="w"> </span><span class="n">times</span><span class="o">=</span><span class="n">getSpeciesCountTimes</span><span class="p">(</span><span class="n">replicate</span><span class="p">);</span>
<span class="linenos">1991</span>
<span class="linenos">1992</span><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">1993</span><span class="w">	</span><span class="p">{</span>
<span class="linenos">1994</span><span class="w">		</span><span class="c1">//printf(&quot;counts at time %g (frame %d):\n&quot;, times[i], i);</span>
<span class="linenos">1995</span><span class="w">		</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="w"> </span><span class="n">p</span><span class="p">(</span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
<span class="linenos">1996</span><span class="w">		</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">&lt;</span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span><span class="w"> </span><span class="n">j</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">1997</span><span class="w">		</span><span class="p">{</span>
<span class="linenos">1998</span><span class="w">			</span><span class="c1">//printf(&quot;%d &quot;, counts[i*dims[1] + j]);</span>
<span class="linenos">1999</span><span class="w">			</span><span class="c1">// expecting 1-based vector of particles</span>
<span class="linenos">2000</span><span class="w">			</span><span class="n">p</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">counts</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="p">];</span>
<span class="linenos">2001</span><span class="w">		</span><span class="p">}</span>
<span class="linenos">2002</span>
<span class="linenos">2003</span><span class="w">		</span><span class="n">particles</span><span class="p">[</span><span class="n">times</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">=</span><span class="n">p</span><span class="p">;</span>
<span class="linenos">2004</span><span class="w">	</span><span class="p">}</span>
<span class="linenos">2005</span>
<span class="linenos">2006</span><span class="w">    </span><span class="k">delete</span><span class="w"> </span><span class="p">[]</span><span class="w"> </span><span class="n">counts</span><span class="p">;</span>
<span class="linenos">2007</span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">particles</span><span class="p">;</span>
<span class="linenos">2008</span><span class="p">}</span>
<span class="linenos">2009</span>
<span class="linenos">2010</span><span class="kt">void</span><span class="w"> </span><span class="n">SimulationFile</span><span class="o">::</span><span class="n">getLattice</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">replicate</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeIndex</span><span class="p">,</span><span class="w"> </span><span class="n">lm</span><span class="o">::</span><span class="n">rdme</span><span class="o">::</span><span class="n">Lattice</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">lattice</span><span class="p">)</span>
<span class="linenos">2011</span><span class="p">{</span>
<span class="linenos">2012</span><span class="w">    </span><span class="n">ReplicateHandles</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">replicateHandles</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">openReplicateHandles</span><span class="p">(</span><span class="n">replicate</span><span class="p">);</span>
<span class="linenos">2013</span>
<span class="linenos">2014</span><span class="w">    </span><span class="c1">// Read the lattice data.</span>
<span class="linenos">2015</span><span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">latticeDatasetName</span><span class="p">[</span><span class="mi">19</span><span class="p">];</span>
<span class="linenos">2016</span><span class="w">    </span><span class="n">snprintf</span><span class="p">(</span><span class="n">latticeDatasetName</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">latticeDatasetName</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;Lattice/%010d&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">latticeIndex</span><span class="p">);</span>
<span class="linenos">2017</span><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">RANK</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="n">rank</span><span class="p">;</span>
<span class="linenos">2018</span><span class="w">    </span><span class="n">hsize_t</span><span class="w"> </span><span class="n">dims</span><span class="p">[</span><span class="n">RANK</span><span class="p">];</span>
<span class="linenos">2019</span><span class="w">    </span><span class="n">H5T_class_t</span><span class="w"> </span><span class="n">type</span><span class="p">;</span>
<span class="linenos">2020</span><span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">size</span><span class="p">;</span>
<span class="linenos">2021</span><span class="w">    </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5LTget_dataset_ndims</span><span class="p">(</span><span class="n">replicateHandles</span><span class="o">-&gt;</span><span class="n">group</span><span class="p">,</span><span class="w"> </span><span class="n">latticeDatasetName</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">rank</span><span class="p">));</span>
<span class="linenos">2022</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rank</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">RANK</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="n">Exception</span><span class="p">(</span><span class="s">&quot;Invalid dataset rank&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">filename</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span><span class="w"> </span><span class="n">latticeDatasetName</span><span class="p">);</span>
<span class="linenos">2023</span><span class="w">    </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5LTget_dataset_info</span><span class="p">(</span><span class="n">replicateHandles</span><span class="o">-&gt;</span><span class="n">group</span><span class="p">,</span><span class="w"> </span><span class="n">latticeDatasetName</span><span class="p">,</span><span class="w"> </span><span class="n">dims</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">size</span><span class="p">));</span>
<span class="linenos">2024</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getSize</span><span class="p">().</span><span class="n">x</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getSize</span><span class="p">().</span><span class="n">y</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getSize</span><span class="p">().</span><span class="n">z</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">dims</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">getMaxOccupancy</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">dims</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="n">Exception</span><span class="p">(</span><span class="s">&quot;Invalid lattice dimensions&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">filename</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
<span class="linenos">2025</span><span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">particlesBufferSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">dims</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">dims</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
<span class="linenos">2026</span>
<span class="linenos">2027</span><span class="w">	</span><span class="k">switch</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
<span class="linenos">2028</span><span class="w">	</span><span class="p">{</span>
<span class="linenos">2029</span><span class="w">		</span><span class="k">case</span><span class="w"> </span><span class="no">sizeof</span><span class="p">(</span><span class="no">uint8_t</span><span class="p">):</span>
<span class="linenos">2030</span><span class="w">		</span><span class="p">{</span>
<span class="linenos">2031</span><span class="w">			</span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">particlesBuffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">uint8_t</span><span class="p">[</span><span class="n">particlesBufferSize</span><span class="p">];</span>
<span class="linenos">2032</span><span class="w">			</span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5LTread_dataset</span><span class="p">(</span><span class="n">replicateHandles</span><span class="o">-&gt;</span><span class="n">group</span><span class="p">,</span><span class="w"> </span><span class="n">latticeDatasetName</span><span class="p">,</span><span class="w"> </span><span class="n">H5T_STD_U8LE</span><span class="p">,</span><span class="w"> </span><span class="n">particlesBuffer</span><span class="p">));</span>
<span class="linenos">2033</span><span class="w">			</span><span class="n">lattice</span><span class="o">-&gt;</span><span class="n">setFromRowMajorByteData</span><span class="p">(</span><span class="n">particlesBuffer</span><span class="p">,</span><span class="w"> </span><span class="n">particlesBufferSize</span><span class="p">);</span>
<span class="linenos">2034</span><span class="w">			</span><span class="k">delete</span><span class="w"> </span><span class="p">[]</span><span class="w"> </span><span class="n">particlesBuffer</span><span class="p">;</span>
<span class="linenos">2035</span><span class="w">			</span><span class="k">break</span><span class="p">;</span>
<span class="linenos">2036</span><span class="w">		</span><span class="p">}</span>
<span class="linenos">2037</span><span class="w">		</span><span class="k">case</span><span class="w"> </span><span class="no">sizeof</span><span class="p">(</span><span class="no">int</span><span class="p">):</span>
<span class="linenos">2038</span><span class="w">		</span><span class="p">{</span>
<span class="linenos">2039</span><span class="w">			</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">particlesBuffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="p">[</span><span class="n">particlesBufferSize</span><span class="p">];</span>
<span class="linenos">2040</span><span class="w">			</span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5LTread_dataset</span><span class="p">(</span><span class="n">replicateHandles</span><span class="o">-&gt;</span><span class="n">group</span><span class="p">,</span><span class="w"> </span><span class="n">latticeDatasetName</span><span class="p">,</span><span class="w"> </span><span class="n">H5T_STD_U32LE</span><span class="p">,</span><span class="w"> </span><span class="n">particlesBuffer</span><span class="p">));</span>
<span class="linenos">2041</span><span class="w">			</span><span class="n">lm</span><span class="o">::</span><span class="n">rdme</span><span class="o">::</span><span class="n">IntLattice</span><span class="w"> </span><span class="o">*</span><span class="n">intlattice</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">lm</span><span class="o">::</span><span class="n">rdme</span><span class="o">::</span><span class="n">IntLattice</span><span class="o">*</span><span class="p">)</span><span class="n">lattice</span><span class="p">;</span>
<span class="linenos">2042</span><span class="w">			</span><span class="n">intlattice</span><span class="o">-&gt;</span><span class="n">setFromRowMajorData</span><span class="p">(</span><span class="n">particlesBuffer</span><span class="p">,</span><span class="w"> </span><span class="n">particlesBufferSize</span><span class="p">);</span>
<span class="linenos">2043</span><span class="w">			</span><span class="k">delete</span><span class="w"> </span><span class="p">[]</span><span class="w"> </span><span class="n">particlesBuffer</span><span class="p">;</span>
<span class="linenos">2044</span><span class="w">			</span><span class="k">break</span><span class="p">;</span>
<span class="linenos">2045</span><span class="w">		</span><span class="p">}</span>
<span class="linenos">2046</span><span class="w">		</span><span class="k">default</span><span class="o">:</span>
<span class="linenos">2047</span><span class="w">			</span><span class="k">throw</span><span class="w"> </span><span class="n">Exception</span><span class="p">(</span><span class="s">&quot;Unsupported dataset size&quot;</span><span class="p">,</span><span class="n">size</span><span class="p">);</span>
<span class="linenos">2048</span><span class="w">	</span><span class="p">}</span>
<span class="linenos">2049</span><span class="p">}</span>
<span class="linenos">2050</span>
<span class="linenos">2051</span><span class="c1">// Get particle counts without actually copying to a lattice</span>
<span class="linenos">2052</span><span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="kt">uint32_t</span><span class="p">,</span><span class="w"> </span><span class="n">uint</span><span class="o">&gt;</span><span class="w"> </span><span class="n">SimulationFile</span><span class="o">::</span><span class="n">getParticleCounts</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">replicate</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">latticeIndex</span><span class="p">)</span>
<span class="linenos">2053</span><span class="p">{</span>
<span class="linenos">2054</span><span class="w">    </span><span class="n">ReplicateHandles</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">replicateHandles</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">openReplicateHandles</span><span class="p">(</span><span class="n">replicate</span><span class="p">);</span>
<span class="linenos">2055</span>
<span class="linenos">2056</span><span class="w">    </span><span class="c1">// Read the lattice data.</span>
<span class="linenos">2057</span><span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">latticeDatasetName</span><span class="p">[</span><span class="mi">19</span><span class="p">];</span>
<span class="linenos">2058</span><span class="w">    </span><span class="n">snprintf</span><span class="p">(</span><span class="n">latticeDatasetName</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">latticeDatasetName</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;Lattice/%010d&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">latticeIndex</span><span class="p">);</span>
<span class="linenos">2059</span><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">RANK</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="n">rank</span><span class="p">;</span>
<span class="linenos">2060</span><span class="w">    </span><span class="n">hsize_t</span><span class="w"> </span><span class="n">dims</span><span class="p">[</span><span class="n">RANK</span><span class="p">];</span>
<span class="linenos">2061</span><span class="w">    </span><span class="n">H5T_class_t</span><span class="w"> </span><span class="n">type</span><span class="p">;</span>
<span class="linenos">2062</span><span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">size</span><span class="p">;</span>
<span class="linenos">2063</span><span class="w">    </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5LTget_dataset_ndims</span><span class="p">(</span><span class="n">replicateHandles</span><span class="o">-&gt;</span><span class="n">group</span><span class="p">,</span><span class="w"> </span><span class="n">latticeDatasetName</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">rank</span><span class="p">));</span>
<span class="linenos">2064</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rank</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">RANK</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="n">Exception</span><span class="p">(</span><span class="s">&quot;Invalid dataset rank&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">filename</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span><span class="w"> </span><span class="n">latticeDatasetName</span><span class="p">);</span>
<span class="linenos">2065</span><span class="w">    </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5LTget_dataset_info</span><span class="p">(</span><span class="n">replicateHandles</span><span class="o">-&gt;</span><span class="n">group</span><span class="p">,</span><span class="w"> </span><span class="n">latticeDatasetName</span><span class="p">,</span><span class="w"> </span><span class="n">dims</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">size</span><span class="p">));</span>
<span class="linenos">2066</span><span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">particlesBufferSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">dims</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">dims</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
<span class="linenos">2067</span>
<span class="linenos">2068</span><span class="w">	</span><span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="kt">uint32_t</span><span class="p">,</span><span class="w"> </span><span class="n">uint</span><span class="o">&gt;</span><span class="w"> </span><span class="n">particles</span><span class="p">;</span>
<span class="linenos">2069</span><span class="w">	</span><span class="k">switch</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
<span class="linenos">2070</span><span class="w">	</span><span class="p">{</span>
<span class="linenos">2071</span><span class="w">		</span><span class="k">case</span><span class="w"> </span><span class="no">sizeof</span><span class="p">(</span><span class="no">uint8_t</span><span class="p">):</span>
<span class="linenos">2072</span><span class="w">		</span><span class="p">{</span>
<span class="linenos">2073</span><span class="w">			</span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">particlesBuffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">uint8_t</span><span class="p">[</span><span class="n">particlesBufferSize</span><span class="p">];</span>
<span class="linenos">2074</span><span class="w">			</span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5LTread_dataset</span><span class="p">(</span><span class="n">replicateHandles</span><span class="o">-&gt;</span><span class="n">group</span><span class="p">,</span><span class="w"> </span><span class="n">latticeDatasetName</span><span class="p">,</span><span class="w"> </span><span class="n">H5T_STD_U8LE</span><span class="p">,</span><span class="w"> </span><span class="n">particlesBuffer</span><span class="p">));</span>
<span class="linenos">2075</span><span class="w">			</span><span class="k">for</span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">particlesBufferSize</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">2076</span><span class="w">			</span><span class="p">{</span>
<span class="linenos">2077</span><span class="w">				</span><span class="k">const</span><span class="w"> </span><span class="n">particle_t</span><span class="w"> </span><span class="n">p</span><span class="o">=</span><span class="n">particlesBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="linenos">2078</span><span class="w">				</span><span class="k">if</span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">2079</span><span class="w">				</span><span class="p">{</span>
<span class="linenos">2080</span><span class="w">					</span><span class="k">if</span><span class="p">(</span><span class="n">particles</span><span class="p">.</span><span class="n">count</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">2081</span><span class="w">						</span><span class="n">particles</span><span class="p">[</span><span class="n">p</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
<span class="linenos">2082</span><span class="w">					</span><span class="k">else</span>
<span class="linenos">2083</span><span class="w">						</span><span class="n">particles</span><span class="p">[</span><span class="n">p</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
<span class="linenos">2084</span><span class="w">				</span><span class="p">}</span>
<span class="linenos">2085</span><span class="w">			</span><span class="p">}</span>
<span class="linenos">2086</span><span class="w">			</span><span class="k">delete</span><span class="w"> </span><span class="p">[]</span><span class="w"> </span><span class="n">particlesBuffer</span><span class="p">;</span>
<span class="linenos">2087</span><span class="w">			</span><span class="k">break</span><span class="p">;</span>
<span class="linenos">2088</span><span class="w">		</span><span class="p">}</span>
<span class="linenos">2089</span><span class="w">		</span><span class="k">case</span><span class="w"> </span><span class="no">sizeof</span><span class="p">(</span><span class="no">int</span><span class="p">):</span>
<span class="linenos">2090</span><span class="w">		</span><span class="p">{</span>
<span class="linenos">2091</span><span class="w">			</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">particlesBuffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="p">[</span><span class="n">particlesBufferSize</span><span class="p">];</span>
<span class="linenos">2092</span><span class="w">			</span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5LTread_dataset</span><span class="p">(</span><span class="n">replicateHandles</span><span class="o">-&gt;</span><span class="n">group</span><span class="p">,</span><span class="w"> </span><span class="n">latticeDatasetName</span><span class="p">,</span><span class="w"> </span><span class="n">H5T_STD_U32LE</span><span class="p">,</span><span class="w"> </span><span class="n">particlesBuffer</span><span class="p">));</span>
<span class="linenos">2093</span><span class="w">			</span><span class="k">for</span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">particlesBufferSize</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">2094</span><span class="w">			</span><span class="p">{</span>
<span class="linenos">2095</span><span class="w">				</span><span class="k">const</span><span class="w"> </span><span class="n">particle_t</span><span class="w"> </span><span class="n">p</span><span class="o">=</span><span class="n">particlesBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="linenos">2096</span><span class="w">				</span><span class="k">if</span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">2097</span><span class="w">				</span><span class="p">{</span>
<span class="linenos">2098</span><span class="w">					</span><span class="k">if</span><span class="p">(</span><span class="n">particles</span><span class="p">.</span><span class="n">count</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">2099</span><span class="w">						</span><span class="n">particles</span><span class="p">[</span><span class="n">p</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
<span class="linenos">2100</span><span class="w">					</span><span class="k">else</span>
<span class="linenos">2101</span><span class="w">						</span><span class="n">particles</span><span class="p">[</span><span class="n">p</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
<span class="linenos">2102</span><span class="w">				</span><span class="p">}</span>
<span class="linenos">2103</span><span class="w">			</span><span class="p">}</span>
<span class="linenos">2104</span><span class="w">			</span><span class="k">delete</span><span class="w"> </span><span class="p">[]</span><span class="w"> </span><span class="n">particlesBuffer</span><span class="p">;</span>
<span class="linenos">2105</span><span class="w">			</span><span class="k">break</span><span class="p">;</span>
<span class="linenos">2106</span><span class="w">		</span><span class="p">}</span>
<span class="linenos">2107</span><span class="w">		</span><span class="k">default</span><span class="o">:</span>
<span class="linenos">2108</span><span class="w">			</span><span class="k">throw</span><span class="w"> </span><span class="n">Exception</span><span class="p">(</span><span class="s">&quot;Unsupported dataset size&quot;</span><span class="p">,</span><span class="n">size</span><span class="p">);</span>
<span class="linenos">2109</span><span class="w">	</span><span class="p">}</span>
<span class="linenos">2110</span>
<span class="linenos">2111</span><span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="n">particles</span><span class="p">;</span>
<span class="linenos">2112</span><span class="p">}</span>
<span class="linenos">2113</span>
<span class="linenos">2114</span><span class="kt">void</span><span class="w"> </span><span class="n">SimulationFile</span><span class="o">::</span><span class="n">closeReplicate</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">replicate</span><span class="p">)</span>
<span class="linenos">2115</span><span class="p">{</span>
<span class="linenos">2116</span><span class="w">    </span><span class="n">map</span><span class="o">&lt;</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="p">,</span><span class="n">ReplicateHandles</span><span class="w"> </span><span class="o">*&gt;::</span><span class="n">iterator</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">openReplicates</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">replicate</span><span class="p">);</span>
<span class="linenos">2117</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">it</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">openReplicates</span><span class="p">.</span><span class="n">end</span><span class="p">())</span>
<span class="linenos">2118</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">2119</span><span class="w">        </span><span class="n">ReplicateHandles</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">handles</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">it</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">;</span>
<span class="linenos">2120</span><span class="w">        </span><span class="n">closeReplicateHandles</span><span class="p">(</span><span class="n">handles</span><span class="p">);</span>
<span class="linenos">2121</span><span class="w">        </span><span class="k">delete</span><span class="w"> </span><span class="n">handles</span><span class="p">;</span>
<span class="linenos">2122</span><span class="w">        </span><span class="n">openReplicates</span><span class="p">.</span><span class="n">erase</span><span class="p">(</span><span class="n">it</span><span class="p">);</span>
<span class="linenos">2123</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">2124</span><span class="p">}</span>
<span class="linenos">2125</span>
<span class="linenos">2126</span><span class="kt">void</span><span class="w"> </span><span class="n">SimulationFile</span><span class="o">::</span><span class="n">closeAllReplicates</span><span class="p">()</span>
<span class="linenos">2127</span><span class="p">{</span>
<span class="linenos">2128</span><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">map</span><span class="o">&lt;</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="p">,</span><span class="n">ReplicateHandles</span><span class="w"> </span><span class="o">*&gt;::</span><span class="n">iterator</span><span class="w"> </span><span class="n">it</span><span class="o">=</span><span class="n">openReplicates</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">openReplicates</span><span class="p">.</span><span class="n">end</span><span class="p">();</span><span class="w"> </span><span class="n">it</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">2129</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">2130</span><span class="w">        </span><span class="n">ReplicateHandles</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">handles</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">it</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">;</span>
<span class="linenos">2131</span><span class="w">        </span><span class="n">closeReplicateHandles</span><span class="p">(</span><span class="n">handles</span><span class="p">);</span>
<span class="linenos">2132</span><span class="w">        </span><span class="k">delete</span><span class="w"> </span><span class="n">handles</span><span class="p">;</span>
<span class="linenos">2133</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">2134</span><span class="w">    </span><span class="n">openReplicates</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
<span class="linenos">2135</span><span class="p">}</span>
<span class="linenos">2136</span>
<span class="linenos">2137</span>
<span class="linenos">2138</span><span class="n">SimulationFile</span><span class="o">::</span><span class="n">ReplicateHandles</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">SimulationFile</span><span class="o">::</span><span class="n">openReplicateHandles</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">replicate</span><span class="p">)</span>
<span class="linenos">2139</span><span class="p">{</span>
<span class="linenos">2140</span><span class="w">    </span><span class="c1">// See if the replicate is already open.</span>
<span class="linenos">2141</span><span class="w">    </span><span class="n">map</span><span class="o">&lt;</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="p">,</span><span class="n">ReplicateHandles</span><span class="w"> </span><span class="o">*&gt;::</span><span class="n">iterator</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">openReplicates</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">replicate</span><span class="p">);</span>
<span class="linenos">2142</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">it</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">openReplicates</span><span class="p">.</span><span class="n">end</span><span class="p">())</span>
<span class="linenos">2143</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">2144</span><span class="w">        </span><span class="n">ReplicateHandles</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">handles</span><span class="p">;</span>
<span class="linenos">2145</span>
<span class="linenos">2146</span><span class="w">        </span><span class="c1">// Construct a string representation of the replicate name.</span>
<span class="linenos">2147</span><span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">stringstream</span><span class="w"> </span><span class="n">ss</span><span class="p">;</span>
<span class="linenos">2148</span><span class="w">        </span><span class="n">ss</span><span class="p">.</span><span class="n">fill</span><span class="p">(</span><span class="sc">&#39;0&#39;</span><span class="p">);</span>
<span class="linenos">2149</span><span class="w">        </span><span class="n">ss</span><span class="p">.</span><span class="n">width</span><span class="p">(</span><span class="mi">7</span><span class="p">);</span>
<span class="linenos">2150</span><span class="w">        </span><span class="n">ss</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">replicate</span><span class="p">;</span>
<span class="linenos">2151</span><span class="w">        </span><span class="n">string</span><span class="w"> </span><span class="n">replicateString</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ss</span><span class="p">.</span><span class="n">str</span><span class="p">();</span>
<span class="linenos">2152</span>
<span class="linenos">2153</span><span class="w">        </span><span class="c1">// Turn off exception handling again to work around odd behavior in hdf5 1.8.4.</span>
<span class="linenos">2154</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Eset_auto2</span><span class="p">(</span><span class="n">H5E_DEFAULT</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">));</span>
<span class="linenos">2155</span>
<span class="linenos">2156</span><span class="w">        </span><span class="c1">// Open the replicate group.</span>
<span class="linenos">2157</span><span class="w">        </span><span class="n">hid_t</span><span class="w"> </span><span class="n">groupHandle</span><span class="p">;</span>
<span class="linenos">2158</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">groupHandle</span><span class="o">=</span><span class="n">H5Gopen2</span><span class="p">(</span><span class="n">simulationsGroup</span><span class="p">,</span><span class="w"> </span><span class="n">replicateString</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">))</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">2159</span><span class="w">        </span><span class="p">{</span>
<span class="linenos">2160</span><span class="w">            </span><span class="c1">// Open the rest of the handles.</span>
<span class="linenos">2161</span><span class="w">            </span><span class="n">handles</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ReplicateHandles</span><span class="p">();</span>
<span class="linenos">2162</span><span class="w">            </span><span class="n">handles</span><span class="o">-&gt;</span><span class="n">group</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">groupHandle</span><span class="p">;</span>
<span class="linenos">2163</span><span class="w">            </span><span class="n">HDF5_EXCEPTION_CALL</span><span class="p">(</span><span class="n">handles</span><span class="o">-&gt;</span><span class="n">speciesCountsDataset</span><span class="p">,</span><span class="n">H5Dopen2</span><span class="p">(</span><span class="n">handles</span><span class="o">-&gt;</span><span class="n">group</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;SpeciesCounts&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">));</span>
<span class="linenos">2164</span><span class="w">            </span><span class="n">HDF5_EXCEPTION_CALL</span><span class="p">(</span><span class="n">handles</span><span class="o">-&gt;</span><span class="n">speciesCountTimesDataset</span><span class="p">,</span><span class="n">H5Dopen2</span><span class="p">(</span><span class="n">handles</span><span class="o">-&gt;</span><span class="n">group</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;SpeciesCountTimes&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">));</span>
<span class="linenos">2165</span><span class="w">        </span><span class="p">}</span>
<span class="linenos">2166</span><span class="w">        </span><span class="k">else</span>
<span class="linenos">2167</span><span class="w">        </span><span class="p">{</span>
<span class="linenos">2168</span><span class="w">            </span><span class="c1">// If we couldn&#39;t open it, try to create a new one.</span>
<span class="linenos">2169</span><span class="w">            </span><span class="n">handles</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">createReplicateHandles</span><span class="p">(</span><span class="n">replicateString</span><span class="p">);</span>
<span class="linenos">2170</span><span class="w">        </span><span class="p">}</span>
<span class="linenos">2171</span>
<span class="linenos">2172</span><span class="w">        </span><span class="c1">// Add it to the map.</span>
<span class="linenos">2173</span><span class="w">        </span><span class="n">openReplicates</span><span class="p">[</span><span class="n">replicate</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">handles</span><span class="p">;</span>
<span class="linenos">2174</span><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">handles</span><span class="p">;</span>
<span class="linenos">2175</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">2176</span><span class="w">    </span><span class="k">else</span>
<span class="linenos">2177</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">2178</span><span class="w">        </span><span class="c1">// Use the already open replicate.</span>
<span class="linenos">2179</span><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">it</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">;</span>
<span class="linenos">2180</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">2181</span>
<span class="linenos">2182</span><span class="p">}</span>
<span class="linenos">2183</span>
<span class="linenos">2184</span><span class="n">SimulationFile</span><span class="o">::</span><span class="n">ReplicateHandles</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">SimulationFile</span><span class="o">::</span><span class="n">createReplicateHandles</span><span class="p">(</span><span class="n">string</span><span class="w"> </span><span class="n">replicateString</span><span class="p">)</span>
<span class="linenos">2185</span><span class="p">{</span>
<span class="linenos">2186</span><span class="w">    </span><span class="c1">// Make sure the model is loaded, since need the number of species.</span>
<span class="linenos">2187</span><span class="w">    </span><span class="n">loadModel</span><span class="p">();</span>
<span class="linenos">2188</span>
<span class="linenos">2189</span><span class="w">    </span><span class="n">ReplicateHandles</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">handles</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ReplicateHandles</span><span class="p">();</span>
<span class="linenos">2190</span>
<span class="linenos">2191</span><span class="w">    </span><span class="c1">// Create the group.</span>
<span class="linenos">2192</span><span class="w">    </span><span class="n">HDF5_EXCEPTION_CALL</span><span class="p">(</span><span class="n">handles</span><span class="o">-&gt;</span><span class="n">group</span><span class="p">,</span><span class="n">H5Gcreate2</span><span class="p">(</span><span class="n">simulationsGroup</span><span class="p">,</span><span class="w"> </span><span class="n">replicateString</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">,</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">,</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">));</span>
<span class="linenos">2193</span>
<span class="linenos">2194</span><span class="w">    </span><span class="c1">// Create the species counts dataset</span>
<span class="linenos">2195</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">2196</span><span class="w">        </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">RANK</span><span class="o">=</span><span class="mi">2</span><span class="p">;</span>
<span class="linenos">2197</span><span class="w">        </span><span class="n">hsize_t</span><span class="w"> </span><span class="n">dims</span><span class="p">[</span><span class="n">RANK</span><span class="p">],</span><span class="w"> </span><span class="n">maxDims</span><span class="p">[</span><span class="n">RANK</span><span class="p">],</span><span class="w"> </span><span class="n">chunkDims</span><span class="p">[</span><span class="n">RANK</span><span class="p">];</span>
<span class="linenos">2198</span><span class="w">        </span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">2199</span><span class="w">        </span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">numberSpecies</span><span class="p">;</span>
<span class="linenos">2200</span><span class="w">        </span><span class="n">maxDims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">H5S_UNLIMITED</span><span class="p">;</span>
<span class="linenos">2201</span><span class="w">        </span><span class="n">maxDims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">numberSpecies</span><span class="p">;</span>
<span class="linenos">2202</span><span class="w">        </span><span class="n">chunkDims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">100</span><span class="p">;</span>
<span class="linenos">2203</span><span class="w">        </span><span class="n">chunkDims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">numberSpecies</span><span class="p">;</span>
<span class="linenos">2204</span><span class="w">        </span><span class="n">hid_t</span><span class="w"> </span><span class="n">dataspace_id</span><span class="p">,</span><span class="w"> </span><span class="n">dcpl_id</span><span class="p">;</span>
<span class="linenos">2205</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CALL</span><span class="p">(</span><span class="n">dataspace_id</span><span class="p">,</span><span class="n">H5Screate_simple</span><span class="p">(</span><span class="n">RANK</span><span class="p">,</span><span class="w"> </span><span class="n">dims</span><span class="p">,</span><span class="w"> </span><span class="n">maxDims</span><span class="p">));</span>
<span class="linenos">2206</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CALL</span><span class="p">(</span><span class="n">dcpl_id</span><span class="p">,</span><span class="n">H5Pcreate</span><span class="p">(</span><span class="n">H5P_DATASET_CREATE</span><span class="p">));</span>
<span class="linenos">2207</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Pset_chunk</span><span class="p">(</span><span class="n">dcpl_id</span><span class="p">,</span><span class="w"> </span><span class="n">RANK</span><span class="p">,</span><span class="w"> </span><span class="n">chunkDims</span><span class="p">));</span>
<span class="linenos">2208</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CALL</span><span class="p">(</span><span class="n">handles</span><span class="o">-&gt;</span><span class="n">speciesCountsDataset</span><span class="p">,</span><span class="n">H5Dcreate2</span><span class="p">(</span><span class="n">handles</span><span class="o">-&gt;</span><span class="n">group</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;SpeciesCounts&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">H5T_STD_I32LE</span><span class="p">,</span><span class="w"> </span><span class="n">dataspace_id</span><span class="p">,</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">,</span><span class="w"> </span><span class="n">dcpl_id</span><span class="p">,</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">));</span>
<span class="linenos">2209</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Pclose</span><span class="p">(</span><span class="n">dcpl_id</span><span class="p">));</span>
<span class="linenos">2210</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Sclose</span><span class="p">(</span><span class="n">dataspace_id</span><span class="p">));</span>
<span class="linenos">2211</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">2212</span>
<span class="linenos">2213</span><span class="w">    </span><span class="c1">// Create the species count times dataset</span>
<span class="linenos">2214</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">2215</span><span class="w">        </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">RANK</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
<span class="linenos">2216</span><span class="w">        </span><span class="n">hsize_t</span><span class="w"> </span><span class="n">dims</span><span class="p">[</span><span class="n">RANK</span><span class="p">],</span><span class="w"> </span><span class="n">maxDims</span><span class="p">[</span><span class="n">RANK</span><span class="p">],</span><span class="w"> </span><span class="n">chunkDims</span><span class="p">[</span><span class="n">RANK</span><span class="p">];</span>
<span class="linenos">2217</span><span class="w">        </span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">2218</span><span class="w">        </span><span class="n">maxDims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">H5S_UNLIMITED</span><span class="p">;</span>
<span class="linenos">2219</span><span class="w">        </span><span class="n">chunkDims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">100</span><span class="p">;</span>
<span class="linenos">2220</span><span class="w">        </span><span class="n">hid_t</span><span class="w"> </span><span class="n">dataspace_id</span><span class="p">,</span><span class="w"> </span><span class="n">dcpl_id</span><span class="p">;</span>
<span class="linenos">2221</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CALL</span><span class="p">(</span><span class="n">dataspace_id</span><span class="p">,</span><span class="n">H5Screate_simple</span><span class="p">(</span><span class="n">RANK</span><span class="p">,</span><span class="w"> </span><span class="n">dims</span><span class="p">,</span><span class="w"> </span><span class="n">maxDims</span><span class="p">));</span>
<span class="linenos">2222</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CALL</span><span class="p">(</span><span class="n">dcpl_id</span><span class="p">,</span><span class="n">H5Pcreate</span><span class="p">(</span><span class="n">H5P_DATASET_CREATE</span><span class="p">));</span>
<span class="linenos">2223</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Pset_chunk</span><span class="p">(</span><span class="n">dcpl_id</span><span class="p">,</span><span class="w"> </span><span class="n">RANK</span><span class="p">,</span><span class="w"> </span><span class="n">chunkDims</span><span class="p">));</span>
<span class="linenos">2224</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CALL</span><span class="p">(</span><span class="n">handles</span><span class="o">-&gt;</span><span class="n">speciesCountTimesDataset</span><span class="p">,</span><span class="n">H5Dcreate2</span><span class="p">(</span><span class="n">handles</span><span class="o">-&gt;</span><span class="n">group</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;SpeciesCountTimes&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">H5T_IEEE_F64LE</span><span class="p">,</span><span class="w"> </span><span class="n">dataspace_id</span><span class="p">,</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">,</span><span class="w"> </span><span class="n">dcpl_id</span><span class="p">,</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">));</span>
<span class="linenos">2225</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Pclose</span><span class="p">(</span><span class="n">dcpl_id</span><span class="p">));</span>
<span class="linenos">2226</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Sclose</span><span class="p">(</span><span class="n">dataspace_id</span><span class="p">));</span>
<span class="linenos">2227</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">2228</span>
<span class="linenos">2229</span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">handles</span><span class="p">;</span>
<span class="linenos">2230</span><span class="p">}</span>
<span class="linenos">2231</span>
<span class="linenos">2232</span><span class="kt">void</span><span class="w"> </span><span class="n">SimulationFile</span><span class="o">::</span><span class="n">closeReplicateHandles</span><span class="p">(</span><span class="n">ReplicateHandles</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">handles</span><span class="p">)</span>
<span class="linenos">2233</span><span class="p">{</span>
<span class="linenos">2234</span><span class="w">    </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Gclose</span><span class="p">(</span><span class="n">handles</span><span class="o">-&gt;</span><span class="n">group</span><span class="p">));</span>
<span class="linenos">2235</span><span class="w">    </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Dclose</span><span class="p">(</span><span class="n">handles</span><span class="o">-&gt;</span><span class="n">speciesCountsDataset</span><span class="p">));</span>
<span class="linenos">2236</span><span class="w">    </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Dclose</span><span class="p">(</span><span class="n">handles</span><span class="o">-&gt;</span><span class="n">speciesCountTimesDataset</span><span class="p">));</span>
<span class="linenos">2237</span><span class="w">    </span><span class="n">handles</span><span class="o">-&gt;</span><span class="n">group</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">H5I_INVALID_HID</span><span class="p">;</span>
<span class="linenos">2238</span><span class="w">    </span><span class="n">handles</span><span class="o">-&gt;</span><span class="n">speciesCountsDataset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">H5I_INVALID_HID</span><span class="p">;</span>
<span class="linenos">2239</span><span class="w">    </span><span class="n">handles</span><span class="o">-&gt;</span><span class="n">speciesCountTimesDataset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">H5I_INVALID_HID</span><span class="p">;</span>
<span class="linenos">2240</span><span class="p">}</span>
<span class="linenos">2241</span>
<span class="linenos">2242</span><span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">uint</span><span class="p">,</span><span class="w"> </span><span class="n">string</span><span class="o">&gt;</span><span class="w"> </span><span class="n">SimulationFile</span><span class="o">::</span><span class="n">getSpeciesNames</span><span class="p">()</span>
<span class="linenos">2243</span><span class="p">{</span>
<span class="linenos">2244</span><span class="w">	</span><span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">uint</span><span class="p">,</span><span class="w"> </span><span class="n">string</span><span class="o">&gt;</span><span class="w"> </span><span class="n">names</span><span class="p">;</span>
<span class="linenos">2245</span><span class="w">	</span><span class="n">string</span><span class="w"> </span><span class="n">namelist</span><span class="o">=</span><span class="n">getParameter</span><span class="p">(</span><span class="s">&quot;speciesNames&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">);</span>
<span class="linenos">2246</span><span class="w">	</span><span class="k">if</span><span class="p">(</span><span class="n">namelist</span><span class="p">.</span><span class="n">length</span><span class="p">()</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">2247</span><span class="w">		</span><span class="k">return</span><span class="w"> </span><span class="n">names</span><span class="p">;</span>
<span class="linenos">2248</span>
<span class="linenos">2249</span><span class="w">	</span><span class="kt">size_t</span><span class="w"> </span><span class="n">pos</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">nextpos</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">2250</span><span class="w">	</span><span class="n">uint</span><span class="w"> </span><span class="n">particle</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
<span class="linenos">2251</span><span class="w">	</span><span class="k">while</span><span class="p">((</span><span class="n">nextpos</span><span class="o">=</span><span class="n">namelist</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;,&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">pos</span><span class="p">))</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">string</span><span class="o">::</span><span class="n">npos</span><span class="p">)</span>
<span class="linenos">2252</span><span class="w">	</span><span class="p">{</span>
<span class="linenos">2253</span><span class="w">		</span><span class="n">names</span><span class="p">[</span><span class="n">particle</span><span class="p">]</span><span class="o">=</span><span class="n">namelist</span><span class="p">.</span><span class="n">substr</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span><span class="w"> </span><span class="n">nextpos</span><span class="o">-</span><span class="n">pos</span><span class="p">);</span><span class="w">	</span>
<span class="linenos">2254</span><span class="w">	</span><span class="c1">//	printf(&quot;name %d %s\n&quot;, particle, names[particle].c_str());</span>
<span class="linenos">2255</span><span class="w">		</span><span class="n">particle</span><span class="o">++</span><span class="p">;</span>
<span class="linenos">2256</span><span class="w">		</span><span class="n">pos</span><span class="o">=</span><span class="n">nextpos</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
<span class="linenos">2257</span><span class="w">	</span><span class="p">}</span>
<span class="linenos">2258</span>
<span class="linenos">2259</span><span class="w">	</span><span class="n">names</span><span class="p">[</span><span class="n">particle</span><span class="p">]</span><span class="o">=</span><span class="n">namelist</span><span class="p">.</span><span class="n">substr</span><span class="p">(</span><span class="n">pos</span><span class="p">);</span>
<span class="linenos">2260</span>
<span class="linenos">2261</span><span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="n">names</span><span class="p">;</span>
<span class="linenos">2262</span><span class="p">}</span>
<span class="linenos">2263</span>
<span class="linenos">2264</span><span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">uint</span><span class="p">,</span><span class="w"> </span><span class="n">string</span><span class="o">&gt;</span><span class="w"> </span><span class="n">SimulationFile</span><span class="o">::</span><span class="n">getSiteTypeNames</span><span class="p">()</span>
<span class="linenos">2265</span><span class="p">{</span>
<span class="linenos">2266</span><span class="w">	</span><span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">uint</span><span class="p">,</span><span class="w"> </span><span class="n">string</span><span class="o">&gt;</span><span class="w"> </span><span class="n">names</span><span class="p">;</span>
<span class="linenos">2267</span><span class="w">	</span><span class="n">string</span><span class="w"> </span><span class="n">namelist</span><span class="o">=</span><span class="n">getParameter</span><span class="p">(</span><span class="s">&quot;siteTypeNames&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">);</span>
<span class="linenos">2268</span><span class="w">	</span><span class="k">if</span><span class="p">(</span><span class="n">namelist</span><span class="p">.</span><span class="n">length</span><span class="p">()</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">2269</span><span class="w">		</span><span class="k">return</span><span class="w"> </span><span class="n">names</span><span class="p">;</span>
<span class="linenos">2270</span>
<span class="linenos">2271</span><span class="w">	</span><span class="kt">size_t</span><span class="w"> </span><span class="n">pos</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">nextpos</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">2272</span><span class="w">	</span><span class="n">uint</span><span class="w"> </span><span class="n">siteid</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">2273</span><span class="w">	</span><span class="k">while</span><span class="p">((</span><span class="n">nextpos</span><span class="o">=</span><span class="n">namelist</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;,&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">pos</span><span class="p">))</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">string</span><span class="o">::</span><span class="n">npos</span><span class="p">)</span>
<span class="linenos">2274</span><span class="w">	</span><span class="p">{</span>
<span class="linenos">2275</span><span class="w">		</span><span class="n">names</span><span class="p">[</span><span class="n">siteid</span><span class="p">]</span><span class="o">=</span><span class="n">namelist</span><span class="p">.</span><span class="n">substr</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span><span class="w"> </span><span class="n">nextpos</span><span class="o">-</span><span class="n">pos</span><span class="p">);</span><span class="w">	</span>
<span class="linenos">2276</span><span class="w">	</span><span class="c1">//	printf(&quot;name %d %s\n&quot;, particle, names[particle].c_str());</span>
<span class="linenos">2277</span><span class="w">		</span><span class="n">siteid</span><span class="o">++</span><span class="p">;</span>
<span class="linenos">2278</span><span class="w">		</span><span class="n">pos</span><span class="o">=</span><span class="n">nextpos</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
<span class="linenos">2279</span><span class="w">	</span><span class="p">}</span>
<span class="linenos">2280</span>
<span class="linenos">2281</span><span class="w">	</span><span class="n">names</span><span class="p">[</span><span class="n">siteid</span><span class="p">]</span><span class="o">=</span><span class="n">namelist</span><span class="p">.</span><span class="n">substr</span><span class="p">(</span><span class="n">pos</span><span class="p">);</span>
<span class="linenos">2282</span>
<span class="linenos">2283</span><span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="n">names</span><span class="p">;</span>
<span class="linenos">2284</span><span class="p">}</span>
<span class="linenos">2285</span>
<span class="linenos">2286</span><span class="kt">void</span>
<span class="linenos">2287</span><span class="n">SimulationFile</span><span class="o">::</span><span class="n">arbitraryH5</span><span class="p">(</span><span class="n">byte</span><span class="w"> </span><span class="o">*</span><span class="n">ptr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">2288</span><span class="w">    </span><span class="n">H5MetaData</span><span class="o">*</span><span class="w"> </span><span class="n">header</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">H5MetaData</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span>
<span class="linenos">2289</span><span class="w">    </span><span class="n">byte</span><span class="o">*</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ptr</span><span class="o">+</span><span class="k">sizeof</span><span class="p">(</span><span class="n">H5MetaData</span><span class="p">);</span>
<span class="linenos">2290</span><span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">2291</span><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="no">H5MetaData</span><span class="o">::</span><span class="no">APPEND_TO_GROUP</span><span class="p">:</span>
<span class="linenos">2292</span><span class="w">            </span><span class="n">appendDsToGroup</span><span class="p">(</span><span class="n">header</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">);</span>
<span class="linenos">2293</span><span class="w">            </span><span class="k">break</span><span class="p">;</span>
<span class="linenos">2294</span><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="no">H5MetaData</span><span class="o">::</span><span class="no">APPEND_TO_DATASET</span><span class="p">:</span>
<span class="linenos">2295</span><span class="w">            </span><span class="n">appendToDataset</span><span class="p">(</span><span class="n">header</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">);</span>
<span class="linenos">2296</span><span class="w">            </span><span class="k">break</span><span class="p">;</span>
<span class="linenos">2297</span><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="no">H5MetaData</span><span class="o">::</span><span class="no">NEW_DATASET</span><span class="p">:</span>
<span class="linenos">2298</span><span class="w">            </span><span class="n">makeNewDataset</span><span class="p">(</span><span class="n">header</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">);</span>
<span class="linenos">2299</span><span class="w">            </span><span class="k">break</span><span class="p">;</span>
<span class="linenos">2300</span><span class="w">        </span><span class="k">default</span><span class="o">:</span>
<span class="linenos">2301</span><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="n">InvalidArgException</span><span class="p">(</span><span class="s">&quot;H5MetaData::mode&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Write mode invalid&quot;</span><span class="p">);</span>
<span class="linenos">2302</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">2303</span><span class="p">}</span>
<span class="linenos">2304</span>
<span class="linenos">2305</span>
<span class="linenos">2306</span><span class="kt">void</span>
<span class="linenos">2307</span><span class="n">SimulationFile</span><span class="o">::</span><span class="n">appendToDataset</span><span class="p">(</span><span class="n">H5MetaData</span><span class="w"> </span><span class="o">*</span><span class="n">header</span><span class="p">,</span><span class="w"> </span><span class="n">byte</span><span class="w"> </span><span class="o">*</span><span class="n">data</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">2308</span><span class="w">    </span><span class="n">hid_t</span><span class="w"> </span><span class="n">replicateHandle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">openReplicateHandles</span><span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">replicate</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">group</span><span class="p">;</span>
<span class="linenos">2309</span>
<span class="linenos">2310</span><span class="w">    </span><span class="n">hsize_t</span><span class="w"> </span><span class="n">dims</span><span class="p">[</span><span class="n">H5S_MAX_RANK</span><span class="p">],</span><span class="w"> </span><span class="n">chunk</span><span class="p">[</span><span class="n">H5S_MAX_RANK</span><span class="p">],</span><span class="w"> </span><span class="n">maxDims</span><span class="p">[</span><span class="n">H5S_MAX_RANK</span><span class="p">];</span>
<span class="linenos">2311</span><span class="w">    </span><span class="n">hsize_t</span><span class="w"> </span><span class="n">memDims</span><span class="p">[</span><span class="n">H5S_MAX_RANK</span><span class="p">],</span><span class="w"> </span><span class="n">start</span><span class="p">[</span><span class="n">H5S_MAX_RANK</span><span class="p">],</span><span class="w"> </span><span class="n">count</span><span class="p">[</span><span class="n">H5S_MAX_RANK</span><span class="p">];</span>
<span class="linenos">2312</span><span class="w">    </span><span class="n">hid_t</span><span class="w"> </span><span class="n">datasetHandle</span><span class="p">;</span>
<span class="linenos">2313</span><span class="w">    </span><span class="n">hid_t</span><span class="w"> </span><span class="n">dataspaceHandle</span><span class="p">;</span>
<span class="linenos">2314</span>
<span class="linenos">2315</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">H5Lexists</span><span class="p">(</span><span class="n">replicateHandle</span><span class="p">,</span><span class="w"> </span><span class="n">header</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">2316</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CALL</span><span class="p">(</span><span class="n">datasetHandle</span><span class="p">,</span><span class="w"> </span><span class="n">H5Dopen2</span><span class="p">(</span><span class="n">replicateHandle</span><span class="p">,</span><span class="w">  </span><span class="n">header</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">));</span>
<span class="linenos">2317</span><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">2318</span><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">header</span><span class="o">-&gt;</span><span class="n">ndim</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">2319</span><span class="w">            </span><span class="n">dims</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">header</span><span class="o">-&gt;</span><span class="n">shape</span><span class="p">[</span><span class="n">i</span><span class="mi">-1</span><span class="p">];</span>
<span class="linenos">2320</span><span class="w">            </span><span class="n">chunk</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">min</span><span class="p">((</span><span class="kt">size_t</span><span class="p">)</span><span class="n">TUNE_LATTICE_GZIP_CHUNK_SIZE</span><span class="p">,</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">shape</span><span class="p">[</span><span class="n">i</span><span class="mi">-1</span><span class="p">]);</span>
<span class="linenos">2321</span><span class="w">            </span><span class="n">maxDims</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">header</span><span class="o">-&gt;</span><span class="n">shape</span><span class="p">[</span><span class="n">i</span><span class="mi">-1</span><span class="p">];</span>
<span class="linenos">2322</span><span class="w">        </span><span class="p">}</span>
<span class="linenos">2323</span>
<span class="linenos">2324</span><span class="w">        </span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">2325</span><span class="w">        </span><span class="n">maxDims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">H5S_UNLIMITED</span><span class="p">;</span>
<span class="linenos">2326</span><span class="w">        </span><span class="n">chunk</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">100</span><span class="p">;</span>
<span class="linenos">2327</span>
<span class="linenos">2328</span><span class="w">        </span><span class="n">hid_t</span><span class="w"> </span><span class="n">propsHandle</span><span class="p">;</span>
<span class="linenos">2329</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CALL</span><span class="p">(</span><span class="n">dataspaceHandle</span><span class="p">,</span><span class="n">H5Screate_simple</span><span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">ndim</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">dims</span><span class="p">,</span><span class="w"> </span><span class="n">maxDims</span><span class="p">));</span>
<span class="linenos">2330</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CALL</span><span class="p">(</span><span class="n">propsHandle</span><span class="p">,</span><span class="n">H5Pcreate</span><span class="p">(</span><span class="n">H5P_DATASET_CREATE</span><span class="p">));</span>
<span class="linenos">2331</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Pset_chunk</span><span class="p">(</span><span class="n">propsHandle</span><span class="p">,</span><span class="w"> </span><span class="n">header</span><span class="o">-&gt;</span><span class="n">ndim</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">chunk</span><span class="p">));</span>
<span class="linenos">2332</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CALL</span><span class="p">(</span><span class="n">datasetHandle</span><span class="p">,</span><span class="w"> </span><span class="n">H5Dcreate2</span><span class="p">(</span><span class="n">replicateHandle</span><span class="p">,</span><span class="w"> </span><span class="n">header</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">header</span><span class="o">-&gt;</span><span class="n">h5type</span><span class="p">,</span><span class="w"> </span><span class="n">dataspaceHandle</span><span class="p">,</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">,</span><span class="w"> </span><span class="n">propsHandle</span><span class="p">,</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">));</span>
<span class="linenos">2333</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Pclose</span><span class="p">(</span><span class="n">propsHandle</span><span class="p">));</span>
<span class="linenos">2334</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Sclose</span><span class="p">(</span><span class="n">dataspaceHandle</span><span class="p">));</span>
<span class="linenos">2335</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">2336</span>
<span class="linenos">2337</span><span class="w">    </span><span class="n">HDF5_EXCEPTION_CALL</span><span class="p">(</span><span class="n">dataspaceHandle</span><span class="p">,</span><span class="w"> </span><span class="n">H5Dget_space</span><span class="p">(</span><span class="n">datasetHandle</span><span class="p">));</span>
<span class="linenos">2338</span><span class="w">    </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Sget_simple_extent_dims</span><span class="p">(</span><span class="n">dataspaceHandle</span><span class="p">,</span><span class="w"> </span><span class="n">dims</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">));</span>
<span class="linenos">2339</span><span class="w">    </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Sclose</span><span class="p">(</span><span class="n">dataspaceHandle</span><span class="p">));</span>
<span class="linenos">2340</span>
<span class="linenos">2341</span><span class="w">    </span><span class="c1">// Extend the dataset by the number of rows in the data set.</span>
<span class="linenos">2342</span><span class="w">    </span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="linenos">2343</span><span class="w">    </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Dset_extent</span><span class="p">(</span><span class="n">datasetHandle</span><span class="p">,</span><span class="w"> </span><span class="n">dims</span><span class="p">));</span>
<span class="linenos">2344</span>
<span class="linenos">2345</span><span class="w">    </span><span class="c1">// Create the memory dataset.</span>
<span class="linenos">2346</span><span class="w">    </span><span class="n">hid_t</span><span class="w"> </span><span class="n">memspaceHandle</span><span class="p">;</span>
<span class="linenos">2347</span><span class="w">    </span><span class="n">memcpy</span><span class="p">(</span><span class="n">memDims</span><span class="p">,</span><span class="w"> </span><span class="n">dims</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">dims</span><span class="p">));</span>
<span class="linenos">2348</span><span class="w">    </span><span class="n">memDims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="linenos">2349</span><span class="w">    </span><span class="n">HDF5_EXCEPTION_CALL</span><span class="p">(</span><span class="n">memspaceHandle</span><span class="p">,</span><span class="w"> </span><span class="n">H5Screate_simple</span><span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">ndim</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">memDims</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">));</span>
<span class="linenos">2350</span>
<span class="linenos">2351</span><span class="w">    </span><span class="c1">// Write the new data.</span>
<span class="linenos">2352</span><span class="w">    </span><span class="n">HDF5_EXCEPTION_CALL</span><span class="p">(</span><span class="n">dataspaceHandle</span><span class="p">,</span><span class="w"> </span><span class="n">H5Dget_space</span><span class="p">(</span><span class="n">datasetHandle</span><span class="p">));</span>
<span class="linenos">2353</span>
<span class="linenos">2354</span><span class="w">    </span><span class="n">memset</span><span class="p">(</span><span class="n">start</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">start</span><span class="p">));</span>
<span class="linenos">2355</span><span class="w">    </span><span class="n">start</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="mi">-1</span><span class="p">;</span>
<span class="linenos">2356</span><span class="w">    </span><span class="n">memcpy</span><span class="p">(</span><span class="n">count</span><span class="p">,</span><span class="w"> </span><span class="n">memDims</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">memDims</span><span class="p">));</span>
<span class="linenos">2357</span>
<span class="linenos">2358</span><span class="w">    </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Sselect_hyperslab</span><span class="p">(</span><span class="n">dataspaceHandle</span><span class="p">,</span><span class="w"> </span><span class="n">H5S_SELECT_SET</span><span class="p">,</span><span class="w"> </span><span class="n">start</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">count</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">));</span>
<span class="linenos">2359</span><span class="w">    </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Dwrite</span><span class="p">(</span><span class="n">datasetHandle</span><span class="p">,</span><span class="w"> </span><span class="n">header</span><span class="o">-&gt;</span><span class="n">h5type</span><span class="p">,</span><span class="w"> </span><span class="n">memspaceHandle</span><span class="p">,</span><span class="w"> </span><span class="n">dataspaceHandle</span><span class="p">,</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">));</span>
<span class="linenos">2360</span>
<span class="linenos">2361</span><span class="w">    </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Sclose</span><span class="p">(</span><span class="n">dataspaceHandle</span><span class="p">));</span>
<span class="linenos">2362</span><span class="w">    </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Sclose</span><span class="p">(</span><span class="n">memspaceHandle</span><span class="p">));</span>
<span class="linenos">2363</span><span class="w">    </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Dclose</span><span class="p">(</span><span class="n">datasetHandle</span><span class="p">));</span>
<span class="linenos">2364</span><span class="p">}</span>
<span class="linenos">2365</span>
<span class="linenos">2366</span>
<span class="linenos">2367</span><span class="kt">void</span>
<span class="linenos">2368</span><span class="n">SimulationFile</span><span class="o">::</span><span class="n">makeNewDataset</span><span class="p">(</span><span class="n">H5MetaData</span><span class="w"> </span><span class="o">*</span><span class="n">header</span><span class="p">,</span><span class="w"> </span><span class="n">byte</span><span class="w"> </span><span class="o">*</span><span class="n">data</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">2369</span><span class="w">    </span><span class="n">hid_t</span><span class="w"> </span><span class="n">replicateHandle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">openReplicateHandles</span><span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">replicate</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">group</span><span class="p">;</span>
<span class="linenos">2370</span>
<span class="linenos">2371</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">H5Lexists</span><span class="p">(</span><span class="n">replicateHandle</span><span class="p">,</span><span class="w"> </span><span class="n">header</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">2372</span><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="n">Exception</span><span class="p">(</span><span class="s">&quot;Dataset already exists&quot;</span><span class="p">);</span>
<span class="linenos">2373</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">2374</span>
<span class="linenos">2375</span><span class="w">    </span><span class="n">hsize_t</span><span class="w"> </span><span class="n">dims</span><span class="p">[</span><span class="n">H5S_MAX_RANK</span><span class="p">],</span><span class="w"> </span><span class="n">chunk</span><span class="p">[</span><span class="n">H5S_MAX_RANK</span><span class="p">];</span>
<span class="linenos">2376</span>
<span class="linenos">2377</span><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">header</span><span class="o">-&gt;</span><span class="n">ndim</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">2378</span><span class="w">        </span><span class="n">dims</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">header</span><span class="o">-&gt;</span><span class="n">shape</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="linenos">2379</span><span class="w">        </span><span class="n">chunk</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">min</span><span class="p">((</span><span class="kt">size_t</span><span class="p">)</span><span class="n">TUNE_LATTICE_GZIP_CHUNK_SIZE</span><span class="p">,</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">shape</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="linenos">2380</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">2381</span>
<span class="linenos">2382</span><span class="w">    </span><span class="n">hid_t</span><span class="w"> </span><span class="n">dataspaceHandle</span><span class="p">,</span><span class="w"> </span><span class="n">dcplHandle</span><span class="p">,</span><span class="w"> </span><span class="n">datasetHandle</span><span class="p">;</span>
<span class="linenos">2383</span><span class="w">    </span><span class="n">HDF5_EXCEPTION_CALL</span><span class="p">(</span><span class="n">dataspaceHandle</span><span class="p">,</span><span class="w"> </span><span class="n">H5Screate_simple</span><span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">ndim</span><span class="p">,</span><span class="w"> </span><span class="n">dims</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">));</span>
<span class="linenos">2384</span><span class="w">    </span><span class="n">HDF5_EXCEPTION_CALL</span><span class="p">(</span><span class="n">dcplHandle</span><span class="p">,</span><span class="w"> </span><span class="n">H5Pcreate</span><span class="p">(</span><span class="n">H5P_DATASET_CREATE</span><span class="p">));</span>
<span class="linenos">2385</span><span class="w">    </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Pset_deflate</span><span class="p">(</span><span class="n">dcplHandle</span><span class="p">,</span><span class="w"> </span><span class="n">TUNE_LATTICE_GZIP_COMPRESSION_LEVEL</span><span class="p">));</span>
<span class="linenos">2386</span><span class="w">    </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Pset_chunk</span><span class="p">(</span><span class="n">dcplHandle</span><span class="p">,</span><span class="w"> </span><span class="n">header</span><span class="o">-&gt;</span><span class="n">ndim</span><span class="p">,</span><span class="w"> </span><span class="n">chunk</span><span class="p">));</span>
<span class="linenos">2387</span><span class="w">    </span><span class="n">HDF5_EXCEPTION_CALL</span><span class="p">(</span><span class="n">datasetHandle</span><span class="p">,</span><span class="w"> </span><span class="n">H5Dcreate2</span><span class="p">(</span><span class="n">replicateHandle</span><span class="p">,</span><span class="w"> </span><span class="n">header</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">header</span><span class="o">-&gt;</span><span class="n">h5type</span><span class="p">,</span><span class="w"> </span><span class="n">dataspaceHandle</span><span class="p">,</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">,</span><span class="w"> </span><span class="n">dcplHandle</span><span class="p">,</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">));</span>
<span class="linenos">2388</span><span class="w">    </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Dwrite</span><span class="p">(</span><span class="n">datasetHandle</span><span class="p">,</span><span class="w"> </span><span class="n">header</span><span class="o">-&gt;</span><span class="n">h5type</span><span class="p">,</span><span class="w"> </span><span class="n">H5S_ALL</span><span class="p">,</span><span class="w"> </span><span class="n">H5S_ALL</span><span class="p">,</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">));</span>
<span class="linenos">2389</span>
<span class="linenos">2390</span><span class="w">    </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Dclose</span><span class="p">(</span><span class="n">datasetHandle</span><span class="p">));</span>
<span class="linenos">2391</span><span class="w">    </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Pclose</span><span class="p">(</span><span class="n">dcplHandle</span><span class="p">));</span>
<span class="linenos">2392</span><span class="w">    </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Sclose</span><span class="p">(</span><span class="n">dataspaceHandle</span><span class="p">));</span>
<span class="linenos">2393</span><span class="p">}</span>
<span class="linenos">2394</span>
<span class="linenos">2395</span><span class="kt">void</span>
<span class="linenos">2396</span><span class="n">SimulationFile</span><span class="o">::</span><span class="n">appendDsToGroup</span><span class="p">(</span><span class="n">H5MetaData</span><span class="w"> </span><span class="o">*</span><span class="n">header</span><span class="p">,</span><span class="w"> </span><span class="n">byte</span><span class="w"> </span><span class="o">*</span><span class="n">data</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">2397</span><span class="w">    </span><span class="n">hid_t</span><span class="w"> </span><span class="n">replicateHandle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">openReplicateHandles</span><span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">replicate</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">group</span><span class="p">;</span>
<span class="linenos">2398</span>
<span class="linenos">2399</span><span class="w">    </span><span class="n">hid_t</span><span class="w"> </span><span class="n">groupHandle</span><span class="p">;</span>
<span class="linenos">2400</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">H5Lexists</span><span class="p">(</span><span class="n">replicateHandle</span><span class="p">,</span><span class="w"> </span><span class="n">header</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">2401</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CALL</span><span class="p">(</span><span class="n">groupHandle</span><span class="p">,</span><span class="w"> </span><span class="n">H5Gopen2</span><span class="p">(</span><span class="n">replicateHandle</span><span class="p">,</span><span class="w"> </span><span class="n">header</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">));</span>
<span class="linenos">2402</span><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">2403</span><span class="w">        </span><span class="n">HDF5_EXCEPTION_CALL</span><span class="p">(</span><span class="n">groupHandle</span><span class="p">,</span><span class="n">H5Gcreate2</span><span class="p">(</span><span class="n">replicateHandle</span><span class="p">,</span><span class="w"> </span><span class="n">header</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">,</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">,</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">));</span>
<span class="linenos">2404</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">2405</span>
<span class="linenos">2406</span><span class="w">    </span><span class="n">hsize_t</span><span class="w"> </span><span class="n">nds</span><span class="p">;</span>
<span class="linenos">2407</span><span class="w">    </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Gget_num_objs</span><span class="p">(</span><span class="n">groupHandle</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">nds</span><span class="p">));</span>
<span class="linenos">2408</span>
<span class="linenos">2409</span><span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">dsName</span><span class="p">[</span><span class="mi">11</span><span class="p">];</span>
<span class="linenos">2410</span><span class="w">    </span><span class="n">snprintf</span><span class="p">(</span><span class="n">dsName</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">dsName</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;%010zd&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">nds</span><span class="p">);</span>
<span class="linenos">2411</span>
<span class="linenos">2412</span><span class="w">    </span><span class="n">hsize_t</span><span class="w"> </span><span class="n">dims</span><span class="p">[</span><span class="n">H5S_MAX_RANK</span><span class="p">],</span><span class="w"> </span><span class="n">chunk</span><span class="p">[</span><span class="n">H5S_MAX_RANK</span><span class="p">];</span>
<span class="linenos">2413</span>
<span class="linenos">2414</span><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">header</span><span class="o">-&gt;</span><span class="n">ndim</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">2415</span><span class="w">        </span><span class="n">dims</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">header</span><span class="o">-&gt;</span><span class="n">shape</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="linenos">2416</span><span class="w">        </span><span class="n">chunk</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">min</span><span class="p">((</span><span class="kt">size_t</span><span class="p">)</span><span class="n">TUNE_LATTICE_GZIP_CHUNK_SIZE</span><span class="p">,</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">shape</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="linenos">2417</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">2418</span>
<span class="linenos">2419</span><span class="w">    </span><span class="n">hid_t</span><span class="w"> </span><span class="n">dataspaceHandle</span><span class="p">,</span><span class="w"> </span><span class="n">dcplHandle</span><span class="p">,</span><span class="w"> </span><span class="n">datasetHandle</span><span class="p">;</span>
<span class="linenos">2420</span><span class="w">    </span><span class="n">HDF5_EXCEPTION_CALL</span><span class="p">(</span><span class="n">dataspaceHandle</span><span class="p">,</span><span class="n">H5Screate_simple</span><span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">ndim</span><span class="p">,</span><span class="w"> </span><span class="n">dims</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">));</span>
<span class="linenos">2421</span><span class="w">    </span><span class="n">HDF5_EXCEPTION_CALL</span><span class="p">(</span><span class="n">dcplHandle</span><span class="p">,</span><span class="n">H5Pcreate</span><span class="p">(</span><span class="n">H5P_DATASET_CREATE</span><span class="p">));</span>
<span class="linenos">2422</span><span class="w">    </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Pset_deflate</span><span class="w"> </span><span class="p">(</span><span class="n">dcplHandle</span><span class="p">,</span><span class="w"> </span><span class="n">TUNE_LATTICE_GZIP_COMPRESSION_LEVEL</span><span class="p">));</span>
<span class="linenos">2423</span><span class="w">    </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Pset_chunk</span><span class="p">(</span><span class="n">dcplHandle</span><span class="p">,</span><span class="w"> </span><span class="n">header</span><span class="o">-&gt;</span><span class="n">ndim</span><span class="p">,</span><span class="w"> </span><span class="n">chunk</span><span class="p">));</span>
<span class="linenos">2424</span><span class="w">    </span><span class="n">HDF5_EXCEPTION_CALL</span><span class="p">(</span><span class="n">datasetHandle</span><span class="p">,</span><span class="n">H5Dcreate2</span><span class="p">(</span><span class="n">groupHandle</span><span class="p">,</span><span class="w"> </span><span class="n">dsName</span><span class="p">,</span><span class="w"> </span><span class="n">header</span><span class="o">-&gt;</span><span class="n">h5type</span><span class="p">,</span><span class="w"> </span><span class="n">dataspaceHandle</span><span class="p">,</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">,</span><span class="w"> </span><span class="n">dcplHandle</span><span class="p">,</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">));</span>
<span class="linenos">2425</span><span class="w">    </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Dwrite</span><span class="p">(</span><span class="n">datasetHandle</span><span class="p">,</span><span class="w"> </span><span class="n">header</span><span class="o">-&gt;</span><span class="n">h5type</span><span class="p">,</span><span class="w"> </span><span class="n">H5S_ALL</span><span class="p">,</span><span class="w"> </span><span class="n">H5S_ALL</span><span class="p">,</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">));</span>
<span class="linenos">2426</span>
<span class="linenos">2427</span><span class="w">    </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Dclose</span><span class="p">(</span><span class="n">datasetHandle</span><span class="p">));</span>
<span class="linenos">2428</span><span class="w">    </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Pclose</span><span class="p">(</span><span class="n">dcplHandle</span><span class="p">));</span>
<span class="linenos">2429</span><span class="w">    </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Sclose</span><span class="p">(</span><span class="n">dataspaceHandle</span><span class="p">));</span>
<span class="linenos">2430</span><span class="w">    </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Gclose</span><span class="p">(</span><span class="n">groupHandle</span><span class="p">));</span>
<span class="linenos">2431</span><span class="p">}</span>
<span class="linenos">2432</span>
<span class="linenos">2433</span><span class="kt">void</span>
<span class="linenos">2434</span><span class="n">SimulationFile</span><span class="o">::</span><span class="n">arbitraryH5Lookup</span><span class="p">(</span><span class="n">byte</span><span class="w"> </span><span class="o">*</span><span class="n">req</span><span class="p">,</span><span class="w"> </span><span class="n">byte</span><span class="w"> </span><span class="o">*&amp;</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="o">&amp;</span><span class="n">sz</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">2435</span><span class="w">    </span><span class="n">H5Lookup</span><span class="o">*</span><span class="w"> </span><span class="n">header</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">H5Lookup</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
<span class="linenos">2436</span><span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">2437</span><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="no">H5Lookup</span><span class="o">::</span><span class="no">DATASET</span><span class="p">:</span>
<span class="linenos">2438</span><span class="w">            </span><span class="n">readDataset</span><span class="p">(</span><span class="n">header</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">sz</span><span class="p">);</span>
<span class="linenos">2439</span><span class="w">            </span><span class="k">break</span><span class="p">;</span>
<span class="linenos">2440</span><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="no">H5Lookup</span><span class="o">::</span><span class="no">ATTR</span><span class="p">:</span>
<span class="linenos">2441</span><span class="w">            </span><span class="n">readAttr</span><span class="p">(</span><span class="n">header</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">sz</span><span class="p">);</span>
<span class="linenos">2442</span><span class="w">            </span><span class="k">break</span><span class="p">;</span>
<span class="linenos">2443</span><span class="w">        </span><span class="k">default</span><span class="o">:</span>
<span class="linenos">2444</span><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="n">InvalidArgException</span><span class="p">(</span><span class="s">&quot;H5Lookup::mode&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;H5 data mode invalid&quot;</span><span class="p">);</span>
<span class="linenos">2445</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">2446</span><span class="p">}</span>
<span class="linenos">2447</span>
<span class="linenos">2448</span><span class="kt">void</span><span class="w"> </span>
<span class="linenos">2449</span><span class="n">SimulationFile</span><span class="o">::</span><span class="n">readAttr</span><span class="p">(</span><span class="n">H5Lookup</span><span class="w"> </span><span class="o">*</span><span class="n">req</span><span class="p">,</span><span class="w"> </span><span class="n">byte</span><span class="w"> </span><span class="o">*&amp;</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="o">&amp;</span><span class="n">sz</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">2450</span><span class="w">    </span><span class="n">H5MetaData</span><span class="w"> </span><span class="n">md</span><span class="p">;</span>
<span class="linenos">2451</span><span class="w">    </span><span class="n">md</span><span class="p">.</span><span class="n">replicate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">req</span><span class="o">-&gt;</span><span class="n">replicate</span><span class="p">;</span>
<span class="linenos">2452</span><span class="w">    </span><span class="n">hsize_t</span><span class="w"> </span><span class="n">dims</span><span class="p">[</span><span class="n">H5S_MAX_RANK</span><span class="p">];</span>
<span class="linenos">2453</span><span class="w">    </span><span class="n">hsize_t</span><span class="w"> </span><span class="n">elemSz</span><span class="p">;</span>
<span class="linenos">2454</span>
<span class="linenos">2455</span><span class="w">    </span><span class="n">hid_t</span><span class="w"> </span><span class="n">attrHandle</span><span class="p">,</span><span class="w"> </span><span class="n">typeHandle</span><span class="p">,</span><span class="w"> </span><span class="n">dataspaceHandle</span><span class="p">;</span>
<span class="linenos">2456</span><span class="w">    </span><span class="n">HDF5_EXCEPTION_CALL</span><span class="p">(</span><span class="n">attrHandle</span><span class="p">,</span><span class="w"> </span><span class="n">H5Aopen_by_name</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="n">req</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">,</span><span class="w"> </span><span class="n">req</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">,</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">,</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">));</span>
<span class="linenos">2457</span><span class="w">    </span><span class="n">HDF5_EXCEPTION_CALL</span><span class="p">(</span><span class="n">dataspaceHandle</span><span class="p">,</span><span class="w"> </span><span class="n">H5Aget_space</span><span class="p">(</span><span class="n">attrHandle</span><span class="p">));</span>
<span class="linenos">2458</span><span class="w">    </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Sget_simple_extent_dims</span><span class="p">(</span><span class="n">dataspaceHandle</span><span class="p">,</span><span class="w"> </span><span class="n">dims</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">));</span>
<span class="linenos">2459</span><span class="w">    </span><span class="n">HDF5_EXCEPTION_CALL</span><span class="p">(</span><span class="n">md</span><span class="p">.</span><span class="n">ndim</span><span class="p">,</span><span class="w"> </span><span class="n">H5Sget_simple_extent_ndims</span><span class="p">(</span><span class="n">dataspaceHandle</span><span class="p">));</span>
<span class="linenos">2460</span><span class="w">    </span><span class="n">HDF5_EXCEPTION_CALL</span><span class="p">(</span><span class="n">typeHandle</span><span class="p">,</span><span class="w"> </span><span class="n">H5Aget_type</span><span class="p">(</span><span class="n">attrHandle</span><span class="p">));</span>
<span class="linenos">2461</span><span class="w">    </span><span class="n">HDF5_EXCEPTION_CALL</span><span class="p">(</span><span class="n">md</span><span class="p">.</span><span class="n">h5type</span><span class="p">,</span><span class="w"> </span><span class="n">H5Tget_native_type</span><span class="p">(</span><span class="n">typeHandle</span><span class="p">,</span><span class="w"> </span><span class="n">H5T_DIR_ASCEND</span><span class="p">));</span>
<span class="linenos">2462</span><span class="w">    </span><span class="n">HDF5_EXCEPTION_CALL</span><span class="p">(</span><span class="n">elemSz</span><span class="p">,</span><span class="w"> </span><span class="n">H5Tget_size</span><span class="p">(</span><span class="n">md</span><span class="p">.</span><span class="n">h5type</span><span class="p">));</span>
<span class="linenos">2463</span>
<span class="linenos">2464</span><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">md</span><span class="p">.</span><span class="n">ndim</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">2465</span><span class="w">        </span><span class="n">md</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dims</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="linenos">2466</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">2467</span>
<span class="linenos">2468</span><span class="w">    </span><span class="n">md</span><span class="p">.</span><span class="n">payloadSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">elemSz</span><span class="o">*</span><span class="n">std</span><span class="o">::</span><span class="n">accumulate</span><span class="p">(</span><span class="n">md</span><span class="p">.</span><span class="n">shape</span><span class="p">,</span><span class="w"> </span><span class="n">md</span><span class="p">.</span><span class="n">shape</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">md</span><span class="p">.</span><span class="n">ndim</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">multiplies</span><span class="o">&lt;</span><span class="kt">size_t</span><span class="o">&gt;</span><span class="p">());</span>
<span class="linenos">2469</span>
<span class="linenos">2470</span><span class="w">    </span><span class="n">sz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">md</span><span class="p">)</span><span class="o">+</span><span class="n">md</span><span class="p">.</span><span class="n">payloadSize</span><span class="p">;</span>
<span class="linenos">2471</span><span class="w">    </span><span class="n">buf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="p">[</span><span class="n">sz</span><span class="p">];</span>
<span class="linenos">2472</span><span class="w">    </span><span class="n">H5MetaData</span><span class="w"> </span><span class="o">*</span><span class="n">hdr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">H5MetaData</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
<span class="linenos">2473</span><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">payload</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">buf</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">md</span><span class="p">);</span>
<span class="linenos">2474</span><span class="w">    </span><span class="o">*</span><span class="n">hdr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">md</span><span class="p">;</span>
<span class="linenos">2475</span>
<span class="linenos">2476</span><span class="w">    </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Aread</span><span class="p">(</span><span class="n">attrHandle</span><span class="p">,</span><span class="w"> </span><span class="n">md</span><span class="p">.</span><span class="n">h5type</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">payload</span><span class="p">));</span>
<span class="linenos">2477</span>
<span class="linenos">2478</span><span class="w">    </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Tclose</span><span class="p">(</span><span class="n">typeHandle</span><span class="p">));</span>
<span class="linenos">2479</span><span class="w">    </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Sclose</span><span class="p">(</span><span class="n">dataspaceHandle</span><span class="p">));</span>
<span class="linenos">2480</span><span class="w">    </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Aclose</span><span class="p">(</span><span class="n">attrHandle</span><span class="p">));</span>
<span class="linenos">2481</span>
<span class="linenos">2482</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">H5Tequal</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">h5type</span><span class="p">,</span><span class="w"> </span><span class="n">md</span><span class="p">.</span><span class="n">h5type</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">2483</span><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="n">Exception</span><span class="p">(</span><span class="s">&quot;Requested and HDF5 data types do not match&quot;</span><span class="p">);</span>
<span class="linenos">2484</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">2485</span><span class="p">}</span>
<span class="linenos">2486</span>
<span class="linenos">2487</span>
<span class="linenos">2488</span><span class="kt">void</span>
<span class="linenos">2489</span><span class="n">SimulationFile</span><span class="o">::</span><span class="n">readDataset</span><span class="p">(</span><span class="n">H5Lookup</span><span class="w"> </span><span class="o">*</span><span class="n">req</span><span class="p">,</span><span class="w"> </span><span class="n">byte</span><span class="w"> </span><span class="o">*&amp;</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="o">&amp;</span><span class="n">sz</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">2490</span><span class="w">    </span><span class="n">H5MetaData</span><span class="w"> </span><span class="n">md</span><span class="p">;</span>
<span class="linenos">2491</span><span class="w">    </span><span class="n">md</span><span class="p">.</span><span class="n">replicate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">req</span><span class="o">-&gt;</span><span class="n">replicate</span><span class="p">;</span>
<span class="linenos">2492</span>
<span class="linenos">2493</span><span class="w">    </span><span class="n">hid_t</span><span class="w"> </span><span class="n">datasetHandle</span><span class="p">,</span><span class="w"> </span><span class="n">dataspaceHandle</span><span class="p">,</span><span class="w"> </span><span class="n">typeHandle</span><span class="p">;</span>
<span class="linenos">2494</span><span class="w">    </span><span class="n">H5T_class_t</span><span class="w"> </span><span class="n">typeClass</span><span class="p">;</span>
<span class="linenos">2495</span><span class="w">    </span><span class="n">hsize_t</span><span class="w"> </span><span class="n">dims</span><span class="p">[</span><span class="n">H5S_MAX_RANK</span><span class="p">];</span>
<span class="linenos">2496</span><span class="w">    </span><span class="n">hsize_t</span><span class="w"> </span><span class="n">elemSz</span><span class="p">;</span>
<span class="linenos">2497</span>
<span class="linenos">2498</span><span class="w">    </span><span class="n">HDF5_EXCEPTION_CALL</span><span class="p">(</span><span class="n">datasetHandle</span><span class="p">,</span><span class="w"> </span><span class="n">H5Dopen2</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="n">req</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">,</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">));</span>
<span class="linenos">2499</span><span class="w">    </span><span class="n">HDF5_EXCEPTION_CALL</span><span class="p">(</span><span class="n">dataspaceHandle</span><span class="p">,</span><span class="w"> </span><span class="n">H5Dget_space</span><span class="p">(</span><span class="n">datasetHandle</span><span class="p">));</span>
<span class="linenos">2500</span><span class="w">    </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Sget_simple_extent_dims</span><span class="p">(</span><span class="n">dataspaceHandle</span><span class="p">,</span><span class="w"> </span><span class="n">dims</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">));</span>
<span class="linenos">2501</span><span class="w">    </span><span class="n">HDF5_EXCEPTION_CALL</span><span class="p">(</span><span class="n">md</span><span class="p">.</span><span class="n">ndim</span><span class="p">,</span><span class="w"> </span><span class="n">H5Sget_simple_extent_ndims</span><span class="p">(</span><span class="n">dataspaceHandle</span><span class="p">));</span>
<span class="linenos">2502</span><span class="w">    </span><span class="n">HDF5_EXCEPTION_CALL</span><span class="p">(</span><span class="n">typeHandle</span><span class="p">,</span><span class="w"> </span><span class="n">H5Dget_type</span><span class="p">(</span><span class="n">datasetHandle</span><span class="p">));</span>
<span class="linenos">2503</span><span class="w">    </span><span class="n">HDF5_EXCEPTION_CALL</span><span class="p">(</span><span class="n">md</span><span class="p">.</span><span class="n">h5type</span><span class="p">,</span><span class="w"> </span><span class="n">H5Tget_native_type</span><span class="p">(</span><span class="n">typeHandle</span><span class="p">,</span><span class="w"> </span><span class="n">H5T_DIR_ASCEND</span><span class="p">));</span>
<span class="linenos">2504</span><span class="w">    </span><span class="n">HDF5_EXCEPTION_CALL</span><span class="p">(</span><span class="n">elemSz</span><span class="p">,</span><span class="w"> </span><span class="n">H5Tget_size</span><span class="p">(</span><span class="n">md</span><span class="p">.</span><span class="n">h5type</span><span class="p">));</span>
<span class="linenos">2505</span>
<span class="linenos">2506</span><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">md</span><span class="p">.</span><span class="n">ndim</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">2507</span><span class="w">        </span><span class="n">md</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dims</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="linenos">2508</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">2509</span>
<span class="linenos">2510</span><span class="w">    </span><span class="n">md</span><span class="p">.</span><span class="n">payloadSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">elemSz</span><span class="o">*</span><span class="n">std</span><span class="o">::</span><span class="n">accumulate</span><span class="p">(</span><span class="n">md</span><span class="p">.</span><span class="n">shape</span><span class="p">,</span><span class="w"> </span><span class="n">md</span><span class="p">.</span><span class="n">shape</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">md</span><span class="p">.</span><span class="n">ndim</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">multiplies</span><span class="o">&lt;</span><span class="kt">size_t</span><span class="o">&gt;</span><span class="p">());</span>
<span class="linenos">2511</span>
<span class="linenos">2512</span><span class="w">    </span><span class="n">sz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">md</span><span class="p">)</span><span class="o">+</span><span class="n">md</span><span class="p">.</span><span class="n">payloadSize</span><span class="p">;</span>
<span class="linenos">2513</span><span class="w">    </span><span class="n">buf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="p">[</span><span class="n">sz</span><span class="p">];</span>
<span class="linenos">2514</span><span class="w">    </span><span class="n">H5MetaData</span><span class="w"> </span><span class="o">*</span><span class="n">hdr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">H5MetaData</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
<span class="linenos">2515</span><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">payload</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">buf</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">md</span><span class="p">);</span>
<span class="linenos">2516</span><span class="w">    </span><span class="o">*</span><span class="n">hdr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">md</span><span class="p">;</span>
<span class="linenos">2517</span>
<span class="linenos">2518</span><span class="w">    </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Dread</span><span class="p">(</span><span class="n">datasetHandle</span><span class="p">,</span><span class="w"> </span><span class="n">md</span><span class="p">.</span><span class="n">h5type</span><span class="p">,</span><span class="w"> </span><span class="n">H5S_ALL</span><span class="p">,</span><span class="w"> </span><span class="n">H5S_ALL</span><span class="p">,</span><span class="w"> </span><span class="n">H5P_DEFAULT</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">payload</span><span class="p">));</span>
<span class="linenos">2519</span><span class="w">    </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Tclose</span><span class="p">(</span><span class="n">typeHandle</span><span class="p">));</span>
<span class="linenos">2520</span><span class="w">    </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Dclose</span><span class="p">(</span><span class="n">datasetHandle</span><span class="p">));</span>
<span class="linenos">2521</span><span class="w">    </span><span class="n">HDF5_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">H5Sclose</span><span class="p">(</span><span class="n">dataspaceHandle</span><span class="p">));</span>
<span class="linenos">2522</span>
<span class="linenos">2523</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">H5Tequal</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">h5type</span><span class="p">,</span><span class="w"> </span><span class="n">md</span><span class="p">.</span><span class="n">h5type</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">2524</span><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="n">Exception</span><span class="p">(</span><span class="s">&quot;Requested and HDF5 data types do not match&quot;</span><span class="p">);</span>
<span class="linenos">2525</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">2526</span><span class="p">}</span>
<span class="linenos">2527</span>
<span class="linenos">2528</span>
<span class="linenos">2529</span><span class="p">}</span>
<span class="linenos">2530</span><span class="p">}</span>
<span class="linenos">2531</span><span class="p">}</span>
<span class="linenos">2532</span>
<span class="linenos">2533</span><span class="cm">/* Generic code to read a dataset with a hyperslab.</span>
<span class="linenos">2534</span><span class="cm"> * int ndims;</span>
<span class="linenos">2535</span><span class="cm">hsize_t dims[4];</span>
<span class="linenos">2536</span><span class="cm">hsize_t memdims[1];</span>
<span class="linenos">2537</span><span class="cm">hsize_t start[4], count[4];</span>
<span class="linenos">2538</span><span class="cm">hid_t dataset, dataspace, memspace;</span>
<span class="linenos">2539</span><span class="cm">HDF5_EXCEPTION_CALL(dataset,H5Dopen2(file, &quot;/Model/Diffusion/Lattice&quot;, H5P_DEFAULT));</span>
<span class="linenos">2540</span><span class="cm">HDF5_EXCEPTION_CALL(dataspace,H5Dget_space(dataset));</span>
<span class="linenos">2541</span><span class="cm">ndims=H5Sget_simple_extent_ndims(dataspace);</span>
<span class="linenos">2542</span><span class="cm">if (ndims != 4) throw Exception(&quot;Invalid dataset dimensions&quot;, filename.c_str(), &quot;/Model/Diffusion/Lattice&quot;);</span>
<span class="linenos">2543</span><span class="cm">HDF5_EXCEPTION_CALL(ndims,H5Sget_simple_extent_dims(dataspace, dims, NULL));</span>
<span class="linenos">2544</span><span class="cm">if (dims[0]*dims[1]*dims[2]*dims[3] != latticeSize) throw InvalidArgException(&quot;lattice&quot;, &quot;incorrect lattice size&quot;);</span>
<span class="linenos">2545</span><span class="cm">start[0] = 0;</span>
<span class="linenos">2546</span><span class="cm">start[1] = 0;</span>
<span class="linenos">2547</span><span class="cm">start[2] = 0;</span>
<span class="linenos">2548</span><span class="cm">start[3] = 0;</span>
<span class="linenos">2549</span><span class="cm">count[0] = dims[0];</span>
<span class="linenos">2550</span><span class="cm">count[1] = dims[1];</span>
<span class="linenos">2551</span><span class="cm">count[2] = dims[2];</span>
<span class="linenos">2552</span><span class="cm">count[3] = dims[3];</span>
<span class="linenos">2553</span><span class="cm">HDF5_EXCEPTION_CHECK(H5Sselect_hyperslab(dataspace, H5S_SELECT_SET, start, NULL, count, NULL));</span>
<span class="linenos">2554</span><span class="cm">memdims[0] = dims[0]*dims[1]*dims[2]*dims[3];</span>
<span class="linenos">2555</span><span class="cm">HDF5_EXCEPTION_CALL(memspace,H5Screate_simple(1, memdims, NULL));</span>
<span class="linenos">2556</span><span class="cm">HDF5_EXCEPTION_CHECK(H5Dread(dataset, H5T_NATIVE_UINT8, memspace, dataspace, H5P_DEFAULT, (void *)lattice));</span>
<span class="linenos">2557</span><span class="cm">HDF5_EXCEPTION_CHECK(H5Sclose(memspace));</span>
<span class="linenos">2558</span><span class="cm">HDF5_EXCEPTION_CHECK(H5Sclose(dataspace));</span>
<span class="linenos">2559</span><span class="cm">HDF5_EXCEPTION_CHECK(H5Dclose(dataset));</span>
<span class="linenos">2560</span><span class="cm">*/</span>
</pre></div>
</div>
</section>
<section id="timer-h">
<h3>Timer.h<a class="headerlink" href="#timer-h" title="Link to this heading">#</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="linenos">  1</span><span class="cm">/*</span>
<span class="linenos">  2</span><span class="cm"> * University of Illinois Open Source License</span>
<span class="linenos">  3</span><span class="cm"> * Copyright 2016-2018 Luthey-Schulten Group,</span>
<span class="linenos">  4</span><span class="cm"> * All rights reserved.</span>
<span class="linenos">  5</span><span class="cm"> * </span>
<span class="linenos">  6</span><span class="cm"> * Developed by: Luthey-Schulten Group</span>
<span class="linenos">  7</span><span class="cm"> * 			     University of Illinois at Urbana-Champaign</span>
<span class="linenos">  8</span><span class="cm"> * 			     http://www.scs.uiuc.edu/~schulten</span>
<span class="linenos">  9</span><span class="cm"> * </span>
<span class="linenos"> 10</span><span class="cm"> * Permission is hereby granted, free of charge, to any person obtaining a copy of</span>
<span class="linenos"> 11</span><span class="cm"> * this software and associated documentation files (the Software), to deal with </span>
<span class="linenos"> 12</span><span class="cm"> * the Software without restriction, including without limitation the rights to </span>
<span class="linenos"> 13</span><span class="cm"> * use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies </span>
<span class="linenos"> 14</span><span class="cm"> * of the Software, and to permit persons to whom the Software is furnished to </span>
<span class="linenos"> 15</span><span class="cm"> * do so, subject to the following conditions:</span>
<span class="linenos"> 16</span><span class="cm"> * </span>
<span class="linenos"> 17</span><span class="cm"> * - Redistributions of source code must retain the above copyright notice, </span>
<span class="linenos"> 18</span><span class="cm"> * this list of conditions and the following disclaimers.</span>
<span class="linenos"> 19</span><span class="cm"> * </span>
<span class="linenos"> 20</span><span class="cm"> * - Redistributions in binary form must reproduce the above copyright notice, </span>
<span class="linenos"> 21</span><span class="cm"> * this list of conditions and the following disclaimers in the documentation </span>
<span class="linenos"> 22</span><span class="cm"> * and/or other materials provided with the distribution.</span>
<span class="linenos"> 23</span><span class="cm"> * </span>
<span class="linenos"> 24</span><span class="cm"> * - Neither the names of the Luthey-Schulten Group, University of Illinois at</span>
<span class="linenos"> 25</span><span class="cm"> * Urbana-Champaign, nor the names of its contributors may be used to endorse or</span>
<span class="linenos"> 26</span><span class="cm"> * promote products derived from this Software without specific prior written</span>
<span class="linenos"> 27</span><span class="cm"> * permission.</span>
<span class="linenos"> 28</span><span class="cm"> * </span>
<span class="linenos"> 29</span><span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR </span>
<span class="linenos"> 30</span><span class="cm"> * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, </span>
<span class="linenos"> 31</span><span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL </span>
<span class="linenos"> 32</span><span class="cm"> * THE CONTRIBUTORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR </span>
<span class="linenos"> 33</span><span class="cm"> * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, </span>
<span class="linenos"> 34</span><span class="cm"> * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR </span>
<span class="linenos"> 35</span><span class="cm"> * OTHER DEALINGS WITH THE SOFTWARE.</span>
<span class="linenos"> 36</span><span class="cm"> *</span>
<span class="linenos"> 37</span><span class="cm"> * Author(s): Tyler M. Earnest</span>
<span class="linenos"> 38</span><span class="cm"> */</span>
<span class="linenos"> 39</span>
<span class="linenos"> 40</span><span class="cp">#ifndef TIMER_HH_</span>
<span class="linenos"> 41</span><span class="cp">#define TIMER_HH_</span>
<span class="linenos"> 42</span>
<span class="linenos"> 43</span><span class="cp">#ifdef LINUX</span>
<span class="linenos"> 44</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;ctime&gt;</span>
<span class="linenos"> 45</span>
<span class="linenos"> 46</span><span class="cp">#ifdef __MACH__</span>
<span class="linenos"> 47</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;mach/clock.h&gt;</span>
<span class="linenos"> 48</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;mach/mach.h&gt;</span>
<span class="linenos"> 49</span><span class="cp">#endif</span>
<span class="linenos"> 50</span>
<span class="linenos"> 51</span><span class="k">class</span><span class="w"> </span><span class="nc">Timer</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 52</span><span class="w">    </span><span class="n">timespec</span><span class="w"> </span><span class="n">now</span><span class="p">,</span><span class="n">then</span><span class="p">;</span>
<span class="linenos"> 53</span><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">get_time</span><span class="p">(</span><span class="n">timespec</span><span class="o">*</span><span class="w"> </span><span class="n">t</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span>
<span class="linenos"> 54</span><span class="cp">#ifdef __MACH__</span>
<span class="linenos"> 55</span><span class="w">      </span><span class="n">clock_serv_t</span><span class="w"> </span><span class="n">cclock</span><span class="p">;</span>
<span class="linenos"> 56</span><span class="w">      </span><span class="n">mach_timespec_t</span><span class="w"> </span><span class="n">mts</span><span class="p">;</span>
<span class="linenos"> 57</span><span class="w">      </span><span class="n">host_get_clock_service</span><span class="p">(</span><span class="n">mach_host_self</span><span class="p">(),</span><span class="w"> </span><span class="n">CALENDAR_CLOCK</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">cclock</span><span class="p">);</span>
<span class="linenos"> 58</span><span class="w">      </span><span class="n">clock_get_time</span><span class="p">(</span><span class="n">cclock</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">mts</span><span class="p">);</span>
<span class="linenos"> 59</span><span class="w">      </span><span class="n">mach_port_deallocate</span><span class="p">(</span><span class="n">mach_task_self</span><span class="p">(),</span><span class="w"> </span><span class="n">cclock</span><span class="p">);</span>
<span class="linenos"> 60</span><span class="w">      </span><span class="n">t</span><span class="o">-&gt;</span><span class="n">tv_sec</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">mts</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">;</span>
<span class="linenos"> 61</span><span class="w">      </span><span class="n">t</span><span class="o">-&gt;</span><span class="n">tv_nsec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mts</span><span class="p">.</span><span class="n">tv_nsec</span><span class="p">;</span>
<span class="linenos"> 62</span><span class="cp">#else</span>
<span class="linenos"> 63</span><span class="w">      </span><span class="n">clock_gettime</span><span class="p">(</span><span class="n">CLOCK_MONOTONIC</span><span class="p">,</span><span class="w"> </span><span class="n">t</span><span class="p">);</span><span class="w"> </span>
<span class="linenos"> 64</span><span class="cp">#endif</span>
<span class="linenos"> 65</span><span class="w">    </span><span class="p">}</span>
<span class="linenos"> 66</span>
<span class="linenos"> 67</span><span class="k">public</span><span class="o">:</span>
<span class="linenos"> 68</span>
<span class="linenos"> 69</span><span class="w">    </span><span class="kt">double</span>
<span class="linenos"> 70</span><span class="w">    </span><span class="n">tock</span><span class="p">()</span>
<span class="linenos"> 71</span><span class="w">    </span><span class="p">{</span>
<span class="linenos"> 72</span><span class="w">      </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">sec</span><span class="p">,</span><span class="n">nsec</span><span class="p">;</span>
<span class="linenos"> 73</span>
<span class="linenos"> 74</span><span class="w">      </span><span class="n">get_time</span><span class="p">(</span><span class="o">&amp;</span><span class="n">now</span><span class="p">);</span>
<span class="linenos"> 75</span>
<span class="linenos"> 76</span><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">now</span><span class="p">.</span><span class="n">tv_nsec</span><span class="o">-</span><span class="n">then</span><span class="p">.</span><span class="n">tv_nsec</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span>
<span class="linenos"> 77</span><span class="w">        </span><span class="p">{</span>
<span class="linenos"> 78</span><span class="w">          </span><span class="n">sec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">now</span><span class="p">.</span><span class="n">tv_sec</span><span class="o">-</span><span class="n">then</span><span class="p">.</span><span class="n">tv_sec</span><span class="mi">-1</span><span class="p">;</span>
<span class="linenos"> 79</span><span class="w">          </span><span class="n">nsec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1000000000L</span><span class="o">+</span><span class="n">now</span><span class="p">.</span><span class="n">tv_nsec</span><span class="o">-</span><span class="n">then</span><span class="p">.</span><span class="n">tv_nsec</span><span class="p">;</span>
<span class="linenos"> 80</span><span class="w">        </span><span class="p">}</span><span class="w"> </span>
<span class="linenos"> 81</span><span class="w">      </span><span class="k">else</span><span class="w"> </span>
<span class="linenos"> 82</span><span class="w">        </span><span class="p">{</span>
<span class="linenos"> 83</span><span class="w">          </span><span class="n">sec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">now</span><span class="p">.</span><span class="n">tv_sec</span><span class="o">-</span><span class="n">then</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">;</span>
<span class="linenos"> 84</span><span class="w">          </span><span class="n">nsec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">now</span><span class="p">.</span><span class="n">tv_nsec</span><span class="o">-</span><span class="n">then</span><span class="p">.</span><span class="n">tv_nsec</span><span class="p">;</span>
<span class="linenos"> 85</span><span class="w">        </span><span class="p">}</span>
<span class="linenos"> 86</span><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">sec</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">nsec</span><span class="o">*</span><span class="mf">1e-9</span><span class="p">;</span>
<span class="linenos"> 87</span><span class="w">    </span><span class="p">}</span>
<span class="linenos"> 88</span>
<span class="linenos"> 89</span><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">tick</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">get_time</span><span class="p">(</span><span class="o">&amp;</span><span class="n">then</span><span class="p">);</span><span class="w"> </span><span class="p">}</span>
<span class="linenos"> 90</span>
<span class="linenos"> 91</span><span class="w">    </span><span class="n">Timer</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">tick</span><span class="p">();</span><span class="w"> </span><span class="p">}</span>
<span class="linenos"> 92</span><span class="p">};</span>
<span class="linenos"> 93</span><span class="cp">#endif </span><span class="cm">/* LINUX */</span>
<span class="linenos"> 94</span>
<span class="linenos"> 95</span><span class="cp">#ifdef MACOSX</span>
<span class="linenos"> 96</span><span class="cm">/* https://developer.apple.com/library/mac/qa/qa1398/_index.html */</span>
<span class="linenos"> 97</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;mach/mach_time.h&gt;</span>
<span class="linenos"> 98</span>
<span class="linenos"> 99</span><span class="k">class</span><span class="w"> </span><span class="nc">Timer</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">100</span><span class="w">	</span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">now</span><span class="p">,</span><span class="n">then</span><span class="p">;</span>
<span class="linenos">101</span><span class="w">	</span><span class="n">mach_timebase_info_data_t</span><span class="w"> </span><span class="n">base</span><span class="p">;</span>
<span class="linenos">102</span><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">get_time</span><span class="p">(</span><span class="kt">uint64_t</span><span class="o">*</span><span class="w"> </span><span class="n">t</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">*</span><span class="n">t</span><span class="o">=</span><span class="n">mach_absolute_time</span><span class="p">();</span><span class="w"> </span><span class="p">}</span><span class="w"> </span>
<span class="linenos">103</span>
<span class="linenos">104</span><span class="k">public</span><span class="o">:</span>
<span class="linenos">105</span>
<span class="linenos">106</span><span class="w">	</span><span class="n">Timer</span><span class="p">()</span>
<span class="linenos">107</span><span class="w">	</span><span class="p">{</span>
<span class="linenos">108</span><span class="w">		</span><span class="n">mach_timebase_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">base</span><span class="p">);</span>
<span class="linenos">109</span><span class="w">		</span><span class="n">tick</span><span class="p">();</span>
<span class="linenos">110</span><span class="w">	</span><span class="p">}</span>
<span class="linenos">111</span>
<span class="linenos">112</span><span class="w">    </span><span class="kt">double</span>
<span class="linenos">113</span><span class="w">    </span><span class="n">tock</span><span class="p">()</span>
<span class="linenos">114</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">115</span><span class="w">      </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">nsec</span><span class="p">;</span>
<span class="linenos">116</span>
<span class="linenos">117</span><span class="w">      </span><span class="n">get_time</span><span class="p">(</span><span class="o">&amp;</span><span class="n">now</span><span class="p">);</span>
<span class="linenos">118</span><span class="w">		</span><span class="n">nsec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">now</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">then</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">base</span><span class="p">.</span><span class="n">numer</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">base</span><span class="p">.</span><span class="n">denom</span><span class="p">;</span>
<span class="linenos">119</span><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">nsec</span><span class="o">*</span><span class="mf">1e-9</span><span class="p">;</span>
<span class="linenos">120</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">121</span>
<span class="linenos">122</span><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">tick</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">get_time</span><span class="p">(</span><span class="o">&amp;</span><span class="n">then</span><span class="p">);</span><span class="w"> </span><span class="p">}</span>
<span class="linenos">123</span><span class="p">};</span>
<span class="linenos">124</span><span class="cp">#endif </span><span class="cm">/* MACOSX */</span>
<span class="linenos">125</span>
<span class="linenos">126</span><span class="cp">#endif </span><span class="cm">/* TIMER_HH_ */</span>
</pre></div>
</div>
</section>
<section id="timer-cpp">
<h3>Timer.cpp<a class="headerlink" href="#timer-cpp" title="Link to this heading">#</a></h3>
</section>
<section id="signalhandler-h">
<h3>SignalHandler.h<a class="headerlink" href="#signalhandler-h" title="Link to this heading">#</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cm">/*</span>
<span class="linenos"> 2</span><span class="cm"> * University of Illinois Open Source License</span>
<span class="linenos"> 3</span><span class="cm"> * Copyright 2008-2018 Luthey-Schulten Group,</span>
<span class="linenos"> 4</span><span class="cm"> * All rights reserved.</span>
<span class="linenos"> 5</span><span class="cm"> * </span>
<span class="linenos"> 6</span><span class="cm"> * Developed by: Luthey-Schulten Group</span>
<span class="linenos"> 7</span><span class="cm"> * 			     University of Illinois at Urbana-Champaign</span>
<span class="linenos"> 8</span><span class="cm"> * 			     http://www.scs.uiuc.edu/~schulten</span>
<span class="linenos"> 9</span><span class="cm"> * </span>
<span class="linenos">10</span><span class="cm"> * Permission is hereby granted, free of charge, to any person obtaining a copy of</span>
<span class="linenos">11</span><span class="cm"> * this software and associated documentation files (the Software), to deal with </span>
<span class="linenos">12</span><span class="cm"> * the Software without restriction, including without limitation the rights to </span>
<span class="linenos">13</span><span class="cm"> * use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies </span>
<span class="linenos">14</span><span class="cm"> * of the Software, and to permit persons to whom the Software is furnished to </span>
<span class="linenos">15</span><span class="cm"> * do so, subject to the following conditions:</span>
<span class="linenos">16</span><span class="cm"> * </span>
<span class="linenos">17</span><span class="cm"> * - Redistributions of source code must retain the above copyright notice, </span>
<span class="linenos">18</span><span class="cm"> * this list of conditions and the following disclaimers.</span>
<span class="linenos">19</span><span class="cm"> * </span>
<span class="linenos">20</span><span class="cm"> * - Redistributions in binary form must reproduce the above copyright notice, </span>
<span class="linenos">21</span><span class="cm"> * this list of conditions and the following disclaimers in the documentation </span>
<span class="linenos">22</span><span class="cm"> * and/or other materials provided with the distribution.</span>
<span class="linenos">23</span><span class="cm"> * </span>
<span class="linenos">24</span><span class="cm"> * - Neither the names of the Luthey-Schulten Group, University of Illinois at</span>
<span class="linenos">25</span><span class="cm"> * Urbana-Champaign, nor the names of its contributors may be used to endorse or</span>
<span class="linenos">26</span><span class="cm"> * promote products derived from this Software without specific prior written</span>
<span class="linenos">27</span><span class="cm"> * permission.</span>
<span class="linenos">28</span><span class="cm"> * </span>
<span class="linenos">29</span><span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR </span>
<span class="linenos">30</span><span class="cm"> * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, </span>
<span class="linenos">31</span><span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL </span>
<span class="linenos">32</span><span class="cm"> * THE CONTRIBUTORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR </span>
<span class="linenos">33</span><span class="cm"> * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, </span>
<span class="linenos">34</span><span class="cm"> * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR </span>
<span class="linenos">35</span><span class="cm"> * OTHER DEALINGS WITH THE SOFTWARE.</span>
<span class="linenos">36</span><span class="cm"> *</span>
<span class="linenos">37</span><span class="cm"> * Author(s): Elijah Roberts</span>
<span class="linenos">38</span><span class="cm"> */</span>
<span class="linenos">39</span>
<span class="linenos">40</span><span class="cp">#ifndef LM_MAIN_SIGNALHANDLER</span>
<span class="linenos">41</span><span class="cp">#define LM_MAIN_SIGNALHANDLER</span>
<span class="linenos">42</span>
<span class="linenos">43</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;list&gt;</span>
<span class="linenos">44</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;csignal&gt;</span>
<span class="linenos">45</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;thread/Thread.h&quot;</span>
<span class="linenos">46</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;thread/Worker.h&quot;</span>
<span class="linenos">47</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;thread/WorkerManager.h&quot;</span>
<span class="linenos">48</span>
<span class="linenos">49</span><span class="k">using</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">list</span><span class="p">;</span>
<span class="linenos">50</span><span class="k">using</span><span class="w"> </span><span class="n">lm</span><span class="o">::</span><span class="kr">thread</span><span class="o">::</span><span class="n">PthreadException</span><span class="p">;</span>
<span class="linenos">51</span><span class="k">using</span><span class="w"> </span><span class="n">lm</span><span class="o">::</span><span class="kr">thread</span><span class="o">::</span><span class="n">Worker</span><span class="p">;</span>
<span class="linenos">52</span>
<span class="linenos">53</span>
<span class="linenos">54</span><span class="k">namespace</span><span class="w"> </span><span class="nn">lm</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">55</span><span class="k">namespace</span><span class="w"> </span><span class="nn">main</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">56</span>
<span class="linenos">57</span><span class="k">class</span><span class="w"> </span><span class="nc">LocalDataOutputWorker</span><span class="p">;</span>
<span class="linenos">58</span>
<span class="linenos">59</span><span class="c1">/// @class SignalHandler</span>
<span class="linenos">60</span><span class="c1">/// @brief A thread safe Worker thread type that captures SIG* type signals over the various threads</span>
<span class="linenos">61</span><span class="k">class</span><span class="w"> </span><span class="nc">SignalHandler</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">Worker</span>
<span class="linenos">62</span><span class="p">{</span>
<span class="linenos">63</span><span class="k">public</span><span class="o">:</span>
<span class="linenos">64</span><span class="w">    </span><span class="c1">/// @brief Create a SignalHandler</span>
<span class="linenos">65</span><span class="w">    </span><span class="n">SignalHandler</span><span class="p">();</span>
<span class="linenos">66</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="o">~</span><span class="n">SignalHandler</span><span class="p">();</span>
<span class="linenos">67</span><span class="w">    </span>
<span class="linenos">68</span><span class="w">    </span><span class="c1">/// @brief Wake a sleeping Signalhandler</span>
<span class="linenos">69</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">wake</span><span class="p">();</span>
<span class="linenos">70</span>
<span class="linenos">71</span><span class="k">private</span><span class="o">:</span>
<span class="linenos">72</span><span class="w">    </span><span class="kt">sigset_t</span><span class="w"> </span><span class="n">signalMask</span><span class="p">;</span>
<span class="linenos">73</span>
<span class="linenos">74</span><span class="k">protected</span><span class="o">:</span>
<span class="linenos">75</span><span class="w">    </span><span class="c1">/// @brief Run the SignalHandler thread so that it can catch signals</span>
<span class="linenos">76</span><span class="w">    </span><span class="c1">/// @return 0 on success, -1 on failure</span>
<span class="linenos">77</span><span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">run</span><span class="p">();</span>
<span class="linenos">78</span><span class="p">};</span>
<span class="linenos">79</span>
<span class="linenos">80</span><span class="p">}</span>
<span class="linenos">81</span><span class="p">}</span>
<span class="linenos">82</span>
<span class="linenos">83</span>
<span class="linenos">84</span><span class="cp">#endif</span>
</pre></div>
</div>
</section>
<section id="signalhandler-cpp">
<h3>SignalHandler.cpp<a class="headerlink" href="#signalhandler-cpp" title="Link to this heading">#</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="linenos">  1</span><span class="cm">/*</span>
<span class="linenos">  2</span><span class="cm"> * University of Illinois Open Source License</span>
<span class="linenos">  3</span><span class="cm"> * Copyright 2008-2018 Luthey-Schulten Group,</span>
<span class="linenos">  4</span><span class="cm"> * All rights reserved.</span>
<span class="linenos">  5</span><span class="cm"> * </span>
<span class="linenos">  6</span><span class="cm"> * Developed by: Luthey-Schulten Group</span>
<span class="linenos">  7</span><span class="cm"> * 			     University of Illinois at Urbana-Champaign</span>
<span class="linenos">  8</span><span class="cm"> * 			     http://www.scs.uiuc.edu/~schulten</span>
<span class="linenos">  9</span><span class="cm"> * </span>
<span class="linenos"> 10</span><span class="cm"> * Permission is hereby granted, free of charge, to any person obtaining a copy of</span>
<span class="linenos"> 11</span><span class="cm"> * this software and associated documentation files (the Software), to deal with </span>
<span class="linenos"> 12</span><span class="cm"> * the Software without restriction, including without limitation the rights to </span>
<span class="linenos"> 13</span><span class="cm"> * use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies </span>
<span class="linenos"> 14</span><span class="cm"> * of the Software, and to permit persons to whom the Software is furnished to </span>
<span class="linenos"> 15</span><span class="cm"> * do so, subject to the following conditions:</span>
<span class="linenos"> 16</span><span class="cm"> * </span>
<span class="linenos"> 17</span><span class="cm"> * - Redistributions of source code must retain the above copyright notice, </span>
<span class="linenos"> 18</span><span class="cm"> * this list of conditions and the following disclaimers.</span>
<span class="linenos"> 19</span><span class="cm"> * </span>
<span class="linenos"> 20</span><span class="cm"> * - Redistributions in binary form must reproduce the above copyright notice, </span>
<span class="linenos"> 21</span><span class="cm"> * this list of conditions and the following disclaimers in the documentation </span>
<span class="linenos"> 22</span><span class="cm"> * and/or other materials provided with the distribution.</span>
<span class="linenos"> 23</span><span class="cm"> * </span>
<span class="linenos"> 24</span><span class="cm"> * - Neither the names of the Luthey-Schulten Group, University of Illinois at</span>
<span class="linenos"> 25</span><span class="cm"> * Urbana-Champaign, nor the names of its contributors may be used to endorse or</span>
<span class="linenos"> 26</span><span class="cm"> * promote products derived from this Software without specific prior written</span>
<span class="linenos"> 27</span><span class="cm"> * permission.</span>
<span class="linenos"> 28</span><span class="cm"> * </span>
<span class="linenos"> 29</span><span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR </span>
<span class="linenos"> 30</span><span class="cm"> * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, </span>
<span class="linenos"> 31</span><span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL </span>
<span class="linenos"> 32</span><span class="cm"> * THE CONTRIBUTORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR </span>
<span class="linenos"> 33</span><span class="cm"> * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, </span>
<span class="linenos"> 34</span><span class="cm"> * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR </span>
<span class="linenos"> 35</span><span class="cm"> * OTHER DEALINGS WITH THE SOFTWARE.</span>
<span class="linenos"> 36</span><span class="cm"> *</span>
<span class="linenos"> 37</span><span class="cm"> * Author(s): Elijah Roberts</span>
<span class="linenos"> 38</span><span class="cm"> */</span>
<span class="linenos"> 39</span>
<span class="linenos"> 40</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;csignal&gt;</span>
<span class="linenos"> 41</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;config.h&quot;</span>
<span class="linenos"> 42</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;core/Print.h&quot;</span>
<span class="linenos"> 43</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;core/LocalDataOutputWorker.h&quot;</span>
<span class="linenos"> 44</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;core/Globals.h&quot;</span>
<span class="linenos"> 45</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;core/SignalHandler.h&quot;</span>
<span class="linenos"> 46</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;thread/Thread.h&quot;</span>
<span class="linenos"> 47</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;thread/WorkerManager.h&quot;</span>
<span class="linenos"> 48</span>
<span class="linenos"> 49</span><span class="k">using</span><span class="w"> </span><span class="n">lm</span><span class="o">::</span><span class="kr">thread</span><span class="o">::</span><span class="n">PthreadException</span><span class="p">;</span>
<span class="linenos"> 50</span><span class="k">using</span><span class="w"> </span><span class="n">lm</span><span class="o">::</span><span class="kr">thread</span><span class="o">::</span><span class="n">WorkerManager</span><span class="p">;</span>
<span class="linenos"> 51</span>
<span class="linenos"> 52</span><span class="k">namespace</span><span class="w"> </span><span class="nn">lm</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 53</span><span class="k">namespace</span><span class="w"> </span><span class="nn">main</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 54</span>
<span class="linenos"> 55</span>
<span class="linenos"> 56</span><span class="n">SignalHandler</span><span class="o">::</span><span class="n">SignalHandler</span><span class="p">()</span>
<span class="linenos"> 57</span><span class="p">{</span>
<span class="linenos"> 58</span><span class="w">    </span><span class="c1">// Block signals from interrupting the calling thread.</span>
<span class="linenos"> 59</span><span class="w">    </span><span class="n">sigemptyset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">signalMask</span><span class="p">);</span>
<span class="linenos"> 60</span><span class="w">    </span><span class="n">sigaddset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">signalMask</span><span class="p">,</span><span class="w"> </span><span class="n">SIGINT</span><span class="p">);</span>
<span class="linenos"> 61</span><span class="w">    </span><span class="n">sigaddset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">signalMask</span><span class="p">,</span><span class="w"> </span><span class="n">SIGTERM</span><span class="p">);</span>
<span class="linenos"> 62</span><span class="w">    </span><span class="n">sigaddset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">signalMask</span><span class="p">,</span><span class="w"> </span><span class="n">SIGUSR1</span><span class="p">);</span>
<span class="linenos"> 63</span><span class="w">    </span><span class="n">sigaddset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">signalMask</span><span class="p">,</span><span class="w"> </span><span class="n">SIGUSR2</span><span class="p">);</span>
<span class="linenos"> 64</span><span class="w">    </span><span class="n">PTHREAD_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">pthread_sigmask</span><span class="p">(</span><span class="n">SIG_BLOCK</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">signalMask</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">));</span>
<span class="linenos"> 65</span><span class="p">}</span>
<span class="linenos"> 66</span>
<span class="linenos"> 67</span><span class="n">SignalHandler</span><span class="o">::~</span><span class="n">SignalHandler</span><span class="p">()</span>
<span class="linenos"> 68</span><span class="p">{</span>
<span class="linenos"> 69</span><span class="p">}</span>
<span class="linenos"> 70</span>
<span class="linenos"> 71</span><span class="kt">void</span><span class="w"> </span><span class="n">SignalHandler</span><span class="o">::</span><span class="n">wake</span><span class="p">()</span>
<span class="linenos"> 72</span><span class="p">{</span>
<span class="linenos"> 73</span><span class="w">    </span><span class="n">PTHREAD_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">pthread_kill</span><span class="p">(</span><span class="n">threadId</span><span class="p">,</span><span class="w"> </span><span class="n">SIGUSR1</span><span class="p">));</span>
<span class="linenos"> 74</span><span class="p">}</span>
<span class="linenos"> 75</span>
<span class="linenos"> 76</span><span class="kt">int</span><span class="w"> </span><span class="n">SignalHandler</span><span class="o">::</span><span class="n">run</span><span class="p">()</span>
<span class="linenos"> 77</span><span class="p">{</span>
<span class="linenos"> 78</span><span class="w">    </span><span class="k">try</span>
<span class="linenos"> 79</span><span class="w">    </span><span class="p">{</span>
<span class="linenos"> 80</span><span class="w">        </span><span class="n">Print</span><span class="o">::</span><span class="n">printf</span><span class="p">(</span><span class="n">Print</span><span class="o">::</span><span class="n">DEBUG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Signal handler thread running.&quot;</span><span class="p">);</span>
<span class="linenos"> 81</span>
<span class="linenos"> 82</span><span class="w">        </span><span class="kt">bool</span><span class="w"> </span><span class="n">looping</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="linenos"> 83</span><span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">looping</span><span class="p">)</span>
<span class="linenos"> 84</span><span class="w">        </span><span class="p">{</span>
<span class="linenos"> 85</span><span class="w">            </span><span class="c1">// Wait for a signal.</span>
<span class="linenos"> 86</span><span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">signalCaught</span><span class="p">;</span>
<span class="linenos"> 87</span><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">sigwait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">signalMask</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">signalCaught</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="n">lm</span><span class="o">::</span><span class="n">Exception</span><span class="p">(</span><span class="s">&quot;Error waiting for signal.&quot;</span><span class="p">);</span>
<span class="linenos"> 88</span>
<span class="linenos"> 89</span><span class="w">            </span><span class="n">Print</span><span class="o">::</span><span class="n">printf</span><span class="p">(</span><span class="n">Print</span><span class="o">::</span><span class="n">DEBUG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Received signal %d, control signal is %d.&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">signalCaught</span><span class="p">,</span><span class="n">SIGUSR1</span><span class="p">);</span>
<span class="linenos"> 90</span>
<span class="linenos"> 91</span><span class="w">            </span><span class="c1">// If this was our control signal, check for control changes.</span>
<span class="linenos"> 92</span><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">signalCaught</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">SIGUSR1</span><span class="p">)</span>
<span class="linenos"> 93</span><span class="w">            </span><span class="p">{</span>
<span class="linenos"> 94</span><span class="w">                </span><span class="c1">//// BEGIN CRITICAL SECTION: controlMutex</span>
<span class="linenos"> 95</span><span class="w">                </span><span class="n">PTHREAD_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">pthread_mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">controlMutex</span><span class="p">));</span>
<span class="linenos"> 96</span>
<span class="linenos"> 97</span><span class="w">                </span><span class="c1">// If we should abort, stop looping.</span>
<span class="linenos"> 98</span><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">aborted</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="n">running</span><span class="p">)</span><span class="w"> </span><span class="n">looping</span><span class="o">=</span><span class="nb">false</span><span class="p">;</span>
<span class="linenos"> 99</span>
<span class="linenos">100</span><span class="w">                </span><span class="n">PTHREAD_EXCEPTION_CHECK</span><span class="p">(</span><span class="n">pthread_mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">controlMutex</span><span class="p">));</span>
<span class="linenos">101</span><span class="w">                </span><span class="c1">//// END CRITICAL SECTION: controlMutex</span>
<span class="linenos">102</span><span class="w">            </span><span class="p">}</span>
<span class="linenos">103</span>
<span class="linenos">104</span><span class="w">            </span><span class="c1">// Otherwise, see what we need to do.</span>
<span class="linenos">105</span><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">signalCaught</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">SIGUSR1</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">looping</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">true</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">signalCaught</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">SIGUSR2</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">signalCaught</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">SIGINT</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">signalCaught</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">SIGTERM</span><span class="p">)</span>
<span class="linenos">106</span><span class="w">            </span><span class="p">{</span>
<span class="linenos">107</span><span class="w">                </span><span class="c1">// Set the global abort flag.</span>
<span class="linenos">108</span><span class="w">                </span><span class="n">Print</span><span class="o">::</span><span class="n">printf</span><span class="p">(</span><span class="n">Print</span><span class="o">::</span><span class="n">WARNING</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Global abort signaled.&quot;</span><span class="p">);</span>
<span class="linenos">109</span><span class="w">                </span><span class="n">globalAbort</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="linenos">110</span><span class="w">            </span><span class="p">}</span>
<span class="linenos">111</span><span class="w">        </span><span class="p">}</span>
<span class="linenos">112</span><span class="w">        </span><span class="n">Print</span><span class="o">::</span><span class="n">printf</span><span class="p">(</span><span class="n">Print</span><span class="o">::</span><span class="n">DEBUG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Signal handler thread finished.&quot;</span><span class="p">);</span>
<span class="linenos">113</span><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">114</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">115</span><span class="w">    </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">lm</span><span class="o">::</span><span class="kr">thread</span><span class="o">::</span><span class="n">PthreadException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span>
<span class="linenos">116</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">117</span><span class="w">        </span><span class="n">Print</span><span class="o">::</span><span class="n">printf</span><span class="p">(</span><span class="n">Print</span><span class="o">::</span><span class="n">FATAL</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Pthread exception during execution: %s (%s:%d)&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">what</span><span class="p">(),</span><span class="w"> </span><span class="n">__FILE__</span><span class="p">,</span><span class="w"> </span><span class="n">__LINE__</span><span class="p">);</span>
<span class="linenos">118</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">119</span><span class="w">    </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">lm</span><span class="o">::</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span>
<span class="linenos">120</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">121</span><span class="w">        </span><span class="n">Print</span><span class="o">::</span><span class="n">printf</span><span class="p">(</span><span class="n">Print</span><span class="o">::</span><span class="n">FATAL</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Exception during execution: %s (%s:%d)&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">what</span><span class="p">(),</span><span class="w"> </span><span class="n">__FILE__</span><span class="p">,</span><span class="w"> </span><span class="n">__LINE__</span><span class="p">);</span>
<span class="linenos">122</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">123</span><span class="w">    </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">exception</span><span class="o">&amp;</span><span class="w"> </span><span class="n">e</span><span class="p">)</span>
<span class="linenos">124</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">125</span><span class="w">        </span><span class="n">Print</span><span class="o">::</span><span class="n">printf</span><span class="p">(</span><span class="n">Print</span><span class="o">::</span><span class="n">FATAL</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Exception during execution: %s (%s:%d)&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">what</span><span class="p">(),</span><span class="w"> </span><span class="n">__FILE__</span><span class="p">,</span><span class="w"> </span><span class="n">__LINE__</span><span class="p">);</span>
<span class="linenos">126</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">127</span><span class="w">    </span><span class="k">catch</span><span class="w"> </span><span class="p">(...)</span>
<span class="linenos">128</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">129</span><span class="w">        </span><span class="n">Print</span><span class="o">::</span><span class="n">printf</span><span class="p">(</span><span class="n">Print</span><span class="o">::</span><span class="n">FATAL</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Unknown Exception during execution (%s:%d)&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">__FILE__</span><span class="p">,</span><span class="w"> </span><span class="n">__LINE__</span><span class="p">);</span>
<span class="linenos">130</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">131</span>
<span class="linenos">132</span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<span class="linenos">133</span><span class="p">}</span>
<span class="linenos">134</span>
<span class="linenos">135</span><span class="p">}</span>
<span class="linenos">136</span><span class="p">}</span>
</pre></div>
</div>
</section>
</section>
</section>


                </article>
              
              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
                <dialog id="pst-secondary-sidebar-modal"></dialog>
                <div id="pst-secondary-sidebar" class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
<div
    id="pst-page-navigation-heading-2"
    class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> On this page
  </div>
  <nav class="bd-toc-nav page-toc" aria-labelledby="pst-page-navigation-heading-2">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#core-functions">Core Functions</a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#runsimulation-h">runSimulation.h</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#runsimulation-cpp">runSimulation.cpp</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#lattice-classes">Lattice Classes</a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#lattice-h">Lattice.h</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#lattice-cpp">Lattice.cpp</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#bytelattice-h">ByteLattice.h</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#bytelattice-cpp">ByteLattice.cpp</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#cudabytelattice-h">CudaByteLattice.h</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#cudabytelattice-cu">CudaByteLattice.cu</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#cudaintlattice-h">CudaIntLattice.h</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#cudaintlattice-cu">CudaIntLattice.cu</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#solver-classes">Solver Classes</a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#mesolver-h">MESolver.h</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#mesolver-cpp">MESolver.cpp</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#cmesolver-h">CMESolver.h</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#cmesolver-cpp">CMESolver.cpp</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#rdme-solver-classes">RDME Solver Classes</a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#mpdrdmesolver-h">MpdRdmeSolver.h</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#mpdrdmesolver-cu">MpdRdmeSolver.cu</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#intmpdrdmesolver-h">IntMpdRdmeSolver.h</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#intmpdrdmesolver-cu">IntMpdRdmeSolver.cu</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#mgpumpdrdmesolver-h">MGPUMpdRdmeSolver.h</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#mgpumpdrdmesolver-cu">MGPUMpdRdmeSolver.cu</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#mgpuintmpdrdmesolver-h">MGPUIntMpdRdmeSolver.h</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#mgpuintmpdrdmesolver-cu">MGPUIntMpdRdmeSolver.cu</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#shape-classes">Shape Classes</a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#shape-h">Shape.h</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#shape-cpp">Shape.cpp</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#hemisphere-h">Hemisphere.h</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#hemisphere-cpp">Hemisphere.cpp</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#builder-classes">Builder Classes</a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#latticebuilder-h">LatticeBuilder.h</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#latticebuilder-cpp">LatticeBuilder.cpp</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#threading-classes">Threading Classes</a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#workermanager-h">WorkerManager.h</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#workermanager-cpp">WorkerManager.cpp</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#worker-h">Worker.h</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#worker-cpp">Worker.cpp</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#thread-h">Thread.h</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#thread-cpp">Thread.cpp</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#utility-classes">Utility Classes</a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#simulationfile-h">SimulationFile.h</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#simulationfile-cpp">SimulationFile.cpp</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#timer-h">Timer.h</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#timer-cpp">Timer.cpp</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#signalhandler-h">SignalHandler.h</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#signalhandler-cpp">SignalHandler.cpp</a></li>
</ul>
</li>
</ul>
  </nav></div>

  <div class="sidebar-secondary-item">
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/Cpp_source.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf"></script>
<script defer src="_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">

  <p class="copyright">
    
       Copyright 2025, Luthey-Schulten Lab.
      <br/>
    
  </p>
</div>
      
        <div class="footer-item">

  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 8.1.3.
    <br/>
  </p>
</div>
      
    </div>
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">
<p class="theme-version">
  <!-- # L10n: Setting the PST URL as an argument as this does not need to be localized -->
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.16.1.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>